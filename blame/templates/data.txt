[{"commits": [{"lines": ["/**", " *", " */", "", "var webpack = require('webpack');", "var webpackCommon = require('./webpack.common.config.js');", "", "// A subset of the app webpack config", "var webpackTestConfig = {", "    devtool: 'inline-source-map',", "    plugins: [", "        new webpack.ResolverPlugin(", "            new webpack.ResolverPlugin.DirectoryDescriptionFilePlugin('bower.json', ['main'])", "        ),", "", "        // Make sure that CommonJS is always used", "        new webpack.DefinePlugin({", "            'define.amd': false", "        }),", "", "        new webpack.ProvidePlugin({", "            $: 'jquery',", "            jQuery: 'jquery',", "            'window.jQuery': 'jquery',", "            'window.$': 'jquery'", "        }),", "    ],", "    resolve: webpackCommon.resolve,", "    externals: {'jquery': 'jQuery', 'jquery-ui': 'jQuery.ui'},", "    module: {", "        loaders: webpackCommon.module.loaders.concat([", "            // Assume test files are ES6", "            {test: /\\.test\\.js$/, loader: 'babel-loader'},", "        ])", "    }", "};", "", "module.exports = {", "    frameworks: ['mocha', 'sinon'],", "    files: [", "        // Mimics loading jquery and jquery-ui with script tags", "        'website/static/vendor/bower_components/jquery/dist/jquery.js',", "        'website/static/vendor/bower_components/jquery-ui/ui/jquery-ui.js',"]}, {"lines": ["        // Only need to target one file, which will load all files in tests/ that", "        // match *.test.js, including addons tests", "        'website/static/js/tests/tests.webpack.js',", "    ],", "    preprocessors: {", "        // add webpack as preprocessor", "        'website/static/js/tests/tests.webpack.js': ['webpack', 'sourcemap'],", "    },", "    webpack: webpackTestConfig,", "    webpackMiddleware: {noInfo: true},", "    webpackServer: {", "        noInfo: true // don't spam the console"]}, {"lines": ["    },", "", "    // Avoid DISCONNECTED messages", "    // See https://github.com/karma-runner/karma/issues/598", "    browserDisconnectTimeout : 100000, // default 2000"]}, {"lines": ["    browserDisconnectTolerance : 1, // default 0"]}, {"lines": ["    browserNoActivityTimeout : 600000 //default 10000"]}, {"lines": ["/**", " *", " */"]}, {"lines": ["var fs = require('fs');"]}, {"lines": [""]}, {"lines": ["var commonConfig = require('./karma.common.conf.js');", "var assign = require('object-assign');"]}, {"lines": ["", "var browsers = {"]}, {"lines": ["    sl_chrome: {", "        base: 'SauceLabs',", "        browserName: 'chrome',"]}, {"lines": ["        version: '40'"]}, {"lines": ["    },", "    sl_firefox: {", "        base: 'SauceLabs',", "        browserName: 'firefox',"]}, {"lines": ["    },", "    sl_safari: {", "        base: 'SauceLabs',", "        browserName: 'safari',"]}, {"lines": ["    },", "    sl_ie_11: {", "        base: 'SauceLabs',", "        browserName: 'internet explorer',", "        platform: 'Windows 8.1',", "        version: '11'", "    },", "    sl_ie_10: {", "        base: 'SauceLabs',", "        browserName: 'internet explorer',", "        platform: 'Windows 8',", "        version: '10'"]}, {"lines": ["    // TODO: Sinon faker is not compatible with IE 9. Github issue: https://github.com/cjohansen/Sinon.JS/issues/715", "    //sl_ie_9: {", "    //    base: 'SauceLabs',", "    //    browserName: 'internet explorer',", "    //    platform: 'Windows 7',", "    //    version: '9'"]}, {"lines": ["    //}"]}, {"lines": ["};", ""]}, {"lines": ["// Use ENV vars on Travis and sauce.json locally to get credentials"]}, {"lines": ["if (!process.env.SAUCE_USERNAME) {", "    if (!fs.existsSync('sauce.json')) {", "        console.log('Create a sauce.json with your credentials based on the sauce-sample.json file.');", "        process.exit(1);"]}, {"lines": ["    } else {"]}, {"lines": ["        process.env.SAUCE_USERNAME = require('./sauce').username;", "        process.env.SAUCE_ACCESS_KEY = require('./sauce').accessKey;"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["module.exports = function(config) {"]}, {"lines": ["    # Regression test for https://github.com/CenterForOpenScience/osf.io/issues/1478"]}, {"lines": ["        # register a project", "        self.project.register_node(None, Auth(user=self.project.creator), '', None)", "        # get the first registered project of a project", "        url = self.project.api_url_for('get_registrations')", "        res = self.app.get(url, auth=self.auth)", "        data = res.json", "        pid = data['nodes'][0]['id']", "        url2 = api_url_for('get_summary', pid=pid)", "        # count contributions", "        res2 = self.app.get(url2, {'rescale_ratio': data['rescale_ratio']}, auth=self.auth)", "        data = res2.json", "        assert_is_not_none(data['summary']['nlogs'])", "", "    def test_forks_contributions(self):", "        # fork a project", "        self.project.fork_node(Auth(user=self.project.creator))", "        # get the first forked project of a project", "        url = self.project.api_url_for('get_forks')", "        res = self.app.get(url, auth=self.auth)", "        data = res.json", "        pid = data['nodes'][0]['id']", "        url2 = api_url_for('get_summary', pid=pid)", "        # count contributions", "        res2 = self.app.get(url2, {'rescale_ratio': data['rescale_ratio']}, auth=self.auth)", "        data = res2.json", "        assert_is_not_none(data['summary']['nlogs'])", ""]}, {"lines": ["        assert_equal(len(result), 5)"]}, {"lines": ["        assert_equal(pages, 3)"]}, {"lines": ["        assert_equal(len(result), 5)"]}, {"lines": ["    def test_search_pagination_default_page_2(self):", "        url = api_url_for('search_contributor')", "        res = self.app.get(url, {'query': 'fr', 'page': 2})", "        assert_equal(res.status_code, 200)", "        result = res.json['users']", "        page = res.json['page']", "        assert_equal(len(result), 2)", "        assert_equal(page, 2)", ""]}, {"lines": ["        The file \"{name}\" is still a draft on figshare. <br>", "        To view it  on the OSF <a href=\"http://figshare.com/faqs\">publish</a> it on figshare."]}, {"lines": ["            'This {cat} is connected to a figshare project. Files marked as '"]}, {"lines": ["            'private on figshare <strong>will be visible to the public'"]}, {"lines": ["        figshare"]}, {"lines": ["        push_status_message('figshare authorization request cancelled.')"]}, {"lines": ["def _get_summary(node, auth, rescale_ratio, primary=True, link_id=None, show_path=False):"]}, {"lines": ["            'is_public': node.is_public,", "            'parent_title': node.parent_node.title if node.parent_node else None,", "            'parent_is_public': node.parent_node.is_public if node.parent_node else False,", "            'show_path': show_path"]}, {"lines": ["    if rescale_ratio is None and request.args.get('rescale_ratio'):", "        try:", "            rescale_ratio = float(request.args.get('rescale_ratio'))", "        except (TypeError, ValueError):", "            raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["    show_path = kwargs.get('show_path', False)"]}, {"lines": ["        node, auth, rescale_ratio, primary=primary, link_id=link_id, show_path=show_path"]}, {"lines": ["    return _render_nodes(registrations, auth)"]}, {"lines": ["    size = int(bleach.clean(request.args.get('size', '5'), tags=[], strip=True))"]}, {"lines": ["            if (contrib.email) {", "                var contribEmail = contrib.email.toLowerCase().trim();", "                if (contribEmail === self.inviteEmail().toLowerCase().trim()) {", "                    return self.inviteEmail() + ' is already in queue.';", "                }"]}, {"lines": ["        $osf.block();"]}, {"lines": ["                }),", "                node_ids: self.nodesToChange()", "            }", "        ).done(function() {", "            window.location.reload();", "        }).fail(function() {"]}, {"lines": ["            $osf.unblock();"]}, {"lines": ["        });"]}, {"lines": ["                        type=\"button\""]}, {"lines": ["                        class=\"btn btn-default\"", "                        data-bind=\"click: cancel\"", "                    >Cancel</button>", ""]}, {"lines": ["                <button", "                        type=\"submit\"", "                        class=\"btn btn-primary\"", "                    >Submit</button>", ""]}, {"lines": ["                        type=\"button\""]}, {"lines": ["                        class=\"btn btn-default\"", "                        data-bind=\"click: cancel\"", "                    >Cancel</button>", ""]}, {"lines": ["                <button", "                        type=\"submit\"", "                        class=\"btn btn-primary\"", "                    >Submit</button>", ""]}, {"lines": ["                                    <ul class=\"pagination pagination-sm\" data-bind=\"foreach: paginators\">"]}, {"lines": ["                                        <li data-bind=\"css: style\"><a href=\"#\" data-bind=\"click: handler, html: text\"></a></li>"]}, {"lines": ["                                    </ul>"]}, {"lines": ["", "        % if summary['show_path'] and summary['node_type'] == 'component':", "            <div style=\"padding-bottom: 10px\">", "                ${summary['parent_title'] if summary['parent_is_public'] else \"<em>-- private project --</em>\"} / <b>${summary['title']}</b>", "            </div>", "        % endif", ""]}], "name": "huangginny"}, {"commits": [{"lines": ["        'website/static/vendor/bower_components/bootstrap/dist/js/bootstrap.js',"]}, {"lines": ["};"]}, {"lines": ["    }"]}, {"lines": ["    config.set(assign(commonConfig, {", "        reporters: ['saucelabs', 'spec'],", "        browsers: Object.keys(browsers),", "        customLaunchers: browsers,", "        singleRun: true", "    }));", "};"]}, {"lines": ["#!/usr/bin/env python", "import os", "import sys", "from website.app import init_app", "", "", "if __name__ == \"__main__\":", "    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'api.base.settings')", "", "    from django.core.management import execute_from_command_line", ""]}, {"lines": [""]}, {"lines": ["    if 'livereload' in sys.argv:", "        from django.core.wsgi import get_wsgi_application", "        from livereload import Server", "        import django.conf as conf", "        conf.settings.STATIC_URL = '/static/'", "        application = get_wsgi_application()", "        server = Server(application)", "        server.watch('api/')", "", "        server.serve(port=8000)", "    else:", "        execute_from_command_line(sys.argv)"]}, {"lines": ["var SaveAssetsJson = require('assets-webpack-plugin');", ""]}, {"lines": ["/**", " * Each JS module for a page on the OSF is webpack entry point. These are built", " * to website/static/public/", " */"]}, {"lines": ["    // JS"]}, {"lines": ["        // Vendor libraries"]}, {"lines": ["        'moment',"]}, {"lines": ["        'bootstrap-editable',"]}, {"lines": ["        'URIjs',"]}, {"lines": ["        // Common internal modules"]}, {"lines": ["        'bootstrap-editable': staticPath('vendor/bootstrap-editable-custom/js/bootstrap-editable.js'),"]}, {"lines": ["        'zeroclipboard': staticPath('vendor/bower_components/zeroclipboard/dist/ZeroClipboard.js'),"]}, {"lines": ["        'history': nodePath('historyjs/scripts/bundled/html4+html5/jquery.history.js'),"]}, {"lines": ["    'raven-js': 'Raven',"]}, {"lines": ["    'MathJax': 'MathJax'"]}, {"lines": ["    new webpack.optimize.CommonsChunkPlugin('vendor', 'vendor.js'),"]}, {"lines": ["    filename: '[name].js',"]}, {"lines": ["    output: output,", "    module: {", "        loaders: ["]}, {"lines": ["            {test: /\\.es6\\.js$/, exclude: [/node_modules/, /bower_components/, /vendor/], loader: 'babel-loader'},"]}, {"lines": ["            {test: /\\.css$/, loaders: ['style', 'css']},"]}, {"lines": ["            // url-loader uses DataUrls; files-loader emits files"]}, {"lines": ["            {test: /\\.gif$/, loader: 'url-loader?limit=10000&mimetype=image/gif'},", "            {test: /\\.jpg$/, loader: 'url-loader?limit=10000&mimetype=image/jpg'},"]}, {"lines": ["            {test: /\\.woff(2)?(\\?v=[0-9]\\.[0-9]\\.[0-9])?$/, loader: 'url-loader?mimetype=application/font-woff'},"]}, {"lines": ["            {test: /\\.svg/, loader: 'file-loader'},", "            {test: /\\.eot/, loader: 'file-loader'},"]}, {"lines": ["        ]", "    }"]}, {"lines": ["var assign = require('object-assign');"]}, {"lines": ["var SaveAssetsJson = require('assets-webpack-plugin');"]}, {"lines": ["module.exports = assign(common, {"]}, {"lines": ["    debug: false,", "    devtool: false,", "    stats: {reasons: false},"]}, {"lines": ["        new webpack.DefinePlugin({", "            'process.env': {", "                NODE_ENV: JSON.stringify('production')"]}, {"lines": ["            },"]}, {"lines": ["            DEBUG: false,", "            '__DEV__': false"]}, {"lines": ["        }),"]}, {"lines": ["        new webpack.optimize.UglifyJsPlugin({", "            exclude: /conference.*?\\.js$/,", "            compress: {warnings: false}"]}, {"lines": ["        }),", "        // Save a webpack-assets.json file that maps base filename to filename with", "        // hash. This file is used by the webpack_asset mako filter to expand", "        // base filenames to full filename with hash.", "        new SaveAssetsJson(),", "        // Append hash to commons chunk for cachebusting", "        new webpack.optimize.CommonsChunkPlugin('vendor', 'vendor.[hash].js'),", "    ]),", "    output: {", "        path: './website/static/public/js/',", "        // publicPath: '/static/', // used to generate urls to e.g. images", "", "        // Append hash to filenames for cachebusting", "        filename: '[name].[chunkhash].js',", "        sourcePrefix: ''", "    }"]}, {"lines": ["});"]}, {"lines": ["from pymongo.errors import OperationFailure"]}, {"lines": [""]}, {"lines": ["# TODO: Verify that a transaction is being created for every", "# individual request."]}, {"lines": ["class TokuTransactionsMiddleware(object):", "    \"\"\"TokuMX transaction middleware.\"\"\"", "", "    def process_request(self, request):"]}, {"lines": ["        \"\"\"Begin a transaction if one doesn't already exist.\"\"\"", "        try:", "            commands.begin()", "        except OperationFailure as err:", "            message = utils.get_error_message(err)", "            if messages.TRANSACTION_EXISTS_ERROR not in message:", "                raise err"]}, {"lines": [""]}, {"lines": ["    def process_exception(self, request, exception):"]}, {"lines": ["        \"\"\"If an exception occurs, rollback the current transaction", "        if it exists.", "        \"\"\""]}, {"lines": ["        try:", "            commands.rollback()", "        except OperationFailure as err:", "            message = utils.get_error_message(err)", "            if messages.NO_TRANSACTION_ERROR not in message:", "                raise"]}, {"lines": ["        return None"]}, {"lines": [""]}, {"lines": ["    def process_response(self, request, response):"]}, {"lines": ["        \"\"\"Commit transaction if it exists, rolling back in an", "        exception occurs.", "        \"\"\""]}, {"lines": ["        try:"]}, {"lines": ["            commands.commit()", "        except OperationFailure as err:", "            message = utils.get_error_message(err)", "            if messages.NO_TRANSACTION_TO_COMMIT_ERROR not in message:", "                raise err", "        except Exception as err:", "            try:", "                commands.rollback()", "            except OperationFailure:", "                pass", "            else:", "                raise err"]}, {"lines": ["        return response"]}, {"lines": ["", "from rest_framework.renderers import JSONRenderer", "", "class JSONAPIRenderer(JSONRenderer):", "    media_type = 'application/vnd.api+json'"]}, {"lines": ["from django.conf import settings"]}, {"lines": ["# from django.contrib import admin"]}, {"lines": ["from django.conf.urls.static import static"]}, {"lines": [""]}, {"lines": ["", "from . import views", ""]}, {"lines": [""]}, {"lines": ["urlpatterns = ["]}, {"lines": ["    ### API ###"]}, {"lines": ["from rest_framework.decorators import api_view", "from rest_framework.response import Response"]}, {"lines": [""]}, {"lines": ["from .utils import absolute_reverse"]}, {"lines": ["from api.users.serializers import UserSerializer"]}, {"lines": ["", "@api_view(('GET',))", "def root(request, format=None):"]}, {"lines": ["    if request.user and not request.user.is_anonymous():", "        user = request.user"]}, {"lines": ["        current_user = UserSerializer(user).data"]}, {"lines": ["    else:", "        current_user = None", "    return Response({"]}, {"lines": ["        'meta': {"]}, {"lines": ["            'message': 'Welcome to the OSF API.',", "            'version': request.version,"]}, {"lines": ["            'current_user': current_user,", "        },"]}, {"lines": ["        'links': {", "            'nodes': absolute_reverse('nodes:node-list'),"]}, {"lines": ["            'users': absolute_reverse('users:user-list'),"]}, {"lines": ["        }", "    })"]}, {"lines": ["import itsdangerous"]}, {"lines": ["from django.utils.translation import ugettext_lazy as _"]}, {"lines": [""]}, {"lines": ["from rest_framework.authentication import BasicAuthentication", "from rest_framework import exceptions"]}, {"lines": [""]}, {"lines": ["def get_session_from_cookie(cookie_val):", "    \"\"\"Given a cookie value, return the `Session` object or `None`.\"\"\"", "    session_id = itsdangerous.Signer(settings.SECRET_KEY).unsign(cookie_val)", "    return Session.load(session_id)", "", "# http://www.django-rest-framework.org/api-guide/authentication/#custom-authentication", "class OSFSessionAuthentication(authentication.BaseAuthentication):", "    \"\"\"Custom DRF authentication class which works with the OSF's Session object.", "    \"\"\"", "", "    def authenticate(self, request):", "        cookie_val = request.COOKIES.get(settings.COOKIE_NAME)", "        if not cookie_val:", "            return None", "        session = get_session_from_cookie(cookie_val)", "        if not session:", "            return None", "        user_id = session.data.get('auth_user_id')", "        user = User.load(user_id)", "        if user:", "            return user, None", "        return None"]}, {"lines": ["", "", "class OSFBasicAuthentication(BasicAuthentication):", "", "    # override BasicAuthentication", "    def authenticate_credentials(self, userid, password):", "        \"\"\"", "        Authenticate the userid and password against username and password.", "        \"\"\"", "        user = get_user(email=userid, password=password)", "", "        if userid and user is None:", "            raise exceptions.AuthenticationFailed(_('Invalid username/password.'))"]}, {"lines": ["            raise exceptions.NotAuthenticated()", "        return (user, None)"]}, {"lines": ["\"\"\"", "Django settings for api project.", "", "Generated by 'django-admin startproject' using Django 1.8.", "", "For more information on this file, see", "https://docs.djangoproject.com/en/1.8/topics/settings/", "", "For the full list of settings and their values, see", "https://docs.djangoproject.com/en/1.8/ref/settings/", "\"\"\"", ""]}, {"lines": ["import os"]}, {"lines": ["from website import settings as osf_settings"]}, {"lines": [""]}, {"lines": ["# Quick-start development settings - unsuitable for production", "# See https://docs.djangoproject.com/en/1.8/howto/deployment/checklist/", "", "# SECURITY WARNING: keep the secret key used in production secret!"]}, {"lines": ["SECRET_KEY = osf_settings.SECRET_KEY"]}, {"lines": ["", "AUTHENTICATION_BACKENDS = ("]}, {"lines": ["    'api.base.authentication.backends.ODMBackend',"]}, {"lines": [")", "", "# SECURITY WARNING: don't run with debug turned on in production!"]}, {"lines": ["DEBUG = osf_settings.DEBUG_MODE"]}, {"lines": [""]}, {"lines": ["ALLOWED_HOSTS = [", "    '.osf.io'", "]"]}, {"lines": ["", "", "# Application definition", "", "INSTALLED_APPS = ("]}, {"lines": ["    'django.contrib.auth',", "    'django.contrib.contenttypes',"]}, {"lines": ["    'django.contrib.staticfiles',", "", "    # 3rd party", "    'rest_framework',"]}, {"lines": [")", ""]}, {"lines": ["REST_FRAMEWORK = {"]}, {"lines": ["    'PAGE_SIZE': 10,"]}, {"lines": ["    'DEFAULT_RENDERER_CLASSES': ("]}, {"lines": ["        'rest_framework.renderers.JSONRenderer',"]}, {"lines": ["        'rest_framework.renderers.BrowsableAPIRenderer',", "    ),", "    'DEFAULT_VERSIONING_CLASS': 'rest_framework.versioning.AcceptHeaderVersioning',", "    'DEFAULT_VERSION': '2.0',"]}, {"lines": ["    'DEFAULT_FILTER_BACKENDS': ('api.base.filters.ODMOrderingFilter',),"]}, {"lines": ["    'DEFAULT_PAGINATION_CLASS': 'api.base.pagination.JSONAPIPagination',"]}, {"lines": ["    'ORDERING_PARAM': 'sort',"]}, {"lines": ["    'DEFAULT_AUTHENTICATION_CLASSES': ("]}, {"lines": ["        # Custom auth classes"]}, {"lines": ["        'api.base.authentication.drf.OSFSessionAuthentication',"]}, {"lines": ["    ),", "}", "", "MIDDLEWARE_CLASSES = ("]}, {"lines": ["    # TokuMX transaction support", "    # Needs to go before CommonMiddleware, so that transactions are always started,", "    # even in the event of a redirect. CommonMiddleware may cause other middlewares'"]}, {"lines": ["    'api.base.middleware.TokuTransactionsMiddleware',", ""]}, {"lines": ["    # 'django.contrib.sessions.middleware.SessionMiddleware',"]}, {"lines": ["    'django.middleware.common.CommonMiddleware',", "    'django.middleware.csrf.CsrfViewMiddleware',"]}, {"lines": ["    # 'django.contrib.auth.middleware.AuthenticationMiddleware',", "    # 'django.contrib.auth.middleware.SessionAuthenticationMiddleware',", "    # 'django.contrib.messages.middleware.MessageMiddleware',"]}, {"lines": ["    'django.middleware.clickjacking.XFrameOptionsMiddleware',", "    'django.middleware.security.SecurityMiddleware',"]}, {"lines": [""]}, {"lines": [")", ""]}, {"lines": ["ROOT_URLCONF = 'api.base.urls'"]}, {"lines": ["WSGI_APPLICATION = 'api.base.wsgi.application'"]}, {"lines": ["", ""]}, {"lines": ["LANGUAGE_CODE = 'en-us'", ""]}, {"lines": ["", "USE_I18N = True", "", "USE_L10N = True", "", "USE_TZ = True", "", ""]}, {"lines": ["# https://docs.djangoproject.com/en/1.8/howto/static-files/", ""]}, {"lines": ["from rest_framework import permissions", "", "from framework.auth import Auth", ""]}, {"lines": ["", "class ContributorOrPublic(permissions.BasePermission):", "", "    def has_object_permission(self, request, view, obj):"]}, {"lines": ["        if request.method in permissions.SAFE_METHODS:", "            return obj.is_public or obj.can_view(auth)", "        else:", "            return obj.can_edit(auth)"]}, {"lines": [""]}, {"lines": ["class ReadOnlyIfRegistration(permissions.BasePermission):"]}, {"lines": ["    \"\"\"Makes PUT and POST forbidden for registrations.\"\"\""]}, {"lines": ["", "    def has_object_permission(self, request, view, obj):"]}, {"lines": ["        assert isinstance(obj, Node), 'obj must be a Node'"]}, {"lines": ["        if obj.is_registration:", "            return request.method in permissions.SAFE_METHODS", "        return True"]}, {"lines": [""]}, {"lines": ["urlpatterns = [", "    # Examples:", "    # url(r'^$', 'api.views.home', name='home'),", "    # url(r'^blog/', include('blog.urls')),"]}, {"lines": ["    url(r'^$', views.NodeList.as_view(), name='node-list'),"]}, {"lines": ["]"]}, {"lines": ["from django.conf.urls import url", "from . import views", "", "urlpatterns = [", "    url(r'^$', views.UserList.as_view(), name='user-list'),"]}, {"lines": ["]"]}, {"lines": ["from website import settings"]}, {"lines": ["    # Pass mailer so that celery is not used", "    # Email synchronously so that user is only saved after email has been sent"]}, {"lines": ["        username=settings.MANDRILL_USERNAME,", "        password=settings.MANDRILL_PASSWORD,", "        mail_server=settings.MANDRILL_MAIL_SERVER,"]}, {"lines": ["    # Active users who have not received the email", "    query = (", "        Q('security_messages.{0}'.format(MESSAGE_NAME), 'exists', False) &", "        Q('is_registered', 'eq', True) &", "        Q('password', 'ne', None) &", "        Q('is_merged', 'ne', True) &", "        Q('is_disabled', 'ne', True) &", "        Q('date_confirmed', 'ne', None)", "    )"]}, {"lines": ["    script_utils.add_file_logger(logger, __file__)"]}, {"lines": ["import logging"]}, {"lines": ["from website.app import init_app"]}, {"lines": ["from scripts import utils as script_utils", "", "", "logger = logging.getLogger(__name__)"]}, {"lines": ["    expired_if_before = datetime.utcnow() - ARCHIVE_TIMEOUT_TIMEDELTA"]}, {"lines": ["    init_app(set_backends=True, routes=False)"]}, {"lines": ["    count = 0"]}, {"lines": ["            logging.info('Cleaning {}'.format(f))"]}, {"lines": ["            count += 1", "    logging.info('Cleaned {} registrations'.format(count))"]}, {"lines": ["    dry = 'dry' in sys.argv", "    if not dry:"]}, {"lines": ["        script_utils.add_file_logger(logger, __file__)"]}, {"lines": ["    remove_failed_registrations(dry_run=dry)"]}, {"lines": ["from __future__ import absolute_import"]}, {"lines": ["    logger.warn('Clearing sessions older than {0} months'.format(months))"]}, {"lines": ["    retractions.hour.on(0)", "    retractions.minute.on(0)  # Daily 12 a.m."]}, {"lines": ["    embargoes.hour.on(0)", "    embargoes.minute.on(0)  # Daily 12 a.m."]}, {"lines": ["    logger.info('Sending message to user {0!r}'.format(contrib))"]}, {"lines": ["", "Log:", "    Run by sloria, jmcarp, and icereval on 2015-02-10 at 1:15 PM. 822 file version records", "    were copied and migrated. A migration log was saved to the migration-logs directory."]}, {"lines": ["import sys"]}, {"lines": ["    logger.info('Setting container of OsfStorageFileVersion {0} to {1}'.format(", "        version._id,", "        PROD_CONTAINER_NAME)", "    )"]}, {"lines": ["        logger.info('Migrating OsfStorageFileVersion {0}'.format(version._id))"]}, {"lines": ["    init_app(set_backends=True, routes=False)"]}, {"lines": ["    if not dry_run:", "        script_utils.add_file_logger(logger, __file__)"]}, {"lines": ["    pyrax.set_credentials(", "        storage_settings.USERNAME,", "        storage_settings.API_KEY,", "        region=storage_settings.REGION", "    )"]}, {"lines": ["from website.app import init_app"]}, {"lines": ["                u'Removing admin {0} from node {1}'.format("]}, {"lines": ["            u'Adding staff email {0} to node {1}'.format("]}, {"lines": ["    logger.info('{}Migrated {} users'.format('[dry]'if dry else '', len(records)))"]}, {"lines": ["        'Migrating user - {}: merged_by={}, '.format("]}, {"lines": ["            user.merged_by._id,"]}, {"lines": ["\"\"\"Remove None from nodes' logs lists.\"\"\""]}, {"lines": ["    count = 0"]}, {"lines": ["        # Can't use in operator to check if None in node.logs", "        # Due to modm bug: https://github.com/CenterForOpenScience/modular-odm/issues/110", "        # So instead, we build an intermediate list", "        if None in [each for each in node.logs]:"]}, {"lines": ["                'Removing None logs in node {}'.format(node._id)"]}, {"lines": ["            node.logs = [each for each in node.logs if each is not None]", "            node.save()", "            count += 1", "    logger.info('Removed None logs from {} nodes'.format(count))"]}, {"lines": ["    main()"]}, {"lines": ["    return Node.find("]}, {"lines": ["            logger.info('Calling _update_node_objecton Node {}'.format(node._id))"]}, {"lines": ["    logger.info('Finished')"]}, {"lines": ["from framework.transactions.context import TokuTransaction"]}, {"lines": ["            with TokuTransaction():", "                migrate_project_contributed(user)", "                user.is_disabled = True", "                user.save()"]}, {"lines": ["        log_info(user)"]}, {"lines": ["        user.save()", "    logger.info('Migrated {0} users'.format(len(records)))", ""]}, {"lines": ["", "def log_info(user):", "    logger.info(", "        'Migrating user - {}: date_confirmed={}, '", "        'date_last_login={}, is_registered={}'.format(", "            user._id,", "            user.date_confirmed,", "            user.date_last_login,", "            user.is_registered", "        )", "    )", "", ""]}, {"lines": ["        user_list = get_targets()", "        for user in user_list:", "            log_info(user)", "        logger.info('[dry] Migrated {0} users'.format(len(user_list)))"]}, {"lines": ["        today = dt.datetime.utcnow()", "        user1 = UserFactory.build(date_confirmed=today, date_last_login=today)", "        user2 = UserFactory.build(date_confirmed=None, date_last_login=today)", "        user1.save()", "        user2.save()", "", "        user_list = get_targets()", "        assert user_list is not None", "        assert len(user_list) is 1", "", "        user1.date_confirmed = None", "        user1.save()", "        user_list = get_targets()", "        assert len(user_list) is 2"]}, {"lines": [""]}, {"lines": ["    if 'dry' not in sys.argv:", "        script_utils.add_file_logger(logger, __file__)"]}, {"lines": ["from website.app import init_app"]}, {"lines": ["        'logo_url': 'http://vprsf.org/wp-content/themes/VPRSF/images/logo.png',"]}, {"lines": ["            'mhurst@virginia.edu',"]}, {"lines": ["    'VSSEF2015': {"]}, {"lines": ["    'NEEPS2015': {"]}, {"lines": ["    },"]}, {"lines": ["    'NRAO2015': {"]}, {"lines": ["    },"]}, {"lines": ["    'ARCS2015': {"]}, {"lines": ["    'singlecasedesigns2015': {"]}, {"lines": ["        'logo_url': None,"]}, {"lines": ["    'OSFM2015': {"]}, {"lines": ["    'JSSP2015': {"]}, {"lines": ["    '4S2015': {"]}, {"lines": ["        meeting = meeting.strip()"]}, {"lines": ["        conf = Conference(", "            endpoint=meeting, admins=admin_objs, **attrs", "        )"]}, {"lines": ["            print('{0} Conference already exists. Updating existing record...'.format(meeting))", "            conf = Conference.find_one(Q('endpoint', 'eq', meeting))", "            for key, value in attrs.items():", "                setattr(conf, key, value)", "            conf.admins = admin_objs"]}, {"lines": ["            changed_fields = conf.save()"]}, {"lines": ["            if changed_fields:", "                print('Changed: {}'.format(changed_fields))"]}, {"lines": ["        else:", "            print('Added new Conference: {}'.format(meeting))"]}, {"lines": ["            try:", "                parent_registration = models.Node.find_one(Q('retraction', 'eq', retraction))", "            except Exception as err:", "                logger.error('Could not find registration associated with retraction {}'.format(retraction))", "                logger.error('Skipping...'.format(retraction))", "                continue", ""]}, {"lines": ["                    try:", "                        parent_registration.registered_from.add_log(", "                            action=NodeLog.RETRACTION_APPROVED,", "                            params={", "                                'node': parent_registration._id,", "                                'retraction_id': parent_registration.retraction._id,", "                            },", "                            auth=Auth(parent_registration.retraction.initiated_by),", "                        )", "                        retraction.save()"]}, {"lines": ["                        parent_registration.update_search()", "                        for node in parent_registration.get_descendants_recursive():", "                            node.update_search()"]}, {"lines": ["                    except Exception as err:", "                        logger.error(", "                            'Unexpected error raised when retracting '", "                            'registration {}. Continuing...'.format(parent_registration))", "                        logger.exception(err)"]}, {"lines": ["    init_app(routes=False)"]}, {"lines": ["        main(dry_run=dry_run)"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Get public registrations for staff members.", "", "    python -m scripts.staff_public_regs", "\"\"\"", "from collections import defaultdict", "import logging", "", "from modularodm import Q", "", "from website.models import Node, User", "from website.app import init_app", "", "logger = logging.getLogger('staff_public_regs')", "", "STAFF_GUIDS = [", "    'jk5cv',  # Jeff", "    'cdi38',  # Brian", "    'edb8y',  # Johanna", "    'hsey5',  # Courtney", "    '5hdme',  # Melissa", "]", "", "def main():"]}, {"lines": ["    staff_registrations = defaultdict(list)", "    users = [User.load(each) for each in STAFF_GUIDS]", "    for registration in Node.find(Q('is_registration', 'eq', True) & Q('is_public', 'eq', True)):", "        for user in users:", "            if registration in user.node__contributed:", "                staff_registrations[user._id].append(registration)", "", "    for uid in staff_registrations:", "        user = User.load(uid)", "        user_regs = staff_registrations[uid]", "        logger.info('{} ({})  on {} Public Registrations:'.format(", "            user.fullname,", "            user._id,", "            len(user_regs))", "        )", "        for registration in user_regs:", "            logger.info('\\t{} ({}): {}'.format(registration.title,", "                registration._id,", "                registration.absolute_url)", "            )", "", "if __name__ == '__main__':", "    main()"]}, {"lines": ["logger = logging.getLogger(__name__)"]}, {"lines": ["    database['node'].update({\"is_dashboard\": {'$exists': False}}, {'$set': {'is_dashboard': False}}, multi=True)"]}, {"lines": [""]}, {"lines": ["    database['node'].update({\"expanded\": {'$exists': False}}, {'$set': {'expanded': {}}}, multi=True)"]}, {"lines": ["    database['node'].update({\"expanded\": False}, {'$set': {'expanded': {}}}, multi=True)"]}, {"lines": ["    main()"]}, {"lines": ["from pyrax.exceptions import NoSuchObject"]}, {"lines": ["logging.getLogger('boto').setLevel(logging.CRITICAL)"]}, {"lines": ["    try:", "        obj = container_primary.get_object(version.location['object'])"]}, {"lines": ["    except NoSuchObject as err:", "        logger.error('*** FILE NOT FOUND ***')", "        logger.error('Exception:')", "        logger.exception(err)", "        logger.error('Version info:')", "        logger.error(version.to_storage())"]}, {"lines": ["    return model.OsfStorageFileVersion.find(", "        Q('status', 'ne', 'cached') &", "        Q('location.object', 'exists', True)", "    )"]}, {"lines": ["    try:", "        # Authenticate to Rackspace", "        pyrax.settings.set('identity_type', 'rackspace')", "        pyrax.set_credentials(", "            storage_settings.USERNAME,", "            storage_settings.API_KEY,", "            region=storage_settings.REGION", "        )", "        container_primary = pyrax.cloudfiles.get_container(storage_settings.PRIMARY_CONTAINER_NAME)", "        container_parity = pyrax.cloudfiles.get_container(storage_settings.PARITY_CONTAINER_NAME)", "", "        # Connect to AWS", "        layer2 = Layer2(", "            aws_access_key_id=storage_settings.AWS_ACCESS_KEY,", "            aws_secret_access_key=storage_settings.AWS_SECRET_KEY,", "        )", "        vault = layer2.get_vault(storage_settings.GLACIER_VAULT)", "", "        # Log to file", "        if not dry_run:", "            scripts_utils.add_file_logger(logger, __file__, suffix=worker_id)"]}, {"lines": ["            main(nworkers, worker_id, dry_run=dry_run)", "    except Exception as err:", "        logger.error('=== Unexpected Error ===')", "        logger.exception(err)", "        raise err"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Nodes that were updated between the first run of migrate_from_oldels and the catchup run", "of migrate_from_oldels will have logs that were unmigrated because the _migrated_from_old_models", "flag was set during the first migration.", "\"\"\""]}, {"lines": ["import logging", "import sys", ""]}, {"lines": ["from website.models import Node"]}, {"lines": ["from website.app import init_app"]}, {"lines": ["from framework.transactions.context import TokuTransaction"]}, {"lines": ["from framework.mongo import database"]}, {"lines": ["from scripts import utils as scripts_utils"]}, {"lines": ["", "from . import migrate_from_oldels", "", "logger = logging.getLogger(__name__)", "", "def find_unmigrated_nodes():"]}, {"lines": ["    logs = database.nodelog.find({'$and': [", "        {", "            'action': {'$in': list(migrate_from_oldels.LOG_ACTIONS)},", "        },", "        {'params.path': {'$regex': '^(?!/)'}}", "    ]})", "    node_ids = set(sum([(each['params']['node'], each['params']['project']) for each in logs], tuple()))"]}, {"lines": ["    for node_id in node_ids:", "        node = Node.load(node_id)", "        if not node:", "            logger.warn('Skipping invalid node id: {}'.format(node_id))", "            continue", "        yield node"]}, {"lines": ["", "", "def main(dry=True):"]}, {"lines": ["    count, failed = 0, 0"]}, {"lines": ["    for node in find_unmigrated_nodes():", "        addon = node.get_addon('osfstorage')"]}, {"lines": ["        try:", "            with TokuTransaction():", "                migrate_from_oldels.migrate_children(addon, dry=dry)", "            count += 1", "        except Exception as error:"]}, {"lines": ["            failed += 1"]}, {"lines": ["            logger.error('Could not migrate file tree from {}'.format(addon.owner._id))", "            logger.exception(error)"]}, {"lines": ["    logger.info('Migrated {} nodes'.format(count))"]}, {"lines": ["    logger.error('Failed to migrate {} nodes'.format(failed))"]}, {"lines": ["", "", "if __name__ == '__main__':", "    dry = 'dry' in sys.argv"]}, {"lines": ["    if not dry:", "        scripts_utils.add_file_logger(logger, __file__)"]}, {"lines": ["    main(dry=dry)"]}, {"lines": ["import datetime as dt"]}, {"lines": ["LOG_ACTIONS = ["]}, {"lines": ["]"]}, {"lines": ["def migrate_guids(node_settings, children, dry=True):"]}, {"lines": ["    for guid in model.OsfStorageGuidFile.find(", "            Q('node', 'eq', node_settings.owner) & Q('_has_no_file_tree', 'ne', True)):"]}, {"lines": ["                    # A number of invalid GUIDs were generated by", "                    # search bots that spidered invalid URLs", "                    # e.g. /blah/{{ urls.revisions }}", "                    # which created OsfStorageGuidFile records", "                    # that are not included in the file_tree for", "                    # a node's OsfStorageNodeSettings", "                    # Any file Guid whose path contains a '/' should"]}, {"lines": ["                    # be considered invalid, and we skip over those and mark them so that"]}, {"lines": ["                    # the rest of the migration can occur"]}, {"lines": ["                    logger.warning('Skipping invalid OsfStorageGuidFile with _id {} and path {}. Marking as invalid...'.format(guid._id, guid.path))", "                    guid._has_no_file_tree = True", "                    guid.save()", "                else:", "                    logger.warning('Already migrated {!r}'.format(guid))"]}, {"lines": ["    migrate_guids(node_settings, children, dry=dry)"]}, {"lines": ["def main(nworkers, worker_id, dry=True):"]}, {"lines": ["    to_migrate = model.OsfStorageNodeSettings.find(Q('_migrated_from_old_models', 'ne', True))"]}, {"lines": ["                if not dry:", "                    node_settings.reload()", "                    node_settings._migrated_from_old_models = True", "                    node_settings.save()"]}, {"lines": ["    main(nworkers, worker_id, dry=dry)"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Script which ensures that every file version's", "content_type, size, and date_modified fields are consistent", "with the metadata from waterbutler.", "\"\"\""]}, {"lines": ["from modularodm import Q"]}, {"lines": ["import logging", "import sys", ""]}, {"lines": ["from website.addons.osfstorage.model import OsfStorageFileVersion"]}, {"lines": ["from website.app import init_app"]}, {"lines": [""]}, {"lines": ["from scripts import utils as scripts_utils", "", "logger = logging.getLogger(__name__)"]}, {"lines": ["", "def main():"]}, {"lines": ["    for each in OsfStorageFileVersion.find(", "        Q('size', 'eq', None) &", "        Q('status', 'ne', 'cached') &", "        Q('location.object', 'exists', True)", "    ):"]}, {"lines": ["        logger.info('Updating metadata for OsfStorageFileVersion {}'.format(each._id))", "        if 'dry' not in sys.argv:", "            each.update_metadata(each.metadata)"]}, {"lines": ["", "if __name__ == '__main__':"]}, {"lines": ["    # Set up storage backends", "    init_app(set_backends=True, routes=False)"]}, {"lines": ["    if 'dry' not in sys.argv:", "        scripts_utils.add_file_logger(logger, __file__)"]}, {"lines": ["    main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "from nose.tools import *  # noqa", "from modularodm import Q", "from framework.guid.model import Guid", "from tests.base import OsfTestCase", "from website.project.model import Node", "from tests.factories import NodeFactory", "", "from scripts.find_guids_without_referents import get_targets", "", "", "class TestFindGuidsWithoutReferents(OsfTestCase):", "", "    def setUp(self):", "        super(TestFindGuidsWithoutReferents, self).setUp()", "        self.node = NodeFactory()", "        self.nontarget_guid = Guid(referent=self.node)", "        self.nontarget_guid.save()", "", "    def test_get_targets_referent_is_none(self):", "        bad_guid = Guid(referent=None)", "        bad_guid.save()", "", "        targets = list(get_targets())", "        assert_in(bad_guid, targets)", "        assert_not_in(self.nontarget_guid, targets)", "", "    def test_get_targets_referent_points_to_nothing(self):", "        node = NodeFactory()", "        bad_guid = Guid(referent=node)", "        bad_guid.save()", "        Node.remove(Q('_id', 'eq', node._id))", "", "        targets = list(get_targets())", "        assert_in(bad_guid, targets)", "        assert_not_in(self.nontarget_guid, targets)"]}, {"lines": ["# -*- coding: utf-8 -*-", "import datetime", "from nose.tools import *  # noqa", "", "from scripts.osfstorage.utils import ensure_osf_files", "from website import settings", "ensure_osf_files(settings)", "", "# Hack: Must configure add-ons before importing `OsfTestCase`", "from website.addons.osfstorage.tests.factories import FileVersionFactory", "from website.addons.osfstorage.model import OsfStorageFileRecord", "from website.addons.osffiles.model import NodeFile", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory", "", "from scripts.osfstorage.migrate_dates import main", "", "", "class TestMigrateDates(OsfTestCase):", "", "    def setUp(self):", "        super(TestMigrateDates, self).setUp()", "        self.path = 'old-pizza'", "        self.project = ProjectFactory()", "        self.node_settings = self.project.get_addon('osfstorage')", "        self.node_file = NodeFile(path=self.path)", "        self.node_file.save()", "        self.node_file.reload()", "        self.date = self.node_file.date_modified", "        self.project.files_versions['old_pizza'] = [self.node_file._id]", "        self.project.save()", "        self.version = FileVersionFactory(date_modified=datetime.datetime.now())", "        self.record, _ = OsfStorageFileRecord.get_or_create(self.node_file.path, self.node_settings)", "        self.record.versions = [self.version]", "        self.record.save()", "", "    def test_migrate_dates(self):", "        assert_not_equal(self.version.date_modified, self.date)", "        main(dry_run=False)", "        assert_equal(self.version.date_created, self.date)"]}, {"lines": ["        targets = get_targets()", "        assert targets is not None", "        assert len(targets) is 1"]}, {"lines": ["        targets = get_targets()", "        do_migration(targets)"]}, {"lines": ["from nose.tools import *  # noqa"]}, {"lines": ["import webtest"]}, {"lines": ["from modularodm import storage"]}, {"lines": ["from framework.mongo import set_up_storage"]}, {"lines": ["from website.addons.base import exceptions, GuidFile"]}, {"lines": ["from tests.base import OsfTestCase", "from tests.factories import AuthUserFactory, ProjectFactory"]}, {"lines": ["", "", "class DummyGuidFile(GuidFile):", "", "    file_name = 'foo.md'", "    name = 'bar.md'", "", "    @property", "    def provider(self):", "        return 'dummy'", "", "    @property", "    def version_identifier(self):", "        return 'versionidentifier'", "", "    @property", "    def unique_identifier(self):", "        return 'dummyid'", "", "    @property", "    def waterbutler_path(self):", "        return '/path/to/file/'", "", "    def enrich(self):", "        pass"]}, {"lines": ["            '/static/addons/test/foo'"]}, {"lines": ["    def test_deleted_defaults_to_false(self):", "        class MyAddonSettings(AddonNodeSettingsBase):", "            pass", "", "        config = MyAddonSettings()", "        assert_is(config.deleted, False)", ""]}, {"lines": ["        assert_equal(res.status_code, 401)"]}, {"lines": ["class OsfFileTestCase(OsfTestCase):", "", "    @classmethod", "    def setUpClass(cls):", "        super(OsfTestCase, cls).setUpClass()", "        set_up_storage([DummyGuidFile], storage.MongoStorage)", "", "", "class TestAddonFileViewHelpers(OsfFileTestCase):"]}, {"lines": ["        assert_equals(resp.headers['Location'], guid.download_url + '&action=download')"]}, {"lines": ["        assert_equals(args[-1], {'action': 'view'})"]}, {"lines": ["        self.node_addon = self.project.get_addon('osfstorage')"]}, {"lines": ["        self.node_addon.save()", "        file_record.save()"]}, {"lines": ["from tests.base import assert_before"]}, {"lines": ["    assert_in(framework.transactions.handlers.transaction_before_request, before_funcs)"]}, {"lines": ["    assert_before(", "        before_funcs,", "        framework.transactions.handlers.transaction_before_request,", "        framework.sessions.prepare_private_key", "    )"]}, {"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-", "import unittest"]}, {"lines": ["import mock"]}, {"lines": ["import datetime"]}, {"lines": ["import httplib as http"]}, {"lines": [""]}, {"lines": ["from flask import Flask"]}, {"lines": ["from werkzeug.wrappers import BaseResponse"]}, {"lines": [""]}, {"lines": ["from framework.auth import cas"]}, {"lines": [")"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["    def test_unreg_user_can_register(self):", "        user = UnregUserFactory()", ""]}, {"lines": [""]}, {"lines": ["        assert_true(user.get_confirmation_token(user.username))"]}, {"lines": [""]}, {"lines": ["    def test_get_user_by_id(self):", "        user = UserFactory()"]}, {"lines": [""]}, {"lines": ["        user = UserFactory()"]}, {"lines": ["", "    def test_get_user_with_wrong_password_returns_false(self):", "        user = UserFactory.build()", "        user.set_password('killerqueen')"]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["    def test_factory(self):", "        auth_obj = AuthFactory()"]}, {"lines": ["        assert_true(auth_obj.api_key)", ""]}, {"lines": ["    def test_from_kwargs(self):", "        user = UserFactory()"]}, {"lines": ["        kwargs = {'user': user, 'api_key': 'myapikey', 'api_node': '123v'}"]}, {"lines": ["        auth_obj = Auth.from_kwargs(request_args, kwargs)", "        assert_equal(auth_obj.user, user)", "        assert_equal(auth_obj.api_key, kwargs['api_key'])"]}, {"lines": ["", "    def test_logged_in(self):", "        user = UserFactory()"]}, {"lines": ["        auth_obj = Auth(user=user)", "        assert_true(auth_obj.logged_in)"]}, {"lines": ["        auth2 = Auth(user=None)", "        assert_false(auth2.logged_in)", ""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.flaskapp = Flask('testing_private_links')", "", "        @self.flaskapp.route('/project/<pid>/')", "        @must_be_contributor", "        def project_get(**kwargs):", "            return 'success', 200", "", "        self.app = TestApp(self.flaskapp)", "", "        self.user = AuthUserFactory()", "        self.project = ProjectFactory(is_public=False)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.project.decorators.Auth.from_kwargs')"]}, {"lines": ["        mock_from_kwargs.return_value = Auth(user=None)", "        res = self.app.get('/project/{0}'.format(self.project._primary_key),"]}, {"lines": ["        res = res.follow()", "        assert_equal(res.status_code, 200)", "        assert_equal(res.body, 'success')", ""]}, {"lines": ["    @mock.patch('website.project.decorators.Auth.from_kwargs')"]}, {"lines": ["        mock_from_kwargs.return_value = Auth(user=None)", "        res = self.app.get('/project/{0}'.format(self.project._primary_key),", "            {'key': None})", "        assert_is_redirect(res)", ""]}, {"lines": ["", "# Flask app for testing view decorators"]}, {"lines": ["decoratorapp = Flask('decorators')", "", "", "@must_be_contributor", "def view_that_needs_contributor(**kwargs):"]}, {"lines": ["", ""]}, {"lines": ["", "    def setUp(self):", "        self.ctx = decoratorapp.test_request_context()", "        self.ctx.push()", "", "    def tearDown(self):", "        self.ctx.pop()", ""]}, {"lines": ["class TestMustBeContributorDecorator(AuthAppTestCase):", "", "    def setUp(self):"]}, {"lines": ["        super(TestMustBeContributorDecorator, self).setUp()"]}, {"lines": ["        self.contrib = AuthUserFactory()", "        self.project = ProjectFactory()", "        self.project.add_contributor(self.contrib, auth=Auth(self.project.creator))", "        self.project.save()", ""]}, {"lines": ["    def test_must_be_contributor_when_user_is_contributor(self):"]}, {"lines": ["        result = view_that_needs_contributor(", "            pid=self.project._primary_key,"]}, {"lines": ["            api_key=self.contrib.auth[1],", "            api_node=self.project,", "            user=self.contrib)", "        assert_equal(result, self.project)", "", "    def test_must_be_contributor_when_user_is_not_contributor_raises_error(self):", "        non_contributor = AuthUserFactory()", "        with assert_raises(HTTPError):"]}, {"lines": ["            view_that_needs_contributor(", "                pid=self.project._primary_key,", "                api_key=non_contributor.auth[1],", "                api_node=non_contributor.auth[1],", "                user=non_contributor", "            )"]}, {"lines": ["", "    def test_must_be_contributor_no_user(self):", "        res = view_that_needs_contributor(", "            pid=self.project._primary_key,", "            user=None,", "            api_key='123',", "            api_node='abc',", "        )", "        assert_is_redirect(res)"]}, {"lines": ["        # redirects to login url"]}, {"lines": ["        redirect_url = res.headers['Location']"]}, {"lines": ["        login_url = cas.get_login_url(service_url='http://localhost/')", "        assert_equal(redirect_url, login_url)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_logged_in", "def protected(**kwargs):", "    return 'open sesame'", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestPermissionDecorators(AuthAppTestCase):"]}, {"lines": [""]}, {"lines": ["        user = UserFactory()"]}, {"lines": ["        login_url = cas.get_login_url(service_url='http://localhost/')", "        assert_in(login_url, resp.headers.get('location'))"]}, {"lines": ["", ""]}, {"lines": ["if __name__ == '__main__':", "    unittest.main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "import mock"]}, {"lines": ["import unittest"]}, {"lines": ["from nose.tools import *  # flake8: noqa (PEP8 asserts)"]}, {"lines": ["import httpretty", "import furl"]}, {"lines": ["", "from framework.auth import cas", "", "from tests.base import OsfTestCase, fake", "from tests.factories import UserFactory", "", "def make_successful_response(user):", "    return cas.CasResponse(", "        authenticated=True, user=user._primary_key,", "        attributes={", "            'accessToken': fake.md5()", "        }", "    )", "", "def make_failure_response():", "    return cas.CasResponse(", "        authenticated=False, user=None,", "    )", ""]}, {"lines": ["RESPONSE_TEMPLATE = \"\"\"", "<cas:serviceResponse xmlns:cas='http://www.yale.edu/tp/cas'>", "    <cas:authenticationSuccess>", "        <cas:user>{user_id}</cas:user>", "            <cas:attributes>", "                        <cas:isFromNewLogin>true</cas:isFromNewLogin>", "                        <cas:authenticationDate>Tue May 19 02:20:19 UTC 2015</cas:authenticationDate>", "                        <cas:givenName>{given_name}</cas:givenName>", "                        <cas:familyName>{family_name}</cas:familyName>", "                        <cas:longTermAuthenticationRequestTokenUsed>true</cas:longTermAuthenticationRequestTokenUsed>", "                        <cas:accessToken>{access_token}</cas:accessToken>", "                        <cas:username>{username}</cas:username>", "            </cas:attributes>", "    </cas:authenticationSuccess>", "</cas:serviceResponse>", "\"\"\"", "def make_service_validation_response_body(user, access_token=None):", "    token = access_token or fake.md5()", "    return RESPONSE_TEMPLATE.format(", "        user_id=user._primary_key,", "        given_name=user.given_name,", "        family_name=user.family_name,", "        username=user.username,", "        access_token=token", "    )", ""]}, {"lines": [""]}, {"lines": ["def test_parse_authorization_header():", "    token = fake.md5()", "    valid = 'Bearer {}'.format(token)", "    assert_equal(cas.parse_auth_header(valid), token)", "", "    missing_token = 'Bearer '", "    with assert_raises(cas.CasTokenError):", "        cas.parse_auth_header(missing_token)", "", ""]}, {"lines": ["# TODO:", "class TestCASClient(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):", "        OsfTestCase.setUp(self)", "        self.base_url = 'http://accounts.test.test'", "        self.client = cas.CasClient(self.base_url)", "", "    @httpretty.activate", "    def test_service_validate(self):", "        user = UserFactory()", "        url = furl.furl(self.base_url)", "        url.path.segments.extend(('p3', 'serviceValidate',))", "        service_url = 'http://test.osf.io'", "        ticket = fake.md5()", "        body = make_service_validation_response_body(user, ticket)", "        httpretty.register_uri(", "            httpretty.GET,", "            url.url,", "            body=body,", "            status=200,", "        )", "        resp = self.client.service_validate(ticket, service_url)", "        assert_true(resp.authenticated)", "", "    @httpretty.activate", "    def test_service_validate_invalid_ticket_raises_error(self):", "        url = furl.furl(self.base_url)", "        url.path.segments.extend(('p3', 'serviceValidate',))", "        service_url = 'http://test.osf.io'", "        # Return error response", "        httpretty.register_uri(", "            httpretty.GET,", "            url.url,", "            body='invalid ticket...',", "            status=500,", "        )", "        with assert_raises(cas.CasHTTPError):", "            self.client.service_validate('invalid', service_url)", "", "    @httpretty.activate", "    def test_profile_invalid_access_token_raises_error(self):", "        url = furl.furl(self.base_url)", "        url.path.segments.extend(('oauth2', 'profile',))", "        httpretty.register_uri(", "            httpretty.GET,", "            url.url,", "            status=500,", "        )", "        with assert_raises(cas.CasHTTPError):", "            self.client.profile('invalid-access-token')", "", "    @unittest.skip('finish me')", "    def test_profile_valid_access_token_returns_cas_response(self):", "        assert 0", "", "    @unittest.skip('finish me')", "    def test_get_login_url(self):", "        assert 0", "", "    @unittest.skip('finish me')", "    def test_get_logout_url(self):", "        assert 0", ""]}, {"lines": ["", "class TestCASTicketAuthentication(OsfTestCase):", "", "    def setUp(self):", "        OsfTestCase.setUp(self)", "        self.user = UserFactory()", "", "    @mock.patch('framework.auth.cas.CasClient.service_validate')", "    def test_make_response_from_ticket_success(self, mock_service_validate):", "        mock_response = make_successful_response(self.user)", "        mock_service_validate.return_value = mock_response", "        ticket = fake.md5()", "        service_url = 'http://accounts.osf.io/?ticket=' + ticket", "        resp = cas.make_response_from_ticket(ticket, service_url)", "        assert_equal(resp.status_code, 302)", "        mock_service_validate.assert_called_once()", "        first_call_args = mock_service_validate.call_args[0]", "        assert_equal(first_call_args[0], ticket)", "        assert_equal(first_call_args[1], 'http://accounts.osf.io/')", "", "    @mock.patch('framework.auth.cas.CasClient.service_validate')", "    def test_make_response_from_ticket_failure(self, mock_service_validate):", "        mock_response = make_failure_response()", "        mock_service_validate.return_value = mock_response", "        ticket = fake.md5()", "        service_url = 'http://accounts.osf.io/?ticket=' + ticket", "        resp = cas.make_response_from_ticket(ticket, service_url)", "        assert_equal(resp.status_code, 302)", "        assert_equal(resp.location, 'http://accounts.osf.io/')", "", "    @mock.patch('framework.auth.cas.CasClient.service_validate')", "    def test_make_response_from_ticket_invalidates_verification_key(self, mock_service_validate):", "        self.user.verification_key = fake.md5()"]}, {"lines": ["        self.user.save()"]}, {"lines": ["        mock_response = make_successful_response(self.user)", "        mock_service_validate.return_value = mock_response", "        ticket = fake.md5()", "        service_url = 'http://accounts.osf.io/?ticket=' + ticket", "        resp = cas.make_response_from_ticket(ticket, service_url)"]}, {"lines": ["    def test_redirect_to_meetings_url(self):", "        url = '/presentations/'", "        res = self.app.get(url)", "        assert_equal(res.status_code, 302)", "        res = res.follow()", "        assert_equal(res.request.path, '/meetings/')", ""]}, {"lines": ["    def test_conference_plain_returns_200(self):", "        conference = ConferenceFactory()", "        url = web_url_for('conference_results__plain', meeting=conference.endpoint)", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import logging"]}, {"lines": ["from nose.tools import *  # flake8: noqa (PEP8 asserts)"]}, {"lines": ["from tests.base import OsfTestCase", "from tests.test_features import requires_search", "from tests.factories import (", "    UserFactory, ProjectFactory, NodeFactory,"]}, {"lines": [")", ""]}, {"lines": ["        # Add a user, change her name, and verify that only the new name is", "        # found in search."]}, {"lines": ["        # Test that disabled users are not in search index"]}, {"lines": ["        # Verify that a private project is not present in Elastic Search."]}, {"lines": ["        # Make project public, and verify that it is present in Elastic", "        # Search."]}, {"lines": [""]}, {"lines": ["        # Make project public, then private, and verify that it is not present", "        # in search."]}, {"lines": ["        # Make parent of component, public, then private, and verify that the", "        # component still appears but doesn't link to the parent in search."]}, {"lines": ["        # Add wiki text to page, then delete, then verify that project is not", "        # found when searching for wiki text."]}, {"lines": ["        # Add a contributor, then verify that project is found when searching", "        # for contributor."]}, {"lines": ["        # Add and remove a contributor, then verify that project is not found", "        # when searching for contributor."]}, {"lines": ["    # Tests of the search.search_contributor method"]}, {"lines": ["        # Searching for full name yields exactly one result."]}, {"lines": ["        # Searching for first name yields exactly one result."]}, {"lines": ["        # Searching for part of first name yields exactly one", "        # result."]}, {"lines": ["        # Searching for a fullname with a special character yields", "        # exactly one result."]}, {"lines": ["        # Searching for a first name with a special character yields", "        # exactly one result."]}, {"lines": [""]}, {"lines": ["        # Searching for a partial name with a special character yields", "        # exctly one result."]}, {"lines": [""]}, {"lines": ["        # Verify searching for singular term includes singular,", "        # possessive and plural versions in results."]}, {"lines": ["        # Verify searching for singular term includes singular,", "        # possessive and plural versions in results."]}, {"lines": ["        # Verify searching for possessive term includes singular,", "        # possessive and plural versions in results."]}, {"lines": ["    # Verify that the correct exception is thrown when the connection is lost"]}, {"lines": ["        logging.getLogger('website.project.model').setLevel(logging.CRITICAL)"]}, {"lines": ["        # Ensures that saving projects/users doesn't break as a result of connection errors"]}, {"lines": ["    # Verify that the correct indices are created/deleted during migration"]}, {"lines": ["from nose.tools import *  # noqa PEP8 asserts"]}, {"lines": ["        # Admin on parent project is removed as a contributor on a component. Check", "        #     that admin is not removed from component subscriptions, as the admin", "        #     now has read-only access."]}, {"lines": ["                        u'message': u'Hello',"]}, {"lines": ["                        u'message': u'Hello',"]}, {"lines": ["        }]", ""]}, {"lines": ["        args, kwargs = mock_send_mail.call_args", "", "        assert_equal(kwargs['to_addr'], user.username)", "        assert_equal(kwargs['mimetype'], 'html')", "        assert_equal(kwargs['mail'], mails.DIGEST)", "        assert_equal(kwargs['name'], user.fullname)", "        message = group_messages_by_node(user_groups[last_user_index]['info'])", "        assert_equal(kwargs['message'], message)", "        assert_equal(kwargs['callback'],", "                mock_callback.si(digest_notification_ids=digest_notification_ids))"]}, {"lines": ["        remove_sent_digest_notifications(digest_notification_ids=[digest_id])"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Tests for the permissions module.\"\"\"", "import unittest", "from nose.tools import *  # PEP8 asserts", "", "from website.util import permissions", ""]}, {"lines": ["def test_expand_permissions():", "    result = permissions.expand_permissions('admin')", "    assert_equal(result, ['read', 'write', 'admin'])", "", "    result2 = permissions.expand_permissions('write')", "    assert_equal(result2, ['read', 'write'])", "", "    result3 = permissions.expand_permissions(None)", "    assert_equal(result3, [])", ""]}, {"lines": ["def test_reduce_permissions():", "    result = permissions.reduce_permissions(['read', 'write', 'admin'])", "    assert_equal(result, 'admin')", "", "    result2 = permissions.reduce_permissions(['read', 'write'])", "    assert_equal(result2, 'write')", "", "    result3 = permissions.reduce_permissions(['read'])", "    assert_equal(result3, 'read')", ""]}, {"lines": ["def test_reduce_permissions_with_empty_list_raises_error():", "    with assert_raises(ValueError):", "        permissions.reduce_permissions([])", ""]}, {"lines": ["def test_reduce_permissions_with_unknown_permission_raises_error():", "    with assert_raises(ValueError):", "        permissions.reduce_permissions(['unknownpermission'])", ""]}, {"lines": ["def test_default_contributor_permissions():", "    assert_equal(permissions.DEFAULT_CONTRIBUTOR_PERMISSIONS,", "        ['read', 'write', 'admin'])", ""]}, {"lines": ["", "if __name__ == '__main__':", "    unittest.main()"]}, {"lines": ["import mock"]}, {"lines": ["    UnregUserFactory"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["    # https://trello.com/c/bYyt6nYT/89-clicking-retract-registration-with-unregistered-users-as-project-admins-gives-500-error", "    @mock.patch('website.project.views.register.mails.send_mail')", "    def test_POST_retraction_does_not_send_email_to_unregistered_admins(self, mock_send_mail):", "        unreg = UnregUserFactory()", "        self.registration.add_contributor(", "            unreg,", "            auth=Auth(self.user),", "            permissions=('read', 'write', 'admin')", "        )", "        self.registration.save()", "        self.app.post_json(", "            self.retraction_post_url,", "            {'justification': ''},", "            auth=self.auth,", "        )", "        # Only the creator gets an email; the unreg user does not get emailed", "        assert_equal(mock_send_mail.call_count, 1)", ""]}, {"lines": ["from nose.tools import *  # flake8: noqa"]}, {"lines": ["            '&lt;script&gt;&lt;/script&gt;',"]}, {"lines": ["            sanitize.safe_unescape_html(('&lt;&gt;&amp;', ))[0],", "            '<>&'", "        )", "        assert_equal("]}, {"lines": ["        )"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website.views import _render_node"]}, {"lines": ["from website.util import permissions"]}, {"lines": [""]}, {"lines": ["", "    # Regression test for #489", "    # https://github.com/CenterForOpenScience/openscienceframework.org/issues/489"]}, {"lines": ["        user = UserFactory()", "        # user cannot see this node", "        node = ProjectFactory(public=False)"]}, {"lines": ["            rescale_ratio=None,", "            primary=True,", "            link_id=None", "        )", "", "        # serialized result should have id and primary", "        assert_equal(result['summary']['id'], node._primary_key)", "        assert_true(result['summary']['primary'], True)"]}, {"lines": ["    def test_render_node(self):", "        node = ProjectFactory()", "        res = _render_node(node)", "        assert_equal(res['title'], node.title)", "        assert_equal(res['id'], node._primary_key)", "        assert_equal(res['url'], node.url)", "        assert_equal(res['api_url'], node.api_url)", "        assert_equal(res['primary'], node.primary)", "        assert_equal(res['date_modified'], framework_utils.iso8601format(node.date_modified))"]}, {"lines": ["        assert_equal(res['category'], 'project')", "", "    def test_render_node_returns_permissions(self):", "        node = ProjectFactory()", "        admin = UserFactory()", "        node.add_contributor(admin, auth=Auth(node.creator),", "            permissions=permissions.expand_permissions(permissions.ADMIN))", "        writer = UserFactory()", "        node.add_contributor(writer, auth=Auth(node.creator),", "            permissions=permissions.expand_permissions(permissions.WRITE))", "        node.save()", ""]}, {"lines": ["        assert_equal(res_admin['permissions'], 'admin')"]}, {"lines": ["        assert_equal(res_writer['permissions'], 'write')", ""]}, {"lines": ["", ""]}, {"lines": ["        assert_equal(user_info['profile_url'], self.profile)"]}, {"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-"]}, {"lines": ["'''Views tests for the OSF.'''"]}, {"lines": ["from __future__ import absolute_import"]}, {"lines": ["import unittest"]}, {"lines": ["import datetime as dt"]}, {"lines": ["import mock"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from framework import auth"]}, {"lines": [""]}, {"lines": ["from website.views import _rescale_ratio"]}, {"lines": ["from website.util import permissions"]}, {"lines": ["from website.models import Node, Pointer, NodeLog"]}, {"lines": ["from website.project.views.contributor import ("]}, {"lines": ["    send_claim_email,"]}, {"lines": ["    deserialize_contributors,", "    send_claim_registered_email,"]}, {"lines": [")"]}, {"lines": ["from website.profile.utils import add_contributor_json, serialize_unregistered"]}, {"lines": ["from website.util import api_url_for, web_url_for"]}, {"lines": ["from website.util import rubeus"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = AuthUserFactory()  # Is NOT a contributor", "        self.project = ProjectFactory(is_public=False)"]}, {"lines": [""]}, {"lines": ["    def test_has_private_link_key(self):"]}, {"lines": ["        assert_equal(res.status_code, 200)", ""]}, {"lines": ["    def test_not_logged_in_no_key(self):"]}, {"lines": ["        assert_is_redirect(res)"]}, {"lines": ["        assert_equal(res.status_code, 301)"]}, {"lines": ["            '/login'"]}, {"lines": ["", "    def test_logged_in_no_private_key(self):"]}, {"lines": ["        assert_equal(res.status_code, http.FORBIDDEN)", ""]}, {"lines": ["    def test_logged_in_has_key(self):"]}, {"lines": ["        assert_equal(res.status_code, 200)", ""]}, {"lines": ["    @unittest.skip('Skipping for now until we find a way to mock/set the referrer')", "    def test_prepare_private_key(self):"]}, {"lines": ["", "        res = res.click('Registrations')", "", "        assert_is_redirect(res)", "        res = res.follow()", "", "        assert_equal(res.status_code, 200)"]}, {"lines": [""]}, {"lines": ["    def test_check_can_access_valid(self):", "        contributor = AuthUserFactory()", "        self.project.add_contributor(contributor, auth=Auth(self.project.creator))", "        self.project.save()", "        assert_true(check_can_access(self.project, contributor))", "", "    def test_check_user_access_invalid(self):", "        noncontrib = AuthUserFactory()", "        with assert_raises(HTTPError):", "            check_can_access(self.project, noncontrib)", "", "    def test_check_user_access_if_user_is_None(self):", "        assert_false(check_can_access(self.project, None))"]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user1 = AuthUserFactory()"]}, {"lines": ["        self.user1.save()"]}, {"lines": ["        self.consolidate_auth1 = Auth(user=self.user1)"]}, {"lines": ["        self.auth = self.user1.auth"]}, {"lines": ["        self.user2 = UserFactory()", "        # A project has 2 contributors"]}, {"lines": ["        self.project.add_contributor(self.user2, auth=Auth(self.user1))"]}, {"lines": ["        self.project.save()", ""]}, {"lines": ["    def test_edit_description(self):", "        url = \"/api/v1/project/{0}/edit/\".format(self.project._id)", "        self.app.post_json(url,"]}, {"lines": ["        self.project.reload()", "        assert_equal(self.project.description, \"Deep-fried\")", ""]}, {"lines": ["    def test_project_api_url(self):", "        url = self.project.api_url", "        res = self.app.get(url, auth=self.auth)", "        data = res.json"]}, {"lines": ["        assert_equal(data['node']['title'], self.project.title)", "        assert_equal(data['node']['is_public'], self.project.is_public)", "        assert_equal(data['node']['is_registration'], False)", "        assert_equal(data['node']['id'], self.project._primary_key)", "        assert_equal(data['node']['watched_count'], 0)", "        assert_true(data['user']['is_contributor'])"]}, {"lines": ["        assert_equal(data['node']['description'], self.project.description)", "        assert_equal(data['node']['url'], self.project.url)", "        assert_equal(data['node']['tags'], [t._primary_key for t in self.project.tags])", "        assert_in('forked_date', data['node'])", "        assert_in('watched_count', data['node'])", "        assert_in('registered_from_url', data['node'])", "        # TODO: Test \"parent\" and \"user\" output"]}, {"lines": [""]}, {"lines": ["    def test_add_contributor_post(self):"]}, {"lines": ["        # Two users are added as a contributor via a POST request"]}, {"lines": ["        project = ProjectFactory(creator=self.user1, is_public=True)"]}, {"lines": ["        user2 = UserFactory()"]}, {"lines": ["        url = \"/api/v1/project/{0}/contributors/\".format(project._id)"]}, {"lines": ["        dict2 = add_contributor_json(user2)", "        dict3 = add_contributor_json(user3)"]}, {"lines": ["        project.reload()"]}, {"lines": ["        # A log event was added"]}, {"lines": ["        assert_equal(project.logs[-1].action, \"contributor_added\")"]}, {"lines": [""]}, {"lines": ["    def test_project_remove_contributor(self):"]}, {"lines": ["        url = \"/api/v1/project/{0}/removecontributors/\".format(self.project._id)"]}, {"lines": ["        # User 1 removes user2"]}, {"lines": ["        self.project.reload()", "        assert_not_in(self.user2._id, self.project.contributors)"]}, {"lines": ["        # A log event was added", "        assert_equal(self.project.logs[-1].action, \"contributor_removed\")"]}, {"lines": [""]}, {"lines": ["    def test_edit_node_title(self):", "        url = \"/api/v1/project/{0}/edit/\".format(self.project._id)", "        # The title is changed though posting form data"]}, {"lines": ["        self.project.reload()", "        # The title was changed", "        assert_equal(self.project.title, \"Bacon\")", "        # A log event was saved", "        assert_equal(self.project.logs[-1].action, \"edit_title\")"]}, {"lines": [""]}, {"lines": ["    def test_make_public(self):", "        self.project.is_public = False", "        self.project.save()", "        url = \"/api/v1/project/{0}/permissions/public/\".format(self.project._id)"]}, {"lines": ["        res = self.app.post_json(url, {}, auth=self.auth)"]}, {"lines": ["        self.project.reload()", "        assert_true(self.project.is_public)", "        assert_equal(res.json['status'], 'success')", ""]}, {"lines": ["    def test_make_private(self):"]}, {"lines": ["        self.project.is_public = True"]}, {"lines": ["        self.project.save()", "        url = \"/api/v1/project/{0}/permissions/private/\".format(self.project._id)", "        res = self.app.post_json(url, {}, auth=self.auth)", "        self.project.reload()", "        assert_false(self.project.is_public)", "        assert_equal(res.json['status'], 'success')", ""]}, {"lines": ["    def test_add_tag(self):"]}, {"lines": ["        self.project.reload()", "        assert_in(\"footag\", self.project.tags)", "", "    def test_remove_tag(self):"]}, {"lines": ["        assert_in(\"footag\", self.project.tags)"]}, {"lines": ["        self.project.reload()", "        assert_not_in(\"footag\", self.project.tags)"]}, {"lines": [""]}, {"lines": ["        self.project.reload()"]}, {"lines": ["        # A registration was added to the project's registration list"]}, {"lines": ["        # A log event was saved", "        assert_equal(self.project.logs[-1].action, \"project_registered\")", "        # Most recent node is a registration"]}, {"lines": ["        assert_true(reg.is_registration)", ""]}, {"lines": ["        # Add some logs"]}, {"lines": ["        self.project.save()"]}, {"lines": ["        res = self.app.get(url, auth=self.auth)"]}, {"lines": ["        self.project.reload()", "        data = res.json", "        assert_equal(len(data['logs']), len(self.project.logs))"]}, {"lines": ["        most_recent = data['logs'][0]"]}, {"lines": [""]}, {"lines": ["    def test_get_logs_with_count_param(self):", "        # Add some logs"]}, {"lines": ["        self.project.save()"]}, {"lines": ["        assert_equal(len(res.json['logs']), 3)"]}, {"lines": ["", "    def test_get_logs_defaults_to_ten(self):", "        # Add some logs"]}, {"lines": ["        self.project.save()"]}, {"lines": ["        res = self.app.get(url, auth=self.auth)", "        assert_equal(len(res.json['logs']), 10)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestChildrenViews(OsfTestCase):", "", "    def setUp(self):", "        OsfTestCase.setUp(self)", "        self.user = AuthUserFactory()", "", "    def test_get_children(self):", "        project = ProjectFactory(creator=self.user)"]}, {"lines": ["", "        url = project.api_url_for('get_children')", "        res = self.app.get(url, auth=self.user.auth)", "", "        nodes = res.json['nodes']", "        assert_equal(len(nodes), 1)", "        assert_equal(nodes[0]['id'], child._primary_key)", "", "    def test_get_children_includes_pointers(self):", "        project = ProjectFactory(creator=self.user)", "        pointed = ProjectFactory()", "        project.add_pointer(pointed, Auth(self.user))", "        project.save()", "", "        url = project.api_url_for('get_children')", "        res = self.app.get(url, auth=self.user.auth)", "", "        nodes = res.json['nodes']", "        assert_equal(len(nodes), 1)", "        assert_equal(nodes[0]['title'], pointed.title)"]}, {"lines": ["        pointer = Pointer.find_one(Q('node', 'eq', pointed))", "        assert_equal(nodes[0]['id'], pointer._primary_key)"]}, {"lines": [""]}, {"lines": ["    def test_get_children_filter_for_permissions(self):", "        # self.user has admin access to this project", "        project = ProjectFactory(creator=self.user)", "", "        # self.user only has read access to this project, which project points", "        # to"]}, {"lines": ["        read_only_creator = read_only_pointed.creator", "        read_only_pointed.add_contributor(self.user, auth=Auth(read_only_creator), permissions=['read'])", "        read_only_pointed.save()", "", "        # self.user only has read access to this project, which is a subproject", "        # of project", "        read_only = ProjectFactory()", "        read_only_pointed.add_contributor(self.user, auth=Auth(read_only_creator), permissions=['read'])", "        project.nodes.append(read_only)", ""]}, {"lines": ["        # self.user adds a pointer to read_only", "        project.add_pointer(read_only_pointed, Auth(self.user))", "        project.save()", "", "        url = project.api_url_for('get_children')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(len(res.json['nodes']), 2)", "", "        url = project.api_url_for('get_children', permissions='write')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(len(res.json['nodes']), 0)", ""]}, {"lines": ["        assert_is_instance(rescale_ratio, float)", "        assert_equal(rescale_ratio, _rescale_ratio(Auth(self.user), [child]))"]}, {"lines": ["        assert_equal(perm, 'admin')"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def test_unserialize_social_validation_failure(self):", "        url = api_url_for('unserialize_social')", "        # personal URL is invalid", "        payload = {", "            'personal': 'http://invalidurl',", "            'twitter': 'howtopizza',", "            'github': 'frozenpizzacode',", "        }", "        res = self.app.put_json(", "            url,", "            payload,", "            auth=self.user.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)", "        assert_equal(res.json['message_long'], 'Invalid personal URL.')", ""]}, {"lines": ["    def test_cannot_update_user_without_user_id(self):", "        user1 = AuthUserFactory()", "        url = api_url_for('update_user')", "        header = {'emails': [{'address': user1.username}]}", "        res = self.app.put_json(url, header, auth=user1.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)", "        assert_equal(res.json['message_long'], '\"id\" is required')"]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        ensure_schemas()"]}, {"lines": ["        self.creator = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.creator)", "        # Authenticate all requests", "        self.app.authenticate(*self.creator.auth)", ""]}, {"lines": ["    def test_serialize_unregistered_without_record(self):", "        name, email = fake.name(), fake.email()", "        res = serialize_unregistered(fullname=name, email=email)", "        assert_equal(res['fullname'], name)", "        assert_equal(res['email'], email)", "        assert_equal(res['id'], None)", "        assert_false(res['registered'])", "        assert_true(res['gravatar'])", "        assert_false(res['active'])", ""]}, {"lines": ["    def test_deserialize_contributors(self):"]}, {"lines": ["        contrib = UserFactory()", "        unreg = UnregUserFactory()", "        name, email = fake.name(), fake.email()", "        unreg_no_record = serialize_unregistered(name, email)"]}, {"lines": ["        contrib_data = ["]}, {"lines": ["            add_contributor_json(contrib),"]}, {"lines": ["            serialize_unregistered(fake.name(), unreg.username),", "            unreg_no_record", "        ]"]}, {"lines": ["        res = deserialize_contributors("]}, {"lines": ["            self.project,", "            contrib_data,"]}, {"lines": ["            auth=Auth(self.creator))"]}, {"lines": ["        assert_equal(len(res), len(contrib_data))"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def test_deserialize_contributors_sends_unreg_contributor_added_signal(self):", "        unreg = UnregUserFactory()"]}, {"lines": ["        serialized = [serialize_unregistered(fake.name(), unreg.username)]"]}, {"lines": ["        with capture_signals() as mock_signals:", "            deserialize_contributors(self.project, serialized,"]}, {"lines": ["        assert_equal(mock_signals.signals_sent(), set([unreg_contributor_added]))", ""]}, {"lines": ["    def test_serialize_unregistered_with_record(self):", "        name, email = fake.name(), fake.email()", "        user = self.project.add_unregistered_contributor(fullname=name,"]}, {"lines": ["        self.project.save()", "        res = serialize_unregistered(", "            fullname=name,", "            email=email", "        )", "        assert_false(res['active'])", "        assert_false(res['registered'])", "        assert_equal(res['id'], user._primary_key)"]}, {"lines": ["        assert_equal(res['fullname'], name)", "        assert_equal(res['email'], email)", ""]}, {"lines": ["    def test_add_contributor_with_unreg_contribs_and_reg_contribs(self):", "        n_contributors_pre = len(self.project.contributors)", "        reg_user = UserFactory()", "        name, email = fake.name(), fake.email()"]}, {"lines": ["        reg_dict = add_contributor_json(reg_user)"]}, {"lines": ["        payload = {"]}, {"lines": ["            'node_ids': []", "        }"]}, {"lines": ["        self.app.post_json(url, payload).maybe_follow()"]}, {"lines": ["        self.project.reload()", "        assert_equal(len(self.project.contributors),"]}, {"lines": [""]}, {"lines": ["        assert_false(new_unreg.is_registered)", "        # unclaimed record was added"]}, {"lines": ["        new_unreg.reload()"]}, {"lines": ["        assert_in(self.project._primary_key, new_unreg.unclaimed_records)"]}, {"lines": ["        rec = new_unreg.get_unclaimed_record(self.project._primary_key)", "        assert_equal(rec['name'], name)", "        assert_equal(rec['email'], email)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.project.views.contributor.send_claim_email')"]}, {"lines": ["        # Project has components"]}, {"lines": ["        self.project.nodes.append(comp1)", "        self.project.nodes.append(comp2)", "        self.project.save()", "", "        # An unreg user is added to the project AND its components", "        unreg_user = {  # dict because user has not previous unreg record", "            'id': None,", "            'registered': False,", "            'fullname': fake.name(),", "            'email': fake.email(),", "            'permission': 'admin',"]}, {"lines": ["        }", "        payload = {", "            'users': [unreg_user],", "            'node_ids': [comp1._primary_key, comp2._primary_key]", "        }", "", "        # send request"]}, {"lines": ["        assert self.project.can_edit(user=self.creator)"]}, {"lines": ["", "        # finalize_invitation should only have been called once", "        assert_equal(mock_send_claim_email.call_count, 1)", ""]}, {"lines": ["    @mock.patch('website.project.views.contributor.send_claim_email')"]}, {"lines": ["    def test_email_sent_when_unreg_user_is_added(self, send_mail):", "        name, email = fake.name(), fake.email()"]}, {"lines": ["        payload = {", "            'users': [pseudouser],", "            'node_ids': []", "        }"]}, {"lines": ["        self.app.post_json(url, payload).maybe_follow()", "        assert_true(send_mail.called)", "        assert_true(send_mail.called_with(email=email))", ""]}, {"lines": ["    def test_add_multiple_contributors_only_adds_one_log(self):", "        n_logs_pre = len(self.project.logs)", "        reg_user = UserFactory()"]}, {"lines": ["        reg_dict = add_contributor_json(reg_user)"]}, {"lines": ["        payload = {"]}, {"lines": ["            'node_ids': []", "        }"]}, {"lines": ["        self.project.reload()", "        assert_equal(len(self.project.logs), n_logs_pre + 1)", "", "    def test_add_contribs_to_multiple_nodes(self):"]}, {"lines": ["        n_contributors_pre = len(child.contributors)", "        reg_user = UserFactory()", "        name, email = fake.name(), fake.email()"]}, {"lines": ["        reg_dict = add_contributor_json(reg_user)"]}, {"lines": ["        payload = {"]}, {"lines": ["            'node_ids': [self.project._primary_key, child._primary_key]", "        }"]}, {"lines": ["        url = \"/api/v1/project/{0}/contributors/\".format(self.project._id)"]}, {"lines": ["        child.reload()", "        assert_equal(len(child.contributors),"]}, {"lines": ["", ""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        ensure_schemas()"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.user)"]}, {"lines": [""]}, {"lines": ["    def test_invite_contributor_post_if_not_in_db(self):"]}, {"lines": ["        name, email = fake.name(), fake.email()"]}, {"lines": ["        contrib = res.json['contributor']", "        assert_true(contrib['id'] is None)", "        assert_equal(contrib['fullname'], name)", "        assert_equal(contrib['email'], email)"]}, {"lines": [""]}, {"lines": ["    def test_invite_contributor_post_if_unreg_already_in_db(self):", "        # A n unreg user is added to a different project"]}, {"lines": ["        name, email = fake.name(), fake.email()"]}, {"lines": ["        project2 = ProjectFactory()", "        unreg_user = project2.add_unregistered_contributor(fullname=name, email=email,"]}, {"lines": ["        project2.save()"]}, {"lines": ["        res = self.app.post_json(self.invite_url,"]}, {"lines": ["        expected = add_contributor_json(unreg_user)"]}, {"lines": ["        expected['fullname'] = name", "        expected['email'] = email", "        assert_equal(res.json['contributor'], expected)"]}, {"lines": ["", "    def test_invite_contributor_post_if_emaiL_already_registered(self):", "        reg_user = UserFactory()", "        # Tries to invite user that is already regiestered", "        res = self.app.post_json(self.invite_url,"]}, {"lines": ["", "    def test_invite_contributor_post_if_user_is_already_contributor(self):", "        unreg_user = self.project.add_unregistered_contributor(", "            fullname=fake.name(), email=fake.email(),", "            auth=Auth(self.project.creator)", "        )", "        self.project.save()", "        # Tries to invite unreg user that is already a contributor", "        res = self.app.post_json(self.invite_url,"]}, {"lines": [""]}, {"lines": ["    def test_invite_contributor_with_no_email(self):"]}, {"lines": ["        name = fake.name()"]}, {"lines": ["        res = self.app.post_json(self.invite_url,"]}, {"lines": ["        assert_equal(data['status'], 'success')", "        assert_equal(data['contributor']['fullname'], name)", "        assert_true(data['contributor']['email'] is None)", "        assert_false(data['contributor']['registered'])"]}, {"lines": [""]}, {"lines": ["    def test_invite_contributor_requires_fullname(self):"]}, {"lines": ["        res = self.app.post_json(self.invite_url,"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.project.views.contributor.mails.send_mail')", "    def test_send_claim_email_to_given_email(self, send_mail):", "        project = ProjectFactory()", "        given_email = fake.email()"]}, {"lines": ["        project.save()", "        send_claim_email(email=given_email, user=unreg_user, node=project)", "", "        assert_true(send_mail.called)", "        assert_true(send_mail.called_with(", "            to_addr=given_email,", "            mail=mails.INVITE", "        ))", "", "    @mock.patch('website.project.views.contributor.mails.send_mail')", "    def test_send_claim_email_to_referrer(self, send_mail):", "        project = ProjectFactory()", "        referrer = project.creator", "        given_email, real_email = fake.email(), fake.email()", "        unreg_user = project.add_unregistered_contributor(fullname=fake.name(),"]}, {"lines": ["        project.save()", "        send_claim_email(email=real_email, user=unreg_user, node=project)", "", "        assert_true(send_mail.called)", "        # email was sent to referrer", "        assert_true(send_mail.called_with(", "            to_addr=referrer.username,", "            mail=mails.FORWARD_INVITE", "        ))", ""]}, {"lines": ["    @mock.patch('website.project.views.contributor.mails.send_mail')", "    def test_send_claim_email_before_throttle_expires(self, send_mail):", "        project = ProjectFactory()", "        given_email = fake.email()", "        unreg_user = project.add_unregistered_contributor(", "            fullname=fake.name(),", "            email=given_email,", "            auth=Auth(project.creator),", "        )", "        project.save()", "        send_claim_email(email=fake.email(), user=unreg_user, node=project)", "        # 2nd call raises error because throttle hasn't expired", "        with assert_raises(HTTPError):", "            send_claim_email(email=fake.email(), user=unreg_user, node=project)", "        send_mail.assert_not_called()", ""]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.referrer = AuthUserFactory()"]}, {"lines": ["        self.project = ProjectFactory(creator=self.referrer, is_public=True)"]}, {"lines": ["        self.given_name = fake.name()", "        self.given_email = fake.email()"]}, {"lines": ["        self.user = self.project.add_unregistered_contributor("]}, {"lines": ["            fullname=self.given_name,"]}, {"lines": ["            email=self.given_email,", "            auth=Auth(user=self.referrer)", "        )", "        self.project.save()"]}, {"lines": [""]}, {"lines": ["        reg_user = UserFactory()", "        payload = {", "            # pk of unreg user record", "            'pk': self.user._primary_key,", "            'claimerId': reg_user._primary_key", "        }"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.project.views.contributor.mails.send_mail')", "    def test_send_claim_registered_email(self, mock_send_mail):", "        reg_user = UserFactory()", "        send_claim_registered_email(", "            claimer=reg_user,", "            unreg_user=self.user,", "            node=self.project", "        )", "        mock_send_mail.assert_called()", "        assert_equal(mock_send_mail.call_count, 2)", "        first_call_args = mock_send_mail.call_args_list[0][0]", "        assert_equal(first_call_args[0], self.referrer.username)", "        second_call_args = mock_send_mail.call_args_list[1][0]", "        assert_equal(second_call_args[0], reg_user.username)", "", "    @mock.patch('website.project.views.contributor.mails.send_mail')", "    def test_send_claim_registered_email_before_throttle_expires(self, mock_send_mail):", "        reg_user = UserFactory()", "        send_claim_registered_email(", "            claimer=reg_user,", "            unreg_user=self.user,", "            node=self.project,", "        )", "        # second call raises error because it was called before throttle period", "        with assert_raises(HTTPError):", "            send_claim_registered_email(", "                claimer=reg_user,", "                unreg_user=self.user,", "                node=self.project,", "            )", "        mock_send_mail.assert_not_called()", ""]}, {"lines": ["    @mock.patch('website.project.views.contributor.send_claim_registered_email')"]}, {"lines": ["        reg_user = UserFactory()", "        payload = {", "            'value': reg_user.username,", "            'pk': self.user._primary_key", "        }"]}, {"lines": ["        assert_true(send_claim_registered_email.called)", ""]}, {"lines": ["", "    def test_claim_user_form_redirects_to_password_confirm_page_if_user_is_logged_in(self):"]}, {"lines": ["        reg_user = AuthUserFactory()"]}, {"lines": ["        res = self.app.get(url, auth=reg_user.auth)", "        assert_equal(res.status_code, 302)"]}, {"lines": [""]}, {"lines": ["    def test_get_valid_form(self):"]}, {"lines": ["        url = self.user.get_claim_url(self.project._primary_key)"]}, {"lines": ["        res = self.app.get(url).maybe_follow()", "        assert_equal(res.status_code, 200)"]}, {"lines": [""]}, {"lines": ["    def test_invalid_claim_form_redirects_to_register_page(self):"]}, {"lines": ["        uid = self.user._primary_key", "        pid = self.project._primary_key"]}, {"lines": ["        url = '/user/{uid}/{pid}/claim/?token=badtoken'.format(**locals())"]}, {"lines": ["        res = self.app.get(url, expect_errors=True).maybe_follow()"]}, {"lines": ["        assert_equal(res.status_code, 200)"]}, {"lines": [""]}, {"lines": ["    def test_posting_to_claim_form_with_valid_data(self):"]}, {"lines": ["        url = self.user.get_claim_url(self.project._primary_key)"]}, {"lines": ["        res = self.app.post(url, {", "            'username': self.user.username,", "            'password': 'killerqueen',", "            'password2': 'killerqueen'", "        }).maybe_follow()", "        assert_equal(res.status_code, 200)", "        self.user.reload()", "        assert_true(self.user.is_registered)"]}, {"lines": ["        assert_not_in(self.project._primary_key, self.user.unclaimed_records)"]}, {"lines": [""]}, {"lines": ["    def test_posting_to_claim_form_removes_all_unclaimed_data(self):", "        # user has multiple unclaimed records", "        p2 = ProjectFactory(creator=self.referrer)", "        self.user.add_unclaimed_record(node=p2, referrer=self.referrer,"]}, {"lines": ["        self.user.save()", "        assert_true(len(self.user.unclaimed_records.keys()) > 1)  # sanity check", "        url = self.user.get_claim_url(self.project._primary_key)"]}, {"lines": ["            'username': self.given_email,", "            'password': 'bohemianrhap',", "            'password2': 'bohemianrhap'", "        })", "        self.user.reload()", "        assert_equal(self.user.unclaimed_records, {})", ""]}, {"lines": ["    def test_posting_to_claim_form_sets_fullname_to_given_name(self):", "        # User is created with a full name", "        original_name = fake.name()", "        unreg = UnregUserFactory(fullname=original_name)", "        # User invited with a different name"]}, {"lines": ["            fullname=different_name,"]}, {"lines": ["        self.project.save()", "        # Goes to claim url"]}, {"lines": ["            'username': unreg.username,", "            'password': 'killerqueen', 'password2': 'killerqueen'", "        })", "        unreg.reload()", "        # Full name was set correctly", "        assert_equal(unreg.fullname, different_name)", "        # CSL names were set correctly"]}, {"lines": ["        assert_equal(unreg.given_name, parsed_name['given_name'])", "        assert_equal(unreg.family_name, parsed_name['family_name'])", ""]}, {"lines": ["    @mock.patch('website.project.views.contributor.mails.send_mail')", "    def test_claim_user_post_returns_fullname(self, send_mail):"]}, {"lines": ["        res = self.app.post_json(url,"]}, {"lines": ["        assert_equal(res.json['fullname'], self.given_name)", "        assert_true(send_mail.called)", "        assert_true(send_mail.called_with(to_addr=self.given_email))"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.project.views.contributor.mails.send_mail')", "    def test_claim_user_post_if_email_is_different_from_given_email(self, send_mail):", "        email = fake.email()  # email that is different from the one the referrer gave"]}, {"lines": ["        assert_true(send_mail.called)", "        assert_equal(send_mail.call_count, 2)", "        call_to_invited = send_mail.mock_calls[0]", "        assert_true(call_to_invited.called_with(", "            to_addr=email", "        ))", "        call_to_referrer = send_mail.mock_calls[1]", "        assert_true(call_to_referrer.called_with(", "            to_addr=self.given_email", "        ))", ""]}, {"lines": ["    def test_claim_url_with_bad_token_returns_400(self):"]}, {"lines": ["        res = self.app.get(url, auth=self.referrer.auth, expect_errors=400)"]}, {"lines": ["        assert_equal(res.status_code, 400)", ""]}, {"lines": ["    def test_cannot_claim_user_with_user_who_is_already_contributor(self):", "        # user who is already a contirbutor to the project", "        contrib = AuthUserFactory.build()", "        contrib.set_password('underpressure')", "        contrib.save()", "        self.project.add_contributor(contrib, auth=Auth(self.project.creator))", "        self.project.save()", "        # Claiming user goes to claim url, but contrib is already logged in", "        url = self.user.get_claim_url(self.project._primary_key)"]}, {"lines": ["        # Response is a 400", "        assert_equal(res.status_code, 400)"]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        api_key = ApiKeyFactory()", "        self.user.api_keys.append(api_key)", "        self.user.save()"]}, {"lines": ["        self.auth = ('test', self.user.api_keys[0]._id)  # used for requests auth"]}, {"lines": ["        # A public project", "        self.project = ProjectFactory(is_public=True)"]}, {"lines": ["        self.project.save()"]}, {"lines": ["        # A log added now"]}, {"lines": ["        # Clear watched list", "        self.user.watched = []", "        self.user.save()", "", "    def test_watching_a_project_appends_to_users_watched_list(self):", "        n_watched_then = len(self.user.watched)"]}, {"lines": ["        url = '/api/v1/project/{0}/watch/'.format(self.project._id)"]}, {"lines": ["        res = self.app.post_json(url,"]}, {"lines": ["        assert_equal(res.json['watchCount'], 1)"]}, {"lines": ["        self.user.reload()", "        n_watched_now = len(self.user.watched)", "        assert_equal(res.status_code, 200)", "        assert_equal(n_watched_now, n_watched_then + 1)"]}, {"lines": ["        assert_true(self.user.watched[-1].digest)"]}, {"lines": [""]}, {"lines": ["    def test_watching_project_twice_returns_400(self):"]}, {"lines": ["        url = \"/api/v1/project/{0}/watch/\".format(self.project._id)"]}, {"lines": ["        res = self.app.post_json(url,"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        # User tries to watch a node she's already watching"]}, {"lines": ["        res2 = self.app.post_json(url,"]}, {"lines": ["", "    def test_unwatching_a_project_removes_from_watched_list(self):", "        # The user has already watched a project"]}, {"lines": ["        watch_config = WatchConfigFactory(node=self.project)"]}, {"lines": ["        self.user.watch(watch_config)", "        self.user.save()", "        n_watched_then = len(self.user.watched)"]}, {"lines": ["        url = '/api/v1/project/{0}/unwatch/'.format(self.project._id)"]}, {"lines": ["        res = self.app.post_json(url, {}, auth=self.auth)"]}, {"lines": ["        self.user.reload()", "        n_watched_now = len(self.user.watched)", "        assert_equal(res.status_code, 200)", "        assert_equal(n_watched_now, n_watched_then - 1)"]}, {"lines": ["        assert_false(self.user.is_watching(self.project))", ""]}, {"lines": ["    def test_toggle_watch(self):"]}, {"lines": ["        # The user is not watching project", "        assert_false(self.user.is_watching(self.project))"]}, {"lines": ["        url = \"/api/v1/project/{0}/togglewatch/\".format(self.project._id)"]}, {"lines": ["        res = self.app.post_json(url, {}, auth=self.auth)", "        # The response json has a watchcount and watched property", "        assert_equal(res.json['watchCount'], 1)", "        assert_true(res.json['watched'])"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        self.user.reload()", "        # The user is now watching the project"]}, {"lines": ["        assert_true(res.json['watched'])"]}, {"lines": ["        assert_true(self.user.is_watching(self.project))"]}, {"lines": [""]}, {"lines": ["    def test_toggle_watch_node(self):", "        # The project has a public sub-node"]}, {"lines": ["        url = \"/api/v1/project/{}/node/{}/togglewatch/\".format(self.project._id,"]}, {"lines": ["        res = self.app.post_json(url, {}, auth=self.auth)"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        self.user.reload()", "        # The user is now watching the sub-node"]}, {"lines": ["        assert_true(res.json['watched'])"]}, {"lines": ["        assert_true(self.user.is_watching(node))"]}, {"lines": [""]}, {"lines": ["    def test_get_watched_logs(self):", "        project = ProjectFactory()", "        # Add some logs", "        for _ in range(12):", "            project.logs.append(NodeLogFactory(user=self.user, action=\"file_added\"))", "        project.save()", "        watch_cfg = WatchConfigFactory(node=project)", "        self.user.watch(watch_cfg)", "        self.user.save()", "        url = \"/api/v1/watched/logs/\"", "        res = self.app.get(url, auth=self.auth)"]}, {"lines": ["        assert_equal(res.json['logs'][0]['action'], 'file_added')", ""]}, {"lines": ["        assert_equal(res.json['logs'][0]['action'], 'file_added')", ""]}, {"lines": [""]}, {"lines": ["    def test_explore(self):", "        res = self.app.get(\"/explore/\").maybe_follow()", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["        assert_in('Forgot Password', res.body)"]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.auth = self.user.auth"]}, {"lines": ["", "    def test_merge_user(self):"]}, {"lines": ["        dupe.set_password(\"copycat\")", "        dupe.save()", "        url = \"/api/v1/user/merge/\""]}, {"lines": ["        self.user.reload()", "        dupe.reload()", "        assert_true(dupe.is_merged)", ""]}, {"lines": ["    @mock.patch('framework.auth.views.mails.send_mail')", "    def test_register_sends_confirm_email(self, send_mail):"]}, {"lines": ["        url = '/register/'"]}, {"lines": ["        self.app.post(url, {", "            'register-fullname': 'Freddie Mercury',", "            'register-username': 'fred@queen.com',", "            'register-password': 'killerqueen',", "            'register-username2': 'fred@queen.com',", "            'register-password2': 'killerqueen',", "        })", "        assert_true(send_mail.called)", "        assert_true(send_mail.called_with(", "            to_addr='fred@queen.com'", "        ))"]}, {"lines": [""]}, {"lines": ["    # Regression test for https://github.com/CenterForOpenScience/osf.io/issues/2902"]}, {"lines": ["    def test_register_post_sends_user_registered_signal(self):"]}, {"lines": ["        name, email, password = fake.name(), fake.email(), 'underpressure'", "        with capture_signals() as mock_signals:", "            self.app.post(url, {", "                'register-fullname': name,", "                'register-username': email,", "                'register-password': password,", "                'register-username2': email,", "                'register-password2': password", "            })", "        assert_equal(mock_signals.signals_sent(), set([auth.signals.user_registered]))", ""]}, {"lines": ["    def test_resend_confirmation_get(self):", "        res = self.app.get('/resend/')", "        assert_equal(res.status_code, 200)", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def test_confirmation_link_registers_user(self):", "        user = User.create_unconfirmed('brian@queen.com', 'bicycle123', 'Brian May')", "        assert_false(user.is_registered)  # sanity check", "        user.save()", "        confirmation_url = user.get_confirmation_url('brian@queen.com', external=False)", "        res = self.app.get(confirmation_url)", "        assert_equal(res.status_code, 302, 'redirects to settings page')", "        res = res.follow()", "        user.reload()", "        assert_true(user.is_registered)", ""]}, {"lines": ["    @unittest.skipIf(settings.USE_CELERY, 'Subscription must happen synchronously for this test')"]}, {"lines": ["        payload = {settings.MAILCHIMP_GENERAL_LIST: True}"]}, {"lines": ["        assert_true(user.mailing_lists[settings.MAILCHIMP_GENERAL_LIST])", "        assert_equal(", "            user.mailing_lists[settings.MAILCHIMP_GENERAL_LIST],", "            payload[settings.MAILCHIMP_GENERAL_LIST]", "        )"]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.project = ProjectFactory.build(creator=self.user, is_public=True)", "        self.project.add_contributor(self.user)", "        self.project.save()", "", "    def test_files_get(self):"]}, {"lines": ["        assert_equal(res.json['node'], expected['node'])", "        assert_in('tree_js', res.json)", "        assert_in('tree_css', res.json)", "", "    def test_grid_data(self):"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth).maybe_follow()"]}, {"lines": ["        expected = rubeus.to_hgrid(self.project, auth=Auth(self.user))", "        data = res.json['data']", "        assert_equal(len(data), len(expected))"]}, {"lines": [""]}, {"lines": ["        date_created = parse_date(str(res_comment.pop('dateCreated')))", "        date_modified = parse_date(str(res_comment.pop('dateModified')))"]}, {"lines": ["        date_created2 = parse_date(serialized_comment.pop('dateCreated'))", "        date_modified2 = parse_date(serialized_comment.pop('dateModified'))"]}, {"lines": ["        date_created = parse_date(str(res_comment.pop('dateCreated')))", "        date_modified = parse_date(str(res_comment.pop('dateModified')))"]}, {"lines": ["        date_created2 = parse_date(serialized_comment.pop('dateCreated'))", "        date_modified2 = parse_date(serialized_comment.pop('dateModified'))"]}, {"lines": ["        assert_in('login', res.headers.get('location'))"]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.user)", ""]}, {"lines": ["    def test_tag_get_returns_200(self):"]}, {"lines": ["        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "", ""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": [""]}, {"lines": ["    def test_search_contributor(self):"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        result = res.json['users']", "        assert_equal(len(result), 1)"]}, {"lines": ["    def test_search_projects(self):"]}, {"lines": ["        res = self.app.get(url, {'q': self.project.title})", "        assert_equal(res.status_code, 200)"]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.creator = AuthUserFactory()", "        self.contrib = AuthUserFactory()", "        # Project is public", "        self.project = ProjectFactory.build(creator=self.creator, public=True)", "        self.project.add_contributor(self.contrib, auth=Auth(self.creator))", "", "        # subcomponent that only creator can see", "        self.public_component = NodeFactory(creator=self.creator, public=True)", "        self.private_component = NodeFactory(creator=self.creator, public=False)", "        self.project.nodes.append(self.public_component)", "        self.project.nodes.append(self.private_component)", "", "        self.project.save()", "", "    # https://github.com/CenterForOpenScience/openscienceframework.org/issues/489", "    def test_reorder_components_with_private_component(self):", "", "        # contrib tries to reorder components"]}, {"lines": ["                '{0}:node'.format(self.private_component._primary_key),", "                '{0}:node'.format(self.public_component._primary_key),", "            ]", "        }"]}, {"lines": ["        res = self.app.post_json(url, payload, auth=self.contrib.auth)", "        assert_equal(res.status_code, 200)", "", ""]}, {"lines": [""]}, {"lines": ["    def test_components_with_are_accessible_from_dashboard(self):"]}, {"lines": ["        assert_equal(len(res.json['data']), 1)"]}, {"lines": [""]}, {"lines": ["    def test_get_dashboard_nodes(self):", "        project = ProjectFactory(creator=self.creator)"]}, {"lines": ["", "        url = api_url_for('get_dashboard_nodes')", "", "        res = self.app.get(url, auth=self.creator.auth)", "        assert_equal(res.status_code, 200)", "", "        nodes = res.json['nodes']"]}, {"lines": ["", "        project_serialized = nodes[0]", "        assert_equal(project_serialized['id'], project._primary_key)", "", "    def test_get_dashboard_nodes_shows_components_if_user_is_not_contrib_on_project(self):", "        # User creates a project with a component", "        project = ProjectFactory(creator=self.creator)"]}, {"lines": ["        # User adds friend as a contributor to the component but not the", "        # project", "        friend = AuthUserFactory()", "        component.add_contributor(friend, auth=Auth(self.creator))", "        component.save()", "", "        # friend requests their dashboard nodes", "        url = api_url_for('get_dashboard_nodes')", "        res = self.app.get(url, auth=friend.auth)", "        nodes = res.json['nodes']", "        # Response includes component", "        assert_equal(len(nodes), 1)", "        assert_equal(nodes[0]['id'], component._primary_key)", ""]}, {"lines": ["        url = api_url_for('get_dashboard_nodes', no_components=True)", "        res = self.app.get(url, auth=friend.auth)", "        nodes = res.json['nodes']", "        assert_equal(len(nodes), 0)", ""]}, {"lines": ["    def test_get_dashboard_nodes_admin_only(self):", "        friend = AuthUserFactory()", "        project = ProjectFactory(creator=self.creator)", "        # Friend is added as a contributor with read+write (not admin)", "        # permissions", "        perms = permissions.expand_permissions(permissions.WRITE)", "        project.add_contributor(friend, auth=Auth(self.creator), permissions=perms)", "        project.save()", "", "        url = api_url_for('get_dashboard_nodes')", "        res = self.app.get(url, auth=friend.auth)", "        assert_equal(res.json['nodes'][0]['id'], project._primary_key)", "", "        # Can filter project according to permission", "        url = api_url_for('get_dashboard_nodes', permissions='admin')", "        res = self.app.get(url, auth=friend.auth)", "        assert_equal(len(res.json['nodes']), 0)", "", "    def test_get_dashboard_nodes_invalid_permission(self):", "        url = api_url_for('get_dashboard_nodes', permissions='not-valid')", "        res = self.app.get(url, auth=self.creator.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)", ""]}, {"lines": [""]}, {"lines": ["        assert_equal(len(res.json['data']), 1)"]}, {"lines": [""]}, {"lines": ["        assert_equal(res2.status_code, 301)", "        assert_equal(res2.request.path, '/login')"]}, {"lines": ["class TestProfileNodeList(OsfTestCase):", "", "    def setUp(self):", "        OsfTestCase.setUp(self)", "        self.user = AuthUserFactory()", "", "        self.public = ProjectFactory(is_public=True)"]}, {"lines": ["        self.private = ProjectFactory(is_public=False)", "        self.deleted = ProjectFactory(is_public=True, is_deleted=True)", "", "        for node in (self.public, self.public_component, self.private, self.deleted):", "            node.add_contributor(self.user, auth=Auth(node.creator))", "            node.save()", "", "    def test_get_public_projects(self):", "        url = api_url_for('get_public_projects', uid=self.user._id)", "        res = self.app.get(url)", "        node_ids = [each['id'] for each in res.json['nodes']]", "        assert_in(self.public._id, node_ids)", "        assert_not_in(self.private._id, node_ids)", "        assert_not_in(self.deleted._id, node_ids)", "        assert_not_in(self.public_component._id, node_ids)", "", "    def test_get_public_components(self):", "        url = api_url_for('get_public_components', uid=self.user._id)", "        res = self.app.get(url)", "        node_ids = [each['id'] for each in res.json['nodes']]", "        assert_in(self.public_component._id, node_ids)", "        assert_not_in(self.public._id, node_ids)", "        assert_not_in(self.private._id, node_ids)", "        assert_not_in(self.deleted._id, node_ids)", ""]}, {"lines": ["class TestStaticFileViews(OsfTestCase):", "", "    def test_robots_dot_txt(self):", "        res = self.app.get('/robots.txt')", "        assert_equal(res.status_code, 200)", "        assert_in('User-agent', res)", "        assert_in('text/plain', res.headers['Content-Type'])", "", "    def test_favicon(self):", "        res = self.app.get('/favicon.ico')", "        assert_equal(res.status_code, 200)", "        assert_in('image/vnd.microsoft.icon', res.headers['Content-Type'])"]}, {"lines": [""]}, {"lines": ["    def test_getting_started_page(self):", "        res = self.app.get('/getting-started/')", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["if __name__ == '__main__':", "    unittest.main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "import unittest", "import smtplib", "", "from nose.tools import *  # PEP8 asserts", "", "from framework.email.tasks import send_email", "from website import settings", "", "# Check if local mail server is running", "SERVER_RUNNING = True", "try:"]}, {"lines": ["    s = smtplib.SMTP(settings.MAIL_SERVER)"]}, {"lines": ["    s.quit()", "except Exception as err:", "    SERVER_RUNNING = False", "", "", "class TestEmail(unittest.TestCase):", "", "    @unittest.skipIf(not SERVER_RUNNING,", "                     \"Mailserver isn't running. Run \\\"invoke mailserver\\\".\")"]}, {"lines": ["    def test_sending_email(self):", "        assert_true(send_email(\"foo@bar.com\", \"baz@quux.com\", subject='no subject',", "                                 message=\"<h1>Greetings!</h1>\", ttls=False, login=False))", "", "", "if __name__ == '__main__':", "    unittest.main()"]}, {"lines": ["from nose.tools import *  # flake8: noqa (PEP8 asserts)"]}, {"lines": ["from tests.base import fake"]}, {"lines": ["    # Regression test for https://github.com/CenterForOpenScience/osf.io/issues/2454", "    def test_add_unconfirmed_email_when_email_verifications_is_None(self):", "", "        self.user.email_verifications = None", "        self.user.save()", "        email = fake.email()", "        self.user.add_unconfirmed_email(email)", "        self.user.save()", "        assert_in(email, self.user.unconfirmed_emails)", ""]}, {"lines": ["        assert_true(u.is_confirmed)"]}, {"lines": ["        unconfirmed_username = self.unconfirmed.username"]}, {"lines": ["        # The mergee's email no longer needs to be confirmed by merger", "        unconfirmed_emails = [record['email'] for record in self.user.email_verifications.values()]", "        assert_not_in(unconfirmed_username, unconfirmed_emails)"]}, {"lines": ["        assert_in(self.user, self.project_with_unreg_contrib.contributors)"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Various text used throughout the website, e.g. status messages, errors, etc.", "\"\"\"", "", "", "# Status Messages", "#################", ""]}, {"lines": ["# NOTE: in status messages, newlines are not preserved, so triple-quotes strings", "# are ok", ""]}, {"lines": ["# Status message shown at settings page on first login"]}, {"lines": ["# (upon clicking primary email confirmation link)"]}, {"lines": [""]}, {"lines": ["", "# Shown if registration is turned off in website.settings", "REGISTRATION_UNAVAILABLE = 'Registration currently unavailable.'", ""]}, {"lines": ["", "# Shown if user tries to login with an email that is not yet confirmed"]}, {"lines": [""]}, {"lines": ["# Shown on incorrect password attempt", "LOGIN_FAILED = '''", "Log-in failed. Please try again or reset your password.", "'''", "", "# Shown at login page if user tries to access a resource that requires auth", "MUST_LOGIN = '''", "You must log in to access this resource.", "'''", "", "# Shown on logout", "LOGOUT = '''", "You have successfully logged out.", "'''", ""]}, {"lines": ["EMAIL_NOT_FOUND = '''", "<strong>{email}</strong> was not found in our records.", "'''", ""]}, {"lines": ["# Shown after an unregistered user claims an account and is redirected to the"]}, {"lines": ["# settings page"]}, {"lines": [""]}, {"lines": ["# Error Pages", "# ###########", "", "# Shown at error page if an expired/revokes email confirmation link is clicked"]}, {"lines": ["CANNOT_MERGE_ACCOUNTS_LONG = 'Accounts cannot be merged due to a possible conflict with add-ons. Please deactivate any add-ons authorized on the account to be merged and try again.'"]}, {"lines": ["    '<p>This email is confirmed to another account. '", "    'Would you like to merge <em>{user_to_merge.username}</em> with the account '", "    '<em>{user.username}</em>?<p>'", "    '<a class=\"btn btn-success\" href=\"?confirm_merge\">Confirm merge</a> '"]}, {"lines": ["edited or deleted but can be retracted. You can register your project by"]}, {"lines": ["however, and the frozen version with timestamps will always be linked to"]}, {"lines": ["when the registration was created and retracted but removes the contents"]}, {"lines": ["DISK_SAVING_MODE = 'Forks, registrations, and uploads to OSF Storage uploads are temporarily disabled while we are undergoing a server upgrade. These features will return shortly.'"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["\"\"\"OSF mailing utilities.", "", "Email templates go in website/templates/emails", "Templates must end in ``.txt.mako`` for plaintext emails or``.html.mako`` for html emails.", "", "You can then create a `Mail` object given the basename of the template and", "the email subject. ::", "", "    CONFIRM_EMAIL = Mail(tpl_prefix='confirm', subject=\"Confirm your email address\")", "", "You can then use ``send_mail`` to send the email.", "", "Usage: ::", "", "    from website import mails", "    ...", "    mails.send_mail('foo@bar.com', mails.CONFIRM_EMAIL, user=user)", "", "\"\"\""]}, {"lines": ["import os", "import logging", ""]}, {"lines": ["from mako.lookup import TemplateLookup, Template"]}, {"lines": ["from website import settings", "", "logger = logging.getLogger(__name__)", "", "EMAIL_TEMPLATES_DIR = os.path.join(settings.TEMPLATES_PATH, 'emails')", "", "_tpl_lookup = TemplateLookup("]}, {"lines": [")", "", "TXT_EXT = '.txt.mako'", "HTML_EXT = '.html.mako'", "", "", "class Mail(object):", "    \"\"\"An email object.", "", "    :param str tpl_prefix: The template name prefix.", "    :param str subject: The subject of the email.", "    \"\"\"", "", "    def __init__(self, tpl_prefix, subject):", "        self.tpl_prefix = tpl_prefix"]}, {"lines": ["        self._subject = subject"]}, {"lines": ["", "    def html(self, **context):", "        \"\"\"Render the HTML email message.\"\"\"", "        tpl_name = self.tpl_prefix + HTML_EXT", "        return render_message(tpl_name, **context)", "", "    def text(self, **context):", "        \"\"\"Render the plaintext email message\"\"\"", "        tpl_name = self.tpl_prefix + TXT_EXT", "        return render_message(tpl_name, **context)", ""]}, {"lines": ["    def subject(self, **context):", "        return Template(self._subject).render(**context)", ""]}, {"lines": ["", "def render_message(tpl_name, **context):", "    \"\"\"Render an email message.\"\"\"", "    tpl = _tpl_lookup.get_template(tpl_name)", "    return tpl.render(**context)", "", ""]}, {"lines": ["def send_mail(to_addr, mail, mimetype='plain', from_addr=None, mailer=None,"]}, {"lines": ["    \"\"\"Send an email from the OSF.", "    Example: ::", "", "        from website import mails", "", "        mails.send_email('foo@bar.com', mails.TEST, name=\"Foo\")", "", "    :param str to_addr: The recipient's email address", "    :param Mail mail: The mail object", "    :param str mimetype: Either 'plain' or 'html'"]}, {"lines": ["    :param **context: Context vars for the message template", "", "    .. note:"]}, {"lines": ["    \"\"\""]}, {"lines": ["    subject = mail.subject(**context)"]}, {"lines": ["    message = mail.text(**context) if mimetype in ('plain', 'txt') else mail.html(**context)"]}, {"lines": ["    logger.debug('Sending email...')"]}, {"lines": ["        to_addr=to_addr,"]}, {"lines": ["        subject=subject,"]}, {"lines": ["        message=message,", "        mimetype=mimetype,"]}, {"lines": ["        username=username,", "        password=password,"]}, {"lines": [""]}, {"lines": ["# Predefined Emails"]}, {"lines": [""]}, {"lines": ["TEST = Mail('test', subject='A test email to ${name}')"]}, {"lines": ["CONFIRM_EMAIL = Mail('confirm', subject='Confirm your email address')"]}, {"lines": ["INVITE = Mail('invite', subject='You have been added as a contributor to an OSF project.')"]}, {"lines": [""]}, {"lines": ["FORWARD_INVITE = Mail('forward_invite', subject='Please forward to ${fullname}')"]}, {"lines": ["FORWARD_INVITE_REGiSTERED = Mail('forward_invite_registered', subject='Please forward to ${fullname}')", ""]}, {"lines": ["FORGOT_PASSWORD = Mail('forgot_password', subject='Reset Password')"]}, {"lines": ["PENDING_VERIFICATION = Mail('pending_invite', subject=\"Your account is almost ready!\")"]}, {"lines": ["PENDING_VERIFICATION_REGISTERED = Mail('pending_registered', subject='Received request to be a contributor')"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from framework.auth import views as auth_views"]}, {"lines": [""]}, {"lines": ["from website.search import views as search_views"]}, {"lines": ["from website.profile import views as profile_views", "from website.project import views as project_views"]}, {"lines": [""]}, {"lines": ["def get_globals():"]}, {"lines": ["    \"\"\"Context variables that are available for every template rendered by", "    OSFWebRenderer."]}, {"lines": ["    \"\"\""]}, {"lines": ["    return {", "        'user_name': user.username if user else '',", "        'user_full_name': user.fullname if user else '',", "        'user_id': user._primary_key if user else '',"]}, {"lines": ["        'use_cdn': settings.USE_CDN_FOR_CLIENT_LIBS,"]}, {"lines": ["        'dev_mode': settings.DEV_MODE,", "        'allow_login': settings.ALLOW_LOGIN,"]}, {"lines": ["        'web_url_for': util.web_url_for,"]}, {"lines": ["    }", "", "", "class OsfWebRenderer(WebRenderer):", "", "    def __init__(self, *args, **kwargs):", "        kwargs['data'] = get_globals", "        super(OsfWebRenderer, self).__init__(*args, **kwargs)", ""]}, {"lines": ["#: Use if a view only redirects or raises error", "notemplate = OsfWebRenderer('', render_mako_string)", ""]}, {"lines": [""]}, {"lines": ["# Static files (robots.txt, etc.)", ""]}, {"lines": ["def favicon():"]}, {"lines": ["        settings.STATIC_FOLDER,", "        'favicon.ico',", "        mimetype='image/vnd.microsoft.icon'", "    )", ""]}, {"lines": ["def robots():", "    \"\"\"Serves the robots.txt file.\"\"\"", "    # Allow local robots.txt", "    if os.path.exists(os.path.join(settings.STATIC_FOLDER,", "                                   'robots.local.txt')):", "        robots_file = 'robots.local.txt'", "    else:", "        robots_file = 'robots.txt'", "    return send_from_directory(", "        settings.STATIC_FOLDER,", "        robots_file,", "        mimetype='text/plain'", "    )", ""]}, {"lines": [""]}, {"lines": ["    status.push_status_message(language.LOGOUT, 'info')"]}, {"lines": ["def make_url_map(app):", "    '''Set up all the routes for the OSF app.", "", "    :param app: A Flask/Werkzeug app to bind the rules to.", "    '''", "", "    # Set default views to 404, using URL-appropriate renderers", "    process_rules(app, [", "        Rule('/<path:_>', ['get', 'post'], HTTPError(http.NOT_FOUND),", "             OsfWebRenderer('', render_mako_string)),", "        Rule('/api/v1/<path:_>', ['get', 'post'],", "             HTTPError(http.NOT_FOUND), json_renderer),", "    ])", ""]}, {"lines": ["    # Static files"]}, {"lines": ["    process_rules(app, [", "        Rule('/favicon.ico', 'get', favicon, json_renderer),"]}, {"lines": ["        Rule('/robots.txt', 'get', robots, json_renderer),"]}, {"lines": ["    ])", "", "    ### Base ###", "", "    process_rules(app, [", ""]}, {"lines": ["", "        Rule('/about/', 'get', {}, OsfWebRenderer('public/pages/about.mako')),", "        Rule('/howosfworks/', 'get', {}, OsfWebRenderer('public/pages/howosfworks.mako')),", "        Rule('/faq/', 'get', {}, OsfWebRenderer('public/pages/faq.mako')),", "        Rule('/getting-started/', 'get', {}, OsfWebRenderer('public/pages/getting_started.mako')),", "        Rule('/explore/', 'get', {}, OsfWebRenderer('public/explore.mako')),", "        Rule(['/messages/', '/help/'], 'get', {}, OsfWebRenderer('public/comingsoon.mako')),", ""]}, {"lines": ["    ])", ""]}, {"lines": ["", "    process_rules(app, ["]}, {"lines": [""]}, {"lines": ["    ], prefix='/api/v1')", ""]}, {"lines": ["    ### Metadata ###"]}, {"lines": ["", "    process_rules(app, [", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    ], prefix='/api/v1')", "", "    ### Forms ###", "", "    process_rules(app, ["]}, {"lines": ["    ], prefix='/api/v1')", "", "    ### Discovery ###", "", "    process_rules(app, [", ""]}, {"lines": ["", "    ])", "", "    ### Auth ###", "", "    # Web", "", "    process_rules(app, [", "", "        Rule("]}, {"lines": ["            '/confirm/<uid>/<token>/',", "            'get',", "            auth_views.confirm_email_get,"]}, {"lines": ["            # View will either redirect or display error message", "            OsfWebRenderer('error.mako', render_mako_string)"]}, {"lines": ["        ),", "", "        Rule("]}, {"lines": ["            '/resetpassword/<verification_key>/',", "            ['get', 'post'],", "            auth_views.reset_password,", "            OsfWebRenderer('public/resetpassword.mako', render_mako_string)", "        ),", ""]}, {"lines": ["        # Resend confirmation URL linked to in CAS login page", "        Rule(", "            '/resend/',", "            ['get', 'post'],", "            auth_views.resend_confirmation,", "            OsfWebRenderer('resend.mako', render_mako_string)", "        ),", ""]}, {"lines": [""]}, {"lines": ["        Rule('/logout/', 'get', auth_views.auth_logout, notemplate),"]}, {"lines": ["", "        Rule([", "            '/midas/', '/summit/', '/accountbeta/', '/decline/'", "        ], 'get', auth_views.auth_registerbeta, OsfWebRenderer('', render_mako_string)),", ""]}, {"lines": ["    ])", "", "    ### Profile ###", "", "    # Web", "", "    process_rules(app, ["]}, {"lines": ["        Rule('/profile/', 'get', profile_views.profile_view, OsfWebRenderer('profile.mako')),"]}, {"lines": ["        Rule(['/user/<uid>/<pid>/claim/'], ['get', 'post'],"]}, {"lines": ["        Rule(['/user/<uid>/<pid>/claim/verify/<token>/'], ['get', 'post'],"]}, {"lines": ["    ])", "", "    # API", "", "    process_rules(app, [", "", "        Rule('/profile/', 'get', profile_views.profile_view, json_renderer),"]}, {"lines": ["        Rule('/profile/<uid>/', 'get', profile_views.profile_view_id, json_renderer),", "", "        # Used by profile.html", "        Rule('/profile/<uid>/edit/', 'post', profile_views.edit_profile, json_renderer),"]}, {"lines": [""]}, {"lines": ["        Rule('/settings/keys/', 'get', profile_views.get_keys, json_renderer),", "        Rule('/settings/create_key/', 'post', profile_views.create_user_key, json_renderer),", "        Rule('/settings/revoke_key/', 'post', profile_views.revoke_user_key, json_renderer),", "        Rule('/settings/key_history/<kid>/', 'get', profile_views.user_key_history, json_renderer),", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    ], prefix='/api/v1',)", "", "    ### Search ###", "", "    # Web", "", "    process_rules(app, [", ""]}, {"lines": ["        Rule('/api/v1/user/search/', 'get', search_views.search_contributor, json_renderer),", ""]}, {"lines": ["    ])", "", "    # API", "", "    process_rules(app, [", ""]}, {"lines": ["", "    ], prefix='/api/v1')", "", "    # Project", "", "    # Web", "", "    process_rules(app, [", ""]}, {"lines": ["", "        Rule([", "            '/project/<pid>/',", "            '/project/<pid>/node/<nid>/',"]}, {"lines": ["        ], 'get', project_views.node.view_project, OsfWebRenderer('project/project.mako')),"]}, {"lines": [""]}, {"lines": ["        Rule([", "            '/project/<pid>/key_history/<kid>/',", "            '/project/<pid>/node/<nid>/key_history/<kid>/',", "        ], 'get', project_views.key.node_key_history, OsfWebRenderer('project/key_history.mako')),", ""]}, {"lines": [""]}, {"lines": ["        # Permissions"]}, {"lines": ["", "        ### Logs ###", ""]}, {"lines": ["        # View forks", "        Rule([", "            '/project/<pid>/forks/',", "            '/project/<pid>/node/<nid>/forks/',", "        ], 'get', project_views.node.node_forks, OsfWebRenderer('project/forks.mako')),", "", "        # Registrations", "        Rule([", "            '/project/<pid>/register/',", "            '/project/<pid>/node/<nid>/register/',"]}, {"lines": ["", "        Rule([", "            '/project/<pid>/register/<template>/',", "            '/project/<pid>/node/<nid>/register/<template>/',"]}, {"lines": ["", "        Rule([", "            '/project/<pid>/registrations/',", "            '/project/<pid>/node/<nid>/registrations/',"]}, {"lines": [""]}, {"lines": ["        # Statistics", "        Rule([", "            '/project/<pid>/statistics/',", "            '/project/<pid>/node/<nid>/statistics/',"]}, {"lines": [""]}, {"lines": ["            ],", "            'get',", "            addon_views.addon_view_or_download_file_legacy,", "            OsfWebRenderer('project/view_file.mako'),", "        ),", "        Rule(", "            ["]}, {"lines": [""]}, {"lines": ["    ])", "", "    # API", "", "    process_rules(app, [", ""]}, {"lines": ["        Rule([", "            '/project/<pid>/contributors_abbrev/',", "            '/project/<pid>/node/<nid>/contributors_abbrev/',", "        ], 'get', project_views.contributor.get_node_contributors_abbrev, json_renderer),", "", "        Rule('/tags/<tag>/', 'get', project_views.tag.project_tag, json_renderer),", ""]}, {"lines": ["        Rule([", "            '/project/<pid>/',", "            '/project/<pid>/node/<nid>/',", "        ], 'get', project_views.node.view_project, json_renderer),"]}, {"lines": [""]}, {"lines": ["        Rule([", "            '/project/<pid>/get_summary/',", "            '/project/<pid>/node/<nid>/get_summary/',", "        ], 'get', project_views.node.get_summary, json_renderer),", "", "        Rule([", "            '/project/<pid>/get_children/',", "            '/project/<pid>/node/<nid>/get_children/',", "        ], 'get', project_views.node.get_children, json_renderer),", "        Rule(["]}, {"lines": ["            '/project/<pid>/get_forks/',", "            '/project/<pid>/node/<nid>/get_forks/',", "        ], 'get', project_views.node.get_forks, json_renderer),", "        Rule([", "            '/project/<pid>/get_registrations/',", "            '/project/<pid>/node/<nid>/get_registrations/',", "        ], 'get', project_views.node.get_registrations, json_renderer),", "", "        Rule('/log/<log_id>/', 'get', project_views.log.get_log, json_renderer),"]}, {"lines": ["        Rule([", "            '/project/<pid>/log/',", "            '/project/<pid>/node/<nid>/log/',", "        ], 'get', project_views.log.get_logs, json_renderer),", "", "        Rule([", "            '/project/<pid>/get_contributors/',", "            '/project/<pid>/node/<nid>/get_contributors/',", "        ], 'get', project_views.contributor.get_contributors, json_renderer),", ""]}, {"lines": ["        Rule([", "            '/project/<pid>/get_contributors_from_parent/',", "            '/project/<pid>/node/<nid>/get_contributors_from_parent/',", "        ], 'get', project_views.contributor.get_contributors_from_parent, json_renderer),", ""]}, {"lines": ["        Rule(["]}, {"lines": ["            '/project/<pid>/get_editable_children/',", "            '/project/<pid>/node/<nid>/get_editable_children/',", "        ], 'get', project_views.node.get_editable_children, json_renderer),", ""]}, {"lines": [""]}, {"lines": ["        # Remove"]}, {"lines": ["", "        # API keys", "        Rule([", "            '/project/<pid>/create_key/',", "            '/project/<pid>/node/<nid>/create_key/',", "        ], 'post', project_views.key.create_node_key, json_renderer),", "        Rule([", "            '/project/<pid>/revoke_key/',", "            '/project/<pid>/node/<nid>/revoke_key/'"]}, {"lines": ["        Rule([", "            '/project/<pid>/keys/',", "            '/project/<pid>/node/<nid>/keys/',", "        ], 'get', project_views.key.get_node_keys, json_renderer),", "", "        # Reorder components"]}, {"lines": ["", "        # Edit node", "        Rule([", "            '/project/<pid>/edit/',", "            '/project/<pid>/node/<nid>/edit/',", "        ], 'post', project_views.node.edit_node, json_renderer),", "", "        # Tags", "        Rule([", "            '/project/<pid>/addtag/<tag>/',", "            '/project/<pid>/node/<nid>/addtag/<tag>/',", "        ], 'post', project_views.tag.project_addtag, json_renderer),", "        Rule([", "            '/project/<pid>/removetag/<tag>/',", "            '/project/<pid>/node/<nid>/removetag/<tag>/',", "        ], 'post', project_views.tag.project_removetag, json_renderer),", ""]}, {"lines": ["        # Add / remove contributors", "        Rule(["]}, {"lines": ["            '/project/<pid>/contributors/',", "            '/project/<pid>/node/<nid>/contributors/',", "        ], 'post', project_views.contributor.project_contributors_post, json_renderer),"]}, {"lines": ["        Rule(["]}, {"lines": ["        # TODO(sloria): should be a delete request to /contributors/"]}, {"lines": ["            '/project/<pid>/removecontributors/',", "            '/project/<pid>/node/<nid>/removecontributors/',", "        ], 'post', project_views.contributor.project_removecontributor, json_renderer),", "", "        # Forks"]}, {"lines": ["", "        # View forks", "        Rule([", "            '/project/<pid>/forks/',", "            '/project/<pid>/node/<nid>/forks/',", "        ], 'get', project_views.node.node_forks, json_renderer),", "", "        # Registrations", "        Rule(["]}, {"lines": ["            '/project/<pid>/register/<template>/',", "            '/project/<pid>/node/<nid>/register/<template>/',", "        ], 'get', project_views.register.node_register_template_page, json_renderer),", "", "        Rule(["]}, {"lines": ["            '/project/<pid>/register/<template>/',", "            '/project/<pid>/node/<nid>/register/<template>/',", "        ], 'post', project_views.register.node_register_template_page_post, json_renderer),", ""]}, {"lines": ["        # Statistics", "        Rule([", "            '/project/<pid>/statistics/',", "            '/project/<pid>/node/<nid>/statistics/',", "        ], 'get', project_views.node.project_statistics, json_renderer),", "", "        # Permissions", "        Rule([", "            '/project/<pid>/permissions/<permissions>/',", "            '/project/<pid>/node/<nid>/permissions/<permissions>/',"]}, {"lines": [""]}, {"lines": ["", "        ### Wiki ###", ""]}, {"lines": ["        ### Watching ###", "        Rule([", "            '/project/<pid>/watch/',", "            '/project/<pid>/node/<nid>/watch/'", "        ], 'post', project_views.node.watch_post, json_renderer),", "", "        Rule([", "            '/project/<pid>/unwatch/',", "            '/project/<pid>/node/<nid>/unwatch/'", "        ], 'post', project_views.node.unwatch_post, json_renderer),", "", "        Rule([", "            '/project/<pid>/togglewatch/',", "            '/project/<pid>/node/<nid>/togglewatch/'", "        ], 'post', project_views.node.togglewatch_post, json_renderer),", ""]}, {"lines": ["        Rule([", "            '/watched/logs/'"]}, {"lines": ["        ### Accounts ###", "        Rule([", "            '/user/merge/'", "        ], 'post', auth_views.merge_user_post, json_renderer),", ""]}, {"lines": ["        # Endpoint to fetch Rubeus.JS/Hgrid-formatted data", "        Rule("]}, {"lines": ["            ],", "            'get',", "            project_views.file.grid_data,", "            json_renderer", "        ),", ""]}, {"lines": ["        # Invite Users"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/invite_contributor/',", "                '/project/<pid>/node/<nid>/invite_contributor/'", "            ],", "            'post',", "            project_views.contributor.invite_contributor_post,", "            json_renderer", "        ),"]}, {"lines": ["    ], prefix='/api/v1')"]}, {"lines": ["\"\"\"Consolidates all signals used by the OSF.\"\"\"", ""]}, {"lines": ["", ""]}, {"lines": ["                 has_hgrid_files=False, get_hgrid_data=None, max_file_size=None, high_max_file_size=None,"]}, {"lines": ["        self.high_max_file_size = high_max_file_size"]}, {"lines": ["        return '/static/addons/{addon}/{filename}'.format("]}, {"lines": ["    deleted = fields.BooleanField(default=False)"]}, {"lines": ["    @property", "    def has_auth(self):", "        \"\"\"Whether the user has added credentials for this addon.\"\"\"", "        return False", ""]}, {"lines": ["        ret['has_auth'] = self.has_auth"]}, {"lines": ["@oauth_complete.connect", "def oauth_complete(provider, account, user):", "    if not user or not account:", "        return", "    user.add_addon(account.provider)", "    user.save()", "", ""]}, {"lines": ["    _meta = {", "        'abstract': True,", "    }"]}, {"lines": ["    def to_json(self, user):", "        ret = super(AddonNodeSettingsBase, self).to_json(user)", "        ret.update({", "            'user': {", "                'permissions': self.owner.get_permissions(user)", "            },", "            'node': {"]}, {"lines": ["                'api_url': self.owner.api_url,", "                'url': self.owner.url,"]}, {"lines": ["                'is_registration': self.owner.is_registration,"]}, {"lines": ["        })", "        return ret", ""]}, {"lines": ["        return None, None"]}, {"lines": ["    _meta = {", "        'abstract': True,", "    }"]}, {"lines": ["                u'the {addon} add-on linked to this {category} will not be included '"]}, {"lines": ["    \"\"\"Load addon module return its create configuration object.", "", "    If `log_fp` is provided, the addon's log templates will be appended", "    to the file."]}, {"lines": ["    :param file log_fp: File pointer for the built logs file."]}, {"lines": ["            msg = \"addon_serialized_urls must include key '{0}'\".format(url)"]}, {"lines": ["            assert url in addon_urls, msg"]}, {"lines": ["    # If provider is OSFstorage, check existence of requested file in the filetree", "    # This prevents invalid GUIDs from being created", "    if provider == 'osfstorage':"]}, {"lines": ["        node_settings = node.get_addon('osfstorage')"]}, {"lines": [""]}, {"lines": ["    action = extras.get('action', 'view')"]}, {"lines": [""]}, {"lines": ["    # Disable OSF Storage file deletion in DISK_SAVING_MODE", "    if settings.DISK_SAVING_MODE and node_addon.config.short_name == 'osfstorage':", "        ret['user']['can_edit'] = False"]}, {"lines": ["logger = logging.getLogger(__name__)", ""]}, {"lines": ["    logger.warn('No local.py settings file found')"]}, {"lines": ["    'files': [],"]}, {"lines": ["logger = logging.getLogger(__name__)", ""]}, {"lines": ["    logger.warn('No local.py settings file found')"]}, {"lines": ["var ko = require('knockout');", "var bootbox = require('bootbox');"]}, {"lines": ["ko.punches.enableAll();"]}, {"lines": ["function ViewModel(url) {", "    var self = this;", "    self.url = url;", "    self.urls = ko.observable();"]}, {"lines": ["    self.ownerName = ko.observable();", "    self.nodeHasAuth = ko.observable(false);", "    self.userHasAuth = ko.observable(false);", "    self.userIsOwner = ko.observable(false);", "    self.connected = ko.observable(false);", "    self.loadedSettings = ko.observable(false);"]}, {"lines": ["    self.submitting = ko.observable(false);"]}, {"lines": ["    self.dataverses = ko.observableArray([]);"]}, {"lines": ["    self.savedDataverseAlias = ko.observable();", "    self.savedDataverseTitle = ko.observable();"]}, {"lines": [""]}, {"lines": ["    });"]}, {"lines": ["        return (self.urls()) ? self.urls().dataversePrefix + self.savedDataverseAlias() : null;", "    });"]}, {"lines": ["    self.selectedDataverseAlias = ko.observable();"]}, {"lines": ["            var data = self.dataverses()[i];", "            if (data.alias === self.selectedDataverseAlias()) {", "                return data.title;"]}, {"lines": ["        }", "        return null;", "    });"]}, {"lines": ["                return data.title;"]}, {"lines": ["        }", "        return null;", "    });"]}, {"lines": ["    });"]}, {"lines": ["    });"]}, {"lines": ["    });"]}, {"lines": ["    });"]}, {"lines": ["        return self.userHasAuth() && !self.nodeHasAuth() && self.loadedSettings();", "    });"]}, {"lines": ["        return self.nodeHasAuth() && !self.connected();", "    });"]}, {"lines": ["            (!self.userHasAuth() && !self.nodeHasAuth() && self.loadedSettings());", "    });"]}, {"lines": ["        return self.dataverses().length > 0;", "    });"]}, {"lines": ["    });"]}, {"lines": ["        return self.nodeHasAuth() && self.connected() && self.userIsOwner();", "    });"]}, {"lines": ["    });"]}, {"lines": ["    // Update above observables with data from the server", "    $.ajax({", "        url: url,", "        type: 'GET',", "        dataType: 'json'", "    }).done(function(response) {", "        // Update view model", "        self.updateFromData(response.result);", "        self.loadedSettings(true);", "    }).fail(function(xhr, textStatus, error) {"]}, {"lines": ["        Raven.captureMessage('Could not GET dataverse settings', {", "            url: url,", "            textStatus: textStatus,", "            error: error", "        });", "    });"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            }"]}, {"lines": ["    function sendDeauth() {", "        return $.ajax({", "            url: self.urls().deauthorize,", "            type: 'DELETE'", "        }).done(function() {", "            self.nodeHasAuth(false);", "            self.userIsOwner(false);", "            self.connected(false);"]}, {"lines": ["        }).fail(function() {"]}, {"lines": ["        });", "    }"]}, {"lines": ["        }"]}, {"lines": ["function DataverseNodeConfig(selector, url) {", "    // Initialization code", "    var self = this;", "    self.selector = selector;", "    self.url = url;", "    // On success, instantiate and bind the ViewModel", "    self.viewModel = new ViewModel(url);", "    osfHelpers.applyBindings(self.viewModel, '#dataverseScope');", "}", "module.exports = DataverseNodeConfig;"]}, {"lines": ["var DataverseNodeConfig = require('./dataverseNodeConfig.js');", "", "var url = window.contextVars.node.urls.api + 'dataverse/config/';", "new DataverseNodeConfig('#dataverseScope', url);"]}, {"lines": ["// #dataverseScope will only be in the DOM if the addon is properly configured", "if ($('#dataverseScope')[0]) {", "    new DataverseWidget('#dataverseScope', url);", "}"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["from dropbox.client import DropboxClient", "", "", "def get_client(user):", "    \"\"\"Return a :class:`dropbox.client.DropboxClient`, using a user's", "    access token.", "", "    :param User user: The user.", "    :raises: AddonError if user does not have the Dropbox addon enabled.", "    \"\"\"", "    user_settings = user.get_addon('dropbox')", "    if not user_settings:", "        raise AddonError('User does not have the Dropbox addon enabled.')", "    return DropboxClient(user_settings.access_token)", ""]}, {"lines": ["def get_client_from_user_settings(settings_obj):", "    \"\"\"Same as get client, except its argument is a DropboxUserSettingsObject.\"\"\"", "    return get_client(settings_obj.owner)"]}, {"lines": ["    raise AddonError('Node does not have the Dropbox addon enabled.')"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Dropbox addon routes.\"\"\"", "from framework.routing import Rule, json_renderer", "", "from website.addons.dropbox import views", "", ""]}, {"lines": ["auth_routes = {"]}, {"lines": ["    'rules': [", ""]}, {"lines": ["        Rule(", "            '/settings/dropbox/',", "            'get',", "            views.auth.dropbox_user_config_get,", "            json_renderer,", "        ),", ""]}, {"lines": ["        ##### OAuth #####"]}, {"lines": ["        Rule(", "            '/settings/dropbox/oauth/',", "            'get',"]}, {"lines": ["            views.auth.dropbox_oauth_start,  # Use same view func as node oauth start"]}, {"lines": ["            json_renderer,"]}, {"lines": ["            endpoint_suffix='_user'          # but add a suffix for url_for"]}, {"lines": ["        ),", "", "        Rule(", "            '/addons/dropbox/oauth/finish/',", "            'get',", "            views.auth.dropbox_oauth_finish,", "            json_renderer,", "        ),", "", "        Rule(", "            '/settings/dropbox/oauth/',", "            'delete',", "            views.auth.dropbox_oauth_delete_user,", "            json_renderer,"]}, {"lines": ["        ),", ""]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/dropbox/oauth/',", "                '/project/<pid>/node/<nid>/dropbox/oauth/',", "            ],", "            'get',", "            views.auth.dropbox_oauth_start,", "            json_renderer,", "        ),"]}, {"lines": ["    ],"]}, {"lines": ["    'prefix': '/api/v1'", "}", ""]}, {"lines": ["api_routes = {", "    'rules': ["]}, {"lines": ["", "        ##### Node settings #####", ""]}, {"lines": ["        Rule(", "            ['/project/<pid>/dropbox/config/',", "            '/project/<pid>/node/<nid>/dropbox/config/'],", "            'get',", "            views.config.dropbox_config_get,", "            json_renderer", "        ),", "", "        Rule(", "            ['/project/<pid>/dropbox/config/',", "            '/project/<pid>/node/<nid>/dropbox/config/'],", "            'put',", "            views.config.dropbox_config_put,", "            json_renderer", "        ),"]}, {"lines": ["        Rule(", "            ['/project/<pid>/dropbox/config/',", "            '/project/<pid>/node/<nid>/dropbox/config/'],", "            'delete',", "            views.config.dropbox_deauthorize,", "            json_renderer", "        ),", ""]}, {"lines": ["        Rule(", "            ['/project/<pid>/dropbox/config/import-auth/',", "            '/project/<pid>/node/<nid>/dropbox/config/import-auth/'],", "            'put',", "            views.config.dropbox_import_user_auth,", "            json_renderer", "        ),", ""]}, {"lines": ["", "        Rule(", "            ['/project/<pid>/dropbox/config/share/',", "            '/project/<pid>/node/<nid>/dropbox/config/share/'],", "            'get',", "            views.config.dropbox_get_share_emails,", "            json_renderer", "        ),", ""]}, {"lines": ["        ##### HGrid #####"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/dropbox/hgrid/',", "                '/project/<pid>/node/<nid>/dropbox/hgrid/',"]}, {"lines": ["                '/project/<pid>/dropbox/hgrid/<path:path>',", "                '/project/<pid>/node/<nid>/dropbox/hgrid/<path:path>',"]}, {"lines": ["            ],", "            'get',", "            views.hgrid.dropbox_hgrid_data_contents,", "            json_renderer", "        ),", "    ],", "    'prefix': '/api/v1'", "}"]}, {"lines": ["logger = logging.getLogger(__name__)", ""]}, {"lines": ["    logger.warn('No local.py settings file found')"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Example Dropbox local settings file. Copy this file to local.py and change", "these settings.", "\"\"\"", "# Get an app key and secret at https://www.dropbox.com/developers/apps", "DROPBOX_KEY = 'changeme'", "DROPBOX_SECRET = 'changeme'"]}, {"lines": ["var DropboxUserConfig = require('./dropboxUserConfig.js');", "", "// Endpoint for dropbox user settings", "var url = '/api/v1/settings/dropbox/';", "// Start up the Dropbox Config manager", "new DropboxUserConfig('#dropboxAddonScope', url);"]}, {"lines": ["<script type=\"text/html\" id=\"dropbox_file_added\">", "added file", "<a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect\">{{ params.path }}</a> to"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>"]}, {"lines": ["</script>", "", "", "<script type=\"text/html\" id=\"dropbox_file_removed\">"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>"]}, {"lines": ["", "", "<script type=\"text/html\" id=\"dropbox_folder_selected\">"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>"]}, {"lines": ["", "", "<script type=\"text/html\" id=\"dropbox_node_deauthorized\">"]}, {"lines": ["<a class=\"log-node-title-link overflow\"", "    data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", "", "", "<script type=\"text/html\" id=\"dropbox_node_authorized\">"]}, {"lines": ["    data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>"]}, {"lines": ["</script>"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Factory boy factories for the Dropbox addon.\"\"\"", ""]}, {"lines": ["from tests.factories import ModularOdmFactory, UserFactory, ProjectFactory"]}, {"lines": [""]}, {"lines": ["from website.addons.dropbox.model import (", "    DropboxUserSettings, DropboxNodeSettings, DropboxFile", ")"]}, {"lines": [""]}, {"lines": ["# TODO(sloria): make an abstract UserSettingsFactory that just includes the owner field", "class DropboxUserSettingsFactory(ModularOdmFactory):", "    FACTORY_FOR = DropboxUserSettings", "", "    owner = SubFactory(UserFactory)", "    access_token = Sequence(lambda n: 'abcdef{0}'.format(n))"]}, {"lines": ["", "", "class DropboxNodeSettingsFactory(ModularOdmFactory):", "    FACTORY_FOR = DropboxNodeSettings", ""]}, {"lines": ["    owner = SubFactory(ProjectFactory)"]}, {"lines": ["    user_settings = SubFactory(DropboxUserSettingsFactory)", "    folder = 'Camera Uploads'"]}, {"lines": ["", "", "class DropboxFileFactory(ModularOdmFactory):", "    FACTORY_FOR = DropboxFile", "", "    node = SubFactory(ProjectFactory)"]}, {"lines": ["    path = 'foo.txt'"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import os"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website.addons.dropbox.model import ("]}, {"lines": [")"]}, {"lines": ["from tests.factories import UserFactory, ProjectFactory"]}, {"lines": ["from website.addons.dropbox.tests.factories import ("]}, {"lines": ["    DropboxUserSettingsFactory, DropboxNodeSettingsFactory,"]}, {"lines": [")"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = UserFactory()", "", "    def test_fields(self):", "        user_settings = DropboxUserSettings(", "            access_token='12345',", "            dropbox_id='abc',", "            owner=self.user)", "        user_settings.save()"]}, {"lines": ["        retrieved = DropboxUserSettings.load(user_settings._primary_key)", "        assert_true(retrieved.access_token)", "        assert_true(retrieved.dropbox_id)", "        assert_true(retrieved.owner)"]}, {"lines": ["", "    def test_has_auth(self):", "        user_settings = DropboxUserSettingsFactory(access_token=None)", "        assert_false(user_settings.has_auth)", "        user_settings.access_token = '12345'", "        user_settings.save()", "        assert_true(user_settings.has_auth)"]}, {"lines": [""]}, {"lines": ["    def test_clear_clears_associated_node_settings(self):", "        node_settings = DropboxNodeSettingsFactory.build()", "        user_settings = DropboxUserSettingsFactory()", "        node_settings.user_settings = user_settings", "        node_settings.save()", "", "        user_settings.clear()", "        user_settings.save()", "", "        # Node settings no longer associated with user settings", "        assert_is(node_settings.user_settings, None)", "        assert_is(node_settings.folder, None)", "", "    def test_clear(self):", "        node_settings = DropboxNodeSettingsFactory.build()"]}, {"lines": ["        user_settings = DropboxUserSettingsFactory(access_token='abcde',", "            dropbox_id='abc')"]}, {"lines": ["        node_settings.user_settings = user_settings", "        node_settings.save()"]}, {"lines": ["", "        assert_true(user_settings.access_token)"]}, {"lines": ["        user_settings.clear()"]}, {"lines": ["        user_settings.save()", "        assert_false(user_settings.access_token)", "        assert_false(user_settings.dropbox_id)"]}, {"lines": [""]}, {"lines": ["    def test_delete(self):", "        user_settings = DropboxUserSettingsFactory()", "        assert_true(user_settings.has_auth)", "        user_settings.delete()", "        user_settings.save()", "        assert_false(user_settings.access_token)", "        assert_false(user_settings.dropbox_id)"]}, {"lines": [""]}, {"lines": ["    def test_to_json(self):", "        user_settings = DropboxUserSettingsFactory()", "        result = user_settings.to_json()", "        assert_equal(result['has_auth'], user_settings.has_auth)", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        self.user = UserFactory()", "        self.user.add_addon('dropbox')", "        self.user.save()", "        self.user_settings = self.user.get_addon('dropbox')"]}, {"lines": ["        self.project = ProjectFactory()", "        self.node_settings = DropboxNodeSettingsFactory(", "            user_settings=self.user_settings,", "            owner=self.project", "        )"]}, {"lines": [""]}, {"lines": ["    def test_fields(self):", "        node_settings = DropboxNodeSettings(user_settings=self.user_settings)", "        node_settings.save()", "        assert_true(node_settings.user_settings)", "        assert_equal(node_settings.user_settings.owner, self.user)"]}, {"lines": ["        assert_true(hasattr(node_settings, 'folder'))"]}, {"lines": ["        assert_true(hasattr(node_settings, 'registration_data'))"]}, {"lines": [""]}, {"lines": ["    def test_folder_defaults_to_none(self):"]}, {"lines": ["        node_settings = DropboxNodeSettings(user_settings=self.user_settings)", "        node_settings.save()"]}, {"lines": ["        assert_is_none(node_settings.folder)"]}, {"lines": [""]}, {"lines": ["    def test_has_auth(self):", "        settings = DropboxNodeSettings(user_settings=self.user_settings)", "        settings.save()", "        assert_false(settings.has_auth)", "", "        settings.user_settings.access_token = '123abc'", "        settings.user_settings.save()", "        assert_true(settings.has_auth)", "", "    def test_to_json(self):"]}, {"lines": ["        settings = self.node_settings"]}, {"lines": ["        user = UserFactory()", "        result = settings.to_json(user)", "        assert_equal(result['addon_short_name'], 'dropbox')"]}, {"lines": [""]}, {"lines": ["    def test_deauthorize(self):", "        assert_true(self.node_settings.user_settings)", "        assert_true(self.node_settings.folder)", "        self.node_settings.deauthorize(auth=Auth(self.user))", "        self.node_settings.save()", "        assert_is(self.node_settings.user_settings, None)", "        assert_is(self.node_settings.folder, None)", "", "        last_log = self.project.logs[-1]", "        assert_equal(last_log.action, 'dropbox_node_deauthorized')", "        params = last_log.params", "        assert_in('node', params)", "        assert_in('project', params)", "        assert_in('folder', params)"]}, {"lines": [""]}, {"lines": ["    def test_set_folder(self):", "        folder_name = 'queen/freddie'", "        self.node_settings.set_folder(folder_name, auth=Auth(self.user))", "        self.node_settings.save()", "        # Folder was set", "        assert_equal(self.node_settings.folder, folder_name)", "        # Log was saved", "        last_log = self.project.logs[-1]", "        assert_equal(last_log.action, 'dropbox_folder_selected')"]}, {"lines": [""]}, {"lines": ["    def test_set_user_auth(self):", "        node_settings = DropboxNodeSettingsFactory()", "        user_settings = DropboxUserSettingsFactory()", "", "        node_settings.set_user_auth(user_settings)", "        node_settings.save()", "", "        assert_true(node_settings.has_auth)", "        assert_equal(node_settings.user_settings, user_settings)", "        # A log was saved", "        last_log = node_settings.owner.logs[-1]", "        assert_equal(last_log.action, 'dropbox_node_authorized')", "        log_params = last_log.params"]}, {"lines": ["        assert_equal(log_params['node'], node_settings.owner._primary_key)", "        assert_equal(last_log.user, user_settings.owner)", ""]}, {"lines": ["            path,"]}, {"lines": ["        registration = self.project.register_node(", "            schema=None,", "            auth=Auth(user=self.project.creator),", "            template='Template1',", "            data='hodor'", "        )", "        assert_false(registration.has_addon('dropbox'))", ""]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        # Create node settings with auth"]}, {"lines": ["        self.user_settings = DropboxUserSettingsFactory(access_token='123abc')"]}, {"lines": ["", "        self.project = self.node_settings.owner"]}, {"lines": ["        self.user = self.user_settings.owner"]}, {"lines": [""]}, {"lines": ["    def test_after_fork_by_authorized_dropbox_user(self):", "        fork = ProjectFactory()", "        clone, message = self.node_settings.after_fork(", "            node=self.project, fork=fork, user=self.user_settings.owner", "        )", "        assert_equal(clone.user_settings, self.user_settings)", "", "    def test_after_fork_by_unauthorized_dropbox_user(self):", "        fork = ProjectFactory()", "        user = UserFactory()"]}, {"lines": [""]}, {"lines": ["    def test_before_fork(self):", "        node = ProjectFactory()", "        message = self.node_settings.before_fork(node, self.user)", "        assert_true(message)"]}, {"lines": [""]}, {"lines": ["    def test_before_remove_contributor_message(self):", "        message = self.node_settings.before_remove_contributor(", "            self.project, self.user)", "        assert_true(message)", "        assert_in(self.user.fullname, message)", "        assert_in(self.project.project_or_component, message)", ""]}, {"lines": ["        self.node_settings.save()", "        assert_is_none(self.node_settings.user_settings)", "        assert_true(message)"]}, {"lines": [""]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Views tests for the Dropbox addon.\"\"\""]}, {"lines": ["import os"]}, {"lines": ["import unittest"]}, {"lines": ["import mock"]}, {"lines": ["import httplib"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website.addons.dropbox.tests.utils import ("]}, {"lines": [")"]}, {"lines": ["from website.addons.dropbox.views.config import serialize_settings"]}, {"lines": ["from website.addons.dropbox import utils"]}, {"lines": [""]}, {"lines": ["mock_client = MockDropbox()", ""]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = AuthUserFactory()", "        # Log user in", "        self.app.authenticate(*self.user.auth)", "", "    def test_dropbox_oauth_start(self):"]}, {"lines": ["        res = self.app.get(url)", "        assert_is_redirect(res)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.dropbox.views.auth.DropboxOAuth2Flow.finish')"]}, {"lines": ["        mock_finish.return_value = ('mytoken123', 'mydropboxid', 'done')"]}, {"lines": ["        res = self.app.get(url)", "        assert_is_redirect(res)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.disable_access_token')", "    def test_dropbox_oauth_delete_user(self, mock_disable_access_token):", "        self.user.add_addon('dropbox')", "        settings = self.user.get_addon('dropbox')", "        settings.access_token = '12345abc'", "        settings.save()", "        assert_true(settings.has_auth)", "        self.user.save()"]}, {"lines": ["        settings.reload()", "        assert_false(settings.has_auth)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestConfigViews(DropboxAddonTestCase):", ""]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        # The JSON result", "        result = res.json['result']"]}, {"lines": ["        assert_true(result['userHasAuth'])"]}, {"lines": [""]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        # The JSONified URLs result", "        urls = res.json['result']['urls']"]}, {"lines": [""]}, {"lines": ["    def test_serialize_settings_helper_returns_correct_urls(self):"]}, {"lines": ["", "    def test_serialize_settings_helper_returns_correct_auth_info(self):"]}, {"lines": ["        assert_equal(result['nodeHasAuth'], self.node_settings.has_auth)"]}, {"lines": ["        assert_true(result['userHasAuth'])", "        assert_true(result['userIsOwner'])"]}, {"lines": [""]}, {"lines": ["    def test_serialize_settings_for_user_no_auth(self):", "        no_addon_user = AuthUserFactory()"]}, {"lines": ["        assert_false(result['userIsOwner'])", "        assert_false(result['userHasAuth'])", ""]}, {"lines": ["    def test_serialize_settings_helper_returns_correct_folder_info(self):"]}, {"lines": ["        folder = result['folder']"]}, {"lines": ["        assert_equal(folder['path'], self.node_settings.folder)", ""]}, {"lines": ["        self.user_settings.save()", ""]}, {"lines": ["", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        result = res.json['result']"]}, {"lines": ["        assert_equal(result['ownerName'], self.user_settings.owner.fullname)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def test_dropbox_config_put(self):"]}, {"lines": ["        # Can set folder through API call"]}, {"lines": ["        res = self.app.put_json(url, {'selected': {'path': 'My test folder',", "            'name': 'Dropbox/My test folder'}},"]}, {"lines": ["            auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.node_settings.reload()"]}, {"lines": ["        self.project.reload()"]}, {"lines": [""]}, {"lines": ["        # Folder was set", "        assert_equal(self.node_settings.folder, 'My test folder')", "        # A log event was created", "        last_log = self.project.logs[-1]", "        assert_equal(last_log.action, 'dropbox_folder_selected')", "        params = last_log.params", "        assert_equal(params['folder'], 'My test folder')"]}, {"lines": [""]}, {"lines": ["    def test_dropbox_deauthorize(self):"]}, {"lines": ["        saved_folder = self.node_settings.folder", "        self.app.delete(url, auth=self.user.auth)", "        self.project.reload()", "        self.node_settings.reload()", "", "        assert_false(self.node_settings.has_auth)", "        assert_is(self.node_settings.user_settings, None)", "        assert_is(self.node_settings.folder, None)", "", "        # A log event was saved", "        last_log = self.project.logs[-1]", "        assert_equal(last_log.action, 'dropbox_node_deauthorized')", "        log_params = last_log.params", "        assert_equal(log_params['node'], self.project._primary_key)", "        assert_equal(log_params['folder'], saved_folder)"]}, {"lines": [""]}, {"lines": ["        # Node does not have user settings", "        self.node_settings.user_settings = None", "        self.node_settings.save()"]}, {"lines": ["        res = self.app.put(url, auth=self.user.auth)", "        self.project.reload()", "        self.node_settings.reload()"]}, {"lines": ["        result = res.json['result']", "        assert_equal(result, expected_result)", ""]}, {"lines": ["        # Node does not have user settings", "        self.node_settings.user_settings = None", "        self.node_settings.save()"]}, {"lines": ["        self.app.put(url, auth=self.user.auth)"]}, {"lines": ["        self.project.reload()", "        self.node_settings.reload()", "        last_log = self.project.logs[-1]", "", "        assert_equal(last_log.action, 'dropbox_node_authorized')"]}, {"lines": ["        log_params = last_log.params"]}, {"lines": ["        assert_equal(log_params['node'], self.project._primary_key)"]}, {"lines": ["        assert_equal(last_log.user, self.user)"]}, {"lines": [""]}, {"lines": ["    def test_dropbox_get_share_emails(self):", "        # project has some contributors", "        contrib = AuthUserFactory()", "        self.project.add_contributor(contrib, auth=Auth(self.user))", "        self.project.save()"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        result = res.json['result']"]}, {"lines": ["        assert_equal(result['emails'], [u.username for u in self.project.contributors", "                                        if u != self.user])"]}, {"lines": ["        assert_equal(result['url'], utils.get_share_folder_uri(self.node_settings.folder))", "", "    def test_dropbox_get_share_emails_returns_error_if_not_authorizer(self):", "        contrib = AuthUserFactory()", "        contrib.add_addon('dropbox')", "        contrib.save()", "        self.project.add_contributor(contrib, auth=Auth(self.user))", "        self.project.save()"]}, {"lines": ["        # Non-authorizing contributor sends request", "        res = self.app.get(url, auth=contrib.auth, expect_errors=True)", "        assert_equal(res.status_code, httplib.FORBIDDEN)", "", "    def test_dropbox_get_share_emails_requires_user_addon(self):", "        # Node doesn't have auth", "        self.node_settings.user_settings = None", "        self.node_settings.save()"]}, {"lines": ["        # Non-authorizing contributor sends request", "        res = self.app.get(url, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, httplib.BAD_REQUEST)", "", ""]}, {"lines": ["class TestFilebrowserViews(DropboxAddonTestCase):", ""]}, {"lines": ["    def test_dropbox_hgrid_data_contents(self):"]}, {"lines": ["        with patch_client('website.addons.dropbox.views.hgrid.get_node_client'):"]}, {"lines": ["                path=self.node_settings.folder,"]}, {"lines": ["            res = self.app.get(url, auth=self.user.auth)"]}, {"lines": ["            assert_equal(len(res.json), len(contents))", "            first = res.json[0]", "            assert_in('kind', first)", "            assert_equal(first['path'], contents[0]['path'])"]}, {"lines": [""]}, {"lines": ["    def test_dropbox_hgrid_data_contents_if_folder_is_none_and_folders_only(self):", "        with patch_client('website.addons.dropbox.views.hgrid.get_node_client'):", "            self.node_settings.folder = None", "            self.node_settings.save()"]}, {"lines": ["            res = self.app.get(url, auth=self.user.auth)", "            contents = mock_client.metadata('', list=True)['contents']", "            expected = [each for each in contents if each['is_dir']]", "            assert_equal(len(res.json), len(expected))", ""]}, {"lines": ["    def test_dropbox_hgrid_data_contents_folders_only(self):"]}, {"lines": ["        with patch_client('website.addons.dropbox.views.hgrid.get_node_client'):"]}, {"lines": ["            res = self.app.get(url, auth=self.user.auth)", "            contents = mock_client.metadata('', list=True)['contents']", "            expected = [each for each in contents if each['is_dir']]", "            assert_equal(len(res.json), len(expected))"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.metadata')", "    def test_dropbox_hgrid_data_contents_include_root(self, mock_metadata):"]}, {"lines": ["        with patch_client('website.addons.dropbox.views.hgrid.get_node_client'):"]}, {"lines": ["            res = self.app.get(url, auth=self.user.auth)", "            contents = mock_client.metadata('', list=True)['contents']"]}, {"lines": ["            first_elem = res.json[0]", "            assert_equal(first_elem['path'], '/')"]}, {"lines": ["", "    @unittest.skip('finish this')", "    def test_dropbox_addon_folder(self):", "        assert 0, 'finish me'", ""]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.metadata')", "    def test_dropbox_hgrid_data_contents_deleted(self, mock_metadata):", "        # Example metadata for a deleted folder", "        mock_metadata.return_value = {", "            u'bytes': 0,", "            u'contents': [],", "            u'hash': u'e3c62eb85bc50dfa1107b4ca8047812b',", "            u'icon': u'folder_gray',", "            u'is_deleted': True,", "            u'is_dir': True,", "            u'modified': u'Sat, 29 Mar 2014 20:11:49 +0000',", "            u'path': u'/tests',", "            u'rev': u'3fed844002c12fc',", "            u'revision': 67033156,", "            u'root': u'dropbox',", "            u'size': u'0 bytes',", "            u'thumb_exists': False", "        }"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, httplib.NOT_FOUND)", ""]}, {"lines": ["", "class TestRestrictions(DropboxAddonTestCase):", "", "    def setUp(self):", "        super(DropboxAddonTestCase, self).setUp()", ""]}, {"lines": ["        # Nasty contributor who will try to access folders that he shouldn't have", "        # access to"]}, {"lines": ["        self.contrib = AuthUserFactory()", "        self.project.add_contributor(self.contrib, auth=Auth(self.user))"]}, {"lines": ["        self.project.save()"]}, {"lines": ["", "        # Set shared folder", "        self.node_settings.folder = 'foo bar/bar'"]}, {"lines": ["        self.node_settings.save()"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.metadata')", "    def test_restricted_hgrid_data_contents(self, mock_metadata):", "        mock_metadata.return_value = mock_responses['metadata_list']", ""]}, {"lines": ["        # tries to access a parent folder"]}, {"lines": ["        res = self.app.get(url, auth=self.contrib.auth, expect_errors=True)", "        assert_equal(res.status_code, httplib.FORBIDDEN)", ""]}, {"lines": ["    def test_restricted_config_contrib_no_addon(self):"]}, {"lines": ["        res = self.app.put_json(url, {'selected': {'path': 'foo'}},", "            auth=self.contrib.auth, expect_errors=True)", "        assert_equal(res.status_code, httplib.BAD_REQUEST)", "", "    def test_restricted_config_contrib_not_owner(self):", "        # Contributor has dropbox auth, but is not the node authorizer", "        self.contrib.add_addon('dropbox')", "        self.contrib.save()", ""]}, {"lines": ["        res = self.app.put_json(url, {'selected': {'path': 'foo'}},", "            auth=self.contrib.auth, expect_errors=True)", "        assert_equal(res.status_code, httplib.FORBIDDEN)"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import mock", "from contextlib import contextmanager"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website.addons.base.testing import AddonTestCase"]}, {"lines": ["from website.addons.dropbox import MODELS"]}, {"lines": [""]}, {"lines": ["", "def init_storage():"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class DropboxAddonTestCase(AddonTestCase):"]}, {"lines": [""]}, {"lines": ["", "    def set_user_settings(self, settings):", "        settings.access_token = '12345abc'", "        settings.dropbox_id = 'mydropboxid'", "", "    def set_node_settings(self, settings):", "        settings.folder = 'foo'", ""]}, {"lines": ["mock_responses = {", "    'put_file': {", "        'bytes': 77,", "        'icon': 'page_white_text',", "        'is_dir': False,", "        'mime_type': 'text/plain',", "        'modified': 'Wed, 20 Jul 2011 22:04:50 +0000',", "        'path': '/magnum-opus.txt',", "        'rev': '362e2029684fe',", "        'revision': 221922,", "        'root': 'dropbox',", "        'size': '77 bytes',", "        'thumb_exists': False"]}, {"lines": ["    },", "    'metadata_list': {", "        \"size\": \"0 bytes\",", "        \"hash\": \"37eb1ba1849d4b0fb0b28caf7ef3af52\",", "        \"bytes\": 0,", "        \"thumb_exists\": False,", "        \"rev\": \"714f029684fe\",", "        \"modified\": \"Wed, 27 Apr 2011 22:18:51 +0000\",", "        \"path\": \"/Public\",", "        \"is_dir\": True,", "        \"icon\": \"folder_public\",", "        \"root\": \"dropbox\",", "        \"contents\": [", "            {", "                \"size\": \"0 bytes\",", "                \"rev\": \"35c1f029684fe\",", "                \"thumb_exists\": False,", "                \"bytes\": 0,", "                \"modified\": \"Mon, 18 Jul 2011 20:13:43 +0000\",", "                \"client_mtime\": \"Wed, 20 Apr 2011 16:20:19 +0000\",", "                \"path\": \"/Public/latest.txt\",", "                \"is_dir\": False,", "                \"icon\": \"page_white_text\",", "                \"root\": \"dropbox\",", "                \"mime_type\": \"text/plain\",", "                \"revision\": 220191"]}, {"lines": ["            },", "            {", "                u'bytes': 0,", "                u'icon': u'folder',", "                u'is_dir': True,", "                u'modified': u'Sat, 22 Mar 2014 05:40:29 +0000',", "                u'path': u'/datasets/New Folder',", "                u'rev': u'3fed51f002c12fc',", "                u'revision': 67032351,", "                u'root': u'dropbox',", "                u'size': u'0 bytes',", "                u'thumb_exists': False"]}, {"lines": ["            }", "        ],", "        \"revision\": 29007"]}, {"lines": ["    },"]}, {"lines": ["    'metadata_single': {", "        u'bytes': 74,", "        u'client_mtime': u'Mon, 13 Jan 2014 20:24:15 +0000',", "        u'icon': u'page_white',", "        u'is_dir': False,", "        u'mime_type': u'text/csv',", "        u'modified': u'Fri, 21 Mar 2014 05:46:36 +0000',", "        u'path': '/datasets/foo.txt',", "        u'rev': u'a2149fb64',", "        u'revision': 10,", "        u'root': u'app_folder',", "        u'size': u'74 bytes',", "        u'thumb_exists': False", "    },"]}, {"lines": ["        u'client_mtime': u'Wed, 31 Dec 1969 23:59:59 +0000',", "        u'icon': u'page_white_picture',", "        u'is_deleted': True,", "        u'is_dir': False,", "        u'mime_type': u'image/png',", "        u'modified': u'Tue, 25 Mar 2014 03:39:13 +0000',", "        u'path': u'/svs-v-barks.png',", "        u'rev': u'3fed741002c12fc',", "        u'revision': 67032897,", "        u'root': u'dropbox',", "        u'size': u'0 bytes',", "        u'thumb_exists': True},", "        {u'bytes': 151164,", "        u'client_mtime': u'Sat, 13 Apr 2013 21:56:36 +0000',", "        u'icon': u'page_white_picture',", "        u'is_dir': False,", "        u'mime_type': u'image/png',", "        u'modified': u'Tue, 25 Mar 2014 01:45:51 +0000',", "        u'path': u'/svs-v-barks.png',", "        u'rev': u'3fed61a002c12fc',", "        u'revision': 67032602,", "        u'root': u'dropbox',", "        u'size': u'147.6 KB',", "        u'thumb_exists': True}]"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class MockDropbox(object):", ""]}, {"lines": ["    def put_file(self, full_path, file_obj, overwrite=False, parent_rev=None):"]}, {"lines": ["        return mock_responses['put_file']", ""]}, {"lines": ["    def metadata(self, path, list=True, file_limit=25000, hash=None, rev=None,", "            include_deleted=False):"]}, {"lines": ["        if list:"]}, {"lines": ["            ret = mock_responses['metadata_list']"]}, {"lines": ["        else:"]}, {"lines": ["            ret = mock_responses['metadata_single']", "            ret['path'] = path"]}, {"lines": ["        return ret"]}, {"lines": ["", "    def get_file_and_metadata(*args, **kwargs):", "        pass", ""]}, {"lines": ["    def file_delete(self, path):", "        return mock_responses['metadata_single']", ""]}, {"lines": ["    def revisions(self, path):", "        ret = mock_responses['revisions']", "        for each in ret:", "            each['path'] = path", "        return ret", ""]}, {"lines": ["", "@contextmanager"]}, {"lines": ["    \"\"\"Patches a function that returns a DropboxClient, returning an instance", "    of MockDropbox instead.", "", "    Usage: ::", "", "        with patch_client('website.addons.dropbox.view.config.get_client') as client:", "            # test view that uses the dropbox client.", "    \"\"\"", "    with mock.patch(target) as client_getter:"]}, {"lines": ["        client_getter.return_value = client", "        yield client"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"OAuth views for the Dropbox addon.\"\"\"", "import httplib as http"]}, {"lines": ["import logging"]}, {"lines": ["from collections import namedtuple"]}, {"lines": [""]}, {"lines": ["from werkzeug.wrappers import BaseResponse"]}, {"lines": [""]}, {"lines": ["from framework.sessions import session"]}, {"lines": ["from framework.auth.decorators import must_be_logged_in"]}, {"lines": ["from website.project.model import Node"]}, {"lines": ["from website.project.decorators import must_have_addon"]}, {"lines": [""]}, {"lines": ["from website.addons.dropbox import settings"]}, {"lines": ["from website.addons.dropbox.client import get_client_from_user_settings"]}, {"lines": ["", ""]}, {"lines": ["logger = logging.getLogger(__name__)", "debug = logger.debug", ""]}, {"lines": [""]}, {"lines": ["def get_auth_flow():"]}, {"lines": ["    # Dropbox only accepts https redirect uris unless using localhost"]}, {"lines": ["    redirect_uri = api_url_for('dropbox_oauth_finish', _absolute=True)"]}, {"lines": ["    return DropboxOAuth2Flow(", "        consumer_key=settings.DROPBOX_KEY,", "        consumer_secret=settings.DROPBOX_SECRET,", "        redirect_uri=redirect_uri,", "        session=session.data,", "        csrf_token_session_key=settings.DROPBOX_AUTH_CSRF_TOKEN", "    )", ""]}, {"lines": ["AuthResult = namedtuple('AuthResult', ['access_token', 'dropbox_id', 'url_state'])"]}, {"lines": [""]}, {"lines": ["    \"\"\"View helper for finishing the Dropbox Oauth2 flow. Returns the", "    access_token, dropbox_id, and url_state."]}, {"lines": [""]}, {"lines": ["    Handles various errors that may be raised by the Dropbox client.", "    \"\"\""]}, {"lines": ["    try:", "        access_token, dropbox_id, url_state = get_auth_flow().finish(request.args)", "    except DropboxOAuth2Flow.BadRequestException:", "        raise HTTPError(http.BAD_REQUEST)", "    except DropboxOAuth2Flow.BadStateException:", "        # Start auth flow again"]}, {"lines": ["        return redirect(api_url_for('dropbox_oauth_start'))"]}, {"lines": ["    except DropboxOAuth2Flow.CsrfException:", "        raise HTTPError(http.FORBIDDEN)"]}, {"lines": ["    except DropboxOAuth2Flow.NotApprovedException:  # User canceled flow", "        flash('Did not approve token.', 'info')"]}, {"lines": ["    except DropboxOAuth2Flow.ProviderException:", "        raise HTTPError(http.FORBIDDEN)"]}, {"lines": ["    return AuthResult(access_token, dropbox_id, url_state)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["    # Store the node ID on the session in order to get the correct redirect URL", "    # upon finishing the flow"]}, {"lines": ["    if nid:", "        session.data['dropbox_auth_nid'] = nid", "    if not user:", "        raise HTTPError(http.FORBIDDEN)", "    # If user has already authorized dropbox, flash error message", "    if user.has_addon('dropbox') and user.get_addon('dropbox').has_auth:"]}, {"lines": ["        flash('You have already authorized Dropbox for this account', 'warning')"]}, {"lines": ["", ""]}, {"lines": ["    \"\"\"View called when the Oauth flow is completed. Adds a new DropboxUserSettings", "    record to the user and saves the user's access token and account info.", "    \"\"\""]}, {"lines": ["        raise HTTPError(http.FORBIDDEN)"]}, {"lines": ["    node = Node.load(session.data.get('dropbox_auth_nid'))"]}, {"lines": ["    # If result is a redirect response, follow the redirect", "    if isinstance(result, BaseResponse):", "        return result"]}, {"lines": ["    # Make sure user has dropbox enabled", "    user.add_addon('dropbox')", "    user.save()", "    user_settings = user.get_addon('dropbox')"]}, {"lines": ["    user_settings.owner = user"]}, {"lines": ["    user_settings.access_token = result.access_token", "    user_settings.dropbox_id = result.dropbox_id"]}, {"lines": ["    user_settings.save()", ""]}, {"lines": ["    flash('Successfully authorized Dropbox', 'success')"]}, {"lines": ["    if node:"]}, {"lines": ["        del session.data['dropbox_auth_nid']"]}, {"lines": ["        # Automatically use newly-created auth", "        if node.has_addon('dropbox'):", "            node_addon = node.get_addon('dropbox')"]}, {"lines": ["            node_addon.set_user_auth(user_settings)"]}, {"lines": ["            node_addon.save()"]}, {"lines": ["        return redirect(node.web_url_for('node_setting'))"]}, {"lines": [""]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["@must_have_addon('dropbox', 'user')"]}, {"lines": ["def dropbox_oauth_delete_user(user_addon, auth, **kwargs):"]}, {"lines": ["    \"\"\"View for deauthorizing Dropbox.\"\"\""]}, {"lines": ["    user_addon.clear()"]}, {"lines": ["    user_addon.save()"]}, {"lines": ["    return None", "", "", "@must_be_logged_in", "@must_have_addon('dropbox', 'user')", "def dropbox_user_config_get(user_addon, auth, **kwargs):", "    \"\"\"View for getting a JSON representation of the logged-in user's", "    Dropbox user settings.", "    \"\"\"", "    urls = {"]}, {"lines": ["        'create': api_url_for('dropbox_oauth_start_user'),"]}, {"lines": ["        'delete': api_url_for('dropbox_oauth_delete_user')", "    }"]}, {"lines": ["    return {", "        'result': {", "            'userHasAuth': user_addon.has_auth,"]}, {"lines": ["        },"]}, {"lines": ["    }, http.OK"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import httplib as http"]}, {"lines": [""]}, {"lines": ["from website.util import rubeus"]}, {"lines": ["from website.addons.dropbox.client import get_node_client"]}, {"lines": ["from website.addons.dropbox.utils import ("]}, {"lines": ["    metadata_to_hgrid,", "    abort_if_not_subdir,"]}, {"lines": ["    is_authorizer,"]}, {"lines": [")"]}, {"lines": ["def dropbox_hgrid_data_contents(node_addon, auth, **kwargs):"]}, {"lines": ["    \"\"\"Return the Rubeus/HGrid-formatted response for a folder's contents.", "", "    Takes optional query parameters `foldersOnly` (only return folders) and", "    `includeRoot` (include the root folder).", "    \"\"\""]}, {"lines": ["    # No folder, just return an empty list of data"]}, {"lines": ["    node = node_addon.owner"]}, {"lines": ["    # Verify that path is a subdirectory of the node's shared folder"]}, {"lines": ["    if not is_authorizer(auth, node_addon):"]}, {"lines": ["        abort_if_not_subdir(path, node_addon.folder)"]}, {"lines": ["    permissions = {", "        'edit': node.can_edit(auth) and not node.is_registration,", "        'view': node.can_view(auth)", "    }"]}, {"lines": ["    # Raise error if folder was deleted", "    if metadata.get('is_deleted'):"]}, {"lines": ["    \"\"\"Return the Rubeus/HGrid-formatted response for the root folder only.\"\"\"", "    # Quit if node settings does not have authentication"]}, {"lines": ["        return None"]}, {"lines": ["    root = rubeus.build_addon_root(", "        node_settings=node_settings,", "        name=node_settings.folder,", "        permissions=auth,", "        nodeUrl=node.url,", "        nodeApiUrl=node.api_url,"]}, {"lines": ["    )", "    return [root]"]}, {"lines": ["def _get_project_url(node_settings, project, *args):", "    return os.path.join(node_settings.api_url, 'projects', str(project), *args)", ""]}, {"lines": ["    def __init__(self, client_token=None, client_secret=None, owner_token=None, owner_secret=None):"]}, {"lines": ["        registration = self.project.register_node(", "            schema=None,", "            auth=Auth(user=self.project.creator),", "            template='Template1',", "            data='hodor'", "        )", "        assert_false(registration.has_addon('figshare'))", ""]}, {"lines": ["// #forwardScope will only be present if Forward addon is configured", "if ($('#forwardScope')[0]) {", "    new ForwardWidget('#forwardScope', url);", "}"]}, {"lines": ["        \"\"\"Get a single Github repo's info."]}, {"lines": ["            See http://developer.github.com/v3/repos/#get", "        \"\"\""]}, {"lines": ["            http://developer.github.com/v3/repos/#list-branches", "        \"\"\""]}, {"lines": ["        :returns: tuple: Tuple of headers and file location"]}, {"lines": ["from website.addons.github import views"]}, {"lines": ["api_routes = {", "    'rules': ["]}, {"lines": ["    ],", "    'prefix': '/api/v1'", "}"]}, {"lines": ["var URI = require('URIjs');"]}, {"lines": ["<%include file=\"profile/addon_permissions.mako\" />"]}, {"lines": ["        registration = self.project.register_node(", "            schema=None,", "            auth=Auth(user=self.project.creator),", "            template='Template1',", "            data='hodor'", "        )", "        assert_false(registration.has_addon('github'))", ""]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import unittest"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = AuthUserFactory()"]}, {"lines": ["        self.project.creator.add_addon('github')", ""]}, {"lines": ["", "        self.node_settings = self.project.get_addon('github')", "        self.node_settings.user_settings = self.project.creator.get_addon('github')", "        # Set the node addon settings to correspond to the values of the mock repo"]}, {"lines": ["        self.node_settings.save()", ""]}, {"lines": ["        non_authenticated_auth = Auth(user=non_authenticated_user)"]}, {"lines": ["        assert_false(check_permissions(self.node_settings, non_authenticated_auth, connection, branch))"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["if __name__ == '__main__':", "    unittest.main()"]}, {"lines": ["logging.getLogger('github3').setLevel(logging.WARNING)", "logging.getLogger('requests.packages.urllib3.connectionpool').setLevel(logging.WARNING)", ""]}, {"lines": ["        if not folder or folder == '/':"]}, {"lines": ["        assert_equal(log_params['folder'], node_settings.folder_path)"]}, {"lines": [""]}, {"lines": ["    FACTORY_FOR = model.MendeleyUserSettings"]}, {"lines": ["    FACTORY_FOR = model.MendeleyNodeSettings"]}, {"lines": ["        self.node_settings = model.MendeleyNodeSettings(owner=self.node)"]}, {"lines": ["MAX_FILE_SIZE = 128  # 128 MB", "HIGH_MAX_FILE_SIZE = 5 * 1024  # 5 GB"]}, {"lines": ["logger = logging.getLogger(__name__)", ""]}, {"lines": ["    logger.warn('No local.py settings file found')"]}, {"lines": ["  removed {{ pathType(params.path) }} <span class=\"overflow\">"]}, {"lines": ["from factory import SubFactory, post_generation"]}, {"lines": ["        'files': node.web_url_for('collect_file_trees'),"]}, {"lines": ["        assert_is_none(clone)"]}, {"lines": ["        registration = self.project.register_node(", "            schema=None,", "            auth=Auth(user=self.project.creator),", "            template='Template1',", "            data='hodor'", "        )", "        assert_false(registration.has_addon('s3'))"]}, {"lines": ["from .models import TwoFactorUserSettings", "from .routes import settings_routes", ""]}, {"lines": ["CATEGORIES = ['security']"]}, {"lines": ["from . import views"]}, {"lines": ["            '/settings/twofactor/',"]}, {"lines": ["}"]}, {"lines": ["var TwoFactorUserConfig = require('./twoFactorUserConfig.js');", "", "var otpURL = window.contextVars.otpauthURL;", "// Initialize tfa user config widget", "new TwoFactorUserConfig('#twoFactorScope', '#twoFactorQrCode', otpURL);"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["    return version"]}, {"lines": ["    self.pageTitle = $(document).find('title').text();"]}, {"lines": ["    // Save initial query params (except for the \"mode\" query params, which are handled", "    // by self.currentURL), so that we can preserve them when we mutate window.history.state", "    var initialParams = $osf.urlParams();", "    delete initialParams.view;", "    delete initialParams.edit;", "    delete initialParams.compare;", "    delete initialParams.menu;", "    self.initialQueryParams = $.param(initialParams);"]}, {"lines": [""]}, {"lines": ["        var paramPrefix = '?';"]}, {"lines": ["        // Preserve initial query params", "        if (self.initialQueryParams) {", "            url += paramPrefix + self.initialQueryParams;"]}, {"lines": ["            paramPrefix = '&';", "        }"]}, {"lines": ["                    <p id=\"alert\" class=\"text-danger\"> </p>"]}, {"lines": ["</div>"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": [""]}, {"lines": ["from website.addons.wiki.model import NodeWikiPage, render_content"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": [""]}, {"lines": ["    def test_wiki_url_get_returns_200(self):"]}, {"lines": [""]}, {"lines": ["    def test_wiki_url_for_pointer_returns_200(self):"]}, {"lines": [""]}, {"lines": ["    def test_wiki_url_for_component_returns_200(self):"]}, {"lines": [""]}, {"lines": ["    def test_serialize_wiki_toc(self):", "        project = ProjectFactory()", "        auth = Auth(project.creator)"]}, {"lines": ["        project.save()"]}, {"lines": ["        # note: forward slashes not allowed in page_name", "        page_name = fake.catch_phrase().replace('/', ' ')"]}, {"lines": ["        # note: forward slashes not allowed in page_name", "        page_name = fake.catch_phrase().replace('/' , ' ')", "        page_content = fake.bs()"]}, {"lines": ["    def test_home_is_capitalized_in_web_view(self):", "        url = self.project.web_url_for('project_wiki_home', wid='home', _guid=True)", "        res = self.app.get(url, auth=self.user.auth).follow(auth=self.user.auth)", "        page_name_elem = res.html.find('span', {'id': 'pageName'})", "        assert_in('Home', page_name_elem.text)", ""]}, {"lines": ["    # Regression test for https://sentry.osf.io/osf/production/group/310/", "    def test_bad_links(self):", "        content = u'<span></span><iframe src=\"http://httpbin.org/\"></iframe>'", "        node = ProjectFactory()", "        wiki = NodeWikiFactory(content=content, node=node)", "        expected = render_content(content, node)", "        assert_equal(expected, wiki.html(node))", ""]}, {"lines": ["# TODO: Don't cap at 200 responses. We can only fetch 100 citations at a time. With lots", "# of citations, requesting the citations may take longer than the UWSGI harakiri time.", "# For now, we load 200 citations max and show a message to the user.", "MAX_CITATION_LOAD = 200"]}, {"lines": ["            while more and len(citations) <= MAX_CITATION_LOAD:"]}, {"lines": ["        while more and len(citations) <= MAX_CITATION_LOAD:"]}, {"lines": ["    \"\"\"Return the list of all of the current user's authorized Zotero accounts.\"\"\""]}, {"lines": ["    \"\"\"Serialize node addon settings and relevant urls"]}, {"lines": ["    \"\"\"Update ZoteroNodeSettings based on submitted account and folder information.\"\"\""]}, {"lines": ["    \"\"\"Allows for importing existing auth to ZoteroNodeSettings \"\"\""]}, {"lines": ["    \"\"\"Removes auth from ZoteroNodeSettings \"\"\""]}, {"lines": ["    \"\"\"Collects and serializes settting needed to build the widget.\"\"\""]}, {"lines": ["    \"\"\"Collects a listing of folders and citations based on the", "    passed zotero_list_id. If zotero_list_id is `None`, then all of the", "    authorizer's folders and citations are listed."]}, {"lines": ["        return '<{0}(_id={1}, name={2}, status={3})>'.format(", "            self.__class__.__name__,", "            self._id,", "            self.name,", "            self.status", "        )"]}, {"lines": ["    def __repr__(self):", "        return (", "            '<{ClassName}(_id={self._id}, done={self.done}, '", "            ' status={self.status}, src_node={self.src_node}, dst_node={self.dst_node})>'", "        ).format(ClassName=self.__class__.__name__, self=self)", ""]}, {"lines": ["    \"\"\"A persistent identifier model for DOIs, ARKs, and the like.\"\"\""]}, {"lines": ["    # object to which the identifier points"]}, {"lines": ["    # category: e.g. 'ark', 'doi'"]}, {"lines": ["    # value: e.g. 'FK424601'"]}, {"lines": ["    \"\"\"Model mixin that adds methods for getting and setting Identifier objects", "    for model objects.", "    \"\"\""]}, {"lines": ["LOCALTIME_FORMAT = '%H:%M on %A, %B %d %Z'"]}, {"lines": ["    if contributor._id not in node.admin_contributor_ids:"]}, {"lines": ["        for user_id in parent.child_node_subscriptions:", "            if node._id in parent.child_node_subscriptions[user_id]:", "                parent.child_node_subscriptions[user_id].remove(node._id)"]}, {"lines": ["from requests.exceptions import HTTPError as RequestsHTTPError"]}, {"lines": ["            except (MissingTokenError, RequestsHTTPError):"]}, {"lines": ["        # ensure that provider_name is correct", "        self.account.provider_name = self.name"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import framework"]}, {"lines": ["from website.filters import gravatar", "from website import settings"]}, {"lines": ["def get_projects(user):"]}, {"lines": ["", "def get_public_projects(user):", "    '''Return a list of a user's public projects.'''", "    return [p for p in get_projects(user) if p.is_public]", "", ""]}, {"lines": [""]}, {"lines": ["        'id': str(user._primary_key),"]}, {"lines": ["        'registered': user.is_registered,"]}, {"lines": ["    }"]}, {"lines": ["    if user.is_registered:"]}, {"lines": ["            'url': user.url,", "            'absolute_url': user.absolute_url,", "            'display_absolute_url': user.display_absolute_url,", "            'date_registered': user.date_registered.strftime(\"%Y-%m-%d\"),", "        })"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": ["    return {", "        'fullname': user.fullname,", "        'email': user.username,", "        'id': user._primary_key,"]}, {"lines": ["        'registered': user.is_registered,"]}, {"lines": ["        'gravatar_url': gravatar(", "            user, use_ssl=True,", "            size=settings.GRAVATAR_SIZE_ADD_CONTRIBUTOR", "        ),"]}, {"lines": ["    }", "", "def serialize_unregistered(fullname, email):", "    \"\"\"Serializes an unregistered user.", "    \"\"\""]}, {"lines": ["    if user is None:", "        serialized = {", "            'fullname': fullname,", "            'id': None,", "            'registered': False,", "            'active': False,", "            'gravatar': gravatar(email, use_ssl=True,", "                size=settings.GRAVATAR_SIZE_ADD_CONTRIBUTOR),"]}, {"lines": ["            'email': email,"]}, {"lines": ["        }", "    else:"]}, {"lines": ["        serialized = add_contributor_json(user)"]}, {"lines": ["        serialized['fullname'] = fullname", "        serialized['email'] = email", "    return serialized"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["            raise RuntimeError(\"unexpected opcode\")"]}, {"lines": ["# TODO: This should be a class method of Node"]}, {"lines": [""]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import time"]}, {"lines": ["import itertools"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from framework.auth.signals import user_registered"]}, {"lines": [""]}, {"lines": ["from website.profile import utils"]}, {"lines": [""]}, {"lines": ["        utils.add_contributor_json(contrib)"]}, {"lines": ["    active_contribs = itertools.ifilter("]}, {"lines": ["        contrib_counts.most_common()", "    )", "", "    limited = itertools.islice(active_contribs, n_contribs)", "", "    contrib_objs = [(User.load(_id), count) for _id, count in limited]"]}, {"lines": ["        for most_contrib, count in sorted(contrib_objs, key=lambda t: (-t[1], t[0].fullname))"]}, {"lines": ["    max_results = request.args.get('max')"]}, {"lines": ["    if max_results:"]}, {"lines": ["        try:", "            max_results = int(max_results)", "        except (TypeError, ValueError):", "            raise HTTPError(http.BAD_REQUEST)", "    if not max_results:", "        max_results = len(auth.user.recently_added)", "", "    # only include active contributors", "    active_contribs = itertools.ifilter("]}, {"lines": ["        auth.user.recently_added", "    )", "", "    # Limit to max_results", "    limited_contribs = itertools.islice(active_contribs, max_results)"]}, {"lines": [""]}, {"lines": ["        for contrib in limited_contribs"]}, {"lines": ["@must_be_valid_project  # returns project"]}, {"lines": ["def deserialize_contributors(node, user_dicts, auth):", "    \"\"\"View helper that returns a list of User objects from a list of", "    serialized users (dicts). The users in the list may be registered or", "    unregistered users."]}, {"lines": ["", "    e.g. ``[{'id': 'abc123', 'registered': True, 'fullname': ..},", "            {'id': None, 'registered': False, 'fullname'...},", "            {'id': '123ab', 'registered': False, 'fullname': ...}]", ""]}, {"lines": ["    If a dict represents an unregistered user without an ID, creates a new", "    unregistered User record.", ""]}, {"lines": ["    :param Node node: The node to add contributors to", "    :param list(dict) user_dicts: List of serialized users in the format above.", "    :param Auth auth:"]}, {"lines": ["    \"\"\"", ""]}, {"lines": ["    # Add the registered contributors"]}, {"lines": ["    contribs = []", "    for contrib_dict in user_dicts:"]}, {"lines": ["        fullname = contrib_dict['fullname']"]}, {"lines": ["        if contrib_dict['id']:"]}, {"lines": ["            contributor = User.load(contrib_dict['id'])"]}, {"lines": ["        else:"]}, {"lines": ["            try:"]}, {"lines": ["                contributor = User.create_unregistered("]}, {"lines": ["                    fullname=fullname,", "                    email=email)"]}, {"lines": ["                contributor.save()"]}, {"lines": ["", "        # Add unclaimed record if necessary", "        if (not contributor.is_registered", "                and node._primary_key not in contributor.unclaimed_records):", "            contributor.add_unclaimed_record(node=node, referrer=auth.user,", "                given_name=fullname,", "                email=email)", "            contributor.save()", "            unreg_contributor_added.send(node, contributor=contributor,", "                auth=auth)"]}, {"lines": ["            'permissions': expand_permissions(contrib_dict.get('permission'))"]}, {"lines": ["    return contribs"]}, {"lines": ["", "@unreg_contributor_added.connect", "def finalize_invitation(node, contributor, auth):", "    record = contributor.get_unclaimed_record(node._primary_key)", "    if record['email']:", "        send_claim_email(record['email'], contributor, node, notify=True)", ""]}, {"lines": ["@must_have_permission(ADMIN)"]}, {"lines": ["    contribs = deserialize_contributors(node, user_dicts, auth=auth)"]}, {"lines": ["    # Disconnect listener to avoid multiple invite emails", "    unreg_contributor_added.disconnect(finalize_invitation)", ""]}, {"lines": ["            child, user_dicts, auth=auth"]}, {"lines": ["        child.save()"]}, {"lines": ["    # Reconnect listener", "    unreg_contributor_added.connect(finalize_invitation)"]}, {"lines": [""]}, {"lines": ["@must_have_permission(ADMIN)"]}, {"lines": ["    if not node.has_permission(auth.user, ADMIN):"]}, {"lines": ["def get_timestamp():", "    return int(time.time())", ""]}, {"lines": ["", "def throttle_period_expired(timestamp, throttle):", "    return timestamp is None or (get_timestamp() - timestamp) > throttle", "", "", "def send_claim_registered_email(claimer, unreg_user, node, throttle=24 * 3600):"]}, {"lines": ["    unclaimed_record = unreg_user.get_unclaimed_record(node._primary_key)"]}, {"lines": ["        raise HTTPError(400, data=dict(", "            message_long='User account can only be claimed with an existing user once every 24 hours'", "        ))"]}, {"lines": ["    referrer = User.load(unclaimed_record['referrer_id'])"]}, {"lines": ["    # Send mail to claimer, telling them to wait for referrer"]}, {"lines": ["        fullname=claimer.fullname,", "        referrer=referrer,"]}, {"lines": ["    )", "", ""]}, {"lines": ["def send_claim_email(email, user, node, notify=True, throttle=24 * 3600):"]}, {"lines": ["    \"\"\"Send an email for claiming a user account. Either sends to the given email", "    or the referrer's email, depending on the email address provided.", "", "    :param str email: The address given in the claim user form", "    :param User user: The User record to claim.", "    :param Node node: The node where the user claimed their account."]}, {"lines": ["    :param bool notify: If True and an email is sent to the referrer, an email", "        will also be sent to the invited user about their pending verification."]}, {"lines": ["    :param int throttle: Time period (in seconds) after the referrer is", "        emailed during which the referrer will not be emailed again."]}, {"lines": ["    \"\"\""]}, {"lines": [""]}, {"lines": ["    unclaimed_record = user.get_unclaimed_record(node._primary_key)", "    referrer = User.load(unclaimed_record['referrer_id'])"]}, {"lines": ["    claim_url = user.get_claim_url(node._primary_key, external=True)"]}, {"lines": ["    # If given email is the same provided by user, just send to that email"]}, {"lines": ["        mail_tpl = mails.INVITE"]}, {"lines": ["    else:  # Otherwise have the referrer forward the email to the user"]}, {"lines": ["            raise HTTPError(400, data=dict(", "                message_long='User account can only be claimed with an existing user once every 24 hours'", "            ))"]}, {"lines": ["        if notify:"]}, {"lines": ["            pending_mail = mails.PENDING_VERIFICATION"]}, {"lines": ["                user=user,", "                referrer=referrer,", "                fullname=unclaimed_record['name'],"]}, {"lines": ["        mail_tpl = mails.FORWARD_INVITE", "        to_addr = referrer.username"]}, {"lines": ["        user=user,", "        referrer=referrer,", "        node=node,", "        claim_url=claim_url,"]}, {"lines": ["        fullname=unclaimed_record['name']"]}, {"lines": ["    )"]}, {"lines": ["    return to_addr"]}, {"lines": [""]}, {"lines": ["def verify_claim_token(user, token, pid):", "    \"\"\"View helper that checks that a claim token for a given user and node ID", "    is valid. If not valid, throws an error with custom error messages.", "    \"\"\"", "    # if token is invalid, throw an error", "    if not user.verify_claim_token(token=token, project_id=pid):", "        if user.is_registered:", "            error_data = {", "                'message_short': 'User has already been claimed.',", "                'message_long': 'Please <a href=\"/login/\">log in</a> to continue.'}"]}, {"lines": ["            raise HTTPError(400, data=error_data)"]}, {"lines": ["        else:"]}, {"lines": ["            return False"]}, {"lines": ["    return True"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["    \"\"\"View that prompts user to enter their password in order to claim", "    contributorship on a project.", "", "    A user must be logged in.", "    \"\"\""]}, {"lines": ["    if not current_user:"]}, {"lines": ["    # Logged in user should not be a contributor the project", "    if node.is_contributor(current_user):"]}, {"lines": ["            'message_long': ('The logged-in user is already a contributor to this'", "                'project. Would you like to <a href=\"{}\">log out</a>?').format(logout_url)"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST, data=data)"]}, {"lines": ["    uid, pid, token = kwargs['uid'], kwargs['pid'], kwargs['token']", "    unreg_user = User.load(uid)"]}, {"lines": ["    if not verify_claim_token(unreg_user, token, pid=node._primary_key):", "        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["    # Store the unreg_user data on the session in case the user registers", "    # a new account"]}, {"lines": ["    session.data['unreg_user'] = {", "        'uid': uid, 'pid': pid, 'token': token", "    }"]}, {"lines": [""]}, {"lines": ["    form = PasswordForm(request.form)", "    if request.method == 'POST':", "        if form.validate():", "            if current_user.check_password(form.password.data):", "                node.replace_contributor(old=unreg_user, new=current_user)", "                node.save()", "                status.push_status_message("]}, {"lines": ["                    'success')"]}, {"lines": ["            else:", "                status.push_status_message(language.LOGIN_FAILED, 'warning')", "        else:", "            forms.push_errors_to_status(form.errors)", "    if is_json_request():", "        form_ret = forms.utils.jsonify(form)", "        user_ret = utils.serialize_user(current_user, full=False)", "    else:", "        form_ret = form", "        user_ret = current_user", "    return {", "        'form': form_ret,", "        'user': user_ret,"]}, {"lines": ["        'signOutUrl': sign_out_url"]}, {"lines": ["    }", ""]}, {"lines": [""]}, {"lines": ["@user_registered.connect", "def replace_unclaimed_user_with_registered(user):"]}, {"lines": ["    \"\"\"Listens for the user_registered signal. If unreg_user is stored in the", "    session, then the current user is trying to claim themselves as a contributor.", "    Replaces the old, unregistered contributor with the newly registered", "    account.", "", "    \"\"\""]}, {"lines": ["    unreg_user_info = session.data.get('unreg_user')", "    if unreg_user_info:"]}, {"lines": ["        unreg_user = User.load(unreg_user_info['uid'])"]}, {"lines": ["        node = Node.load(pid)", "        node.replace_contributor(old=unreg_user, new=user)", "        node.save()", "        status.push_status_message(", "            'Successfully claimed contributor.', 'success')", "", ""]}, {"lines": ["    \"\"\"View for rendering the set password page for a claimed user.", ""]}, {"lines": ["    Must have ``token`` as a querystring argument.", ""]}, {"lines": ["    Renders the set password form, validates it, and sets the user's password.", "    \"\"\""]}, {"lines": ["    uid, pid = kwargs['uid'], kwargs['pid']", "    token = request.form.get('token') or request.args.get('token')"]}, {"lines": ["", "    # If user is logged in, redirect to 're-enter password' page"]}, {"lines": ["            uid=uid, pid=pid, token=token))"]}, {"lines": [""]}, {"lines": ["    # user ID is invalid. Unregistered user is not in database", "    if not user:"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["    # If claim token not valid, redirect to registration page", "    if not verify_claim_token(user, token, pid):"]}, {"lines": ["    unclaimed_record = user.unclaimed_records[pid]"]}, {"lines": ["    user.fullname = unclaimed_record['name']", "    user.update_guessed_names()"]}, {"lines": ["    form = SetEmailAndPasswordForm(request.form, token=token)"]}, {"lines": ["    if request.method == 'POST':", "        if form.validate():"]}, {"lines": ["            user.register(username=username, password=password)"]}, {"lines": ["            # Clear unclaimed records", "            user.unclaimed_records = {}"]}, {"lines": ["            user.save()"]}, {"lines": ["            # Authenticate user and redirect to project page"]}, {"lines": ["            node = Node.load(pid)"]}, {"lines": ["        else:", "            forms.push_errors_to_status(form.errors)"]}, {"lines": ["    return {"]}, {"lines": ["        'firstname': user.given_name,"]}, {"lines": ["        'fullname': user.fullname,"]}, {"lines": ["        'form': forms.utils.jsonify(form) if is_json_request() else form,"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)"]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"API view for inviting an unregistered user."]}, {"lines": ["    Expects JSON arguments with 'fullname' (required) and email (not required)."]}, {"lines": ["    \"\"\""]}, {"lines": ["    fullname = request.json.get('fullname').strip()"]}, {"lines": ["    email = request.json.get('email')", "    if email:", "        email = email.lower().strip()"]}, {"lines": ["    if not fullname:"]}, {"lines": ["        return {'status': 400, 'message': 'Must provide fullname'}, 400"]}, {"lines": ["    # Check if email is in the database"]}, {"lines": ["    if user:"]}, {"lines": ["        if user.is_registered:"]}, {"lines": ["            msg = 'User is already in database. Please go back and try your search again.'", "            return {'status': 400, 'message': msg}, 400"]}, {"lines": ["        elif node.is_contributor(user):"]}, {"lines": ["            msg = 'User with this email address is already a contributor to this project.'", "            return {'status': 400, 'message': msg}, 400"]}, {"lines": ["        else:"]}, {"lines": ["            serialized = utils.add_contributor_json(user)"]}, {"lines": ["            # use correct display name", "            serialized['fullname'] = fullname"]}, {"lines": ["            serialized['email'] = email"]}, {"lines": ["    else:", "        # Create a placeholder"]}, {"lines": ["        serialized = utils.serialize_unregistered(fullname, email)"]}, {"lines": ["    return {'status': 'success', 'contributor': serialized}"]}, {"lines": ["", "", "@must_be_contributor_or_public"]}, {"lines": ["    \"\"\"View for claiming a user from the X-editable form on a project page.", "    \"\"\""]}, {"lines": ["    reqdata = request.json"]}, {"lines": ["    # Unreg user"]}, {"lines": ["    user = User.load(reqdata['pk'])"]}, {"lines": ["    unclaimed_data = user.get_unclaimed_record(node._primary_key)"]}, {"lines": ["    # Submitted through X-editable"]}, {"lines": ["    if 'value' in reqdata:  # Submitted email address"]}, {"lines": ["        email = reqdata['value'].lower().strip()"]}, {"lines": ["            send_claim_registered_email(claimer=claimer, unreg_user=user,", "                node=node)", "        else:", "            send_claim_email(email, user, node, notify=True)", "    # TODO(sloria): Too many assumptions about the request data. Just use"]}, {"lines": ["    elif 'claimerId' in reqdata:  # User is logged in and confirmed identity"]}, {"lines": ["        claimer_id = reqdata['claimerId']", "        claimer = User.load(claimer_id)", "        send_claim_registered_email(claimer=claimer, unreg_user=user, node=node)"]}, {"lines": ["        email = claimer.username"]}, {"lines": ["    else:", "        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["    return {", "        'status': 'success',", "        'email': email,", "        'fullname': unclaimed_data['name']", "    }"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import logging"]}, {"lines": ["import httplib as http"]}, {"lines": ["from website.util.rubeus import collect_addon_js"]}, {"lines": ["logger = logging.getLogger(__name__)"]}, {"lines": [""]}, {"lines": ["    post_data = request.json"]}, {"lines": ["    edited_field = post_data.get('name')"]}, {"lines": ["    prompts = node.callback('before_fork', user=user)"]}, {"lines": [""]}, {"lines": ["def collect_node_config_js(addons):", "    \"\"\"Collect webpack bundles for each of the addons' node-cfg.js modules. Return", "    the URLs for each of the JS modules to be included on the node addons config page.", "", "    :param list addons: List of node's addon config records.", "    \"\"\"", "    js_modules = []", "    for addon in addons:"]}, {"lines": ["            js_modules.append(js_path)", "    return js_modules", ""]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["    primary = '/api/v1' not in request.path"]}, {"lines": ["    # Collect the URIs to the static assets for addons that have widgets"]}, {"lines": ["        filename='widget-cfg.js',", "        config_entry='widget'", "    ))"]}, {"lines": [""]}, {"lines": ["    \"\"\"Reorders the components in a project's component list."]}, {"lines": ["    :param-json list new_list: List of strings that include node IDs and", "        node type delimited by ':'."]}, {"lines": ["    \"\"\"", "    # TODO(sloria): Change new_list parameter to be an array of objects", "    # {", "    #   'newList': {", "    #       {'key': 'abc123', 'type': 'node'}", "    #   }", "    # }"]}, {"lines": ["    valid_nodes = ["]}, {"lines": ["    if len(valid_nodes) == len(nodes_new) and set(valid_nodes) == set(nodes_new):"]}, {"lines": ["# Make Private/Public"]}, {"lines": ["        prompt.append('Anonymized view-only links <b>DO NOT</b> anonymize '", "                      'contributors after a project or component is made public.')"]}, {"lines": [""]}, {"lines": ["@must_be_contributor_or_public", "@must_not_be_registration"]}, {"lines": ["    try:", "        user.watch(watch_config)", "    except ValueError:  # Node is already being watched", "        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["    user.save()"]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["    try:"]}, {"lines": ["    except ValueError:  # Node isn't being watched", "        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["@must_be_contributor_or_public", "@must_not_be_registration"]}, {"lines": ["    '''View for toggling watch mode for a node.'''"]}, {"lines": ["    try:", "        if user.is_watching(node):"]}, {"lines": ["        else:"]}, {"lines": ["    except ValueError:", "        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["                'message_short': 'Error',"]}, {"lines": ["                'message_short': 'Error',"]}, {"lines": ["    data = {"]}, {"lines": ["            'registered_meta': [", "                {"]}, {"lines": ["                    'name_clean': clean_template_name(meta),", "                }"]}, {"lines": ["            ],"]}, {"lines": ["        },"]}, {"lines": ["        'parent_node': {"]}, {"lines": ["            'id': parent._primary_key if parent else '',", "            'title': parent.title if parent else '',"]}, {"lines": ["            'url': parent.url if parent else '',", "            'api_url': parent.api_url if parent else '',"]}, {"lines": ["        },"]}, {"lines": ["            'username': user.username if user else None,"]}, {"lines": ["            'fullname': user.fullname if user else '',"]}, {"lines": ["    return data"]}, {"lines": ["    try:"]}, {"lines": ["    except ZeroDivisionError:", "        ua = 0", "    try:"]}, {"lines": ["    except ZeroDivisionError:", "        non_ua = 0", ""]}, {"lines": [""]}, {"lines": ["    # TODO(sloria): Refactor this or remove (lots of duplication with _view_project)", "    summary = {", "        'id': link_id if link_id else node._id,", "        'primary': primary,"]}, {"lines": ["    }"]}, {"lines": ["    # TODO: Make output format consistent with _view_project"]}, {"lines": ["    user = auth.user"]}, {"lines": ["    if request.args.get('permissions'):", "        perm = request.args['permissions'].lower().strip()"]}, {"lines": ["    else:", "        nodes = ["]}, {"lines": ["        ]"]}, {"lines": ["        )"]}, {"lines": ["    # TODO: since these a delete request, shouldn't use request body. put pointer", "    # id in the URL instead"]}, {"lines": ["    node = get_pointer_parent(pointer)"]}, {"lines": ["        if not get_pointer_parent(each).is_folder"]}, {"lines": ["from framework.auth.decorators import collect_auth"]}, {"lines": ["@collect_auth"]}, {"lines": ["    tag_obj = Tag.load(tag)", "    nodes = tag_obj.node__tagged if tag_obj else []", "    visible_nodes = [obj for obj in nodes if obj.can_view(auth)]"]}, {"lines": ["        'nodes': ["]}, {"lines": ["            for node in visible_nodes", "        ],"]}, {"lines": ["            numbers.append([key] + [sum(x[0:i + 1]) for i in range(len(x[0:]))])"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-"]}, {"lines": ["from __future__ import absolute_import"]}, {"lines": ["from modularodm.query.querydialect import DefaultQueryDialect as Q"]}, {"lines": [""]}, {"lines": ["    ctx.pop()"]}, {"lines": ["if __name__ == '__main__':"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["These settings can be overridden in local.py."]}, {"lines": ["import json"]}, {"lines": ["def parent_dir(path):", "    '''Return the parent of a directory.'''", "    return os.path.abspath(os.path.join(path, os.pardir))", "", "HERE = os.path.dirname(os.path.abspath(__file__))"]}, {"lines": ["BASE_PATH = parent_dir(HERE)  # website/ directory"]}, {"lines": ["STATIC_FOLDER = os.path.join(BASE_PATH, 'static')"]}, {"lines": ["ROOT = os.path.join(BASE_PATH, '..')"]}, {"lines": [""]}, {"lines": ["# Hours before email confirmation tokens expire", "EMAIL_TOKEN_EXPIRATION = 24"]}, {"lines": [""]}, {"lines": ["LOAD_BALANCER = False"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["API_DOMAIN = 'http://localhost:8000/'"]}, {"lines": ["CONFIRM_REGISTRATIONS_BY_EMAIL = True"]}, {"lines": ["ALLOW_REGISTRATION = True", "ALLOW_LOGIN = True"]}, {"lines": ["# Sessions"]}, {"lines": ["COOKIE_NAME = 'osf'"]}, {"lines": [""]}, {"lines": ["USE_CDN_FOR_CLIENT_LIBS = True"]}, {"lines": ["MAIL_SERVER = 'smtp.sendgrid.net'", "MAIL_USERNAME = 'osf-smtp'", "MAIL_PASSWORD = ''  # Set this in local.py"]}, {"lines": ["# Mandrill", "MANDRILL_USERNAME = None", "MANDRILL_PASSWORD = None", "MANDRILL_MAIL_SERVER = None", ""]}, {"lines": ["ENABLE_EMAIL_SUBSCRIPTIONS = True"]}, {"lines": ["CANONICAL_DOMAIN = 'openscienceframework.org'", "COOKIE_DOMAIN = '.openscienceframework.org' # Beaker"]}, {"lines": ["SHORT_DOMAIN = 'osf.io'"]}, {"lines": ["WIKI_WHITELIST = {"]}, {"lines": ["##### Celery #####", "## Default RabbitMQ broker", "BROKER_URL = 'amqp://'", "", "# Default RabbitMQ backend"]}, {"lines": ["", "# Modules to import when celery launches", "CELERY_IMPORTS = ("]}, {"lines": ["    'website.mailchimp_utils',"]}, {"lines": [")"]}, {"lines": ["# Load addons from addons.json", "with open(os.path.join(ROOT, 'addons.json')) as fp:"]}, {"lines": ["", "# Google Analytics", "GOOGLE_ANALYTICS_ID = None", "GOOGLE_SITE_VERIFICATION = None", "", "# Pingdom", "PINGDOM_ID = None"]}, {"lines": ["# Format for DOIs and ARKs", "EZID_FORMAT = '{namespace}osf.io/{guid}'", "", ""]}, {"lines": ["/**"]}, {"lines": ["* Module that enables account claiming on the project page. Makes unclaimed", "* usernames show popovers when clicked, where they can input their email.", "*", "* Sends HTTP requests to the claim_user_post endpoint.", "*/", "'use strict';"]}, {"lines": [""]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var bootbox = require('bootbox');"]}, {"lines": [""]}, {"lines": ["var currentUserId = window.contextVars.currentUser.id;"]}, {"lines": [""]}, {"lines": ["function AccountClaimer (selector) {", "    this.selector = selector;", "    this.element = $(selector);  // Should select all span elements for", "                                // unreg contributor names", "    this.init();", "}", "", "function getClaimUrl() {", "    var uid = $(this).data('pk');", "    var pid = global.nodeId;"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["function alertFinished(email) {"]}, {"lines": ["}", "", "function onClickIfLoggedIn() {", "    var pk = $(this).data('pk');", "    if (pk !== currentUserId) {", "        bootbox.confirm({", "            title: 'Claim as ' + global.contextVars.currentUser.username + '?',", "            message: 'If you claim this account, a contributor of this project ' +", "                    'will be emailed to confirm your identity.',", "            callback: function(confirmed) {", "                if (confirmed) {", "                    $osf.postJSON(", "                        getClaimUrl(),", "                        {", "                            claimerId: currentUserId,", "                            pk: pk", "                        }", "                    ).done(function(response) {", "                        alertFinished(response.email);", "                    }).fail(", "                        $osf.handleJSONError", "                    );", "                }", "            }"]}, {"lines": ["        });"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["AccountClaimer.prototype = {", "    constructor: AccountClaimer,", "    init: function() {", "        var self = this;", "        self.element.tooltip({", "            title: 'Is this you? Click to claim'", "        });", "        if (currentUserId.length) { // If user is logged in, ask for confirmation", "            self.element.on('click', onClickIfLoggedIn);", "        } else {", "            self.element.editable({", "                type: 'text',", "                value: '',", "                ajaxOptions: {", "                    type: 'post',", "                    contentType: 'application/json',", "                    dataType: 'json'  // Expect JSON response", "                },", "                success: function(data) {", "                    alertFinished(data.email);", "                },"]}, {"lines": ["                display: function(value, sourceData){", "                    if (sourceData && sourceData.fullname) {", "                        $(this).text(sourceData.fullname);"]}, {"lines": ["                    }"]}, {"lines": ["                },", "                // Send JSON payload", "                params: function(params) {", "                    return JSON.stringify(params);", "                },", "                title: 'Claim Account',", "                placement: 'bottom',", "                placeholder: 'Enter email...',", "                validate: function(value) {", "                    var trimmed = $.trim(value);", "                    if (!$osf.isEmail(trimmed)) {", "                        return 'Not a valid email.';", "                    }", "                },", "                url: getClaimUrl.call(this),"]}, {"lines": ["            });", "        }", "    }"]}, {"lines": ["};"]}, {"lines": [""]}, {"lines": ["module.exports = AccountClaimer;"]}, {"lines": ["// TODO: Deprecate me"]}, {"lines": ["    exports = {"]}, {"lines": ["    };"]}, {"lines": ["    if (typeof module === 'object') {", "        module.exports = exports;", "    }", "    return exports;"]}, {"lines": ["'use strict';"]}, {"lines": ["var $osf = require('js/osfHelpers');", ""]}, {"lines": ["                                $('#' + addonShortName + '-' + nodeId + '-auth-row').hide();", "                                var numNodes = $('#' + addonShortName + '-auth-table tr:visible').length;"]}, {"lines": ["                                    $('#' + addonShortName + '-auth-table').hide();"]}, {"lines": ["                                    $('#' + addonShortName + '-more').hide();", "                                    $('#' + addonShortName+ '-less').hide();"]}, {"lines": ["var ChangeMessageMixin = oop.defclass({"]}, {"lines": ["module.exports = ChangeMessageMixin;"]}, {"lines": ["                });"]}, {"lines": ["        // Load css with webpack if possible", "        if (typeof webpackJsonp !== 'undefined') {", "            // NOTE: Assumes that the style-loader and css-loader are used for .css files", "            require('../css/commentpane.css');", "        }"]}, {"lines": ["    if (typeof define === 'function' && define.amd) {", "        define(['jquery'], function($) {"]}, {"lines": ["/**"]}, {"lines": ["var $ = require('jquery');", "var ko = require('knockout');"]}, {"lines": ["var bootbox = require('bootbox');"]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": [""]}, {"lines": ["// Max number of recent/common contributors to show", "var MAX_RECENT = 5;"]}, {"lines": [""]}, {"lines": ["// TODO: Remove dependency on contextVars", "var nodeApiUrl = window.contextVars.node.urls.api;", "var nodeId = window.contextVars.node.id;", ""]}, {"lines": ["var AddContributorViewModel = oop.extend(Paginator, {"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        self.inviteName(self.query());", "        self.inviteError('');", "        self.inviteEmail('');", "        self.page('invite');"]}, {"lines": ["    /**"]}, {"lines": ["        self.notification(false);", "        if (self.query()) {"]}, {"lines": ["                    query: self.query(),", "                    excludeNode: nodeId,", "                    page: self.currentPage", "                },", "                function(result) {", "                    var contributors = result.users.map(function(userData) {", "                        return new Contributor(userData);", "                    });", "                    self.results(contributors);", "                    self.currentPage(result.page);", "                    self.numberOfPages(result.pages);", "                    self.addNewPaginators();", "                }", "            );", "        } else {", "            self.results([]);"]}, {"lines": ["            self.totalPages(0);", "        }"]}, {"lines": ["        self.notification(false);", "        $.getJSON("]}, {"lines": ["            function(result) {", "                if (!result.contributors.length) {", "                    self.notification({", "                        'message': 'All contributors from parent already included.',", "                        'level': 'info'", "                    });"]}, {"lines": ["                }"]}, {"lines": ["                self.results(result.contributors);", "            }", "        );"]}, {"lines": ["        self.notification(false);"]}, {"lines": ["        var url = nodeApiUrl + 'get_recently_added_contributors/?max=' + MAX_RECENT.toString();"]}, {"lines": ["            function(result) {", "                if (!result.contributors.length) {", "                    self.notification({", "                        'message': 'All recent collaborators already included.',", "                        'level': 'info'", "                    });"]}, {"lines": ["                }"]}, {"lines": ["                var contribs = [];"]}, {"lines": ["                var numToDisplay = result.contributors.length;"]}, {"lines": ["                    contribs.push(new Contributor(result.contributors[i]));"]}, {"lines": ["                self.results(contribs);"]}, {"lines": ["                self.numberOfPages(1);"]}, {"lines": ["            }"]}, {"lines": ["            self.notification({"]}, {"lines": ["                    'please report it to <a href=\"mailto:support@osf.io\">support@osf.io</a>.',", "                'level': 'warning'"]}, {"lines": ["            Raven.captureMessage('Could not GET recentlyAdded contributors.', {", "                url: url,", "                textStatus: textStatus,", "                error: error"]}, {"lines": ["            });"]}, {"lines": ["        });"]}, {"lines": ["        self.notification(false);"]}, {"lines": ["        var url = nodeApiUrl + 'get_most_in_common_contributors/?max=' + MAX_RECENT.toString();"]}, {"lines": ["            function(result) {", "                if (!result.contributors.length) {", "                    self.notification({", "                        'message': 'All frequent collaborators already included.',", "                        'level': 'info'", "                    });"]}, {"lines": ["                var contribs = [];"]}, {"lines": ["                var numToDisplay = result.contributors.length;"]}, {"lines": ["                    contribs.push(new Contributor(result.contributors[i]));", "                }", "                self.results(contribs);"]}, {"lines": ["                self.numberOfPages(1);"]}, {"lines": ["            }"]}, {"lines": ["            self.notification({"]}, {"lines": ["                    'please report it to <a href=\"mailto:support@osf.io\">support@osf.io</a>.',", "                'level': 'warning'"]}, {"lines": ["            Raven.captureMessage('Could not GET mostInCommon contributors.', {", "                url: url,", "                textStatus: textStatus,", "                error: error", "            });", "        });"]}, {"lines": ["        elements.forEach(function(element) {", "            $(element).find('.contrib-button').tooltip();", "        });"]}, {"lines": ["        self.addTips(elm, data);"]}, {"lines": ["    /** Validate the invite form. Returns a string error message or"]}, {"lines": ["        // Make sure Full Name is not blank", "        if (!self.inviteName().trim().length) {", "            return 'Full Name is required.';", "        }", "        if (self.inviteEmail() && !$osf.isEmail(self.inviteEmail())) {", "            return 'Not a valid email address.';", "        }", "        // Make sure that entered email is not already in selection"]}, {"lines": ["            }"]}, {"lines": ["        }", "        return true;"]}, {"lines": ["        self.inviteError('');", "        var validated = self.validateInviteForm();", "        if (typeof validated === 'string') {", "            self.inviteError(validated);"]}, {"lines": ["            return false;"]}, {"lines": ["        }"]}, {"lines": ["        // All manually added contributors are visible", "        data.visible = true;"]}, {"lines": ["        // Hack: Hide and refresh tooltips", "        $('.tooltip').hide();", "        $('.contrib-button').tooltip();"]}, {"lines": ["        );", "        // Hack: Hide and refresh tooltips", "        $('.tooltip').hide();", "        $('.contrib-button').tooltip();"]}, {"lines": ["            }"]}, {"lines": ["        });"]}, {"lines": ["        });"]}, {"lines": ["                return true;", "            }", "        }", "        return false;"]}, {"lines": ["        self.page('whom');", "        self.query('');", "        self.results([]);", "        self.selection([]);", "        self.nodesToChange([]);", "        self.notification(false);"]}, {"lines": [""]}, {"lines": ["", "////////////////", "// Public API //", "////////////////", ""]}, {"lines": ["    var self = this;", "    self.selector = selector;", "    self.$element = $(selector);", "    self.nodeTitle = nodeTitle;", "    self.nodeId = nodeId;", "    self.parentTitle = parentTitle;", "    self.viewModel = new AddContributorViewModel(self.nodeTitle,", "        self.nodeId, self.parentTitle);", "    self.init();", "}", "", "ContribAdder.prototype.init = function() {", "    var self = this;", "    ko.applyBindings(self.viewModel, self.$element[0]);", "    // Clear popovers on dismiss start", "    self.$element.on('hide.bs.modal', function() {", "        self.$element.find('.popover').popover('hide');", "    });", "    // Clear user search modal when dismissed; catches dismiss by escape key", "    // or cancel button.", "    self.$element.on('hidden.bs.modal', function() {", "        self.viewModel.clear();", "    });", "    // Load recently added contributors every time the modal is activated.", "    self.$element.on('shown.bs.modal', function() {", "        self.viewModel.recentlyAdded();", "    });", "};", "", "module.exports = ContribAdder;"]}, {"lines": ["var URI = require('URIjs');"]}, {"lines": [""]}, {"lines": ["var URI = require('URIjs');"]}, {"lines": [""]}, {"lines": ["// CSS"]}, {"lines": [""]}, {"lines": ["function resolveIconView(item) {"]}, {"lines": ["    var newIcon = resolveIconView(item);"]}, {"lines": ["        _fangornOrderFolder.call(tb, from.parent());"]}, {"lines": ["    var parent = file.treebeardParent || treebeard.dropzoneItemCache;"]}, {"lines": ["    var configOption = resolveconfigOption.call(treebeard, parent, 'uploadSending', [file, xhr, formData]);"]}, {"lines": ["    var dropzoneHoverClass = 'fangorn-dz-hover',"]}, {"lines": ["        item.data.tmpID = null;"]}, {"lines": ["    }"]}, {"lines": ["function _fangornDropzoneError(treebeard, file, message, xhr) {"]}, {"lines": ["    // File may either be a webkit Entry or a file object, depending on the browser", "    // On Chrome we can check if a directory is being uploaded", "    var msgText;", "    if (file.isDirectory) {", "        msgText = 'Cannot upload directories, applications, or packages.';"]}, {"lines": ["    } else if (xhr.status === 507) {", "        msgText = 'Cannot upload file due to insufficient storage.';"]}, {"lines": ["    } else {", "        msgText = DEFAULT_ERROR_MESSAGE;", "    }"]}, {"lines": ["    // Parent may be undefined, e.g. in Chrome, where file is an entry object", "    var item;", "    var child;", "    var destroyItem = false;"]}, {"lines": ["                        m('p.text-danger', 'This folder and ALL its contents will be deleted. This action is irreversible.')"]}, {"lines": ["                deleteMessage.push(m('p.text-danger', 'Some of the selected items are folders. This will delete the folder(s) and ALL of their content.'));"]}, {"lines": ["    var child;", "    var i;"]}, {"lines": ["        for (i = 0; i < tree.children.length; i++) {", "            child = tree.children[i];"]}, {"lines": ["        for (i = 0; i < tree.children.length; i++) {", "            child = tree.children[i];"]}, {"lines": ["            if (nodeID === child.data.nodeId && child.data.provider === file.provider && child.data.path === file.path &&", "                child.data.extra.datasetVersion === urlParams.version) {"]}, {"lines": ["            child = tree.children[j];"]}, {"lines": ["        var opts = {"]}, {"lines": ["            onclick: onclick", "        };", "        // Add tooltip if applicable", "        if (args.tooltip) {", "            opts['data-toggle'] = 'tooltip';", "            opts['data-placement'] = 'bottom';", "            opts.title = args.tooltip;", "        }", "        return m('div', opts, ["]}, {"lines": ["};"]}, {"lines": ["};"]}, {"lines": ["        return m('span.fangorn-dropdown', {", "                className: extraCSS"]}, {"lines": ["};"]}, {"lines": ["                    onclick: function(event) {_uploadEvent.call(tb, event, item); },"]}, {"lines": ["                        onclick: function(event) {_removeEvent.call(tb, event, [item]); },"]}, {"lines": ["            if (item.data.permissions && item.data.permissions.view) {", "                rowButtons.push(", "                    m.component(FGButton, {", "                        onclick: function(event) {", "                            gotoFileEvent.call(tb, item);", "                        },", "                        icon: 'fa fa-file-o',", "                        className : 'text-info'", "                    }, 'View'));", "            }"]}, {"lines": ["                    onclick: function(event) { _downloadEvent.call(tb, event, item); },"]}, {"lines": ["                        onclick: function(event) { _removeEvent.call(tb, event, [item]); },"]}, {"lines": ["        } else if(item.data.provider && item.children.length !== 0) {"]}, {"lines": ["};"]}, {"lines": ["        ];"]}, {"lines": ["                    className : 'text-danger'"]}, {"lines": ["            var showDelete = false;", "            // Only show delete button if user has edit permissions on at least one selected file", "            for (var i = 0, len = items.length; i < len; i++) {", "                var each = items[i];"]}, {"lines": ["                    showDelete = true;", "                    break;"]}, {"lines": ["            }", "            if(showDelete){"]}, {"lines": ["                        onclick: function(event) {"]}, {"lines": ["                        m('p', [ m('b', 'Select Multiple Files:'), m('span', ' Use Command or Shift keys to select multiple files.')]),"]}, {"lines": ["                        m('p', [ m('b', 'Open Files in New Tab:'), m('span',  ' Press Command (or Ctrl in Windows) and  click a file name to open it in a new tab.')]),", "                        m('p', [ m('b', 'Copy Files:'), m('span', ' Press Option (or Alt in Windows) while dragging a file to a new folder or component.')])"]}, {"lines": ["                        m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function(event) { ctrl.tb.modal.dismiss(); } }, 'Close'),"]}, {"lines": ["};"]}, {"lines": ["    function changeColor() { $(this).css('background-color', ''); }", "    if (originalRow !== undefined) {"]}, {"lines": ["                $('.tb-row[data-id=\"' + rows[i].id + '\"]').stop().css('background-color', '#D18C93')", "                    .animate({ backgroundColor: '#fff'}, 500, changeColor);"]}, {"lines": ["        });"]}, {"lines": ["        $(window).on('beforeunload', function() {"]}, {"lines": ["        });"]}, {"lines": ["            });"]}, {"lines": ["    filterPlaceholder : 'Search',"]}, {"lines": ["        parallelUploads: 1,"]}, {"lines": ["        acceptDirectories: false,"]}, {"lines": ["};"]}, {"lines": ["    resolveIconView: resolveIconView"]}, {"lines": ["/**"]}, {"lines": ["* A simple folder picker plugin built on HGrid.", "* Takes the same options as HGrid and additionally requires an"]}, {"lines": ["*", "* Usage:", "*", "*     $('#myPicker').folderpicker({", "*         data: // Array of HGrid-formatted data or URL to fetch data", "*         onPickFolder: function(evt, folder) {", "*             // do something with folder", "*         }", "*     });", "*/"]}, {"lines": ["    }", ""]}, {"lines": ["    }", ""]}, {"lines": [""]}, {"lines": ["        }"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["module.exports = FolderPicker;"]}, {"lines": ["// website/static/js/growlBox.js", "'use strict';", "var $ = require('jquery');", "require('bootstrap.growl');", ""]}, {"lines": ["var oop = require('js/oop');", ""]}, {"lines": ["/**", "* Show a growl-style notification for messages. Defaults to an error type.", "* @param {String} title Shows in bold at the top of the box. Required or it looks foolish.", "* @param {String} message Shows a line below the title. This could be '' if there's nothing to say.", "* @param {String} type One of 'success', 'info', 'warning', or 'danger'. Defaults to danger.", "*/"]}, {"lines": ["var GrowlBox = oop.defclass({"]}, {"lines": ["        this.title = title;", "        this.message = message;"]}, {"lines": ["        this.show();"]}, {"lines": ["    },"]}, {"lines": ["        $.growl({", "            title: '<strong>' + this.title + '<strong><br />',", "            message: this.message", "        },{", "            type: this.type,", "            delay: 0,", "            animate: {", "                enter: 'animated slideInDown',", "                exit: 'animated slideOutRight'", "            }", "        });", "", "    }"]}, {"lines": ["});"]}, {"lines": ["", "module.exports = GrowlBox;"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var ko = require('knockout');"]}, {"lines": ["", "var makeExtender = function(interceptor) {", "    return function(target, options) {", "        var result = ko.computed({", "            read: target,", "            write: function(value) {", "                var current = target();", "                var toWrite = interceptor(value, options);", "                if (current !== toWrite) {", "                    target(toWrite);", "                } else {", "                    if (current !== value) {", "                        target.notifySubscribers(toWrite);"]}, {"lines": ["            }", "        }).extend({", "            notify: 'always'"]}, {"lines": ["        result(target());", "        return result;"]}, {"lines": ["};"]}, {"lines": ["var addExtender = function(label, interceptor) {", "    ko.extenders[label] = makeExtender(interceptor);", "};"]}, {"lines": ["var makeRegexValidator = function(regex, message, match) {", "    match = match || match === undefined;", "    return {", "        validator: function(value) {", "            if (ko.validation.utils.isEmptyVal(value)) {"]}, {"lines": ["            return match === regex.test(ko.utils.unwrapObservable(value));"]}, {"lines": ["        message: message"]}, {"lines": ["};"]}, {"lines": ["addExtender('cleanup', function(value, cleaner) {", "    return !!value ? cleaner(value) : '';", "});"]}, {"lines": ["addExtender('ensureHttp', function(value) {", "    if (!value || value.search(/^https?:\\/\\//i) === 0) {", "        return value;", "    }", "    return 'http://' + value;", "});"]}, {"lines": ["var sanitize = function(value) {", "    return value.replace(/<\\/?[^>]+>/g, '');", "};"]}, {"lines": ["var sanitizedObservable = function(value) {", "    return ko.observable(value).extend({", "        cleanup: sanitize", "    });", "};"]}, {"lines": ["// Add custom validators"]}, {"lines": ["ko.validation.rules.minDate = {", "    validator: function (val, minDate) {", "        // Skip if values empty", "        var uwVal = ko.utils.unwrapObservable(val);", "        var uwMin = ko.utils.unwrapObservable(minDate);", "        if (uwVal === null || uwMin === null) {", "            return true;", "        }", "        // Skip if dates invalid", "        var dateVal = new Date(uwVal);", "        var dateMin = new Date(uwMin);", "        if (dateVal.toString() === 'Invalid Date' || dateMin.toString() === 'Invalid Date') {", "            return true;", "        }", "        // Check if end date is ongoing", "        if (uwVal === 'ongoing') {", "            return true;", "        }", "        // Compare dates", "        return dateVal >= dateMin;", "    },", "    message: 'End date must be greater than or equal to the start date.'", "};", "", "ko.validation.rules.pyDate = {", "    validator: function (val) {", "        // Skip if values empty", "        var uwVal = ko.utils.unwrapObservable(val);", "        if (uwVal === null) {", "            return true;", "        }", "        // Skip if dates invalid", "        var dateVal = new Date(uwVal);", "        if (dateVal.toString() === 'Invalid Date') {", "            return true;", "        }", "        // Compare years", "        return parseInt(uwVal) >= 1900;", "    },", "    message: 'Date must be greater than or equal to 1900.'", "};", "", "ko.validation.rules.notInFuture = {", "    validator: function (val) {", "        // Skip if values empty", "        var uwVal = ko.utils.unwrapObservable(val);", "        if (uwVal === null || uwVal === undefined) {", "            return true;", "        }"]}, {"lines": ["        //Skip if dates invalid", "        var dateVal = new Date(uwVal);"]}, {"lines": ["        if (dateVal.toString() === 'Invalid Date') {", "            return true;", "        }", "        // Compare dates", "        var now = new Date();", "        return dateVal <= now;", "", "    },", "    message: 'Please enter a date prior to the current date.'", "};", "", "", "ko.validation.rules.year = makeRegexValidator(", "    new RegExp('^\\\\d{4}$'),", "    'Please enter a valid year.'", ");", "", "", "ko.validation.rules.url = makeRegexValidator(", "    new RegExp(", "        '^(?:http|ftp)s?://' +", "            '(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\\\\.)+(?:[A-Z]{2,6}\\\\.?|[A-Z0-9-]{2,}\\\\.?)|' +", "            'localhost|' +", "            '\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}|' +", "            '\\\\[?[A-F0-9]*:[A-F0-9:]+\\\\]?)' +", "            '(?::\\\\d+)?' +", "            '(?:/?|[/?]\\\\S+)$',", "        'i'", "    ),", "    'Please enter a valid URL.'", ");", ""]}, {"lines": ["// Expose public utilities", "", "module.exports = {", "    makeExtender: makeExtender,", "    addExtender: addExtender,", "    makeRegexValidator: makeRegexValidator,"]}, {"lines": ["};"]}, {"lines": [" * Knockout models for controlling metadata; bound to HTML in"]}, {"lines": ["var ko = require('knockout');"]}, {"lines": ["        init: function(element, valueAccessor) {"]}, {"lines": ["        if ('each' in self && content.repeatType === 'each') {", "            if (typeof(self.each) === 'string') {"]}, {"lines": ["        self.minRepeat = typeof(self.minRepeat) !== 'undefined' ? self.minRepeat : 1;"]}, {"lines": ["            if (self[field] && typeof(self[field]) === 'string' && self[field].match(TPL_REGEX)) {"]}, {"lines": ["                if (modelValue !== value) {"]}, {"lines": ["                    if (ctxSplit[0] === '$ctx') {"]}, {"lines": ["                            if (key === '$parent') {"]}, {"lines": ["                    } else if (ctxSplit[0] === '$svy') {"]}, {"lines": ["        return new (Function.prototype.bind.apply(klass, args));  // jshint ignore: line"]}, {"lines": ["            if (data.$parent.repeatType !== 'repeat' || data.disable || this.disable) {"]}, {"lines": ["            if (data.repeatType !== 'repeat' || data.disable || this.disable) {"]}, {"lines": ["                if (!model.value) {"]}, {"lines": ["    };", "", "}());"]}, {"lines": ["module.exports = MetaData;"]}, {"lines": ["/**", " * IE8 shim for Object.create. Should be imported whenever Object.create is used.", " */", "if (typeof Object.create !== 'function') {", "    Object.create = function (o) {", "        var F = function() {};", "        F.prototype = o;", "        return new F();", "    };", "}"]}, {"lines": ["// These are mostly a simplification of", "// augment.js (https://github.com/javascript/augment, MIT Licensed) and", "// Douglas Crockford's protoypical inheritance pattern."]}, {"lines": ["require('js/objectCreateShim'); // IE8 compat"]}, {"lines": [""]}, {"lines": ["/**", " * Usage:", " *"]}, {"lines": [" *  var Animal = defclass({", " *      constructor: function(name) {", " *          this.name = name || 'unnamed';", " *          this.sleeping = false;", " *      },", " *      sayHi: function() {", " *          console.log('Hi, my name is ' + this.name);", " *      }", " *  });"]}, {"lines": [" */", "function defclass(prototype) {"]}, {"lines": ["    constructor.prototype = prototype;", "    return constructor;", "}", "", "/**", " * Usage:", " *"]}, {"lines": [" *  var Person = extend(Animal, {", " *      constructor: function(name) {", " *          this.super.constructor.call(name);", " *          this.name = name || 'Steve';", " *      }", " *  });"]}, {"lines": [" */"]}, {"lines": ["function extend(cls, sub) {", "    var prototype = Object.create(cls.prototype);"]}, {"lines": ["    for (var key in sub) { prototype[key] = sub[key]; }"]}, {"lines": ["    prototype.super = cls.prototype;"]}, {"lines": ["    return defclass(prototype);", "}", "", "module.exports = {", "    defclass: defclass,", "    extend: extend", "};"]}, {"lines": ["module.exports = {"]}, {"lines": ["    // TODO", "    makePublic: null,", "    makePrivate: null,"]}, {"lines": ["        registerSkipAddons: 'If you choose to continue with the registration at this time we will exclude the contents of any addons that are not copyable. These files will not appear in the final registration.'"]}, {"lines": ["    Addons: {", "        dataverse: {", "            userSettingsError: 'Could not retrieve settings. Please refresh the page or ' +"]}, {"lines": ["                'problem persists.',", "            confirmUserDeauth: 'Are you sure you want to unlink your Dataverse ' +", "                'account? This will revoke access to Dataverse for all ' +", "                'projects you have authorized.',", "            confirmNodeDeauth: 'Are you sure you want to unlink this Dataverse account? This will ' +", "                'revoke the ability to view, download, modify, and upload files ' +", "                'to studies on the Dataverse from the OSF. This will not remove your ' +", "                'Dataverse authorization from your <a href=\"/settings/addons/\">user settings</a> ' +", "                'page.',", "            deauthError: 'Could not unlink Dataverse at this time.',", "            deauthSuccess: 'Unlinked your Dataverse account.',", "            authError: 'There was a problem connecting to the Dataverse.',"]}, {"lines": ["            authSuccess: 'Your Dataverse account was linked.',"]}, {"lines": ["                'and cannot be connected to the OSF.',"]}, {"lines": ["                'development team.',"]}, {"lines": ["            widgetInvalid: 'The Dataverse credentials associated with ' +", "                'this node appear to be invalid.',", "            widgetError: 'There was a problem connecting to the Dataverse.'", "        },", "        dropbox: {", "            // Shown on clicking \"Delete Access Token\" for dropbox", "            confirmDeauth: 'Are you sure you want to delete your Dropbox access ' +", "                'key? This will revoke access to Dropbox for all projects you have ' +"]}, {"lines": ["                'authorized.',"]}, {"lines": ["            deauthError: 'Could not deauthorize Dropbox at this time',", "            deauthSuccess: 'Deauthorized Dropbox.'", "        },", "        // TODO", "        github: {"]}, {"lines": [""]}, {"lines": ["        },", "        s3: {"]}, {"lines": [""]}, {"lines": ["        }"]}, {"lines": ["    }", "};"]}, {"lines": ["var $ = require('jquery');", "var ko = require('knockout');"]}, {"lines": ["var bootbox = require('bootbox');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["var LINK_CUTOFF = 2;"]}, {"lines": ["var setupEditable = function(elm, data) {", "    var $elm = $(elm);", "    var $editable = $elm.find('.link-name');", "    $editable.editable({", "        type: 'text',"]}, {"lines": ["        placement: 'bottom',", "        ajaxOptions: {", "            type: 'PUT',", "            dataType: 'json',"]}, {"lines": ["        },", "        send: 'always',", "        title: 'Edit Link Name',", "        params: function(params){", "            // Send JSON data", "            params.pk = data.id;", "            return JSON.stringify(params);", "        },", "        success: function(response, value) {", "            data.name(value);", "        },"]}, {"lines": ["    });", "};", "", "function LinkViewModel(data, $root) {", "", "    var self = this;", "", "    self.$root = $root;", "    $.extend(self, data);", ""]}, {"lines": ["    self.collapse = 'Collapse';"]}, {"lines": ["    self.name = ko.observable(data.name);"]}, {"lines": ["    self.readonly = 'readonly';"]}, {"lines": ["", "    self.collapseNode = ko.observable(false);", "    self.dateCreated = new $osf.FormattableDate(data.date_created);", "    self.linkUrl = ko.computed(function() {", "        return self.$root.nodeUrl() + '?view_only=' + data.key;", "    });", "    self.nodesList = ko.observableArray(data.nodes.slice(0, LINK_CUTOFF));", "    self.moreNode = ko.observable(data.nodes.length > LINK_CUTOFF);"]}, {"lines": ["    self.hasMoreText = ko.computed(function(){", "        return 'Show ' + (data.nodes.length - LINK_CUTOFF).toString() + ' more...';", "    });", "", "    self.anonymousDisplay = ko.computed(function() {"]}, {"lines": ["        var openTag = '<span>';", "        var closeTag = '</span>';", "        var text;", "        if (data.anonymous) {", "            text = 'Yes';", "            // Strikethrough if node is public", "            if ($root.nodeIsPublic) {", "                openTag = '<del>';", "                closeTag = '</del>';", "            }", "        } else{", "            text = 'No';", "        }", "        return [openTag, text, closeTag].join('');"]}, {"lines": ["    });", "", "    self.displayAllNodes = function() {", "        self.nodesList(data.nodes);", "        self.moreNode(false);", "        self.collapseNode(true);"]}, {"lines": ["    self.displayDefaultNodes = function() {", "        self.nodesList(data.nodes.slice(0, LINK_CUTOFF));", "        self.moreNode(true);", "        self.collapseNode(false);"]}, {"lines": ["}"]}, {"lines": ["function ViewModel(url, nodeIsPublic) {"]}, {"lines": ["    var self = this;"]}, {"lines": ["    self.nodeIsPublic = nodeIsPublic || false;"]}, {"lines": ["    self.url = url;", "    self.privateLinks = ko.observableArray();", "    self.nodeUrl = ko.observable(null);"]}, {"lines": ["    function onFetchSuccess(response) {", "        var node = response.node;", "        self.privateLinks(ko.utils.arrayMap(node.private_links, function(link) {", "            return new LinkViewModel(link, self);", "        }));", "        self.nodeUrl(node.absolute_url);", "    }"]}, {"lines": ["    function onFetchError() {"]}, {"lines": ["        $osf.growl('Could not retrieve view-only links.', 'Please refresh the page or ' +", "                'contact <a href=\"mailto: support@cos.io\">support@cos.io</a> if the ' +", "                'problem persists.');", "    }"]}, {"lines": [""]}, {"lines": ["    function fetch() {", "        $.ajax({", "            url: url,", "            type: 'GET',"]}, {"lines": ["        }).done(", "            onFetchSuccess", "        ).fail(", "            onFetchError", "        );", "    }"]}, {"lines": ["    fetch();"]}, {"lines": ["    self.removeLink = function(data) {", "        var dataToSend = {", "            'private_link_id': data.id"]}, {"lines": ["        bootbox.confirm({", "            title: 'Remove view only link?',", "            message: 'Are you sure to remove this view only link?',", "            callback: function(result) {", "                if(result) {", "                    $.ajax({", "                    type: 'delete',"]}, {"lines": ["                    contentType: 'application/json',", "                    dataType: 'json',"]}, {"lines": ["                }).done(function() {", "                    self.privateLinks.remove(data);", "                }).fail(function() {"]}, {"lines": ["                });", "                }", "            }", "        });", "    };"]}, {"lines": ["    self.afterRenderLink = function(elm, data) {"]}, {"lines": ["        var $tr = $(elm);"]}, {"lines": ["        var target = $tr.find('.copy-button');"]}, {"lines": ["        $tr.find('.remove-private-link').tooltip();", "        setupEditable(elm, data);", "    };"]}, {"lines": [""]}, {"lines": ["}", ""]}, {"lines": ["function PrivateLinkTable (selector, url, nodeIsPublic) {"]}, {"lines": ["    var self = this;"]}, {"lines": ["    self.viewModel = new ViewModel(url, nodeIsPublic);"]}, {"lines": ["    $osf.applyBindings(self.viewModel, selector);"]}, {"lines": [""]}, {"lines": ["}", "module.exports = PrivateLinkTable;"]}, {"lines": ["/////////////////////", "// Project JS      //", "/////////////////////"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var bootbox = require('bootbox');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["var NodeActions = {}; // Namespace for NodeActions"]}, {"lines": ["", "// TODO: move me to the NodeControl or separate module", "NodeActions.beforeForkNode = function(url, done) {", "    $.ajax({", "        url: url,", "        contentType: 'application/json'", "    }).done(function(response) {", "        bootbox.confirm("]}, {"lines": ["            $osf.joinPrompts(response.prompts, 'Are you sure you want to fork this project?'),"]}, {"lines": ["            function(result) {", "                if (result) {", "                    done && done();"]}, {"lines": ["            }"]}, {"lines": ["    }).fail("]}, {"lines": ["        $osf.handleJSONError"]}, {"lines": ["    );", "};", "", "NodeActions.forkNode = function() {"]}, {"lines": ["        // Block page"]}, {"lines": ["        $osf.block();"]}, {"lines": ["        // Fork node"]}, {"lines": ["        $osf.postJSON("]}, {"lines": ["            {}", "        ).done(function(response) {", "            window.location = response;", "        }).fail(function(response) {"]}, {"lines": ["            $osf.unblock();"]}, {"lines": ["            if (response.status === 403) {"]}, {"lines": ["                $osf.growl('Sorry:', 'you do not have permission to fork this project');"]}, {"lines": ["            } else {"]}, {"lines": ["                $osf.growl('Error:', 'Forking failed');"]}, {"lines": ["                Raven.captureMessage('Error occurred during forking');"]}, {"lines": ["    });", "};", "", "NodeActions.forkPointer = function(pointerId) {", "    bootbox.confirm({", "        title: 'Fork this project?',", "        message: 'Are you sure you want to fork this project?',", "        callback: function(result) {", "            if(result) {", "                // Block page"]}, {"lines": ["                $osf.block();"]}, {"lines": ["", "                // Fork pointer"]}, {"lines": ["                $osf.postJSON("]}, {"lines": ["                    {pointerId: pointerId}", "                ).done(function() {", "                    window.location.reload();", "                }).fail(function() {"]}, {"lines": ["                    $osf.unblock();", "                    $osf.growl('Error','Could not fork link.');"]}, {"lines": ["                });", "            }", "        }", "    });", "};", "", "NodeActions.beforeTemplate = function(url, done) {", "    $.ajax({", "        url: url,", "        contentType: 'application/json'", "    }).success(function(response) {", "        bootbox.confirm("]}, {"lines": ["            $osf.joinPrompts(response.prompts,"]}, {"lines": ["                ('Are you sure you want to create a new project using this project as a template? ' +", "                  'Any add-ons configured for this project will not be authenticated in the new project.')),", "            function (result) {", "                if (result) {", "                    done && done();"]}, {"lines": ["            }", "        );", "    });", "};", "", "NodeActions.addonFileRedirect = function(item) {", "    window.location.href = item.params.urls.view;", "    return false;", "};", "", "NodeActions.useAsTemplate = function() {"]}, {"lines": ["        $osf.block();"]}, {"lines": [""]}, {"lines": ["        $osf.postJSON("]}, {"lines": ["            {}", "        ).done(function(response) {", "            window.location = response.url;", "        }).fail(function(response) {"]}, {"lines": ["            $osf.unblock();", "            $osf.handleJSONError(response);"]}, {"lines": ["    });", "};"]}, {"lines": ["$(function() {"]}, {"lines": ["    $('#newComponent form').on('submit', function(e) {"]}, {"lines": ["        $('#add-component-submit')", "            .attr('disabled', 'disabled')", "            .text('Adding');"]}, {"lines": ["        if ($.trim($('#title').val()) === '') {"]}, {"lines": ["                .removeAttr('disabled', 'disabled')", "                .text('OK');"]}, {"lines": ["            e.preventDefault();", "        } else if ($(e.target).find('#title').val().length > 200) {"]}, {"lines": ["            $('#add-component-submit')", "                .removeAttr('disabled', 'disabled')", "                .text('OK');"]}, {"lines": [""]}, {"lines": ["            e.preventDefault();"]}, {"lines": [""]}, {"lines": ["        }"]}, {"lines": ["});"]}, {"lines": [""]}, {"lines": ["NodeActions._openCloseNode = function(nodeId) {"]}, {"lines": [""]}, {"lines": ["    var icon = $('#icon-' + nodeId);", "    var body = $('#body-' + nodeId);"]}, {"lines": ["    body.toggleClass('hide');"]}, {"lines": ["    if (body.hasClass('hide')) {"]}, {"lines": ["        icon.attr('title', 'More');", "    } else {"]}, {"lines": ["        icon.attr('title', 'Less');", "    }"]}, {"lines": [""]}, {"lines": ["    // Refresh tooltip text", "    icon.tooltip('destroy');", "    icon.tooltip();"]}, {"lines": ["};"]}, {"lines": ["NodeActions.reorderChildren = function(idList, elm) {"]}, {"lines": ["    $osf.postJSON("]}, {"lines": ["        {new_list: idList}", "    ).fail(function(response) {", "        $(elm).sortable('cancel');"]}, {"lines": ["        $osf.handleJSONError(response);"]}, {"lines": ["    });", "};", "", "NodeActions.removePointer = function(pointerId, pointerElm) {", "    $.ajax({", "        type: 'DELETE',"]}, {"lines": ["        data: JSON.stringify({", "            pointerId: pointerId", "        }),", "        contentType: 'application/json',", "        dataType: 'json'", "    }).done(function() {", "        pointerElm.remove();", "    }).fail("]}, {"lines": ["        $osf.handleJSONError"]}, {"lines": ["    );", "};", "", "", "/*", "Display recent logs for for a node on the project view page.", "*/", "NodeActions.openCloseNode = function(nodeId) {", "    var $logs = $('#logs-' + nodeId);", "    if (!$logs.hasClass('active')) {", "        if (!$logs.hasClass('served')) {", "            $.getJSON(", "                $logs.attr('data-uri'),", "                {count: 3}", "            ).done(function(response) {"]}, {"lines": ["                $logs.addClass('served');", "            });"]}, {"lines": ["        $logs.addClass('active');", "    } else {", "        $logs.removeClass('active');", "    }", "    // Hide/show the html", "    NodeActions._openCloseNode(nodeId);", "};"]}, {"lines": [""]}, {"lines": ["// TODO: remove this"]}, {"lines": ["$(document).ready(function() {"]}, {"lines": ["    var permissionInfoHtml = '<dl>' +", "        '<dt>Read</dt><dd>View project content and comment</dd>' +", "        '<dt>Read + Write</dt><dd>Read privileges plus add and configure components; add and edit content</dd>' +", "        '<dt>Administrator</dt><dd>Read and write privileges; manage contributors; delete and register project; public-private settings</dd>' +", "        '</dl>';"]}, {"lines": ["    $('.permission-info').attr(", "        'data-content', permissionInfoHtml", "    ).popover({", "        trigger: 'hover'", "    });"]}, {"lines": ["    $('.visibility-info').attr("]}, {"lines": ["    ).popover({", "        trigger: 'hover'", "    });"]}, {"lines": ["    ////////////////////", "    // Event Handlers //", "    ////////////////////"]}, {"lines": ["    $('.remove-pointer').on('click', function() {", "        var $this = $(this);", "        bootbox.confirm({", "            title: 'Remove this link?',", "            message: 'Are you sure you want to remove this link? This will not remove the ' +", "                'project this link refers to.',", "            callback: function(result) {", "                if(result) {", "                    var pointerId = $this.attr('data-id');", "                    var pointerElm = $this.closest('.list-group-item');", "                    NodeActions.removePointer(pointerId, pointerElm);", "                }", "            }"]}, {"lines": ["    });"]}, {"lines": ["    $('body').on('click', '.tagsinput .tag > span', function(e) {", "        window.location = '/search/?q=(tags:' + $(e.target).text().toString().trim()+ ')';", "    });"]}, {"lines": ["});"]}, {"lines": ["window.NodeActions = NodeActions;"]}, {"lines": ["module.exports = NodeActions;"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var Treebeard = require('treebeard');", "", "// CSS"]}, {"lines": [""]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var bootbox = require('bootbox');", "var Bloodhound = require('exports?Bloodhound!typeahead.js');"]}, {"lines": ["var moment = require('moment');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        row.trigger('click');"]}, {"lines": ["        item.data.childrenCount = 0;"]}, {"lines": ["                triggerClickOnItem.call(tb, item.children[i], true);"]}, {"lines": ["    if (typeof originalRow !== 'undefined') {"]}, {"lines": [""]}, {"lines": ["                        var url = postInfo[copyMode].url,", "                            postData = JSON.stringify(postInfo[copyMode].json),"]}, {"lines": ["        var children = $(this).children('i');"]}, {"lines": ["                someItemsAreFolders = (", "                    someItemsAreFolders ||", "                    thisItem.isFolder ||", "                    thisItem.isSmartFolder ||", "                    thisItem.parentIsSmartFolder ||", "                    !thisItem.permissions.movable", "                );"]}, {"lines": ["        });"]}, {"lines": ["        _cleanupMithril();"]}, {"lines": [" * TODO, bring the register page up to date."]}, {"lines": ["            ' its parent, <b>' + parentTitle + '</b>.' +"]}, {"lines": ["            ' If you want to register the parent, please go <a href=\"' +"]}, {"lines": ["        // Allow server to validate password", "        self.password = ko.observable('');"]}, {"lines": ["    var baseUrl = window.contextVars.waterbutlerURL + suffix;"]}, {"lines": ["                }).fail(function(xhr, textStatus, err) {", "                    var message;", "                    if (xhr.status === 507) {", "                        message = 'Could not update file. Insufficient storage space in your Dropbox.';", "                    } else {", "                        message = 'The file could not be updated.';", "                    }"]}, {"lines": ["                    $osf.growl('Error', message);"]}, {"lines": ["                        textStatus: textStatus,"]}, {"lines": ["/**"]}, {"lines": [" * JS module included on every page of the OSF. Site-wide initialization"]}, {"lines": [" * code goes here.", " */", "'use strict';"]}, {"lines": ["// CSS used on every page"]}, {"lines": ["require('../../vendor/bower_components/bootstrap/dist/css/bootstrap-theme.css');"]}, {"lines": ["require('../../vendor/bootstrap-editable-custom/css/bootstrap-editable.css');"]}, {"lines": ["require('../../vendor/bower_components/jquery-ui/themes/base/minified/jquery.ui.resizable.min.css');"]}, {"lines": ["require('../../css/bootstrap-xl.css');", "require('../../css/animate.css');", "require('../../css/site.css');"]}, {"lines": ["", "var $ = require('jquery');", "require('jquery.cookie');", ""]}, {"lines": [""]}, {"lines": ["// Prevent IE from caching responses"]}, {"lines": [""]}, {"lines": ["// Polyfill for String.prototype.endsWith"]}, {"lines": ["    String.prototype.endsWith = function(suffix) {", "        return this.indexOf(suffix, this.length - suffix.length) !== -1;", "    };", "}", ""]}, {"lines": ["// Apply an empty view-model to the navbar, just so the tooltip bindingHandler", "// can be used"]}, {"lines": [""]}, {"lines": ["$('[rel=\"tooltip\"]').tooltip();", ""]}, {"lines": ["// If there isn't a user logged in, show the footer slide-in", "var sliderSelector = '#footerSlideIn';", "var SlideInViewModel = function (){", "    var self = this;", "    self.elem = $(sliderSelector);"]}, {"lines": ["", "    var dismissed = false;", "", "    try {", "        dismissed = dismissed || window.localStorage.getItem('slide') === '0';", "    } catch (e) {}", "", "    dismissed = dismissed || $.cookie('slide') === '0';", "", "    if (this.elem.length > 0 && !dismissed) {"]}, {"lines": ["        setTimeout(function () {", "            self.elem.slideDown(1000);", "        }, 3000);", "    }", "    self.dismiss = function() {", "        self.elem.slideUp(1000);"]}, {"lines": ["        try {", "            window.localStorage.setItem('slide', '0');", "        } catch (e) {", "            $.cookie('slide', '0', { expires: 1, path: '/'});", "        }"]}, {"lines": ["        window.ga('send', 'event', 'button', 'click', source);"]}, {"lines": ["    };", "};"]}, {"lines": ["$(function() {"]}, {"lines": ["    if(/MSIE 9.0/.test(window.navigator.userAgent) ||", "       /MSIE 8.0/.test(window.navigator.userAgent) ||", "       /MSIE 7.0/.test(window.navigator.userAgent) ||", "       /MSIE 6.0/.test(window.navigator.userAgent)) {"]}, {"lines": ["        $('.placeholder-replace').show();", "    }"]}, {"lines": ["        $osf.applyBindings(new SlideInViewModel(), sliderSelector);", "    }"]}, {"lines": ["    new NavbarControl('.osf-nav-wrapper');", "});"]}, {"lines": ["/**", " * Initialization code for the dashboard pages. Starts up the Project Organizer", " * and binds the onboarder Knockout components."]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": ["var ko = require('knockout');", "var $ = require('jquery');"]}, {"lines": ["var jstz = require('jstimezonedetect').jstz;"]}, {"lines": [""]}, {"lines": ["// Knockout components for the onboarder"]}, {"lines": ["", "var url = '/api/v1/dashboard/get_nodes/';", "var request = $.getJSON(url, function(response) {", "    var allNodes = response.nodes;", "    //  For uploads, only show nodes for which user has write or admin permissions", "    var uploadSelection = ko.utils.arrayFilter(allNodes, function(node) {", "        return $.inArray(node.permissions, ['write', 'admin']) !== -1;", "    });"]}, {"lines": [""]}, {"lines": ["    $osf.applyBindings({nodes: allNodes}, '#obGoToProject');"]}, {"lines": ["    $osf.applyBindings({nodes: uploadSelection}, '#obUploader');"]}, {"lines": ["", "    function ProjectCreateViewModel() {", "        var self = this;"]}, {"lines": ["        self.isOpen = ko.observable(false);"]}, {"lines": ["        self.focus = ko.observable(false);", "        self.toggle = function() {", "            self.isOpen(!self.isOpen());", "            self.focus(self.isOpen());", "        };", "        self.nodes = response.nodes;", "    }"]}, {"lines": ["    $osf.applyBindings(new ProjectCreateViewModel(), '#projectCreate');"]}, {"lines": ["});", "request.fail(function(xhr, textStatus, error) {", "    Raven.captureMessage('Could not fetch dashboard nodes.', {", "        url: url, textStatus: textStatus, error: error", "    });", "});"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["$(document).ready(function() {", "    $('#projectOrganizerScope').tooltip({selector: '[data-toggle=tooltip]'});"]}, {"lines": ["", "// Don't show dropped content if user drags outside grid", "window.ondragover = function(e) { e.preventDefault(); };", "window.ondrop = function(e) { e.preventDefault(); };", ""]}, {"lines": ["var SignUp = require('../signUp.js');"]}, {"lines": ["var ProjectNotifications = require('../notificationsTreebeard.js');"]}, {"lines": ["/**", " * Initialization code for the profile page. Currently, this just loads the necessary"]}, {"lines": [" * modules and puts the profile module on the global context."]}, {"lines": [" *"]}, {"lines": ["*/"]}, {"lines": [""]}, {"lines": ["var profile = require('../profile.js'); // Social, Job, Education classes", "require('../project.js'); // Needed for nodelists to work", "require('../logFeed.js'); // Needed for nodelists to work", ""]}, {"lines": ["var ctx = window.contextVars;", "// Instantiate all the profile modules"]}, {"lines": ["var profile = require('../profile.js');", "", "var ctx = window.contextVars;", "", "new profile.Names('#names', ctx.nameUrls, ['edit']);", "new profile.Social('#social', ctx.socialUrls, ['edit']);", "new profile.Jobs('#jobs', ctx.jobsUrls, ['edit']);", "new profile.Schools('#schools', ctx.schoolsUrls, ['edit']);"]}, {"lines": ["/** Initialization code for the project overview page. */", "'use strict';"]}, {"lines": ["", "var $ = require('jquery');"]}, {"lines": ["require('../../vendor/bower_components/jquery.tagsinput/jquery.tagsinput.css');"]}, {"lines": ["var LogFeed = require('js/logFeed');", "var pointers = require('js/pointers');"]}, {"lines": ["var NodeControl = require('js/nodeControl');", "var CitationList = require('js/citationList');", "var CitationWidget = require('js/citationWidget');", "var mathrender = require('js/mathrender');", "var md = require('js/markdown').full;", ""]}, {"lines": ["var ctx = window.contextVars;", "var nodeApiUrl = ctx.node.urls.api;"]}, {"lines": ["", "// Listen for the nodeLoad event (prevents multiple requests for data)"]}, {"lines": ["    // Initialize nodeControl"]}, {"lines": ["    new NodeControl.NodeControl('#projectScope', data);"]}, {"lines": ["// Initialize comment pane w/ it's viewmodel", "var $comments = $('#comments');", "if ($comments.length) {", "    var userName = window.contextVars.currentUser.name;", "    var canComment = window.contextVars.currentUser.canComment;", "    var hasChildren = window.contextVars.node.hasChildren;", "    Comment.init('#commentPane', userName, canComment, hasChildren);", "}"]}, {"lines": ["// Initialize CitationWidget if user isn't viewing through an anonymized VOL"]}, {"lines": ["    new CitationWidget('#citationStyleInput', '#citationText');", "}", ""]}, {"lines": ["        width: '100%',"]}, {"lines": ["            var url = window.contextVars.node.urls.api + 'addtag/' + tag + '/';"]}, {"lines": ["                type: 'POST',", "                contentType: 'application/json'"]}, {"lines": ["            });"]}, {"lines": ["            var url = window.contextVars.node.urls.api + 'removetag/' + tag + '/';"]}, {"lines": ["                type: 'POST',", "                contentType: 'application/json'"]}, {"lines": ["            });"]}, {"lines": ["    $('#node-tags_tag').attr('maxlength', '128');"]}, {"lines": ["                url: ctx.urls.wikiContent"]}, {"lines": ["            $(elm).text($(elm).text().replace(/\\s*$/, ''));"]}, {"lines": ["'use strict';", "var $ = require('jquery');"]}, {"lines": ["var ko = require('knockout');", "var bootbox = require('bootbox');"]}, {"lines": [""]}, {"lines": ["var ctx = window.contextVars;"]}, {"lines": ["/**", "    * Unblock UI and display error modal", "    */"]}, {"lines": ["    $osf.unblock();", "    bootbox.alert('Registration failed');", "}", "", "function registerNode(data) {", "", "    // Block UI until request completes", "    $osf.block();", "", "    // POST data", "    $.ajax({", "        url:  ctx.node.urls.api + 'register/' + ctx.regTemplate + '/',", "        type: 'POST',", "        data: JSON.stringify(data),", "        contentType: 'application/json',", "        dataType: 'json'", "    }).done(function(response) {"]}, {"lines": ["        }", "        else if (response.status === 'error') {"]}, {"lines": ["        }", "    }).fail(function() {"]}, {"lines": ["    });", "", "    // Stop event propagation", "    return false;", "", "}", "", "$(document).ready(function() {", "", "    // Don't submit form on enter; must use $.delegate rather than $.on", "    // to catch dynamically created form elements", "    $('#registration_template').delegate('input, select', 'keypress', function(event) {", "        return event.keyCode !== 13;", "    });", ""]}, {"lines": ["    var registrationViewModel = new MetaData.ViewModel("]}, {"lines": ["        ctx.regSchema,", "        ctx.registered,", "        [ctx.node.id].concat(ctx.node.children)", "    );", "    // Apply view model", "    ko.applyBindings(registrationViewModel, $('#registration_template')[0]);", "    registrationViewModel.updateIdx('add', true);", "", "    if (ctx.registered) {", "        registrationViewModel.unserialize(ctx.regPayload);", "    }", "", "    $('#registration_template form').on('submit', function() {", ""]}, {"lines": ["        // Serialize responses", "        var serialized = registrationViewModel.serialize(),", "            data = serialized.data,", "            complete = serialized.complete;", "", "        // Clear continue text and stop if incomplete", "        if (!complete) {", "            registrationViewModel.continueText('');", "            return false;", "        }", ""]}, {"lines": ["        $.ajax({", "            url: ctx.node.urls.api + 'beforeregister/',", "            contentType: 'application/json',", "            success: function(response) {"]}, {"lines": ["                    bootbox.confirm("]}, {"lines": ["                        function(result) {", "                            if (result) {", "                                registerNode(data);", "                            }", "                        }", "                    );"]}, {"lines": ["                    registerNode(data);", "                }", "            }"]}, {"lines": ["        });"]}, {"lines": ["        return false;"]}, {"lines": ["    });", "});"]}, {"lines": ["pymParent.onMessage('scroll_top_now', scrollToTop);"]}, {"lines": ["    $('[data-toggle=\"tooltip\"]').tooltip();"]}, {"lines": ["'use strict';", "/**", " * API client for the 'nodes' resource.", " *", " * Usage:", " *", " *    var client = new NodeClient();", " *    client.list({pageSize: 100}).then(function(nodes) {", " *        nodes.forEach(function(node) {", " *            console.log(node.title);", " *            console.log(node.description);", " *        })", " *    });", " *", " *    client.detail('abc12').then(function(node) {", " *        console.log('Information about Node abc12:');", " *        console.log(node.title);", " *        console.log(node.isPublic);", " *    });", " */", "var base = require('js/resources/base');", "var oop = require('js/oop');"]}, {"lines": ["", "/** Node model */"]}, {"lines": ["    /** Params is the data from the server. */", "    constructor: function(params) {", "        this.id = params.id;", "        this.title = params.title;", "        this.description = params.description;", "        this.isPublic = params.is_public;", "    },", "    toString: function() {", "        return '[Node ' + this.id + ']';", "    }", "});", "", "", "var NodeClient = oop.extend(base.BaseClient, {", "    /**", "     * Return a promise that resolves to an Array of Node objects.", "     * @param {object} params", "     *  {number} pageSize", "     */", "    list: function(params) {", "        params = params || {};", "        var ret = $.Deferred();", "        // TODO: page numbber, filtering etc.", "        var query = params.pageSize != null ? 'page[size]=' + params.pageSize : '';", "        this._request({url: '/nodes/',", "                      query: query})", "            .done(function(resp) {"]}, {"lines": ["                var nodes = $.map(resp.data, function(nodeData) {", "                    return new Node(nodeData);", "                });", "                ret.resolve(nodes);", "            }).fail(base.captureError('Could not fetch nodes list.'));", "        return ret.promise();", "    }", "    // TODO: detail(nodeID)", "});", "", "module.exports = {", "    Node: Node,", "    NodeClient: NodeClient", "};"]}, {"lines": ["                    if (name === 'pubmed') {", "                        name = 'pubmed central';"]}, {"lines": ["                  if (name === 'pubmed') {", "                      name = 'pubmed central';"]}, {"lines": ["        describe('ProjectViewModel', () => {"]}, {"lines": ["                vm.createIdentifiers().always(() => {"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/"]}, {"lines": ["'use strict';"]}, {"lines": ["var assert = require('chai').assert;"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var moment = require('moment');", "var Raven = require('raven-js');"]}, {"lines": [""]}, {"lines": ["var $osf = require('../osfHelpers');"]}, {"lines": [""]}, {"lines": ["// Add sinon asserts to chai.assert, so we can do assert.calledWith instead of sinon.assert.calledWith", "sinon.assert.expose(assert, {prefix: ''});", ""]}, {"lines": ["describe('osfHelpers', () => {"]}, {"lines": [""]}, {"lines": ["    describe('growl', () => {", "        it('calls $.growl with correct arguments', () => {"]}, {"lines": ["            var stub = new sinon.stub($, 'growl');"]}, {"lines": ["            $osf.growl('The one', 'the only', 'danger');"]}, {"lines": ["            assert.calledOnce(stub);"]}, {"lines": [""]}, {"lines": ["            assert.calledWith(stub,"]}, {"lines": ["                {title: '<strong>The one<strong><br />', message: 'the only'});"]}, {"lines": ["            stub.restore();"]}, {"lines": ["        });"]}, {"lines": ["    });", ""]}, {"lines": ["    describe('handleJSONError', () => {"]}, {"lines": ["", "        var growlStub;", "        var ravenStub;", "        beforeEach(() => {", "            growlStub = new sinon.stub($osf, 'growl');", "            ravenStub = new sinon.stub(Raven, 'captureMessage');", "        });", "", "        afterEach(() => {", "            growlStub.restore();", "            ravenStub.restore();", "        });"]}, {"lines": ["        var response = {"]}, {"lines": ["            responseJSON: {", "                message_short: 'Oh no!',", "                message_long: 'Something went wrong'", "            }"]}, {"lines": ["        };", "        it('uses the response body if available', () => {"]}, {"lines": ["            $osf.handleJSONError(response);"]}, {"lines": ["            assert.called(growlStub);", "            assert.calledWith(growlStub,", "                              response.responseJSON.message_short,", "                              response.responseJSON.message_long);"]}, {"lines": ["        });"]}, {"lines": [""]}, {"lines": ["        it('logs error with Raven', () => {"]}, {"lines": ["            $osf.handleJSONError(response);"]}, {"lines": ["            assert.called(growlStub);", "            assert.called(ravenStub);"]}, {"lines": ["        });", "    });"]}, {"lines": [""]}, {"lines": ["    describe('block', () => {"]}, {"lines": ["        it('calls $.blockUI with correct arguments', () => {"]}, {"lines": ["            $osf.block();"]}, {"lines": ["            assert.calledOnce(stub);", "            assert.calledWith(stub, {"]}, {"lines": ["                css: {", "                    border: 'none',", "                    padding: '15px',", "                    backgroundColor: '#000',", "                    '-webkit-border-radius': '10px',", "                    '-moz-border-radius': '10px',", "                    opacity: 0.5,", "                    color: '#fff'", "                },", "                message: 'Please wait'", "            });", "        });"]}, {"lines": ["    });"]}, {"lines": [""]}, {"lines": ["    describe('unblock', () => {", "        it('calls unblockUI', () => {"]}, {"lines": ["            var stub = new sinon.stub($, 'unblockUI');"]}, {"lines": ["            $osf.unblock();"]}, {"lines": ["            assert.calledOnce(stub);"]}, {"lines": ["        });"]}, {"lines": ["    });"]}, {"lines": [""]}, {"lines": ["    describe('mapByProperty', () => {", "        it('returns the given property for every item in a list of objects', () => {", "            var fixture = [{foo: 42}, {foo: 24}, {foo: 424, bar:242}, {bar: 2424}];", "            var ret = $osf.mapByProperty(fixture, 'foo');", "            assert.deepEqual(ret, [42, 24, 424]);"]}, {"lines": ["        });", "    });", ""]}, {"lines": ["    describe('isEmail', () => {", "        it('returns true for valid emails', () => {", "            var emails = [", "                'niceandsimple@example.com',", "                'NiCeAnDsImPlE@eXaMpLe.CoM',", "                'very.common@example.com',", "                'a.little.lengthy.but.fine@a.iana-servers.net',", "                'disposable.style.email.with+symbol@example.com',", "                '\"very.unusual.@.unusual.com\"@example.com',", "                \"!#$%&'*+-/=?^_`{}|~@example.org\", // jshint ignore: line", "            ];", "            emails.forEach((email) => {", "                assert.isTrue($osf.isEmail(email), email + ' not recognized as a valid email');", "            });"]}, {"lines": ["        });"]}, {"lines": [""]}, {"lines": ["        it('returns false for invalid emails', () => {", "            var invalids = [", "                'a\"b(c)d,e:f;g<h>i[j\\\\k]l@example.com',", "                'just\"not\"right@example.com',", "                'this is\"not\\allowed@example.com',", "                'this\\\\ still\\\\\"not\\\\\\\\allowed@example.com',", "                '\"very.(),:;<>[]\\\".VERY.\\\"very@\\\\ \\\"very\\\".unusual\"@strange.example.com',", "                'user@example',", "                '@nouser.com',", "                'example.com',", "                'user',", "                '',", "                null,", "                undefined", "            ];", "            invalids.forEach((invalid) => {", "                assert.isFalse($osf.isEmail(invalid), invalid + ' not recognized as a invalid email');", "            });", "        });"]}, {"lines": ["    });"]}, {"lines": [""]}, {"lines": ["    describe('ajax helpers', () => {"]}, {"lines": ["        var stub, xhr;"]}, {"lines": ["        beforeEach(() => {"]}, {"lines": ["            stub = new sinon.stub($, 'ajax');"]}, {"lines": ["        });", "        afterEach(function() {"]}, {"lines": ["            stub.restore();"]}, {"lines": ["        });"]}, {"lines": [""]}, {"lines": ["        describe('postJSON', () => {", "            it('calls $.ajax with correct args', () => {", "                var url = '/foo';", "                var payload = {'bar': 42};", "                $osf.postJSON(url, payload);", ""]}, {"lines": ["                assert.calledOnce(stub);", "                assert.calledWith(stub, {"]}, {"lines": ["                    url: url,", "                    type: 'post',", "                    data: JSON.stringify(payload),", "                    contentType: 'application/json',", "                    dataType: 'json'", "                });"]}, {"lines": ["            });", "        });"]}, {"lines": [""]}, {"lines": ["        describe('putJSON', () => {", "            it('calls $.ajax with correct args', () => {", "                var url = '/foo';", "                var payload = {'bar': 42};", "                $osf.putJSON(url, payload);", ""]}, {"lines": ["                assert.calledOnce(stub);", "                assert.calledWith(stub, {"]}, {"lines": ["                    url: url,", "                    type: 'put',", "                    data: JSON.stringify(payload),", "                    contentType: 'application/json',", "                    dataType: 'json'", "                });"]}, {"lines": ["            });", "        });", "    });"]}, {"lines": [""]}, {"lines": ["    describe('urlParams', () => {", "        it('should parse query params', () => {", "            assert.deepEqual($osf.urlParams('?foo=bar'), {foo: 'bar'});", "            assert.deepEqual($osf.urlParams('?foo=bar'), {foo: 'bar'});", "            assert.deepEqual($osf.urlParams('?foo=bar&baz=42'), {foo: 'bar', baz: '42'});", "        });"]}, {"lines": ["    });"]}, {"lines": [""]}, {"lines": ["    describe('htmlEscape', () => {", "        it('should escape html entities', () => {", "            assert.equal($osf.htmlEscape('safe'), 'safe');", "            assert.equal($osf.htmlEscape('<b>'), '&lt;b&gt;');", "            assert.equal($osf.htmlEscape('<script>alert(\"lol\")</script>'), '&lt;script&gt;alert(\"lol\")&lt;/script&gt;');", "        });"]}, {"lines": ["    });"]}, {"lines": [""]}, {"lines": ["    describe('FormattableDate', () => {", "        it('should have local and utc time', () => {", "            var date = new Date();", "            var fd = new $osf.FormattableDate(date);", "            var expectedLocal = moment(date).format('YYYY-MM-DD hh:mm A');", "            assert.equal(fd.local, expectedLocal);", "            var expectedUTC = moment.utc(date).format('YYYY-MM-DD HH:mm UTC');", "            assert.equal(fd.utc, expectedUTC);", "        });"]}, {"lines": ["    });"]}, {"lines": ["});"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';", "var assert = require('chai').assert;", "var $ = require('jquery');", "var faker = require('faker');", "", "var utils = require('./utils');", "var profile = require('../profile');", ""]}, {"lines": ["// Add sinon asserts to chai.assert, so we can do assert.calledWith instead of sinon.assert.calledWith", "sinon.assert.expose(assert, {prefix: ''});", ""]}, {"lines": ["describe('profile', () => {", "    describe('ViewModels', () => {"]}, {"lines": [""]}, {"lines": ["        var nameURLs = {", "            crud: '/settings/names/',", "            impute: '/settings/names/impute/'", "        };", "        var server;"]}, {"lines": [""]}, {"lines": ["        var names = {", "            full: faker.name.findName(),", "            given: faker.name.firstName(),", "            middle: [faker.name.lastName()],", "            family: faker.name.lastName(),", "            suffix: faker.name.suffix()", "        };", "        var imputedNames = {", "            given: faker.name.firstName(),", "            middle: [faker.name.lastName()],", "            family: faker.name.lastName(),", "            suffix: faker.name.suffix()", "        };"]}, {"lines": [""]}, {"lines": ["        before(() => {", "            // Set up fake server", "            var endpoints = [", "                {url: nameURLs.crud, response: names},", "                {url: /\\/settings\\/names\\/impute\\/.+/, response: imputedNames}", "            ];", "            server = utils.createServer(sinon, endpoints);", "        });"]}, {"lines": [""]}, {"lines": ["        after(() => {", "            server.restore();"]}, {"lines": ["        });", ""]}, {"lines": ["", "        describe('NameViewModel', () => {", "            var vm;"]}, {"lines": ["", "            // Constructor current sends a request, so need to make beforeEach async", "            beforeEach((done) => {", "                vm = new profile._NameViewModel(nameURLs, ['view', 'edit'], false, function() {", "                    done();", "                });"]}, {"lines": ["            });"]}, {"lines": [""]}, {"lines": ["            it('should fetch and update names upon instantiation', (done) => {", "                var vm = new profile._NameViewModel(nameURLs, ['view', 'edit'], false, function() {", "                    // Observables have been updated", "                    assert.equal(this.full(), names.full);", "                    assert.equal(this.given(), names.given);", "                    assert.equal(this.family(), names.family);", "                    assert.equal(this.suffix(), names.suffix);"]}, {"lines": ["                    done();", "                });"]}, {"lines": ["            });"]}, {"lines": ["", "            describe('impute', () => {", "                it('should send request and update imputed names', (done) => {"]}, {"lines": ["                    vm.impute().done(() => {"]}, {"lines": ["                        assert.equal(vm.given(), imputedNames.given);", "                        done();", "                    });"]}, {"lines": ["                });", "            });"]}, {"lines": ["", "            // TODO: Test citation computes"]}, {"lines": ["        });"]}, {"lines": ["", "    // TODO: Test other profile ViewModels"]}, {"lines": ["    });", "});"]}, {"lines": [""]}, {"lines": ["/*"]}, {"lines": ["window.contextVars = {", "    node: {", "        urls: {", "            api: faker.internet.ip()", "        }", "    }", "};"]}, {"lines": ["    var updateUrl = faker.internet.ip();"]}, {"lines": ["            changeMessageSpy = sinon.spy(vm, 'changeMessage');"]}, {"lines": ["        });"]}, {"lines": ["            changeMessageSpy = sinon.spy(vm, 'changeMessage');"]}, {"lines": ["    describe('#updateCategory', () => {"]}, {"lines": ["        var updateSuccessSpy = sinon.spy(vm, 'updateSuccess');"]}, {"lines": ["            server.respondWith("]}, {"lines": ["                    };"]}, {"lines": ["        });"]}, {"lines": ["// Generate a single webpack bundle for all tests for faster testing", "// See https://github.com/webpack/karma-webpack#alternative-usage", ""]}, {"lines": ["// Configure raven with a fake DSN to avoid errors in test output", "var Raven = require('raven-js');", "Raven.config('http://abc@example.com:80/2');", ""]}, {"lines": ["// Include all files that end with .test.js (core tests)"]}, {"lines": ["var context = require.context('.', true, /.*test\\.js$/); //make sure you have your directory and regex test set correctly!", "context.keys().forEach(context);"]}, {"lines": ["", "// Include all files in the addons directory that end with .test.js", "var addonContext = require.context('../../../addons/', true, /.*test\\.js$/); //make sure you have your directory and regex test set correctly!", "addonContext.keys().forEach(addonContext);"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';", "var assert = require('chai').assert;", "", "var utils = require('tests/utils');", "var faker = require('faker');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    });"]}, {"lines": ["});"]}, {"lines": ["/*! X-editable - v1.5.1", "* In-place editing with Twitter Bootstrap, jQuery UI or pure jQuery", "* http://github.com/vitalets/x-editable"]}, {"lines": ["* Copyright (c) 2013 Vitaliy Potapov; Licensed MIT", "*", "* Modified by @sloria on 2015-03-07: Remove datepicker and other extraneous", "* plugins and inputs", "* */"]}, {"lines": ["/**", "Form with single input element, two buttons and two states: normal/loading.", "Applied as jQuery method to DIV tag (not to form tag!). This is because form can be in loading state when spinner shown.", "Editableform is linked with one of input types, e.g. 'text', 'select' etc.", "", "@class editableform", "@uses text", "@uses textarea", "**/", "(function ($) {", "    \"use strict\";", "", "    var EditableForm = function (div, options) {", "        this.options = $.extend({}, $.fn.editableform.defaults, options);", "        this.$div = $(div); //div, containing form. Not form tag. Not editable-element.", "        if(!this.options.scope) {", "            this.options.scope = this;", "        }", "        //nothing shown after init", "    };", "", "    EditableForm.prototype = {", "        constructor: EditableForm,", "        initInput: function() {  //called once", "            //take input from options (as it is created in editable-element)", "            this.input = this.options.input;", "", "            //set initial value", "            //todo: may be add check: typeof str === 'string' ?", "            this.value = this.input.str2value(this.options.value);", "", "            //prerender: get input.$input", "            this.input.prerender();", "        },", "        initTemplate: function() {", "            this.$form = $($.fn.editableform.template);", "        },", "        initButtons: function() {", "            var $btn = this.$form.find('.editable-buttons');", "            $btn.append($.fn.editableform.buttons);", "            if(this.options.showbuttons === 'bottom') {", "                $btn.addClass('editable-buttons-bottom');", "            }", "        },", "        /**", "        Renders editableform", "", "        @method render", "        **/", "        render: function() {", "            //init loader", "            this.$loading = $($.fn.editableform.loading);", "            this.$div.empty().append(this.$loading);", "", "            //init form template and buttons", "            this.initTemplate();", "            if(this.options.showbuttons) {", "                this.initButtons();", "            } else {", "                this.$form.find('.editable-buttons').remove();", "            }", "", "            //show loading state", "            this.showLoading();", "", "            //flag showing is form now saving value to server.", "            //It is needed to wait when closing form.", "            this.isSaving = false;", "", "            /**", "            Fired when rendering starts", "            @event rendering", "            @param {Object} event event object", "            **/", "            this.$div.triggerHandler('rendering');", "", "            //init input", "            this.initInput();", "", "            //append input to form", "            this.$form.find('div.editable-input').append(this.input.$tpl);", "", "            //append form to container", "            this.$div.append(this.$form);", "", "            //render input", "            $.when(this.input.render())", "            .then($.proxy(function () {", "                //setup input to submit automatically when no buttons shown", "                if(!this.options.showbuttons) {", "                    this.input.autosubmit();", "                }", "", "                //attach 'cancel' handler", "                this.$form.find('.editable-cancel').click($.proxy(this.cancel, this));", "", "                if(this.input.error) {", "                    this.error(this.input.error);", "                    this.$form.find('.editable-submit').attr('disabled', true);", "                    this.input.$input.attr('disabled', true);", "                    //prevent form from submitting", "                    this.$form.submit(function(e){ e.preventDefault(); });", "                } else {", "                    this.error(false);", "                    this.input.$input.removeAttr('disabled');", "                    this.$form.find('.editable-submit').removeAttr('disabled');", "                    var value = (this.value === null || this.value === undefined || this.value === '') ? this.options.defaultValue : this.value;", "                    this.input.value2input(value);", "                    //attach submit handler", "                    this.$form.submit($.proxy(this.submit, this));", "                }", "", "                /**", "                Fired when form is rendered", "                @event rendered", "                @param {Object} event event object", "                **/", "                this.$div.triggerHandler('rendered');", "", "                this.showForm();", "", "                //call postrender method to perform actions required visibility of form", "                if(this.input.postrender) {", "                    this.input.postrender();", "                }", "            }, this));", "        },", "        cancel: function() {", "            /**", "            Fired when form was cancelled by user", "            @event cancel", "            @param {Object} event event object", "            **/", "            this.$div.triggerHandler('cancel');", "        },", "        showLoading: function() {", "            var w, h;", "            if(this.$form) {", "                //set loading size equal to form", "                w = this.$form.outerWidth();", "                h = this.$form.outerHeight();", "                if(w) {", "                    this.$loading.width(w);", "                }", "                if(h) {", "                    this.$loading.height(h);", "                }", "                this.$form.hide();", "            } else {", "                //stretch loading to fill container width", "                w = this.$loading.parent().width();", "                if(w) {", "                    this.$loading.width(w);", "                }", "            }", "            this.$loading.show();", "        },", "", "        showForm: function(activate) {", "            this.$loading.hide();", "            this.$form.show();", "            if(activate !== false) {", "                this.input.activate();", "            }", "            /**", "            Fired when form is shown", "            @event show", "            @param {Object} event event object", "            **/", "            this.$div.triggerHandler('show');", "        },", "", "        error: function(msg) {", "            var $group = this.$form.find('.control-group'),", "                $block = this.$form.find('.editable-error-block'),", "                lines;", "", "            if(msg === false) {", "                $group.removeClass($.fn.editableform.errorGroupClass);", "                $block.removeClass($.fn.editableform.errorBlockClass).empty().hide();", "            } else {", "                //convert newline to <br> for more pretty error display", "                if(msg) {", "                    lines = (''+msg).split('\\n');", "                    for (var i = 0; i < lines.length; i++) {", "                        lines[i] = $('<div>').text(lines[i]).html();", "                    }", "                    msg = lines.join('<br>');", "                }", "                $group.addClass($.fn.editableform.errorGroupClass);", "                $block.addClass($.fn.editableform.errorBlockClass).html(msg).show();", "            }", "        },", "", "        submit: function(e) {", "            e.stopPropagation();", "            e.preventDefault();", "", "            //get new value from input", "            var newValue = this.input.input2value();", "", "            //validation: if validate returns string or truthy value - means error", "            //if returns object like {newValue: '...'} => submitted value is reassigned to it", "            var error = this.validate(newValue);", "            if ($.type(error) === 'object' && error.newValue !== undefined) {", "                newValue = error.newValue;", "                this.input.value2input(newValue);", "                if(typeof error.msg === 'string') {", "                    this.error(error.msg);", "                    this.showForm();", "                    return;", "                }", "            } else if (error) {", "                this.error(error);", "                this.showForm();", "                return;", "            }", "", "            //if value not changed --> trigger 'nochange' event and return", "            /*jslint eqeq: true*/", "            if (!this.options.savenochange && this.input.value2str(newValue) == this.input.value2str(this.value)) {", "            /*jslint eqeq: false*/", "                /**", "                Fired when value not changed but form is submitted. Requires savenochange = false.", "                @event nochange", "                @param {Object} event event object", "                **/", "                this.$div.triggerHandler('nochange');", "                return;", "            }", "", "            //convert value for submitting to server", "            var submitValue = this.input.value2submit(newValue);", "", "            this.isSaving = true;", "", "            //sending data to server", "            $.when(this.save(submitValue))", "            .done($.proxy(function(response) {", "                this.isSaving = false;", "", "                //run success callback", "                var res = typeof this.options.success === 'function' ? this.options.success.call(this.options.scope, response, newValue) : null;", "", "                //if success callback returns false --> keep form open and do not activate input", "                if(res === false) {", "                    this.error(false);", "                    this.showForm(false);", "                    return;", "                }", "", "                //if success callback returns string -->  keep form open, show error and activate input", "                if(typeof res === 'string') {", "                    this.error(res);", "                    this.showForm();", "                    return;", "                }", "", "                //if success callback returns object like {newValue: <something>} --> use that value instead of submitted", "                //it is usefull if you want to chnage value in url-function", "                if(res && typeof res === 'object' && res.hasOwnProperty('newValue')) {", "                    newValue = res.newValue;", "                }", "", "                //clear error message", "                this.error(false);", "                this.value = newValue;", "                /**", "                Fired when form is submitted", "                @event save", "                @param {Object} event event object", "                @param {Object} params additional params", "                @param {mixed} params.newValue raw new value", "                @param {mixed} params.submitValue submitted value as string", "                @param {Object} params.response ajax response", "", "                @example", "                $('#form-div').on('save'), function(e, params){", "                    if(params.newValue === 'username') {...}", "                });", "                **/", "                this.$div.triggerHandler('save', {newValue: newValue, submitValue: submitValue, response: response});", "            }, this))", "            .fail($.proxy(function(xhr) {", "                this.isSaving = false;", "", "                var msg;", "                if(typeof this.options.error === 'function') {", "                    msg = this.options.error.call(this.options.scope, xhr, newValue);", "                } else {", "                    msg = typeof xhr === 'string' ? xhr : xhr.responseText || xhr.statusText || 'Unknown error!';", "                }", "", "                this.error(msg);", "                this.showForm();", "            }, this));", "        },", "", "        save: function(submitValue) {", "            //try parse composite pk defined as json string in data-pk", "            this.options.pk = $.fn.editableutils.tryParseJson(this.options.pk, true);", "", "            var pk = (typeof this.options.pk === 'function') ? this.options.pk.call(this.options.scope) : this.options.pk,", "            /*", "              send on server in following cases:", "              1. url is function", "              2. url is string AND (pk defined OR send option = always)", "            */", "            send = !!(typeof this.options.url === 'function' || (this.options.url && ((this.options.send === 'always') || (this.options.send === 'auto' && pk !== null && pk !== undefined)))),", "            params;", "", "            if (send) { //send to server", "                this.showLoading();", "", "                //standard params", "                params = {", "                    name: this.options.name || '',", "                    value: submitValue,", "                    pk: pk", "                };", "", "                //additional params", "                if(typeof this.options.params === 'function') {", "                    params = this.options.params.call(this.options.scope, params);", "                } else {", "                    //try parse json in single quotes (from data-params attribute)", "                    this.options.params = $.fn.editableutils.tryParseJson(this.options.params, true);", "                    $.extend(params, this.options.params);", "                }", "", "                if(typeof this.options.url === 'function') { //user's function", "                    return this.options.url.call(this.options.scope, params);", "                } else {", "                    //send ajax to server and return deferred object", "                    return $.ajax($.extend({", "                        url     : this.options.url,", "                        data    : params,", "                        type    : 'POST'", "                    }, this.options.ajaxOptions));", "                }", "            }", "        },", "", "        validate: function (value) {", "            if (value === undefined) {", "                value = this.value;", "            }", "            if (typeof this.options.validate === 'function') {", "                return this.options.validate.call(this.options.scope, value);", "            }", "        },", "", "        option: function(key, value) {", "            if(key in this.options) {", "                this.options[key] = value;", "            }", "", "            if(key === 'value') {", "                this.setValue(value);", "            }", "", "            //do not pass option to input as it is passed in editable-element", "        },", "", "        setValue: function(value, convertStr) {", "            if(convertStr) {", "                this.value = this.input.str2value(value);", "            } else {", "                this.value = value;", "            }", "", "            //if form is visible, update input", "            if(this.$form && this.$form.is(':visible')) {", "                this.input.value2input(this.value);", "            }", "        }", "    };", "", "    /*", "    Initialize editableform. Applied to jQuery object.", "", "    @method $().editableform(options)", "    @params {Object} options", "    @example", "    var $form = $('&lt;div&gt;').editableform({", "        type: 'text',", "        name: 'username',", "        url: '/post',", "        value: 'vitaliy'", "    });", "", "    //to display form you should call 'render' method", "    $form.editableform('render');", "    */", "    $.fn.editableform = function (option) {", "        var args = arguments;", "        return this.each(function () {", "            var $this = $(this),", "            data = $this.data('editableform'),", "            options = typeof option === 'object' && option;", "            if (!data) {", "                $this.data('editableform', (data = new EditableForm(this, options)));", "            }", "", "            if (typeof option === 'string') { //call method", "                data[option].apply(data, Array.prototype.slice.call(args, 1));", "            }", "        });", "    };", "", "    //keep link to constructor to allow inheritance", "    $.fn.editableform.Constructor = EditableForm;", "", "    //defaults", "    $.fn.editableform.defaults = {", "        /* see also defaults for input */", "", "        /**", "        Type of input. Can be <code>text|textarea|select|date|checklist</code>", "", "        @property type", "        @type string", "        @default 'text'", "        **/", "        type: 'text',", "        /**", "        Url for submit, e.g. <code>'/post'</code>", "        If function - it will be called instead of ajax. Function should return deferred object to run fail/done callbacks.", "", "        @property url", "        @type string|function", "        @default null", "        @example", "        url: function(params) {", "            var d = new $.Deferred;", "            if(params.value === 'abc') {", "                return d.reject('error message'); //returning error via deferred object", "            } else {", "                //async saving data in js model", "                someModel.asyncSaveMethod({", "                   ...,", "                   success: function(){", "                      d.resolve();", "                   }", "                });", "                return d.promise();", "            }", "        }", "        **/", "        url:null,", "        /**", "        Additional params for submit. If defined as <code>object</code> - it is **appended** to original ajax data (pk, name and value).", "        If defined as <code>function</code> - returned object **overwrites** original ajax data.", "        @example", "        params: function(params) {", "            //originally params contain pk, name and value", "            params.a = 1;", "            return params;", "        }", "", "        @property params", "        @type object|function", "        @default null", "        **/", "        params:null,", "        /**", "        Name of field. Will be submitted on server. Can be taken from <code>id</code> attribute", "", "        @property name", "        @type string", "        @default null", "        **/", "        name: null,", "        /**", "        Primary key of editable object (e.g. record id in database). For composite keys use object, e.g. <code>{id: 1, lang: 'en'}</code>.", "        Can be calculated dynamically via function.", "", "        @property pk", "        @type string|object|function", "        @default null", "        **/", "        pk: null,", "        /**", "        Initial value. If not defined - will be taken from element's content.", "        For __select__ type should be defined (as it is ID of shown text).", "", "        @property value", "        @type string|object", "        @default null", "        **/", "        value: null,", "        /**", "        Value that will be displayed in input if original field value is empty (`null|undefined|''`).", "", "        @property defaultValue", "        @type string|object", "        @default null", "        @since 1.4.6", "        **/", "        defaultValue: null,", "        /**", "        Strategy for sending data on server. Can be `auto|always|never`.", "        When 'auto' data will be sent on server **only if pk and url defined**, otherwise new value will be stored locally.", "", "        @property send", "        @type string", "        @default 'auto'", "        **/", "        send: 'auto',", "        /**", "        Function for client-side validation. If returns string - means validation not passed and string showed as error.", "        Since 1.5.1 you can modify submitted value by returning object from `validate`:", "        `{newValue: '...'}` or `{newValue: '...', msg: '...'}`", "", "        @property validate", "        @type function", "        @default null", "        @example", "        validate: function(value) {", "            if($.trim(value) == '') {", "                return 'This field is required';", "            }", "        }", "        **/", "        validate: null,", "        /**", "        Success callback. Called when value successfully sent on server and **response status = 200**.", "        Usefull to work with json response. For example, if your backend response can be <code>{success: true}</code>", "        or <code>{success: false, msg: \"server error\"}</code> you can check it inside this callback.", "        If it returns **string** - means error occured and string is shown as error message.", "        If it returns **object like** <code>{newValue: &lt;something&gt;}</code> - it overwrites value, submitted by user.", "        Otherwise newValue simply rendered into element.", "", "        @property success", "        @type function", "        @default null", "        @example", "        success: function(response, newValue) {", "            if(!response.success) return response.msg;", "        }", "        **/", "        success: null,", "        /**", "        Error callback. Called when request failed (response status != 200).", "        Usefull when you want to parse error response and display a custom message.", "        Must return **string** - the message to be displayed in the error block.", "", "        @property error", "        @type function", "        @default null", "        @since 1.4.4", "        @example", "        error: function(response, newValue) {", "            if(response.status === 500) {", "                return 'Service unavailable. Please try later.';", "            } else {", "                return response.responseText;", "            }", "        }", "        **/", "        error: null,", "        /**", "        Additional options for submit ajax request.", "        List of values: http://api.jquery.com/jQuery.ajax", "", "        @property ajaxOptions", "        @type object", "        @default null", "        @since 1.1.1", "        @example", "        ajaxOptions: {", "            type: 'put',", "            dataType: 'json'", "        }", "        **/", "        ajaxOptions: null,", "        /**", "        Where to show buttons: left(true)|bottom|false", "        Form without buttons is auto-submitted.", "", "        @property showbuttons", "        @type boolean|string", "        @default true", "        @since 1.1.1", "        **/", "        showbuttons: true,", "        /**", "        Scope for callback methods (success, validate).", "        If <code>null</code> means editableform instance itself.", "", "        @property scope", "        @type DOMElement|object", "        @default null", "        @since 1.2.0", "        @private", "        **/", "        scope: null,", "        /**", "        Whether to save or cancel value when it was not changed but form was submitted", "", "        @property savenochange", "        @type boolean", "        @default false", "        @since 1.2.0", "        **/", "        savenochange: false", "    };", "", "    /*", "    Note: following params could redefined in engine: bootstrap or jqueryui:", "    Classes 'control-group' and 'editable-error-block' must always present!", "    */", "    $.fn.editableform.template = '<form class=\"form-inline editableform\">'+", "    '<div class=\"control-group\">' +", "    '<div><div class=\"editable-input\"></div><div class=\"editable-buttons\"></div></div>'+", "    '<div class=\"editable-error-block\"></div>' +", "    '</div>' +", "    '</form>';", "", "    //loading div", "    $.fn.editableform.loading = '<div class=\"editableform-loading\"></div>';", "", "    //buttons", "    $.fn.editableform.buttons = '<button type=\"submit\" class=\"editable-submit\">ok</button>'+", "    '<button type=\"button\" class=\"editable-cancel\">cancel</button>';", "", "    //error class attached to control-group", "    $.fn.editableform.errorGroupClass = null;", "", "    //error class attached to editable-error-block", "    $.fn.editableform.errorBlockClass = 'editable-error';", "", "    //engine", "    $.fn.editableform.engine = 'jquery';", "}(window.jQuery));", "", "/**", "* EditableForm utilites", "*/", "(function ($) {", "    \"use strict\";", "", "    //utils", "    $.fn.editableutils = {", "        /**", "        * classic JS inheritance function", "        */", "        inherit: function (Child, Parent) {", "            var F = function() { };", "            F.prototype = Parent.prototype;", "            Child.prototype = new F();", "            Child.prototype.constructor = Child;", "            Child.superclass = Parent.prototype;", "        },", "", "        /**", "        * set caret position in input", "        * see http://stackoverflow.com/questions/499126/jquery-set-cursor-position-in-text-area", "        */", "        setCursorPosition: function(elem, pos) {", "            if (elem.setSelectionRange) {", "                elem.setSelectionRange(pos, pos);", "            } else if (elem.createTextRange) {", "                var range = elem.createTextRange();", "                range.collapse(true);", "                range.moveEnd('character', pos);", "                range.moveStart('character', pos);", "                range.select();", "            }", "        },", "", "        /**", "        * function to parse JSON in *single* quotes. (jquery automatically parse only double quotes)", "        * That allows such code as: <a data-source=\"{'a': 'b', 'c': 'd'}\">", "        * safe = true --> means no exception will be thrown", "        * for details see http://stackoverflow.com/questions/7410348/how-to-set-json-format-to-html5-data-attributes-in-the-jquery", "        */", "        tryParseJson: function(s, safe) {", "            if (typeof s === 'string' && s.length && s.match(/^[\\{\\[].*[\\}\\]]$/)) {", "                if (safe) {", "                    try {", "                        /*jslint evil: true*/", "                        s = (new Function('return ' + s))();", "                        /*jslint evil: false*/", "                    } catch (e) {} finally {", "                        return s;", "                    }", "                } else {", "                    /*jslint evil: true*/", "                    s = (new Function('return ' + s))();", "                    /*jslint evil: false*/", "                }", "            }", "            return s;", "        },", "", "        /**", "        * slice object by specified keys", "        */", "        sliceObj: function(obj, keys, caseSensitive /* default: false */) {", "            var key, keyLower, newObj = {};", "", "            if (!$.isArray(keys) || !keys.length) {", "                return newObj;", "            }", "", "            for (var i = 0; i < keys.length; i++) {", "                key = keys[i];", "                if (obj.hasOwnProperty(key)) {", "                    newObj[key] = obj[key];", "                }", "", "                if(caseSensitive === true) {", "                    continue;", "                }", "", "                //when getting data-* attributes via $.data() it's converted to lowercase.", "                //details: http://stackoverflow.com/questions/7602565/using-data-attributes-with-jquery", "                //workaround is code below.", "                keyLower = key.toLowerCase();", "                if (obj.hasOwnProperty(keyLower)) {", "                    newObj[key] = obj[keyLower];", "                }", "            }", "", "            return newObj;", "        },", "", "        /*", "        exclude complex objects from $.data() before pass to config", "        */", "        getConfigData: function($element) {", "            var data = {};", "            $.each($element.data(), function(k, v) {", "                if(typeof v !== 'object' || (v && typeof v === 'object' && (v.constructor === Object || v.constructor === Array))) {", "                    data[k] = v;", "                }", "            });", "            return data;", "        },", "", "        /*", "         returns keys of object", "        */", "        objectKeys: function(o) {", "            if (Object.keys) {", "                return Object.keys(o);", "            } else {", "                if (o !== Object(o)) {", "                    throw new TypeError('Object.keys called on a non-object');", "                }", "                var k=[], p;", "                for (p in o) {", "                    if (Object.prototype.hasOwnProperty.call(o,p)) {", "                        k.push(p);", "                    }", "                }", "                return k;", "            }", "", "        },", "", "       /**", "        method to escape html.", "       **/", "       escape: function(str) {", "           return $('<div>').text(str).html();", "       },", "", "       /*", "        returns array items from sourceData having value property equal or inArray of 'value'", "       */", "       itemsByValue: function(value, sourceData, valueProp) {", "           if(!sourceData || value === null) {", "               return [];", "           }", "", "           if (typeof(valueProp) !== \"function\") {", "               var idKey = valueProp || 'value';", "               valueProp = function (e) { return e[idKey]; };", "           }", "", "           var isValArray = $.isArray(value),", "           result = [],", "           that = this;", "", "           $.each(sourceData, function(i, o) {", "               if(o.children) {", "                   result = result.concat(that.itemsByValue(value, o.children, valueProp));", "               } else {", "                   /*jslint eqeq: true*/", "                   if(isValArray) {", "                       if($.grep(value, function(v){  return v == (o && typeof o === 'object' ? valueProp(o) : o); }).length) {", "                           result.push(o);", "                       }", "                   } else {", "                       var itemValue = (o && (typeof o === 'object')) ? valueProp(o) : o;", "                       if(value == itemValue) {", "                           result.push(o);", "                       }", "                   }", "                   /*jslint eqeq: false*/", "               }", "           });", "", "           return result;", "       },", "", "       /*", "       Returns input by options: type, mode.", "       */", "       createInput: function(options) {", "           var TypeConstructor, typeOptions, input,", "           type = options.type;", "", "           //`date` is some kind of virtual type that is transformed to one of exact types", "           //depending on mode and core lib", "           if(type === 'date') {", "               //inline", "               if(options.mode === 'inline') {", "                   if($.fn.editabletypes.datefield) {", "                       type = 'datefield';", "                   } else if($.fn.editabletypes.dateuifield) {", "                       type = 'dateuifield';", "                   }", "               //popup", "               } else {", "                   if($.fn.editabletypes.date) {", "                       type = 'date';", "                   } else if($.fn.editabletypes.dateui) {", "                       type = 'dateui';", "                   }", "               }", "", "               //if type still `date` and not exist in types, replace with `combodate` that is base input", "               if(type === 'date' && !$.fn.editabletypes.date) {", "                   type = 'combodate';", "               }", "           }", "", "           //`datetime` should be datetimefield in 'inline' mode", "           if(type === 'datetime' && options.mode === 'inline') {", "             type = 'datetimefield';", "           }", "", "           //change wysihtml5 to textarea for jquery UI and plain versions", "           if(type === 'wysihtml5' && !$.fn.editabletypes[type]) {", "               type = 'textarea';", "           }", "", "           //create input of specified type. Input will be used for converting value, not in form", "           if(typeof $.fn.editabletypes[type] === 'function') {", "               TypeConstructor = $.fn.editabletypes[type];", "               typeOptions = this.sliceObj(options, this.objectKeys(TypeConstructor.defaults));", "               input = new TypeConstructor(typeOptions);", "               return input;", "           } else {", "               $.error('Unknown type: '+ type);", "               return false;", "           }", "       },", "", "       //see http://stackoverflow.com/questions/7264899/detect-css-transitions-using-javascript-and-without-modernizr", "       supportsTransitions: function () {", "           var b = document.body || document.documentElement,", "               s = b.style,", "               p = 'transition',", "               v = ['Moz', 'Webkit', 'Khtml', 'O', 'ms'];", "", "           if(typeof s[p] === 'string') {", "               return true;", "           }", "", "           // Tests for vendor specific prop", "           p = p.charAt(0).toUpperCase() + p.substr(1);", "           for(var i=0; i<v.length; i++) {", "               if(typeof s[v[i] + p] === 'string') {", "                   return true;", "               }", "           }", "           return false;", "       }", "", "    };", "}(window.jQuery));", "", "/**", "Attaches stand-alone container with editable-form to HTML element. Element is used only for positioning, value is not stored anywhere.<br>", "This method applied internally in <code>$().editable()</code>. You should subscribe on it's events (save / cancel) to get profit of it.<br>", "Final realization can be different: bootstrap-popover, jqueryui-tooltip, poshytip, inline-div. It depends on which js file you include.<br>", "Applied as jQuery method.", "", "@class editableContainer", "@uses editableform", "**/", "(function ($) {", "    \"use strict\";", "", "    var Popup = function (element, options) {", "        this.init(element, options);", "    };", "", "    var Inline = function (element, options) {", "        this.init(element, options);", "    };", "", "    //methods", "    Popup.prototype = {", "        containerName: null, //method to call container on element", "        containerDataName: null, //object name in element's .data()", "        innerCss: null, //tbd in child class", "        containerClass: 'editable-container editable-popup', //css class applied to container element", "        defaults: {}, //container itself defaults", "", "        init: function(element, options) {", "            this.$element = $(element);", "            //since 1.4.1 container do not use data-* directly as they already merged into options.", "            this.options = $.extend({}, $.fn.editableContainer.defaults, options);", "            this.splitOptions();", "", "            //set scope of form callbacks to element", "            this.formOptions.scope = this.$element[0];", "", "            this.initContainer();", "", "            //flag to hide container, when saving value will finish", "            this.delayedHide = false;", "", "            //bind 'destroyed' listener to destroy container when element is removed from dom", "            this.$element.on('destroyed', $.proxy(function(){", "                this.destroy();", "            }, this));", "", "            //attach document handler to close containers on click / escape", "            if(!$(document).data('editable-handlers-attached')) {", "                //close all on escape", "                $(document).on('keyup.editable', function (e) {", "                    if (e.which === 27) {", "                        $('.editable-open').editableContainer('hide');", "                        //todo: return focus on element", "                    }", "                });", "", "                //close containers when click outside", "                //(mousedown could be better than click, it closes everything also on drag drop)", "                $(document).on('click.editable', function(e) {", "                    var $target = $(e.target), i,", "                        exclude_classes = ['.editable-container',", "                                           '.ui-datepicker-header',", "                                           '.datepicker', //in inline mode datepicker is rendered into body", "                                           '.modal-backdrop',", "                                           '.bootstrap-wysihtml5-insert-image-modal',", "                                           '.bootstrap-wysihtml5-insert-link-modal'", "                                           ];", "", "                    //check if element is detached. It occurs when clicking in bootstrap datepicker", "                    if (!$.contains(document.documentElement, e.target)) {", "                      return;", "                    }", "", "                    //for some reason FF 20 generates extra event (click) in select2 widget with e.target = document", "                    //we need to filter it via construction below. See https://github.com/vitalets/x-editable/issues/199", "                    //Possibly related to http://stackoverflow.com/questions/10119793/why-does-firefox-react-differently-from-webkit-and-ie-to-click-event-on-selec", "                    if($target.is(document)) {", "                       return;", "                    }", "", "                    //if click inside one of exclude classes --> no nothing", "                    for(i=0; i<exclude_classes.length; i++) {", "                         if($target.is(exclude_classes[i]) || $target.parents(exclude_classes[i]).length) {", "                             return;", "                         }", "                    }", "", "                    //close all open containers (except one - target)", "                    Popup.prototype.closeOthers(e.target);", "                });", "", "                $(document).data('editable-handlers-attached', true);", "            }", "        },", "", "        //split options on containerOptions and formOptions", "        splitOptions: function() {", "            this.containerOptions = {};", "            this.formOptions = {};", "", "            if(!$.fn[this.containerName]) {", "                throw new Error(this.containerName + ' not found. Have you included corresponding js file?');", "            }", "", "            //keys defined in container defaults go to container, others go to form", "            for(var k in this.options) {", "              if(k in this.defaults) {", "                 this.containerOptions[k] = this.options[k];", "              } else {", "                 this.formOptions[k] = this.options[k];", "              }", "            }", "        },", "", "        /*", "        Returns jquery object of container", "        @method tip()", "        */", "        tip: function() {", "            return this.container() ? this.container().$tip : null;", "        },", "", "        /* returns container object */", "        container: function() {", "            var container;", "            //first, try get it by `containerDataName`", "            if(this.containerDataName) {", "                if(container = this.$element.data(this.containerDataName)) {", "                    return container;", "                }", "            }", "            //second, try `containerName`", "            container = this.$element.data(this.containerName);", "            return container;", "        },", "", "        /* call native method of underlying container, e.g. this.$element.popover('method') */", "        call: function() {", "            this.$element[this.containerName].apply(this.$element, arguments);", "        },", "", "        initContainer: function(){", "            this.call(this.containerOptions);", "        },", "", "        renderForm: function() {", "            this.$form", "            .editableform(this.formOptions)", "            .on({", "                save: $.proxy(this.save, this), //click on submit button (value changed)", "                nochange: $.proxy(function(){ this.hide('nochange'); }, this), //click on submit button (value NOT changed)", "                cancel: $.proxy(function(){ this.hide('cancel'); }, this), //click on calcel button", "                show: $.proxy(function() {", "                    if(this.delayedHide) {", "                        this.hide(this.delayedHide.reason);", "                        this.delayedHide = false;", "                    } else {", "                        this.setPosition();", "                    }", "                }, this), //re-position container every time form is shown (occurs each time after loading state)", "                rendering: $.proxy(this.setPosition, this), //this allows to place container correctly when loading shown", "                resize: $.proxy(this.setPosition, this), //this allows to re-position container when form size is changed", "                rendered: $.proxy(function(){", "                    /**", "                    Fired when container is shown and form is rendered (for select will wait for loading dropdown options).", "                    **Note:** Bootstrap popover has own `shown` event that now cannot be separated from x-editable's one.", "                    The workaround is to check `arguments.length` that is always `2` for x-editable.", "", "                    @event shown", "                    @param {Object} event event object", "                    @example", "                    $('#username').on('shown', function(e, editable) {", "                        editable.input.$input.val('overwriting value of input..');", "                    });", "                    **/", "                    /*", "                     TODO: added second param mainly to distinguish from bootstrap's shown event. It's a hotfix that will be solved in future versions via namespaced events.", "                    */", "                    this.$element.triggerHandler('shown', $(this.options.scope).data('editable'));", "                }, this)", "            })", "            .editableform('render');", "        },", "", "        /**", "        Shows container with form", "        @method show()", "        @param {boolean} closeAll Whether to close all other editable containers when showing this one. Default true.", "        **/", "        /* Note: poshytip owerwrites this method totally! */", "        show: function (closeAll) {", "            this.$element.addClass('editable-open');", "            if(closeAll !== false) {", "                //close all open containers (except this)", "                this.closeOthers(this.$element[0]);", "            }", "", "            //show container itself", "            this.innerShow();", "            this.tip().addClass(this.containerClass);", "", "            /*", "            Currently, form is re-rendered on every show.", "            The main reason is that we dont know, what will container do with content when closed:", "            remove(), detach() or just hide() - it depends on container.", "", "            Detaching form itself before hide and re-insert before show is good solution,", "            but visually it looks ugly --> container changes size before hide.", "            */", "", "            //if form already exist - delete previous data", "            if(this.$form) {", "                //todo: destroy prev data!", "                //this.$form.destroy();", "            }", "", "            this.$form = $('<div>');", "", "            //insert form into container body", "            if(this.tip().is(this.innerCss)) {", "                //for inline container", "                this.tip().append(this.$form);", "            } else {", "                this.tip().find(this.innerCss).append(this.$form);", "            }", "", "            //render form", "            this.renderForm();", "        },", "", "        /**", "        Hides container with form", "        @method hide()", "        @param {string} reason Reason caused hiding. Can be <code>save|cancel|onblur|nochange|undefined (=manual)</code>", "        **/", "        hide: function(reason) {", "            if(!this.tip() || !this.tip().is(':visible') || !this.$element.hasClass('editable-open')) {", "                return;", "            }", "", "            //if form is saving value, schedule hide", "            if(this.$form.data('editableform').isSaving) {", "                this.delayedHide = {reason: reason};", "                return;", "            } else {", "                this.delayedHide = false;", "            }", "", "            this.$element.removeClass('editable-open');", "            this.innerHide();", "", "            /**", "            Fired when container was hidden. It occurs on both save or cancel.", "            **Note:** Bootstrap popover has own `hidden` event that now cannot be separated from x-editable's one.", "            The workaround is to check `arguments.length` that is always `2` for x-editable.", "", "            @event hidden", "            @param {object} event event object", "            @param {string} reason Reason caused hiding. Can be <code>save|cancel|onblur|nochange|manual</code>", "            @example", "            $('#username').on('hidden', function(e, reason) {", "                if(reason === 'save' || reason === 'cancel') {", "                    //auto-open next editable", "                    $(this).closest('tr').next().find('.editable').editable('show');", "                }", "            });", "            **/", "            this.$element.triggerHandler('hidden', reason || 'manual');", "        },", "", "        /* internal show method. To be overwritten in child classes */", "        innerShow: function () {", "", "        },", "", "        /* internal hide method. To be overwritten in child classes */", "        innerHide: function () {", "", "        },", "", "        /**", "        Toggles container visibility (show / hide)", "        @method toggle()", "        @param {boolean} closeAll Whether to close all other editable containers when showing this one. Default true.", "        **/", "        toggle: function(closeAll) {", "            if(this.container() && this.tip() && this.tip().is(':visible')) {", "                this.hide();", "            } else {", "                this.show(closeAll);", "            }", "        },", "", "        /*", "        Updates the position of container when content changed.", "        @method setPosition()", "        */", "        setPosition: function() {", "            //tbd in child class", "        },", "", "        save: function(e, params) {", "            /**", "            Fired when new value was submitted. You can use <code>$(this).data('editableContainer')</code> inside handler to access to editableContainer instance", "", "            @event save", "            @param {Object} event event object", "            @param {Object} params additional params", "            @param {mixed} params.newValue submitted value", "            @param {Object} params.response ajax response", "            @example", "            $('#username').on('save', function(e, params) {", "                //assuming server response: '{success: true}'", "                var pk = $(this).data('editableContainer').options.pk;", "                if(params.response && params.response.success) {", "                    alert('value: ' + params.newValue + ' with pk: ' + pk + ' saved!');", "                } else {", "                    alert('error!');", "                }", "            });", "            **/", "            this.$element.triggerHandler('save', params);", "", "            //hide must be after trigger, as saving value may require methods of plugin, applied to input", "            this.hide('save');", "        },", "", "        /**", "        Sets new option", "", "        @method option(key, value)", "        @param {string} key", "        @param {mixed} value", "        **/", "        option: function(key, value) {", "            this.options[key] = value;", "            if(key in this.containerOptions) {", "                this.containerOptions[key] = value;", "                this.setContainerOption(key, value);", "            } else {", "                this.formOptions[key] = value;", "                if(this.$form) {", "                    this.$form.editableform('option', key, value);", "                }", "            }", "        },", "", "        setContainerOption: function(key, value) {", "            this.call('option', key, value);", "        },", "", "        /**", "        Destroys the container instance", "        @method destroy()", "        **/", "        destroy: function() {", "            this.hide();", "            this.innerDestroy();", "            this.$element.off('destroyed');", "            this.$element.removeData('editableContainer');", "        },", "", "        /* to be overwritten in child classes */", "        innerDestroy: function() {", "", "        },", "", "        /*", "        Closes other containers except one related to passed element.", "        Other containers can be cancelled or submitted (depends on onblur option)", "        */", "        closeOthers: function(element) {", "            $('.editable-open').each(function(i, el){", "                //do nothing with passed element and it's children", "                if(el === element || $(el).find(element).length) {", "                    return;", "                }", "", "                //otherwise cancel or submit all open containers", "                var $el = $(el),", "                ec = $el.data('editableContainer');", "", "                if(!ec) {", "                    return;", "                }", "", "                if(ec.options.onblur === 'cancel') {", "                    $el.data('editableContainer').hide('onblur');", "                } else if(ec.options.onblur === 'submit') {", "                    $el.data('editableContainer').tip().find('form').submit();", "                }", "            });", "", "        },", "", "        /**", "        Activates input of visible container (e.g. set focus)", "        @method activate()", "        **/", "        activate: function() {", "            if(this.tip && this.tip().is(':visible') && this.$form) {", "               this.$form.data('editableform').input.activate();", "            }", "        }", "", "    };", "", "    /**", "    jQuery method to initialize editableContainer.", "", "    @method $().editableContainer(options)", "    @params {Object} options", "    @example", "    $('#edit').editableContainer({", "        type: 'text',", "        url: '/post',", "        pk: 1,", "        value: 'hello'", "    });", "    **/", "    $.fn.editableContainer = function (option) {", "        var args = arguments;", "        return this.each(function () {", "            var $this = $(this),", "            dataKey = 'editableContainer',", "            data = $this.data(dataKey),", "            options = typeof option === 'object' && option,", "            Constructor = (options.mode === 'inline') ? Inline : Popup;", "", "            if (!data) {", "                $this.data(dataKey, (data = new Constructor(this, options)));", "            }", "", "            if (typeof option === 'string') { //call method", "                data[option].apply(data, Array.prototype.slice.call(args, 1));", "            }", "        });", "    };", "", "    //store constructors", "    $.fn.editableContainer.Popup = Popup;", "    $.fn.editableContainer.Inline = Inline;", "", "    //defaults", "    $.fn.editableContainer.defaults = {", "        /**", "        Initial value of form input", "", "        @property value", "        @type mixed", "        @default null", "        @private", "        **/", "        value: null,", "        /**", "        Placement of container relative to element. Can be <code>top|right|bottom|left</code>. Not used for inline container.", "", "        @property placement", "        @type string", "        @default 'top'", "        **/", "        placement: 'top',", "        /**", "        Whether to hide container on save/cancel.", "", "        @property autohide", "        @type boolean", "        @default true", "        @private", "        **/", "        autohide: true,", "        /**", "        Action when user clicks outside the container. Can be <code>cancel|submit|ignore</code>.", "        Setting <code>ignore</code> allows to have several containers open.", "", "        @property onblur", "        @type string", "        @default 'cancel'", "        @since 1.1.1", "        **/", "        onblur: 'cancel',", "", "        /**", "        Animation speed (inline mode only)", "        @property anim", "        @type string", "        @default false", "        **/", "        anim: false,", "", "        /**", "        Mode of editable, can be `popup` or `inline`", "", "        @property mode", "        @type string", "        @default 'popup'", "        @since 1.4.0", "        **/", "        mode: 'popup'", "    };", "", "    /*", "    * workaround to have 'destroyed' event to destroy popover when element is destroyed", "    * see http://stackoverflow.com/questions/2200494/jquery-trigger-event-when-an-element-is-removed-from-the-dom", "    */", "    jQuery.event.special.destroyed = {", "        remove: function(o) {", "            if (o.handler) {", "                o.handler();", "            }", "        }", "    };", "", "}(window.jQuery));", "", "/**", "* Editable Inline", "* ---------------------", "*/", "(function ($) {", "    \"use strict\";", "", "    //copy prototype from EditableContainer", "    //extend methods", "    $.extend($.fn.editableContainer.Inline.prototype, $.fn.editableContainer.Popup.prototype, {", "        containerName: 'editableform',", "        innerCss: '.editable-inline',", "        containerClass: 'editable-container editable-inline', //css class applied to container element", "", "        initContainer: function(){", "            //container is <span> element", "            this.$tip = $('<span></span>');", "", "            //convert anim to miliseconds (int)", "            if(!this.options.anim) {", "                this.options.anim = 0;", "            }", "        },", "", "        splitOptions: function() {", "            //all options are passed to form", "            this.containerOptions = {};", "            this.formOptions = this.options;", "        },", "", "        tip: function() {", "           return this.$tip;", "        },", "", "        innerShow: function () {", "            this.$element.hide();", "            this.tip().insertAfter(this.$element).show();", "        },", "", "        innerHide: function () {", "            this.$tip.hide(this.options.anim, $.proxy(function() {", "                this.$element.show();", "                this.innerDestroy();", "            }, this));", "        },", "", "        innerDestroy: function() {", "            if(this.tip()) {", "                this.tip().empty().remove();", "            }", "        }", "    });", "", "}(window.jQuery));", "/**", "Makes editable any HTML element on the page. Applied as jQuery method.", "", "@class editable", "@uses editableContainer", "**/", "(function ($) {", "    \"use strict\";", "", "    var Editable = function (element, options) {", "        this.$element = $(element);", "        //data-* has more priority over js options: because dynamically created elements may change data-*", "        this.options = $.extend({}, $.fn.editable.defaults, options, $.fn.editableutils.getConfigData(this.$element));", "        if(this.options.selector) {", "            this.initLive();", "        } else {", "            this.init();", "        }", "", "        //check for transition support", "        if(this.options.highlight && !$.fn.editableutils.supportsTransitions()) {", "            this.options.highlight = false;", "        }", "    };", "", "    Editable.prototype = {", "        constructor: Editable,", "        init: function () {", "            var isValueByText = false,", "                doAutotext, finalize;", "", "            //name", "            this.options.name = this.options.name || this.$element.attr('id');", "", "            //create input of specified type. Input needed already here to convert value for initial display (e.g. show text by id for select)", "            //also we set scope option to have access to element inside input specific callbacks (e. g. source as function)", "            this.options.scope = this.$element[0];", "            this.input = $.fn.editableutils.createInput(this.options);", "            if(!this.input) {", "                return;", "            }", "", "            //set value from settings or by element's text", "            if (this.options.value === undefined || this.options.value === null) {", "                this.value = this.input.html2value($.trim(this.$element.html()));", "                isValueByText = true;", "            } else {", "                /*", "                  value can be string when received from 'data-value' attribute", "                  for complext objects value can be set as json string in data-value attribute,", "                  e.g. data-value=\"{city: 'Moscow', street: 'Lenina'}\"", "                */", "                this.options.value = $.fn.editableutils.tryParseJson(this.options.value, true);", "                if(typeof this.options.value === 'string') {", "                    this.value = this.input.str2value(this.options.value);", "                } else {", "                    this.value = this.options.value;", "                }", "            }", "", "            //add 'editable' class to every editable element", "            this.$element.addClass('editable');", "", "            //specifically for \"textarea\" add class .editable-pre-wrapped to keep linebreaks", "            if(this.input.type === 'textarea') {", "                this.$element.addClass('editable-pre-wrapped');", "            }", "", "            //attach handler activating editable. In disabled mode it just prevent default action (useful for links)", "            if(this.options.toggle !== 'manual') {", "                this.$element.addClass('editable-click');", "                this.$element.on(this.options.toggle + '.editable', $.proxy(function(e){", "                    //prevent following link if editable enabled", "                    if(!this.options.disabled) {", "                        e.preventDefault();", "                    }", "", "                    //stop propagation not required because in document click handler it checks event target", "                    //e.stopPropagation();", "", "                    if(this.options.toggle === 'mouseenter') {", "                        //for hover only show container", "                        this.show();", "                    } else {", "                        //when toggle='click' we should not close all other containers as they will be closed automatically in document click listener", "                        var closeAll = (this.options.toggle !== 'click');", "                        this.toggle(closeAll);", "                    }", "                }, this));", "            } else {", "                this.$element.attr('tabindex', -1); //do not stop focus on element when toggled manually", "            }", "", "            //if display is function it's far more convinient to have autotext = always to render correctly on init", "            //see https://github.com/vitalets/x-editable-yii/issues/34", "            if(typeof this.options.display === 'function') {", "                this.options.autotext = 'always';", "            }", "", "            //check conditions for autotext:", "            switch(this.options.autotext) {", "              case 'always':", "               doAutotext = true;", "              break;", "              case 'auto':", "                //if element text is empty and value is defined and value not generated by text --> run autotext", "                doAutotext = !$.trim(this.$element.text()).length && this.value !== null && this.value !== undefined && !isValueByText;", "              break;", "              default:", "               doAutotext = false;", "            }", "", "            //depending on autotext run render() or just finilize init", "            $.when(doAutotext ? this.render() : true).then($.proxy(function() {", "                if(this.options.disabled) {", "                    this.disable();", "                } else {", "                    this.enable();", "                }", "               /**", "               Fired when element was initialized by `$().editable()` method.", "               Please note that you should setup `init` handler **before** applying `editable`.", "", "               @event init", "               @param {Object} event event object", "               @param {Object} editable editable instance (as here it cannot accessed via data('editable'))", "               @since 1.2.0", "               @example", "               $('#username').on('init', function(e, editable) {", "                   alert('initialized ' + editable.options.name);", "               });", "               $('#username').editable();", "               **/", "                this.$element.triggerHandler('init', this);", "            }, this));", "        },", "", "        /*", "         Initializes parent element for live editables", "        */", "        initLive: function() {", "           //store selector", "           var selector = this.options.selector;", "           //modify options for child elements", "           this.options.selector = false;", "           this.options.autotext = 'never';", "           //listen toggle events", "           this.$element.on(this.options.toggle + '.editable', selector, $.proxy(function(e){", "               var $target = $(e.target);", "               if(!$target.data('editable')) {", "                   //if delegated element initially empty, we need to clear it's text (that was manually set to `empty` by user)", "                   //see https://github.com/vitalets/x-editable/issues/137", "                   if($target.hasClass(this.options.emptyclass)) {", "                      $target.empty();", "                   }", "                   $target.editable(this.options).trigger(e);", "               }", "           }, this));", "        },", "", "        /*", "        Renders value into element's text.", "        Can call custom display method from options.", "        Can return deferred object.", "        @method render()", "        @param {mixed} response server response (if exist) to pass into display function", "        */", "        render: function(response) {", "            //do not display anything", "            if(this.options.display === false) {", "                return;", "            }", "", "            //if input has `value2htmlFinal` method, we pass callback in third param to be called when source is loaded", "            if(this.input.value2htmlFinal) {", "                return this.input.value2html(this.value, this.$element[0], this.options.display, response);", "            //if display method defined --> use it", "            } else if(typeof this.options.display === 'function') {", "                return this.options.display.call(this.$element[0], this.value, response);", "            //else use input's original value2html() method", "            } else {", "                return this.input.value2html(this.value, this.$element[0]);", "            }", "        },", "", "        /**", "        Enables editable", "        @method enable()", "        **/", "        enable: function() {", "            this.options.disabled = false;", "            this.$element.removeClass('editable-disabled');", "            this.handleEmpty(this.isEmpty);", "            if(this.options.toggle !== 'manual') {", "                if(this.$element.attr('tabindex') === '-1') {", "                    this.$element.removeAttr('tabindex');", "                }", "            }", "        },", "", "        /**", "        Disables editable", "        @method disable()", "        **/", "        disable: function() {", "            this.options.disabled = true;", "            this.hide();", "            this.$element.addClass('editable-disabled');", "            this.handleEmpty(this.isEmpty);", "            //do not stop focus on this element", "            this.$element.attr('tabindex', -1);", "        },", "", "        /**", "        Toggles enabled / disabled state of editable element", "        @method toggleDisabled()", "        **/", "        toggleDisabled: function() {", "            if(this.options.disabled) {", "                this.enable();", "            } else {", "                this.disable();", "            }", "        },", "", "        /**", "        Sets new option", "", "        @method option(key, value)", "        @param {string|object} key option name or object with several options", "        @param {mixed} value option new value", "        @example", "        $('.editable').editable('option', 'pk', 2);", "        **/", "        option: function(key, value) {", "            //set option(s) by object", "            if(key && typeof key === 'object') {", "               $.each(key, $.proxy(function(k, v){", "                  this.option($.trim(k), v);", "               }, this));", "               return;", "            }", "", "            //set option by string", "            this.options[key] = value;", "", "            //disabled", "            if(key === 'disabled') {", "               return value ? this.disable() : this.enable();", "            }", "", "            //value", "            if(key === 'value') {", "                this.setValue(value);", "            }", "", "            //transfer new option to container!", "            if(this.container) {", "                this.container.option(key, value);", "            }", "", "            //pass option to input directly (as it points to the same in form)", "            if(this.input.option) {", "                this.input.option(key, value);", "            }", "", "        },", "", "        /*", "        * set emptytext if element is empty", "        */", "        handleEmpty: function (isEmpty) {", "            //do not handle empty if we do not display anything", "            if(this.options.display === false) {", "                return;", "            }", "", "            /*", "            isEmpty may be set directly as param of method.", "            It is required when we enable/disable field and can't rely on content", "            as node content is text: \"Empty\" that is not empty %)", "            */", "            if(isEmpty !== undefined) {", "                this.isEmpty = isEmpty;", "            } else {", "                //detect empty", "                //for some inputs we need more smart check", "                //e.g. wysihtml5 may have <br>, <p></p>, <img>", "                if(typeof(this.input.isEmpty) === 'function') {", "                    this.isEmpty = this.input.isEmpty(this.$element);", "                } else {", "                    this.isEmpty = $.trim(this.$element.html()) === '';", "                }", "            }", "", "            //emptytext shown only for enabled", "            if(!this.options.disabled) {", "                if (this.isEmpty) {", "                    this.$element.html(this.options.emptytext);", "                    if(this.options.emptyclass) {", "                        this.$element.addClass(this.options.emptyclass);", "                    }", "                } else if(this.options.emptyclass) {", "                    this.$element.removeClass(this.options.emptyclass);", "                }", "            } else {", "                //below required if element disable property was changed", "                if(this.isEmpty) {", "                    this.$element.empty();", "                    if(this.options.emptyclass) {", "                        this.$element.removeClass(this.options.emptyclass);", "                    }", "                }", "            }", "        },", "", "        /**", "        Shows container with form", "        @method show()", "        @param {boolean} closeAll Whether to close all other editable containers when showing this one. Default true.", "        **/", "        show: function (closeAll) {", "            if(this.options.disabled) {", "                return;", "            }", "", "            //init editableContainer: popover, tooltip, inline, etc..", "            if(!this.container) {", "                var containerOptions = $.extend({}, this.options, {", "                    value: this.value,", "                    input: this.input //pass input to form (as it is already created)", "                });", "                this.$element.editableContainer(containerOptions);", "                //listen `save` event", "                this.$element.on(\"save.internal\", $.proxy(this.save, this));", "                this.container = this.$element.data('editableContainer');", "            } else if(this.container.tip().is(':visible')) {", "                return;", "            }", "", "            //show container", "            this.container.show(closeAll);", "        },", "", "        /**", "        Hides container with form", "        @method hide()", "        **/", "        hide: function () {", "            if(this.container) {", "                this.container.hide();", "            }", "        },", "", "        /**", "        Toggles container visibility (show / hide)", "        @method toggle()", "        @param {boolean} closeAll Whether to close all other editable containers when showing this one. Default true.", "        **/", "        toggle: function(closeAll) {", "            if(this.container && this.container.tip().is(':visible')) {", "                this.hide();", "            } else {", "                this.show(closeAll);", "            }", "        },", "", "        /*", "        * called when form was submitted", "        */", "        save: function(e, params) {", "            //mark element with unsaved class if needed", "            if(this.options.unsavedclass) {", "                /*", "                 Add unsaved css to element if:", "                  - url is not user's function", "                  - value was not sent to server", "                  - params.response === undefined, that means data was not sent", "                  - value changed", "                */", "                var sent = false;", "                sent = sent || typeof this.options.url === 'function';", "                sent = sent || this.options.display === false;", "                sent = sent || params.response !== undefined;", "                sent = sent || (this.options.savenochange && this.input.value2str(this.value) !== this.input.value2str(params.newValue));", "", "                if(sent) {", "                    this.$element.removeClass(this.options.unsavedclass);", "                } else {", "                    this.$element.addClass(this.options.unsavedclass);", "                }", "            }", "", "            //highlight when saving", "            if(this.options.highlight) {", "                var $e = this.$element,", "                    bgColor = $e.css('background-color');", "", "                $e.css('background-color', this.options.highlight);", "                setTimeout(function(){", "                    if(bgColor === 'transparent') {", "                        bgColor = '';", "                    }", "                    $e.css('background-color', bgColor);", "                    $e.addClass('editable-bg-transition');", "                    setTimeout(function(){", "                       $e.removeClass('editable-bg-transition');", "                    }, 1700);", "                }, 10);", "            }", "", "            //set new value", "            this.setValue(params.newValue, false, params.response);", "", "            /**", "            Fired when new value was submitted. You can use <code>$(this).data('editable')</code> to access to editable instance", "", "            @event save", "            @param {Object} event event object", "            @param {Object} params additional params", "            @param {mixed} params.newValue submitted value", "            @param {Object} params.response ajax response", "            @example", "            $('#username').on('save', function(e, params) {", "                alert('Saved value: ' + params.newValue);", "            });", "            **/", "            //event itself is triggered by editableContainer. Description here is only for documentation", "        },", "", "        validate: function () {", "            if (typeof this.options.validate === 'function') {", "                return this.options.validate.call(this, this.value);", "            }", "        },", "", "        /**", "        Sets new value of editable", "        @method setValue(value, convertStr)", "        @param {mixed} value new value", "        @param {boolean} convertStr whether to convert value from string to internal format", "        **/", "        setValue: function(value, convertStr, response) {", "            if(convertStr) {", "                this.value = this.input.str2value(value);", "            } else {", "                this.value = value;", "            }", "            if(this.container) {", "                this.container.option('value', this.value);", "            }", "            $.when(this.render(response))", "            .then($.proxy(function() {", "                this.handleEmpty();", "            }, this));", "        },", "", "        /**", "        Activates input of visible container (e.g. set focus)", "        @method activate()", "        **/", "        activate: function() {", "            if(this.container) {", "               this.container.activate();", "            }", "        },", "", "        /**", "        Removes editable feature from element", "        @method destroy()", "        **/", "        destroy: function() {", "            this.disable();", "", "            if(this.container) {", "               this.container.destroy();", "            }", "", "            this.input.destroy();", "", "            if(this.options.toggle !== 'manual') {", "                this.$element.removeClass('editable-click');", "                this.$element.off(this.options.toggle + '.editable');", "            }", "", "            this.$element.off(\"save.internal\");", "", "            this.$element.removeClass('editable editable-open editable-disabled');", "            this.$element.removeData('editable');", "        }", "    };", "", "    /* EDITABLE PLUGIN DEFINITION", "    * ======================= */", "", "    /**", "    jQuery method to initialize editable element.", "", "    @method $().editable(options)", "    @params {Object} options", "    @example", "    $('#username').editable({", "        type: 'text',", "        url: '/post',", "        pk: 1", "    });", "    **/", "    $.fn.editable = function (option) {", "        //special API methods returning non-jquery object", "        var result = {}, args = arguments, datakey = 'editable';", "        switch (option) {", "            /**", "            Runs client-side validation for all matched editables", "", "            @method validate()", "            @returns {Object} validation errors map", "            @example", "            $('#username, #fullname').editable('validate');", "            // possible result:", "            {", "              username: \"username is required\",", "              fullname: \"fullname should be minimum 3 letters length\"", "            }", "            **/", "            case 'validate':", "                this.each(function () {", "                    var $this = $(this), data = $this.data(datakey), error;", "                    if (data && (error = data.validate())) {", "                        result[data.options.name] = error;", "                    }", "                });", "            return result;", "", "            /**", "            Returns current values of editable elements.", "            Note that it returns an **object** with name-value pairs, not a value itself. It allows to get data from several elements.", "            If value of some editable is `null` or `undefined` it is excluded from result object.", "            When param `isSingle` is set to **true** - it is supposed you have single element and will return value of editable instead of object.", "", "            @method getValue()", "            @param {bool} isSingle whether to return just value of single element", "            @returns {Object} object of element names and values", "            @example", "            $('#username, #fullname').editable('getValue');", "            //result:", "            {", "            username: \"superuser\",", "            fullname: \"John\"", "            }", "            //isSingle = true", "            $('#username').editable('getValue', true);", "            //result \"superuser\"", "            **/", "            case 'getValue':", "                if(arguments.length === 2 && arguments[1] === true) { //isSingle = true", "                    result = this.eq(0).data(datakey).value;", "                } else {", "                    this.each(function () {", "                        var $this = $(this), data = $this.data(datakey);", "                        if (data && data.value !== undefined && data.value !== null) {", "                            result[data.options.name] = data.input.value2submit(data.value);", "                        }", "                    });", "                }", "            return result;", "", "            /**", "            This method collects values from several editable elements and submit them all to server.", "            Internally it runs client-side validation for all fields and submits only in case of success.", "            See <a href=\"#newrecord\">creating new records</a> for details.", "            Since 1.5.1 `submit` can be applied to single element to send data programmatically. In that case", "            `url`, `success` and `error` is taken from initial options and you can just call `$('#username').editable('submit')`.", "", "            @method submit(options)", "            @param {object} options", "            @param {object} options.url url to submit data", "            @param {object} options.data additional data to submit", "            @param {object} options.ajaxOptions additional ajax options", "            @param {function} options.error(obj) error handler", "            @param {function} options.success(obj,config) success handler", "            @returns {Object} jQuery object", "            **/", "            case 'submit':  //collects value, validate and submit to server for creating new record", "                var config = arguments[1] || {},", "                $elems = this,", "                errors = this.editable('validate');", "", "                // validation ok", "                if($.isEmptyObject(errors)) {", "                    var ajaxOptions = {};", "", "                    // for single element use url, success etc from options", "                    if($elems.length === 1) {", "                        var editable = $elems.data('editable');", "                        //standard params", "                        var params = {", "                            name: editable.options.name || '',", "                            value: editable.input.value2submit(editable.value),", "                            pk: (typeof editable.options.pk === 'function') ?", "                                editable.options.pk.call(editable.options.scope) :", "                                editable.options.pk", "                        };", "", "                        //additional params", "                        if(typeof editable.options.params === 'function') {", "                            params = editable.options.params.call(editable.options.scope, params);", "                        } else {", "                            //try parse json in single quotes (from data-params attribute)", "                            editable.options.params = $.fn.editableutils.tryParseJson(editable.options.params, true);", "                            $.extend(params, editable.options.params);", "                        }", "", "                        ajaxOptions = {", "                            url: editable.options.url,", "                            data: params,", "                            type: 'POST'", "                        };", "", "                        // use success / error from options", "                        config.success = config.success || editable.options.success;", "                        config.error = config.error || editable.options.error;", "", "                    // multiple elements", "                    } else {", "                        var values = this.editable('getValue');", "", "                        ajaxOptions = {", "                            url: config.url,", "                            data: values,", "                            type: 'POST'", "                        };", "                    }", "", "                    // ajax success callabck (response 200 OK)", "                    ajaxOptions.success = typeof config.success === 'function' ? function(response) {", "                            config.success.call($elems, response, config);", "                        } : $.noop;", "", "                    // ajax error callabck", "                    ajaxOptions.error = typeof config.error === 'function' ? function() {", "                             config.error.apply($elems, arguments);", "                        } : $.noop;", "", "                    // extend ajaxOptions", "                    if(config.ajaxOptions) {", "                        $.extend(ajaxOptions, config.ajaxOptions);", "                    }", "", "                    // extra data", "                    if(config.data) {", "                        $.extend(ajaxOptions.data, config.data);", "                    }", "", "                    // perform ajax request", "                    $.ajax(ajaxOptions);", "                } else { //client-side validation error", "                    if(typeof config.error === 'function') {", "                        config.error.call($elems, errors);", "                    }", "                }", "            return this;", "        }", "", "        //return jquery object", "        return this.each(function () {", "            var $this = $(this),", "                data = $this.data(datakey),", "                options = typeof option === 'object' && option;", "", "            //for delegated targets do not store `editable` object for element", "            //it's allows several different selectors.", "            //see: https://github.com/vitalets/x-editable/issues/312", "            if(options && options.selector) {", "                data = new Editable(this, options);", "                return;", "            }", "", "            if (!data) {", "                $this.data(datakey, (data = new Editable(this, options)));", "            }", "", "            if (typeof option === 'string') { //call method", "                data[option].apply(data, Array.prototype.slice.call(args, 1));", "            }", "        });", "    };", "", "", "    $.fn.editable.defaults = {", "        /**", "        Type of input. Can be <code>text|textarea|select|date|checklist</code> and more", "", "        @property type", "        @type string", "        @default 'text'", "        **/", "        type: 'text',", "        /**", "        Sets disabled state of editable", "", "        @property disabled", "        @type boolean", "        @default false", "        **/", "        disabled: false,", "        /**", "        How to toggle editable. Can be <code>click|dblclick|mouseenter|manual</code>.", "        When set to <code>manual</code> you should manually call <code>show/hide</code> methods of editable.", "        **Note**: if you call <code>show</code> or <code>toggle</code> inside **click** handler of some DOM element,", "        you need to apply <code>e.stopPropagation()</code> because containers are being closed on any click on document.", "", "        @example", "        $('#edit-button').click(function(e) {", "            e.stopPropagation();", "            $('#username').editable('toggle');", "        });", "", "        @property toggle", "        @type string", "        @default 'click'", "        **/", "        toggle: 'click',", "        /**", "        Text shown when element is empty.", "", "        @property emptytext", "        @type string", "        @default 'Empty'", "        **/", "        emptytext: 'Empty',", "        /**", "        Allows to automatically set element's text based on it's value. Can be <code>auto|always|never</code>. Useful for select and date.", "        For example, if dropdown list is <code>{1: 'a', 2: 'b'}</code> and element's value set to <code>1</code>, it's html will be automatically set to <code>'a'</code>.", "        <code>auto</code> - text will be automatically set only if element is empty.", "        <code>always|never</code> - always(never) try to set element's text.", "", "        @property autotext", "        @type string", "        @default 'auto'", "        **/", "        autotext: 'auto',", "        /**", "        Initial value of input. If not set, taken from element's text.", "        Note, that if element's text is empty - text is automatically generated from value and can be customized (see `autotext` option).", "        For example, to display currency sign:", "        @example", "        <a id=\"price\" data-type=\"text\" data-value=\"100\"></a>", "        <script>", "        $('#price').editable({", "            ...", "            display: function(value) {", "              $(this).text(value + '$');", "            }", "        })", "        </script>", "", "        @property value", "        @type mixed", "        @default element's text", "        **/", "        value: null,", "        /**", "        Callback to perform custom displaying of value in element's text.", "        If `null`, default input's display used.", "        If `false`, no displaying methods will be called, element's text will never change.", "        Runs under element's scope.", "        _**Parameters:**_", "", "        * `value` current value to be displayed", "        * `response` server response (if display called after ajax submit), since 1.4.0", "", "        For _inputs with source_ (select, checklist) parameters are different:", "", "        * `value` current value to be displayed", "        * `sourceData` array of items for current input (e.g. dropdown items)", "        * `response` server response (if display called after ajax submit), since 1.4.0", "", "        To get currently selected items use `$.fn.editableutils.itemsByValue(value, sourceData)`.", "", "        @property display", "        @type function|boolean", "        @default null", "        @since 1.2.0", "        @example", "        display: function(value, sourceData) {", "           //display checklist as comma-separated values", "           var html = [],", "               checked = $.fn.editableutils.itemsByValue(value, sourceData);", "", "           if(checked.length) {", "               $.each(checked, function(i, v) { html.push($.fn.editableutils.escape(v.text)); });", "               $(this).html(html.join(', '));", "           } else {", "               $(this).empty();", "           }", "        }", "        **/", "        display: null,", "        /**", "        Css class applied when editable text is empty.", "", "        @property emptyclass", "        @type string", "        @since 1.4.1", "        @default editable-empty", "        **/", "        emptyclass: 'editable-empty',", "        /**", "        Css class applied when value was stored but not sent to server (`pk` is empty or `send = 'never'`).", "        You may set it to `null` if you work with editables locally and submit them together.", "", "        @property unsavedclass", "        @type string", "        @since 1.4.1", "        @default editable-unsaved", "        **/", "        unsavedclass: 'editable-unsaved',", "        /**", "        If selector is provided, editable will be delegated to the specified targets.", "        Usefull for dynamically generated DOM elements.", "        **Please note**, that delegated targets can't be initialized with `emptytext` and `autotext` options,", "        as they actually become editable only after first click.", "        You should manually set class `editable-click` to these elements.", "        Also, if element originally empty you should add class `editable-empty`, set `data-value=\"\"` and write emptytext into element:", "", "        @property selector", "        @type string", "        @since 1.4.1", "        @default null", "        @example", "        <div id=\"user\">", "          <!-- empty -->", "          <a href=\"#\" data-name=\"username\" data-type=\"text\" class=\"editable-click editable-empty\" data-value=\"\" title=\"Username\">Empty</a>", "          <!-- non-empty -->", "          <a href=\"#\" data-name=\"group\" data-type=\"select\" data-source=\"/groups\" data-value=\"1\" class=\"editable-click\" title=\"Group\">Operator</a>", "        </div>", "", "        <script>", "        $('#user').editable({", "            selector: 'a',", "            url: '/post',", "            pk: 1", "        });", "        </script>", "        **/", "        selector: null,", "        /**", "        Color used to highlight element after update. Implemented via CSS3 transition, works in modern browsers.", "", "        @property highlight", "        @type string|boolean", "        @since 1.4.5", "        @default #FFFF80", "        **/", "        highlight: '#FFFF80'", "    };", "", "}(window.jQuery));", "", "/**", "AbstractInput - base class for all editable inputs.", "It defines interface to be implemented by any input type.", "To create your own input you can inherit from this class.", "", "@class abstractinput", "**/", "(function ($) {", "    \"use strict\";", "", "    //types", "    $.fn.editabletypes = {};", "", "    var AbstractInput = function () { };", "", "    AbstractInput.prototype = {", "       /**", "        Initializes input", "", "        @method init()", "        **/", "       init: function(type, options, defaults) {", "           this.type = type;", "           this.options = $.extend({}, defaults, options);", "       },", "", "       /*", "       this method called before render to init $tpl that is inserted in DOM", "       */", "       prerender: function() {", "           this.$tpl = $(this.options.tpl); //whole tpl as jquery object", "           this.$input = this.$tpl;         //control itself, can be changed in render method", "           this.$clear = null;              //clear button", "           this.error = null;               //error message, if input cannot be rendered", "       },", "", "       /**", "        Renders input from tpl. Can return jQuery deferred object.", "        Can be overwritten in child objects", "", "        @method render()", "       **/", "       render: function() {", "", "       },", "", "       /**", "        Sets element's html by value.", "", "        @method value2html(value, element)", "        @param {mixed} value", "        @param {DOMElement} element", "       **/", "       value2html: function(value, element) {", "           $(element)[this.options.escape ? 'text' : 'html']($.trim(value));", "       },", "", "       /**", "        Converts element's html to value", "", "        @method html2value(html)", "        @param {string} html", "        @returns {mixed}", "       **/", "       html2value: function(html) {", "           return $('<div>').html(html).text();", "       },", "", "       /**", "        Converts value to string (for internal compare). For submitting to server used value2submit().", "", "        @method value2str(value)", "        @param {mixed} value", "        @returns {string}", "       **/", "       value2str: function(value) {", "           return value;", "       },", "", "       /**", "        Converts string received from server into value. Usually from `data-value` attribute.", "", "        @method str2value(str)", "        @param {string} str", "        @returns {mixed}", "       **/", "       str2value: function(str) {", "           return str;", "       },", "", "       /**", "        Converts value for submitting to server. Result can be string or object.", "", "        @method value2submit(value)", "        @param {mixed} value", "        @returns {mixed}", "       **/", "       value2submit: function(value) {", "           return value;", "       },", "", "       /**", "        Sets value of input.", "", "        @method value2input(value)", "        @param {mixed} value", "       **/", "       value2input: function(value) {", "           this.$input.val(value);", "       },", "", "       /**", "        Returns value of input. Value can be object (e.g. datepicker)", "", "        @method input2value()", "       **/", "       input2value: function() {", "           return this.$input.val();", "       },", "", "       /**", "        Activates input. For text it sets focus.", "", "        @method activate()", "       **/", "       activate: function() {", "           if(this.$input.is(':visible')) {", "               this.$input.focus();", "           }", "       },", "", "       /**", "        Creates input.", "", "        @method clear()", "       **/", "       clear: function() {", "           this.$input.val(null);", "       },", "", "       /**", "        method to escape html.", "       **/", "       escape: function(str) {", "           return $('<div>').text(str).html();", "       },", "", "       /**", "        attach handler to automatically submit form when value changed (useful when buttons not shown)", "       **/", "       autosubmit: function() {", "", "       },", "", "       /**", "       Additional actions when destroying element", "       **/", "       destroy: function() {", "       },", "", "       // -------- helper functions --------", "       setClass: function() {", "           if(this.options.inputclass) {", "               this.$input.addClass(this.options.inputclass);", "           }", "       },", "", "       setAttr: function(attr) {", "           if (this.options[attr] !== undefined && this.options[attr] !== null) {", "               this.$input.attr(attr, this.options[attr]);", "           }", "       },", "", "       option: function(key, value) {", "            this.options[key] = value;", "       }", "", "    };", "", "    AbstractInput.defaults = {", "        /**", "        HTML template of input. Normally you should not change it.", "", "        @property tpl", "        @type string", "        @default ''", "        **/", "        tpl: '',", "        /**", "        CSS class automatically applied to input", "", "        @property inputclass", "        @type string", "        @default null", "        **/", "        inputclass: null,", "", "        /**", "        If `true` - html will be escaped in content of element via $.text() method.", "        If `false` - html will not be escaped, $.html() used.", "        When you use own `display` function, this option obviosly has no effect.", "", "        @property escape", "        @type boolean", "        @since 1.5.0", "        @default true", "        **/", "        escape: true,", "", "        //scope for external methods (e.g. source defined as function)", "        //for internal use only", "        scope: null,", "", "        //need to re-declare showbuttons here to get it's value from common config (passed only options existing in defaults)", "        showbuttons: true", "    };", "", "    $.extend($.fn.editabletypes, {abstractinput: AbstractInput});", "", "}(window.jQuery));", "", "/**", "List - abstract class for inputs that have source option loaded from js array or via ajax", "", "@class list", "@extends abstractinput", "**/", "(function ($) {", "    \"use strict\";", "", "    var List = function (options) {", "", "    };", "", "    $.fn.editableutils.inherit(List, $.fn.editabletypes.abstractinput);", "", "    $.extend(List.prototype, {", "        render: function () {", "            var deferred = $.Deferred();", "", "            this.error = null;", "            this.onSourceReady(function () {", "                this.renderList();", "                deferred.resolve();", "            }, function () {", "                this.error = this.options.sourceError;", "                deferred.resolve();", "            });", "", "            return deferred.promise();", "        },", "", "        html2value: function (html) {", "            return null; //can't set value by text", "        },", "", "        value2html: function (value, element, display, response) {", "            var deferred = $.Deferred(),", "                success = function () {", "                    if(typeof display === 'function') {", "                        //custom display method", "                        display.call(element, value, this.sourceData, response);", "                    } else {", "                        this.value2htmlFinal(value, element);", "                    }", "                    deferred.resolve();", "               };", "", "            //for null value just call success without loading source", "            if(value === null) {", "               success.call(this);", "            } else {", "               this.onSourceReady(success, function () { deferred.resolve(); });", "            }", "", "            return deferred.promise();", "        },", "", "        // ------------- additional functions ------------", "", "        onSourceReady: function (success, error) {", "            //run source if it function", "            var source;", "            if ($.isFunction(this.options.source)) {", "                source = this.options.source.call(this.options.scope);", "                this.sourceData = null;", "                //note: if function returns the same source as URL - sourceData will be taken from cahce and no extra request performed", "            } else {", "                source = this.options.source;", "            }", "", "            //if allready loaded just call success", "            if(this.options.sourceCache && $.isArray(this.sourceData)) {", "                success.call(this);", "                return;", "            }", "", "            //try parse json in single quotes (for double quotes jquery does automatically)", "            try {", "                source = $.fn.editableutils.tryParseJson(source, false);", "            } catch (e) {", "                error.call(this);", "                return;", "            }", "", "            //loading from url", "            if (typeof source === 'string') {", "                //try to get sourceData from cache", "                if(this.options.sourceCache) {", "                    var cacheID = source,", "                    cache;", "", "                    if (!$(document).data(cacheID)) {", "                        $(document).data(cacheID, {});", "                    }", "                    cache = $(document).data(cacheID);", "", "                    //check for cached data", "                    if (cache.loading === false && cache.sourceData) { //take source from cache", "                        this.sourceData = cache.sourceData;", "                        this.doPrepend();", "                        success.call(this);", "                        return;", "                    } else if (cache.loading === true) { //cache is loading, put callback in stack to be called later", "                        cache.callbacks.push($.proxy(function () {", "                            this.sourceData = cache.sourceData;", "                            this.doPrepend();", "                            success.call(this);", "                        }, this));", "", "                        //also collecting error callbacks", "                        cache.err_callbacks.push($.proxy(error, this));", "                        return;", "                    } else { //no cache yet, activate it", "                        cache.loading = true;", "                        cache.callbacks = [];", "                        cache.err_callbacks = [];", "                    }", "                }", "", "                //ajaxOptions for source. Can be overwritten bt options.sourceOptions", "                var ajaxOptions = $.extend({", "                    url: source,", "                    type: 'get',", "                    cache: false,", "                    dataType: 'json',", "                    success: $.proxy(function (data) {", "                        if(cache) {", "                            cache.loading = false;", "                        }", "                        this.sourceData = this.makeArray(data);", "                        if($.isArray(this.sourceData)) {", "                            if(cache) {", "                                //store result in cache", "                                cache.sourceData = this.sourceData;", "                                //run success callbacks for other fields waiting for this source", "                                $.each(cache.callbacks, function () { this.call(); });", "                            }", "                            this.doPrepend();", "                            success.call(this);", "                        } else {", "                            error.call(this);", "                            if(cache) {", "                                //run error callbacks for other fields waiting for this source", "                                $.each(cache.err_callbacks, function () { this.call(); });", "                            }", "                        }", "                    }, this),", "                    error: $.proxy(function () {", "                        error.call(this);", "                        if(cache) {", "                             cache.loading = false;", "                             //run error callbacks for other fields", "                             $.each(cache.err_callbacks, function () { this.call(); });", "                        }", "                    }, this)", "                }, this.options.sourceOptions);", "", "                //loading sourceData from server", "                $.ajax(ajaxOptions);", "", "            } else { //options as json/array", "                this.sourceData = this.makeArray(source);", "", "                if($.isArray(this.sourceData)) {", "                    this.doPrepend();", "                    success.call(this);", "                } else {", "                    error.call(this);", "                }", "            }", "        },", "", "        doPrepend: function () {", "            if(this.options.prepend === null || this.options.prepend === undefined) {", "                return;", "            }", "", "            if(!$.isArray(this.prependData)) {", "                //run prepend if it is function (once)", "                if ($.isFunction(this.options.prepend)) {", "                    this.options.prepend = this.options.prepend.call(this.options.scope);", "                }", "", "                //try parse json in single quotes", "                this.options.prepend = $.fn.editableutils.tryParseJson(this.options.prepend, true);", "", "                //convert prepend from string to object", "                if (typeof this.options.prepend === 'string') {", "                    this.options.prepend = {'': this.options.prepend};", "                }", "", "                this.prependData = this.makeArray(this.options.prepend);", "            }", "", "            if($.isArray(this.prependData) && $.isArray(this.sourceData)) {", "                this.sourceData = this.prependData.concat(this.sourceData);", "            }", "        },", "", "        /*", "         renders input list", "        */", "        renderList: function() {", "            // this method should be overwritten in child class", "        },", "", "         /*", "         set element's html by value", "        */", "        value2htmlFinal: function(value, element) {", "            // this method should be overwritten in child class", "        },", "", "        /**", "        * convert data to array suitable for sourceData, e.g. [{value: 1, text: 'abc'}, {...}]", "        */", "        makeArray: function(data) {", "            var count, obj, result = [], item, iterateItem;", "            if(!data || typeof data === 'string') {", "                return null;", "            }", "", "            if($.isArray(data)) { //array", "                /*", "                   function to iterate inside item of array if item is object.", "                   Caclulates count of keys in item and store in obj.", "                */", "                iterateItem = function (k, v) {", "                    obj = {value: k, text: v};", "                    if(count++ >= 2) {", "                        return false;// exit from `each` if item has more than one key.", "                    }", "                };", "", "                for(var i = 0; i < data.length; i++) {", "                    item = data[i];", "                    if(typeof item === 'object') {", "                        count = 0; //count of keys inside item", "                        $.each(item, iterateItem);", "                        //case: [{val1: 'text1'}, {val2: 'text2} ...]", "                        if(count === 1) {", "                            result.push(obj);", "                            //case: [{value: 1, text: 'text1'}, {value: 2, text: 'text2'}, ...]", "                        } else if(count > 1) {", "                            //removed check of existance: item.hasOwnProperty('value') && item.hasOwnProperty('text')", "                            if(item.children) {", "                                item.children = this.makeArray(item.children);", "                            }", "                            result.push(item);", "                        }", "                    } else {", "                        //case: ['text1', 'text2' ...]", "                        result.push({value: item, text: item});", "                    }", "                }", "            } else {  //case: {val1: 'text1', val2: 'text2, ...}", "                $.each(data, function (k, v) {", "                    result.push({value: k, text: v});", "                });", "            }", "            return result;", "        },", "", "        option: function(key, value) {", "            this.options[key] = value;", "            if(key === 'source') {", "                this.sourceData = null;", "            }", "            if(key === 'prepend') {", "                this.prependData = null;", "            }", "        }", "", "    });", "", "    List.defaults = $.extend({}, $.fn.editabletypes.abstractinput.defaults, {", "        /**", "        Source data for list.", "        If **array** - it should be in format: `[{value: 1, text: \"text1\"}, {value: 2, text: \"text2\"}, ...]`", "        For compability, object format is also supported: `{\"1\": \"text1\", \"2\": \"text2\" ...}` but it does not guarantee elements order.", "", "        If **string** - considered ajax url to load items. In that case results will be cached for fields with the same source and name. See also `sourceCache` option.", "", "        If **function**, it should return data in format above (since 1.4.0).", "", "        Since 1.4.1 key `children` supported to render OPTGROUP (for **select** input only).", "        `[{text: \"group1\", children: [{value: 1, text: \"text1\"}, {value: 2, text: \"text2\"}]}, ...]`", "", "", "        @property source", "        @type string | array | object | function", "        @default null", "        **/", "        source: null,", "        /**", "        Data automatically prepended to the beginning of dropdown list.", "", "        @property prepend", "        @type string | array | object | function", "        @default false", "        **/", "        prepend: false,", "        /**", "        Error message when list cannot be loaded (e.g. ajax error)", "", "        @property sourceError", "        @type string", "        @default Error when loading list", "        **/", "        sourceError: 'Error when loading list',", "        /**", "        if <code>true</code> and source is **string url** - results will be cached for fields with the same source.", "        Usefull for editable column in grid to prevent extra requests.", "", "        @property sourceCache", "        @type boolean", "        @default true", "        @since 1.2.0", "        **/", "        sourceCache: true,", "        /**", "        Additional ajax options to be used in $.ajax() when loading list from server.", "        Useful to send extra parameters (`data` key) or change request method (`type` key).", "", "        @property sourceOptions", "        @type object|function", "        @default null", "        @since 1.5.0", "        **/", "        sourceOptions: null", "    });", "", "    $.fn.editabletypes.list = List;", "", "}(window.jQuery));", "", "/**", "Text input", "", "@class text", "@extends abstractinput", "@final", "@example", "<a href=\"#\" id=\"username\" data-type=\"text\" data-pk=\"1\">awesome</a>", "<script>", "$(function(){", "    $('#username').editable({", "        url: '/post',", "        title: 'Enter username'", "    });", "});", "</script>", "**/", "(function ($) {", "    \"use strict\";", "", "    var Text = function (options) {", "        this.init('text', options, Text.defaults);", "    };", "", "    $.fn.editableutils.inherit(Text, $.fn.editabletypes.abstractinput);", "", "    $.extend(Text.prototype, {", "        render: function() {", "           this.renderClear();", "           this.setClass();", "           this.setAttr('placeholder');", "        },", "", "        activate: function() {", "            if(this.$input.is(':visible')) {", "                this.$input.focus();", "                $.fn.editableutils.setCursorPosition(this.$input.get(0), this.$input.val().length);", "                if(this.toggleClear) {", "                    this.toggleClear();", "                }", "            }", "        },", "", "        //render clear button", "        renderClear:  function() {", "           if (this.options.clear) {", "               this.$clear = $('<span class=\"editable-clear-x\"></span>');", "               this.$input.after(this.$clear)", "                          .css('padding-right', 24)", "                          .keyup($.proxy(function(e) {", "                              //arrows, enter, tab, etc", "                              if(~$.inArray(e.keyCode, [40,38,9,13,27])) {", "                                return;", "                              }", "", "                              clearTimeout(this.t);", "                              var that = this;", "                              this.t = setTimeout(function() {", "                                that.toggleClear(e);", "                              }, 100);", "", "                          }, this))", "                          .parent().css('position', 'relative');", "", "               this.$clear.click($.proxy(this.clear, this));", "           }", "        },", "", "        postrender: function() {", "            /*", "            //now `clear` is positioned via css", "            if(this.$clear) {", "                //can position clear button only here, when form is shown and height can be calculated", "//                var h = this.$input.outerHeight(true) || 20,", "                var h = this.$clear.parent().height(),", "                    delta = (h - this.$clear.height()) / 2;", "", "                //this.$clear.css({bottom: delta, right: delta});", "            }", "            */", "        },", "", "        //show / hide clear button", "        toggleClear: function(e) {", "            if(!this.$clear) {", "                return;", "            }", "", "            var len = this.$input.val().length,", "                visible = this.$clear.is(':visible');", "", "            if(len && !visible) {", "                this.$clear.show();", "            }", "", "            if(!len && visible) {", "                this.$clear.hide();", "            }", "        },", "", "        clear: function() {", "           this.$clear.hide();", "           this.$input.val('').focus();", "        }", "    });", "", "    Text.defaults = $.extend({}, $.fn.editabletypes.abstractinput.defaults, {", "        /**", "        @property tpl", "        @default <input type=\"text\">", "        **/", "        tpl: '<input type=\"text\">',", "        /**", "        Placeholder attribute of input. Shown when input is empty.", "", "        @property placeholder", "        @type string", "        @default null", "        **/", "        placeholder: null,", "", "        /**", "        Whether to show `clear` button", "", "        @property clear", "        @type boolean", "        @default true", "        **/", "        clear: true", "    });", "", "    $.fn.editabletypes.text = Text;", "", "}(window.jQuery));", "", "/**", "Textarea input", "", "@class textarea", "@extends abstractinput", "@final", "@example", "<a href=\"#\" id=\"comments\" data-type=\"textarea\" data-pk=\"1\">awesome comment!</a>", "<script>", "$(function(){", "    $('#comments').editable({", "        url: '/post',", "        title: 'Enter comments',", "        rows: 10", "    });", "});", "</script>", "**/", "(function ($) {", "    \"use strict\";", "", "    var Textarea = function (options) {", "        this.init('textarea', options, Textarea.defaults);", "    };", "", "    $.fn.editableutils.inherit(Textarea, $.fn.editabletypes.abstractinput);", "", "    $.extend(Textarea.prototype, {", "        render: function () {", "            this.setClass();", "            this.setAttr('placeholder');", "            this.setAttr('rows');", "", "            //ctrl + enter", "            this.$input.keydown(function (e) {", "                if (e.ctrlKey && e.which === 13) {", "                    $(this).closest('form').submit();", "                }", "            });", "        },", "", "       //using `white-space: pre-wrap` solves \\n  <--> BR conversion very elegant!", "       /*", "       value2html: function(value, element) {", "            var html = '', lines;", "            if(value) {", "                lines = value.split(\"\\n\");", "                for (var i = 0; i < lines.length; i++) {", "                    lines[i] = $('<div>').text(lines[i]).html();", "                }", "                html = lines.join('<br>');", "            }", "            $(element).html(html);", "        },", "", "        html2value: function(html) {", "            if(!html) {", "                return '';", "            }", "", "            var regex = new RegExp(String.fromCharCode(10), 'g');", "            var lines = html.split(/<br\\s*\\/?>/i);", "            for (var i = 0; i < lines.length; i++) {", "                var text = $('<div>').html(lines[i]).text();", "", "                // Remove newline characters (\\n) to avoid them being converted by value2html() method", "                // thus adding extra <br> tags", "                text = text.replace(regex, '');", "", "                lines[i] = text;", "            }", "            return lines.join(\"\\n\");", "        },", "         */", "        activate: function() {", "            $.fn.editabletypes.text.prototype.activate.call(this);", "        }", "    });", "", "    Textarea.defaults = $.extend({}, $.fn.editabletypes.abstractinput.defaults, {", "        /**", "        @property tpl", "        @default <textarea></textarea>", "        **/", "        tpl:'<textarea></textarea>',", "        /**", "        @property inputclass", "        @default input-large", "        **/", "        inputclass: 'input-large',", "        /**", "        Placeholder attribute of input. Shown when input is empty.", "", "        @property placeholder", "        @type string", "        @default null", "        **/", "        placeholder: null,", "        /**", "        Number of rows in textarea", "", "        @property rows", "        @type integer", "        @default 7", "        **/", "        rows: 7", "    });", "", "    $.fn.editabletypes.textarea = Textarea;", "", "}(window.jQuery));", "", "/**", "Select (dropdown)", "", "@class select", "@extends list", "@final", "@example", "<a href=\"#\" id=\"status\" data-type=\"select\" data-pk=\"1\" data-url=\"/post\" data-title=\"Select status\"></a>", "<script>", "$(function(){", "    $('#status').editable({", "        value: 2,", "        source: [", "              {value: 1, text: 'Active'},", "              {value: 2, text: 'Blocked'},", "              {value: 3, text: 'Deleted'}", "           ]", "    });", "});", "</script>", "**/", "(function ($) {", "    \"use strict\";", "", "    var Select = function (options) {", "        this.init('select', options, Select.defaults);", "    };", "", "    $.fn.editableutils.inherit(Select, $.fn.editabletypes.list);", "", "    $.extend(Select.prototype, {", "        renderList: function() {", "            this.$input.empty();", "", "            var fillItems = function($el, data) {", "                var attr;", "                if($.isArray(data)) {", "                    for(var i=0; i<data.length; i++) {", "                        attr = {};", "                        if(data[i].children) {", "                            attr.label = data[i].text;", "                            $el.append(fillItems($('<optgroup>', attr), data[i].children));", "                        } else {", "                            attr.value = data[i].value;", "                            if(data[i].disabled) {", "                                attr.disabled = true;", "                            }", "                            $el.append($('<option>', attr).text(data[i].text));", "                        }", "                    }", "                }", "                return $el;", "            };", "", "            fillItems(this.$input, this.sourceData);", "", "            this.setClass();", "", "            //enter submit", "            this.$input.on('keydown.editable', function (e) {", "                if (e.which === 13) {", "                    $(this).closest('form').submit();", "                }", "            });", "        },", "", "        value2htmlFinal: function(value, element) {", "            var text = '',", "                items = $.fn.editableutils.itemsByValue(value, this.sourceData);", "", "            if(items.length) {", "                text = items[0].text;", "            }", "", "            //$(element).text(text);", "            $.fn.editabletypes.abstractinput.prototype.value2html.call(this, text, element);", "        },", "", "        autosubmit: function() {", "            this.$input.off('keydown.editable').on('change.editable', function(){", "                $(this).closest('form').submit();", "            });", "        }", "    });", "", "    Select.defaults = $.extend({}, $.fn.editabletypes.list.defaults, {", "        /**", "        @property tpl", "        @default <select></select>", "        **/", "        tpl:'<select></select>'", "    });", "", "    $.fn.editabletypes.select = Select;", "", "}(window.jQuery));", "", "/**", "List of checkboxes.", "Internally value stored as javascript array of values.", "", "@class checklist", "@extends list", "@final", "@example", "<a href=\"#\" id=\"options\" data-type=\"checklist\" data-pk=\"1\" data-url=\"/post\" data-title=\"Select options\"></a>", "<script>", "$(function(){", "    $('#options').editable({", "        value: [2, 3],", "        source: [", "              {value: 1, text: 'option1'},", "              {value: 2, text: 'option2'},", "              {value: 3, text: 'option3'}", "           ]", "    });", "});", "</script>", "**/", "(function ($) {", "    \"use strict\";", "", "    var Checklist = function (options) {", "        this.init('checklist', options, Checklist.defaults);", "    };", "", "    $.fn.editableutils.inherit(Checklist, $.fn.editabletypes.list);", "", "    $.extend(Checklist.prototype, {", "        renderList: function() {", "            var $label, $div;", "", "            this.$tpl.empty();", "", "            if(!$.isArray(this.sourceData)) {", "                return;", "            }", "", "            for(var i=0; i<this.sourceData.length; i++) {", "                $label = $('<label>').append($('<input>', {", "                                           type: 'checkbox',", "                                           value: this.sourceData[i].value", "                                     }))", "                                     .append($('<span>').text(' '+this.sourceData[i].text));", "", "                $('<div>').append($label).appendTo(this.$tpl);", "            }", "", "            this.$input = this.$tpl.find('input[type=\"checkbox\"]');", "            this.setClass();", "        },", "", "       value2str: function(value) {", "           return $.isArray(value) ? value.sort().join($.trim(this.options.separator)) : '';", "       },", "", "       //parse separated string", "        str2value: function(str) {", "           var reg, value = null;", "           if(typeof str === 'string' && str.length) {", "               reg = new RegExp('\\\\s*'+$.trim(this.options.separator)+'\\\\s*');", "               value = str.split(reg);", "           } else if($.isArray(str)) {", "               value = str;", "           } else {", "               value = [str];", "           }", "           return value;", "        },", "", "       //set checked on required checkboxes", "       value2input: function(value) {", "            this.$input.prop('checked', false);", "            if($.isArray(value) && value.length) {", "               this.$input.each(function(i, el) {", "                   var $el = $(el);", "                   // cannot use $.inArray as it performs strict comparison", "                   $.each(value, function(j, val){", "                       /*jslint eqeq: true*/", "                       if($el.val() == val) {", "                       /*jslint eqeq: false*/", "                           $el.prop('checked', true);", "                       }", "                   });", "               });", "            }", "        },", "", "       input2value: function() {", "           var checked = [];", "           this.$input.filter(':checked').each(function(i, el) {", "               checked.push($(el).val());", "           });", "           return checked;", "       },", "", "       //collect text of checked boxes", "        value2htmlFinal: function(value, element) {", "           var html = [],", "               checked = $.fn.editableutils.itemsByValue(value, this.sourceData),", "               escape = this.options.escape;", "", "           if(checked.length) {", "               $.each(checked, function(i, v) {", "                   var text = escape ? $.fn.editableutils.escape(v.text) : v.text;", "                   html.push(text);", "               });", "               $(element).html(html.join('<br>'));", "           } else {", "               $(element).empty();", "           }", "        },", "", "       activate: function() {", "           this.$input.first().focus();", "       },", "", "       autosubmit: function() {", "           this.$input.on('keydown', function(e){", "               if (e.which === 13) {", "                   $(this).closest('form').submit();", "               }", "           });", "       }", "    });", "", "    Checklist.defaults = $.extend({}, $.fn.editabletypes.list.defaults, {", "        /**", "        @property tpl", "        @default <div></div>", "        **/", "        tpl:'<div class=\"editable-checklist\"></div>',", "", "        /**", "        @property inputclass", "        @type string", "        @default null", "        **/", "        inputclass: null,", "", "        /**", "        Separator of values when reading from `data-value` attribute", "", "        @property separator", "        @type string", "        @default ','", "        **/", "        separator: ','", "    });", "", "    $.fn.editabletypes.checklist = Checklist;", "", "}(window.jQuery));", "", "/**", "HTML5 input types.", "Following types are supported:", "", "* password", "* email", "* url", "* tel", "* number", "* range", "* time", "", "Learn more about html5 inputs:", "http://www.w3.org/wiki/HTML5_form_additions", "To check browser compatibility please see:", "https://developer.mozilla.org/en-US/docs/HTML/Element/Input", "", "@class html5types", "@extends text", "@final", "@since 1.3.0", "@example", "<a href=\"#\" id=\"email\" data-type=\"email\" data-pk=\"1\">admin@example.com</a>", "<script>", "$(function(){", "    $('#email').editable({", "        url: '/post',", "        title: 'Enter email'", "    });", "});", "</script>", "**/", "", "/**", "@property tpl", "@default depends on type", "**/", "", "/*", "Password", "*/", "(function ($) {", "    \"use strict\";", "", "    var Password = function (options) {", "        this.init('password', options, Password.defaults);", "    };", "    $.fn.editableutils.inherit(Password, $.fn.editabletypes.text);", "    $.extend(Password.prototype, {", "       //do not display password, show '[hidden]' instead", "       value2html: function(value, element) {", "           if(value) {", "               $(element).text('[hidden]');", "           } else {", "               $(element).empty();", "           }", "       },", "       //as password not displayed, should not set value by html", "       html2value: function(html) {", "           return null;", "       }", "    });", "    Password.defaults = $.extend({}, $.fn.editabletypes.text.defaults, {", "        tpl: '<input type=\"password\">'", "    });", "    $.fn.editabletypes.password = Password;", "}(window.jQuery));", "", "", "/*", "Email", "*/", "(function ($) {", "    \"use strict\";", "", "    var Email = function (options) {", "        this.init('email', options, Email.defaults);", "    };", "    $.fn.editableutils.inherit(Email, $.fn.editabletypes.text);", "    Email.defaults = $.extend({}, $.fn.editabletypes.text.defaults, {", "        tpl: '<input type=\"email\">'", "    });", "    $.fn.editabletypes.email = Email;", "}(window.jQuery));", "", "", "/*", "Url", "*/", "(function ($) {", "    \"use strict\";", "", "    var Url = function (options) {", "        this.init('url', options, Url.defaults);", "    };", "    $.fn.editableutils.inherit(Url, $.fn.editabletypes.text);", "    Url.defaults = $.extend({}, $.fn.editabletypes.text.defaults, {", "        tpl: '<input type=\"url\">'", "    });", "    $.fn.editabletypes.url = Url;", "}(window.jQuery));", "", "", "/*", "Tel", "*/", "(function ($) {", "    \"use strict\";", "", "    var Tel = function (options) {", "        this.init('tel', options, Tel.defaults);", "    };", "    $.fn.editableutils.inherit(Tel, $.fn.editabletypes.text);", "    Tel.defaults = $.extend({}, $.fn.editabletypes.text.defaults, {", "        tpl: '<input type=\"tel\">'", "    });", "    $.fn.editabletypes.tel = Tel;", "}(window.jQuery));", "", "", "/*", "Number", "*/", "(function ($) {", "    \"use strict\";", "", "    var NumberInput = function (options) {", "        this.init('number', options, NumberInput.defaults);", "    };", "    $.fn.editableutils.inherit(NumberInput, $.fn.editabletypes.text);", "    $.extend(NumberInput.prototype, {", "         render: function () {", "            NumberInput.superclass.render.call(this);", "            this.setAttr('min');", "            this.setAttr('max');", "            this.setAttr('step');", "        },", "        postrender: function() {", "            if(this.$clear) {", "                //increase right ffset  for up/down arrows", "                this.$clear.css({right: 24});", "                /*", "                //can position clear button only here, when form is shown and height can be calculated", "                var h = this.$input.outerHeight(true) || 20,", "                    delta = (h - this.$clear.height()) / 2;", "", "                //add 12px to offset right for up/down arrows", "                this.$clear.css({top: delta, right: delta + 16});", "                */", "            }", "        }", "    });", "    NumberInput.defaults = $.extend({}, $.fn.editabletypes.text.defaults, {", "        tpl: '<input type=\"number\">',", "        inputclass: 'input-mini',", "        min: null,", "        max: null,", "        step: null", "    });", "    $.fn.editabletypes.number = NumberInput;", "}(window.jQuery));", "", "", "/*", "Range (inherit from number)", "*/", "(function ($) {", "    \"use strict\";", "", "    var Range = function (options) {", "        this.init('range', options, Range.defaults);", "    };", "    $.fn.editableutils.inherit(Range, $.fn.editabletypes.number);", "    $.extend(Range.prototype, {", "        render: function () {", "            this.$input = this.$tpl.filter('input');", "", "            this.setClass();", "            this.setAttr('min');", "            this.setAttr('max');", "            this.setAttr('step');", "", "            this.$input.on('input', function(){", "                $(this).siblings('output').text($(this).val());", "            });", "        },", "        activate: function() {", "            this.$input.focus();", "        }", "    });", "    Range.defaults = $.extend({}, $.fn.editabletypes.number.defaults, {", "        tpl: '<input type=\"range\"><output style=\"width: 30px; display: inline-block\"></output>',", "        inputclass: 'input-medium'", "    });", "    $.fn.editabletypes.range = Range;", "}(window.jQuery));", "", "/*", "Time", "*/", "(function ($) {", "    \"use strict\";", "", "    var Time = function (options) {", "        this.init('time', options, Time.defaults);", "    };", "    //inherit from abstract, as inheritance from text gives selection error.", "    $.fn.editableutils.inherit(Time, $.fn.editabletypes.abstractinput);", "    $.extend(Time.prototype, {", "        render: function() {", "           this.setClass();", "        }", "    });", "    Time.defaults = $.extend({}, $.fn.editabletypes.abstractinput.defaults, {", "        tpl: '<input type=\"time\">'", "    });", "    $.fn.editabletypes.time = Time;", "}(window.jQuery));", "", "", "/*", "Editableform based on Twitter Bootstrap 3", "*/", "(function ($) {", "    \"use strict\";", "", "    //store parent methods", "    var pInitInput = $.fn.editableform.Constructor.prototype.initInput;", "", "    $.extend($.fn.editableform.Constructor.prototype, {", "        initTemplate: function() {", "            this.$form = $($.fn.editableform.template);", "            this.$form.find('.control-group').addClass('form-group');", "            this.$form.find('.editable-error-block').addClass('help-block');", "        },", "        initInput: function() {", "            pInitInput.apply(this);", "", "            //for bs3 set default class `input-sm` to standard inputs", "            var emptyInputClass = this.input.options.inputclass === null || this.input.options.inputclass === false;", "            var defaultClass = 'input-sm';", "", "            //bs3 add `form-control` class to standard inputs", "            var stdtypes = 'text,select,textarea,password,email,url,tel,number,range,time,typeaheadjs'.split(',');", "            if(~$.inArray(this.input.type, stdtypes)) {", "                this.input.$input.addClass('form-control');", "                if(emptyInputClass) {", "                    this.input.options.inputclass = defaultClass;", "                    this.input.$input.addClass(defaultClass);", "                }", "            }", "", "            //apply bs3 size class also to buttons (to fit size of control)", "            var $btn = this.$form.find('.editable-buttons');", "            var classes = emptyInputClass ? [defaultClass] : this.input.options.inputclass.split(' ');", "            for(var i=0; i<classes.length; i++) {", "                // `btn-sm` is default now", "                /*", "                if(classes[i].toLowerCase() === 'input-sm') {", "                    $btn.find('button').addClass('btn-sm');", "                }", "                */", "                if(classes[i].toLowerCase() === 'input-lg') {", "                    $btn.find('button').removeClass('btn-sm').addClass('btn-lg');", "                }", "            }", "        }", "    });", "", "    //buttons", "    $.fn.editableform.buttons =", "      '<button type=\"submit\" class=\"btn btn-primary btn-sm editable-submit\">'+", "        '<i class=\"glyphicon glyphicon-ok\"></i>'+", "      '</button>'+", "      '<button type=\"button\" class=\"btn btn-default btn-sm editable-cancel\">'+", "        '<i class=\"glyphicon glyphicon-remove\"></i>'+", "      '</button>';", "", "    //error classes", "    $.fn.editableform.errorGroupClass = 'has-error';", "    $.fn.editableform.errorBlockClass = null;", "    //engine", "    $.fn.editableform.engine = 'bs3';", "}(window.jQuery));", "/**", "* Editable Popover3 (for Bootstrap 3)", "* ---------------------", "* requires bootstrap-popover.js", "*/", "(function ($) {", "    \"use strict\";", "", "    //extend methods", "    $.extend($.fn.editableContainer.Popup.prototype, {", "        containerName: 'popover',", "        containerDataName: 'bs.popover',", "        innerCss: '.popover-content',", "        defaults: $.fn.popover.Constructor.DEFAULTS,", "", "        initContainer: function(){", "            $.extend(this.containerOptions, {", "                trigger: 'manual',", "                selector: false,", "                content: ' ',", "                template: this.defaults.template", "            });", "", "            //as template property is used in inputs, hide it from popover", "            var t;", "            if(this.$element.data('template')) {", "               t = this.$element.data('template');", "               this.$element.removeData('template');", "            }", "", "            this.call(this.containerOptions);", "", "            if(t) {", "               //restore data('template')", "               this.$element.data('template', t);", "            }", "        },", "", "        /* show */", "        innerShow: function () {", "            this.call('show');", "        },", "", "        /* hide */", "        innerHide: function () {", "            this.call('hide');", "        },", "", "        /* destroy */", "        innerDestroy: function() {", "            this.call('destroy');", "        },", "", "        setContainerOption: function(key, value) {", "            this.container().options[key] = value;", "        },", "", "        /**", "        * move popover to new position. This function mainly copied from bootstrap-popover.", "        */", "        /*jshint laxcomma: true, eqeqeq: false*/", "        setPosition: function () {", "", "            (function() {", "            /*", "                var $tip = this.tip()", "                , inside", "                , pos", "                , actualWidth", "                , actualHeight", "                , placement", "                , tp", "                , tpt", "                , tpb", "                , tpl", "                , tpr;", "", "                placement = typeof this.options.placement === 'function' ?", "                this.options.placement.call(this, $tip[0], this.$element[0]) :", "                this.options.placement;", "", "                inside = /in/.test(placement);", "", "                $tip", "              //  .detach()", "              //vitalets: remove any placement class because otherwise they dont influence on re-positioning of visible popover", "                .removeClass('top right bottom left')", "                .css({ top: 0, left: 0, display: 'block' });", "              //  .insertAfter(this.$element);", "", "                pos = this.getPosition(inside);", "", "                actualWidth = $tip[0].offsetWidth;", "                actualHeight = $tip[0].offsetHeight;", "", "                placement = inside ? placement.split(' ')[1] : placement;", "", "                tpb = {top: pos.top + pos.height, left: pos.left + pos.width / 2 - actualWidth / 2};", "                tpt = {top: pos.top - actualHeight, left: pos.left + pos.width / 2 - actualWidth / 2};", "                tpl = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left - actualWidth};", "                tpr = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left + pos.width};", "", "                switch (placement) {", "                    case 'bottom':", "                        if ((tpb.top + actualHeight) > ($(window).scrollTop() + $(window).height())) {", "                            if (tpt.top > $(window).scrollTop()) {", "                                placement = 'top';", "                            } else if ((tpr.left + actualWidth) < ($(window).scrollLeft() + $(window).width())) {", "                                placement = 'right';", "                            } else if (tpl.left > $(window).scrollLeft()) {", "                                placement = 'left';", "                            } else {", "                                placement = 'right';", "                            }", "                        }", "                        break;", "                    case 'top':", "                        if (tpt.top < $(window).scrollTop()) {", "                            if ((tpb.top + actualHeight) < ($(window).scrollTop() + $(window).height())) {", "                                placement = 'bottom';", "                            } else if ((tpr.left + actualWidth) < ($(window).scrollLeft() + $(window).width())) {", "                                placement = 'right';", "                            } else if (tpl.left > $(window).scrollLeft()) {", "                                placement = 'left';", "                            } else {", "                                placement = 'right';", "                            }", "                        }", "                        break;", "                    case 'left':", "                        if (tpl.left < $(window).scrollLeft()) {", "                            if ((tpr.left + actualWidth) < ($(window).scrollLeft() + $(window).width())) {", "                                placement = 'right';", "                            } else if (tpt.top > $(window).scrollTop()) {", "                                placement = 'top';", "                            } else if (tpt.top > $(window).scrollTop()) {", "                                placement = 'bottom';", "                            } else {", "                                placement = 'right';", "                            }", "                        }", "                        break;", "                    case 'right':", "                        if ((tpr.left + actualWidth) > ($(window).scrollLeft() + $(window).width())) {", "                            if (tpl.left > $(window).scrollLeft()) {", "                                placement = 'left';", "                            } else if (tpt.top > $(window).scrollTop()) {", "                                placement = 'top';", "                            } else if (tpt.top > $(window).scrollTop()) {", "                                placement = 'bottom';", "                            }", "                        }", "                        break;", "                }", "", "                switch (placement) {", "                    case 'bottom':", "                        tp = tpb;", "                        break;", "                    case 'top':", "                        tp = tpt;", "                        break;", "                    case 'left':", "                        tp = tpl;", "                        break;", "                    case 'right':", "                        tp = tpr;", "                        break;", "                }", "", "                $tip", "                .offset(tp)", "                .addClass(placement)", "                .addClass('in');", "           */", "", "", "            var $tip = this.tip();", "", "            var placement = typeof this.options.placement == 'function' ?", "                this.options.placement.call(this, $tip[0], this.$element[0]) :", "                this.options.placement;", "", "            var autoToken = /\\s?auto?\\s?/i;", "            var autoPlace = autoToken.test(placement);", "            if (autoPlace) {", "                placement = placement.replace(autoToken, '') || 'top';", "            }", "", "", "            var pos = this.getPosition();", "            var actualWidth = $tip[0].offsetWidth;", "            var actualHeight = $tip[0].offsetHeight;", "", "            if (autoPlace) {", "                var $parent = this.$element.parent();", "", "                var orgPlacement = placement;", "                var docScroll    = document.documentElement.scrollTop || document.body.scrollTop;", "                var parentWidth  = this.options.container == 'body' ? window.innerWidth  : $parent.outerWidth();", "                var parentHeight = this.options.container == 'body' ? window.innerHeight : $parent.outerHeight();", "                var parentLeft   = this.options.container == 'body' ? 0 : $parent.offset().left;", "", "                placement = placement == 'bottom' && pos.top   + pos.height  + actualHeight - docScroll > parentHeight  ? 'top'    :", "                            placement == 'top'    && pos.top   - docScroll   - actualHeight < 0                         ? 'bottom' :", "                            placement == 'right'  && pos.right + actualWidth > parentWidth                              ? 'left'   :", "                            placement == 'left'   && pos.left  - actualWidth < parentLeft                               ? 'right'  :", "                            placement;", "", "                $tip", "                  .removeClass(orgPlacement)", "                  .addClass(placement);", "            }", "", "", "            var calculatedOffset = this.getCalculatedOffset(placement, pos, actualWidth, actualHeight);", "", "            this.applyPlacement(calculatedOffset, placement);", "", "", "            }).call(this.container());", "          /*jshint laxcomma: false, eqeqeq: true*/", "        }", "    });", "", "}(window.jQuery));"]}, {"lines": ["/**", " * @license Knockout.Punches", " * Enhanced binding syntaxes for Knockout 3+", " * (c) Michael Best", " * License: MIT (http://www.opensource.org/licenses/mit-license.php)", " * Version 0.5.0", " */", "(function (factory) {", "    if (typeof define === 'function' && define.amd) {", "        // AMD. Register as an anonymous module.", "        define(['knockout'], factory);", "    } else if (typeof module === \"object\") {", "        // NOTE: Added by @sloria", "        // CommonJS module", "        var ko = require(\"knockout\");", "        factory(ko);", "    } else {", "        // Browser globals", "        factory(ko);", "    }", "}(function(ko) {", "", "// Add a preprocess function to a binding handler.", "function addBindingPreprocessor(bindingKeyOrHandler, preprocessFn) {", "    return chainPreprocessor(getOrCreateHandler(bindingKeyOrHandler), 'preprocess', preprocessFn);", "}", "", "// These utility functions are separated out because they're also used by", "// preprocessBindingProperty", "", "// Get the binding handler or create a new, empty one", "function getOrCreateHandler(bindingKeyOrHandler) {", "    return typeof bindingKeyOrHandler === 'object' ? bindingKeyOrHandler :", "        (ko.getBindingHandler(bindingKeyOrHandler) || (ko.bindingHandlers[bindingKeyOrHandler] = {}));", "}", "// Add a preprocess function", "function chainPreprocessor(obj, prop, fn) {", "    if (obj[prop]) {", "        // If the handler already has a preprocess function, chain the new", "        // one after the existing one. If the previous function in the chain", "        // returns a falsy value (to remove the binding), the chain ends. This", "        // method allows each function to modify and return the binding value.", "        var previousFn = obj[prop];", "        obj[prop] = function(value, binding, addBinding) {", "            value = previousFn.call(this, value, binding, addBinding);", "            if (value)", "                return fn.call(this, value, binding, addBinding);", "        };", "    } else {", "        obj[prop] = fn;", "    }", "    return obj;", "}", "", "// Add a preprocessNode function to the binding provider. If a", "// function already exists, chain the new one after it. This calls", "// each function in the chain until one modifies the node. This", "// method allows only one function to modify the node.", "function addNodePreprocessor(preprocessFn) {", "    var provider = ko.bindingProvider.instance;", "    if (provider.preprocessNode) {", "        var previousPreprocessFn = provider.preprocessNode;", "        provider.preprocessNode = function(node) {", "            var newNodes = previousPreprocessFn.call(this, node);", "            if (!newNodes)", "                newNodes = preprocessFn.call(this, node);", "            return newNodes;", "        };", "    } else {", "        provider.preprocessNode = preprocessFn;", "    }", "}", "", "function addBindingHandlerCreator(matchRegex, callbackFn) {", "    var oldGetHandler = ko.getBindingHandler;", "    ko.getBindingHandler = function(bindingKey) {", "        var match;", "        return oldGetHandler(bindingKey) || ((match = bindingKey.match(matchRegex)) && callbackFn(match, bindingKey));", "    };", "}", "", "// Create shortcuts to commonly used ko functions", "var ko_unwrap = ko.unwrap;", "", "// Create \"punches\" object and export utility functions", "var ko_punches = ko.punches = {", "    utils: {", "        addBindingPreprocessor: addBindingPreprocessor,", "        addNodePreprocessor: addNodePreprocessor,", "        addBindingHandlerCreator: addBindingHandlerCreator,", "", "        // previous names retained for backwards compitibility", "        setBindingPreprocessor: addBindingPreprocessor,", "        setNodePreprocessor: addNodePreprocessor", "    }", "};", "", "ko_punches.enableAll = function () {", "    // Enable interpolation markup", "    enableInterpolationMarkup();", "    enableAttributeInterpolationMarkup();", "", "    // Enable auto-namspacing of attr, css, event, and style", "    enableAutoNamespacedSyntax('attr');", "    enableAutoNamespacedSyntax('css');", "    enableAutoNamespacedSyntax('event');", "    enableAutoNamespacedSyntax('style');", "", "    // Enable filter syntax for text, html, and attr", "    enableTextFilter('text');", "    enableTextFilter('html');", "    addDefaultNamespacedBindingPreprocessor('attr', filterPreprocessor);", "", "    // Enable wrapped callbacks for click, submit, event, optionsAfterRender, and template options", "    enableWrappedCallback('click');", "    enableWrappedCallback('submit');", "    enableWrappedCallback('optionsAfterRender');", "    addDefaultNamespacedBindingPreprocessor('event', wrappedCallbackPreprocessor);", "    addBindingPropertyPreprocessor('template', 'beforeRemove', wrappedCallbackPreprocessor);", "    addBindingPropertyPreprocessor('template', 'afterAdd', wrappedCallbackPreprocessor);", "    addBindingPropertyPreprocessor('template', 'afterRender', wrappedCallbackPreprocessor);", "};", "// Convert input in the form of `expression | filter1 | filter2:arg1:arg2` to a function call format", "// with filters accessed as ko.filters.filter1, etc.", "function filterPreprocessor(input) {", "    // Check if the input contains any | characters; if not, just return", "    if (input.indexOf('|') === -1)", "        return input;", "", "    // Split the input into tokens, in which | and : are individual tokens, quoted strings are ignored, and all tokens are space-trimmed", "    var tokens = input.match(/\"([^\"\\\\]|\\\\.)*\"|'([^'\\\\]|\\\\.)*'|\\|\\||[|:]|[^\\s|:\"'][^|:\"']*[^\\s|:\"']|[^\\s|:\"']/g);", "    if (tokens && tokens.length > 1) {", "        // Append a line so that we don't need a separate code block to deal with the last item", "        tokens.push('|');", "        input = tokens[0];", "        var lastToken, token, inFilters = false, nextIsFilter = false;", "        for (var i = 1, token; token = tokens[i]; ++i) {", "            if (token === '|') {", "                if (inFilters) {", "                    if (lastToken === ':')", "                        input += \"undefined\";", "                    input += ')';", "                }", "                nextIsFilter = true;", "                inFilters = true;", "            } else {", "                if (nextIsFilter) {", "                    input = \"ko.filters['\" + token + \"'](\" + input;", "                } else if (inFilters && token === ':') {", "                    if (lastToken === ':')", "                        input += \"undefined\";", "                    input += \",\";", "                } else {", "                    input += token;", "                }", "                nextIsFilter = false;", "            }", "            lastToken = token;", "        }", "    }", "    return input;", "}", "", "// Set the filter preprocessor for a specific binding", "function enableTextFilter(bindingKeyOrHandler) {", "    addBindingPreprocessor(bindingKeyOrHandler, filterPreprocessor);", "}", "", "var filters = {};", "", "// Convert value to uppercase", "filters.uppercase = function(value) {", "    return String.prototype.toUpperCase.call(ko_unwrap(value));", "};", "", "// Convert value to lowercase", "filters.lowercase = function(value) {", "    return String.prototype.toLowerCase.call(ko_unwrap(value));", "};", "", "// Return default value if the input value is empty or null", "filters['default'] = function (value, defaultValue) {", "    value = ko_unwrap(value);", "    if (typeof value === \"function\") {", "        return value;", "    }", "    if (typeof value === \"string\") {", "        return trim(value) === '' ? defaultValue : value;", "    }", "    return value == null || value.length == 0 ? defaultValue : value;", "};", "", "// Return the value with the search string replaced with the replacement string", "filters.replace = function(value, search, replace) {", "    return String.prototype.replace.call(ko_unwrap(value), search, replace);", "};", "", "filters.fit = function(value, length, replacement, trimWhere) {", "    value = ko_unwrap(value);", "    if (length && ('' + value).length > length) {", "        replacement = '' + (replacement || '...');", "        length = length - replacement.length;", "        value = '' + value;", "        switch (trimWhere) {", "            case 'left':", "                return replacement + value.slice(-length);", "            case 'middle':", "                var leftLen = Math.ceil(length / 2);", "                return value.substr(0, leftLen) + replacement + value.slice(leftLen-length);", "            default:", "                return value.substr(0, length) + replacement;", "        }", "    } else {", "        return value;", "    }", "};", "", "// Convert a model object to JSON", "filters.json = function(rootObject, space, replacer) {     // replacer and space are optional", "    return ko.toJSON(rootObject, replacer, space);", "};", "", "// Format a number using the browser's toLocaleString", "filters.number = function(value) {", "    return (+ko_unwrap(value)).toLocaleString();", "};", "", "// Export the filters object for general access", "ko.filters = filters;", "", "// Export the preprocessor functions", "ko_punches.textFilter = {", "    preprocessor: filterPreprocessor,", "    enableForBinding: enableTextFilter", "};", "// Support dynamically-created, namespaced bindings. The binding key syntax is", "// \"namespace.binding\". Within a certain namespace, we can dynamically create the", "// handler for any binding. This is particularly useful for bindings that work", "// the same way, but just set a different named value, such as for element", "// attributes or CSS classes.", "var namespacedBindingMatch = /([^\\.]+)\\.(.+)/, namespaceDivider = '.';", "addBindingHandlerCreator(namespacedBindingMatch, function (match, bindingKey) {", "    var namespace = match[1],", "        namespaceHandler = ko.bindingHandlers[namespace];", "    if (namespaceHandler) {", "        var bindingName = match[2],", "            handlerFn = namespaceHandler.getNamespacedHandler || defaultGetNamespacedHandler,", "            handler = handlerFn.call(namespaceHandler, bindingName, namespace, bindingKey);", "        ko.bindingHandlers[bindingKey] = handler;", "        return handler;", "    }", "});", "", "// Knockout's built-in bindings \"attr\", \"event\", \"css\" and \"style\" include the idea of", "// namespaces, representing it using a single binding that takes an object map of names", "// to values. This default handler translates a binding of \"namespacedName: value\"", "// to \"namespace: {name: value}\" to automatically support those built-in bindings.", "function defaultGetNamespacedHandler(name, namespace, namespacedName) {", "    var handler = ko.utils.extend({}, this);", "    function setHandlerFunction(funcName) {", "        if (handler[funcName]) {", "            handler[funcName] = function(element, valueAccessor) {", "                function subValueAccessor() {", "                    var result = {};", "                    result[name] = valueAccessor();", "                    return result;", "                }", "                var args = Array.prototype.slice.call(arguments, 0);", "                args[1] = subValueAccessor;", "                return ko.bindingHandlers[namespace][funcName].apply(this, args);", "            };", "        }", "    }", "    // Set new init and update functions that wrap the originals", "    setHandlerFunction('init');", "    setHandlerFunction('update');", "    // Clear any preprocess function since preprocessing of the new binding would need to be different", "    if (handler.preprocess)", "        handler.preprocess = null;", "    if (ko.virtualElements.allowedBindings[namespace])", "        ko.virtualElements.allowedBindings[namespacedName] = true;", "    return handler;", "}", "", "// Adds a preprocess function for every generated namespace.x binding. This can", "// be called multiple times for the same binding, and the preprocess functions will", "// be chained. If the binding has a custom getNamespacedHandler method, make sure that", "// it's set before this function is used.", "function addDefaultNamespacedBindingPreprocessor(namespace, preprocessFn) {", "    var handler = ko.getBindingHandler(namespace);", "    if (handler) {", "        var previousHandlerFn = handler.getNamespacedHandler || defaultGetNamespacedHandler;", "        handler.getNamespacedHandler = function() {", "            return addBindingPreprocessor(previousHandlerFn.apply(this, arguments), preprocessFn);", "        };", "    }", "}", "", "function autoNamespacedPreprocessor(value, binding, addBinding) {", "    if (value.charAt(0) !== \"{\")", "        return value;", "", "    // Handle two-level binding specified as \"binding: {key: value}\" by parsing inner", "    // object and converting to \"binding.key: value\"", "    var subBindings = ko.expressionRewriting.parseObjectLiteral(value);", "    ko.utils.arrayForEach(subBindings, function(keyValue) {", "        addBinding(binding + namespaceDivider + keyValue.key, keyValue.value);", "    });", "}", "", "// Set the namespaced preprocessor for a specific binding", "function enableAutoNamespacedSyntax(bindingKeyOrHandler) {", "    addBindingPreprocessor(bindingKeyOrHandler, autoNamespacedPreprocessor);", "}", "", "// Export the preprocessor functions", "ko_punches.namespacedBinding = {", "    defaultGetHandler: defaultGetNamespacedHandler,", "    setDefaultBindingPreprocessor: addDefaultNamespacedBindingPreprocessor,    // for backwards compat.", "    addDefaultBindingPreprocessor: addDefaultNamespacedBindingPreprocessor,", "    preprocessor: autoNamespacedPreprocessor,", "    enableForBinding: enableAutoNamespacedSyntax", "};", "// Wrap a callback function in an anonymous function so that it is called with the appropriate", "// \"this\" value.", "function wrappedCallbackPreprocessor(val) {", "    // Matches either an isolated identifier or something ending with a property accessor", "    if (/^([$_a-z][$\\w]*|.+(\\.\\s*[$_a-z][$\\w]*|\\[.+\\]))$/i.test(val)) {", "        return 'function(_x,_y,_z){return(' + val + ')(_x,_y,_z);}';", "    } else {", "        return val;", "    }", "}", "", "// Set the wrappedCallback preprocessor for a specific binding", "function enableWrappedCallback(bindingKeyOrHandler) {", "    addBindingPreprocessor(bindingKeyOrHandler, wrappedCallbackPreprocessor);", "}", "", "// Export the preprocessor functions", "ko_punches.wrappedCallback = {", "    preprocessor: wrappedCallbackPreprocessor,", "    enableForBinding: enableWrappedCallback", "};", "// Attach a preprocess function to a specific property of a binding. This allows you to", "// preprocess binding \"options\" using the same preprocess functions that work for bindings.", "function addBindingPropertyPreprocessor(bindingKeyOrHandler, property, preprocessFn) {", "    var handler = getOrCreateHandler(bindingKeyOrHandler);", "    if (!handler._propertyPreprocessors) {", "        // Initialize the binding preprocessor", "        chainPreprocessor(handler, 'preprocess', propertyPreprocessor);", "        handler._propertyPreprocessors = {};", "    }", "    // Add the property preprocess function", "    chainPreprocessor(handler._propertyPreprocessors, property, preprocessFn);", "}", "", "// In order to preprocess a binding property, we have to preprocess the binding itself.", "// This preprocess function splits up the binding value and runs each property's preprocess", "// function if it's set.", "function propertyPreprocessor(value, binding, addBinding) {", "    if (value.charAt(0) !== \"{\")", "        return value;", "", "    var subBindings = ko.expressionRewriting.parseObjectLiteral(value),", "        resultStrings = [],", "        propertyPreprocessors = this._propertyPreprocessors || {};", "    ko.utils.arrayForEach(subBindings, function(keyValue) {", "        var prop = keyValue.key, propVal = keyValue.value;", "        if (propertyPreprocessors[prop]) {", "            propVal = propertyPreprocessors[prop](propVal, prop, addBinding);", "        }", "        if (propVal) {", "            resultStrings.push(\"'\" + prop + \"':\" + propVal);", "        }", "    });", "    return \"{\" + resultStrings.join(\",\") + \"}\";", "}", "", "// Export the preprocessor functions", "ko_punches.preprocessBindingProperty = {", "    setPreprocessor: addBindingPropertyPreprocessor,     // for backwards compat.", "    addPreprocessor: addBindingPropertyPreprocessor", "};", "// Wrap an expression in an anonymous function so that it is called when the event happens", "function makeExpressionCallbackPreprocessor(args) {", "    return function expressionCallbackPreprocessor(val) {", "        return 'function('+args+'){return(' + val + ');}';", "    };", "}", "", "var eventExpressionPreprocessor = makeExpressionCallbackPreprocessor(\"$data,$event\");", "", "// Set the expressionCallback preprocessor for a specific binding", "function enableExpressionCallback(bindingKeyOrHandler, args) {", "    var args = Array.prototype.slice.call(arguments, 1).join();", "    addBindingPreprocessor(bindingKeyOrHandler, makeExpressionCallbackPreprocessor(args));", "}", "", "// Export the preprocessor functions", "ko_punches.expressionCallback = {", "    makePreprocessor: makeExpressionCallbackPreprocessor,", "    eventPreprocessor: eventExpressionPreprocessor,", "    enableForBinding: enableExpressionCallback", "};", "", "// Create an \"on\" namespace for events to use the expression method", "ko.bindingHandlers.on = {", "    getNamespacedHandler: function(eventName) {", "        var handler = ko.getBindingHandler('event' + namespaceDivider + eventName);", "        return addBindingPreprocessor(handler, eventExpressionPreprocessor);", "    }", "};", "// Performance comparison at http://jsperf.com/markup-interpolation-comparison", "function parseInterpolationMarkup(textToParse, outerTextCallback, expressionCallback) {", "    function innerParse(text) {", "        var innerMatch = text.match(/^([\\s\\S]*)}}([\\s\\S]*?)\\{\\{([\\s\\S]*)$/);", "        if (innerMatch) {", "            innerParse(innerMatch[1]);", "            outerTextCallback(innerMatch[2]);", "            expressionCallback(innerMatch[3]);", "        } else {", "            expressionCallback(text);", "        }", "    }", "    var outerMatch = textToParse.match(/^([\\s\\S]*?)\\{\\{([\\s\\S]*)}}([\\s\\S]*)$/);", "    if (outerMatch) {", "        outerTextCallback(outerMatch[1]);", "        innerParse(outerMatch[2]);", "        outerTextCallback(outerMatch[3]);", "    }", "}", "", "function trim(string) {", "    return string == null ? '' :", "        string.trim ?", "            string.trim() :", "            string.toString().replace(/^[\\s\\xa0]+|[\\s\\xa0]+$/g, '');", "}", "", "function interpolationMarkupPreprocessor(node) {", "    // only needs to work with text nodes", "    if (node.nodeType === 3 && node.nodeValue && node.nodeValue.indexOf('{{') !== -1 && (node.parentNode || {}).nodeName != \"TEXTAREA\") {", "        var nodes = [];", "        function addTextNode(text) {", "            if (text)", "                nodes.push(document.createTextNode(text));", "        }", "        function wrapExpr(expressionText) {", "            if (expressionText)", "                nodes.push.apply(nodes, ko_punches_interpolationMarkup.wrapExpression(expressionText, node));", "        }", "        parseInterpolationMarkup(node.nodeValue, addTextNode, wrapExpr)", "", "        if (nodes.length) {", "            if (node.parentNode) {", "                for (var i = 0, n = nodes.length, parent = node.parentNode; i < n; ++i) {", "                    parent.insertBefore(nodes[i], node);", "                }", "                parent.removeChild(node);", "            }", "            return nodes;", "        }", "    }", "}", "", "if (!ko.virtualElements.allowedBindings.html) {", "    // Virtual html binding", "    // SO Question: http://stackoverflow.com/a/15348139", "    var overridden = ko.bindingHandlers.html.update;", "    ko.bindingHandlers.html.update = function (element, valueAccessor) {", "        if (element.nodeType === 8) {", "            var html = ko_unwrap(valueAccessor());", "            if (html != null) {", "                var parsedNodes = ko.utils.parseHtmlFragment('' + html);", "                ko.virtualElements.setDomNodeChildren(element, parsedNodes);", "            } else {", "                ko.virtualElements.emptyNode(element);", "            }", "        } else {", "            overridden(element, valueAccessor);", "        }", "    };", "    ko.virtualElements.allowedBindings.html = true;", "}", "", "function wrapExpression(expressionText, node) {", "    var ownerDocument = node ? node.ownerDocument : document,", "        closeComment = true,", "        binding,", "        firstChar = expressionText[0],", "        lastChar = expressionText[expressionText.length - 1],", "        result = [],", "        matches;", "", "    if (firstChar === '#') {", "        if (lastChar === '/') {", "            binding = expressionText.slice(1, -1);", "        } else {", "            binding = expressionText.slice(1);", "            closeComment = false;", "        }", "        if (matches = binding.match(/^([^,\"'{}()\\/:[\\]\\s]+)\\s+([^\\s:].*)/)) {", "            binding = matches[1] + ':' + matches[2];", "        }", "    } else if (firstChar === '/') {", "        // replace only with a closing comment", "    } else if (firstChar === '{' && lastChar === '}') {", "        binding = \"html:\" + trim(expressionText.slice(1, -1));", "    } else {", "        binding = \"text:\" + trim(expressionText);", "    }", "", "    if (binding)", "        result.push(ownerDocument.createComment(\"ko \" + binding));", "    if (closeComment)", "        result.push(ownerDocument.createComment(\"/ko\"));", "    return result;", "};", "", "function enableInterpolationMarkup() {", "    addNodePreprocessor(interpolationMarkupPreprocessor);", "}", "", "// Export the preprocessor functions", "var ko_punches_interpolationMarkup = ko_punches.interpolationMarkup = {", "    preprocessor: interpolationMarkupPreprocessor,", "    enable: enableInterpolationMarkup,", "    wrapExpression: wrapExpression", "};", "", "", "var dataBind = 'data-bind';", "function attributeInterpolationMarkerPreprocessor(node) {", "    if (node.nodeType === 1 && node.attributes.length) {", "        var dataBindAttribute = node.getAttribute(dataBind);", "        for (var attrs = ko.utils.arrayPushAll([], node.attributes), n = attrs.length, i = 0; i < n; ++i) {", "            var attr = attrs[i];", "            if (attr.specified && attr.name != dataBind && attr.value.indexOf('{{') !== -1) {", "                var parts = [], attrValue = '';", "                function addText(text) {", "                    if (text)", "                        parts.push('\"' + text.replace(/\"/g, '\\\\\"') + '\"');", "                }", "                function addExpr(expressionText) {", "                    if (expressionText) {", "                        attrValue = expressionText;", "                        parts.push('ko.unwrap(' + expressionText + ')');", "                    }", "                }", "                parseInterpolationMarkup(attr.value, addText, addExpr);", "", "                if (parts.length > 1) {", "                    attrValue = '\"\"+' + parts.join('+');", "                }", "", "                if (attrValue) {", "                    var attrName = attr.name.toLowerCase();", "                    var attrBinding = ko_punches_attributeInterpolationMarkup.attributeBinding(attrName, attrValue, node) || attributeBinding(attrName, attrValue, node);", "                    if (!dataBindAttribute) {", "                        dataBindAttribute = attrBinding", "                    } else {", "                        dataBindAttribute += ',' + attrBinding;", "                    }", "                    node.setAttribute(dataBind, dataBindAttribute);", "                    // Using removeAttribute instead of removeAttributeNode because IE clears the", "                    // class if you use removeAttributeNode to remove the id.", "                    node.removeAttribute(attr.name);", "                }", "            }", "        }", "    }", "}", "", "function attributeBinding(name, value, node) {", "    if (ko.getBindingHandler(name)) {", "        return name + ':' + value;", "    } else {", "        return 'attr.' + name + ':' + value;", "    }", "}", "", "function enableAttributeInterpolationMarkup() {", "    addNodePreprocessor(attributeInterpolationMarkerPreprocessor);", "}", "", "var ko_punches_attributeInterpolationMarkup = ko_punches.attributeInterpolationMarkup = {", "    preprocessor: attributeInterpolationMarkerPreprocessor,", "    enable: enableAttributeInterpolationMarkup,", "    attributeBinding: attributeBinding", "};", "", "    return ko_punches;", "}));"]}, {"lines": ["    } else if (typeof module === \"object\") {"]}, {"lines": ["        // NOTE: Added by @sloria"]}, {"lines": ["        // CommonJS module", "        var ko = require(\"knockout\");", "        var jQuery = require(\"jquery\");", "        require(\"jquery.ui.sortable\");", "        factory(ko, jQuery);"]}, {"lines": ["        dataSet = ko.utils.domData.set,", "        version = $.ui && $.ui.version,", "        //1.8.24 included a fix for how events were triggered in nested sortables. indexOf checks will fail if version starts with that value (0 vs. -1)", "        hasNestedSortableFix = version && version.indexOf(\"1.6.\") && version.indexOf(\"1.7.\") && (version.indexOf(\"1.8.\") || version === \"1.8.24\");"]}, {"lines": ["    //internal afterRender that adds metadata to children"]}, {"lines": ["        //use an afterRender function to add metadata"]}, {"lines": ["    //remove problematic leading/trailing whitespace from templates", "    var stripTemplateWhitespace = function(element, name) {", "        var templateSource,", "            templateElement;", "", "        //process named templates", "        if (name) {", "            templateElement = document.getElementById(name);", "            if (templateElement) {", "                templateSource = new ko.templateSources.domElement(templateElement);", "                templateSource.text($.trim(templateSource.text()));", "            }", "        }", "        else {", "            //remove leading/trailing non-elements from anonymous templates", "            $(element).contents().each(function() {", "                if (this && this.nodeType !== 1) {", "                    element.removeChild(this);", "                }", "            });", "        }", "    };", ""]}, {"lines": ["            stripTemplateWhitespace(element, templateOptions.name);"]}, {"lines": ["                        if (item && (this === parentEl) || (!hasNestedSortableFix && $.contains(this, parentEl))) {"]}, {"lines": ["                            //build up args for the callbacks"]}, {"lines": ["", "                                //execute the configured callback prior to actually moving items", "                                if (sortable.beforeMove) {", "                                    sortable.beforeMove.call(this, arg, event, ui);", "                                }"]}, {"lines": ["                            //call cancel on the correct list, so KO can take care of DOM manipulation", "                            if (sourceParent) {", "                                $(sourceParent === targetParent ? this : ui.sender || this).sortable(\"cancel\");", "                            }", "                            //for a draggable item just remove the element", "                            else {", "                                $(el).remove();", "                            }"]}, {"lines": ["                            //if beforeMove told us to cancel, then we are done", "                            if (arg && arg.cancelDrop) {", "                                return;"]}, {"lines": ["                            //do the actual move"]}, {"lines": ["            value = \"data\" in value ? value.data : value;"]}, {"lines": ["});"]}, {"lines": ["<% from website import settings %>"]}, {"lines": ["<!DOCTYPE html>", "<html lang=\"en\">", "<head>", "    <meta charset=\"utf-8\">"]}, {"lines": ["    % if settings.GOOGLE_SITE_VERIFICATION:", "        <meta name=\"google-site-verification\" content=\"${settings.GOOGLE_SITE_VERIFICATION}\" />", "    % endif"]}, {"lines": ["    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">", "    <meta name=\"description\" content=\"${self.description()}\">"]}, {"lines": ["    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">"]}, {"lines": [""]}, {"lines": ["    ${self.stylesheets()}"]}, {"lines": ["    <script src=\"${\"/static/public/js/base-page.js\" | webpack_asset}\"></script>"]}, {"lines": ["    ${self.javascript()}", ""]}, {"lines": ["</head>"]}, {"lines": ["    % if dev_mode:", "    <style>", "        #devmode {", "            position:fixed;", "            bottom:0;", "            left:0;", "            border-top-right-radius:8px;", "            background-color:red;", "            color:white;", "            padding:.5em;", "        }", "    </style>", "    <div id='devmode'><strong>WARNING</strong>: This site is running in development mode.</div>", "    % endif", ""]}, {"lines": ["     ## TODO: shouldn't always have the watermark class"]}, {"lines": [""]}, {"lines": ["        % if settings.PINGDOM_ID:"]}, {"lines": ["            var _prum = [['id', '${settings.PINGDOM_ID}'],", "                            ['mark', 'firstbyte', (new Date()).getTime()]];"]}, {"lines": ["                    , p = document.createElement('script');"]}, {"lines": ["        % endif"]}, {"lines": ["        % if settings.GOOGLE_ANALYTICS_ID:"]}, {"lines": ["            ga('create', '${settings.GOOGLE_ANALYTICS_ID}', 'auto', {'allowLinker': true});"]}, {"lines": ["            </script>"]}, {"lines": ["        % endif"]}, {"lines": ["        % endif", ""]}, {"lines": ["", "        % if piwik_host:"]}, {"lines": ["                        <% parent_project = parent_node.get('id') or node.get('id') %>"]}, {"lines": ["                    $.osf.trackPiwik(\"${ piwik_host }\", ${ piwik_site_id }, cvars, true);"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        ${self.javascript_bottom()}", "    </body>", "</html>", "", "", "###### Base template functions #####", "", "<%def name=\"title()\">", "    ### The page title ###", "</%def>", ""]}, {"lines": ["<%def name=\"description()\">", "    ### The page description ###", "</%def>", ""]}, {"lines": ["<%def name=\"stylesheets()\">", "    ### Extra css for this page. ###", "</%def>", ""]}, {"lines": ["<%def name=\"javascript()\">", "    ### Additional javascript, loaded at the top of the page ###", "</%def>", "", "<%def name=\"content()\">", "    ### The body content. ###", "</%def>", "", "<%def name=\"javascript_bottom()\">", "    ### Javascript loaded at the bottom of the page ###", "</%def>"]}, {"lines": [""]}, {"lines": ["    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->", "    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->"]}, {"lines": ["      <script src=\"https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js\"></script>", "      <script src=\"https://oss.maxcdn.com/respond/1.4.2/respond.min.js\"></script>"]}, {"lines": ["      <script src=\"//cdnjs.cloudflare.com/ajax/libs/es5-shim/4.0.3/es5-shim.min.js\"></script>", "      <script src=\"//cdnjs.cloudflare.com/ajax/libs/es5-shim/4.0.3/es5-sham.min.js\"></script>"]}, {"lines": ["    ## TODO: Get fontawesome and select2 to play nicely with webpack"]}, {"lines": ["    <link rel=\"stylesheet\" href=\"/static/vendor/bower_components/bootstrap/dist/css/bootstrap.min.css\">"]}, {"lines": ["    <link rel=\"stylesheet\" href=\"/static/vendor/bower_components/select2/select2.css\">"]}, {"lines": [""]}, {"lines": ["    ## NOTE: We load vendor bundle  at the top of the page because contains", "    ## the webpack runtime and a number of necessary stylesheets which should be loaded before the user sees"]}, {"lines": ["    ## content.", "    <script src=\"${\"/static/public/js/vendor.js\" | webpack_asset}\"></script>"]}, {"lines": [""]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">Claim Contributor</%def>", "<%def name=\"content()\">", "<h1 class=\"page-header text-center\">Claim Contributor</h1>", "", "<div class=\"row\">", "    ## Center the form", "    <div class=\"col-md-6 col-md-offset-3\">", "    <p>Please enter your credentials to continue.</p>", "", "        <form method=\"POST\" id='claimContributorForm' role='form'>", "            <div class='form-group'>", "                <input type=\"text\" class='form-control' value=\"${user.username}\" disabled/>", "            </div>", "            <div class='form-group'>", "                ${form.password(placeholder='Password', autofocus=True)}", "            </div>", "", "            %if next_url:", "                <input type='hidden' name='next_url' value='${next_url}'>", "            %endif", "            <span class='help-text'>"]}, {"lines": ["                <a id=\"signOutLink\" href='${signOutUrl}'>I am <strong>not</strong> <em>${user.fullname}</em>.</a>"]}, {"lines": ["            </span>", "            <button type='submit' class=\"btn btn-submit btn-primary pull-right\">Submit</button>", "        </form>", "", "    </div>", "</div>", "</%def>", ""]}, {"lines": ["<%inherit file=\"base.mako\"/>"]}, {"lines": ["<%def name=\"content()\">"]}, {"lines": ["<div class=\"container\">"]}, {"lines": ["        <div class='col-md-12'>"]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"base.mako\"/>"]}, {"lines": ["<%def name=\"title()\">Home</%def>"]}, {"lines": ["                              <input type=\"password\" class=\"form-control\" placeholder=\"Password (Must be 6 to 256 characters)\" data-bind=\" value: password, disable: submitted(), event: {blur: trim.bind($data, password)}\">"]}, {"lines": ["          <h3>Cloud-based management for your projects.</h3>"]}, {"lines": ["              <p><strong>Connect your favorite third party services</strong> directly to the Open Science Framework.  <span class=\"label label-primary\">3rd Party Integrations</span></p>"]}, {"lines": ["            <h2>OSF integrations make your <strong>workflow more efficient</strong></h2>"]}, {"lines": ["            <p>Computer or collaborator explode? With the OSF <strong>you will never lose your project data.</strong></p>"]}, {"lines": ["            <p>The OSF helps individuals, teams and labs make their <strong>research processes more efficient.</strong></p>"]}, {"lines": ["              <p>Labs and teams across the globe use the Open Science Framework to open their projects up to the scientific community. You can browse the newest and most popular public projects <a href=\"/explore/activity/\">right here</a>. <span class=\"label label-warning\">Get involved</span></p>"]}, {"lines": ["              <p>The OSF is a free, open-source service of the <a href=\"https://cos.io/\">Center for Open Science</a>. We\u2019re aligning scientific practices with scientific values by improving openness, integrity and reproducibility of research. <span class=\"label label-success\">Non-Profit</span></p>"]}, {"lines": ["            <p>The OSF helps our students understand and apply sound data management principles to their work. And since we have easy access to all of the files the students are working with, it greatly enhances our ability to offer them constructive guidance.<br/><small><em>Richard Ball, Professor of Economics, Haverford College</em></small></em></small></p>"]}, {"lines": ["            <p>The OSF makes version control effortless. My PI, my lab mates, and I have access to previous versions of a file at any time&#151;and the most current version is always readily available.<br/><small><em>Erica Baranski, PhD Student, Social and Personality Psychology Funder Lab, UC Riverside</em></small></em></small></p>"]}, {"lines": ["    </div>"]}, {"lines": ["            <h4>The OSF is a public good built to support your research.</h4>"]}, {"lines": ["</%def>"]}, {"lines": ["</%def>"]}, {"lines": ["## Knockout templates for OSF-core (non-addon) logs. Used by logFeed.js to render the log feed", "## the id attribute of each script tag corresponds to NodeLog action.", "## When the application is initialized, this mako template is concatenated with the addons'", "## log templates. An addon's log templates are located in"]}, {"lines": ["## website/addons/<addon_name>/templates/log_templates.mako."]}, {"lines": [""]}, {"lines": ["<script type=\"text/html\" id=\"embargo_approved_no_user\">", "Embargo for", "<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a> approved", "</script>", ""]}, {"lines": ["completed embargo of"]}, {"lines": ["<script type=\"text/html\" id=\"embargo_completed_no_user\">", "Embargo for", "<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a> completed", "</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"project_created\">"]}, {"lines": ["</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"node_created\">"]}, {"lines": ["</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"contributor_added\">"]}, {"lines": ["</script>", "", "<script type=\"text/html\" id=\"contributor_removed\">"]}, {"lines": ["</script>", ""]}, {"lines": ["</script>", "", "<script type=\"text/html\" id=\"made_public\">"]}, {"lines": ["</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"made_public_no_user\">", "    <a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a> made public", "</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"made_private\">"]}, {"lines": ["</script>", "", "<script type=\"text/html\" id=\"tag_added\">", "tagged"]}, {"lines": ["</script>", "", "<script type=\"text/html\" id=\"tag_removed\">"]}, {"lines": ["</script>", "", "<script type=\"text/html\" id=\"edit_title\">"]}, {"lines": ["</script>", "", "<script type=\"text/html\" id=\"project_registered\">"]}, {"lines": ["</script>", ""]}, {"lines": ["</script>", ""]}, {"lines": ["</script>", ""]}, {"lines": ["</script>", ""]}, {"lines": ["</script>", ""]}, {"lines": ["</script>"]}, {"lines": [""]}, {"lines": ["</script>"]}, {"lines": ["    <div class=\"container\">"]}, {"lines": ["        % if user_name:", "            <li><a href=\"/dashboard/\">My Dashboard</a></li>"]}, {"lines": ["            <li><a href=\"/explore/activity/\">Browse New Projects</a></li>", "        % endif"]}, {"lines": ["</nav>"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">Resend Confirmation Email</%def>", "<%def name=\"content()\">", "<h1 class=\"page-header text-center\">Resend Confirmation Email</h1>", "", "<div class=\"row\">", "    ## Center the form", "    <div class=\"col-md-6 col-md-offset-3\">", "        <p class='help'>Enter your email address and we'll resend your", "        confirmation link.", "        </p>", "", "        <form id='resendForm' method='POST' class='form' role='form'>", "            <div class='form-group'>", "                ${form.email(placeholder='Email address', autofocus=True)}", "            </div>", "", "            <button type='submit' class='btn btn-primary'>Submit</button>", "        </form>", "    </div>", "</div>", "</%def>"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"content()\">"]}, {"lines": ["    % for node in nodes:", "        <a href=\"${node['url']}\">${node['title']}</a>", "    % endfor"]}, {"lines": ["</%def>"]}, {"lines": ["Hello ${user.fullname},", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["<% from website import util %>"]}, {"lines": ["                ${Node.load(key).title}"]}, {"lines": ["                %endif"]}, {"lines": ["                    %endfor"]}, {"lines": ["Dear ${user.fullname},"]}, {"lines": ["You are receiving this message because you have an Open Science Framework (OSF) account.  We are writing to let you know of a change to our registrations that may affect how you choose to use that feature."]}, {"lines": ["Registrations create a frozen, time-stamped snapshot of the project and its contents.  Registrations are used for archiving significant events in the research lifecycle, such as pre-registering an analysis plan prior to data collection, and they cannot be deleted.  As early as June 8, 2015, upon creating a registration, you will choose to make it public immediately or set an embargo period, which will keep the project contents private for up to one year, other than the title, description, creation date, embargo period, and contributors.  Users will be able to end the embargo early, but they will not be able to stop the registration from becoming public after the embargo.  Instead, to remove a public registration, users will have to retract it - similar to retraction of a published article.  The same information that is available during the embargo would remain, but all other project content would be inaccessible and replaced with a retraction notice."]}, {"lines": ["This change removes the possibility of having a permanently private registration.  The change also adds features to promote persistence and preservation.  OSF registrations will receive persistent identifiers (DOI and/or ARKid), and files will be archived to preserve the content.  Finally, when one project administrator registers the project, all contributors are notified of the registration and all project administrators will have 48 hours to cancel the registration before it is made permanent.  We believe that these changes better align the registration function with the expectations of what registration should do."]}, {"lines": ["How will this affect you?  The new functionality will not apply to existing private OSF registrations - they can remain private.  If you have any public OSF registrations or ever decide to make those private registrations public, you will not be able to make them private.  If you want to avoid this, then you must set your public registrations to private before June 8, 2015.  As of June 8, 2015, all new registrations will become public immediately or following their embargo date.  As such, treat registration like journal publication - it is difficult to go back."]}, {"lines": ["Follow this link to reset your password", "", "${reset_link}"]}, {"lines": ["Hello ${referrer.fullname},", "", "You recently added ${fullname} to \"${node.title}\". ${fullname} wants to claim their account, but the email address they provided is different from the one you provided.  To maintain security of your project, we are sending the account confirmation to you first.", "", "IMPORTANT: To ensure that the correct person is added to your project please forward the message below to ${fullname}.", "", "After ${fullname} confirms their account, they will be able to contribute to the project.", "", "----------------------", "", "Hello ${fullname},", ""]}, {"lines": ["", "${claim_url}", ""]}, {"lines": ["", "Sincerely,", "", "The OSF Team", "", ""]}, {"lines": ["Hello ${fullname},", "", "We received your request to become a contributor for \"${node.title}\".", "", "To confirm your identity, ${referrer.fullname} has been sent an email to forward to you with your confirmation link.", "", "This link will allow you to contribute to \"${node.title}\".", "", "Thank you for your patience.", "", "Sincerely,", "", "The OSF Team", "", "More information? Visit http://osf.io/ and http://cos.io/ for information about the Open Science Framework and its supporting organization, the Center for Open Science.", "", "Questions? Email contact@osf.io"]}, {"lines": ["Currently, project administrators can view the contents of components in their projects only if they are listed as contributors on those components. However, two weeks from today on February 20, project administrators will have read-only access to sub-components of their projects even if they are not listed as a contributor. This means that administrators can see the component and its contents."]}, {"lines": ["For example, if Thomas, Nikola, and Angus are administrators on project \"AC/DC\", but Angus is the sole contributor to a subcomponent \"High Voltage\" within that project, then Thomas and Nikola will now be able to view the contents of \"High Voltage\"."]}, {"lines": ["Please do let us know if you have any questions or would like help in addressing the organization of your projects."]}, {"lines": ["Note: In system-wide security messages, we will not ask you to click on links or ask you for information - passwords or otherwise."]}, {"lines": ["Hello <p>${name}</p>"]}, {"lines": ["<div class=\"scripted\" id=\"commentPane\">"]}, {"lines": ["                            <span class=\"overflow\"", "                              data-bind=\"html: contentDisplay, css: {'edit-comment': editHighlight}, event: {mouseenter: startHoverContent, mouseleave: stopHoverContent}\"></span>"]}, {"lines": ["                            <span data-bind=\"if: canEdit, click: edit\">", "                                <i class=\"fa fa-pencil\"></i>", "                            </span>"]}, {"lines": ["<% import json %>"]}, {"lines": ["    ## Make Mako variables accessible to JS modules.", "    ## TODO: This information should be fetched from a JSON endpoint.", "    window.contextVars = window.contextVars || {};", "    window.contextVars.node = window.contextVars.node || {};", "    window.contextVars.node.urls = window.contextVars.node.urls || {};", "    window.contextVars.node.urls.api = ${json.dumps(node['api_url'])};", "    window.contextVars.node.id = ${json.dumps(str(node['id']))};", "    window.contextVars.node.children = ${[str(each) for each in children_ids]};", "    window.contextVars.regTemplate = ${json.dumps(template_name or '')};", "    window.contextVars.regSchema = ${schema};", "    window.contextVars.regPayload = ${json.dumps(payload)};", "    window.contextVars.registered = ${json.dumps(int(registered))};"]}, {"lines": ["                                              <input placeholder=\"Email address\" data-bind=\"value: emailInput\" class=\"form-control\">"]}, {"lines": ["<%def name=\"content()\">"]}, {"lines": ["    <div class=\"col-sm-3\">"]}, {"lines": ["    <div class=\"col-sm-9 col-md-7\">"]}, {"lines": ["</%def>"]}, {"lines": ["<%def name=\"javascript_bottom()\">"]}, {"lines": ["    ${parent.javascript_bottom()}"]}, {"lines": ["    ## Webpack bundles", "    % for js_asset in addon_js:", "      <script src=\"${js_asset | webpack_asset}\"></script>", "    % endfor"]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">Settings</%def>", "<%def name=\"content()\">"]}, {"lines": [""]}, {"lines": ["##    <div class=\"col-sm-6\">"]}, {"lines": ["", "<div class=\"row\">"]}, {"lines": ["    <div class=\"col-sm-3\">"]}, {"lines": ["        <div class=\"panel panel-default\">"]}, {"lines": ["    <div class=\"col-sm-9 col-md-7\">"]}, {"lines": ["            <div class=\"tab-content\" id=\"containDrag\">"]}, {"lines": ["            </div>"]}, {"lines": ["    </div>"]}, {"lines": ["</div>"]}, {"lines": ["</%def>"]}, {"lines": ["<%def name=\"javascript_bottom()\">"]}, {"lines": ["    ## Store mako variables on window so they are accessible from JS"]}, {"lines": ["    ## modules. Not sure if this is a good idea.", "    window.contextVars = window.contextVars || {};", "    window.contextVars.nameUrls = {", "        crud: '${ api_url_for('serialize_names') }',", "        impute: '${ api_url_for('impute_names') }'", "    };", "    window.contextVars.socialUrls = {", "        crud: '${ api_url_for('serialize_social') }'", "    };", "    window.contextVars.jobsUrls = {", "        crud: '${ api_url_for('serialize_jobs') }'", "    };", "    window.contextVars.schoolsUrls = {", "        crud: '${ api_url_for('serialize_schools') }'", "    };"]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"project/project_base.mako\"/>"]}, {"lines": ["${parent.stylesheets()}"]}, {"lines": ["</%def>"]}, {"lines": [""]}, {"lines": ["${parent.javascript_bottom()}"]}, {"lines": ["    window.contextVars = window.contextVars || {};"]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"project/project_base.mako\"/>"]}, {"lines": ["<%def name=\"title()\">Key History</%def>"]}, {"lines": ["        \"uri\": \"${node[\"api_url\"]}keys/\","]}, {"lines": ["            \"route\": \"${node[\"api_url\"]}\""]}, {"lines": ["<div id=\"addContributors\" class=\"modal fade\">"]}, {"lines": ["            <div class=\"modal-header\">"]}, {"lines": ["                <h3 data-bind=\"text:pageTitle\"></h3>"]}, {"lines": ["            </div>"]}, {"lines": [""]}, {"lines": ["            <div class=\"modal-body\">"]}, {"lines": ["", "                <!-- Whom to add -->", ""]}, {"lines": ["                <div data-bind=\"if: page() == 'whom'\">"]}, {"lines": ["", "                    <!-- Find contributors -->"]}, {"lines": ["                                            data-bind=\"value:query\"", "                                            placeholder='Search by name' autofocus/>"]}, {"lines": ["                                </div>"]}, {"lines": ["                            </div>"]}, {"lines": ["                        </div>", "                    </form>", "", "                    <hr />", "", "                    <!-- Choose which to add -->", "                    <div class=\"row\">", ""]}, {"lines": ["                        <div class=\"col-md-6\">"]}, {"lines": ["                            <div>", "                                <span class=\"modal-subheader\">Results</span>", "                                <a data-bind=\"click:addAll\">Add all</a>", "                            </div>"]}, {"lines": ["                            <table>"]}, {"lines": ["                                <tbody data-bind=\"foreach:{data:results, as: 'contributor', afterRender:addTips}\">"]}, {"lines": ["                                    <tr data-bind=\"if:!($root.selected($data))\">", "                                        <td style=\"padding-right: 10px;\">", "                                            <a"]}, {"lines": ["                                                    data-bind=\"click:$root.add, tooltip: {title: 'Add contributor'}\""]}, {"lines": ["                                                >+</a>", "                                        </td>", "                                        <td>"]}, {"lines": ["                                        </td>"]}, {"lines": ["                                    </tr>"]}, {"lines": ["                                </tbody>", "                            </table>"]}, {"lines": ["                            <!-- Link to add non-registered contributor -->", "                            <div class='help-block'>", "                                <div data-bind='if: foundResults'>"]}, {"lines": ["                                </div>"]}, {"lines": ["                                <div data-bind=\"if: noResults\">"]}, {"lines": ["                                    No results found. Try a more specific search or <strong><a href=\"#\""]}, {"lines": ["                                    data-bind=\"click:gotoInvite\">add <em>{{query}}</em> as an unregistered contributor</a>.</strong>"]}, {"lines": ["                                </div>", "                            </div>"]}, {"lines": ["                        </div><!-- ./col-md -->"]}, {"lines": ["", "                        <div class=\"col-md-6\">", "                            <div>", "                                <span class=\"modal-subheader\">Adding</span>", "                                <a data-bind=\"click:removeAll\">Remove all</a>", "                            </div>"]}, {"lines": ["", "                            <!-- TODO: Duplication here: Put this in a KO template -->"]}, {"lines": ["                                    <tr>", "                                        <td style=\"padding-right: 10px;\">", "                                            <a"]}, {"lines": ["                                                    data-bind=\"click:$root.remove, tooltip: {title: 'Remove contributor'}\""]}, {"lines": ["                                                >-</a>", "                                        </td>", "                                        <td>"]}, {"lines": ["                                        </td>"]}, {"lines": ["                                    </tr>", "                                </tbody>", "                            </table>", "                        </div>", ""]}, {"lines": ["                    </div>", ""]}, {"lines": ["                </div>"]}, {"lines": ["                <!-- Component selection page -->"]}, {"lines": ["                <div data-bind=\"if:page()=='which'\">", "", "                    <div>", "                        Adding contributor(s)", "                        <span data-bind=\"text:addingSummary()\"></span>", "                        to component", "                        <span data-bind=\"text:title\"></span>.", "                    </div>", "", "                    <hr />", "", "                    <div style=\"margin-bottom:10px;\">"]}, {"lines": ["                    </div>", "", "                    <div class=\"row\">", "", "                        <div class=\"col-md-6\">", "                            <input type=\"checkbox\" checked disabled />", "                            <span data-bind=\"text:title\"></span> (current component)", "                            <div data-bind=\"foreach:nodes\">"]}, {"lines": ["                                    <input type=\"checkbox\" data-bind=\"checked:$parent.nodesToChange, value:id\" />", "                                    <span data-bind=\"text:title\"></span>", "                                </div>", "                            </div>", "                        </div>", "", "                        <div class=\"col-md-6\">", "                            <div>", "                                <a data-bind=\"click:selectNodes, css:{disabled:cantSelectNodes()}\">Select all</a>", "                            </div>", "                            <div>", "                                <a data-bind=\"click:deselectNodes, css:{disabled:cantDeselectNodes()}\">De-select all</a>", "                            </div>", "                        </div>", "", "                    </div>", ""]}, {"lines": ["                </div><!-- end component selection page -->", ""]}, {"lines": ["                <!-- Invite user page -->"]}, {"lines": ["                <div data-bind='if:page() === \"invite\"'>", "                    <form class='form'>"]}, {"lines": ["                        <div class=\"form-group\">", "                            <label for=\"inviteUserName\">Full Name</label>", "                            <input type=\"text\" class='form-control' id=\"inviteName\""]}, {"lines": ["                                placeholder=\"Full name\" data-bind='value: inviteName, valueUpdate: \"input\"'/>"]}, {"lines": ["                        </div>", "                        <div class=\"form-group\">", "                            <label for=\"inviteUserEmail\">Email</label>", "                            <input type=\"email\" class='form-control' id=\"inviteUserEmail\""]}, {"lines": ["                                    placeholder=\"Email\" data-bind='value: inviteEmail' autofocus/>"]}, {"lines": ["                        </div>"]}, {"lines": ["                         <div class=\"help-block\">"]}, {"lines": ["                            <p>We will notify the user that they have been added to your project.</p>"]}, {"lines": ["                            <p class='text-danger' data-bind='text: inviteError'></p>", "                        </div>", "                    </form>", "                </div><!-- end invite user page -->"]}, {"lines": [""]}, {"lines": ["            </div><!-- end modal-body -->"]}, {"lines": [""]}, {"lines": ["            <div class=\"modal-footer\">"]}, {"lines": [""]}, {"lines": ["                <a href=\"#\" class=\"btn btn-default\" data-bind=\"click: clear\" data-dismiss=\"modal\">Cancel</a>"]}, {"lines": [""]}, {"lines": ["                <span data-bind=\"if: page() === 'invite'\">", "                    <button class=\"btn btn-primary\" data-bind='click:selectWhom'>Back</button>", "                    <button class='btn btn-success'", "                         data-bind='click: postInvite'", "                                    type=\"submit\">Add</button>", "                </span>"]}, {"lines": ["", "                <span data-bind=\"if:selection().length && page() == 'whom'\">", "                    <a class=\"btn btn-success\" data-bind=\"visible:nodes().length==0, click:submit\">Submit</a>", "                    <a class=\"btn btn-primary\" data-bind=\"visible:nodes().length, click:selectWhich\">Next</a>"]}, {"lines": ["                </span>"]}, {"lines": [""]}, {"lines": ["                <span data-bind=\"if: page() == 'which'\">"]}, {"lines": ["                    <a class=\"btn btn-primary\" data-bind=\"click:selectWhom\">Back</a>", "                    <a class=\"btn btn-success\" data-bind=\"click:submit\">Submit</a>", "                </span>", "", "            </div><!-- end modal-footer -->"]}, {"lines": ["        </div><!-- end modal-content -->", "    </div><!-- end modal-dialog -->", "</div><!-- end modal -->"]}, {"lines": ["<%inherit file=\"../base.mako\"/>", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["<%def name=\"content()\">"]}, {"lines": ["<%include file=\"project_header.mako\"/>"]}, {"lines": ["<%include file=\"modal_show_links.mako\"/>"]}, {"lines": [""]}, {"lines": ["% endif"]}, {"lines": [""]}, {"lines": ["", "<%def name=\"javascript_bottom()\">"]}, {"lines": [""]}, {"lines": ["<script>"]}, {"lines": ["    ## TODO: port to commonjs", "    ## $script(['/static/addons/badges/badge-awarder.js'], function() {", "    ##     attachDropDown('${'{}badges/json/'.format(user_api_url)}');", "    ## });"]}, {"lines": ["    var nodeId = '${node['id']}';", "    var userApiUrl = '${user_api_url}';", "    var nodeApiUrl = '${node['api_url']}';"]}, {"lines": ["    <%"]}, {"lines": ["           parent_registration_url = parent_node['registrations_url']"]}, {"lines": [""]}, {"lines": ["    // Mako variables accessible globally"]}, {"lines": ["        currentUser: {"]}, {"lines": ["            id: '${user_id}',"]}, {"lines": ["            urls: {api: userApiUrl},"]}, {"lines": ["            isContributor: ${json.dumps(user.get('is_contributor', False))},", "            fullname: ${json.dumps(user['fullname']) | n}"]}, {"lines": ["        },", "        node: {"]}, {"lines": ["            id: nodeId,", "            title: ${json.dumps(node['title']) | n},"]}, {"lines": ["                api: nodeApiUrl,"]}, {"lines": ["                update: ${json.dumps(node['update_url'])}"]}, {"lines": ["            isPublic: ${json.dumps(node.get('is_public', False))},"]}, {"lines": ["            piwikSiteID: ${json.dumps(node.get('piwik_site_id', None))},"]}, {"lines": ["            piwikHost: ${json.dumps(piwik_host)},"]}, {"lines": ["            parentTitle: ${json.dumps(parent_title) | n},"]}, {"lines": ["        }"]}, {"lines": [""]}, {"lines": ["</script>"]}, {"lines": ["<script type=\"text/x-mathjax-config\">"]}, {"lines": ["    MathJax.Hub.Config({"]}, {"lines": ["        tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']], processEscapes: true},"]}, {"lines": ["        // Don't automatically typeset the whole page. Must explicitly use MathJax.Hub.Typeset", "        skipStartupTypeset: true", "    });"]}, {"lines": ["</script>", "<script type=\"text/javascript\""]}, {"lines": ["</script>", ""]}, {"lines": ["## NOTE: window.contextVars must be set before loading this script"]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"project/project_base.mako\"/>"]}, {"lines": ["<legend class=\"text-center\">Register</legend>"]}, {"lines": ["    <form role=\"form\">"]}, {"lines": ["        <select class=\"form-control\" id=\"select-registration-template\">"]}, {"lines": ["    </form>", ""]}, {"lines": ["                urlparse[0] += '/' + val;"]}, {"lines": ["", "<%def name=\"javascript_bottom()\">"]}, {"lines": ["</%def>"]}, {"lines": ["                Retracting a registration will remove its content from the OSF, but leave basic metadata behind."]}, {"lines": ["<%inherit file=\"project/project_base.mako\"/>"]}, {"lines": ["##<!-- Show API key settings -->", "##<div mod-meta='{", "##        \"tpl\": \"util/render_keys.mako\","]}, {"lines": ["##        \"uri\": \"${node[\"api_url\"]}keys/\","]}, {"lines": ["##        \"replace\": true,", "##        \"kwargs\": {"]}, {"lines": ["##            \"route\": \"${node[\"url\"]}\""]}, {"lines": ["##        }", "##    }'></div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                    </div>", "                    <div class=\"help-block\" style=\"padding-left: 15px\">"]}, {"lines": ["                    </div>"]}, {"lines": ["                            <h3 class=\"panel-title\">Retract Registration</h3>"]}, {"lines": ["<%def name=\"render_node_settings(data)\">", "    <%"]}, {"lines": ["    %>", "    ${tpl}", "</%def>", ""]}, {"lines": ["<%def name=\"javascript_bottom()\">"]}, {"lines": ["    <script>", "      window.contextVars = window.contextVars || {};", "      window.contextVars.node = window.contextVars.node || {};", "      window.contextVars.node.nodeType = '${node['node_type']}';"]}, {"lines": ["    </script>"]}, {"lines": ["    % for js_asset in addon_js:"]}, {"lines": ["    % endfor", ""]}, {"lines": ["</%def>"]}, {"lines": ["    % if 'osf.io' in domain:", "    <script>", "        // IE10 Same Origin (CORS) fix", "        document.domain = 'osf.io';"]}, {"lines": ["    </script>", "    %endif"]}, {"lines": ["    <script type=\"text/javascript\">", "      window.contextVars = $.extend(true, {}, window.contextVars, {"]}, {"lines": ["        file: {"]}, {"lines": ["            extra: ${extra},"]}, {"lines": ["            name: '${file_name | js_str}',", "            path: '${file_path | js_str}',", "            provider: '${provider | js_str}',"]}, {"lines": ["        },", "        node: {", "          urls: {"]}, {"lines": ["          }", "        },"]}, {"lines": ["        currentUser: {", "          canEdit: ${int(user['can_edit'])}"]}, {"lines": ["      });", "    </script>"]}, {"lines": ["                    <!-- ko if: !title --><em>Private project</em><!-- /ko -->"]}, {"lines": ["</div>"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">Coming soon</%def>", "<%def name=\"content()\">"]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">About</%def>", "<%def name=\"content()\">"]}, {"lines": ["    Open Science Framework (OSF) in conjunction with the broader Open Science Collaboration (OSC) is an open collaboration of scientists to increase the alignment between scientific values and scientific practices (<a href=\"/howosfworks\">How the OSF works</a>).  Efforts include development of tools and infrastructure, and conducting research about scientific practices."]}, {"lines": ["Done well, open science collaboration can radically transform scientific practice.", "Scientific expertise is distributed across many minds,", "but scientific problems are rarely localized to the existing expertise of one or a few minds.", "Broadcasting problems openly increases the odds a person with the right expertise will see it and be able to solve it easily.", "This means that solutions can be identified quickly rather than requiring lots of additional self-training by the idea originator"]}, {"lines": ["Likewise, with many people drawing on distinct expertise,", "novel solutions may emerge rapidly that would not have been identified by individuals or small groups.", "In addition to better and faster problem-solving,", "open projects can be more ambitious because more areas of expertise (and hands) can contribute to a problem without as much time or resource investment by any individual.", "For example, it is much easier to contribute on issues that are central to one's skills/expertise than to build new expertise.", "Simultaneously knowledge gain for each contributor can be rapid because they learn from each other's contributions on a shared problem.", "Finally, there are many ways to contribute productively on large-scale projects--data coding, collection, analysis, writing, conceptualization, design, coordination, etc.", "In such projects, all contributions are essential and valued meaning that many areas and levels of expertise can contribute productively together--from senior renowned expert to citizen scientist."]}, {"lines": ["There are multiple threats that will kill an open science group--particularly in managing the collective effort with the constraints of individual contributions.", "Michael Nielsen summarizes these very well in Reinventing Discovery.", "A successful open science collaboration must: (a) modularize: split up the tasks into independent components, (b) encourage small contributions, (c) develop a well-structured information commons, and (d) maintain individual incentives to participate", "These lower the barriers to entry for new contributors, and maximize the range of expertise input potential.", "Individuals should see that getting involved in a project can be done easily, even if the project is underway.", "Ideally, it should be possible to make meaningful contributions with whatever time and interest is available.", "The Open Science Framework (OSF) involves continuously refining these practices as much as actually executing the projects themselves."]}, {"lines": ["The OSF web application is part network of research materials, part version control system, and part collaboration software."]}, {"lines": ["Interested in using the system? <a href=\"mailto:betainvite@openscienceframework.org\">Request an invitation</a> to try out the upcoming beta-release."]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">FAQ</%def>", "<%def name=\"content()\">"]}, {"lines": ["<h1 class=\"page-title\">Frequently Asked Questions</h1>"]}, {"lines": ["    via an open source sponsorship, and has backups on", "    <a href=\"http://aws.amazon.com/glacier/\">Amazon's Glacier platform</a>.", "    OSF maintains several backup schemes, including off-site backups and"]}, {"lines": ["<p>A folder can be used to organize files within a project or component - just like a folder on your own computer groups files together. A component is like a sub-project to help you organize different parts of your research. Components have their own privacy and sharing settings as well as their own unique, persistent identifiers for citation, and their own wiki and add-ons.</p>"]}, {"lines": ["<p>Send us an <a href=\"mailto:support@osf.io\">email</a> and we'll be happy to answer your questions.", "", ""]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">How the OSF Works</%def>", "<%def name=\"content()\">"]}, {"lines": ["<p>The Open Science Framework (OSF) is a breeding ground for open, collaborative projects whomever contributes to them.", "    There is no claim - implied or explicit - that any given project in the OSF is \"endorsed\" by any given OSF contributor.", "    It would be perfectly reasonable, for example, to have two projects that are competing in conception, design and/or", "    conclusion that develop in the OSF with independent sets of contributors.  OSF projects can emerge and thrive or die"]}, {"lines": ["<p>That said, the OSF has community standards for how project evolve and how authorship is determined.", "    These standards facilitate project development and reduce problems and conflicts in collaborative", "    projects.  Community standards are not about what kinds of projects are appropriate, but how to"]}, {"lines": ["<p>If a project is suggested in the OSF discussion group, then it is an \"open project\" in", "    the sense that it is possible for anyone in OSF to contribute and develop the idea,", "    and perhaps turn it into an active project with a target product (e.g., tool,"]}, {"lines": ["<p>Once it becomes clear that a project is moving from \"just an idea\" to something"]}, {"lines": ["      should occur before any contributor invests substantial time and resources in the project.", "      All contributors should explicitly understand and agree to the authorship terms"]}, {"lines": ["<p>There are at least two decisions to make in the authorship discussion. The first", "    is the threshold for earning authorship.  The second is how authorship will be", "    presented in the eventual report(s) or communications of the tool/infrastructure", "    origins.  One option is to have the listed author be \"The Open Science", "    Collaboration\" and present the individual authors in a footnote or appendix", "    alphabetically. Another option is to have the authors listed in the traditional", "    publishing format--first author is the project lead, trailing authors by", "    contribution, last author sometimes being the senior author of the primary", "    laboratory.  In this case especially, it is critical that the authorship order"]}, {"lines": ["<p>The advantage of using \"The Open Science Collaboration\" as the author is that", "    the project team need not wait for slow or non-responsive contributors.  Also", "    the project team is not concerned with whether a person earned their particular", "    position in the authorship order.  The only question is whether they met the", "    minimum threshold for authorship, which was defined in advance.  Contributions", "    beyond the minimum threshold are rewarded with enhanced reputation (much more", "    important than authorship order anyway).  The advantage of the traditional", "    publishing format is that it provides the familiar heuristic to guess about", "    each author's contribution.  Decisions about which authorship strategy to", "    use are left to the people involved in that particular project.  The key is", "    to establish shared understanding of authorship before any extensive work"]}, {"lines": ["<p>For projects with traditional publishing authorship formats, the reports,", "    tools, or infrastructure are cited on the vita or resume as is standard", "    practice.  For projects that are published with \"The Open Science", "    Collaboration\" as primary author, contributors include the citation on", "    their resume or vita and can add brief explanation of their contribution,", "    if desired. Notes about nature of contribution might be particularly"]}, {"lines": ["    will know who made important contributions and how.  As such, OSC members", "    should be explicit and vocal about giving credit to individual members when", "    credit is deserved - not just within the group, but to others. Junior", "    scholars should not be shy about asking more senior scholars in OSF for", "    letters of recommendation or other support.  In short, contributions should"]}, {"lines": ["<p>Transparency in project activities and up-front communication about", "    expectations for each project will minimize free-riding and other common", "    conflicts that emerge in collaborative research.  With clear", "    communication, potential contributors will have a clear understanding", "    about the responsibilities and rewards for getting involved in any", "    particular project.  With transparency, free-riding will be evident to all", "    group members causing loss to reputation.  Even so, conflicts will occur.", "    Project teams resolve conflicts internally among collaborators.  If", "    unsuccessful, project teams can communicate the nature of the conflict to"]}, {"lines": ["</%def>"]}, {"lines": ["        window.contextVars = window.contextVars || {};", "        window.contextVars.meetingData = ${data};"]}, {"lines": ["", "        $('#addLink').on('click', function(e) {", "            e.preventDefault();", "            $('#submit').slideToggle();", "        })"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">About the Reproducibility Project</%def>", "<%def name=\"content()\">"]}, {"lines": ["<li><a href=\"https://docs.google.com/document/d/1b8wlI8RqR07aOJKv5qMRTGCSi10ntb7glL7gyzUEE3M/edit\">Researcher Guide</a>: A comprehensive list of tasks for researchers that would like to conduct a replication (start here if you know the project and want to join in)"]}, {"lines": ["</%def>"]}, {"lines": ["<p>Registration creates a frozen version of the project that can never be edited or deleted but can be", "    retracted. You can register your project by selecting a registration form, entering information about", "    your project, and then confirming. You will be able to continue editing the original project, however,", "    and the frozen version with timestamps will always be linked to the original. Retracting a registration", "    will leave behind metadata about when the registration was created and retracted but removes the contents", "    of the registration.</p>"]}, {"lines": ["<p>A registration can be made public immediately or entered into an embargo period of up to 4 years. At the", "    end of the embargo period, the registration will automatically become public.</p>"]}, {"lines": ["<p>To register a project, click on the <em>Registrations</em> button in the grey navigation bar. Click on \"New Registration\", select a", "    metadata template, fill it out, and then confirm the registration. The registration will be at a separate,"]}, {"lines": ["    <li", "        node_reference=\"${summary['id']}:${'node' if summary['primary'] else 'pointer'}\"", "        class=\"project list-group-item list-group-item-node unavailable\">"]}, {"lines": ["% endif"]}, {"lines": ["% endif"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import urlparse", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    Takes the same arguments as Flask's url_for, with the addition of", "    `_absolute`, which will make an absolute URL with the correct HTTP scheme"]}, {"lines": ["    \"\"\""]}, {"lines": ["    return url"]}, {"lines": ["", ""]}, {"lines": ["    \"\"\"Reverse URL lookup for web routes (those that use the OsfWebRenderer).", "    Takes the same arguments as Flask's url_for, with the addition of", "    `_absolute`, which will make an absolute URL with the correct HTTP scheme", "    based on whether the app is in debug mode.", "    \"\"\""]}, {"lines": ["    url = url_for('OsfWebRenderer__{0}'.format(view_name), *args, **kwargs)"]}, {"lines": ["", "    if _absolute:", "        # We do NOT use the url_for's _external kwarg because app.config['SERVER_NAME'] alters", "        # behavior in an unknown way (currently breaks tests). /sloria /jspies"]}, {"lines": [""]}, {"lines": ["def is_json_request():", "    \"\"\"Return True if the current request is a JSON/AJAX request.\"\"\""]}, {"lines": ["# -*- coding: utf-8 -*-", "", "# Permissions", "READ = 'read'", "WRITE = 'write'", "ADMIN = 'admin'", "# NOTE: Ordered from most-restrictive to most permissive", "PERMISSIONS = [READ, WRITE, ADMIN]", "CREATOR_PERMISSIONS = [READ, WRITE, ADMIN]", "DEFAULT_CONTRIBUTOR_PERMISSIONS = [READ, WRITE, ADMIN]", ""]}, {"lines": ["    if permission is None:", "        return []"]}, {"lines": ["    index = PERMISSIONS.index(permission) + 1", "    return PERMISSIONS[:index]"]}, {"lines": ["    for permission in PERMISSIONS[::-1]:"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["def is_iterable_but_not_string(obj):", "    \"\"\"Return True if ``obj`` is an iterable object that isn't a string.\"\"\"", "    return (hasattr(obj, '__iter__') and not hasattr(obj, 'strip'))"]}, {"lines": ["    if is_iterable_but_not_string(data):"]}, {"lines": ["def safe_unescape_html(value):"]}, {"lines": ["    if isinstance(value, dict):"]}, {"lines": ["            for (key, value) in value.iteritems()"]}, {"lines": ["", "    if is_iterable_but_not_string(value):"]}, {"lines": ["            safe_unescape_html(each)", "            for each in value"]}, {"lines": ["    if isinstance(value, basestring):"]}, {"lines": ["            value = value.replace(escape_sequence, character)", "        return value", "    return value"]}], "name": "Steven Loria"}, {"commits": [{"lines": ["    init_app(set_backends=True, routes=False, attach_request_handlers=False)"]}, {"lines": ["        'wikiPage': addonsPath('wiki/static/wikiPage.js'),"]}, {"lines": ["        commands.disconnect()"]}, {"lines": ["        commands.disconnect()"]}, {"lines": ["from settings import API_BASE"]}, {"lines": ["base_pattern = '^{}'.format(API_BASE)"]}, {"lines": ["", "    def authenticate_header(self, request):"]}, {"lines": ["        return \"\""]}, {"lines": ["BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))"]}, {"lines": ["", "    # Order is important here because of a bug in rest_framework_swagger. For now,", "    # rest_framework.renderers.JSONRenderer needs to be first, at least until", "    # https://github.com/marcgibbons/django-rest-swagger/issues/271 is resolved."]}, {"lines": ["        'api.base.authentication.drf.OSFBasicAuthentication',"]}, {"lines": ["# Disabled to make a test work (TestNodeLog.test_formatted_date)", "# TODO Try to understand what's happening to cause the test to break when that line is active.", "# TIME_ZONE = 'UTC'"]}, {"lines": [""]}, {"lines": ["# API_PATH is '/api' on staging/production, '' on develop"]}, {"lines": ["API_PATH = ''"]}, {"lines": ["API_BASE = 'v2/'", ""]}, {"lines": [""]}, {"lines": ["    'api_path': API_PATH,"]}, {"lines": ["        <p>Welcome to the V2 Open Science Framework API. With this API you can programatically access users,", "        projects, components, and files from the <a href=\"https://osf.io/\">Open Science Framework</a>. The Open Science", "        Framework is a website that", "         integrates with the scientist's daily workflow. OSF helps document and archive study designs, materials, and data."]}, {"lines": ["         OSF facilitates sharing of materials and data within a research group or between groups. OSF also facilitates", "         transparency of research and provides a network design that details and credits individual"]}, {"lines": ["         contributions for all aspects of the research process.</p>", "         <p>NOTE: This API is currently in beta. The beta period should be fairly short, but until then, details about", "         the api could change. Once this notice disappears, it will be replaced with a description of how long we will", "         support the current api and under what circumstances it might change.</p>", "         <h2>General API Usage</h2>"]}, {"lines": ["        <h3>Filtering</h3>"]}, {"lines": ["        <h3>Links</h3>"]}, {"lines": ["    },", "    'doc_expansion': 'list',"]}, {"lines": ["from website.models import Node, Pointer"]}, {"lines": ["def get_user_auth(request):", "    user = request.user", "    if user.is_anonymous():", "        auth = Auth(None)", "    else:", "        auth = Auth(user)", "    return auth"]}, {"lines": ["        assert isinstance(obj, (Node, Pointer)), 'obj must be a Node or Pointer, got {}'.format(obj)"]}, {"lines": ["        auth = get_user_auth(request)"]}, {"lines": ["", "class ContributorOrPublicForPointers(permissions.BasePermission):", "", "    def has_object_permission(self, request, view, obj):"]}, {"lines": ["        assert isinstance(obj, (Node, Pointer)), 'obj must be a Node or Pointer, got {}'.format(obj)"]}, {"lines": ["        auth = get_user_auth(request)"]}, {"lines": ["        pointer_node = Pointer.load(request.parser_context['kwargs']['pointer_id']).node"]}, {"lines": ["        if request.method in permissions.SAFE_METHODS:"]}, {"lines": ["            has_parent_auth = parent_node.can_view(auth)", "            has_pointer_auth = pointer_node.can_view(auth)", "            public = obj.is_public", "            has_auth = public or (has_parent_auth and has_pointer_auth)", "            return has_auth"]}, {"lines": ["        else:"]}, {"lines": ["            has_auth = parent_node.can_edit(auth) and pointer_node.can_edit(auth)", "            return has_auth"]}, {"lines": [""]}, {"lines": ["\"\"\"Fixes nodes without is_folder set.", "", "This script must be run from the OSF root directory for the imports to work.", "\"\"\"", ""]}, {"lines": ["from framework.mongo import database"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def main():"]}, {"lines": [""]}, {"lines": ["    database['node'].update({\"is_folder\": {'$exists': False}}, {'$set': {'is_folder': False}}, multi=True)"]}, {"lines": [""]}, {"lines": ["    print('-----\\nDone.')"]}, {"lines": [""]}, {"lines": ["if __name__ == '__main__':"]}, {"lines": ["        self.user.timezone = 'America/New_York'"]}, {"lines": ["        timestamp = datetime.datetime.utcnow().replace(tzinfo=pytz.utc)", "        self.user.timezone = ''"]}, {"lines": ["        self.user.save()"]}, {"lines": [""]}, {"lines": ["    RegistrationFactory, CommentFactory, PrivateLinkFactory, UnconfirmedUserFactory, DashboardFactory, FolderFactory,"]}, {"lines": ["from website.settings import ALL_MY_REGISTRATIONS_ID, ALL_MY_PROJECTS_ID"]}, {"lines": ["    def test_api_get_folder_pointers(self):", "        dashboard = DashboardFactory(creator=self.user1)", "        project_one = ProjectFactory(creator=self.user1)", "        project_two = ProjectFactory(creator=self.user1)"]}, {"lines": ["        url = dashboard.api_url_for(\"get_folder_pointers\")"]}, {"lines": ["        dashboard.add_pointer(project_one, auth=self.consolidate_auth1)", "        dashboard.add_pointer(project_two, auth=self.consolidate_auth1)", "        res = self.app.get(url, auth=self.auth)", "        pointers = res.json", "        assert_in(project_one._id, pointers)", "        assert_in(project_two._id, pointers)", "        assert_equal(len(pointers), 2)", "", "    def test_api_get_folder_pointers_from_non_folder(self):", "        project_one = ProjectFactory(creator=self.user1)", "        project_two = ProjectFactory(creator=self.user1)"]}, {"lines": ["        url = project_one.api_url_for(\"get_folder_pointers\")"]}, {"lines": ["        project_one.add_pointer(project_two, auth=self.consolidate_auth1)", "        res = self.app.get(url, auth=self.auth)", "        pointers = res.json", "        assert_equal(len(pointers), 0)", ""]}, {"lines": ["    def test_new_user_gets_dashboard_on_dashboard_path(self):", "        my_user = AuthUserFactory()"]}, {"lines": ["        dashboard = my_user.node__contributed.find(Q('is_dashboard', 'eq', True))"]}, {"lines": ["        assert_equal(dashboard.count(), 0)"]}, {"lines": ["        url = api_url_for('get_dashboard')"]}, {"lines": ["        self.app.get(url, auth=my_user.auth)", "        my_user.reload()"]}, {"lines": ["        dashboard = my_user.node__contributed.find(Q('is_dashboard', 'eq', True))"]}, {"lines": ["        assert_equal(dashboard.count(), 1)", ""]}, {"lines": ["class TestEditableChildrenViews(OsfTestCase):", "", "    def setUp(self):", "        OsfTestCase.setUp(self)", "        self.user = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.user, is_public=False)"]}, {"lines": ["        url = self.project.api_url_for('get_editable_children')", "        self.project_results = self.app.get(url, auth=self.user.auth).json", "", "    def test_get_editable_children(self):", "        assert_equal(len(self.project_results['children']), 4)", "        assert_equal(self.project_results['node']['id'], self.project._id)", "", "    def test_editable_children_order(self):", "        assert_equal(self.project_results['children'][0]['id'], self.child._id)", "        assert_equal(self.project_results['children'][1]['id'], self.grandchild._id)", "        assert_equal(self.project_results['children'][2]['id'], self.great_grandchild._id)", "        assert_equal(self.project_results['children'][3]['id'], self.great_great_grandchild._id)", "", "    def test_editable_children_indents(self):", "        assert_equal(self.project_results['children'][0]['indent'], 0)", "        assert_equal(self.project_results['children'][1]['indent'], 1)", "        assert_equal(self.project_results['children'][2]['indent'], 2)", "        assert_equal(self.project_results['children'][3]['indent'], 3)", "", "    def test_editable_children_parents(self):", "        assert_equal(self.project_results['children'][0]['parent_id'], self.project._id)", "        assert_equal(self.project_results['children'][1]['parent_id'], self.child._id)", "        assert_equal(self.project_results['children'][2]['parent_id'], self.grandchild._id)", "        assert_equal(self.project_results['children'][3]['parent_id'], self.great_grandchild._id)", "", "    def test_editable_children_privacy(self):", "        assert_false(self.project_results['node']['is_public'])", "        assert_true(self.project_results['children'][0]['is_public'])", "        assert_false(self.project_results['children'][1]['is_public'])", "        assert_true(self.project_results['children'][2]['is_public'])", "        assert_false(self.project_results['children'][3]['is_public'])", "", "    def test_editable_children_titles(self):", "        assert_equal(self.project_results['node']['title'], self.project.title)", "        assert_equal(self.project_results['children'][0]['title'], self.child.title)", "        assert_equal(self.project_results['children'][1]['title'], self.grandchild.title)", "        assert_equal(self.project_results['children'][2]['title'], self.great_grandchild.title)", "        assert_equal(self.project_results['children'][3]['title'], self.great_great_grandchild.title)", "", ""]}, {"lines": ["    def test_get_current_user_gravatar_default_size(self):", "        url = api_url_for('current_user_gravatar')", "        res = self.app.get(url, auth=self.user.auth)", "        current_user_gravatar = res.json['gravatar_url']", "        assert_true(current_user_gravatar is not None)", "        url = api_url_for('get_gravatar', uid=self.user._id)", "        res = self.app.get(url, auth=self.user.auth)", "        my_user_gravatar = res.json['gravatar_url']", "        assert_equal(current_user_gravatar, my_user_gravatar)", "", "    def test_get_other_user_gravatar_default_size(self):", "        user2 = AuthUserFactory()", "        url = api_url_for('current_user_gravatar')", "        res = self.app.get(url, auth=self.user.auth)", "        current_user_gravatar = res.json['gravatar_url']", "        url = api_url_for('get_gravatar', uid=user2._id)", "        res = self.app.get(url, auth=self.user.auth)", "        user2_gravatar = res.json['gravatar_url']", "        assert_true(user2_gravatar is not None)", "        assert_not_equal(current_user_gravatar, user2_gravatar)", "", "    def test_get_current_user_gravatar_specific_size(self):", "        url = api_url_for('current_user_gravatar')", "        res = self.app.get(url, auth=self.user.auth)", "        current_user_default_gravatar = res.json['gravatar_url']", "        url = api_url_for('current_user_gravatar', size=11)", "        res = self.app.get(url, auth=self.user.auth)", "        current_user_small_gravatar = res.json['gravatar_url']", "        assert_true(current_user_small_gravatar is not None)", "        assert_not_equal(current_user_default_gravatar, current_user_small_gravatar)", "", "    def test_get_other_user_gravatar_specific_size(self):", "        user2 = AuthUserFactory()", "        url = api_url_for('get_gravatar', uid=user2._id)", "        res = self.app.get(url, auth=self.user.auth)", "        gravatar_default_size = res.json['gravatar_url']", "        url = api_url_for('get_gravatar', uid=user2._id, size=11)", "        res = self.app.get(url, auth=self.user.auth)", "        gravatar_small = res.json['gravatar_url']", "        assert_true(gravatar_small is not None)", "        assert_not_equal(gravatar_default_size, gravatar_small)", ""]}, {"lines": ["    def test_add_the_same_pointer_more_than_once(self):", "        url = self.project.api_url + 'pointer/'", "        double_node = NodeFactory()", "", "        self.app.post_json(", "            url,", "            {'nodeIds': [double_node._id]},", "            auth=self.user.auth,"]}, {"lines": ["        )", "        res = self.app.post_json(", "            url,", "            {'nodeIds': [double_node._id]},", "            auth=self.user.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)"]}, {"lines": [""]}, {"lines": ["    def test_move_pointers(self):", "        project_two = ProjectFactory(creator=self.user)", "        url = api_url_for('move_pointers')", "        node = NodeFactory()", "        pointer = self.project.add_pointer(node, auth=self.consolidate_auth)", "", "        assert_equal(len(self.project.nodes), 1)", "        assert_equal(len(project_two.nodes), 0)", "", "        user_auth = self.user.auth", "        move_request = \\", "            {", "                'fromNodeId': self.project._id,", "                'toNodeId': project_two._id,", "                'pointerIds': [pointer.node._id],", "            }", "        self.app.post_json(", "            url,", "            move_request,", "            auth=user_auth,", "        ).maybe_follow()", "        self.project.reload()", "        project_two.reload()", "        assert_equal(len(self.project.nodes), 0)", "        assert_equal(len(project_two.nodes), 1)", ""]}, {"lines": ["        self.contrib = UserFactory(fullname='Brian May')", "        for i in range(0, 12):"]}, {"lines": ["            UserFactory(fullname='Freddie Mercury{}'.format(i))"]}, {"lines": ["        res = self.app.get(url, {'query': self.contrib.fullname})"]}, {"lines": ["        brian = result[0]", "        assert_equal(brian['fullname'], self.contrib.fullname)", "        assert_in('gravatar_url', brian)", "        assert_equal(brian['registered'], self.contrib.is_registered)"]}, {"lines": ["    def test_search_pagination_default(self):", "        url = api_url_for('search_contributor')"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        result = res.json['users']", "        pages = res.json['pages']", "        page = res.json['page']"]}, {"lines": ["        assert_equal(page, 0)", "", "    def test_search_pagination_default_page_1(self):", "        url = api_url_for('search_contributor')"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        result = res.json['users']", "        page = res.json['page']"]}, {"lines": ["        assert_equal(page, 1)", ""]}, {"lines": ["    def test_search_pagination_smaller_pages(self):", "        url = api_url_for('search_contributor')"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        result = res.json['users']", "        pages = res.json['pages']", "        page = res.json['page']", "        assert_equal(len(result), 5)", "        assert_equal(page, 0)", "        assert_equal(pages, 3)", "", "    def test_search_pagination_smaller_pages_page_2(self):", "        url = api_url_for('search_contributor')"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        result = res.json['users']", "        pages = res.json['pages']", "        page = res.json['page']", "        assert_equal(len(result), 2)", "        assert_equal(page, 2)", "        assert_equal(pages, 3)"]}, {"lines": ["class TestODMTitleSearch(OsfTestCase):", "    \"\"\" Docs from original method:", "    :arg term: The substring of the title.", "    :arg category: Category of the node.", "    :arg isDeleted: yes, no, or either. Either will not add a qualifier for that argument in the search.", "    :arg isFolder: yes, no, or either. Either will not add a qualifier for that argument in the search.", "    :arg isRegistration: yes, no, or either. Either will not add a qualifier for that argument in the search.", "    :arg includePublic: yes or no. Whether the projects listed should include public projects.", "    :arg includeContributed: yes or no. Whether the search should include projects the current user has", "        contributed to.", "    :arg ignoreNode: a list of nodes that should not be included in the search.", "    :return: a list of dictionaries of projects", "    \"\"\"", "    def setUp(self):"]}, {"lines": ["        super(TestODMTitleSearch, self).setUp()", ""]}, {"lines": ["        self.user = AuthUserFactory()", "        self.user_two = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.user, title=\"foo\")", "        self.project_two = ProjectFactory(creator=self.user_two, title=\"bar\")", "        self.public_project = ProjectFactory(creator=self.user_two, is_public=True, title=\"baz\")", "        self.registration_project = RegistrationFactory(creator=self.user, title=\"qux\")", "        self.folder = FolderFactory(creator=self.user, title=\"quux\")", "        self.dashboard = DashboardFactory(creator=self.user, title=\"Dashboard\")"]}, {"lines": ["", "    def test_search_projects_by_title(self):", "        res = self.app.get(self.url, {'term': self.project.title}, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.public_project.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'no'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.project.title,", "                               'includePublic': 'no',", "                               'includeContributed': 'yes'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.project.title,", "                               'includePublic': 'no',", "                               'includeContributed': 'yes',", "                               'isRegistration': 'no'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.project.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'yes',", "                               'isRegistration': 'either'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.public_project.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'yes',", "                               'isRegistration': 'either'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.registration_project.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'yes',", "                               'isRegistration': 'either'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 2)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.registration_project.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'yes',", "                               'isRegistration': 'no'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.folder.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'yes',", "                               'isFolder': 'yes'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.folder.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'yes',", "                               'isFolder': 'no'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 0)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.dashboard.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'yes',", "                               'isFolder': 'no'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 0)", "        res = self.app.get(self.url,", "                           {", "                               'term': self.dashboard.title,", "                               'includePublic': 'yes',", "                               'includeContributed': 'yes',", "                               'isFolder': 'yes'", "                           }, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), 1)", ""]}, {"lines": [""]}, {"lines": ["        self.dashboard = DashboardFactory(creator=self.creator)"]}, {"lines": ["        # Get the All My Projects smart folder from the dashboard"]}, {"lines": ["        url = api_url_for('get_dashboard', nid=ALL_MY_PROJECTS_ID)"]}, {"lines": ["        project = ProjectFactory(creator=self.creator, public=False)"]}, {"lines": ["        component.add_contributor(self.contrib, auth=Auth(self.creator))", "        component.save()", "        project.register_node(", "            None, Auth(self.creator), '', '',", "        )"]}, {"lines": ["        # Get the All My Registrations smart folder from the dashboard"]}, {"lines": ["        url = api_url_for('get_dashboard', nid=ALL_MY_REGISTRATIONS_ID)"]}, {"lines": ["    def test_untouched_node_is_collapsed(self):", "        found_item = False", "        folder = FolderFactory(creator=self.creator, public=True)", "        self.dashboard.add_pointer(folder, auth=Auth(self.creator))", "        url = api_url_for('get_dashboard', nid=self.dashboard._id)", "        dashboard_data = self.app.get(url, auth=self.creator.auth)", "        dashboard_json = dashboard_data.json[u'data']", "        for dashboard_item in dashboard_json:", "            if dashboard_item[u'node_id'] == folder._id:", "                found_item = True", "                assert_false(dashboard_item[u'expand'], \"Expand state was not set properly.\")", "        assert_true(found_item, \"Did not find the folder in the dashboard.\")", "", "    def test_expand_node_sets_expand_to_true(self):", "        found_item = False", "        folder = FolderFactory(creator=self.creator, public=True)", "        self.dashboard.add_pointer(folder, auth=Auth(self.creator))", "        url = api_url_for('expand', pid=folder._id)", "        self.app.post(url, auth=self.creator.auth)", "        url = api_url_for('get_dashboard', nid=self.dashboard._id)", "        dashboard_data = self.app.get(url, auth=self.creator.auth)", "        dashboard_json = dashboard_data.json[u'data']", "        for dashboard_item in dashboard_json:", "            if dashboard_item[u'node_id'] == folder._id:", "                found_item = True", "                assert_true(dashboard_item[u'expand'], \"Expand state was not set properly.\")", "        assert_true(found_item, \"Did not find the folder in the dashboard.\")", "", "    def test_collapse_node_sets_expand_to_true(self):", "        found_item = False", "        folder = FolderFactory(creator=self.creator, public=True)", "        self.dashboard.add_pointer(folder, auth=Auth(self.creator))", "", "        # Expand the folder", "        url = api_url_for('expand', pid=folder._id)", "        self.app.post(url, auth=self.creator.auth)", "", "        # Serialize the dashboard and test", "        url = api_url_for('get_dashboard', nid=self.dashboard._id)", "        dashboard_data = self.app.get(url, auth=self.creator.auth)", "        dashboard_json = dashboard_data.json[u'data']", "        for dashboard_item in dashboard_json:", "            if dashboard_item[u'node_id'] == folder._id:", "                found_item = True", "                assert_true(dashboard_item[u'expand'], \"Expand state was not set properly.\")", "        assert_true(found_item, \"Did not find the folder in the dashboard.\")", "", "        # Collapse the folder", "        found_item = False", "        url = api_url_for('collapse', pid=folder._id)", "        self.app.post(url, auth=self.creator.auth)", "", "        # Serialize the dashboard and test", "        url = api_url_for('get_dashboard', nid=self.dashboard._id)", "        dashboard_data = self.app.get(url, auth=self.creator.auth)", "        dashboard_json = dashboard_data.json[u'data']", "        for dashboard_item in dashboard_json:", "            if dashboard_item[u'node_id'] == folder._id:", "                found_item = True", "                assert_false(dashboard_item[u'expand'], \"Expand state was not set properly.\")", "        assert_true(found_item, \"Did not find the folder in the dashboard.\")", ""]}, {"lines": ["    def test_folder_new_post(self):", "        url = api_url_for('folder_new_post', nid=self.dashboard._id)", "        found_item = False", "", "        # Make the folder", "        title = 'New test folder'", "        payload = {'title': title, }", "        self.app.post_json(url, payload, auth=self.creator.auth)", "", "        # Serialize the dashboard and test", "        url = api_url_for('get_dashboard', nid=self.dashboard._id)", "        dashboard_data = self.app.get(url, auth=self.creator.auth)", "        dashboard_json = dashboard_data.json[u'data']", "        for dashboard_item in dashboard_json:", "            if dashboard_item[u'name'] == title:", "                found_item = True", "        assert_true(found_item, \"Did not find the folder in the dashboard.\")"]}, {"lines": ["    def test_strip_html_from_title(self):", "        payload = {", "            'title': 'no html <b>here</b>'", "        }", "        res = self.app.post_json(self.url, payload, auth=self.creator.auth)", "        node = Node.load(res.json['projectUrl'].replace('/', ''))", "        assert_true(node)", "        assert_equal('no html here', node.title)", ""]}, {"lines": ["        res = self.app.get(self.reachable_url, auth=None, auth_type='jwt', expect_errors=True)"]}, {"lines": ["        res = self.app.get(self.reachable_url, auth='invalid_token', auth_type='jwt', expect_errors=True)"]}, {"lines": ["        res = self.app.get(self.reachable_url, auth='some_valid_token', auth_type='jwt', expect_errors=True)"]}, {"lines": ["        res = self.app.get(self.reachable_url, auth='some_valid_token', auth_type='jwt')"]}, {"lines": ["        res = self.app.get(self.unreachable_url, auth='some_valid_token', auth_type='jwt', expect_errors=True)"]}, {"lines": [""]}, {"lines": ["WELCOME_MESSAGE = ('Welcome to the OSF! Please update the following settings. If you need assistance '", "                   'in getting started, please visit the <a href=\"/getting-started/\">Getting Started</a> page.')"]}, {"lines": ["REGISTRATION_SUCCESS = '''Registration successful. Please check {email} to confirm your email address.'''"]}, {"lines": ["ALREADY_REGISTERED = '''The email <em>{email}</em> has already been registered.'''"]}, {"lines": ["UNCONFIRMED = ('This login email has been registered but not confirmed. Please check your email (and spam folder).'", "               ' <a href=\"/resend/\">Click here</a> to resend your confirmation email.')"]}, {"lines": ["CLAIMED_CONTRIBUTOR = ('<strong>Welcome to the OSF!</strong> Edit your display name below and then check your '", "                       '<a href=\"/dashboard/\">dashboard</a> to see projects to which you have been added as a '", "                       'contributor by someone else.')"]}, {"lines": [""]}, {"lines": ["def goodbye():"]}, {"lines": ["             website_views.reproducibility, OsfWebRenderer('', render_mako_string)),"]}, {"lines": ["        Rule(", "            [", "                '/dashboard/<nid>',"]}, {"lines": ["                '/dashboard/',", "            ],", "            'get', website_views.get_dashboard, json_renderer),"]}, {"lines": ["             OsfWebRenderer('public/pages/active_nodes.mako')),"]}, {"lines": ["             OsfWebRenderer('public/login.mako')),"]}, {"lines": ["             auth_views.auth_login, OsfWebRenderer('public/login.mako')),"]}, {"lines": ["             OsfWebRenderer('public/login.mako'),", "             endpoint_suffix='__first', view_kwargs={'first': True}),"]}, {"lines": ["             OsfWebRenderer('public/login.mako')),"]}, {"lines": ["             OsfWebRenderer('profile.mako')),"]}, {"lines": ["             OsfWebRenderer('profile/key_history.mako')),"]}, {"lines": ["             OsfWebRenderer(\"merge_accounts.mako\")),"]}, {"lines": ["             OsfWebRenderer(\"merge_accounts.mako\")),"]}, {"lines": ["             project_views.contributor.claim_user_form, OsfWebRenderer('claim_account.mako')),"]}, {"lines": ["             project_views.contributor.claim_user_registered,", "             OsfWebRenderer('claim_account_registered.mako')),"]}, {"lines": ["             profile_views.get_public_projects, json_renderer),"]}, {"lines": ["             profile_views.get_public_components, json_renderer),"]}, {"lines": ["             profile_views.get_profile_summary, json_renderer),"]}, {"lines": ["             project_views.contributor.claim_user_post, json_renderer),"]}, {"lines": ["        Rule("]}, {"lines": ["            [", "                '/profile/gravatar/',", "                '/users/gravatar/',", "                '/profile/gravatar/<size>',", "                '/users/gravatar/<size>',", "            ],", "            'get',", "            profile_views.current_user_gravatar,", "            json_renderer,", "        ),", "", "        Rule(", "            [", "                '/profile/<uid>/gravatar/',", "                '/users/<uid>/gravatar/',", "                '/profile/<uid>/gravatar/<size>',", "                '/users/<uid>/gravatar/<size>',", "            ],", "            'get',", "            profile_views.get_gravatar,", "            json_renderer,", "        ),", ""]}, {"lines": ["             OsfWebRenderer('', render_mako_string)),"]}, {"lines": ["        Rule('/api/v1/folder/<nid>', 'post', project_views.node.folder_new_post, json_renderer),"]}, {"lines": ["             project_views.node.project_before_template, json_renderer),"]}, {"lines": ["            view_kwargs={'mode': 'page'},"]}, {"lines": ["        Rule(["]}, {"lines": ["            '/project/<pid>/expand/',", "            '/project/<pid>/node/<nid>/expand/',", "        ], 'post', project_views.node.expand, json_renderer),", "        Rule([", "            '/project/<pid>/collapse/',", "            '/project/<pid>/node/<nid>/collapse/',", "        ], 'post', project_views.node.collapse, json_renderer),"]}, {"lines": ["                '/pointer/',", "            ],", "            'post',", "            project_views.node.add_pointer,", "            json_renderer,", "        ),", "        Rule(", "            ["]}, {"lines": ["                '/pointers/move/',"]}, {"lines": ["            ],", "            'post',"]}, {"lines": ["            project_views.node.move_pointers,"]}, {"lines": ["            json_renderer,", "        ),", "        Rule(", "            ["]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["                '/folder/<pid>/pointer/<pointer_id>',"]}, {"lines": ["            ],", "            'delete',", "            project_views.node.remove_pointer_from_folder,", "            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            [", "                '/folder/<pid>/pointers/',", "            ],", "            'delete',", "            project_views.node.remove_pointers_from_folder,", "            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            [", "                '/folder/<pid>',", "            ],", "            'delete',", "            project_views.node.delete_folder,", "            json_renderer,", "        ),"]}, {"lines": ["        Rule('/folder/', 'put', project_views.node.add_folder, json_renderer),"]}, {"lines": ["            '/project/<pid>/get_folder_pointers/'", "        ], 'get', project_views.node.get_folder_pointers, json_renderer),", "        Rule(["]}, {"lines": ["             project_views.node.project_reorder_components, json_renderer),"]}, {"lines": ["            sortkey: 'date' // property of item object on which to sort on"]}, {"lines": ["            sortkey: 'badge' // property of item object on which to sort on"]}, {"lines": ["            sortkey: 'project' // property of item object on which to sort on"]}, {"lines": ["            sortable: false"]}, {"lines": ["                            $.osf.growl('Could not revoke badge','');"]}, {"lines": ["        # WARNING: get_hgrid_data can return None if the addon is added but has no credentials."]}, {"lines": ["        assert_equal(urls['files'], self.project.web_url_for('collect_file_trees'))"]}, {"lines": ["def github_repo_url(owner, repo, branch):", "    url = \"https://github.com/{0}/{1}/tree/{2}\".format(owner, repo, branch)"]}, {"lines": ["    return url", "", ""]}, {"lines": ["        'repo': github_repo_url(owner=node_settings.user, repo=node_settings.repo, branch=branch)"]}, {"lines": ["//    Important: In the body of each snippet, the white spaces is a tab, not a series of spaces, and is required.", ""]}, {"lines": ["snippet video\\n\\", "\t\\n\\", "\t@[${1:service}](${2:url})\\n\\"]}, {"lines": ["\\n\\"]}, {"lines": ["snippet youtube-video\\n\\", "\t\\n\\", "\t@[youtube](${1:url})\\n\\", "\\n\\", "snippet vimeo-video\\n\\", "\t\\n\\", "\t@[vimeo](${1:url})\\n\\", "\\n\\", "snippet table-of-contents\\n\\", "\t\\n\\", "\t@[toc](${1:optional_label})\\n\\", "\\n\\"]}, {"lines": ["var ShareJSDoc = function(url, metadata, viewText, editor) {"]}, {"lines": ["    var self = this;"]}, {"lines": ["    self.editor = editor;", "    var wikiEditor = new WikiEditor(url, viewText, self.editor);"]}, {"lines": ["    self.wikiEditor = wikiEditor;"]}, {"lines": [""]}, {"lines": ["    self.editor.getSession().setMode('ace/mode/markdown');", "    self.editor.getSession().setUseSoftTabs(true);   // Replace tabs with spaces", "    self.editor.getSession().setUseWrapMode(true);   // Wraps text", "    self.editor.renderer.setShowGutter(false);       // Hides line number", "    self.editor.setShowPrintMargin(false);           // Hides print margin", "    self.editor.commands.removeCommand('showSettingsMenu');  // Disable settings menu", "    self.editor.setReadOnly(true); // Read only until initialized", "    self.editor.setOptions({"]}, {"lines": ["            self.editor.setValue(response.wiki_draft, -1);", "            self.editor.setReadOnly(false);"]}, {"lines": ["            doc.attachAce(self.editor);"]}, {"lines": ["        self.editor.gotoLine(0,0);", "        var undoManager = self.editor.getSession().getUndoManager();"]}, {"lines": ["        self.editor.getSession().setUndoManager(undoManager);", "        self.editor.setReadOnly(false);"]}, {"lines": ["                self.editor.setReadOnly(true);"]}, {"lines": ["                self.editor.setReadOnly(true);"]}, {"lines": ["                self.editor.setReadOnly(true);"]}, {"lines": ["'use strict';", "var ko = require('knockout');", "var $ = require('jquery');"]}, {"lines": [""]}, {"lines": ["", "var THROTTLE = 500;", ""]}, {"lines": ["//<div id=\"preview\" data-bind=\"mathjaxify\">"]}, {"lines": ["ko.bindingHandlers.mathjaxify = {"]}, {"lines": ["    update: function(element, valueAccessor, allBindingsAccessor, data, context) {"]}, {"lines": ["        var vm = context.$data;"]}, {"lines": ["        //Need to unwrap the data in order for KO to know it's changed.", "        ko.unwrap(valueAccessor());"]}, {"lines": [""]}, {"lines": ["        if(vm.allowMathjaxification() && vm.allowFullRender()) {", "            mathrender.mathjaxify('#' + element.id);"]}, {"lines": ["        }", "    }", "};", ""]}, {"lines": [""]}, {"lines": ["function ViewWidget(visible, version, viewText, rendered, contentURL, allowMathjaxification, allowFullRender, editor) {"]}, {"lines": ["    var self = this;", "    self.version = version;", "    self.viewText = viewText; // comes from EditWidget.viewText", "    self.rendered = rendered;", "    self.visible = visible;", "    self.allowMathjaxification = allowMathjaxification;", "    self.editor = editor;"]}, {"lines": ["    self.allowFullRender = allowFullRender;"]}, {"lines": ["    self.renderTimeout = null;"]}, {"lines": ["    self.displaySource = ko.observable('');"]}, {"lines": ["    self.debouncedAllowFullRender = $osf.debounce(function() {"]}, {"lines": ["        self.allowFullRender(true);", "    }, THROTTLE);"]}, {"lines": ["", "    self.renderMarkdown = function(rawContent){"]}, {"lines": ["        if(self.visible()) {", "            if (self.allowFullRender()) {", "                return md.render(rawContent);", "            } else {", "                return mdQuick.render(rawContent);", "            }"]}, {"lines": ["        } else {"]}, {"lines": ["            return '';"]}, {"lines": ["        }", "    };", ""]}, {"lines": ["    if (typeof self.editor !== 'undefined') {", "        self.editor.on('change', function () {"]}, {"lines": ["            if(self.version() === 'preview') {", "                // Quick render", "                self.allowFullRender(false);", "", "                // Full render", "                self.debouncedAllowFullRender();", "            }"]}, {"lines": ["        });"]}, {"lines": ["    } else {", "        self.allowFullRender(true);"]}, {"lines": ["    }"]}, {"lines": ["", "    self.displayText =  ko.computed(function() {"]}, {"lines": ["        self.allowFullRender();"]}, {"lines": ["        var requestURL;", "        if (typeof self.version() !== 'undefined') {", "            if (self.version() === 'preview') {", "                self.rendered(self.renderMarkdown(self.viewText()));"]}, {"lines": ["                self.displaySource(self.viewText());"]}, {"lines": ["            } else {", "                if (self.version() === 'current') {", "                    requestURL = contentURL;", "                } else {", "                    requestURL= contentURL + self.version();", "                }", "                var request = $.ajax({", "                    url: requestURL", "                });", "", "                request.done(function (resp) {"]}, {"lines": ["                    if(self.visible()) {", "                        var rawContent = resp.wiki_content || '*No wiki content*';", "                        if (resp.wiki_rendered) {", "                            // Use pre-rendered python, if provided. Don't mathjaxify", "                            self.allowMathjaxification(false);"]}, {"lines": ["                            self.rendered(resp.wiki_rendered);"]}, {"lines": ["", "                        } else {", "                            // Render raw markdown"]}, {"lines": ["                            self.allowMathjaxification(true);", "                            self.rendered(self.renderMarkdown(rawContent));", "                        }"]}, {"lines": ["                        self.displaySource(rawContent);"]}, {"lines": ["                    }"]}, {"lines": ["                });", "            }", "        } else {"]}, {"lines": ["            self.displaySource('');"]}, {"lines": ["        }", "    });", "}", "", "    // currentText comes from ViewWidget.displayText", "function CompareWidget(visible, compareVersion, currentText, rendered, contentURL) {", "    var self = this;", "", "    self.compareVersion = compareVersion;"]}, {"lines": ["    self.currentText = currentText;"]}, {"lines": ["    self.rendered = rendered;", "    self.visible = visible;"]}, {"lines": ["    self.contentURL = contentURL;", "    self.compareSource = ko.observable('');"]}, {"lines": [""]}, {"lines": ["    self.compareText = ko.computed(function() {", "        var requestURL;", "        if (self.compareVersion() === 'current') {"]}, {"lines": ["            requestURL = self.contentURL;"]}, {"lines": ["        } else {"]}, {"lines": ["            requestURL= self.contentURL + self.compareVersion();"]}, {"lines": ["        }", "        var request = $.ajax({", "            url: requestURL", "        });", "        request.done(function (resp) {"]}, {"lines": ["            var rawText = resp.wiki_content;", "            self.compareSource(rawText);"]}, {"lines": ["        });", "", "    });", "", "    self.compareOutput = ko.computed(function() {"]}, {"lines": ["        var output = diffTool.diff(self.compareSource(), self.currentText());"]}, {"lines": ["        self.rendered(output);"]}, {"lines": ["        return output;", "    }).extend({ notify: 'always' });"]}, {"lines": ["", "}", "", "", "var defaultOptions = {", "    editVisible: false,", "    viewVisible: true,", "    compareVisible: false,"]}, {"lines": ["    canEdit: true,", "    viewVersion: 'current',"]}, {"lines": ["    metadata: {}", "};", "", "function ViewModel(options){", "    var self = this;", "", "    // enabled?", "    self.editVis = ko.observable(options.editVisible);", "    self.viewVis = ko.observable(options.viewVisible);", "    self.compareVis = ko.observable(options.compareVisible);"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    self.compareVersion = ko.observable(options.compareVersion);", "    self.viewVersion = ko.observable(options.viewVersion);"]}, {"lines": ["    self.editorMetadata = options.metadata;", "    self.canEdit = options.canEdit;", "", "    self.viewText = ko.observable('');", "    self.renderedView = ko.observable('');", "    self.renderedCompare = ko.observable('');"]}, {"lines": ["    self.allowMathjaxification = ko.observable(true);", "    self.allowFullRender = ko.observable(true);"]}, {"lines": ["    self.viewVersionDisplay = ko.computed(function() {", "        var versionString = '';", "        if (self.viewVersion() === 'preview') {", "            versionString = 'Live preview';", "        } else if (self.viewVersion() === 'current'){", "            versionString = 'Current version';", "        } else if (self.viewVersion() === 'previous'){", "            versionString = 'Previous version';", "        } else {", "            versionString = 'Version ' + self.viewVersion();", "        }", "        return versionString;", "    });"]}, {"lines": [""]}, {"lines": ["    self.currentURL = ko.computed(function() {"]}, {"lines": ["        var url = self.pageURL;"]}, {"lines": ["        if (self.editVis()) {"]}, {"lines": ["        }"]}, {"lines": ["            }", "        }", "        if (self.compareVis()) {"]}, {"lines": ["            }", "        }"]}, {"lines": [""]}, {"lines": ["    });"]}, {"lines": ["", ""]}, {"lines": ["    if(self.canEdit) {"]}, {"lines": ["        self.editor = ace.edit('editor'); // jshint ignore: line"]}, {"lines": [""]}, {"lines": ["        var ShareJSDoc = require('addons/wiki/static/ShareJSDoc.js');", "        self.editVM = new ShareJSDoc(self.draftURL, self.editorMetadata, self.viewText, self.editor);", "    }"]}, {"lines": ["    self.viewVM = new ViewWidget(self.viewVis, self.viewVersion, self.viewText, self.renderedView, self.contentURL, self.allowMathjaxification, self.allowFullRender, self.editor);"]}, {"lines": ["    self.compareVM = new CompareWidget(self.compareVis, self.compareVersion, self.viewVM.displaySource, self.renderedCompare, self.contentURL);"]}, {"lines": ["        //URL needs to be a computed observable, and this should just update the panel states, which will feed URL", ""]}, {"lines": ["        } else if (panel === 'view') {", "            if(!display && self.compareVis() && self.editVis()){", "                self.viewVersion('preview');", "            }"]}, {"lines": ["}", "", ""]}, {"lines": [""]}, {"lines": ["var WikiPage = function(selector, options) {", "    var self = this;", "    self.options = $.extend({}, defaultOptions, options);", "", "    this.viewModel = new ViewModel(self.options);", "    $osf.applyBindings(self.viewModel, selector);", "};", "", "module.exports = WikiPage;", ""]}, {"lines": ["## Use full page width"]}, {"lines": ["<%def name=\"container_class()\">container-xxl</%def>"]}, {"lines": ["<div class=\"wiki\" id=\"wikiPageContext\">"]}, {"lines": ["                  <div class=\"row\">"]}, {"lines": ["                            <!-- Version Picker -->"]}, {"lines": ["                      </div>", "                  </div>"]}, {"lines": ["        panelsUsed: ${json.dumps(panels_used) | n},"]}, {"lines": ["</%def>"]}, {"lines": ["    try:"]}, {"lines": ["    '''Return a list of user's projects, excluding registrations and folders.'''"]}, {"lines": ["def get_gravatar(user, size=None):", "    if size is None:", "        size = settings.GRAVATAR_SIZE_PROFILE", "    return gravatar(", "        user, use_ssl=True,", "        size=size", "    )", "", ""]}, {"lines": ["        'gravatar_url': gravatar(", "            user, use_ssl=True,"]}, {"lines": ["            size=settings.GRAVATAR_SIZE_ADD_CONTRIBUTOR"]}, {"lines": ["        ),"]}, {"lines": ["            'gravatar_url': gravatar("]}, {"lines": ["from modularodm import Q"]}, {"lines": ["from website.exceptions import NodeStateError"]}, {"lines": ["def new_dashboard(user):", "    \"\"\"Create a new dashboard project.", "", "    :param User user: User object", "    :return Node: Created node", "", "    \"\"\""]}, {"lines": ["    existing_dashboards = user.node__contributed.find("]}, {"lines": ["        Q('category', 'eq', 'project') &"]}, {"lines": ["    )", ""]}, {"lines": ["    if existing_dashboards.count() > 0:"]}, {"lines": ["        raise NodeStateError(\"Users may only have one dashboard\")"]}, {"lines": ["", "    node = Node("]}, {"lines": ["        title='Dashboard',"]}, {"lines": ["        creator=user,"]}, {"lines": ["        category='project',"]}, {"lines": ["        is_dashboard=True,", "        is_folder=True", "    )", "", "    node.save()", "", "    return node", ""]}, {"lines": [""]}, {"lines": ["def new_folder(title, user):", "    \"\"\"Create a new folder project.", "", "    :param str title: Node title", "    :param User user: User object", "    :return Node: Created node", "", "    \"\"\"", "    title = sanitize(title.strip())", "", "    node = Node(", "        title=title,", "        creator=user,"]}, {"lines": ["        category='project',"]}, {"lines": ["        is_folder=True", "    )", "", "    node.save()", "", "    return node"]}, {"lines": ["                    'You are now a contributor to this project.',"]}, {"lines": ["from website.views import _render_nodes, find_dashboard"]}, {"lines": ["from website.project import new_folder"]}, {"lines": ["##############################################################################", "# New Folder", "##############################################################################"]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["    user = auth.user"]}, {"lines": ["", "    title = request.json.get('title')", ""]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["    folders = [folder]"]}, {"lines": ["    try:", "        _add_pointers(node, folders, auth)", "    except ValueError:"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["", "    return {", "        'projectUrl': '/dashboard/',", "    }, http.CREATED", ""]}, {"lines": ["@collect_auth"]}, {"lines": ["    user = auth.user"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)", "", "    folder = new_folder(", "        title, user", "    )", "    folders = [folder]"]}, {"lines": ["    try:", "        _add_pointers(node, folders, auth)", "    except ValueError:", "        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["    return {}, 201, None"]}, {"lines": [""]}, {"lines": ["", "# Expand/Collapse"]}, {"lines": ["@must_be_valid_project", "@must_be_contributor_or_public"]}, {"lines": ["    return {}, 200, None"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project", "@must_be_contributor_or_public"]}, {"lines": ["    return {}, 200, None"]}, {"lines": [""]}, {"lines": ["# Reorder components"]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"Remove folder node", "", "    \"\"\""]}, {"lines": ["    if node is None:", "        raise HTTPError(http.BAD_REQUEST)", "", "    if not node.is_folder or node.is_dashboard:", "        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": ["    try:", "        node.remove_node(auth)", "    except NodeStateError as e:", "        raise HTTPError(", "            http.BAD_REQUEST,", "            data={"]}, {"lines": ["                'message_long': 'Could not delete component: ' + e.message", "            },", "        )", "", "    return {}", "", ""]}, {"lines": ["    if user:"]}, {"lines": ["        dashboard = find_dashboard(user)", "        dashboard_id = dashboard._id"]}, {"lines": ["        in_dashboard = dashboard.pointing_at(node._primary_key) is not None", "    else:", "        in_dashboard = False"]}, {"lines": ["        dashboard_id = ''"]}, {"lines": ["            'in_dashboard': in_dashboard,"]}, {"lines": ["            'dashboard_id': dashboard_id,"]}, {"lines": ["                'parent_id': child.parent_id,"]}, {"lines": ["        'node': {'id': node._id, 'title': node.title, 'is_public': node.is_public},"]}, {"lines": [""]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["        return []"]}, {"lines": ["    ]"]}, {"lines": [""]}, {"lines": ["            'Anonymized view-only links <b>DO NOT</b> '", "            'anonymize contributors of public project or component.'"]}, {"lines": ["    no_folders_query = Q('is_folder', 'eq', False)"]}, {"lines": ["    odm_query = title_query & not_deleted_query & visibility_query & no_folders_query"]}, {"lines": [""]}, {"lines": ["@collect_auth"]}, {"lines": ["def move_pointers(auth):"]}, {"lines": ["    \"\"\"Move pointer from one node to another node.", "", "    \"\"\"", ""]}, {"lines": ["    from_node_id = request.json.get('fromNodeId')", "    to_node_id = request.json.get('toNodeId')", "    pointers_to_move = request.json.get('pointerIds')"]}, {"lines": [""]}, {"lines": ["    if from_node_id is None or to_node_id is None or pointers_to_move is None:"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": ["    from_node = Node.load(from_node_id)", "    to_node = Node.load(to_node_id)", ""]}, {"lines": ["    if to_node is None or from_node is None:", "        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": ["    for pointer_to_move in pointers_to_move:", "        pointer_id = from_node.pointing_at(pointer_to_move)", "        pointer_node = Node.load(pointer_to_move)"]}, {"lines": [""]}, {"lines": ["        pointer = Pointer.load(pointer_id)", "        if pointer is None:", "            raise HTTPError(http.BAD_REQUEST)", "", "        try:", "            from_node.rm_pointer(pointer, auth=auth)", "        except ValueError:", "            raise HTTPError(http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["        from_node.save()"]}, {"lines": ["        try:", "            _add_pointers(to_node, [pointer_node], auth)", "        except ValueError:", "            raise HTTPError(http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["    return {}, 200, None", ""]}, {"lines": [""]}, {"lines": ["@collect_auth", "def add_pointer(auth):", "    \"\"\"Add a single pointer to a node using only JSON parameters", "", "    \"\"\""]}, {"lines": ["    to_node_id = request.json.get('toNodeID')", "    pointer_to_move = request.json.get('pointerID')", "", "    if not (to_node_id and pointer_to_move):", "        raise HTTPError(http.BAD_REQUEST)", "", "    pointer = Node.load(pointer_to_move)", "    to_node = Node.load(to_node_id)"]}, {"lines": ["    try:", "        _add_pointers(to_node, [pointer], auth)", "    except ValueError:"]}, {"lines": [""]}, {"lines": ["    try:", "        _add_pointers(node, nodes, auth)", "    except ValueError:"]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"Remove a pointer from a node, raising a 400 if the pointer is not", "    in `node.nodes`.", "", "    \"\"\""]}, {"lines": ["    if pointer_id is None:"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": ["    pointer_id = node.pointing_at(pointer_id)"]}, {"lines": ["", "    pointer = Pointer.load(pointer_id)", "", "    if pointer is None:", "        raise HTTPError(http.BAD_REQUEST)", "", "    try:", "        node.rm_pointer(pointer, auth=auth)", "    except ValueError:", "        raise HTTPError(http.BAD_REQUEST)", "", "    node.save()", ""]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"Remove multiple pointers from a node, raising a 400 if the pointer is not", "    in `node.nodes`.", "    \"\"\""]}, {"lines": ["    pointer_ids = request.json.get('pointerIds')", "", "    if pointer_ids is None:", "        raise HTTPError(http.BAD_REQUEST)", "", "    for pointer_id in pointer_ids:", "        pointer_id = node.pointing_at(pointer_id)", "", "        pointer = Pointer.load(pointer_id)", "", "        if pointer is None:", "            raise HTTPError(http.BAD_REQUEST)", "", "        try:", "            node.rm_pointer(pointer, auth=auth)", "        except ValueError:", "            raise HTTPError(http.BAD_REQUEST)", "", "    node.save()", "", ""]}, {"lines": ["        except exceptions.MalformedQueryError:"]}, {"lines": ["            raise HTTPError(http.BAD_REQUEST, data={", "                'message_short': 'Bad search query',", "                'message_long': ('Please check our help (the question mark beside the search box) for more information '", "                                 'on advanced search queries.'),", "            })"]}, {"lines": ["        except exceptions.SearchUnavailableError:"]}, {"lines": ["    results = {}"]}, {"lines": ["def conditionally_add_query_item(query, item, condition):", "    \"\"\" Helper for the search_projects_by_title function which will add a condition to a query", "    It will give an error if the proper search term is not used.", "    :param query: The modular ODM query that you want to modify", "    :param item:  the field to query on", "    :param condition: yes, no, or either", "    :return: the modified query", "    \"\"\"", "", "    condition = condition.lower()", "", "    if condition == \"yes\":", "        return query & Q(item, 'eq', True)", "    elif condition == \"no\":", "        return query & Q(item, 'eq', False)", "    elif condition == \"either\":", "        return query", "", "    raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": [""]}, {"lines": ["    \"\"\" Search for nodes by title. Can pass in arguments from the URL to modify the search", "    :arg term: The substring of the title."]}, {"lines": ["    :arg category: Category of the node."]}, {"lines": ["    :arg isDeleted: yes, no, or either. Either will not add a qualifier for that argument in the search.", "    :arg isFolder: yes, no, or either. Either will not add a qualifier for that argument in the search."]}, {"lines": ["    :arg isRegistration: yes, no, or either. Either will not add a qualifier for that argument in the search."]}, {"lines": ["    :arg includePublic: yes or no. Whether the projects listed should include public projects.", "    :arg includeContributed: yes or no. Whether the search should include projects the current user has"]}, {"lines": ["        contributed to.", "    :arg ignoreNode: a list of nodes that should not be included in the search.", "    :return: a list of dictionaries of projects"]}, {"lines": ["    \"\"\""]}, {"lines": ["    # TODO(fabianvf): At some point, it would be nice to do this with elastic search"]}, {"lines": ["    term = request.args.get('term', '')"]}, {"lines": ["    max_results = int(request.args.get('maxResults', '10'))", "    category = request.args.get('category', 'project').lower()", "    is_deleted = request.args.get('isDeleted', 'no').lower()", "    is_folder = request.args.get('isFolder', 'no').lower()"]}, {"lines": ["    is_registration = request.args.get('isRegistration', 'no').lower()"]}, {"lines": ["    include_public = request.args.get('includePublic', 'yes').lower()", "    include_contributed = request.args.get('includeContributed', 'yes').lower()"]}, {"lines": ["    ignore_nodes = request.args.getlist('ignoreNode', [])"]}, {"lines": ["        Q('category', 'eq', category)  # is a project"]}, {"lines": ["    matching_title = conditionally_add_query_item(matching_title, 'is_deleted', is_deleted)", "    matching_title = conditionally_add_query_item(matching_title, 'is_folder', is_folder)"]}, {"lines": ["    matching_title = conditionally_add_query_item(matching_title, 'is_registration', is_registration)"]}, {"lines": [""]}, {"lines": ["    if len(ignore_nodes) > 0:", "        for node_id in ignore_nodes:", "            matching_title = matching_title & Q('_id', 'ne', node_id)", ""]}, {"lines": ["    my_projects = []", "    my_project_count = 0", "    public_projects = []"]}, {"lines": ["    if include_contributed == \"yes\":", "        my_projects = Node.find(", "            matching_title &", "            Q('contributors', 'contains', user._id)  # user is a contributor", "        ).limit(max_results)", "        my_project_count = my_project_count", ""]}, {"lines": ["    if my_project_count < max_results and include_public == \"yes\":"]}, {"lines": ["        ).limit(max_results - my_project_count)", ""]}, {"lines": ["", "", "@must_be_logged_in", "def process_project_search_results(results, **kwargs):", "    \"\"\"", "    :param results: list of projects from the modular ODM search", "    :return: we return the entire search result, which is a list of", "    dictionaries. This includes the list of contributors.", "    \"\"\"", "    user = kwargs['auth'].user", ""]}, {"lines": ["    page = int(bleach.clean(request.args.get('page', '0'), tags=[], strip=True))"]}, {"lines": ["    return search.search_contributor(query=query, page=page, size=size,"]}, {"lines": ["GRAVATAR_SIZE_PROFILE = 70"]}, {"lines": ["", "# Dashboard", "ALL_MY_PROJECTS_ID = '-amp'", "ALL_MY_REGISTRATIONS_ID = '-amr'", "ALL_MY_PROJECTS_NAME = 'All my projects'"]}, {"lines": ["ALL_MY_REGISTRATIONS_NAME = 'All my registrations'"]}, {"lines": ["            self.currentPage(0);"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var insDel = require('markdown-it-ins-del');", ""]}, {"lines": ["var highlighter = function (str, lang) {"]}, {"lines": ["    .use(require('markdown-it-toc'))"]}, {"lines": ["    .use(require('markdown-it-sanitizer'))", "    .use(insDel)", "    .disable('strikethrough');"]}, {"lines": ["var markdownQuick = new MarkdownIt(('commonmark'), { })"]}, {"lines": ["    .disable('link')"]}, {"lines": ["    .disable('image')", "    .use(insDel)", "    .disable('strikethrough');"]}, {"lines": ["    quick: markdownQuick"]}, {"lines": ["var bootbox = require('bootbox');"]}, {"lines": ["var NavbarViewModel = function() {"]}, {"lines": ["    self.showSearch = ko.observable(false);", "    self.searchCSS = ko.observable('');"]}, {"lines": ["    self.query = ko.observable('');"]}, {"lines": ["", "    self.onSearchPage = ko.computed(function() {"]}, {"lines": ["    });"]}, {"lines": ["    self.toggleSearch = function(){"]}, {"lines": ["            self.searchCSS('active');", "            $('#searchPageFullBar').focus();"]}, {"lines": ["        }", "    };", ""]}, {"lines": ["    self.help = function() {", "        bootbox.dialog({", "            title: 'Search help',", "            message: '<h4>Queries</h4>'+", "                '<p>Search uses the <a href=\"http://extensions.xwiki.org/xwiki/bin/view/Extension/Search+Application+Query+Syntax\">Lucene search syntax</a>. ' +", "                'This gives you many options, but can be very simple as well. ' +", "                'Examples of valid searches include:' +", "                '<ul><li><a href=\"/search/?q=repro*\">repro*</a></li>' +", "                '<li><a href=\"/search/?q=brian+AND+title%3Amany\">brian AND title:many</a></li>' +", "                '<li><a href=\"/search/?q=tags%3A%28psychology%29\">tags:(psychology)</a></li></ul>' +", "                '</p>'", "        });", "    };", "", ""]}, {"lines": ["    self.submit = function() {"]}, {"lines": ["        $('#searchPageFullBar').blur().focus();"]}, {"lines": ["       if(self.query() !== ''){", "           window.location.href = '/search/?q=' + self.query();", "       }"]}, {"lines": ["            contentType: 'application/json'"]}, {"lines": ["        error: $osf.handleEditableError"]}, {"lines": ["            dataType: 'json'"]}, {"lines": ["    }"]}, {"lines": ["    }"]}, {"lines": ["            }"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    });"]}, {"lines": ["function canAcceptDrop(items, folder, theCopyMode) {"]}, {"lines": ["        theCopyMode = copyMode;", "    }"]}, {"lines": ["    if (theCopyMode === 'move') {"]}, {"lines": ["    if (theCopyMode === 'copy') {"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["module.exports = {", "    ProjectOrganizer: ProjectOrganizer,", "    _whichIsContainer: whichIsContainer,", "    _canAcceptDrop: canAcceptDrop", "};"]}, {"lines": ["new profile.Social('#social', ctx.socialUrls, ['view']);", "new profile.Jobs('#jobs', ctx.jobsUrls, ['view']);", "new profile.Schools('#schools', ctx.schoolsUrls, ['view']);"]}, {"lines": ["        var markdownElement = $('#markdownRender');"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var WikiPage = require('wikiPage');", "", "require('ace-noconflict');", "require('ace-mode-markdown');", "require('ace-ext-language_tools');", "require('addons/wiki/static/ace-markdown-snippets.js');", ""]}, {"lines": ["var editable = (ctx.panelsUsed.indexOf('edit') !== -1);", "var viewable = (ctx.panelsUsed.indexOf('view') !== -1);", "var comparable = (ctx.panelsUsed.indexOf('compare') !== -1);"]}, {"lines": ["var wikiPageOptions = {", "    editVisible: editable,"]}, {"lines": ["    viewVisible: viewable,", "    compareVisible: comparable,"]}, {"lines": ["    canEdit: ctx.canEdit,"]}, {"lines": ["    metadata: ctx.metadata"]}, {"lines": ["};", ""]}, {"lines": ["var wikiPage = new WikiPage('#wikiPageContext', wikiPageOptions);"]}, {"lines": ["            // title = Text of the button"]}, {"lines": ["            // thisbtn = $(this);"]}, {"lines": ["            if (typeof editor !== 'undefined') { ace.edit(editor).resize(); } // jshint ignore: line"]}, {"lines": ["        }"]}, {"lines": ["});"]}, {"lines": ["<%def name=\"container_class()\">", "    ### CSS classes to apply to the \"content\" div ###", "</%def>", ""]}, {"lines": ["    <!-- ko ifnot: onSearchPage -->"]}, {"lines": ["        <%include file='./search_bar.mako' />"]}, {"lines": ["    <!-- /ko -->"]}, {"lines": ["    <div class=\"container\">", "        <div class=\"row\">", "            <div class=\"col-md-12\">"]}, {"lines": ["                <form class=\"input-group\" data-bind=\"submit: submit\">"]}, {"lines": ["                    <span class=\"input-group-btn\">"]}, {"lines": ["                    </span>", "                </form>", "            </div>", "        </div>", "    </div>", "</div>"]}, {"lines": ["                                            ${'checked' if (addon.short_name in addons_enabled) else ''}"]}, {"lines": ["                                            <img data-bind=\"attr: {src: contributor.gravatar_url}\" height=40 width=40 />"]}, {"lines": ["                                    <p><strong>", "                                        <a href=\"#\"data-bind=\"click:gotoInvite\">Add <em>{{query}}</em> as an unregistered contributor</a>.", "                                    </strong></p>"]}, {"lines": ["    src=\"/static/vendor/bower_components/MathJax/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML\">"]}, {"lines": ["        Features </a>page, or see how other scientists <a href=\"/svje2/\">use the OSF.</a></p>"]}, {"lines": ["    <img src=\"${ meeting['logo_url'] }\" class=\"img-responsive\" />"]}, {"lines": ["from website import settings as website_settings", "from api.base import settings as api_settings"]}, {"lines": ["               base_route=website_settings.API_DOMAIN,", "               base_prefix=api_settings.API_PREFIX,"]}, {"lines": ["    url = furl.furl(website_settings.WATERBUTLER_URL)"]}, {"lines": ["    elif website_settings.COOKIE_NAME in request.cookies:", "        url.args['cookie'] = request.cookies[website_settings.COOKIE_NAME]"]}, {"lines": ["import os"]}, {"lines": ["import mimetypes", ""]}, {"lines": ["HERE = os.path.dirname(os.path.abspath(__file__))", "MIMEMAP = os.path.join(HERE, 'mime.types')", ""]}, {"lines": [""]}, {"lines": ["def get_mimetype(path, file_contents=None):"]}, {"lines": ["    mimetypes.init([MIMEMAP])"]}, {"lines": ["    mimetype, _ = mimetypes.guess_type(path)", ""]}, {"lines": ["    if mimetype is None:"]}, {"lines": ["        try:", "            import magic"]}, {"lines": ["            if file_contents is not None:", "                mimetype = magic.from_buffer(file_contents, mime=True)", "            else:", "                mimetype = magic.from_file(path, mime=True)"]}, {"lines": ["        except ImportError:", "            return mimetype", ""]}], "name": "Brian J. Geiger"}, {"commits": [{"lines": ["var webpack = require('webpack');"]}, {"lines": ["var path = require('path');", "var fs = require('fs');", ""]}, {"lines": ["var addons = require('./addons.json');", "var root = path.join(__dirname, 'website', 'static');", "/** Return the absolute path given a path relative to ./website/static */", "var staticPath = function(dir) {", "    return path.join(root, dir);", "};"]}, {"lines": [""]}, {"lines": ["var entry = {"]}, {"lines": ["    'base-page': staticPath('js/pages/base-page.js'),", "    'home-page': staticPath('js/pages/home-page.js'),", "    'dashboard-page': staticPath('js/pages/dashboard-page.js'),", "    'profile-page': staticPath('js/pages/profile-page.js'),", "    'project-dashboard': staticPath('js/pages/project-dashboard-page.js'),", "    'project-base-page': staticPath('js/pages/project-base-page.js'),", "    'wiki-edit-page': staticPath('js/pages/wiki-edit-page.js'),"]}, {"lines": ["    'files-page': staticPath('js/pages/files-page.js'),", "    'profile-settings-page': staticPath('js/pages/profile-settings-page.js'),"]}, {"lines": ["    'register_1-page': staticPath('js/pages/register_1-page.js'),", "    'sharing-page': staticPath('js/pages/sharing-page.js'),", "    'conference-page': staticPath('js/pages/conference-page.js'),"]}, {"lines": ["    'project-settings-page': staticPath('js/pages/project-settings-page.js'),", "    'search-page': staticPath('js/pages/search-page.js'),"]}, {"lines": ["    // Commons chunk", "    'vendor': ["]}, {"lines": ["        'knockout',"]}, {"lines": ["        'bootstrap',", "        'bootbox',"]}, {"lines": ["        'select2',"]}, {"lines": ["        'dropzone',", "        'knockout-sortable',"]}, {"lines": ["        'treebeard',"]}, {"lines": ["    ]", "};", "", "// Collect adddons endpoints. If an addon's static folder has", "// any of the following files, it will be added as an entry point", "// and output to website/static/public/js/<addon-name>/files.js", "var addonModules = ['files.js', 'node-cfg.js', 'user-cfg.js', 'file-detail.js', 'widget-cfg.js'];", "addons.addons.forEach(function(addonName) {", "    var baseDir = addonName + '/';", "    addonModules.forEach(function(module) {", "        var modulePath = path.join(__dirname, 'website', 'addons',", "                                  addonName, 'static', module);", "        if (fs.existsSync(modulePath)) {", "            var entryPoint = baseDir + module.split('.')[0];", "            entry[entryPoint] =  modulePath;", "        }", "    });", "});", ""]}, {"lines": ["var resolve = {"]}, {"lines": ["    root: root,", "    // Look for required files in bower and npm directories", "    modulesDirectories: ['./website/static/vendor/bower_components', 'node_modules'],", "    // Need to alias libraries that aren't managed by bower or npm", "    alias: {"]}, {"lines": ["        'knockout-sortable': staticPath('vendor/knockout-sortable/knockout-sortable.js'),"]}, {"lines": ["        'jquery-blockui': staticPath('vendor/jquery-blockui/jquery.blockui.js'),"]}, {"lines": ["        'bootstrap': staticPath('vendor/bower_components/bootstrap/dist/js/bootstrap.min.js'),", "        'jquery-tagsinput': staticPath('vendor/bower_components/jquery.tagsinput/jquery.tagsinput.js'),"]}, {"lines": ["        // Needed for knockout-sortable", "        'jquery.ui.sortable': staticPath('vendor/bower_components/jquery-ui/ui/jquery.ui.sortable.js'),"]}, {"lines": ["        // Also alias some internal libraries for easy access"]}, {"lines": ["        'addons': path.join(__dirname, 'website', 'addons'),"]}, {"lines": ["    }", "};", "", "var externals = {", "    // require(\"jquery\") is external and available", "    //  on the global var jQuery, which is loaded with CDN", "    'jquery': 'jQuery',", "    'jquery-ui': 'jQuery.ui',"]}, {"lines": ["};", "", "var plugins = [", "    // Bundle common code between modules"]}, {"lines": ["    // Bower support", "    new webpack.ResolverPlugin(", "        new webpack.ResolverPlugin.DirectoryDescriptionFilePlugin('bower.json', ['main'])", "    ),", "    // Make jQuery available in all modules without having to do require('jquery')", "    new webpack.ProvidePlugin({", "        $: 'jquery',", "        jQuery: 'jquery'", "    }),", "    // Slight hack to make sure that CommonJS is always used", "    new webpack.DefinePlugin({", "        'define.amd': false", "    }),", "];", ""]}, {"lines": ["", "var output = {", "    path: './website/static/public/js/',", "    // publicPath: '/static/', // used to generate urls to e.g. images"]}, {"lines": ["};", ""]}, {"lines": ["module.exports = {", "    entry: entry,", "    resolve: resolve,", "    externals: externals,"]}, {"lines": ["    plugins: plugins,"]}, {"lines": ["};"]}, {"lines": ["var webpack = require('webpack');"]}, {"lines": ["var common = require('./webpack.common.config.js');"]}, {"lines": [""]}, {"lines": ["    plugins: common.plugins.concat(["]}, {"lines": ["        new webpack.optimize.DedupePlugin(),", "        new webpack.optimize.OccurenceOrderPlugin(),", "        new webpack.optimize.AggressiveMergingPlugin(),"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8", "", "from website.conferences.model import Conference"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["", "import logging", "import datetime", "", "from dateutil import relativedelta"]}, {"lines": ["", "from website.models import Session"]}, {"lines": [""]}, {"lines": ["logger = logging.getLogger(__name__)", "logger.setLevel(logging.WARN)", ""]}, {"lines": ["", "def clear_sessions(max_date, dry_run=False):", "    \"\"\"Remove all sessions last modified before `max_date`.", "    \"\"\""]}, {"lines": ["    session_collection = Session._storage[0].store", "    query = {'date_modified': {'$lt': max_date}}"]}, {"lines": ["    if dry_run:", "        logger.warn('Dry run mode')", "    logger.warn(", "        'Removing {0} stale sessions'.format("]}, {"lines": ["            session_collection.find(query).count()"]}, {"lines": ["        )", "    )", "    if not dry_run:"]}, {"lines": ["        session_collection.remove(query)"]}, {"lines": ["", "", "def clear_sessions_relative(months=1, dry_run=False):", "    \"\"\"Remove all sessions last modified over `months` months ago.", "    \"\"\""]}, {"lines": ["    now = datetime.datetime.utcnow()", "    delta = relativedelta.relativedelta(months=months)", "    clear_sessions(now - delta, dry_run=dry_run)"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8", "\"\"\"Find all nodes with different sets of keys for `files_current` and", "`files_versions`, and ensure that all keys present in the former are also", "present in the latter."]}, {"lines": ["\"\"\"", "", "from website.models import Node", "from website.app import init_app", "", "", "def find_file_mismatch_nodes():", "    \"\"\"Find nodes with inconsistent `files_current` and `files_versions` field", "    keys.", "    \"\"\"", "    return [", "        node for node in Node.find()", "        if set(node.files_versions.keys()) != set(node.files_current.keys())", "    ]", "", "", "def migrate_node(node):", "    \"\"\"Ensure that all keys present in `files_current` are also present in", "    `files_versions`.", "    \"\"\"", "    for key, file_id in node.files_current.iteritems():", "        if key not in node.files_versions:", "            node.files_versions[key] = [file_id]", "        else:", "            if file_id not in node.files_versions[key]:", "                node.files_versions[key].append(file_id)", "    node.save()", "", "", "def main(dry_run=True):", "    init_app()", "    nodes = find_file_mismatch_nodes()", "    print('Migrating {0} nodes'.format(len(nodes)))", "    if dry_run:", "        return", "    for node in nodes:", "        migrate_node(node)", "", "", "if __name__ == '__main__':", "    import sys", "    dry_run = 'dry' in sys.argv", "    main(dry_run=dry_run)", "", "", "from nose.tools import *  # noqa", "", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory", "", "from framework.auth import Auth", "", "", "class TestMigrateFiles(OsfTestCase):", "", "    def clear(self):", "        Node.remove()", "", "    def setUp(self):", "        super(TestMigrateFiles, self).setUp()", "        self.clear()", "        self.nodes = []", "        for idx in range(3):", "            node = ProjectFactory()", "            node.add_file(", "                Auth(user=node.creator),", "                'name',", "                'contents',", "                len('contents'),", "                'text/plain',", "            )", "            self.nodes.append(node)", "        self.nodes[-1].files_versions = {}", "        self.nodes[-1].save()", "        # Sanity check", "        assert_in('name', self.nodes[-1].files_current)", "        assert_not_in('name', self.nodes[-1].files_versions)", "", "    def tearDown(self):", "        super(TestMigrateFiles, self).tearDown()", "        self.clear()", "", "    def test_get_targets(self):", "        targets = find_file_mismatch_nodes()", "        assert_equal(len(targets), 1)", "        assert_equal(targets[0], self.nodes[-1])", "", "    def test_migrate(self):", "        main(dry_run=False)", "        assert_equal(len(find_file_mismatch_nodes()), 0)", "        assert_in('name', self.nodes[-1].files_versions)", "        assert_equal(", "            self.nodes[-1].files_current['name'],", "            self.nodes[-1].files_versions['name'][0],", "        )"]}, {"lines": ["", "import os"]}, {"lines": ["", "from website import settings"]}, {"lines": ["from website.conferences.model import Conference", ""]}, {"lines": [""]}, {"lines": ["        'active': False,"]}, {"lines": ["            # 'Dkim@nrao.edu',"]}, {"lines": ["    'bitss2014': {"]}, {"lines": ["        'info_url': None,", "        'logo_url': os.path.join(", "            settings.STATIC_URL_PATH,", "            'img',", "            'conferences',", "            'bitss.jpg',", "        ),"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'admins': [", "            'gkroll@berkeley.edu',"]}, {"lines": ["            'awais@berkeley.edu',"]}, {"lines": ["        ],", "        'public_projects': True,", "    },"]}, {"lines": ["    'spsp2015': {"]}, {"lines": ["        'admins': [", "            'meetings@spsp.org',"]}, {"lines": ["        ],", "    },"]}, {"lines": ["    'aps2015': {"]}, {"lines": ["        'logo_url': 'http://www.psychologicalscience.org/images/APS_2015_Banner_990x157.jpg',", "        'active': True,", "        'admins': ["]}, {"lines": ["        ],", "        'public_projects': True,", "    },", "    'icps2015': {"]}, {"lines": ["        'logo_url': 'http://icps.psychologicalscience.org/wp-content/themes/deepblue/images/ICPS_Website-header_990px.jpg',"]}, {"lines": ["        'admins': ["]}, {"lines": ["        ],", "        'public_projects': True,", "    },", "    'mpa2015': {"]}, {"lines": ["        'logo_url': 'http://www.midwesternpsych.org/resources/Pictures/MPA%20logo.jpg',", "        'active': True,", "        'admins': [", "            'mpa@kent.edu',"]}, {"lines": ["        ],", "        'public_projects': True,", "    },"]}, {"lines": [""]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import os", "import logging", "import datetime", "", "from website import settings", "", "", "def format_now():", "    return datetime.datetime.now().isoformat()", "", ""]}, {"lines": ["    _, name = os.path.split(script_name)"]}, {"lines": ["    file_handler = logging.FileHandler(", "        os.path.join(", "            settings.LOG_PATH,", "            '.'.join([name, format_now(), 'log'])", "        )", "    )", "    logger.addHandler(file_handler)"]}, {"lines": ["from framework.mongo import database"]}, {"lines": ["from .utils import plot_dates, oid_to_datetime, mkdirp"]}, {"lines": ["log_collection = database['nodelog']"]}, {"lines": ["FIG_PATH = os.path.join(settings.ANALYTICS_PATH, 'figs', 'addons')", "mkdirp(FIG_PATH)", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        if not result['dates']:", "            continue"]}, {"lines": ["        plt.title('{} configurations: {} ({} total)'.format(name, model, len(result['dates'])))", "        plt.savefig(os.path.join(FIG_PATH, '{}-installs-{}.png'.format(name, model)))"]}, {"lines": ["    if not log_dates:", "        return"]}, {"lines": ["    plt.title('{} actions ({} total)'.format(name, len(log_dates)))", "    plt.savefig(os.path.join(FIG_PATH, '{}-actions.png'.format(name)))"]}, {"lines": ["def main():"]}, {"lines": ["    init_app(routes=False)"]}, {"lines": ["", "if __name__ == '__main__':", "    main()"]}, {"lines": ["from framework.mongo import database"]}, {"lines": ["from utils import plot_dates, mkdirp"]}, {"lines": ["comment_collection = database['comment']"]}, {"lines": ["FIG_PATH = os.path.join(settings.ANALYTICS_PATH, 'figs', 'features')", "mkdirp(FIG_PATH)"]}, {"lines": ["def main():"]}, {"lines": ["    main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "\"\"\"", "Summarize distribution of file sizes in OSF git repos.", "\"\"\"", "", "from __future__ import division", "", "import os", "", "import numpy as np", "import tabulate", "", "from website import settings", "", "", "def walk_collect(path, func):", "    sizes = []", "    for root, dirs, files in os.walk(path):", "        try:", "            dirs.remove('.git')", "        except ValueError:", "            pass", "        sizes.extend([", "            func(root, file)", "            for file in files", "        ])", "    return sizes", "", "", "def size_helper(root, file):", "    return root, file, os.stat(os.path.join(root, file)).st_size", "", "", "def size_percentiles():", "    sizes = walk_collect(settings.UPLOADS_PATH, size_helper)", "", "    cutoffs = range(2, 102, 2)", "    percentiles = np.percentile(", "        [size[-1] / 1024 / 1024 for size in sizes],", "        cutoffs,", "    )", "", "    return tabulate.tabulate(", "        zip(cutoffs, percentiles),", "        headers=['Percentile', 'Size (MiB)'],", "    )", "", "", "if __name__ == '__main__':", "    print(size_percentiles())", ""]}, {"lines": ["from framework.mongo import database"]}, {"lines": ["from .utils import plot_dates, mkdirp"]}, {"lines": ["link_collection = database['privatelink']"]}, {"lines": ["FIG_PATH = os.path.join(settings.ANALYTICS_PATH, 'figs', 'features')", "mkdirp(FIG_PATH)"]}, {"lines": ["def analyze_view_only_links():"]}, {"lines": ["    if not dates:", "        return"]}, {"lines": ["    plt.title('view-only links ({} total)'.format(len(dates)))", "    plt.savefig(os.path.join(FIG_PATH, 'view-only-links.png'))"]}, {"lines": ["def analyze_view_only_links_anonymous():", "    dates = [", "        record['date_created']", "        for record in link_collection.find(", "            {'anonymous': True},", "            {'date_created': True},", "        )", "    ]", "    if not dates:", "        return", "    fig = plot_dates(dates)", "    plt.title('anonymous view-only links ({} total)'.format(len(dates)))", "    plt.savefig(os.path.join(FIG_PATH, 'view-only-links-anonymous.png'))", "    plt.close()", "", "", "def main():", "    analyze_view_only_links()", "    analyze_view_only_links_anonymous()", "", ""]}, {"lines": ["    main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import os", "from collections import Counter", "from tabulate import tabulate", ""]}, {"lines": ["from framework.mongo import database"]}, {"lines": ["from website import settings", "", "from .utils import mkdirp", "", ""]}, {"lines": ["node_collection = database['node']"]}, {"lines": ["", "TAB_PATH = os.path.join(settings.ANALYTICS_PATH, 'tables', 'features')", "mkdirp(TAB_PATH)", "", "", "def main():", "    counter = Counter()", "    for node in node_collection.find():", "        permissions = node.get('permissions')", "        # TODO: Shouldn't need this check", "        if not permissions:", "            continue", "        counter.update([", "            tuple(permissions)", "            for _, permissions in permissions.items()", "        ])", "    table = tabulate(", "        [", "            ['total', 'admin', 'write', 'read'],", "            [", "                sum(counter.values()),", "                counter[('read', 'write', 'admin', )],", "                counter[('read', 'write', )],", "                counter[('read', )]", "            ]", "        ],", "        headers='firstrow',", "    )", "    with open(os.path.join(TAB_PATH, 'permissions.txt'), 'w') as fp:", "        fp.write(table)", "", "", "if __name__ == '__main__':", "    main()", ""]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Scripts for counting recently added users by email domain; pushes results", "to the specified project.", "\"\"\"", ""]}, {"lines": ["import datetime", "import collections"]}, {"lines": [""]}, {"lines": ["from framework.mongo import database", "", "from website import models", "from website.app import app, init_app"]}, {"lines": ["", "from scripts.analytics import utils"]}, {"lines": ["", "", "def get_emails(query=None):", "    users = database['user'].find(query, {'username': True})", "    counts = collections.Counter(", "        user['username'].split('@')[-1]", "        for user in users", "    )", "    return counts.most_common()", "", "", "def get_emails_since(delta):", "    return get_emails({"]}, {"lines": ["    })", "", "", "def main():"]}, {"lines": ["", "", "if __name__ == '__main__':"]}, {"lines": ["    init_app()"]}, {"lines": ["    main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Scripts for aggregating recently added logs by action type; pushes results", "to the specified project.", "\"\"\"", "", "import bson", "import datetime"]}, {"lines": ["", "import pymongo"]}, {"lines": ["", "from framework.mongo import database", "", "from website import models", "from website.app import app, init_app", "", "from scripts.analytics import utils"]}, {"lines": ["", "", "mapper = bson.Code('''function() {", "    emit(this.action, 1);", "}''')", "", "", "reducer = bson.Code('''function(key, values) {", "    var count = 0;", "    for (var i=0; i<values.length; i++) {", "        count += values[i];", "    }", "    return count;", "}''')", "", "", "def run_map_reduce(**kwargs):", "    return database['nodelog'].map_reduce(", "        mapper,", "        reducer,"]}, {"lines": ["        **kwargs", "    )", "", "", "def main():"]}, {"lines": ["    result = run_map_reduce(query={'date': {'$gt': cutoff}})"]}, {"lines": ["        (", "            (row['_id'], row['value'])", "            for row in result.find().sort([('value', pymongo.DESCENDING)])", "        ),", "        ['name', 'count'],", "    )"]}, {"lines": ["", "", "if __name__ == '__main__':"]}, {"lines": ["    main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import os", "import matplotlib.pyplot as plt", ""]}, {"lines": ["from framework.mongo import database"]}, {"lines": ["from website import settings", "", "from .utils import plot_dates, oid_to_datetime, mkdirp", "", ""]}, {"lines": ["watch_collection = database['watchconfig']"]}, {"lines": ["", "FIG_PATH = os.path.join(settings.ANALYTICS_PATH, 'figs', 'features')", "mkdirp(FIG_PATH)", "", "", "def main():", "    watch_configs = watch_collection.find()", "    dates_watched = [", "        oid_to_datetime(watch_config['_id'])", "        for watch_config in watch_configs", "    ]", "    fig = plot_dates(dates_watched)", "    plt.title('nodes watched ({}) total)'.format(len(dates_watched)))", "    plt.savefig(os.path.join(FIG_PATH, 'nodes-watched.png'))", "    plt.close()", "", "", "if __name__ == '__main__':", "    main()", ""]}, {"lines": ["from modularodm import Q", "", "import mock", "from nose.tools import *", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory"]}, {"lines": ["from framework.mongo import StoredObject"]}, {"lines": ["from website.addons.github.model import AddonGitHubNodeSettings"]}, {"lines": ["from website.addons.github.exceptions import ApiError"]}, {"lines": ["logger = logging.getLogger(__name__)"]}, {"lines": ["    \"\"\"Discard the existing webhook for a GitHub node add-on and create a new", "    one."]}, {"lines": ["    \"\"\"", "    logger.warn("]}, {"lines": ["    if hook is None:", "        logger.warn('Hook {0} not found'.format(node_settings.hook_id))", "        return", ""]}, {"lines": ["def get_targets():", "    \"\"\"Get `AddonGitHubNodeSettings` records with authorization and a non-null", "    webhook.", "", "    \"\"\"", "    return AddonGitHubNodeSettings.find(", "        Q('user_settings', 'ne', None) &", "        Q('hook_id', 'ne', None)", "    )", "", "", "def main():", "    targets = get_targets()", "    for target in targets:", "        try:", "            update_hook(target)"]}, {"lines": ["        except (GitHubError, ApiError) as error:"]}, {"lines": ["            logging.exception(error)", "            continue", "", "", "class TestHookMigration(OsfTestCase):", "", "    def setUp(self):", "        super(TestHookMigration, self).setUp()", "        self.project = ProjectFactory()", "        self.project.creator.add_addon('github')", "        self.user_addon = self.project.creator.get_addon('github')", "        self.project.add_addon('github', None)", "        self.node_addon = self.project.get_addon('github')", "        self.node_addon.hook_id = 1", "        self.node_addon.user_settings = self.user_addon", "        self.node_addon.save()", "", "    @mock.patch('website.addons.github.utils.make_hook_secret')", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_update_hook(self, mock_repo, mock_make_secret):", "        mock_make_secret.return_value = 'shh'", "        update_hook(self.node_addon)", "        self.node_addon.reload()", "        assert_equal(self.node_addon.hook_secret, 'shh')", "", "    def test_get_targets(self):", "        AddonGitHubNodeSettings.remove()", "        addons = [", "            AddonGitHubNodeSettings(),", "            AddonGitHubNodeSettings(hook_id=1),", "            AddonGitHubNodeSettings(user_settings=self.user_addon),", "            AddonGitHubNodeSettings(hook_id=1, user_settings=self.user_addon),", "        ]", "        for addon in addons:", "            addon.save()", "        targets = get_targets()", "        assert_equal(targets.count(), 1)", "        assert_equal(targets[0]._id, addons[-1]._id)"]}, {"lines": ["    app = init_app('website.settings', set_backends=True, routes=True)", "    main()", ""]}, {"lines": ["# encoding: utf-8", "", "from .defaults import *", "", "", "try:", "    from .local import *", "except ImportError as error:", "    pass"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import furl", "import itsdangerous"]}, {"lines": [""]}, {"lines": ["from framework.auth.core import Auth", "from framework.exceptions import HTTPError", "from framework.sessions.model import Session"]}, {"lines": ["", "from website import settings"]}, {"lines": ["from website.project import new_private_link"]}, {"lines": ["from website.addons.base import AddonConfig, AddonNodeSettingsBase, views", "from website.addons.github.model import AddonGitHubOauthSettings"]}, {"lines": [""]}, {"lines": ["class SetEnvironMiddleware(object):", "", "    def __init__(self, app, **kwargs):", "        self.app = app", "        self.kwargs = kwargs", "", "    def __call__(self, environ, start_response):", "        environ.update(self.kwargs)", "        return self.app(environ, start_response)", "", ""]}, {"lines": ["class TestAddonAuth(OsfTestCase):", "", "    def setUp(self):", "        super(TestAddonAuth, self).setUp()"]}, {"lines": ["        self.flask_app = SetEnvironMiddleware(self.app.app, REMOTE_ADDR='127.0.0.1')", "        self.test_app = webtest.TestApp(self.flask_app)"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.auth_obj = Auth(user=self.user)", "        self.node = ProjectFactory(creator=self.user)", "        self.session = Session(data={'auth_user_id': self.user._id})", "        self.session.save()", "        self.cookie = itsdangerous.Signer(settings.SECRET_KEY).sign(self.session._id)", "        self.configure_addon()", "", "    def configure_addon(self):", "        self.user.add_addon('github')", "        self.user_addon = self.user.get_addon('github')", "        self.oauth_settings = AddonGitHubOauthSettings(github_user_id='john')", "        self.oauth_settings.save()", "        self.user_addon.oauth_settings = self.oauth_settings", "        self.user_addon.oauth_access_token = 'secret'", "        self.user_addon.save()", "        self.node.add_addon('github', self.auth_obj)", "        self.node_addon = self.node.get_addon('github')", "        self.node_addon.user = 'john'", "        self.node_addon.repo = 'youre-my-best-friend'", "        self.node_addon.user_settings = self.user_addon", "        self.node_addon.save()", "", "    def build_url(self, **kwargs):", "        options = dict(", "            action='download',", "            cookie=self.cookie,"]}, {"lines": ["            nid=self.node._id,", "            provider=self.node_addon.config.short_name,", "        )", "        options.update(kwargs)", "        return api_url_for('get_auth', **options)", "", "    def test_auth_download(self):", "        url = self.build_url()"]}, {"lines": ["        res = self.test_app.get(url)"]}, {"lines": ["        assert_equal(res.json['auth'], views.make_auth(self.user))", "        assert_equal(res.json['credentials'], self.node_addon.serialize_waterbutler_credentials())", "        assert_equal(res.json['settings'], self.node_addon.serialize_waterbutler_settings())", "        expected_url = furl.furl(self.node.api_url_for('create_waterbutler_log', _absolute=True))", "        observed_url = furl.furl(res.json['callback_url'])", "        observed_url.port = expected_url.port", "        assert_equal(expected_url, observed_url)", "", "    def test_auth_missing_args(self):", "        url = self.build_url(cookie=None)"]}, {"lines": ["        res = self.test_app.get(url, expect_errors=True)"]}, {"lines": ["", "    def test_auth_bad_cookie(self):", "        url = self.build_url(cookie=self.cookie[::-1])"]}, {"lines": ["        res = self.test_app.get(url, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 401)", "", "    def test_auth_missing_addon(self):", "        url = self.build_url(provider='queenhub')"]}, {"lines": ["        res = self.test_app.get(url, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 400)", ""]}, {"lines": ["    def test_auth_bad_ip(self):", "        flask_app = SetEnvironMiddleware(self.app.app, REMOTE_ADDR='192.168.1.1')", "        test_app = webtest.TestApp(flask_app)", "        url = self.build_url()", "        res = test_app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 403)", ""]}, {"lines": [""]}, {"lines": ["class TestCheckAuth(OsfTestCase):", "", "    def setUp(self):", "        super(TestCheckAuth, self).setUp()", "        self.user = AuthUserFactory()", "        self.node = ProjectFactory(creator=self.user)", "", "    def test_has_permission(self):", "        res = views.check_access(self.node, self.user, 'upload')", "        assert_true(res)", "", "    def test_not_has_permission_read_public(self):", "        self.node.is_public = True", "        self.node.save()", "        res = views.check_access(self.node, None, 'download')", "", "    def test_not_has_permission_read_has_link(self):", "        link = new_private_link('red-special', self.user, [self.node], anonymous=False)", "        res = views.check_access(self.node, None, 'download', key=link.key)", "", "    def test_not_has_permission_logged_in(self):", "        user2 = AuthUserFactory()", "        with assert_raises(HTTPError) as exc_info:", "            views.check_access(self.node, user2, 'download')", "        assert_equal(exc_info.exception.code, 403)", "", "    def test_not_has_permission_not_logged_in(self):", "        with assert_raises(HTTPError) as exc_info:", "            views.check_access(self.node, None, 'download')", "        assert_equal(exc_info.exception.code, 401)"]}, {"lines": ["import mock"]}, {"lines": [""]}, {"lines": ["import hmac", "import hashlib"]}, {"lines": ["from StringIO import StringIO", ""]}, {"lines": ["import furl", "from modularodm import Q", "from modularodm.exceptions import ValidationError", ""]}, {"lines": ["from framework.auth.core import Auth"]}, {"lines": [""]}, {"lines": ["from website import settings"]}, {"lines": ["from website.models import User, Node"]}, {"lines": ["from website.conferences import utils, message"]}, {"lines": ["from tests.factories import ModularOdmFactory, FakerAttribute, ProjectFactory, UserFactory"]}, {"lines": ["from factory import Sequence, post_generation"]}, {"lines": [""]}, {"lines": ["def assert_absolute(url):", "    parsed_domain = furl.furl(settings.DOMAIN)", "    parsed_url = furl.furl(url)", "    assert_equal(parsed_domain.host, parsed_url.host)", "", ""]}, {"lines": ["    endpoint = Sequence(lambda n: 'conference{0}'.format(n))"]}, {"lines": ["    @post_generation", "    def admins(self, create, extracted, **kwargs):", "        self.admins = extracted or [UserFactory()]", ""]}, {"lines": ["class TestConferenceUtils(OsfTestCase):", "", "    def test_get_or_create_user_exists(self):", "        user = UserFactory()", "        fetched, created = utils.get_or_create_user(user.fullname, user.username, True)", "        assert_false(created)", "        assert_equal(user._id, fetched._id)", "        assert_false('is_spam' in fetched.system_tags)", "", "    def test_get_or_create_user_not_exists(self):", "        fullname = 'Roger Taylor'", "        username = 'roger@queen.com'", "        fetched, created = utils.get_or_create_user(fullname, username, False)", "        assert_true(created)", "        assert_equal(fetched.fullname, fullname)", "        assert_equal(fetched.username, username)", "        assert_false('is_spam' in fetched.system_tags)", "", "    def test_get_or_create_user_is_spam(self):", "        fullname = 'John Deacon'", "        username = 'deacon@queen.com'", "        fetched, created = utils.get_or_create_user(fullname, username, True)", "        assert_true(created)", "        assert_equal(fetched.fullname, fullname)", "        assert_equal(fetched.username, username)", "        assert_true('is_spam' in fetched.system_tags)", "", "    def test_get_or_create_node_exists(self):", "        node = ProjectFactory()", "        fetched, created = utils.get_or_create_node(node.title, node.creator)", "        assert_false(created)", "        assert_equal(node._id, fetched._id)", "", "    def test_get_or_create_node_title_not_exists(self):", "        title = 'Night at the Opera'", "        creator = UserFactory()", "        node = ProjectFactory(creator=creator)", "        fetched, created = utils.get_or_create_node(title, creator)", "        assert_true(created)", "        assert_not_equal(node._id, fetched._id)", "", "    def test_get_or_create_node_user_not_exists(self):", "        title = 'Night at the Opera'", "        creator = UserFactory()", "        node = ProjectFactory(title=title)", "        fetched, created = utils.get_or_create_node(title, creator)", "        assert_true(created)", "        assert_not_equal(node._id, fetched._id)", "", ""]}, {"lines": ["class ContextTestCase(OsfTestCase):"]}, {"lines": [""]}, {"lines": ["    MAILGUN_API_KEY = 'mailkimp'", "", "    @classmethod", "    def setUpClass(cls):", "        super(ContextTestCase, cls).setUpClass()", "        settings.MAILGUN_API_KEY, cls._MAILGUN_API_KEY = cls.MAILGUN_API_KEY, settings.MAILGUN_API_KEY", "", "    @classmethod", "    def tearDownClass(cls):", "        super(ContextTestCase, cls).tearDownClass()", "        settings.MAILGUN_API_KEY = cls._MAILGUN_API_KEY", "", "    def make_context(self, method='POST', **kwargs):"]}, {"lines": ["        data = {", "            'X-Mailgun-Sscore': 0,", "            'timestamp': '123',", "            'token': 'secret',", "            'signature': hmac.new(", "                key=settings.MAILGUN_API_KEY,", "                msg='{}{}'.format('123', 'secret'),", "                digestmod=hashlib.sha256,", "            ).hexdigest(),", "        }", "        data.update(kwargs.pop('data', {}))"]}, {"lines": ["        data = {", "            key: value", "            for key, value in data.iteritems()", "            if value is not None", "        }"]}, {"lines": ["        return self.app.app.test_request_context(method=method, data=data, **kwargs)", ""]}, {"lines": ["", "class TestProvisionNode(ContextTestCase):", "", "    def setUp(self):", "        super(TestProvisionNode, self).setUp()", "        self.node = ProjectFactory()", "        self.user = self.node.creator", "        self.conference = ConferenceFactory()", "        self.body = 'dragon on my back'", "        self.content = 'dragon attack'", "        self.attachment = StringIO(self.content)"]}, {"lines": ["        self.recipient = '{0}{1}-poster@osf.io'.format(", "            'test-' if settings.DEV_MODE else '',"]}, {"lines": ["            self.conference.endpoint,", "        )", ""]}, {"lines": ["    def make_context(self, **kwargs):"]}, {"lines": ["        data = {", "            'attachment-count': '1',", "            'attachment-1': (self.attachment, 'attachment-1'),", "            'X-Mailgun-Sscore': 0,", "            'recipient': self.recipient,", "            'stripped-text': self.body,", "        }", "        data.update(kwargs.pop('data', {}))"]}, {"lines": ["        return super(TestProvisionNode, self).make_context(data=data, **kwargs)"]}, {"lines": [""]}, {"lines": ["    def test_provision(self):"]}, {"lines": ["        with self.make_context():"]}, {"lines": ["            msg = message.ConferenceMessage()", "            utils.provision_node(self.conference, msg, self.node, self.user)", "        assert_true(self.node.is_public)", "        assert_in(self.conference.admins[0], self.node.contributors)", "        assert_in('emailed', self.node.system_tags)"]}, {"lines": ["        assert_in(self.conference.endpoint, self.node.system_tags)", "        assert_in(self.conference.endpoint, self.node.tags)"]}, {"lines": ["        assert_not_in('spam', self.node.system_tags)"]}, {"lines": [""]}, {"lines": ["    def test_provision_private(self):"]}, {"lines": ["        self.conference.public_projects = False", "        self.conference.save()"]}, {"lines": ["        with self.make_context():"]}, {"lines": ["            msg = message.ConferenceMessage()", "            utils.provision_node(self.conference, msg, self.node, self.user)", "        assert_false(self.node.is_public)", "        assert_in(self.conference.admins[0], self.node.contributors)", "        assert_in('emailed', self.node.system_tags)", "        assert_not_in('spam', self.node.system_tags)"]}, {"lines": [""]}, {"lines": ["    def test_provision_spam(self):"]}, {"lines": ["        with self.make_context(data={'X-Mailgun-Sscore': message.SSCORE_MAX_VALUE + 1}):"]}, {"lines": ["            msg = message.ConferenceMessage()", "            utils.provision_node(self.conference, msg, self.node, self.user)", "        assert_false(self.node.is_public)", "        assert_in(self.conference.admins[0], self.node.contributors)", "        assert_in('emailed', self.node.system_tags)", "        assert_in('spam', self.node.system_tags)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.conferences.utils.requests.put')"]}, {"lines": ["        mock_get_url.return_value = 'http://queen.com/'", "        self.attachment.filename = 'hammer-to-fall'", "        self.attachment.content_type = 'application/json'", "        utils.upload_attachment(self.user, self.node, self.attachment)", "        mock_get_url.assert_called_with("]}, {"lines": ["            self.node,"]}, {"lines": ["        )", "        mock_put.assert_called_with(", "            mock_get_url.return_value,", "            data=self.content,"]}, {"lines": ["        )", ""]}, {"lines": ["    @mock.patch('website.conferences.utils.requests.put')"]}, {"lines": ["        mock_get_url.return_value = 'http://queen.com/'", "        self.attachment.filename = ''", "        self.attachment.content_type = 'application/json'", "        utils.upload_attachment(self.user, self.node, self.attachment)", "        mock_get_url.assert_called_with("]}, {"lines": ["            self.node,"]}, {"lines": ["        )", "        mock_put.assert_called_with(", "            mock_get_url.return_value,", "            data=self.content,"]}, {"lines": ["        )", "", "", "class TestMessage(ContextTestCase):", ""]}, {"lines": ["    def test_verify_signature_valid(self):"]}, {"lines": ["        with self.make_context():"]}, {"lines": ["            msg = message.ConferenceMessage()", "            msg.verify_signature()"]}, {"lines": ["", "    def test_verify_signature_invalid(self):"]}, {"lines": ["        with self.make_context(data={'signature': 'fake'}):"]}, {"lines": ["            self.app.app.preprocess_request()"]}, {"lines": ["            msg = message.ConferenceMessage()"]}, {"lines": ["            with assert_raises(message.ConferenceError):"]}, {"lines": ["                msg.verify_signature()"]}, {"lines": ["", "    def test_is_spam_false_missing_headers(self):"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={'X-Mailgun-Sscore': message.SSCORE_MAX_VALUE - 1},", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert not msg.is_spam", "", "    def test_is_spam_false_all_headers(self):"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={", "                'X-Mailgun-Sscore': message.SSCORE_MAX_VALUE - 1,", "                'X-Mailgun-Dkim-Check-Result': message.DKIM_PASS_VALUES[0],", "                'X-Mailgun-Spf': message.SPF_PASS_VALUES[0],", "            },", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert not msg.is_spam", "", "    def test_is_spam_true_sscore(self):"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={'X-Mailgun-Sscore': message.SSCORE_MAX_VALUE + 1},", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert msg.is_spam", "", "    def test_is_spam_true_dkim(self):"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={'X-Mailgun-Dkim-Check-Result': message.DKIM_PASS_VALUES[0][::-1]},", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert msg.is_spam", "", "    def test_is_spam_true_spf(self):"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={'X-Mailgun-Spf': message.SPF_PASS_VALUES[0][::-1]},", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert msg.is_spam", "", "    def test_subject(self):"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={'subject': 'RE: Hip Hopera'},", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert_equal(msg.subject, 'Hip Hopera')", "", "    def test_recipient(self):", "        address = 'test-conference@osf.io'"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={'recipient': address},", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert_equal(msg.recipient, address)", "", "    def test_text(self):", "        text = 'welcome to my nuclear family'"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={'stripped-text': text},", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert_equal(msg.text, text)", "", "    def test_sender_name(self):", "        names = [", "            (' Fred', 'Fred'),", "            (u'Me\u2030\u00a8\u00fc', u'Me\u2030\u00a8\u00fc'),", "            (u'Fred <fred@queen.com>', u'Fred'),", "            (u'\"Fred\" <fred@queen.com>', u'Fred'),", "        ]", "        for name in names:"]}, {"lines": ["            with self.make_context(data={'from': name[0]}):"]}, {"lines": ["                msg = message.ConferenceMessage()", "                assert_equal(msg.sender_name, name[1])", "", "    def test_route_invalid_pattern(self):"]}, {"lines": ["        with self.make_context(data={'recipient': 'spam@osf.io'}):"]}, {"lines": ["            self.app.app.preprocess_request()", "            msg = message.ConferenceMessage()", "            with assert_raises(message.ConferenceError):", "                msg.route", "", "    def test_route_invalid_test(self):"]}, {"lines": ["        recipient = '{0}conf-talk@osf.io'.format('' if settings.DEV_MODE else 'test-')"]}, {"lines": ["        with self.make_context(data={'recipient': recipient}):"]}, {"lines": ["            self.app.app.preprocess_request()", "            msg = message.ConferenceMessage()", "            with assert_raises(message.ConferenceError):", "                msg.route", "", "    def test_route_valid(self):"]}, {"lines": ["        recipient = '{0}conf-talk@osf.io'.format('test-' if settings.DEV_MODE else '')"]}, {"lines": ["        with self.make_context(data={'recipient': recipient}):"]}, {"lines": ["            self.app.app.preprocess_request()", "            msg = message.ConferenceMessage()", "            assert_equal(msg.conference_name, 'conf')", "            assert_equal(msg.conference_category, 'talk')", ""]}, {"lines": ["    def test_attachments_count_zero(self):"]}, {"lines": ["        with self.make_context(data={'attachment-count': '0'}):"]}, {"lines": ["            msg = message.ConferenceMessage()", "            assert_equal(msg.attachments, [])", "", "    def test_attachments_count_one(self):", "        content = 'slightly mad'", "        sio = StringIO(content)"]}, {"lines": ["        ctx = self.make_context("]}, {"lines": ["            method='POST',", "            data={", "                'attachment-count': 1,", "                'attachment-1': (sio, 'attachment-1'),", "            },", "        )", "        with ctx:", "            msg = message.ConferenceMessage()", "            assert_equal(len(msg.attachments), 1)", "            assert_equal(msg.attachments[0].read(), content)", ""]}, {"lines": [""]}, {"lines": ["            n_conference_nodes,", "            conference.endpoint,", "        )"]}, {"lines": ["", ""]}, {"lines": ["class TestConferenceIntegration(ContextTestCase):"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.conferences.views.send_mail')"]}, {"lines": ["    @mock.patch('website.conferences.utils.upload_attachments')"]}, {"lines": ["    def test_integration(self, mock_upload, mock_send_mail):"]}, {"lines": ["        fullname = 'John Deacon'", "        username = 'deacon@queen.com'", "        title = 'good songs'", "        conference = ConferenceFactory()", "        body = 'dragon on my back'", "        content = 'dragon attack'"]}, {"lines": ["        recipient = '{0}{1}-poster@osf.io'.format(", "            'test-' if settings.DEV_MODE else '',"]}, {"lines": ["            conference.endpoint,", "        )"]}, {"lines": ["            api_url_for('meeting_hook'),", "            {", "                'X-Mailgun-Sscore': 0,", "                'timestamp': '123',", "                'token': 'secret',", "                'signature': hmac.new(", "                    key=settings.MAILGUN_API_KEY,", "                    msg='{}{}'.format('123', 'secret'),", "                    digestmod=hashlib.sha256,", "                ).hexdigest(),", "                'attachment-count': '1',", "                'X-Mailgun-Sscore': 0,", "                'from': '{0} <{1}>'.format(fullname, username),", "                'recipient': recipient,", "                'subject': title,", "                'stripped-text': body,", "            },", "            upload_files=[", "                ('attachment-1', 'attachment-1', content),", "            ],", "        )"]}, {"lines": ["        assert_true(mock_upload.called)"]}, {"lines": ["        users = User.find(Q('username', 'eq', username))", "        assert_equal(users.count(), 1)", "        nodes = Node.find(Q('title', 'eq', title))", "        assert_equal(nodes.count(), 1)", "        node = nodes[0]", "        assert_equal(node.get_wiki_page('home').content, body)"]}, {"lines": ["        assert_true(mock_send_mail.called)", "        call_args, call_kwargs = mock_send_mail.call_args", "        assert_absolute(call_kwargs['conf_view_url'])", "        assert_absolute(call_kwargs['set_password_url'])", "        assert_absolute(call_kwargs['profile_url'])", "        assert_absolute(call_kwargs['file_url'])", "        assert_absolute(call_kwargs['node_url'])"]}, {"lines": ["import logging", ""]}, {"lines": ["import mock", "import webtest_plus"]}, {"lines": ["from nose.tools import *  # noqa", "from tests.base import DbTestCase"]}, {"lines": ["from flask import make_response", "from pymongo.errors import CollectionInvalid, OperationFailure"]}, {"lines": ["from framework.flask import add_handlers"]}, {"lines": ["from framework.mongo import handlers as database_handlers", "from framework.transactions import context, handlers, commands, messages, utils", ""]}, {"lines": ["from flask import Flask, abort"]}, {"lines": ["app = Flask('test_transactions_app')", "@app.route('/')", "def dummy_view():", "    return 'dummy'"]}, {"lines": ["app.logger.setLevel(logging.CRITICAL)", ""]}, {"lines": ["class TestTransactionContext(DbTestCase):"]}, {"lines": ["            database.create_collection('transaction')"]}, {"lines": ["        cls.collection = database[TEST_COLLECTION_NAME]"]}, {"lines": ["        with context.TokuTransaction(database) as txn:"]}, {"lines": ["            with context.TokuTransaction(database):"]}, {"lines": ["        with context.TokuTransaction(database) as txn1:"]}, {"lines": ["            with context.TokuTransaction(database) as txn2:"]}, {"lines": ["            with context.TokuTransaction(database):"]}, {"lines": ["                with context.TokuTransaction(database):"]}, {"lines": ["", "class TestTransactionHandlers(DbTestCase):", "", "    def clear_transactions(self):", "        try:", "            commands.rollback()", "        except OperationFailure as error:", "            message = utils.get_error_message(error)", "            if messages.NO_TRANSACTION_ERROR not in message:", "                raise", "", "    def setUp(self):", "        super(TestTransactionHandlers, self).setUp()", "        self.clear_transactions()", "        self.context = app.test_request_context('/')", "        self.context.push()", "", "    def tearDown(self):", "        super(TestTransactionHandlers, self).tearDown()", "        self.clear_transactions()", "        self.context.pop()", "", "    def test_before_request(self):", "        handlers.transaction_before_request()", "        transactions = database.command('showLiveTransactions')", "        assert_equal(len(transactions['transactions']), 1)", "", "    def test_before_request_transaction_active(self):", "        commands.begin()", "        transactions_before = database.command('showLiveTransactions')", "        handlers.transaction_before_request()", "        transactions = database.command('showLiveTransactions')", "        assert_equal(len(transactions['transactions']), 1)", "        assert_not_equal(", "            transactions_before['transactions'][0]['txnid'],", "            transactions['transactions'][0]['txnid'],", "        )", "", "    @mock.patch('framework.transactions.commands.rollback')", "    def test_before_request_unexpected_error(self, mock_rollback):", "        mock_rollback.side_effect = OperationFailure('daamn!')", "        with assert_raises(OperationFailure):", "            handlers.transaction_before_request()", "", "    def test_after_request(self):", "        commands.begin()", "        key = 'test_after_request'", "        database['txn'].insert({'_id': key})", "        response = make_response('bob', 200)", "        handlers.transaction_after_request(response)", "        transactions = database.command('showLiveTransactions')", "        assert_equal(len(transactions['transactions']), 0)", "        assert_equal(", "            database['txn'].find({'_id': key}).count(),", "            1,", "        )", "", "    def test_after_request_uncaught_exception(self):", "        commands.begin()", "        key = 'test_after_request_uncaught_exception'", "        database['txn'].insert({'_id': key})", "        response = make_response('ack!', 500)", "        handlers.transaction_after_request(response)", "        transactions = database.command('showLiveTransactions')", "        assert_equal(len(transactions['transactions']), 0)", "        assert_equal(", "            database['txn'].find({'_id': key}).count(),", "            0,", "        )", "", "    def test_after_request_lock_error(self):", "        commands.begin()", "        key = 'test_after_request_lock_error'", "        database['txn'].insert({'_id': key})", "        with app.test_request_context(content_type='application/json'):", "            response = make_response('bob', 200)", "            with mock.patch('framework.transactions.commands.commit') as mock_commit:", "                mock_commit.side_effect = OperationFailure(messages.LOCK_ERROR)", "                handlers.transaction_after_request(response)", "        transactions = database.command('showLiveTransactions')", "        assert_equal(len(transactions['transactions']), 0)", "        assert_equal(", "            database['txn'].find({'_id': key}).count(),", "            0,", "        )", "", "", "transaction_app = Flask('test_transactions_app')", "", "add_handlers(transaction_app, database_handlers.handlers)", "add_handlers(transaction_app, handlers.handlers)", "", "", "@transaction_app.route('/transact/me/bro/', methods=['GET'])", "def transaction_view():", "    return make_response()", "", ""]}, {"lines": ["@handlers.no_auto_transaction"]}, {"lines": ["@transaction_app.route('/dont/transact/me/bro/', methods=['GET'])", "def no_transaction_view():", "    return make_response()", "", "", "@transaction_app.route('/seriously/bro/', methods=['GET'])"]}, {"lines": ["@handlers.no_auto_transaction"]}, {"lines": ["def no_transaction_view_reverse_decorators():", "    return make_response()", "", "", "test_app = webtest_plus.TestApp(transaction_app)", "", "", "class TestSkipTransactions(DbTestCase):", "", "    @mock.patch('framework.transactions.commands.commit')", "    @mock.patch('framework.transactions.commands.rollback')", "    @mock.patch('framework.transactions.commands.begin')", "    def test_no_skip(self, mock_begin, mock_rollback, mock_commit):", "        test_app.get('/transact/me/bro/')", "        assert_true(mock_begin.called)", "        assert_true(mock_rollback.called)", "        assert_true(mock_commit.called)", "", "    @mock.patch('framework.transactions.commands.commit')", "    @mock.patch('framework.transactions.commands.rollback')", "    @mock.patch('framework.transactions.commands.begin')", "    def test_skip_transaction(self, mock_begin, mock_rollback, mock_commit):", "        test_app.get('/dont/transact/me/bro/')", "        assert_false(mock_begin.called)", "        assert_false(mock_rollback.called)", "        assert_false(mock_commit.called)", "", "    @mock.patch('framework.transactions.commands.commit')", "    @mock.patch('framework.transactions.commands.rollback')", "    @mock.patch('framework.transactions.commands.begin')", "    def test_skip_transaction_reverse_decorators(self, mock_begin, mock_rollback, mock_commit):", "        test_app.get('/seriously/bro/')", "        assert_false(mock_begin.called)", "        assert_false(mock_rollback.called)", "        assert_false(mock_commit.called)", "", ""]}, {"lines": ["@transaction_app.route('/write/without/errors/', methods=['POST'])", "def write_without_errors():", "    database['txn'].insert({'_id': 'success'})", "    return 'success'", "", "", "@transaction_app.route('/write/with/error/500/', methods=['POST'])", "def write_with_error_500():", "    database['txn'].insert({'_id': 'error_500'})", "    abort(500)", "", "", "@transaction_app.route('/write/with/error/uncaught/', methods=['POST'])", "def write_with_error_uncaught():", "    database['txn'].insert({'_id': 'error_uncaught'})"]}, {"lines": ["    raise Exception"]}, {"lines": ["", "", "class TestTransactionIntegration(DbTestCase):", "", "    def test_commit_if_no_error(self):", "        test_app.post('/write/without/errors/')", "        assert_equal(", "            database['txn'].find({'_id': 'success'}).count(),", "            1,", "        )", "", "    def test_rollback_if_error_500(self):", "        test_app.post('/write/with/error/500/', expect_errors=True)", "        assert_equal(", "            database['txn'].find({'_id': 'error_500'}).count(),", "            0,", "        )", "", "    def test_rollback_if_error_uncaught(self):", "        test_app.post('/write/with/error/uncaught/', expect_errors=True)", "        assert_equal(", "            database['txn'].find({'_id': 'error_uncaught'}).count(),", "            0,", "        )", "", ""]}, {"lines": [""]}, {"lines": ["from dateutil.parser import parse as parse_date"]}, {"lines": ["        res = res.follow(expect_errors=True)"]}, {"lines": ["    @mock.patch('framework.transactions.commands.begin')", "    @mock.patch('framework.transactions.commands.rollback')", "    @mock.patch('framework.transactions.commands.commit')", "    def test_get_logs(self, *mock_commands):"]}, {"lines": ["        for mock_command in mock_commands:", "            assert_false(mock_command.called)"]}, {"lines": [""]}, {"lines": ["    def test_get_pointed(self):", "        pointing_node = ProjectFactory(creator=self.user)", "        pointing_node.add_pointer(self.project, auth=Auth(self.user))", "        url = self.project.api_url_for('get_pointed')", "        res = self.app.get(url, auth=self.user.auth)", "        pointed = res.json['pointed']", "        assert_equal(len(pointed), 1)", "        assert_equal(pointed[0]['url'], pointing_node.url)", "        assert_equal(pointed[0]['title'], pointing_node.title)", "        assert_equal(pointed[0]['authorShort'], abbrev_authors(pointing_node))", "", "    def test_get_pointed_private(self):", "        secret_user = UserFactory()", "        pointing_node = ProjectFactory(creator=secret_user)", "        pointing_node.add_pointer(self.project, auth=Auth(secret_user))", "        url = self.project.api_url_for('get_pointed')", "        res = self.app.get(url, auth=self.user.auth)", "        pointed = res.json['pointed']", "        assert_equal(len(pointed), 1)", "        assert_equal(pointed[0]['url'], None)", "        assert_equal(pointed[0]['title'], 'Private Component')", "        assert_equal(pointed[0]['authorShort'], 'Private Author(s)')", ""]}, {"lines": ["        date_created = parse_date(res_comment.pop('dateCreated'))", "        date_modified = parse_date(res_comment.pop('dateModified'))"]}, {"lines": ["        date_created2 = parse_date(serialized_comment.pop('dateCreated'))", "        date_modified2 = parse_date(serialized_comment.pop('dateModified'))"]}, {"lines": ["    @unittest.skip('Tags endpoint disabled for now.')"]}, {"lines": ["        res = self.app.post(url, auth=None)"]}, {"lines": ["        res2 = res.follow(expect_errors=True)"]}, {"lines": ["from website.util import paths"]}, {"lines": ["        'display_name': get_display_name(user.fullname) if user else '',"]}, {"lines": ["        'status': status.pop_status_messages(),"]}, {"lines": ["        'js_str': lambda x: x.replace(\"'\", r\"\\'\").replace('\"', r'\\\"'),"]}, {"lines": ["        'webpack_asset': paths.webpack_asset,"]}, {"lines": ["    return send_from_directory("]}, {"lines": ["        # # TODO: Add API endpoint for tags", "        # Rule('/tags/<tag>/', 'get', project_views.tag.project_tag, OsfWebRenderer('tags.mako')),"]}, {"lines": ["# -*- coding: utf -*-", "", "from modularodm import fields"]}, {"lines": ["from modularodm import fields"]}, {"lines": ["from framework.mongo import StoredObject"]}, {"lines": ["    node = fields.ForeignField('node', required=True, index=True)"]}, {"lines": ["def init_addon(app, addon_name, routes=True):"]}, {"lines": ["import functools"]}, {"lines": ["from flask import request"]}, {"lines": ["def check_access(node, user, action, key=None):", "    \"\"\"Verify that user can perform requested action on resource. Raise appropriate", "    error code if action cannot proceed.", "    \"\"\"", "    permission = permission_map.get(action, None)", "    if permission is None:", "        raise HTTPError(httplib.BAD_REQUEST)", "    if node.has_permission(user, permission):", "        return True", "    if permission == 'read':", "        if node.is_public or key in node.private_link_keys_active:", "            return True", "    code = httplib.FORBIDDEN if user else httplib.UNAUTHORIZED", "    raise HTTPError(code)", "", ""]}, {"lines": ["def make_auth(user):", "    if user is not None:", "        return {", "            'id': user._id,", "            'email': '{}@osf.io'.format(user._id),", "            'name': user.fullname,", "        }", "    return {}", "", ""]}, {"lines": ["def restrict_addrs(*addrs):", "    def wrapper(func):", "        @functools.wraps(func)", "        def wrapped(*args, **kwargs):", "            remote = request.remote_addr", "            if remote not in addrs:", "                raise HTTPError(httplib.FORBIDDEN)", "            return func(*args, **kwargs)", "        return wrapped", "    return wrapper", "", "", "restrict_waterbutler = restrict_addrs(*settings.WATERBUTLER_ADDRS)", "", "", "@restrict_waterbutler"]}, {"lines": [""]}, {"lines": ["    check_access(node, user, action, key=view_only)"]}, {"lines": ["        'auth': make_auth(user),"]}, {"lines": ["@restrict_waterbutler"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": [""]}, {"lines": ["    def before_register_message(self, node, user):", "        \"\"\"Return warning text to display if user auth will be copied to a", "        registration.", "        \"\"\"", "        category = node.project_or_component", "        if self.user_settings and self.user_settings.has_auth:", "            return (", "                u'The contents of Dataverse add-ons cannot be registered at this time; '"]}, {"lines": ["                u'as part of this registration.'", "            ).format(**locals())", "", "    # backwards compatibility", "    before_register = before_register_message"]}, {"lines": ["        u'addon': u'dataverse',"]}, {"lines": ["}"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from modularodm import storage"]}, {"lines": ["    set_up_storage(MODELS, storage_class=storage.MongoStorage)"]}, {"lines": ["    ADDON_SHORT_NAME = 'dropbox'"]}, {"lines": [""]}, {"lines": ["from dropbox.client import DropboxOAuth2Flow"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from flask import request"]}, {"lines": ["from modularodm import fields"]}, {"lines": ["from framework.auth.decorators import Auth", ""]}, {"lines": ["from website.models import NodeLog"]}, {"lines": ["from website.addons.base import exceptions", "from website.addons.base import AddonNodeSettingsBase, AddonUserSettingsBase"]}, {"lines": ["    def serialize_waterbutler_credentials(self):", "        if not self.has_auth:", "            raise exceptions.AddonError('Cannot serialize credentials for unauthorized addon')", "        return {", "            'client_token': figshare_settings.CLIENT_ID,", "            'client_secret': figshare_settings.CLIENT_SECRET,", "            'owner_token': self.user_settings.oauth_access_token,", "            'owner_secret': self.user_settings.oauth_access_token_secret,", "        }", "", "    def serialize_waterbutler_settings(self):", "        if not self.figshare_type or not self.figshare_id:", "            raise exceptions.AddonError('Cannot serialize settings for unconfigured addon')", "        return {", "            'container_type': self.figshare_type,", "            'container_id': str(self.figshare_id),", "        }", "", "    def create_waterbutler_log(self, auth, action, metadata):"]}, {"lines": ["        if action in [NodeLog.FILE_ADDED, NodeLog.FILE_UPDATED]:", "            name = metadata['name']"]}, {"lines": ["            urls = {"]}, {"lines": ["            }", "        elif action == NodeLog.FILE_REMOVED:", "            name = metadata['path']", "            urls = {}", "        self.owner.add_log(", "            'figshare_{0}'.format(action),", "            auth=auth,", "            params={", "                'project': self.owner.parent_id,", "                'node': self.owner._id,", "                'path': name,", "                'urls': urls,", "                'figshare': {", "                    'id': self.figshare_id,", "                    'type': self.figshare_type,", "                },", "            },", "        )"]}, {"lines": [""]}, {"lines": ["    def update_fields(self, fields, node, auth):"]}, {"lines": ["            self.figshare_type = fields['type']"]}, {"lines": ["        rubeus.KIND: rubeus.FILE,"]}, {"lines": ["var m = require('mithril');"]}, {"lines": ["Fangorn.config.figshare = {"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": [""]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["", "from modularodm import fields"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["function _fangornGithubTitle(item, col)  {"]}, {"lines": ["    if (item.data.addonFullname) {"]}, {"lines": ["        return m('span',["]}, {"lines": ["        return m('img',{src:item.data.iconUrl, style:{width:'16px', height:'auto'}}, ' ');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from tests.factories import ProjectFactory, UserFactory, AuthUserFactory"]}, {"lines": [""]}, {"lines": ["# TODO: Test remaining CRUD methods", "# TODO: Test exception handling", "class TestCRUD(OsfTestCase):", "", "    def setUp(self):", "        super(TestCRUD, self).setUp()"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.consolidated_auth = Auth(user=self.user)", "        self.project = ProjectFactory(creator=self.user)", "        self.project.add_addon('github', auth=self.consolidated_auth)", "        self.project.creator.add_addon('github')", "        self.node_settings = self.project.get_addon('github')", "        self.node_settings.user_settings = self.project.creator.get_addon('github')", "        # Set the node addon settings to correspond to the values of the mock repo", "        self.node_settings.user = self.github.repo.return_value.owner.login", "        self.node_settings.repo = self.github.repo.return_value.name", "        self.node_settings.save()", ""]}, {"lines": ["    def check_hook_urls(self, urls, node, path, sha):"]}, {"lines": [""]}, {"lines": ["        urls = self.project.logs[-1].params['urls']", "        self.check_hook_urls(", "            urls,", "            self.project,", "            path='PRJWN3TV',", "            sha='b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce',", "        )"]}, {"lines": ["        urls = self.project.logs[-1].params['urls']", "        self.check_hook_urls(", "            urls,", "            self.project,", "            path='PRJWN3TV',", "            sha='b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce',", "        )"]}, {"lines": ["        urls = self.project.logs[-1].params['urls']", "        assert_equal(urls, {})"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["from flask import request", ""]}, {"lines": [""]}, {"lines": ["from flask import request"]}, {"lines": ["        defaultBranch=branch,"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["", "from flask import request"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8"]}, {"lines": [""]}, {"lines": ["", "MODELS = ["]}, {"lines": ["    model.OsfStorageGuidFile,"]}, {"lines": ["]", "NODE_SETTINGS_MODEL = model.OsfStorageNodeSettings", "", "ROUTES = ["]}, {"lines": ["]", "", "SHORT_NAME = 'osfstorage'", "FULL_NAME = 'OSF Storage'", "", "OWNERS = ['node']", "", "ADDED_DEFAULT = ['node']", "ADDED_MANDATORY = ['node']", "", "VIEWS = []", "CONFIGS = []", "", "CATEGORIES = ['storage']", "", "INCLUDE_JS = {", "    'widget': [],", "    'page': [],"]}, {"lines": ["}", "", "HAS_HGRID_FILES = True", "GET_HGRID_DATA = views.osf_storage_root"]}, {"lines": [""]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8"]}, {"lines": ["", "class OsfStorageError(Exception):", "    pass", "", "class PathLockedError(OsfStorageError):", "    pass", "", "class SignatureConsumedError(OsfStorageError):", "    pass", ""]}, {"lines": ["class VersionNotFoundError(OsfStorageError):"]}, {"lines": ["    pass", ""]}, {"lines": ["class SignatureMismatchError(OsfStorageError):"]}, {"lines": ["    pass", ""]}, {"lines": ["class VersionStatusError(OsfStorageError):"]}, {"lines": ["    pass", "", "class DeleteError(OsfStorageError):", "    pass", "", "class UndeleteError(OsfStorageError):", "    pass", "", "class InvalidVersionError(OsfStorageError):", "    pass"]}, {"lines": ["", "class MissingFieldError(OsfStorageError):", "    pass"]}, {"lines": ["", "import os"]}, {"lines": ["import httplib", "import logging"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["logger = logging.getLogger(__name__)"]}, {"lines": ["    \"\"\"Serialize revision for use in revisions table.", "", "    :param Node node: Root node", "    :param FileRecord record: Root file record", "    :param FileVersion version: The version to serialize", "    :param int index: One-based index of version", "    \"\"\""]}, {"lines": ["            'name': version.creator.fullname,", "            'url': version.creator.url,"]}, {"lines": ["        'downloads': record.get_download_count(version=index),"]}, {"lines": ["    }", "", ""]}, {"lines": ["SIGNED_REQUEST_ERROR = HTTPError(", "    httplib.SERVICE_UNAVAILABLE,", "    data={", "        'message_short': 'Upload service unavailable',", "        'message_long': (", "            'Upload service is not available; please retry '", "            'your upload in a moment'", "        ),", "    },", ")", "", ""]}, {"lines": ["def get_filename(version_idx, file_version, file_record):", "    \"\"\"Build name for downloaded file, appending version date if not latest.", "", "    :param int version_idx: One-based version index", "    :param FileVersion file_version: Version to name", "    :param FileRecord file_record: Root file object"]}, {"lines": ["    \"\"\""]}, {"lines": ["    if version_idx == len(file_record.versions):"]}, {"lines": ["    name, ext = os.path.splitext(file_record.name)"]}, {"lines": ["        name=name,"]}, {"lines": ["        date=file_version.date_created.isoformat(),"]}, {"lines": ["        ext=ext,", "    )", "", ""]}, {"lines": ["import logging", "from .defaults import *  # noqa", ""]}, {"lines": ["try:", "    from .local import *  # noqa", "except ImportError as error:"]}, {"lines": ["<script type=\"text/html\" id=\"osf_storage_file_added\">", "added file"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"osf_storage_file_updated\">", "updated file"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", "", "<script type=\"text/html\" id=\"osf_storage_file_removed\">"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>"]}, {"lines": ["", "", "## Legacy log templates for previous OSF Files", "<script type=\"text/html\" id=\"file_added\">", "added file <a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect, text: params.path\"></a> to"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>", "", "<script type=\"text/html\" id=\"file_updated\">", "updated file <a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect, text: params.path\"></a> in"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>", "", "<script type=\"text/html\" id=\"file_removed\">", "removed file <span data-bind=\"text: params.path\"></span> from"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8"]}, {"lines": [""]}, {"lines": ["", "from tests.factories import ModularOdmFactory, AuthUserFactory"]}, {"lines": [""]}, {"lines": ["import datetime", ""]}, {"lines": ["from website.addons.osfstorage import model"]}, {"lines": ["from website.addons.osfstorage import settings"]}, {"lines": ["", "", "generic_location = {", "    'service': 'cloud',"]}, {"lines": ["    settings.WATERBUTLER_RESOURCE: 'resource',"]}, {"lines": ["    'object': '1615307',", "}", "", "", "class FileVersionFactory(ModularOdmFactory):"]}, {"lines": ["    FACTORY_FOR = model.OsfStorageFileVersion"]}, {"lines": [""]}, {"lines": ["    creator = SubFactory(AuthUserFactory)"]}, {"lines": ["    date_modified = datetime.datetime.utcnow()"]}, {"lines": ["    location = generic_location", ""]}, {"lines": ["    @post_generation", "    def refresh(self, create, extracted, **kwargs):", "        if not create:", "            return", "        self.reload()"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8"]}, {"lines": ["", "from nose.tools import *  # noqa", ""]}, {"lines": [""]}, {"lines": ["from website.models import Session"]}, {"lines": ["from website.addons.osfstorage.tests import factories"]}, {"lines": ["from website.addons.osfstorage import utils", ""]}, {"lines": [""]}, {"lines": ["class TestSerializeRevision(StorageTestCase):"]}, {"lines": ["", "    def setUp(self):", "        super(TestSerializeRevision, self).setUp()"]}, {"lines": ["        self.versions = ["]}, {"lines": ["        ]", "        self.record.versions = self.versions"]}, {"lines": ["        self.record.save()", "", "    def test_serialize_revision(self):"]}, {"lines": ["        expected = {", "            'index': 1,", "            'user': {", "                'name': self.user.fullname,", "                'url': self.user.url,", "            },"]}, {"lines": ["            'date': self.versions[0].date_created.isoformat(),"]}, {"lines": ["            'downloads': 2,"]}, {"lines": ["        }", "        observed = utils.serialize_revision(", "            self.project,", "            self.record,"]}, {"lines": ["            self.versions[0],"]}, {"lines": ["        )", "        assert_equal(expected, observed)"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8", "", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory", "", "import collections", "", "from framework.auth import Auth", "", ""]}, {"lines": ["identity = lambda value: value", "class Delta(object):", "    def __init__(self, getter, checker=None):", "        self.getter = getter", "        self.checker = checker or identity"]}, {"lines": ["", "", "class AssertDeltas(object):", ""]}, {"lines": ["    def __init__(self, *deltas):"]}, {"lines": ["        self.deltas = deltas", "        self.original = []", "", "    def __enter__(self):", "        self.original = [delta.getter() for delta in self.deltas]", "", "    def __exit__(self, exc_type, exc_value, exc_tb):", "        for idx, delta in enumerate(self.deltas):", "            final = delta.getter()", "            assert delta.checker(self.original[idx]) == final", "", "", "class StorageTestCase(OsfTestCase):", "", "    def setUp(self):", "        super(StorageTestCase, self).setUp()", "", "        self.project = ProjectFactory()", "        self.user = self.project.creator", "        self.node_settings = self.project.get_addon('osfstorage')", "        self.auth_obj = Auth(user=self.project.creator)", "", "        # Refresh records from database; necessary for comparing dates", "        self.project.reload()", "        self.user.reload()"]}, {"lines": ["from modularodm import fields"]}, {"lines": ["        category = node.project_or_component"]}, {"lines": ["                u'The contents of S3 add-ons cannot be registered at this time; '", "                u'the S3 bucket linked to this {category} will not be included '", "                u'as part of this registration.'", "            ).format(**locals())"]}, {"lines": ["        uploadSuccess: function(file, row) {", "            var self = this;", "            var parent = this.getByID(row.parentID);", "            row.urls = {"]}, {"lines": ["            row.permissions = parent.permissions;", "            this.updateItem(row);", "            var updated = Rubeus.Utils.itemUpdated(row, parent);", "            if (updated) {", "                self.changeStatus(row, Rubeus.Status.UPDATED);", "                self.delayRemoveRow(row);", "            } else {", "                self.changeStatus(row, Rubeus.Status.UPLOAD_SUCCESS, null, 2000,", "                    function(row) {", "                        self.showButtons(row);", "                    });", "            }"]}, {"lines": ["<a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect, text: params.path\"></a> in"]}, {"lines": ["    def test_registration_settings(self):", "        registration = ProjectFactory()"]}, {"lines": ["            self.project, registration, self.project.creator,"]}, {"lines": ["        component = NodeFactory(project=self.project, is_public=True)"]}, {"lines": ["        res = self.app.get(url)"]}, {"lines": ["        \"\"\"Regression test for issues", "        https://github.com/CenterForOpenScience/osf/issues/363 and", "        https://github.com/CenterForOpenScience/openscienceframework.org/issues/574"]}, {"lines": ["        assert_equal(", "            serialized[0]['url'],"]}, {"lines": ["        )"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import re", "import hmac", "import hashlib", "import logging", "", "from nameparser import HumanName", "from werkzeug.utils import cached_property", "", "from framework.flask import request", "", "from website import settings"]}, {"lines": ["from website.conferences.exceptions import ConferenceError"]}, {"lines": ["", "", "logger = logging.getLogger(__name__)", "", "SSCORE_MAX_VALUE = 5", "DKIM_PASS_VALUES = ['Pass']", "SPF_PASS_VALUES = ['Pass', 'Neutral']", "", "ANGLE_BRACKETS_REGEX = re.compile(r'<(.*?)>')", "ROUTE_REGEX = re.compile(", "    r'''", "        (?P<test>test-)?", "        (?P<meeting>\\w*?)", "        -", "        (?P<category>poster|talk)", "        @osf\\.io", "    ''',", "    re.IGNORECASE | re.VERBOSE", ")", "", ""]}, {"lines": ["class ConferenceMessage(object):", "", "    def __init__(self):", "        self.request = request._get_current_object()"]}, {"lines": ["", "    def verify(self):"]}, {"lines": ["        self.verify_signature()"]}, {"lines": ["        _ = [self.sender_email, self.route]  # noqa"]}, {"lines": ["", "    def verify_signature(self):", "        \"\"\"Verify that request comes from Mailgun. Based on sample code from", "        http://documentation.mailgun.com/user_manual.html#webhooks", "        \"\"\"", "        signature = hmac.new(", "            key=settings.MAILGUN_API_KEY,", "            msg='{}{}'.format(", "                self.form['timestamp'],", "                self.form['token'],", "            ),", "            digestmod=hashlib.sha256,", "        ).hexdigest()", "        if signature != self.form['signature']:", "            raise ConferenceError('Invalid headers on incoming mail')", "", "    @cached_property", "    def is_spam(self):", "        \"\"\"Check SSCORE, DKIM, and SPF headers for spam.", "        See http://documentation.mailgun.com/user_manual.html#spam-filter for", "        details.", "", "        :return: At least one header indicates spam", "        \"\"\"", "        try:"]}, {"lines": ["        except (TypeError, ValueError):", "            return True", "        dkim_header = self.form.get('X-Mailgun-Dkim-Check-Result')", "        spf_header = self.form.get('X-Mailgun-Spf')", "        return (", "            (sscore_header and sscore_header > SSCORE_MAX_VALUE) or", "            (dkim_header and dkim_header not in DKIM_PASS_VALUES) or", "            (spf_header and spf_header not in SPF_PASS_VALUES)", "        )", "", "    @cached_property", "    def form(self):"]}, {"lines": ["        return self.request.form"]}, {"lines": ["", "    @cached_property"]}, {"lines": ["    def raw(self):", "        return {", "            'headers': dict(self.request.headers),", "            'form': self.request.form.to_dict(),", "            'args': self.request.args.to_dict(),", "        }", "", "    @cached_property"]}, {"lines": ["    def subject(self):", "        subject = self.form['subject']", "        subject = re.sub(r'^re:', '', subject, flags=re.I)", "        subject = re.sub(r'^fwd:', '', subject, flags=re.I)", "        return subject.strip()", "", "    @cached_property", "    def recipient(self):", "        return self.form['recipient']", "", "    @cached_property", "    def text(self):", "        return self.form['stripped-text']", "", "    @cached_property", "    def sender(self):", "        return self.form['from']", "", "    @cached_property", "    def sender_name(self):", "        name = ANGLE_BRACKETS_REGEX.sub('', self.sender)", "        name = name.strip().replace('\"', '')", "        return unicode(HumanName(name))", "", "    @cached_property", "    def sender_email(self):", "        match = ANGLE_BRACKETS_REGEX.search(self.sender)", "        if match:", "            return match.groups()[0]", "        raise ConferenceError('Could not extract sender email')", "", "    @cached_property", "    def sender_display(self):", "        return self.sender_name or self.sender_email.split('@')[0]", "", "    @cached_property", "    def route(self):", "        match = re.search(ROUTE_REGEX, self.form['recipient'])", "        if not match:", "            raise ConferenceError('Invalid recipient: '.format(self.form['recipient']))", "        data = match.groupdict()", "        if bool(settings.DEV_MODE) != bool(data['test']):", "            raise ConferenceError(", "                'Mismatch between `DEV_MODE` and recipient {0}'.format(", "                    self.form['recipient']", "                )", "            )", "        return data", "", "    @cached_property", "    def conference_name(self):", "        return self.route['meeting']", "", "    @cached_property", "    def conference_category(self):", "        return self.route['category']", "", "    @cached_property", "    def attachments(self):", "        count = self.form.get('attachment-count', 0)", "        try:", "            count = int(count)", "        except (TypeError, ValueError):", "            count = 0", "        return filter(", "            lambda value: value is not None,", "            map(", "                lambda idx: self.request.files.get('attachment-{0}'.format(idx + 1)),", "                range(count),", "            ),", "        )"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import uuid", ""]}, {"lines": ["import requests"]}, {"lines": ["from modularodm import Q", "from modularodm.exceptions import ModularOdmException", ""]}, {"lines": ["from framework.auth import Auth"]}, {"lines": [""]}, {"lines": ["from website import security"]}, {"lines": ["from website import settings"]}, {"lines": ["from website.project import new_node"]}, {"lines": ["from website.models import User, Node, MailRecord", "", "", "def record_message(message, created):", "    record = MailRecord(", "        data=message.raw,", "        records=created,", "    )", "    record.save()"]}, {"lines": ["", "", "def get_or_create_user(fullname, address, is_spam):", "    \"\"\"Get or create user by email address.", "", "    :param str fullname: User full name", "    :param str address: User email address", "    :param bool is_spam: User flagged as potential spam", "    :return: Tuple of (user, created)", "    \"\"\""]}, {"lines": ["        return user, False"]}, {"lines": ["        password = str(uuid.uuid4())", "        user = User.create_confirmed(address, password, fullname)", "        user.verification_key = security.random_string(20)", "        if is_spam:", "            user.system_tags.append('is_spam')", "        user.save()", "        return user, True", "", "", "def get_or_create_node(title, user):", "    \"\"\"Get or create node by title and creating user.", "", "    :param str title: Node title", "    :param User user: User creating node", "    :return: Tuple of (node, created)", "    \"\"\"", "    try:", "        node = Node.find_one(", "            Q('title', 'iexact', title)", "            & Q('contributors', 'eq', user._id)", "        )", "        return node, False", "    except ModularOdmException:", "        node = new_node('project', title, user)", "        return node, True"]}, {"lines": ["", "", "def provision_node(conference, message, node, user):", "    \"\"\"", "    :param Conference conference:", "    :param ConferenceMessage message:", "    :param Node node:", "    :param User user:", "    \"\"\"", "    auth = Auth(user=user)", "", "    node.update_node_wiki('home', message.text, auth)", "    node.add_contributors(prepare_contributors(conference.admins), log=False)", "", "    if not message.is_spam and conference.public_projects:", "        node.set_privacy('public', auth=auth)", ""]}, {"lines": ["    node.add_tag(message.conference_name, auth=auth)"]}, {"lines": ["    node.add_tag(message.conference_category, auth=auth)"]}, {"lines": ["    node.system_tags.extend(['emailed', message.conference_name, message.conference_category])"]}, {"lines": ["    if message.is_spam:", "        node.system_tags.append('spam')", ""]}, {"lines": ["    node.save()", "", "", "def prepare_contributors(admins):", "    return [", "        {", "            'user': admin,", "            'permissions': ['read', 'write', 'admin'],", "            'visible': False,", "        }", "        for admin in admins", "    ]", "", "", "def upload_attachment(user, node, attachment):"]}, {"lines": ["    attachment.seek(0)"]}, {"lines": ["    content = attachment.read()"]}, {"lines": ["    requests.put(", "        upload_url,", "        data=content,"]}, {"lines": ["    )", "", "", "def upload_attachments(user, node, attachments):", "    for attachment in attachments:", "        upload_attachment(user, node, attachment)"]}, {"lines": ["from framework.forms import Form, TextField, TextAreaField, validators"]}, {"lines": [""]}, {"lines": ["from framework import status"]}, {"lines": ["            status.push_status_message('Removed self from project', 'info')"]}, {"lines": ["        status.push_status_message('Contributor removed', 'info')"]}, {"lines": ["        status.push_status_message("]}, {"lines": ["        status.push_status_message("]}, {"lines": ["                return redirect(node.url)"]}, {"lines": ["        return redirect(web_url_for('claim_user_registered',"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["from flask import request", ""]}, {"lines": [""]}, {"lines": ["from flask import request", "from modularodm import Q"]}, {"lines": ["from framework import status"]}, {"lines": ["from framework.mongo import StoredObject"]}, {"lines": ["from website.util import paths"]}, {"lines": ["from website.util import rubeus"]}, {"lines": ["        status.push_errors_to_status(form.errors)"]}, {"lines": ["        js_path = paths.resolve_addon_path(addon.config, 'node-cfg.js')", "        if js_path:"]}, {"lines": ["    ret = _view_project(node, auth, primary=primary)", "    ret['addon_capabilities'] = settings.ADDON_CAPABILITIES"]}, {"lines": ["    ret['addon_widget_js'] = list(collect_addon_js(", "        node,"]}, {"lines": ["    ret.update(rubeus.collect_addon_assets(node))", "    return ret"]}, {"lines": ["        node.rm_pointer(pointer, auth=auth)"]}, {"lines": ["    lead_author = node.visible_contributors[0]", "    ret = lead_author.family_name or lead_author.given_name or lead_author.fullname", "    if len(node.visible_contributor_ids) > 1:", "        ret += ' et al.'", "    return ret"]}, {"lines": ["    if node.can_view(auth):", "        return {"]}, {"lines": ["            'url': node.url,", "            'title': node.title,", "            'authorShort': abbrev_authors(node),", "        }", "    return {", "        'url': None,", "        'title': 'Private Component',", "        'authorShort': 'Private Author(s)',", "    }"]}, {"lines": ["", "@must_be_contributor_or_public"]}, {"lines": ["        serialize_pointer(each, auth)"]}, {"lines": ["# Disabled for now. Should implement pagination, or at least cap the number of", "# nodes serialized, before re-enabling."]}, {"lines": ["from flask import request"]}, {"lines": ["from modularodm import Q"]}, {"lines": ["from framework.auth.decorators import must_be_logged_in"]}, {"lines": ["APP_PATH = parent_dir(BASE_PATH)"]}, {"lines": ["STATIC_URL_PATH = '/static'", "ASSET_HASH_PATH = os.path.join(APP_PATH, 'webpack-assets.json')"]}, {"lines": ["PROXY_ADDRS = []"]}, {"lines": ["LOG_PATH = os.path.join(APP_PATH, 'logs')"]}, {"lines": ["ANALYTICS_PATH = os.path.join(BASE_PATH, 'analytics')"]}, {"lines": ["# TODO: Remove after migration to OSF Storage", "COPY_GIT_REPOS = False", ""]}, {"lines": ["MFR_TEMP_PATH = os.path.join(BASE_PATH, 'mfrtemp')"]}, {"lines": ["    'framework.tasks.signals',"]}, {"lines": ["    'framework.email.tasks',"]}, {"lines": ["    'framework.analytics.tasks',"]}, {"lines": ["WATERBUTLER_ADDRS = ['127.0.0.1']"]}, {"lines": ["            url,", "            formToObj($this)", "        ).done(function() {"]}, {"lines": ["        }).fail(function(response) {", "            var message = 'Error: ';"]}, {"lines": ["            if (response && response.message) {", "                message += response.message;", "            } else {"]}, {"lines": ["            msgElm.text(message)", "                .removeClass('text-success').addClass('text-danger')", "                .fadeOut(100).fadeIn();"]}, {"lines": ["var xhook = require('../vendor/bower_components/xhook/dist/xhook.js').xhook;"]}, {"lines": ["var jquery = require('jquery');", ""]}, {"lines": ["// Adapted from http://jpillora.com/xhook/example/ie-8-9-cors-polyfill.html", "xhook.before(function(request, callback) {", "  // Skip modern browsers"]}, {"lines": ["    return callback();", "  }", "  // Skip same-origin requests", "  var url = request.url;", "  var loc = window.location;", "  var hostname = loc.hostname + (loc.port ? ':' + loc.port : '');", "  if (!/^https?:\\/\\/([^\\?\\/]+)/.test(url) || RegExp.$1 === hostname) {", "    return callback();", "  }", "  // Method must be GET or POST; if neither, pass override in query", "  var method = request.method;", "  if (method.toUpperCase() !== 'GET') {", "    url = URI(request.url)", "      .addSearch({method: request.method.toUpperCase()})", "      .toString();", "    method = 'POST';", "  }", "  // Request must use same protocol as current location", "  url = url.replace(/^https?:/,loc.protocol);", "  var xdr = new window.XDomainRequest();", "  xdr.timeout = request.timeout;", "  // Attach proxy events", "  var proxy = function(e) {", "    xdr['on' + e] = function() {", "      request.xhr.dispatchEvent(e);", "    };", "  };", "  var events = ['progress', 'timeout', 'error'];", "  for (var i=0; i<events.length; i++) {", "    proxy(events[i]);", "  }", "  xdr.onload = function() {", "    callback({", "      status: 200,", "      statusText: 'OK',", "      headers: {", "        'Content-Type': xdr.contentType", "      },", "      text: xdr.responseText", "    });", "  };", "  xdr.open(method, url);", "  xdr.send(request.body);", "});", "", "// Must tell jQuery that CORS is available, else requests won't be sent", "jquery.support.cors = true;"]}, {"lines": ["    file.url = _fangornResolveUploadUrl(item, file);", "    file.method = _fangornUploadMethod(item);", ""]}, {"lines": ["    configOption = resolveconfigOption.call(this, item, 'resolveRows', [item]);"]}, {"lines": ["        url: function(files) {return files[0].url;},"]}, {"lines": ["    // Pass ``null`` to avoid overwriting Dropzone URL resolver", "    resolveUploadUrl: function() {return null;},"]}, {"lines": ["    resolveUploadMethod: _fangornUploadMethod,"]}, {"lines": ["Fangorn.ButtonEvents = {", "    _downloadEvent: _downloadEvent,"]}, {"lines": ["    _uploadEvent: _uploadEvent,"]}, {"lines": ["};", ""]}, {"lines": [""]}, {"lines": ["                        }"]}, {"lines": ["                    }"]}, {"lines": ["function getViewOnly() {"]}, {"lines": ["}", ""]}, {"lines": ["    <script src=${\"/static/public/js/home-page.js\" | webpack_asset}></script>"]}, {"lines": ["<script src=${\"/static/public/js/profile-settings-page.js\" | webpack_asset}></script>"]}, {"lines": ["<script type=\"text/javascript\" src=\"${script | webpack_asset}\"></script>"]}, {"lines": ["<script src=${\"/static/public/js/files-page.js\" | webpack_asset}></script>"]}, {"lines": ["                    <tbody data-bind=\"foreach: links\">", "                        <tr>", "                            <td>", "                                <!-- ko if: url -->", "                                    <a data-bind=\"text: title, attr: {href: url}\"></a>", "                                <!-- /ko -->", "                                <!-- ko ifnot: url -->", "                                    <span data-bind=\"text: title\"></span>", "                                <!-- /ko -->", "                            </td>", "                            <td data-bind=\"text: authorShort\"></td>", "                        </tr>", "                    </tbody>"]}, {"lines": ["</%def>"]}, {"lines": ["<script src=${\"/static/public/js/project-base-page.js\" | webpack_asset}> </script>"]}, {"lines": ["    ${parent.javascript_bottom()}", "    % if schema:", "    <script src=\"${'/static/public/js/register_{0}-page.js'.format(metadata_version) | webpack_asset}\"></script>", "    % endif"]}, {"lines": ["                </div>"]}, {"lines": ["                </div>"]}, {"lines": ["    <script type=\"text/javascript\" src=${\"/static/public/js/project-settings-page.js\" | webpack_asset}></script>"]}, {"lines": ["    <script src=\"${js_asset | webpack_asset}\"></script>"]}, {"lines": ["    <script src=${\"/static/public/js/conference-page.js\" | webpack_asset}></script>"]}, {"lines": [""]}, {"lines": ["import logging"]}, {"lines": ["from flask import request, url_for", ""]}, {"lines": [""]}, {"lines": ["logger = logging.getLogger(__name__)", ""]}, {"lines": ["    content_type = request.content_type"]}], "name": "jmcarp"}, {"commits": [{"lines": ["var nodePath = function(dir) {", "    return path.join(__dirname, 'node_modules', dir);", "};"]}, {"lines": ["var addonsPath = function(dir) {", "    return path.join(__dirname, 'website', 'addons', dir);", "};"]}, {"lines": ["        'truncate': staticPath('vendor/bower_components/truncate/jquery.truncate.js'),"]}, {"lines": ["        // Needed for ace code editor in wiki"]}, {"lines": ["        'ace-noconflict': staticPath('vendor/bower_components/ace-builds/src-noconflict/ace.js'),"]}, {"lines": ["        'pagedown-ace-converter': addonsPath('wiki/static/pagedown-ace/Markdown.Converter.js'),", "        'pagedown-ace-sanitizer': addonsPath('wiki/static/pagedown-ace/Markdown.Sanitizer.js'),", "        'pagedown-ace-editor': addonsPath('wiki/static/pagedown-ace/Markdown.Editor.js'),"]}, {"lines": ["        'highlight-css': nodePath('highlight.js/styles/default.css'),"]}, {"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-", "\"\"\"", "Script to migrate dataverse projects to accomodate changes in their 4.0 API.", "This assumes that the script `migrate_credentials_to_token` has been run.", "", "Changes:", " - Rename node_addon.study to node_addon.dataset", " - Rename node_addon.study_hdl to node_addon.dataset_doi"]}, {"lines": ["", "\"\"\"", ""]}, {"lines": ["import sys"]}, {"lines": ["import logging", "from modularodm import Q", ""]}, {"lines": ["from website.app import init_app", "from scripts import utils as script_utils"]}, {"lines": ["from framework.transactions.context import TokuTransaction"]}, {"lines": [""]}, {"lines": ["from website.addons.dataverse.model import AddonDataverseNodeSettings"]}, {"lines": ["", "logger = logging.getLogger(__name__)", "", "", "def do_migration(records, dry=True):", "    for node_addon in records:", ""]}, {"lines": ["        with TokuTransaction():", "            logger.info('Record found for dataset {}'.format(node_addon.study_hdl))", "            logger.info('renaming fields for to {}'.format(node_addon.study_hdl))"]}, {"lines": [""]}, {"lines": ["            if not dry:", "                node_addon.dataset_doi = node_addon.study_hdl", "                node_addon.dataset = node_addon.study"]}, {"lines": [""]}, {"lines": ["                node_addon.study_hdl = None", "                node_addon.study = None"]}, {"lines": [""]}, {"lines": ["                node_addon.save()"]}, {"lines": ["", "", "def get_targets():", "    return AddonDataverseNodeSettings.find(", "        Q('user_settings', 'ne', None) &", "        Q('study_hdl', 'ne', None)", "    )", "", "", "def main(dry=True):"]}, {"lines": ["    do_migration(get_targets(), dry=dry)", "", ""]}, {"lines": ["if __name__ == '__main__':", "    dry = 'dry' in sys.argv", "    if not dry:", "        script_utils.add_file_logger(logger, __file__)"]}, {"lines": ["from nose.tools import *", "", "from scripts.dataverse.migrate_study import do_migration, get_targets", "", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory", "", "from website.addons.dataverse.model import AddonDataverseNodeSettings", "", "", "class TestDatasetMigration(OsfTestCase):", "", "    def setUp(self):", "        super(TestDatasetMigration, self).setUp()", "        self.project = ProjectFactory()", "        self.project.creator.add_addon('dataverse')", "        self.user_addon = self.project.creator.get_addon('dataverse')", "        self.project.add_addon('dataverse', None)", "        self.node_addon = self.project.get_addon('dataverse')", "        self.node_addon.study_hdl = 'doi:12.3456/DVN/00003'", "        self.node_addon.study = 'Example (DVN/00003)'", "        self.node_addon.user_settings = self.user_addon", "        self.node_addon.save()", "", "    def test_migration(self):", "", "        do_migration([self.node_addon], dry=False)", "        self.node_addon.reload()", "", "        assert_equal(self.node_addon.dataset_doi, 'doi:12.3456/DVN/00003')", "        assert_equal(self.node_addon.dataset, 'Example (DVN/00003)')", "", "    def test_get_targets(self):", "        AddonDataverseNodeSettings.remove()", "        addons = [", "            AddonDataverseNodeSettings(),", "            AddonDataverseNodeSettings(study_hdl='foo'),", "            AddonDataverseNodeSettings(user_settings=self.user_addon),", "            AddonDataverseNodeSettings(study_hdl='foo', user_settings=self.user_addon),", "        ]", "        for addon in addons:", "            addon.save()", "        targets = get_targets()", "        assert_equal(targets.count(), 1)", "        assert_equal(targets[0]._id, addons[-1]._id)"]}, {"lines": ["from .routes import settings_routes, api_routes"]}, {"lines": ["ROUTES = [settings_routes, api_routes]"]}, {"lines": ["import urlparse"]}, {"lines": ["from framework.auth.core import _get_current_user"]}, {"lines": ["from website.security import encrypt, decrypt"]}, {"lines": ["from website.addons.base import (", "    AddonNodeSettingsBase, AddonUserSettingsBase, GuidFile, exceptions,", ")"]}, {"lines": ["from website.addons.dataverse.settings import HOST"]}, {"lines": ["    def waterbutler_path(self):", "        return '/' + self.file_id", "", "    @property", "    def provider(self):", "        return 'dataverse'", "", "    @property"]}, {"lines": ["    def version_identifier(self):"]}, {"lines": ["        return 'version'"]}, {"lines": ["", "    @property", "    def unique_identifier(self):", "        return self.file_id", ""]}, {"lines": ["    def enrich(self, save=True):", "        super(DataverseFile, self).enrich(save)", ""]}, {"lines": ["        # Check permissions"]}, {"lines": ["        user = _get_current_user()"]}, {"lines": ["            try:", "                # Users without edit permission can only see published files", "                if not self._metadata_cache['extra']['hasPublishedVersion']:", "                    raise exceptions.FileDoesntExistError", "            except (KeyError, IndexError):", "                pass", ""]}, {"lines": ["    api_token = fields.StringField()"]}, {"lines": ["    # Legacy Fields", "    dataverse_username = fields.StringField()", "    encrypted_password = fields.StringField()", ""]}, {"lines": ["        return bool(self.api_token)"]}, {"lines": ["    @property", "    def dataverse_password(self):", "        if self.encrypted_password is None:", "            return None", "", "        return decrypt(self.encrypted_password)", "", "    @dataverse_password.setter", "    def dataverse_password(self, value):", "        if value is None:", "            self.encrypted_password = None", "            return", "", "        self.encrypted_password = encrypt(value)", ""]}, {"lines": ["        self.api_token = None"]}, {"lines": ["    dataset_doi = fields.StringField()"]}, {"lines": ["    _dataset_id = fields.StringField()"]}, {"lines": ["    dataset = fields.StringField()"]}, {"lines": ["    # Legacy fields", "    study_hdl = fields.StringField()    # Now dataset_doi", "    study = fields.StringField()        # Now dataset", ""]}, {"lines": ["    def dataset_id(self):", "        if self._dataset_id is None:", "            connection = connect_from_settings_or_401(self.user_settings)", "            dataverse = connection.get_dataverse(self.dataverse_alias)", "            dataset = dataverse.get_dataset_by_doi(self.dataset_doi)", "            self._dataset_id = dataset.id", "            self.save()", "        return self._dataset_id", "", "    @dataset_id.setter", "    def dataset_id(self, value):", "        self._dataset_id = value", "", "    @property"]}, {"lines": ["    def complete(self):"]}, {"lines": ["        return bool(self.has_auth and self.dataset_doi is not None)"]}, {"lines": ["    def find_or_create_file_guid(self, path):"]}, {"lines": ["        file_id = path.strip('/') if path else ''", "        return DataverseFile.get_or_create(node=self.owner, file_id=file_id)"]}, {"lines": [""]}, {"lines": ["        self.dataset_doi = None"]}, {"lines": ["        self.dataset_id = None"]}, {"lines": ["        self.dataset = None"]}, {"lines": ["    def serialize_waterbutler_credentials(self):", "        if not self.has_auth:", "            raise exceptions.AddonError('Addon is not authorized')", "        return {'token': self.user_settings.api_token}", "", "    def serialize_waterbutler_settings(self):"]}, {"lines": ["        return {"]}, {"lines": ["            'host': HOST,"]}, {"lines": ["            'doi': self.dataset_doi,", "            'id': self.dataset_id,", "            'name': self.dataset,", "        }"]}, {"lines": ["", "    def create_waterbutler_log(self, auth, action, metadata):"]}, {"lines": ["        path = metadata['path']", "        if 'name' in metadata:", "            name = metadata['name']", "        else:", "            query_string = urlparse.urlparse(metadata['full_path']).query", "            name = urlparse.parse_qs(query_string).get('name')", "", "        url = self.owner.web_url_for('addon_view_or_download_file', path=path, provider='dataverse')", "        self.owner.add_log(", "            'dataverse_{0}'.format(action),", "            auth=auth,", "            params={", "                'project': self.owner.parent_id,", "                'node': self.owner._id,", "                'dataset': self.dataset,", "                'filename': name,", "                'urls': {", "                    'view': url,", "                    'download': url + '?action=download'", "                },", "            },", "        )"]}, {"lines": [""]}, {"lines": ["                u'the Dataverse dataset linked to this {category} will not be included '"]}, {"lines": ["HOST = 'apitest.dataverse.org'  # Dataverse TEST server"]}, {"lines": ["    self.apiToken = ko.observable();"]}, {"lines": ["    self.loadedDatasets = ko.observable(false);"]}, {"lines": ["    self.datasets = ko.observableArray([]);"]}, {"lines": ["    self.savedDatasetDoi = ko.observable();", "    self.savedDatasetTitle = ko.observable();"]}, {"lines": ["    self.datasetWasFound = ko.observable(false);"]}, {"lines": ["                'to datasets on the Dataverse from the OSF. This will not remove your ' +"]}, {"lines": ["            return 'Your Dataverse API token is invalid.';"]}, {"lines": ["        datasetDeaccessioned: ko.pureComputed(function() {", "            return 'This dataset has already been deaccessioned on the Dataverse ' +"]}, {"lines": ["            return 'This dataset cannot be connected due to forbidden characters ' +", "                'in one or more of the dataset\\'s file names. This issue has been forwarded to our ' +"]}, {"lines": ["            return 'Successfully linked dataset \\'' + self.savedDatasetTitle() + '\\'. Go to the <a href=\"' +"]}, {"lines": ["        setDatasetError: ko.pureComputed(function() {", "            return 'Could not connect to this dataset. Please refresh the page or ' +"]}, {"lines": ["        getDatasetsError: ko.pureComputed(function() {", "            return 'Could not load datasets. Please refresh the page or ' +"]}, {"lines": ["    self.savedDatasetUrl = ko.pureComputed(function() {"]}, {"lines": ["        return (self.urls()) ? self.urls().datasetPrefix + self.savedDatasetDoi() : null;"]}, {"lines": ["    self.selectedDatasetDoi = ko.observable();"]}, {"lines": ["    self.selectedDatasetTitle = ko.pureComputed(function() {", "        for (var i = 0; i < self.datasets().length; i++) {"]}, {"lines": ["            var data = self.datasets()[i];", "            if (data.doi === self.selectedDatasetDoi()) {"]}, {"lines": ["    self.dataverseHasDatasets = ko.pureComputed(function() {"]}, {"lines": ["        return self.datasets().length > 0;"]}, {"lines": ["    self.showDatasetSelect = ko.pureComputed(function() {"]}, {"lines": ["        return self.loadedDatasets() && self.dataverseHasDatasets();"]}, {"lines": ["    self.showNoDatasets = ko.pureComputed(function() {"]}, {"lines": ["        return self.loadedDatasets() && !self.dataverseHasDatasets();"]}, {"lines": ["    self.showLinkedDataset = ko.pureComputed(function() {"]}, {"lines": ["        return self.savedDatasetDoi();"]}, {"lines": ["        return self.savedDatasetDoi() && self.loadedDatasets() && !self.datasetWasFound();"]}, {"lines": ["    self.showSubmitDataset = ko.pureComputed(function() {"]}, {"lines": ["    self.enableSubmitDataset = ko.pureComputed(function() {"]}, {"lines": ["        return !self.submitting() && self.dataverseHasDatasets() &&", "            self.savedDatasetDoi() !== self.selectedDatasetDoi();"]}, {"lines": ["        self.savedDatasetDoi(data.savedDataset.doi);", "        self.savedDatasetTitle(data.savedDataset.title);"]}, {"lines": ["            self.getDatasets(); // Sets datasets, selectedDatasetDoi"]}, {"lines": ["            dataset: {", "                doi: self.selectedDatasetDoi"]}, {"lines": ["        self.savedDatasetDoi(self.selectedDatasetDoi());", "        self.savedDatasetTitle(self.selectedDatasetTitle());", "        self.datasetWasFound(true);"]}, {"lines": ["        var errorMessage = (xhr.status === 410) ? self.messages.datasetDeaccessioned :", "            (xhr.status = 406) ? self.messages.forbiddenCharacters : self.messages.setDatasetError;"]}, {"lines": ["        self.changeMessage(errorMessage, 'text-danger');"]}, {"lines": [" * Looks for dataset in list of datasets when first loaded."]}, {"lines": ["ViewModel.prototype.findDataset = function() {"]}, {"lines": ["    for (var i in self.datasets()) {", "        if (self.datasets()[i].doi === self.savedDatasetDoi()) {", "            self.datasetWasFound(true);"]}, {"lines": ["ViewModel.prototype.getDatasets = function() {"]}, {"lines": ["    self.datasets([]);"]}, {"lines": ["    self.loadedDatasets(false);"]}, {"lines": ["        self.urls().getDatasets,"]}, {"lines": ["        self.datasets(response.datasets);"]}, {"lines": ["        self.loadedDatasets(true);", "        self.selectedDatasetDoi(self.savedDatasetDoi());", "        self.findDataset();"]}, {"lines": ["    }).fail(function(xhr, status, error) {"]}, {"lines": ["        self.changeMessage(self.messages.getDatasetsError, 'text-danger');"]}, {"lines": ["        Raven.captureMessage('Could not GET datasets', {", "            url: self.urls().getDatasets,", "            textStatus: status,", "            error: error", "        });"]}, {"lines": ["    }).fail(function(xhr, status, error) {"]}, {"lines": ["        Raven.captureMessage('Could not import Dataverse node auth', {", "            url: self.urls().importAuth,", "            textStatus: status,", "            error: error", "        });"]}, {"lines": ["        ko.toJS({api_token: self.apiToken})"]}, {"lines": ["    self.dataset = ko.observable();"]}, {"lines": ["    self.datasetUrl = ko.observable('');"]}, {"lines": ["                self.dataset(data.dataset);"]}, {"lines": ["                self.datasetUrl(data.datasetUrl);"]}, {"lines": ["                authorized", "                    <a data-bind=\"click: deleteKey\" class=\"text-danger pull-right addon-auth\">Delete API Token</a>"]}, {"lines": ["            Your dataverse credentials may not be valid. Please re-enter your API token."]}, {"lines": ["            <label for=\"apiToken\">", "                API Token", "                <a href=\"{{urls().apiToken}}\"", "                   target=\"_blank\" class=\"text-muted addon-external-link\">", "                    (Get from Dataverse <i class=\"fa fa-external-link-square\"></i>)", "                </a>", "            </label>"]}, {"lines": ["            <input class=\"form-control\" name=\"apiToken\" data-bind=\"value: apiToken\"/>"]}, {"lines": ["<a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect, text: params.filename\"></a> to"]}, {"lines": ["Dataverse dataset <span class=\"overflow\">{{ params.dataset }}</span>"]}, {"lines": ["Dataverse dataset <span class=\"overflow\">{{ params.dataset }}</span>"]}, {"lines": ["<script type=\"text/html\" id=\"dataverse_dataset_linked\">", "linked Dataverse dataset"]}, {"lines": ["<!-- Legacy version -->", "<script type=\"text/html\" id=\"dataverse_study_linked\">", "linked Dataverse dataset"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"dataverse_dataset_published\">", "published a new version of Dataverse dataset"]}, {"lines": ["<!-- Legacy version -->", "<script type=\"text/html\" id=\"dataverse_study_released\">", "published a new version of Dataverse dataset"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", ""]}, {"lines": ["from dataverse import Connection, Dataverse, DataverseFile, Dataset", "from dataverse.exceptions import UnauthorizedError"]}, {"lines": ["from website.addons.dataverse.client import (_connect, get_files,", "    publish_dataset, get_datasets, get_dataset,"]}, {"lines": ["    get_dataverses, get_dataverse, connect_from_settings, connect_or_401,", "    connect_from_settings_or_401)"]}, {"lines": ["        self.mock_dataset = mock.create_autospec(Dataset)"]}, {"lines": ["        self.mock_file.dataset = self.mock_dataset", "        self.mock_dataset.dataverse = self.mock_dataverse"]}, {"lines": ["    def test_connect(self, mock_connection):", "        mock_connection.return_value = mock.create_autospec(Connection)", "        c = _connect('My token', 'My host')"]}, {"lines": ["        mock_connection.assert_called_once_with('My host', 'My token')"]}, {"lines": ["    def test_connect_default_host(self, mock_connection):", "        mock_connection.return_value = mock.create_autospec(Connection)", "        c = _connect('My token')"]}, {"lines": ["        mock_connection.assert_called_once_with(settings.HOST, 'My token')", "        assert_true(c)"]}, {"lines": ["    def test_connect_fail(self, mock_connection):", "        mock_connection.side_effect = UnauthorizedError()", "        with assert_raises(UnauthorizedError):", "            _connect('My token', 'My host')"]}, {"lines": ["        mock_connection.assert_called_once_with('My host', 'My token')"]}, {"lines": ["    @mock.patch('website.addons.dataverse.client.Connection')", "    def test_connect_or_401(self, mock_connection):", "        mock_connection.return_value = mock.create_autospec(Connection)", "        c = connect_or_401('My token')"]}, {"lines": ["        mock_connection.assert_called_once_with(settings.HOST, 'My token')"]}, {"lines": ["    def test_connect_or_401_forbidden(self, mock_connection):", "        mock_connection.side_effect = UnauthorizedError()"]}, {"lines": ["            connect_or_401('My token')"]}, {"lines": ["        mock_connection.assert_called_once_with(settings.HOST, 'My token')"]}, {"lines": ["        assert_equal(cm.exception.code, 401)"]}, {"lines": ["    @mock.patch('website.addons.dataverse.client._connect')"]}, {"lines": ["        user_settings.api_token = 'Something ridiculous'"]}, {"lines": ["        mock_connect.assert_called_once_with(user_settings.api_token)"]}, {"lines": ["    def test_connect_from_settings_none(self):", "        connection = connect_from_settings(None)", "        assert_is_none(connection)", ""]}, {"lines": ["    @mock.patch('website.addons.dataverse.client._connect')"]}, {"lines": ["    def test_connect_from_settings_or_401(self, mock_connect):"]}, {"lines": ["        user_settings.api_token = 'Something ridiculous'"]}, {"lines": ["        connection = connect_from_settings_or_401(user_settings)"]}, {"lines": ["        mock_connect.assert_called_once_with(user_settings.api_token)"]}, {"lines": ["    def test_connect_from_settings_or_401_none(self):", "        connection = connect_from_settings_or_401(None)", "        assert_is_none(connection)", ""]}, {"lines": ["    def test_connect_from_settings_or_401_forbidden(self, mock_connection):", "        mock_connection.side_effect = UnauthorizedError()"]}, {"lines": ["        user_settings.api_token = 'Something ridiculous'"]}, {"lines": ["        with assert_raises(HTTPError) as e:", "            connect_from_settings_or_401(user_settings)"]}, {"lines": ["        mock_connection.assert_called_once_with(", "            settings.HOST, user_settings.api_token,"]}, {"lines": ["        assert_equal(e.exception.code, 401)"]}, {"lines": ["        published = False", "        get_files(self.mock_dataset, published)", "        self.mock_dataset.get_files.assert_called_once_with('latest')", ""]}, {"lines": ["    def test_get_files_published(self):"]}, {"lines": ["        published = True", "        get_files(self.mock_dataset, published)"]}, {"lines": ["        self.mock_dataset.get_files.assert_called_once_with('latest-published')"]}, {"lines": ["", "    def test_publish_dataset(self):", "        publish_dataset(self.mock_dataset)", "        self.mock_dataset.publish.assert_called_once_with()", ""]}, {"lines": ["    def test_publish_dataset_unpublished_dataverse(self):", "        type(self.mock_dataverse).is_published = mock.PropertyMock(return_value=False)", "        with assert_raises(HTTPError) as e:", "            publish_dataset(self.mock_dataset)", "", "        assert_false(self.mock_dataset.publish.called)", "        assert_equal(e.exception.code, 405)", ""]}, {"lines": ["    def test_get_datasets(self):", "        mock_dataset1 = mock.create_autospec(Dataset)", "        mock_dataset2 = mock.create_autospec(Dataset)", "        mock_dataset3 = mock.create_autospec(Dataset)", "        mock_dataset1.get_state.return_value = 'DRAFT'", "        mock_dataset2.get_state.return_value = 'RELEASED'", "        mock_dataset3.get_state.return_value = 'DEACCESSIONED'", "        self.mock_dataverse.get_datasets.return_value = [", "            mock_dataset1, mock_dataset2, mock_dataset3"]}, {"lines": ["        datasets = get_datasets(self.mock_dataverse)"]}, {"lines": ["        self.mock_dataverse.get_datasets.assert_called_once_with()", "        assert_in(mock_dataset1, datasets)", "        assert_in(mock_dataset2, datasets)", "        assert_in(mock_dataset3, datasets)"]}, {"lines": ["    def test_get_datasets_no_dataverse(self):"]}, {"lines": ["        datasets = get_datasets(None)"]}, {"lines": ["        assert_equal(datasets, [])"]}, {"lines": ["    def test_get_dataset(self):", "        self.mock_dataset.get_state.return_value = 'DRAFT'", "        self.mock_dataverse.get_dataset_by_doi.return_value = self.mock_dataset"]}, {"lines": ["        s = get_dataset(self.mock_dataverse, 'My hdl')", "        self.mock_dataverse.get_dataset_by_doi.assert_called_once_with('My hdl')"]}, {"lines": ["        assert_equal(s, self.mock_dataset)"]}, {"lines": ["    def test_get_deaccessioned_dataset(self):", "        self.mock_dataset.get_state.return_value = 'DEACCESSIONED'", "        self.mock_dataverse.get_dataset_by_doi.return_value = self.mock_dataset"]}, {"lines": ["            s = get_dataset(self.mock_dataverse, 'My hdl')"]}, {"lines": ["        self.mock_dataverse.get_dataset_by_doi.assert_called_once_with('My hdl')"]}, {"lines": ["    def test_get_bad_dataset(self):"]}, {"lines": ["        self.mock_dataset.get_state.side_effect = error", "        self.mock_dataverse.get_dataset_by_doi.return_value = self.mock_dataset"]}, {"lines": ["            s = get_dataset(self.mock_dataverse, 'My hdl')", "        self.mock_dataverse.get_dataset_by_doi.assert_called_once_with('My hdl')"]}, {"lines": ["        published_dv = mock.create_autospec(Dataverse)", "        unpublished_dv = mock.create_autospec(Dataverse)", "        type(published_dv).is_published = mock.PropertyMock(return_value=True)", "        type(unpublished_dv).is_published = mock.PropertyMock(return_value=False)"]}, {"lines": ["            published_dv, unpublished_dv"]}, {"lines": ["        assert_in(published_dv, dvs)"]}, {"lines": ["        assert_in(unpublished_dv, dvs)", "        assert_equal(len(dvs), 2)"]}, {"lines": ["        type(self.mock_dataverse).is_published = mock.PropertyMock(return_value=True)"]}, {"lines": ["    def test_get_unpublished_dataverse(self):", "        type(self.mock_dataverse).is_published = mock.PropertyMock(return_value=False)"]}, {"lines": ["        assert_equal(d, self.mock_dataverse)"]}, {"lines": ["from dataverse import Dataverse, Dataset, DataverseFile"]}, {"lines": ["    create_mock_dataverse, create_mock_dataset, create_mock_draft_file,"]}, {"lines": ["    create_mock_connection, DataverseAddonTestCase,"]}, {"lines": ["        assert_equal(mock_connection.token, 'snowman-frosty')"]}, {"lines": ["        assert_true(mock_dv.is_published)"]}, {"lines": ["        assert_equal(len(mock_dv.get_datasets()), 3)", "        assert_is_instance(mock_dv.get_datasets()[0], Dataset)", "        assert_equal(mock_dv.get_dataset_by_doi(mock_dv.get_datasets()[1].doi),", "                     mock_dv.get_datasets()[1])"]}, {"lines": ["    def test_mock_dataset(self):", "        dataset_id = 'DVN/23456'", "        doi = 'doi:12.3456/{0}'.format(dataset_id)", "        mock_dataset = create_mock_dataset(dataset_id)", "        assert_equal(mock_dataset.doi, doi)", "        assert_equal(mock_dataset.citation,", "                     'Example Citation for {0}'.format(dataset_id))", "        assert_equal(mock_dataset.title, 'Example ({0})'.format(dataset_id))", "        assert_equal(mock_dataset.doi, doi)", "        assert_equal(mock_dataset.get_state(), 'DRAFT')", "        assert_equal(len(mock_dataset.get_files()), 1)", "        assert_false(mock_dataset.get_files()[0].is_published)", "        assert_true(mock_dataset.get_files(published=True)[0].is_published)", "        assert_false(mock_dataset.get_file('name.txt').is_published)", "        assert_true(mock_dataset.get_file('name.txt', published=True).is_published)", "        assert_false(mock_dataset.get_file_by_id('123').is_published)", "        assert_true(mock_dataset.get_file_by_id('123', published=True).is_published)"]}, {"lines": ["from dataverse import Connection, Dataverse, Dataset, DataverseFile"]}, {"lines": ["        settings.api_token = 'snowman-frosty'"]}, {"lines": ["        settings.dataset_doi = 'doi:12.3456/DVN/00001'"]}, {"lines": ["        settings.dataset_id = '18'"]}, {"lines": ["        settings.dataset = 'Example (DVN/00001)'"]}, {"lines": ["def create_mock_connection(token='snowman-frosty'):"]}, {"lines": ["    will return none."]}, {"lines": ["    if not token == 'snowman-frosty':"]}, {"lines": ["        return None"]}, {"lines": ["    mock_connection.token = token"]}, {"lines": ["        create_mock_dataverse('Example 3'),"]}, {"lines": ["    return mock_connection"]}, {"lines": ["    type(mock_dataverse).is_published = mock.PropertyMock(return_value=True)"]}, {"lines": ["    mock_dataverse.get_datasets.return_value = [", "        create_mock_dataset('DVN/00001'),", "        create_mock_dataset('DVN/00002'),"]}, {"lines": ["        create_mock_dataset('DVN/00003'),"]}, {"lines": ["    def _get_dataset_by_doi(doi):"]}, {"lines": ["            dataset for dataset in mock_dataverse.get_datasets()", "            if dataset.doi == doi), None"]}, {"lines": ["    mock_dataverse.get_dataset_by_doi = mock.MagicMock(", "        side_effect=_get_dataset_by_doi"]}, {"lines": ["def create_mock_dataset(id='DVN/12345'):", "    mock_dataset = mock.create_autospec(Dataset)"]}, {"lines": ["    mock_dataset.citation = 'Example Citation for {0}'.format(id)", "    mock_dataset.title = 'Example ({0})'.format(id)", "    mock_dataset.doi = 'doi:12.3456/{0}'.format(id)"]}, {"lines": ["    mock_dataset.id = '18'"]}, {"lines": ["    mock_dataset.get_state.return_value = 'DRAFT'"]}, {"lines": ["    def _create_file(name, published=False):", "        return create_mock_published_file() if published else create_mock_draft_file()"]}, {"lines": ["    def _create_files(published=False):", "        return [_create_file('name.txt', published)]"]}, {"lines": ["    mock_dataset.get_files = mock.MagicMock(side_effect=_create_files)", "    mock_dataset.get_file = mock.MagicMock(side_effect=_create_file)", "    mock_dataset.get_file_by_id = mock.MagicMock(side_effect=_create_file)"]}, {"lines": ["        return mock_dataset"]}, {"lines": ["    mock_file.is_published = False"]}, {"lines": ["def create_mock_published_file(id='54321'):"]}, {"lines": ["    mock_file.name = 'published.txt'"]}, {"lines": ["    mock_file.is_published = True"]}, {"lines": ["        u'hasPublishedFiles': True,", "        u'state': 'published',"]}, {"lines": ["from website.addons.dataverse.client import connect_from_settings_or_401"]}, {"lines": ["from website.addons.dataverse.settings import HOST"]}, {"lines": ["        connection = connect_from_settings_or_401(user_addon)"]}, {"lines": ["        if error.code == 401:"]}, {"lines": ["        'apiToken': 'https://{0}/account/apitoken'.format(HOST),"]}, {"lines": ["            'apiToken': user_addon.api_token,"]}, {"lines": ["from website.addons.dataverse.client import ("]}, {"lines": ["    publish_dataset, get_dataset, get_dataverse, connect_from_settings_or_401,"]}, {"lines": ["    publish_dataverse,"]}, {"lines": [")"]}, {"lines": ["def dataverse_publish_dataset(node_addon, auth, **kwargs):"]}, {"lines": ["    return dataverse_publish(node_addon, auth)"]}, {"lines": ["", "@must_have_permission('write')", "@must_not_be_registration", "@must_have_addon('dataverse', 'node')", "def dataverse_publish_both(node_addon, auth, **kwargs):", "    return dataverse_publish(node_addon, auth, True)", "", "", "def dataverse_publish(node_addon, auth, publish_both=False):"]}, {"lines": ["        connection = connect_from_settings_or_401(user_settings)"]}, {"lines": ["        if error.code == httplib.UNAUTHORIZED:"]}, {"lines": ["    dataset = get_dataset(dataverse, node_addon.dataset_doi)"]}, {"lines": ["    if publish_both:", "        publish_dataverse(dataverse)"]}, {"lines": ["    publish_dataset(dataset)"]}, {"lines": ["        action='dataverse_dataset_published',"]}, {"lines": ["            'dataset': dataset.title,"]}, {"lines": ["    return {'dataset': dataset.title}, httplib.OK"]}, {"lines": ["from website.addons.dataverse.client import connect_from_settings_or_401, \\", "    get_dataverse, get_dataset"]}, {"lines": ["        'complete': node_addon.complete,"]}, {"lines": ["    if not node_addon.complete:"]}, {"lines": ["    doi = node_addon.dataset_doi"]}, {"lines": ["    connection = connect_from_settings_or_401(node_addon.user_settings)"]}, {"lines": ["    dataset = get_dataset(dataverse, doi)"]}, {"lines": ["    if dataset is None:"]}, {"lines": ["    dataverse_url = 'http://{0}/dataverse/'.format(HOST) + alias"]}, {"lines": ["    dataset_url = 'http://dx.doi.org/' + doi"]}, {"lines": ["        'dataset': node_addon.dataset,"]}, {"lines": ["        'datasetUrl': dataset_url,", "        'citation': dataset.citation,"]}, {"lines": ["    pass", "", "class InvalidVersionError(WikiError):", "    \"\"\"Raised if user tries to access a wiki page version that does not exist.\"\"\""]}, {"lines": ["        ], 'get', views.project_wiki_home, OsfWebRenderer(os.path.join(TEMPLATE_DIR, 'edit.mako'))),"]}, {"lines": ["        ], 'get', views.project_wiki_id_page, OsfWebRenderer(os.path.join(TEMPLATE_DIR, 'edit.mako'))),"]}, {"lines": ["        # Wiki | GET"]}, {"lines": ["        ], 'get', views.project_wiki_view, OsfWebRenderer(os.path.join(TEMPLATE_DIR, 'edit.mako'))),"]}, {"lines": ["        # Edit | GET (legacy url, trigger redirect)"]}, {"lines": ["        ], 'get', views.project_wiki_edit, OsfWebRenderer(os.path.join(TEMPLATE_DIR, 'edit.mako'))),", "", "        # Compare | GET (legacy url, trigger redirect)", "        Rule(["]}, {"lines": ["        ], 'get', views.project_wiki_compare, OsfWebRenderer(os.path.join(TEMPLATE_DIR, 'edit.mako'))),", "", "        # Edit | POST", "        Rule([", "            '/project/<pid>/wiki/<wname>/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/',"]}, {"lines": ["        ], 'post', views.project_wiki_edit_post, OsfWebRenderer(os.path.join(TEMPLATE_DIR, 'edit.mako'))),"]}, {"lines": ["        # Draft : GET"]}, {"lines": ["            '/project/<pid>/wiki/<wname>/draft/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/draft/',", "        ], 'get', views.wiki_page_draft, json_renderer),"]}, {"lines": ["        # Content : GET"]}, {"lines": ["        # <wver> refers to a wiki page's version number", "        Rule(["]}, {"lines": ["            '/project/<pid>/wiki/<wname>/content/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/content/',"]}, {"lines": ["            '/project/<pid>/wiki/<wname>/content/<wver>/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/content/<wver>/',"]}, {"lines": ["        ], 'get', views.wiki_page_content, json_renderer),"]}, {"lines": [""]}, {"lines": ["import os", "import urllib"]}, {"lines": ["import uuid"]}, {"lines": [""]}, {"lines": ["from pymongo import MongoClient"]}, {"lines": ["import requests"]}, {"lines": [""]}, {"lines": ["from framework.mongo.utils import to_mongo_key"]}, {"lines": ["from website import settings"]}, {"lines": ["from website.addons.wiki.exceptions import InvalidVersionError"]}, {"lines": ["", ""]}, {"lines": ["def generate_private_uuid(node, wname):"]}, {"lines": ["    \"\"\"", "    Generate private uuid for internal use in sharejs namespacing.", "    Note that this will NEVER be passed to to the client or sharejs.", "    \"\"\""]}, {"lines": [""]}, {"lines": ["    private_uuid = str(uuid.uuid1())"]}, {"lines": ["    wiki_key = to_mongo_key(wname)"]}, {"lines": ["    node.wiki_private_uuids[wiki_key] = private_uuid"]}, {"lines": ["    node.save()", ""]}, {"lines": ["    return private_uuid"]}, {"lines": ["", ""]}, {"lines": ["def get_sharejs_uuid(node, wname):"]}, {"lines": ["    \"\"\""]}, {"lines": ["    Format private uuid into the form used in mongo and sharejs.", "    This includes node's primary ID to prevent fork namespace collision"]}, {"lines": ["    \"\"\""]}, {"lines": ["    wiki_key = to_mongo_key(wname)"]}, {"lines": ["    private_uuid = node.wiki_private_uuids.get(wiki_key)"]}, {"lines": ["    return str(uuid.uuid5("]}, {"lines": ["        uuid.UUID(private_uuid),"]}, {"lines": ["        str(node._id)"]}, {"lines": ["    )) if private_uuid else None"]}, {"lines": ["", ""]}, {"lines": ["def delete_share_doc(node, wname):", "    \"\"\"Deletes share document and removes namespace from model.\"\"\"", "", "    db = share_db()", "    sharejs_uuid = get_sharejs_uuid(node, wname)", "", "    db['docs'].remove({'_id': sharejs_uuid})", "    db['docs_ops'].remove({'name': sharejs_uuid})", "", "    wiki_key = to_mongo_key(wname)", "    del node.wiki_private_uuids[wiki_key]", "    node.save()", "", "", "def migrate_uuid(node, wname):", "    \"\"\"Migrates uuid to new namespace.\"\"\"", "", "    db = share_db()", "    old_sharejs_uuid = get_sharejs_uuid(node, wname)", "", "    broadcast_to_sharejs('lock', old_sharejs_uuid)", "", "    generate_private_uuid(node, wname)", "    new_sharejs_uuid = get_sharejs_uuid(node, wname)", "", "    doc_item = db['docs'].find_one({'_id': old_sharejs_uuid})", "    if doc_item:", "        doc_item['_id'] = new_sharejs_uuid", "        db['docs'].insert(doc_item)", "        db['docs'].remove({'_id': old_sharejs_uuid})", "", "    ops_items = [item for item in db['docs_ops'].find({'name': old_sharejs_uuid})]", "    if ops_items:", "        for item in ops_items:", "            item['_id'] = item['_id'].replace(old_sharejs_uuid, new_sharejs_uuid)", "            item['name'] = new_sharejs_uuid", "        db['docs_ops'].insert(ops_items)", "        db['docs_ops'].remove({'name': old_sharejs_uuid})", ""]}, {"lines": ["    write_contributors = [", "        user._id for user in node.contributors", "        if node.has_permission(user, 'write')", "    ]", "    broadcast_to_sharejs('unlock', old_sharejs_uuid, data=write_contributors)"]}, {"lines": ["", ""]}, {"lines": ["def share_db():", "    \"\"\"Generate db client for sharejs db\"\"\""]}, {"lines": ["    client = MongoClient(settings.DB_HOST, settings.DB_PORT)"]}, {"lines": ["", ""]}, {"lines": ["def get_sharejs_content(node, wname):", "    db = share_db()", "    sharejs_uuid = get_sharejs_uuid(node, wname)", "", "    doc_item = db['docs'].find_one({'_id': sharejs_uuid})", "    return doc_item['_data'] if doc_item else ''", "", ""]}, {"lines": ["def broadcast_to_sharejs(action, sharejs_uuid, node=None, wiki_name='home', data=None):"]}, {"lines": ["    \"\"\"", "    Broadcast an action to all documents connected to a wiki.", "    Actions include 'lock', 'unlock', 'redirect', and 'delete'", "    'redirect' and 'delete' both require a node to be specified"]}, {"lines": ["    'unlock' requires data to be a list of contributors with write permission"]}, {"lines": ["    \"\"\"", "", "    url = 'http://{host}:{port}/{action}/{id}/'.format("]}, {"lines": ["        action=action,", "        id=sharejs_uuid", "    )", "", "    if action == 'redirect' or action == 'delete':"]}, {"lines": ["        redirect_url = urllib.quote("]}, {"lines": ["            node.web_url_for('project_wiki_view', wname=wiki_name, _guid=True),"]}, {"lines": ["            safe='',", "        )", "        url = os.path.join(url, redirect_url)", ""]}, {"lines": ["    try:"]}, {"lines": ["        requests.post(url, json=data)"]}, {"lines": ["    except requests.ConnectionError:", "        pass    # Assume sharejs is not online"]}, {"lines": ["", "", "def format_wiki_version(version, num_versions, allow_preview):", "    \"\"\"", "    :param str version: 'preview', 'current', 'previous', '1', '2', ...", "    :param int num_versions:", "    :param allow_preview: True if view, False if compare", "    \"\"\"", "", "    if not version:", "        return", "", "    if version.isdigit():", "        version = int(version)", "        if version > num_versions or version < 1:"]}, {"lines": ["            raise InvalidVersionError"]}, {"lines": ["        elif version == num_versions:", "            return 'current'", "        elif version == num_versions - 1:", "            return 'previous'", "    elif version != 'current' and version != 'previous':", "        if allow_preview and version == 'preview':", "            return version"]}, {"lines": ["        raise InvalidVersionError"]}, {"lines": ["    elif version == 'previous' and num_versions == 0:"]}, {"lines": ["        raise InvalidVersionError"]}, {"lines": [""]}, {"lines": ["snippet math-inline\\n\\", "\t\\$${1:text}\\$\\n\\"]}, {"lines": ["var activeUsers = [];"]}, {"lines": ["var collaborative = (typeof WebSocket !== 'undefined' && typeof sharejs !== 'undefined');"]}, {"lines": [""]}, {"lines": ["    var ctx = window.contextVars.wiki;"]}, {"lines": ["    // Initialize Ace and configure settings"]}, {"lines": [""]}, {"lines": ["    if (!collaborative) {"]}, {"lines": ["        // Populate editor with most recent draft"]}, {"lines": ["            if (typeof WebSocket === 'undefined') {"]}, {"lines": ["            } else {", "                viewModel.status('disconnected');", "            }"]}, {"lines": ["        });", "        return;", "    }", ""]}, {"lines": ["    // Configure connection"]}, {"lines": ["    var wsUrl = wsPrefix + ctx.urls.sharejs;"]}, {"lines": ["    var socket = new ReconnectingWebSocket(wsUrl);"]}, {"lines": ["    var sjs = new sharejs.Connection(socket);"]}, {"lines": ["    var doc = sjs.get('docs', metadata.docId);"]}, {"lines": ["    var madeConnection = false;"]}, {"lines": ["    var allowRefresh = true;", "    var refreshTriggered = false;"]}, {"lines": ["    var canEdit = true;"]}, {"lines": [""]}, {"lines": ["    function whenReady() {", "", "        // Create a text document if one does not exist", "        if (!doc.type) {", "            doc.create('text');"]}, {"lines": ["        }", ""]}, {"lines": ["            if (viewModel.wikisDiffer(viewModel.currentText(), response.wiki_draft)) {", "                viewModel.currentText(response.wiki_draft);", "            }"]}, {"lines": ["            unlockEditor();"]}, {"lines": ["            viewModel.status('connected');", "            madeConnection = true;", "        });"]}, {"lines": ["", "    }", ""]}, {"lines": ["    function unlockEditor() {"]}, {"lines": ["        undoManager.reset();"]}, {"lines": ["    }", ""]}, {"lines": ["    // Send user metadata", "    function register() {", "        socket.send(JSON.stringify(metadata));", "    }", ""]}, {"lines": ["    function refreshMaybe() {", "        if (allowRefresh && refreshTriggered) {"]}, {"lines": ["            if (canEdit) {", "                window.location.reload();", "            } else {", "                window.location.replace(ctx.urls.page);", "            }"]}, {"lines": ["        }", "    }", ""]}, {"lines": ["    // Handle our custom messages separately"]}, {"lines": ["    var onmessage = socket.onmessage;"]}, {"lines": ["    socket.onmessage = function (message) {", "        var data = JSON.parse(message.data);"]}, {"lines": ["        // Meta type is not built into sharejs; we pass it manually"]}, {"lines": ["                allowRefresh = false;"]}, {"lines": ["                setTimeout(function() {", "                    allowRefresh = true;", "                    refreshMaybe();", "                }, 3000);"]}, {"lines": ["                canEdit = data.contributors.indexOf(metadata.userId) > -1;"]}, {"lines": ["                refreshTriggered = true;", "                refreshMaybe();"]}, {"lines": ["                if (ctx.triggeredDelete) {"]}, {"lines": ["                    break;", "                }"]}, {"lines": ["        }", "    };", ""]}, {"lines": ["    // Update status when reconnecting", "    var onclose = socket.onclose;", "    socket.onclose = function (event) {", "        onclose(event);", "        viewModel.status('connecting');", "    };", "", "    var onopen = socket.onopen;", "    socket.onopen = function(event) {", "        onopen(event);"]}, {"lines": ["        if (madeConnection) {", "            viewModel.status('connected');", "        }"]}, {"lines": ["    };", ""]}, {"lines": ["    // This will be called on both connect and reconnect"]}, {"lines": ["    doc.on('subscribe', register);"]}, {"lines": ["", "    // This will be called when we have a live copy of the server's data."]}, {"lines": ["    doc.whenReady(whenReady);"]}, {"lines": ["", "    // Subscribe to changes", "    doc.subscribe();"]}, {"lines": ["};", ""]}, {"lines": ["    menuVisible: true,"]}, {"lines": ["    compareVersion: 'previous',"]}, {"lines": ["    urls: {", "        content: '',", "        draft: '',", "        page: ''", "    },"]}, {"lines": ["    self.menuVis = ko.observable(options.menuVisible);"]}, {"lines": ["    self.draftURL = options.urls.draft;", "    self.contentURL = options.urls.content;", "    self.pageURL = options.urls.page;"]}, {"lines": ["        // Do not change URL for incompatible browsers", "        if (typeof window.history.replaceState === 'undefined') {", "            return;", "        }", ""]}, {"lines": ["", "        // Default view is special cased", "        if (!self.editVis() && self.viewVis() && self.viewVersion() === 'current' && !self.compareVis() && self.menuVis()) {"]}, {"lines": ["            window.history.replaceState({}, '', url);"]}, {"lines": ["            return;", "        }", ""]}, {"lines": ["            url += paramPrefix + 'edit';", "            paramPrefix = '&';"]}, {"lines": ["        if (self.viewVis()) {"]}, {"lines": ["            url += paramPrefix + 'view';", "            paramPrefix = '&';"]}, {"lines": ["            if  ((!self.editVis() && self.viewVersion() !== 'current' ) ||", "                 (self.editVis() && self.viewVersion() !== 'preview')) {"]}, {"lines": ["                url += '=' + self.viewVersion();"]}, {"lines": ["            url += paramPrefix + 'compare';"]}, {"lines": ["            paramPrefix = '&';"]}, {"lines": ["            if (self.compareVersion() !== 'previous'){", "                url += '=' + self.compareVersion();"]}, {"lines": ["        if (self.menuVis()) {"]}, {"lines": ["            url += paramPrefix + 'menu';", "        }"]}, {"lines": ["        window.history.replaceState({}, self.pageTitle, url);"]}, {"lines": [""]}, {"lines": ["    var bodyElement = $('body');", "    bodyElement.on('togglePanel', function (event, panel, display) {"]}, {"lines": ["        // Update self.editVis, self.viewVis, or self.compareVis in viewmodel", "        self[panel + 'Vis'](display);", ""]}, {"lines": ["        // Switch view to correct version", "        if (panel === 'edit') {", "            if (display) {"]}, {"lines": ["                self.viewVersion('preview');", "            } else if (self.viewVersion() === 'preview') {", "                self.viewVersion('current');"]}, {"lines": ["            }"]}, {"lines": ["        }", "    });"]}, {"lines": ["", "    bodyElement.on('toggleMenu', function(event, menuVisible) {", "        self.menuVis(menuVisible);", "    });"]}, {"lines": ["\ufeff// OSF Note: This file has been changed for UI reasons and to prevent", "// automatic rendering. This is only here for the toolbar", "", "// needs Markdown.Converter.js at the moment"]}, {"lines": ["    var focusNoScroll = function(element) {", "        var x = window.scrollX;", "        var y = window.scrollY;", "        element.focus();", "        window.scrollTo(x, y);", "        return element;", "    };", ""]}, {"lines": ["", "        // This does not live render anymore", "        this.run = function (aceEditor) {"]}, {"lines": ["            var previewManager = function(){};"]}, {"lines": ["            var useragent = ace.require('ace/lib/useragent');"]}, {"lines": ["            var Range = ace.require('ace/range').Range;"]}, {"lines": ["            var Range = ace.require('ace/range').Range;"]}, {"lines": ["            focusNoScroll(inputArea);"]}, {"lines": ["            var Range = ace.require('ace/range').Range;"]}, {"lines": ["//            var emptyTop = position.getTop(panels.input) - getDocScrollTop();"]}, {"lines": ["//            setPanelScrollTops();", "//", "//            if (isFirstTimeFilled) {", "//                isFirstTimeFilled = false;", "//                return;", "//            }", "//", "//            var fullTop = position.getTop(panels.input) - getDocScrollTop();", "//", "//            if (uaSniffed.isIE) {", "//                setTimeout(function () {", "//                    window.scrollBy(0, fullTop - emptyTop);", "//                }, 0);", "//            }", "//            else {", "//                window.scrollBy(0, fullTop - emptyTop);", "//            }"]}, {"lines": ["            focusNoScroll(input);"]}, {"lines": ["            focusNoScroll(inputBox);"]}, {"lines": ["                    focusNoScroll(inputBox);"]}, {"lines": ["<%def name=\"title()\">${node['title'] | n} Wiki</%def>"]}, {"lines": ["    <div class=\"panel-toggle col-sm-${'3' if 'menu' in panels_used else '1' | n}\">"]}, {"lines": ["        <!-- Menu with toggle normal -->"]}, {"lines": ["        </div>"]}, {"lines": ["        <!-- Menu with toggle collapsed -->"]}, {"lines": ["", "        <!-- Menu without toggle in XS size only -->"]}, {"lines": ["                <%include file=\"wiki/templates/toc.mako\"/>", "            </div>", "        </div>"]}, {"lines": [""]}, {"lines": ["    <div class=\"panel-expand col-sm-${'9' if 'menu' in panels_used else '11' | n}\">"]}, {"lines": ["        % if user['can_edit']:"]}, {"lines": ["            <div data-bind=\"with: $root.editVM.wikiEditor.viewModel\"", "                 data-osf-panel=\"Edit\""]}, {"lines": ["                 class=\"${'col-sm-{0}'.format(12 / num_columns) | n}\""]}, {"lines": ["                 style=\"${'' if 'edit' in panels_used else 'display: none' | n}\">"]}, {"lines": ["                    <div class=\"row\">", "                      <div class=\"col-md-6\">"]}, {"lines": ["                      </div>", "                        <div class=\"col-md-6\">"]}, {"lines": ["                          </div>", "                        </div>", "                        <div class=\"col-md-2\">", "                        </div>", "                    </div>", "                  </div>"]}, {"lines": ["                              <ul class=\"list-inline\" data-bind=\"foreach: activeUsers\" class=\"pull-right\">", "                                  <!-- ko ifnot: id === '${user_id}' -->", "                                      <li><a data-bind=\"attr: { href: url }\" >", "                                          <img data-container=\"body\" data-bind=\"attr: {src: gravatar}, tooltip: {title: name, placement: 'top'}\"", "                                               style=\"border: 1px solid black;\">", "                                      </a></li>", "                                  <!-- /ko -->", "                              </ul>"]}, {"lines": [""]}, {"lines": ["                                      data-bind=\"click: revertChanges\""]}, {"lines": ["                        <textarea name=\"content\" style=\"display: none;\""]}, {"lines": ["                </div>"]}, {"lines": ["            </div>"]}, {"lines": ["          % endif"]}, {"lines": [""]}, {"lines": ["          <div data-osf-panel=\"View\""]}, {"lines": ["               class=\"${'col-sm-{0}'.format(12 / num_columns) | n}\""]}, {"lines": ["               style=\"${'' if 'view' in panels_used else 'display: none' | n}\">"]}, {"lines": ["                    <div class=\"row\">", "                        <div class=\"col-sm-6\">"]}, {"lines": ["                        </div>", "                        <div class=\"col-sm-6\">"]}, {"lines": ["                        </div>", "                    </div>"]}, {"lines": ["                </div>"]}, {"lines": ["                </div>"]}, {"lines": ["          <div data-osf-panel=\"Compare\""]}, {"lines": ["               class=\"${'col-sm-{0}'.format(12 / num_columns) | n}\""]}, {"lines": ["               style=\"${'' if 'compare' in panels_used else 'display: none' | n}\">"]}, {"lines": ["            </div>"]}, {"lines": ["  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">"]}, {"lines": ["        <h3 class=\"modal-title\">The permissions for this page have changed</h3>"]}, {"lines": ["      </div>", "      <div class=\"modal-body\">", "        <p>Your browser should refresh shortly&hellip;</p>", "      </div>", "    </div>", "  </div>", "</div>", ""]}, {"lines": ["  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">"]}, {"lines": ["        <h3 class=\"modal-title\">The content of this wiki has been moved to a different page</h3>"]}, {"lines": ["      </div>", "      <div class=\"modal-body\">", "        <p>Your browser should refresh shortly&hellip;</p>", "      </div>", "    </div>", "  </div>", "</div>", ""]}, {"lines": ["  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <h3 class=\"modal-title\">This wiki page has been deleted</h3>", "      </div>", "      <div class=\"modal-body\">", "        <p>Press OK to return to the project wiki home page.</p>", "      </div>", "      <div class=\"modal-footer\">", "          <button type=\"button\" class=\"btn btn-primary\" data-dismiss=\"modal\">OK</button>", "      </div>", "    </div>", "  </div>", "</div>", ""]}, {"lines": ["<div class=\"modal fade\" id=\"connectedModal\" tabindex=\"-1\">", "  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>", "        <h3 class=\"modal-title\">Connected to the collaborative wiki</h3>", "      </div>", "      <div class=\"modal-body\">", "        <p>", "            This page is currently connected to the collaborative wiki. All edits made will be visible to"]}, {"lines": ["            contributors with write permission in real time. Changes will be stored"]}, {"lines": ["            but not published until you click the \"Save\" button.", "        </p>", "      </div>", "    </div>", "  </div>", "</div>", ""]}, {"lines": ["  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>"]}, {"lines": ["      </div>", "      <div class=\"modal-body\">", "        <p>"]}, {"lines": ["        </p>", "      </div>", "    </div>", "  </div>", "</div>", ""]}, {"lines": ["  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>"]}, {"lines": ["      </div>", "      <div class=\"modal-body\">", "        <p>"]}, {"lines": ["        </p>", "      </div>", "    </div>", "  </div>", "</div>", ""]}, {"lines": ["  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>"]}, {"lines": ["      </div>", "      <div class=\"modal-body\">", "        <p>"]}, {"lines": ["        </p>", "      </div>", "    </div>", "  </div>", "</div>", ""]}, {"lines": ["<%def name=\"javascript_bottom()\">"]}, {"lines": ["<% import json %>"]}, {"lines": ["${parent.javascript_bottom()}"]}, {"lines": [""]}, {"lines": ["    var canEdit = ${json.dumps(user['can_edit'])};"]}, {"lines": ["", "    var canEditPageName = canEdit && ${json.dumps(", "        wiki_id and wiki_name != 'home'"]}, {"lines": ["    )};", ""]}, {"lines": ["    window.contextVars = window.contextVars || {};", "    window.contextVars.wiki = {"]}, {"lines": ["        canEdit: canEdit,"]}, {"lines": ["        canEditPageName: canEditPageName,", "        usePythonRender: ${json.dumps(use_python_render)},"]}, {"lines": ["        versionSettings: ${json.dumps(version_settings) | n},"]}, {"lines": ["            draft: '${urls['api']['draft']}',"]}, {"lines": ["            rename: '${urls['api']['rename']}',"]}, {"lines": ["            page: '${urls['web']['page']}',"]}, {"lines": ["            base: '${urls['web']['base']}',"]}, {"lines": ["        metadata: {"]}, {"lines": ["            registration: true,"]}, {"lines": ["            docId: '${sharejs_uuid}',"]}, {"lines": ["            userId: '${user_id}',", "            userName: '${user_full_name}',"]}, {"lines": ["            userUrl: '${user_url}',", "            userGravatar: '${urls['gravatar']}'.replace('&amp;', '&')"]}, {"lines": ["        }", "    };"]}, {"lines": ["<script src=${\"/static/public/js/wiki-edit-page.js\" | webpack_asset}></script>"]}, {"lines": ["            <li data-toggle=\"tooltip\" title=\"New\" data-placement=\"right\" data-container=\"body\">"]}, {"lines": ["                <a id=\"openNewWiki\" href=\"#\" data-toggle=\"modal\" data-target=\"#newWiki\">"]}, {"lines": ["                </a>", "            </li>"]}, {"lines": ["                <li data-toggle=\"tooltip\" title=\"Delete\" data-placement=\"right\" data-container=\"body\">"]}, {"lines": ["                    <a href=\"#\" data-toggle=\"modal\" data-target=\"#deleteWiki\">"]}, {"lines": ["                    </a>", "                </li>"]}, {"lines": ["    <h4 class=\"node-category\">", "        <div class=\"row\">", "            <div class=\"col-xs-10\">", "                ${node['category'].title()} Wiki Pages", "            </div>", "            <div class=\"col-xs-2\">"]}, {"lines": ["                % if user['can_edit']:", "                    <a href=\"#\" data-toggle=\"modal\" data-target=\"#newWiki\">"]}, {"lines": ["                    </a>", "                % endif"]}, {"lines": ["            </div>", "        </div>", "    </h4>"]}, {"lines": ["                    ## NOTE: Do NOT use web_url_for here because we want to use the GUID urls for these links", "                    <a href=\"${urls['web']['home']}\">", "                        <div class=\"col-xs-12\">Home</div>", "                    </a>"]}, {"lines": ["                    <li ${'class=\"active\"' if page['name'] == wiki_name else '' | n}>", "                            <div class=\"row\">", "                                %if page['name'] == wiki_name and user['can_edit']:", "                                    <a href=\"${page['url']}\"><div class=\"col-xs-10\">${page['name']}</div></a>", "                                    <div class=\"col-xs-2\">", "                                        <a href=\"#\" data-toggle=\"modal\" data-target=\"#deleteWiki\">"]}, {"lines": ["                                        </a>", "                                    </div>", "                                % else:", "                                    <a href=\"${page['url']}\"><div class=\"col-xs-12\">${page['name']}</div></a>", "                                % endif"]}, {"lines": ["from copy import deepcopy"]}, {"lines": ["    UserFactory, NodeFactory, ProjectFactory, ApiKeyFactory,"]}, {"lines": ["from website.addons.wiki.exceptions import InvalidVersionError"]}, {"lines": ["from website.addons.wiki.utils import (", "    get_sharejs_uuid, generate_private_uuid, share_db, delete_share_doc,"]}, {"lines": ["    migrate_uuid, format_wiki_version,"]}, {"lines": [")"]}, {"lines": ["from website.addons.wiki.tests.config import EXAMPLE_DOCS, EXAMPLE_OPS"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home')"]}, {"lines": ["    def test_wiki_url_404_with_no_write_permission(self):", "        url = self.project.web_url_for('project_wiki_view', wname='somerandomid')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        res = self.app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 404)", "", "    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_wiki_deleted_404_with_no_write_permission(self, mock_sharejs):", "        self.project.update_node_wiki('funpage', 'Version 1', Auth(self.user))", "        self.project.save()", "        url = self.project.web_url_for('project_wiki_view', wname='funpage')", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "        delete_url = self.project.api_url_for('project_wiki_delete', wname='funpage')", "        self.app.delete(delete_url, auth=self.user.auth)", "        res = self.app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 404)", ""]}, {"lines": ["    def test_wiki_url_with_path_get_returns_200(self):", "        self.project.update_node_wiki('funpage', 'Version 1', Auth(self.user))", "        self.project.update_node_wiki('funpage', 'Version 2', Auth(self.user))", "        self.project.save()", "", "        url = self.project.web_url_for(", "            'project_wiki_view',", "            wname='funpage',"]}, {"lines": ["        ) + '?view&compare=1&edit'"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "", "    def test_wiki_url_with_edit_get_returns_404_with_no_write_permission(self):", "        self.project.update_node_wiki('funpage', 'Version 1', Auth(self.user))", "        self.project.update_node_wiki('funpage', 'Version 2', Auth(self.user))", "        self.project.save()", "", "        url = self.project.web_url_for(", "            'project_wiki_view',", "            wname='funpage',"]}, {"lines": ["            compare=1,"]}, {"lines": ["        )", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "", "        url = self.project.web_url_for(", "            'project_wiki_view',", "            wname='funpage',"]}, {"lines": ["        ) + '?edit'"]}, {"lines": ["        res = self.app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 403)", ""]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home')"]}, {"lines": ["    def test_wiki_draft_returns_200(self):"]}, {"lines": ["        url = self.project.api_url_for('wiki_page_draft', wname='somerandomid')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "", "    def test_wiki_content_returns_200(self):"]}, {"lines": ["        url = self.project.api_url_for('wiki_page_content', wname='somerandomid')", "        res = self.app.get(url, auth=self.user.auth)"]}, {"lines": ["    @mock.patch('website.addons.wiki.model.NodeWikiPage.rendered_before_update', new_callable=mock.PropertyMock)", "    def test_wiki_content_use_python_render(self, mock_rendered_before_update):", "        content = 'Some content'", "        self.project.update_node_wiki('somerandomid', content, Auth(self.user))", "        self.project.save()", "", "        mock_rendered_before_update.return_value = True", "        url = self.project.api_url_for('wiki_page_content', wname='somerandomid')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(content, res.json['wiki_content'])", "        assert_in(content, res.json['wiki_rendered'])", "", "        mock_rendered_before_update.return_value = False", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(content, res.json['wiki_content'])", "        assert_equal('', res.json['wiki_rendered'])", "", ""]}, {"lines": ["        url = component.web_url_for('project_wiki_view', wname='home')"]}, {"lines": ["            pointed_node.web_url_for('project_wiki_view', wname='home', _guid=True)"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home')"]}, {"lines": ["    def test_project_wiki_view_scope(self):", "        self.project.update_node_wiki('home', 'Version 1', Auth(self.user))", "        self.project.update_node_wiki('home', 'Version 2', Auth(self.user))", "        self.project.save()"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home', view=2)"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home', view=3)"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 400)"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home', view=0)"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 400)"]}, {"lines": ["", "    def test_project_wiki_compare_returns_200(self):", "        self.project.update_node_wiki('home', 'updated content', Auth(self.user))", "        self.project.save()"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home') + '?compare'"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "", "    def test_project_wiki_compare_scope(self):", "        self.project.update_node_wiki('home', 'Version 1', Auth(self.user))", "        self.project.update_node_wiki('home', 'Version 2', Auth(self.user))", "        self.project.save()"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home', compare=2)"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home', compare=3)"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 400)"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='home', compare=0)"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 400)"]}, {"lines": [""]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname='cupcake ')"]}, {"lines": ["        # page_url = self.project.api_url_for('project_wiki_view', wname='home')"]}, {"lines": ["        page_url = self.project.web_url_for('project_wiki_view', wname='home', _guid=True)"]}, {"lines": ["        page_url = self.project.web_url_for('project_wiki_view', wname=page.page_name, _guid=True)"]}, {"lines": ["    def test_wiki_widget_no_content(self):", "        url = self.project.api_url_for('wiki_widget', wid='home')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_is_none(res.json['wiki_content'])", "", "    def test_wiki_widget_short_content_no_cutoff(self):", "        short_content = 'a' * 150", "        self.project.update_node_wiki('home', short_content, Auth(self.user))", "        url = self.project.api_url_for('wiki_widget', wid='home')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_in(short_content, res.json['wiki_content'])", "        assert_not_in('...', res.json['wiki_content'])", "        assert_false(res.json['more'])", "", "    def test_wiki_widget_long_content_cutoff(self):", "        long_content = 'a' * 600", "        self.project.update_node_wiki('home', long_content, Auth(self.user))", "        url = self.project.api_url_for('wiki_widget', wid='home')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_less(len(res.json['wiki_content']), 520)  # wiggle room for closing tags", "        assert_in('...', res.json['wiki_content'])", "        assert_true(res.json['more'])", "", "    @mock.patch('website.addons.wiki.model.NodeWikiPage.rendered_before_update', new_callable=mock.PropertyMock)", "    def test_wiki_widget_use_python_render(self, mock_rendered_before_update):", "        # New pages use js renderer", "        mock_rendered_before_update.return_value = False", "        self.project.update_node_wiki('home', 'updated content', Auth(self.user))", "        url = self.project.api_url_for('wiki_widget', wid='home')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_false(res.json['use_python_render'])", "", "        # Old pages use python renderer", "        mock_rendered_before_update.return_value = True", "        res = self.app.get(url, auth=self.user.auth)", "        assert_true(res.json['use_python_render'])", ""]}, {"lines": ["    def test_read_only_users_cannot_view_edit_pane(self):", "        url = self.project.web_url_for('project_wiki_view', wname='home')", "        # No write permissions", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "        assert_not_in('data-osf-panel=\"Edit\"', res.text)", "        # Write permissions", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_in('data-osf-panel=\"Edit\"', res.text)", ""]}, {"lines": ["        assert_equal(urls['base'], self.project.web_url_for('project_wiki_home', _guid=True))"]}, {"lines": ["        assert_equal(urls['edit'], self.project.web_url_for('project_wiki_view', wname=self.wname, _guid=True))"]}, {"lines": ["        assert_equal(urls['page'], self.project.web_url_for('project_wiki_view', wname=self.wname, _guid=True))"]}, {"lines": ["        assert_equal(urls['base'], self.project.api_url_for('project_wiki_home'))"]}, {"lines": ["        assert_equal(urls['content'], self.project.api_url_for('wiki_page_content', wname=self.wname))"]}, {"lines": ["            project.web_url_for('project_wiki_view', wname='wiki2'),"]}, {"lines": ["class TestWikiUuid(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        super(TestWikiUuid, self).setUp()"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.project = ProjectFactory(is_public=True, creator=self.user)"]}, {"lines": ["        self.wname = 'foo.bar'", "        self.wkey = to_mongo_key(self.wname)"]}, {"lines": [""]}, {"lines": ["    def test_uuid_generated_once(self):"]}, {"lines": ["        assert_is_none(self.project.wiki_private_uuids.get(self.wkey))"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname=self.wname)"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "", "        self.project.reload()"]}, {"lines": ["        private_uuid = self.project.wiki_private_uuids.get(self.wkey)", "        assert_true(private_uuid)", "        assert_not_in(private_uuid, res.body)", "        assert_in(get_sharejs_uuid(self.project, self.wname), res.body)"]}, {"lines": [""]}, {"lines": ["        # Revisit page; uuid has not changed", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["        assert_equal(private_uuid, self.project.wiki_private_uuids.get(self.wkey))"]}, {"lines": [""]}, {"lines": ["    def test_uuid_not_visible_without_write_permission(self):", "        self.project.update_node_wiki(self.wname, 'some content', Auth(self.user))", "        self.project.save()", "", "        assert_is_none(self.project.wiki_private_uuids.get(self.wkey))", "        url = self.project.web_url_for('project_wiki_view', wname=self.wname)", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "", "        self.project.reload()", "        private_uuid = self.project.wiki_private_uuids.get(self.wkey)", "        assert_true(private_uuid)", "        assert_not_in(private_uuid, res.body)", "        assert_in(get_sharejs_uuid(self.project, self.wname), res.body)", "", "        # Users without write permission should not be able to access", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "        assert_not_in(get_sharejs_uuid(self.project, self.wname), res.body)", "", "    def test_uuid_not_generated_without_write_permission(self):", "        self.project.update_node_wiki(self.wname, 'some content', Auth(self.user))", "        self.project.save()", "", "        assert_is_none(self.project.wiki_private_uuids.get(self.wkey))", "        url = self.project.web_url_for('project_wiki_view', wname=self.wname)", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "", "        self.project.reload()", "        private_uuid = self.project.wiki_private_uuids.get(self.wkey)", "        assert_is_none(private_uuid)", ""]}, {"lines": ["    def test_uuids_differ_between_pages(self):"]}, {"lines": ["        wname1 = 'foo.bar'"]}, {"lines": ["        url1 = self.project.web_url_for('project_wiki_view', wname=wname1)"]}, {"lines": ["        res1 = self.app.get(url1, auth=self.user.auth)", "        assert_equal(res1.status_code, 200)", ""]}, {"lines": ["        wname2 = 'bar.baz'"]}, {"lines": ["        url2 = self.project.web_url_for('project_wiki_view', wname=wname2)"]}, {"lines": ["        res2 = self.app.get(url2, auth=self.user.auth)", "        assert_equal(res2.status_code, 200)", "", "        self.project.reload()"]}, {"lines": ["        uuid1 = get_sharejs_uuid(self.project, wname1)", "        uuid2 = get_sharejs_uuid(self.project, wname2)"]}, {"lines": [""]}, {"lines": ["        assert_not_equal(uuid1, uuid2)"]}, {"lines": ["        assert_in(uuid1, res1)", "        assert_in(uuid2, res2)", "        assert_not_in(uuid1, res2)", "        assert_not_in(uuid2, res1)"]}, {"lines": [""]}, {"lines": ["    def test_uuids_differ_between_forks(self):"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_view', wname=self.wname)"]}, {"lines": ["        project_res = self.app.get(url, auth=self.user.auth)", "        assert_equal(project_res.status_code, 200)", "        self.project.reload()", "", "        fork = self.project.fork_node(Auth(self.user))", "        assert_true(fork.is_fork_of(self.project))"]}, {"lines": ["        fork_url = fork.web_url_for('project_wiki_view', wname=self.wname)"]}, {"lines": ["        fork_res = self.app.get(fork_url, auth=self.user.auth)", "        assert_equal(fork_res.status_code, 200)", "        fork.reload()", "", "        # uuids are stored the same internally", "        assert_equal("]}, {"lines": ["            self.project.wiki_private_uuids.get(self.wkey),", "            fork.wiki_private_uuids.get(self.wkey)"]}, {"lines": ["        )", ""]}, {"lines": ["        project_uuid = get_sharejs_uuid(self.project, self.wname)", "        fork_uuid = get_sharejs_uuid(fork, self.wname)"]}, {"lines": ["", "        assert_not_equal(project_uuid, fork_uuid)", "        assert_in(project_uuid, project_res)", "        assert_in(fork_uuid, fork_res)", "        assert_not_in(project_uuid, fork_res)", "        assert_not_in(fork_uuid, project_res)", ""]}, {"lines": ["        original_uuid = generate_private_uuid(self.project, self.wname)"]}, {"lines": ["        self.project.update_node_wiki(self.wname, 'Hello world', Auth(self.user))", "        fork = self.project.fork_node(Auth(self.user))"]}, {"lines": ["        assert_equal(original_uuid, fork.wiki_private_uuids.get(self.wkey))"]}, {"lines": [""]}, {"lines": ["        migrate_uuid(self.project, self.wname)"]}, {"lines": [""]}, {"lines": ["        assert_not_equal(original_uuid, self.project.wiki_private_uuids.get(self.wkey))", "        assert_equal(original_uuid, fork.wiki_private_uuids.get(self.wkey))"]}, {"lines": [""]}, {"lines": ["        assert_is_none(self.project.wiki_private_uuids.get(self.wkey))"]}, {"lines": [""]}, {"lines": ["        # Create wiki page"]}, {"lines": ["        self.project.update_node_wiki(self.wname, 'Hello world', Auth(self.user))"]}, {"lines": [""]}, {"lines": ["        # Visit wiki edit page"]}, {"lines": ["        edit_url = self.project.web_url_for('project_wiki_view', wname=self.wname)"]}, {"lines": ["        res = self.app.get(edit_url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["        original_private_uuid = self.project.wiki_private_uuids.get(self.wkey)", "        original_sharejs_uuid = get_sharejs_uuid(self.project, self.wname)"]}, {"lines": ["", "        # Delete wiki"]}, {"lines": ["        delete_url = self.project.api_url_for('project_wiki_delete', wname=self.wname)"]}, {"lines": ["        res = self.app.delete(delete_url, auth=self.user.auth)"]}, {"lines": ["        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["        assert_equal(original_private_uuid, self.project.wiki_private_uuids.get(self.wkey))"]}, {"lines": ["", "        # Revisit wiki edit page", "        res = self.app.get(edit_url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["        assert_equal(original_private_uuid, self.project.wiki_private_uuids.get(self.wkey))", "        assert_in(original_sharejs_uuid, res.body)"]}, {"lines": [""]}, {"lines": ["        new_wname = 'bar.baz'", "        new_wkey = to_mongo_key(new_wname)"]}, {"lines": ["        assert_is_none(self.project.wiki_private_uuids.get(self.wkey))", "        assert_is_none(self.project.wiki_private_uuids.get(new_wkey))"]}, {"lines": ["", "        # Create wiki page"]}, {"lines": ["        self.project.update_node_wiki(self.wname, 'Hello world', Auth(self.user))", "        wiki_page = self.project.get_wiki_page(self.wname)"]}, {"lines": ["", "        # Visit wiki edit page"]}, {"lines": ["        original_edit_url = self.project.web_url_for('project_wiki_view', wname=self.wname)"]}, {"lines": ["        res = self.app.get(original_edit_url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["        original_private_uuid = self.project.wiki_private_uuids.get(self.wkey)", "        original_sharejs_uuid = get_sharejs_uuid(self.project, self.wname)"]}, {"lines": ["", "        # Rename wiki"]}, {"lines": ["        rename_url = self.project.api_url_for('project_wiki_rename', wname=self.wname)"]}, {"lines": ["        res = self.app.put_json(", "            rename_url,"]}, {"lines": ["            {'value': new_wname, 'pk': wiki_page._id},"]}, {"lines": ["            auth=self.user.auth,", "        )", "        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["        assert_is_none(self.project.wiki_private_uuids.get(self.wkey))", "        assert_equal(original_private_uuid, self.project.wiki_private_uuids.get(new_wkey))"]}, {"lines": ["", "        # Revisit original wiki edit page", "        res = self.app.get(original_edit_url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["        assert_not_equal(original_private_uuid, self.project.wiki_private_uuids.get(self.wkey))", "        assert_not_in(original_sharejs_uuid, res.body)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestWikiShareJSMongo(OsfTestCase):", ""]}, {"lines": ["    @classmethod", "    def setUpClass(cls):", "        super(TestWikiShareJSMongo, cls).setUpClass()", "        cls._original_sharejs_db_name = settings.SHAREJS_DB_NAME", "        settings.SHAREJS_DB_NAME = 'sharejs_test'", ""]}, {"lines": ["    def setUp(self):", "        super(TestWikiShareJSMongo, self).setUp()", "        self.user = AuthUserFactory()", "        self.project = ProjectFactory(is_public=True, creator=self.user)"]}, {"lines": ["        self.wname = 'foo.bar'", "        self.wkey = to_mongo_key(self.wname)"]}, {"lines": ["        self.private_uuid = generate_private_uuid(self.project, self.wname)", "        self.sharejs_uuid = get_sharejs_uuid(self.project, self.wname)"]}, {"lines": [""]}, {"lines": ["        # Create wiki page"]}, {"lines": ["        self.project.update_node_wiki(self.wname, 'Hello world', Auth(self.user))", "        self.wiki_page = self.project.get_wiki_page(self.wname)"]}, {"lines": [""]}, {"lines": ["        # Insert mongo data for current project/wiki", "        self.db = share_db()"]}, {"lines": ["        example_uuid = EXAMPLE_DOCS[0]['_id']", "        self.example_docs = deepcopy(EXAMPLE_DOCS)"]}, {"lines": ["        self.example_docs[0]['_id'] = self.sharejs_uuid"]}, {"lines": ["        self.db.docs.insert(self.example_docs)", "        self.example_ops = deepcopy(EXAMPLE_OPS)", "        for item in self.example_ops:"]}, {"lines": ["            item['_id'] = item['_id'].replace(example_uuid, self.sharejs_uuid)", "            item['name'] = item['name'].replace(example_uuid, self.sharejs_uuid)"]}, {"lines": ["        self.db.docs_ops.insert(self.example_ops)"]}, {"lines": [""]}, {"lines": ["        migrate_uuid(self.project, self.wname)"]}, {"lines": ["        assert_is_none(self.db.docs.find_one({'_id': self.sharejs_uuid}))", "        assert_is_none(self.db.docs_ops.find_one({'name': self.sharejs_uuid}))"]}, {"lines": [""]}, {"lines": ["        new_sharejs_uuid = get_sharejs_uuid(self.project, self.wname)"]}, {"lines": ["        assert_equal("]}, {"lines": ["            EXAMPLE_DOCS[0]['_data'],"]}, {"lines": ["            self.db.docs.find_one({'_id': new_sharejs_uuid})['_data']"]}, {"lines": ["        )", "        assert_equal("]}, {"lines": ["            len([item for item in self.example_ops if item['name'] == self.sharejs_uuid]),", "            len([item for item in self.db.docs_ops.find({'name': new_sharejs_uuid})])"]}, {"lines": ["        )", ""]}, {"lines": ["        # Case where no edits have been made to the wiki", "        wname = 'bar.baz'", "        wkey = to_mongo_key(wname)"]}, {"lines": ["        share_uuid = generate_private_uuid(self.project, wname)", "        sharejs_uuid = get_sharejs_uuid(self.project, wname)"]}, {"lines": ["", "        self.project.update_node_wiki(wname, 'Hello world', Auth(self.user))", "        wiki_page = self.project.get_wiki_page(wname)"]}, {"lines": ["        migrate_uuid(self.project, wname)"]}, {"lines": [""]}, {"lines": ["        assert_not_equal(share_uuid, self.project.wiki_private_uuids.get(wkey))", "        assert_is_none(self.db.docs.find_one({'_id': sharejs_uuid}))", "        assert_is_none(self.db.docs_ops.find_one({'name': sharejs_uuid}))"]}, {"lines": [""]}, {"lines": ["        migrate_uuid(self.project, self.wname)", "        assert_not_equal(self.private_uuid, self.project.wiki_private_uuids[self.wkey])", "", "    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_manage_contributors_updates_uuid(self, mock_sharejs):", "        user = UserFactory()", "        self.project.add_contributor(", "            contributor=user,", "            permissions=['read', 'write', 'admin'],", "            auth=Auth(user=self.user),", "        )", "        self.project.save()", "        assert_equal(self.private_uuid, self.project.wiki_private_uuids[self.wkey])", "        # Removing admin permission does nothing", "        self.project.manage_contributors(", "            user_dicts=[", "                {'id': user._id, 'permission': 'write', 'visible': True},", "                {'id': self.user._id, 'permission': 'admin', 'visible': True},", "            ],", "            auth=Auth(user=self.user),", "            save=True,", "        )"]}, {"lines": ["        assert_equal(self.private_uuid, self.project.wiki_private_uuids[self.wkey])"]}, {"lines": ["        # Removing write permission migrates uuid", "        self.project.manage_contributors(", "            user_dicts=[", "                {'id': user._id, 'permission': 'read', 'visible': True},", "                {'id': self.user._id, 'permission': 'admin', 'visible': True},", "            ],", "            auth=Auth(user=self.user),", "            save=True,", "        )"]}, {"lines": ["        assert_not_equal(self.private_uuid, self.project.wiki_private_uuids[self.wkey])"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        delete_share_doc(self.project, self.wname)"]}, {"lines": ["        assert_is_none(self.db.docs.find_one({'_id': self.sharejs_uuid}))", "        assert_is_none(self.db.docs_ops.find_one({'name': self.sharejs_uuid}))"]}, {"lines": [""]}, {"lines": ["        assert_equal(self.private_uuid, self.project.wiki_private_uuids[self.wkey])"]}, {"lines": ["        delete_share_doc(self.project, self.wname)"]}, {"lines": ["        assert_not_in(self.wkey, self.project.wiki_private_uuids)"]}, {"lines": [""]}, {"lines": ["    def tearDown(self):", "        super(TestWikiShareJSMongo, self).tearDown()"]}, {"lines": ["        self.db.drop_collection('docs')", "        self.db.drop_collection('docs_ops')"]}, {"lines": [""]}, {"lines": ["    @classmethod", "    def tearDownClass(cls):", "        share_db().connection.drop_database(settings.SHAREJS_DB_NAME)", "        settings.SHARE_DATABASE_NAME = cls._original_sharejs_db_name", ""]}, {"lines": [""]}, {"lines": ["class TestWikiUtils(OsfTestCase):", "", "    def setUp(self):", "        super(TestWikiUtils, self).setUp()", "        self.project = ProjectFactory()", ""]}, {"lines": ["    def test_get_sharejs_uuid(self):"]}, {"lines": ["        wname = 'foo.bar'", "        wname2 = 'bar.baz'"]}, {"lines": ["        private_uuid = generate_private_uuid(self.project, wname)", "        sharejs_uuid = get_sharejs_uuid(self.project, wname)"]}, {"lines": ["", "        # Provides consistent results"]}, {"lines": ["        assert_equal(sharejs_uuid, get_sharejs_uuid(self.project, wname))"]}, {"lines": ["", "        # Provides obfuscation"]}, {"lines": ["        assert_not_in(wname, sharejs_uuid)", "        assert_not_in(sharejs_uuid, wname)", "        assert_not_in(private_uuid, sharejs_uuid)", "        assert_not_in(sharejs_uuid, private_uuid)"]}, {"lines": ["", "        # Differs based on share uuid provided"]}, {"lines": ["        assert_not_equal(sharejs_uuid, get_sharejs_uuid(self.project, wname2))"]}, {"lines": ["", "        # Differs across projects and forks", "        project = ProjectFactory()"]}, {"lines": ["        assert_not_equal(sharejs_uuid, get_sharejs_uuid(project, wname))"]}, {"lines": ["        fork = self.project.fork_node(Auth(self.project.creator))"]}, {"lines": ["        assert_not_equal(sharejs_uuid, get_sharejs_uuid(fork, wname))"]}, {"lines": ["", "    def test_generate_share_uuid(self):"]}, {"lines": ["        wname = 'bar.baz'"]}, {"lines": ["        wkey = to_mongo_key(wname)"]}, {"lines": ["        assert_is_none(self.project.wiki_private_uuids.get(wkey))", "        share_uuid = generate_private_uuid(self.project, wname)"]}, {"lines": ["        self.project.reload()"]}, {"lines": ["        assert_equal(self.project.wiki_private_uuids[wkey], share_uuid)"]}, {"lines": [""]}, {"lines": ["        new_uuid = generate_private_uuid(self.project, wname)"]}, {"lines": ["        self.project.reload()", "        assert_not_equal(share_uuid, new_uuid)"]}, {"lines": ["        assert_equal(self.project.wiki_private_uuids[wkey], new_uuid)"]}, {"lines": ["", "    def test_format_wiki_version(self):", "        assert_is_none(format_wiki_version(None, 5, False))", "        assert_is_none(format_wiki_version('', 5, False))", "        assert_equal(format_wiki_version('3', 5, False), 3)", "        assert_equal(format_wiki_version('4', 5, False), 'previous')", "        assert_equal(format_wiki_version('5', 5, False), 'current')", "        assert_equal(format_wiki_version('previous', 5, False), 'previous')", "        assert_equal(format_wiki_version('current', 5, False), 'current')", "        assert_equal(format_wiki_version('preview', 5, True), 'preview')", "        assert_equal(format_wiki_version('current', 0, False), 'current')", "        assert_equal(format_wiki_version('preview', 0, True), 'preview')", ""]}, {"lines": ["        with assert_raises(InvalidVersionError):"]}, {"lines": ["            format_wiki_version('1', 0, False)"]}, {"lines": ["        with assert_raises(InvalidVersionError):"]}, {"lines": ["            format_wiki_version('previous', 0, False)"]}, {"lines": ["        with assert_raises(InvalidVersionError):"]}, {"lines": ["            format_wiki_version('6', 5, False)"]}, {"lines": ["        with assert_raises(InvalidVersionError):"]}, {"lines": ["            format_wiki_version('0', 5, False)"]}, {"lines": ["        with assert_raises(InvalidVersionError):"]}, {"lines": ["            format_wiki_version('preview', 5, False)"]}, {"lines": ["        with assert_raises(InvalidVersionError):"]}, {"lines": ["            format_wiki_version('nonsense', 5, True)"]}, {"lines": [""]}, {"lines": ["from framework.transactions.handlers import no_auto_transaction"]}, {"lines": ["@no_auto_transaction"]}, {"lines": ["CORE_TEMPLATES = os.path.join(BASE_PATH, 'templates/log_templates.mako')", "BUILT_TEMPLATES = os.path.join(BASE_PATH, 'templates/_log_templates.mako')"]}, {"lines": ["DB_HOST = 'localhost'"]}, {"lines": ["    } else if (file.provider === 'dataverse') {"]}, {"lines": ["        // Only highlight file in correct dataset version, since paths persist across versions"]}, {"lines": ["            var urlParams = $osf.urlParams();"]}, {"lines": ["                tb.currentFileID = child.id;", "            }", "        }"]}, {"lines": ["var hljs = require('highlight.js');", "require('highlight-css');"]}, {"lines": ["var MarkdownIt = require('markdown-it');", ""]}, {"lines": ["        if (lang && hljs.getLanguage(lang)) {", "            try {", "                return hljs.highlight(lang, str).value;", "            } catch (__) {}", "        }", "", "        try {", "            return hljs.highlightAuto(str).value;", "        } catch (__) {}", "", "        return ''; // use external default escaping"]}, {"lines": ["    };", "", "// Full markdown renderer for views / wiki pages / pauses between typing", "var markdown = new MarkdownIt('commonmark', {", "    highlight: highlighter"]}, {"lines": ["})"]}, {"lines": ["    .use(require('markdown-it-video'))"]}, {"lines": [""]}, {"lines": ["", "// Fast markdown renderer for active editing to prevent slow loading/rendering tasks"]}, {"lines": ["    .use(require('markdown-it-sanitizer'))"]}, {"lines": [""]}, {"lines": ["module.exports = {", "    full: markdown,"]}, {"lines": ["};"]}, {"lines": ["            authInvalid: 'Your Dataverse API token is invalid.',"]}, {"lines": ["            datasetDeaccessioned: 'This dataset has already been deaccessioned on the Dataverse ' +"]}, {"lines": ["            forbiddenCharacters: 'This dataset cannot be connected due to forbidden characters ' +", "                'in one or more of the dataset\\'s file names. This issue has been forwarded to our ' +"]}, {"lines": ["            setDatasetError: 'Could not connect to this dataset.',"]}, {"lines": ["require('truncate');", ""]}, {"lines": ["    // Wiki widget markdown rendering", "    if (ctx.wikiWidget) {", "        // Render math in the wiki widget"]}, {"lines": ["        mathrender.mathjaxify(markdownElement);", "", "        // Render the raw markdown of the wiki", "        if (!ctx.usePythonRender) {", "            var request = $.ajax({"]}, {"lines": ["            });", "            request.done(function(resp) {", "                var rawText = resp.wiki_content || '*No wiki content*';", "                var renderedText = md.render(rawText);", "                var truncatedText = $.truncate(renderedText, {length: 400});", "                markdownElement.html(truncatedText);", "                mathrender.mathjaxify(markdownElement);", "            });", "        }"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["var $ = require('jquery');", "var Raven = require('raven-js');"]}, {"lines": ["require('bootstrap-editable');"]}, {"lines": ["require('osf-panel');"]}, {"lines": [""]}, {"lines": ["var ctx = window.contextVars.wiki;  // mako context variables"]}, {"lines": [""]}, {"lines": ["var menuVisible = (ctx.panelsUsed.indexOf('menu') !== -1);"]}, {"lines": [""]}, {"lines": ["var viewVersion = ctx.versionSettings.view || (editable ? 'preview' : 'current');", "var compareVersion = ctx.versionSettings.compare || 'previous';", ""]}, {"lines": ["    menuVisible: menuVisible,"]}, {"lines": ["    viewVersion: viewVersion,", "    compareVersion: compareVersion,"]}, {"lines": ["    urls: ctx.urls,"]}, {"lines": [""]}, {"lines": ["", "// Edit wiki page name"]}, {"lines": ["if (ctx.canEditPageName) {", "    // Initialize editable wiki page name", "    var $pageName = $('#pageName');", "    $.fn.editable.defaults.mode = 'inline';", "    $pageName.editable({", "        type: 'text',", "        send: 'always',", "        url: ctx.urls.rename,", "        ajaxOptions: {", "            type: 'put',", "            contentType: 'application/json',", "            dataType: 'json'", "        },", "        validate: function(value) {", "            if($.trim(value) === ''){", "                return 'The wiki page name cannot be empty.';", "            } else if(value.length > 100){", "                return 'The wiki page name cannot be more than 100 characters.';", "            }", "        },", "        params: function(params) {", "            return JSON.stringify(params);", "        },", "        success: function(response, value) {", "            window.location.href = ctx.urls.base + encodeURIComponent(value) + '/';", "        },", "        error: function(response) {", "            var msg = response.responseJSON.message_long;", "            if (msg) {", "                return msg;", "            } else {", "                // Log unexpected error with Raven", "                Raven.captureMessage('Error in renaming wiki', {", "                    url: ctx.urls.rename,", "                    responseText: response.responseText,", "                    statusText: response.statusText", "                });", "                return 'An unexpected error occurred. Please try again.';", "            }", "        }", "    });"]}, {"lines": ["}", "", "// Apply panels", "$(document).ready(function () {"]}, {"lines": ["    var bodyElement = $('body');", ""]}, {"lines": ["    $('*[data-osf-panel]').osfPanel({", "        buttonElement : '.switch',"]}, {"lines": ["            // this = all the column elements; an array"]}, {"lines": ["            // col = the $() for the column this button links to"]}, {"lines": ["            // Determine if any columns are visible", "            var visibleColumns = this.filter(function (i, element) {", "                return $(element).is(':visible');", "            });"]}, {"lines": ["            if (visibleColumns.length === 0) {", "                thisbtn.click();", "                return;", "            }"]}, {"lines": ["            bodyElement.trigger('togglePanel', ["]}, {"lines": ["                title.toLowerCase(),"]}, {"lines": ["            ]);"]}, {"lines": ["    });"]}, {"lines": ["    $('.panel-collapse').on('click', function () {", "        var el = $(this).closest('.panel-toggle');"]}, {"lines": ["        panelToggle.removeClass('col-sm-3').addClass('col-sm-1');", "        panelExpand.removeClass('col-sm-9').addClass('col-sm-11');"]}, {"lines": ["", "        bodyElement.trigger('toggleMenu', [false]);"]}, {"lines": ["    });"]}, {"lines": ["        panelToggle.removeClass('col-sm-1').addClass('col-sm-3');", "        panelExpand.removeClass('col-sm-11').addClass('col-sm-9');"]}, {"lines": ["        bodyElement.trigger('toggleMenu', [true]);"]}, {"lines": ["    });"]}, {"lines": ["", "    // Tooltip"]}], "name": "rliebz"}, {"commits": [{"lines": ["    'file-page': staticPath('js/pages/file-page.js'),"]}, {"lines": ["            {test: /\\.ttf/, loader: 'file-loader'},", "            //Dirty hack because mime-type's json file is \"special\"", "            {test: /db.json/, loader: 'json-loader'},"]}, {"lines": ["import logging", "from website.app import init_app", "from website.addons.box.model import BoxFile", "from scripts import utils as scripts_utils"]}, {"lines": ["from framework.transactions.context import TokuTransaction"]}, {"lines": ["", "", "logger = logging.getLogger(__name__)", "", "", "def main():"]}, {"lines": ["    with TokuTransaction():", "        for file in BoxFile.find():", "            new_path = '/' + file.path.split('/')[1]", "            logger.info(u'{} -> {}'.format(file.path, new_path))", "            file.path = new_path", "            file.save()"]}, {"lines": ["", "", "if __name__ == '__main__':", "    scripts_utils.add_file_logger(logger, __file__)", "    init_app(set_backends=True, routes=False)", "    main()"]}, {"lines": ["    init_app(set_backend=True, routes=False)"]}, {"lines": ["    init_app(set_backends=True, routes=False)"]}, {"lines": ["    init_app(set_backends=True, routes=False)"]}, {"lines": ["    init_app(set_backends=True, routes=False)  # Sets the storage backends on all models"]}, {"lines": ["    main(dry=dry)"]}, {"lines": ["    init_app(routes=False, set_backends=True)"]}, {"lines": ["import logging", "from modularodm import Q", "from website.app import init_app", "from website.addons.osfstorage.model import OsfStorageFileNode", "from scripts import utils as scripts_utils"]}, {"lines": ["from framework.transactions.context import TokuTransaction"]}, {"lines": ["", "", "logger = logging.getLogger(__name__)", "", "", "def main():"]}, {"lines": ["    with TokuTransaction():", "        for file in OsfStorageFileNode.find(Q('is_deleted', 'eq', True)):"]}, {"lines": ["            file.delete(recurse=False)"]}, {"lines": ["            logger.info(u'Moving {!r} to the trashed collections'.format(file))"]}, {"lines": ["", "", "if __name__ == '__main__':", "    scripts_utils.add_file_logger(logger, __file__)", "    init_app(set_backends=True, routes=False)", "    main()"]}, {"lines": ["from __future__ import division", "from __future__ import unicode_literals", ""]}, {"lines": ["import logging"]}, {"lines": ["", "from pymongo.errors import DuplicateKeyError", "", "from modularodm import Q", "from modularodm.storage.base import KeyExistsException", "", "from framework.mongo import database", "from framework.analytics import clean_page", "from framework.transactions.context import TokuTransaction", "", "from scripts import utils as scripts_utils", "", "from website.app import init_app", "from website.project.model import NodeLog", "from website.addons.osfstorage import model"]}, {"lines": ["from website.addons.osfstorage import oldels"]}, {"lines": ["", "logger = logging.getLogger(__name__)", "", ""]}, {"lines": ["    'osf_storage_file_added',", "    'osf_storage_file_updated',", "    'osf_storage_file_removed',", "    'osf_storage_file_restored',", "    'file_added',", "    'file_updated',", "    'file_removed',", "    'file_restored',"]}, {"lines": ["", "", "def migrate_download_counts(node, children, dry=True):", "    collection = database['pagecounters']", "    updates = []", "", "    for old_path, new in children.items():", "        if dry:"]}, {"lines": ["            # Note in dry mode new is None"]}, {"lines": ["            new_id = ':'.join(['download', node._id, 'new_id'])", "            old_id = ':'.join(['download', node._id, old_path])", "        else:", "            new_id = ':'.join(['download', node._id, new._id])", "            old_id = ':'.join(['download', node._id, old_path])", "", "        result = collection.find_one({'_id': clean_page(old_id)})", "", "        if not result:", "            continue", "", "        logger.info('Copying download counts of {!r} to {!r}'.format(old_path, new))", "", "        if not dry:", "            result['_id'] = new_id", "            updates.append(result)", "            # try:", "            #     # database.pagecounters.insert(result)", "            # except DuplicateKeyError:", "            #     logger.warn('Already migrated {!r}'.format(old_path))", "            #     continue", "        else:", "            continue", "", "        for idx in range(len(new.versions)):", "            result = collection.find_one({'_id': clean_page('{}:{}'.format(old_id, idx + 1))})", "            if not result:", "                continue", "", "            logger.info('Copying download count of version {} of {!r} to version {} of {!r}'.format(idx + 1, old_path, idx, new))", "            if not dry:", "                result['_id'] = '{}:{}'.format(new_id, idx)", "                updates.append(result)", "                # database.pagecounters.insert(result)", ""]}, {"lines": ["        if not dry:"]}, {"lines": ["            try:", "                database.pagecounters.insert(updates, continue_on_error=True)", "            except DuplicateKeyError:", "                pass", "", "def migrate_node_settings(node_settings, dry=True):", "    logger.info('Running `on add` for node settings of {}'.format(node_settings.owner._id))", "", "    if not dry:", "        node_settings.on_add()", "", "", "def migrate_file(node, old, parent, dry=True):"]}, {"lines": ["    assert isinstance(old, oldels.OsfStorageFileRecord)"]}, {"lines": ["    if not dry:", "        try:", "            new = parent.append_file(old.name)", "            logger.debug('Created new child {}'.format(old.name))", "        except KeyExistsException:", "            logger.warning('{!r} has already been migrated'.format(old))", "            return parent.find_child_by_name(old.name)", "        new.versions = old.versions", "        new.is_deleted = old.is_deleted", "        new.save()", "    else:", "        new = None", "    return new", ""]}, {"lines": ["def migrate_logs(node, children, dry=True):", "    for log in NodeLog.find(Q('params.node', 'eq', node._id)):", "        if log.action not in LOG_ACTIONS:", "            continue", ""]}, {"lines": ["        if log.params.get('_path') is not None and log.params.get('_urls'):"]}, {"lines": ["            logger.warning('Log for file {} has already been migrated'.format(log.params['path']))", "            continue", "", "        if dry:", "            logger.debug('{!r} {} -> {}'.format(log, log.params['path'], 'New path'))", "            continue", "", "        try:", "            new = children[log.params['path']]", "        except KeyError:", "            if not log.params['path'].startswith('/'):", "                logger.warning('Failed to migrate log with path {}'.format(log.params['path']))", "            continue", "", "        mpath = new.materialized_path()", "        url = '/{}/files/osfstorage/{}/'.format(node._id, new._id)", "        logger.debug('{!r} {} -> {}'.format(log, log.params['path'], mpath))", ""]}, {"lines": ["        log.params['_path'] = mpath", "        log.params['_urls'] = {"]}, {"lines": ["            'view': url,", "            'download': url + '?action=download'", "        }", "", "        log.save()", "", "    NodeLog._cache.clear()", "", ""]}, {"lines": ["        if guid._path is not None:", "            logger.warn('File guid {} has already been migrated'.format(guid._id))", "            continue", "", "        logger.info('Migrating file guid {}'.format(guid._id))", "        if not dry:", "            try:", "                guid._path = children[guid.path].path", "            except KeyError:", "                if not guid.path.startswith('/'):"]}, {"lines": ["                continue", "            guid.save()", "    model.OsfStorageGuidFile._cache.clear()", "", "", "def migrate_children(node_settings, dry=True):", "    if not node_settings.file_tree:", "        return logger.warning('Skipping node {}; file_tree is None'.format(node_settings.owner._id))", "", "    logger.info('Migrating children of node {}'.format(node_settings.owner._id))", "", "    children = {}", "    for x in node_settings.file_tree.children:", "        n = migrate_file(node_settings.owner, x, node_settings.root_node, dry=dry)", "        if n:  # not migrated yet", "            children[x.path] = n", "", "    migrate_logs(node_settings.owner, children, dry=dry)"]}, {"lines": ["    migrate_download_counts(node_settings.owner, children, dry=dry)", "    del children", "", ""]}, {"lines": ["    if not dry:", "        scripts_utils.add_file_logger(logger, __file__)", "        logger.info('Not running in dry mode, changes WILL be made')", "    else:", "        logger.info('Running in dry mode, changes NOT will be made')", ""]}, {"lines": ["    if to_migrate.count() == 0:", "        logger.info('No nodes to migrate; exiting...')", "        return", ""]}, {"lines": ["    failed = 0", "    logger.info('Found {} nodes to migrate'.format(to_migrate.count()))"]}, {"lines": ["", "    for node_settings in to_migrate:", "        if hash(node_settings._id) % nworkers != worker_id:", "            continue", "", "        try:", "            with TokuTransaction():", "                migrate_node_settings(node_settings, dry=dry)", "                migrate_children(node_settings, dry=dry)"]}, {"lines": ["        except Exception as error:", "            logger.error('Could not migrate file tree from {}'.format(node_settings.owner._id))", "            logger.exception(error)", "            failed += 1", ""]}, {"lines": ["    if failed > 0:", "        logger.error('Failed to migrate {} nodes'.format(failed))", "", "# Migrate file guids", "# db.osfstorageguidfile.update({"]}, {"lines": ["#   '_path': {'$ne': null}"]}, {"lines": ["# }, {", "#     $rename:{'path': 'premigration_path'}", "# }, {multi: true})", "", "# db.osfstorageguidfile.update({"]}, {"lines": ["#   '_path': {'$ne': null}"]}, {"lines": ["# }, {"]}, {"lines": ["#     $rename:{'_path': 'path'}"]}, {"lines": ["# }, {multi: true})", "", "", "# Migrate logs", "# db.nodelog.update({"]}, {"lines": ["#   'params._path': {'$ne': null}"]}, {"lines": ["# }, {", "#     $rename:{'params.path': 'params.premigration_path'}", "# }, {multi: true})", "", "# db.nodelog.update({"]}, {"lines": ["#   'params._path': {'$ne': null}"]}, {"lines": ["# }, {"]}, {"lines": ["#     $rename:{'params._path': 'params.path'}"]}, {"lines": ["# }, {multi: true})", "", "# db.nodelog.update({"]}, {"lines": ["#   'params._urls': {'$ne': null}"]}, {"lines": ["# }, {", "#     $rename:{'params.urls': 'params.premigration_urls'}", "# }, {multi: true})", "", "# db.nodelog.update({"]}, {"lines": ["#   'params._urls': {'$ne': null}"]}, {"lines": ["# }, {"]}, {"lines": ["#     $rename:{'params._urls': 'params.urls'}"]}, {"lines": ["# }, {multi: true})", "", "if __name__ == '__main__':", "    import sys", "", "    nworkers = int(sys.argv[1])", "    worker_id = int(sys.argv[2])", "", "    dry = 'dry' in sys.argv"]}, {"lines": ["", "    if 'debug' in sys.argv:", "        logger.setLevel(logging.DEBUG)", "    elif 'info' in sys.argv:", "        logger.setLevel(logging.INFO)", "    elif 'error' in sys.argv:", "        logger.setLevel(logging.ERROR)", "", "    init_app(set_backends=True, routes=False)"]}, {"lines": ["import time"]}, {"lines": ["import mock"]}, {"lines": ["from website.addons.github.exceptions import ApiError"]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["    def test_key_error_raises_attr_error_for_name(self):", "        class TestGuidFile(GuidFile):", "            pass", "", "        with assert_raises(AttributeError):", "            TestGuidFile().name", "", "    def test_getattrname_catches(self):", "        class TestGuidFile(GuidFile):", "            pass", "", "        assert_equals(getattr(TestGuidFile(), 'name', 'foo'), 'foo')", "", "    def test_getattrname(self):", "        class TestGuidFile(GuidFile):", "            pass", "", "        guid = TestGuidFile()", "        guid._metadata_cache = {'name': 'test'}", "", "        assert_equals(getattr(guid, 'name', 'foo'), 'test')", ""]}, {"lines": [""]}, {"lines": ["def assert_urls_equal(url1, url2):", "    furl1 = furl.furl(url1)", "    furl2 = furl.furl(url2)", "    for attr in ['scheme', 'host', 'port']:", "        setattr(furl1, attr, None)", "        setattr(furl2, attr, None)", "    assert_equal(furl1, furl2)", "", ""]}, {"lines": ["@mock.patch('website.addons.github.model.GitHub.repo', mock.Mock(side_effect=ApiError))"]}, {"lines": ["class TestAddonFileViews(OsfTestCase):", "", "    def setUp(self):", "        super(TestAddonFileViews, self).setUp()", "        self.user = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.user)"]}, {"lines": ["", "        self.user.add_addon('github')"]}, {"lines": ["        self.project.add_addon('github', auth=Auth(self.user))"]}, {"lines": ["", "        self.user_addon = self.user.get_addon('github')"]}, {"lines": ["        self.node_addon = self.project.get_addon('github')"]}, {"lines": ["        self.oauth = AddonGitHubOauthSettings(", "            github_user_id='denbarell',", "            oauth_access_token='Truthy'", "        )", "", "        self.oauth.save()", "", "        self.user_addon.oauth_settings = self.oauth", "        self.user_addon.save()", "", "        self.node_addon.user_settings = self.user_addon"]}, {"lines": ["        self.node_addon.repo = 'Truth'", "        self.node_addon.user = 'E'"]}, {"lines": ["        self.node_addon.save()", "", "        # self.node_addon.user_settings = 'Truthy'", "        # setattr(self.node_addon, 'has_auth', True)"]}, {"lines": ["", "    def get_mako_return(self):", "        ret = serialize_node(self.project, Auth(self.user), primary=True)", "        ret.update({"]}, {"lines": ["            'error': '',"]}, {"lines": ["            'provider': '',"]}, {"lines": ["            'file_path': '',"]}, {"lines": ["                'files': '',", "                'render': '',", "                'sharejs': '',", "                'mfr': '',", "                'gravatar': '',"]}, {"lines": ["            'size': '',"]}, {"lines": ["            'file_name': '',"]}, {"lines": ["            'materialized_path': '',"]}, {"lines": ["        })"]}, {"lines": ["        return ret", "", "    def test_redirects_to_guid(self):", "        path = 'bigdata'", "        guid, _ = self.node_addon.find_or_create_file_guid('/' + path)", "", "        resp = self.app.get(", "            self.project.web_url_for(", "                'addon_view_or_download_file',", "                path=path,", "                provider='github'", "            ),", "            auth=self.user.auth", "        )", "", "        assert_equals(resp.status_code, 302)", "        assert_equals(resp.headers['Location'], 'http://localhost:80{}'.format(guid.guid_url))", "", "    def test_action_download_redirects_to_download(self):", "        path = 'cloudfiles'", "        guid, _ = self.node_addon.find_or_create_file_guid('/' + path)", "", "        resp = self.app.get(guid.guid_url + '?action=download', auth=self.user.auth)", "", "        assert_equals(resp.status_code, 302)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.base.request')"]}, {"lines": ["        view_only = 'justworkplease'", "        mock_request.args = {", "            'view_only': view_only", "        }", "", "        path = 'cloudfiles'", "        guid, _ = self.node_addon.find_or_create_file_guid('/' + path)", ""]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.base.views.addon_view_file')", "    def test_action_view_calls_view_file(self, mock_view_file):", "        self.user.reload()", "        self.project.reload()", "", "        path = 'cloudfiles'", "        mock_view_file.return_value = self.get_mako_return()", "        guid, _ = self.node_addon.find_or_create_file_guid('/' + path)", "", "        self.app.get(guid.guid_url + '?action=view', auth=self.user.auth)", "", "        args, kwargs = mock_view_file.call_args", "        assert_equals(kwargs, {})"]}, {"lines": ["        assert_equals(args[1], self.project)", "        assert_equals(args[0].user, self.user)", "        assert_equals(args[2], self.node_addon)", "", "    @mock.patch('website.addons.base.views.addon_view_file')", "    def test_no_action_calls_view_file(self, mock_view_file):", "        self.user.reload()", "        self.project.reload()", "", "        path = 'cloudfiles'", "        mock_view_file.return_value = self.get_mako_return()", "        guid, _ = self.node_addon.find_or_create_file_guid('/' + path)", "", "        self.app.get(guid.guid_url, auth=self.user.auth)", "", "        args, kwargs = mock_view_file.call_args", "        assert_equals(kwargs, {})", "        assert_equals(args[-1], {})", "        assert_equals(args[1], self.project)", "        assert_equals(args[0].user, self.user)", "        assert_equals(args[2], self.node_addon)", "", "    def test_download_create_guid(self):", "        path = 'cloudfiles'", "", "        self.app.get(", "            self.project.web_url_for(", "                'addon_view_or_download_file',", "                path=path,", "                provider='github',", "                action='download'", "            ),", "            auth=self.user.auth", "        )", "", "        guid, created = self.node_addon.find_or_create_file_guid('/' + path)", "", "        assert_true(guid)", "        assert_false(created)", "        assert_equals(guid.waterbutler_path, '/' + path)", ""]}, {"lines": ["    def test_unauthorized_addons_raise(self):", "        path = 'cloudfiles'", "        self.node_addon.user_settings = None", "        self.node_addon.save()", "", "        resp = self.app.get(", "            self.project.web_url_for(", "                'addon_view_or_download_file',", "                path=path,", "                provider='github',", "                action='download'", "            ),", "            auth=self.user.auth,", "            expect_errors=True", "        )", ""]}, {"lines": ["        assert_equals(resp.status_code, 401)"]}, {"lines": [""]}, {"lines": ["    def test_head_returns_url(self):"]}, {"lines": ["        path = 'the little engine that couldnt'", "        guid, _ = self.node_addon.find_or_create_file_guid('/' + path)", ""]}, {"lines": ["        download_url = furl.furl(guid.download_url)", "        download_url.args['accept_url'] = 'false'"]}, {"lines": [""]}, {"lines": ["        resp = self.app.head(guid.guid_url, auth=self.user.auth)"]}, {"lines": [""]}, {"lines": ["        assert_urls_equal(resp.headers['Location'], download_url.url)"]}, {"lines": [""]}, {"lines": ["        path = 'cloudfiles'", "        self.project.delete_addon('github', Auth(self.user))", "        self.project.save()", "", "        resp = self.app.get("]}, {"lines": ["            self.project.web_url_for(", "                'addon_view_or_download_file',"]}, {"lines": ["                path=path,", "                provider='github',", "                action='download'", "            ),", "            auth=self.user.auth,", "            expect_errors=True", "        )", "", "        assert_equals(resp.status_code, 400)", "", "    def test_unauth_addons_raise(self):", "        path = 'cloudfiles'", "        self.node_addon.user_settings = None", "        self.node_addon.save()", "", "        resp = self.app.get("]}, {"lines": ["            self.project.web_url_for(", "                'addon_view_or_download_file',"]}, {"lines": ["                path=path,", "                provider='github',", "                action='download'", "            ),", "            auth=self.user.auth,", "            expect_errors=True", "        )", "", "        assert_equals(resp.status_code, 401)", ""]}, {"lines": ["class TestLegacyViews(OsfTestCase):", "", "    def setUp(self):", "        super(TestLegacyViews, self).setUp()", "        self.path = 'mercury.png'", "        self.user = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.user)"]}, {"lines": ["        file_record = self.node_addon.root_node.append_file(self.path)", "        self.expected_path = file_record._id"]}, {"lines": ["", "    def test_view_file_redirect(self):", "        url = '/{0}/osffiles/{1}/'.format(self.project._id, self.path)", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',", "            action='view',"]}, {"lines": ["            path=self.expected_path,"]}, {"lines": ["            provider='osfstorage',", "        )", "        assert_urls_equal(res.location, expected_url)", "", "    def test_download_file_redirect(self):", "        url = '/{0}/osffiles/{1}/download/'.format(self.project._id, self.path)", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',"]}, {"lines": ["            path=self.expected_path,"]}, {"lines": ["            action='download',", "            provider='osfstorage',", "        )", "        assert_urls_equal(res.location, expected_url)", "", "    def test_download_file_version_redirect(self):", "        url = '/{0}/osffiles/{1}/version/3/download/'.format(", "            self.project._id,", "            self.path,", "        )", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',", "            version=3,"]}, {"lines": ["            path=self.expected_path,"]}, {"lines": ["            action='download',", "            provider='osfstorage',", "        )", "        assert_urls_equal(res.location, expected_url)", "", "    def test_api_download_file_redirect(self):", "        url = '/api/v1/project/{0}/osffiles/{1}/'.format(self.project._id, self.path)", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',"]}, {"lines": ["            path=self.expected_path,"]}, {"lines": ["            action='download',", "            provider='osfstorage',", "        )", "        assert_urls_equal(res.location, expected_url)", "", "    def test_api_download_file_version_redirect(self):", "        url = '/api/v1/project/{0}/osffiles/{1}/version/3/'.format(", "            self.project._id,", "            self.path,", "        )", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',", "            version=3,"]}, {"lines": ["            path=self.expected_path,"]}, {"lines": ["            action='download',", "            provider='osfstorage',", "        )", "        assert_urls_equal(res.location, expected_url)", ""]}, {"lines": ["    def test_no_provider_name(self):", "        url = '/{0}/files/{1}'.format(", "            self.project._id,", "            self.path,", "        )", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',", "            action='view',"]}, {"lines": ["            path=self.expected_path,"]}, {"lines": ["            provider='osfstorage',", "        )", "        assert_urls_equal(res.location, expected_url)", ""]}, {"lines": ["    def test_action_as_param(self):", "        url = '/{}/osfstorage/files/{}/?action=download'.format(", "            self.project._id,", "            self.path,", "        )", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',"]}, {"lines": ["            path=self.expected_path,"]}, {"lines": ["            action='download',", "            provider='osfstorage',", "        )", "        assert_urls_equal(res.location, expected_url)", ""]}, {"lines": ["    def test_other_addon_redirect(self):", "        url = '/project/{0}/mycooladdon/files/{1}/'.format(", "            self.project._id,", "            self.path,", "        )", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',", "            action='view',", "            path=self.path,", "            provider='mycooladdon',", "        )", "        assert_urls_equal(res.location, expected_url)", "", "    def test_other_addon_redirect_download(self):", "        url = '/project/{0}/mycooladdon/files/{1}/download/'.format(", "            self.project._id,", "            self.path,", "        )", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 301)", "        expected_url = self.project.web_url_for(", "            'addon_view_or_download_file',", "            path=self.path,", "            action='download',", "            provider='mycooladdon',", "        )", "        assert_urls_equal(res.location, expected_url)"]}, {"lines": ["from website.util import web_url_for"]}, {"lines": ["    def test_has_private_link_key(self, mock_from_kwargs):"]}, {"lines": ["    def test_does_not_have_key(self, mock_from_kwargs):"]}, {"lines": ["        self.project.delete_addon('github', auth=None)"]}, {"lines": ["    @mock.patch('framework.auth.decorators.Auth.from_kwargs')"]}, {"lines": ["        mock_current_user.return_value = Auth(self.project.creator)"]}, {"lines": ["    @mock.patch('framework.auth.decorators.Auth.from_kwargs')"]}, {"lines": ["        mock_current_user.return_value = Auth(self.project.creator)", "        self.project.creator.delete_addon('github')"]}, {"lines": ["    @mock.patch('framework.auth.decorators.Auth.from_kwargs')"]}, {"lines": ["        mock_get_current_user.return_value = Auth(self.project.creator)"]}, {"lines": ["class TestBasicAuth(OsfTestCase):", "", "    def test_basic_auth_returns_403(self):", "        url = web_url_for('dashboard')", "        ret = self.app.get(url, auth=('test', 'test'), expect_errors=True)", "        assert_equal(ret.status_code, 403)", ""]}, {"lines": ["    @mock.patch('website.util.waterbutler_url_for')"]}, {"lines": ["    def test_upload(self, mock_put, mock_get_url):"]}, {"lines": ["            'upload',", "            'osfstorage',"]}, {"lines": ["            user=self.user,"]}, {"lines": ["    @mock.patch('website.util.waterbutler_url_for')"]}, {"lines": ["    def test_upload_no_file_name(self, mock_put, mock_get_url):"]}, {"lines": ["            'upload',", "            'osfstorage',"]}, {"lines": ["            user=self.user,"]}, {"lines": ["        # Verify that user has been added to Elastic Search"]}, {"lines": ["        migrate(delete=False, index=settings.ELASTIC_INDEX, app=self.app.app)"]}, {"lines": ["            migrate(delete=False, index=settings.ELASTIC_INDEX, app=self.app.app)"]}, {"lines": ["        migrate(delete=True, index=settings.ELASTIC_INDEX, app=self.app.app)"]}, {"lines": ["            migrate(delete=True, index=settings.ELASTIC_INDEX, app=self.app.app)"]}, {"lines": ["            migrate(delete=True, index=settings.ELASTIC_INDEX, app=self.app.app)"]}, {"lines": ["    def test_can_read_children(self):"]}, {"lines": ["        has_permission_on_child_node = node.can_read_children(non_admin_user)"]}, {"lines": ["        has_permission_on_child_node = node.can_read_children(non_admin_user)"]}, {"lines": ["        has_permission_on_child_node = node.can_read_children(non_admin_user)"]}, {"lines": ["        has_permission_on_child_node = node.can_read_children(non_admin_user)"]}, {"lines": ["        has_permission_on_child_node = node.can_read_children(parent.creator)"]}, {"lines": ["        has_permission_on_child_nodes = parent.can_read_children(user)"]}, {"lines": ["        assert_equal(payload['id'], s.owner._id)"]}, {"lines": ["            owner=self.project"]}, {"lines": ["            owner=self.node"]}, {"lines": ["                owner=project"]}, {"lines": ["            owner=self.project,"]}, {"lines": ["            owner=self.node,"]}, {"lines": ["            owner=self.user,"]}, {"lines": ["        configured_ids = utils.get_configured_projects(self.user)", ""]}, {"lines": ["        # No dupilcates!", "        assert_equal(len(configured_ids), 1)", ""]}, {"lines": ["        assert_in(self.project._id, configured_ids)", "        assert_not_in(self.node._id, configured_ids)", "        assert_not_in(self.user._id, configured_ids)"]}, {"lines": ["            owner=project"]}, {"lines": ["            owner=node,"]}, {"lines": ["            owner=node,"]}, {"lines": ["        data = utils.format_data(self.user, [self.project._id])"]}, {"lines": ["        data = utils.format_data(self.user, [self.node._id])"]}, {"lines": ["            'node': {", "                'id': self.node._id,", "                'title': self.node.title,", "                'url': self.node.url,", "            },", "            'kind': 'node',"]}, {"lines": ["            'children': [", "                {", "                    'event': {", "                        'title': 'comments',"]}, {"lines": ["                        'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["                        'notificationType': 'email_transactional',", "                        'parent_notification_type': 'email_transactional'"]}, {"lines": ["                    'kind': 'event',"]}, {"lines": ["                    'children': []"]}, {"lines": ["                }", "            ]", "        }]"]}, {"lines": [""]}, {"lines": ["        data = utils.format_data(self.user, [self.project._id])"]}, {"lines": [""]}, {"lines": ["            owner=project,"]}, {"lines": ["        data = utils.format_data(project.creator, configured_project_ids)"]}, {"lines": ["            ]", "        }]"]}, {"lines": ["            owner=node,"]}, {"lines": ["        data = utils.format_data(node.creator, configured_project_ids)"]}, {"lines": ["            'event': {", "                'title': 'comment_replies',", "                'description': constants.USER_SUBSCRIPTIONS_AVAILABLE['comment_replies'],", "                'notificationType': 'email_transactional',", "                'parent_notification_type': None", "            },", "            'kind': 'event',", "            'children': [],", "        }]"]}, {"lines": ["                'children': utils.format_data(self.user, utils.get_configured_projects(self.user))"]}, {"lines": ["        }"]}, {"lines": ["            owner=self.project,"]}, {"lines": ["            owner=self.node,"]}, {"lines": ["            owner=node,"]}, {"lines": ["            owner=node,"]}, {"lines": ["            owner=user,"]}, {"lines": ["            owner=project,"]}, {"lines": ["            owner=project,"]}, {"lines": ["            owner=node,"]}, {"lines": ["            owner=project,"]}, {"lines": ["            owner=node,"]}, {"lines": ["        node_lineage = emails.get_node_lineage(self.node)", "        assert_equal(node_lineage, [self.project._id, self.node._id])"]}, {"lines": ["import unittest"]}, {"lines": ["from website.util import sanitize", "", ""]}, {"lines": ["            '&lt;script&gt; evil code &lt;/script&gt;',"]}, {"lines": ["            '&lt;img src=&quot;javascript:moreevil&quot;&gt;&lt;img&gt;',"]}, {"lines": ["            '&lt;iframe src=&quot;evilsite&quot;&gt;',"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        res_admin = _render_node(node, Auth(admin))"]}, {"lines": ["        res_writer = _render_node(node, Auth(writer))"]}, {"lines": ["                           expect_errors=True)"]}, {"lines": ["        res = self.app.get(", "            self.project_url, {'view_only': self.link.key}, auth=self.user.auth)"]}, {"lines": ["                           {\"name\": \"description\", \"value\": \"Deep-fried\"},", "                           auth=self.auth)"]}, {"lines": ["                    {'id': self.project.creator._id, 'permission': 'admin',", "                        'registered': True, 'visible': True},", "                    {'id': self.user1._id, 'permission': 'read',", "                        'registered': True, 'visible': True},", "                    {'id': self.user2._id, 'permission': 'admin',", "                        'registered': True, 'visible': True},"]}, {"lines": ["                {'user': reg_user1, 'permissions': [", "                    'read', 'write', 'admin'], 'visible': True},", "                {'user': reg_user2, 'permissions': [", "                    'read', 'write', 'admin'], 'visible': False},"]}, {"lines": ["                    {'id': reg_user2._id, 'permission': 'admin',", "                        'registered': True, 'visible': False},", "                    {'id': project.creator._id, 'permission': 'admin',", "                        'registered': True, 'visible': True},", "                    {'id': unregistered_user._id, 'permission': 'admin',", "                        'registered': False, 'visible': True},", "                    {'id': reg_user1._id, 'permission': 'admin',", "                        'registered': True, 'visible': True},"]}, {"lines": ["                      content_type=\"application/json\",", "                      auth=self.auth).maybe_follow()"]}, {"lines": ["                           auth=self.auth).maybe_follow()"]}, {"lines": ["        url = \"/api/v1/project/{0}/register/Replication_Recipe_(Brandt_et_al.,_2013):_Post-Completion/\".format(", "            self.project._primary_key)"]}, {"lines": ["                                     auth=Auth(self.creator))"]}, {"lines": ["                                                         email=email, auth=Auth(self.project.creator))"]}, {"lines": ["                     n_contributors_pre + len(payload['users']))"]}, {"lines": ["        comp1, comp2 = NodeFactory(", "            creator=self.creator), NodeFactory(creator=self.creator)"]}, {"lines": ["                     n_contributors_pre + len(payload['users']))"]}, {"lines": ["        self.invite_url = '/api/v1/project/{0}/invite_contributor/'.format(", "            self.project._primary_key)"]}, {"lines": ["                                                           auth=Auth(project2.creator))"]}, {"lines": ["                                 {'fullname': name, 'email': email}, auth=self.user.auth)"]}, {"lines": ["                                 {'fullname': fake.name(), 'email': reg_user.username},", "                                 auth=self.user.auth, expect_errors=True)"]}, {"lines": ["                                 {'fullname': fake.name(), 'email': unreg_user.username},", "                                 auth=self.user.auth, expect_errors=True)"]}, {"lines": ["                                 {'fullname': name, 'email': None}, auth=self.user.auth)"]}, {"lines": ["                                 {'email': 'brian@queen.com', 'fullname': ''}, auth=self.user.auth,", "                                 expect_errors=True)"]}, {"lines": ["                                                          email=given_email, auth=Auth(", "                                                              referrer)", "                                                          )"]}, {"lines": ["                                       given_name=fake.name())"]}, {"lines": ["                                                         self.project._primary_key)"]}, {"lines": ["                                 {'value': self.given_email,", "                                     'pk': self.user._primary_key},", "                                 auth=self.referrer.auth)"]}, {"lines": ["                                                         self.project._primary_key)"]}, {"lines": ["                           {'value': email, 'pk': self.user._primary_key}", "                           )"]}, {"lines": ["                                 params={},", "                                 auth=self.auth)"]}, {"lines": ["                                  params={},", "                                  auth=self.auth,", "                                  expect_errors=True)"]}, {"lines": ["                                                               node._id)"]}, {"lines": ["        url = '/search/'"]}, {"lines": ["class TestProjectCreation(OsfTestCase):", "", "    def setUp(self):"]}, {"lines": ["        super(TestProjectCreation, self).setUp()"]}, {"lines": ["        self.creator = AuthUserFactory()"]}, {"lines": ["        self.url = api_url_for('project_new_post')"]}, {"lines": ["", "    def test_needs_title(self):", "        res = self.app.post_json(self.url, {}, auth=self.creator.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)", ""]}, {"lines": ["    def test_only_needs_title(self):", "        payload = {", "            'title': 'Im a real title'", "        }", "        res = self.app.post_json(self.url, payload, auth=self.creator.auth)", "        assert_equal(res.status_code, 201)", ""]}, {"lines": ["    def test_title_must_be_one_long(self):", "        payload = {", "            'title': ''", "        }"]}, {"lines": ["        res = self.app.post_json(", "            self.url, payload, auth=self.creator.auth, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 400)", "", "    def test_title_must_be_less_than_200(self):", "        payload = {"]}, {"lines": ["            'title': ''.join([str(x) for x in xrange(0, 250)])"]}, {"lines": ["        }"]}, {"lines": ["        res = self.app.post_json(", "            self.url, payload, auth=self.creator.auth, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 400)", ""]}, {"lines": ["    def test_creates_a_project(self):", "        payload = {", "            'title': 'Im a real title'", "        }", "        res = self.app.post_json(self.url, payload, auth=self.creator.auth)", "        assert_equal(res.status_code, 201)"]}, {"lines": ["        node = Node.load(res.json['projectUrl'].replace('/', ''))"]}, {"lines": ["        assert_true(node)", "        assert_true(node.title, 'Im a real title')", ""]}, {"lines": ["    def test_description_works(self):", "        payload = {", "            'title': 'Im a real title',", "            'description': 'I describe things!'", "        }", "        res = self.app.post_json(self.url, payload, auth=self.creator.auth)", "        assert_equal(res.status_code, 201)"]}, {"lines": ["        node = Node.load(res.json['projectUrl'].replace('/', ''))"]}, {"lines": ["        assert_true(node)", "        assert_true(node.description, 'I describe things!')", "", "    def test_can_template(self):"]}, {"lines": ["        other_node = ProjectFactory(creator=self.creator)"]}, {"lines": ["        payload = {", "            'title': 'Im a real title',"]}, {"lines": ["            'template': other_node._id"]}, {"lines": ["        }", "        res = self.app.post_json(self.url, payload, auth=self.creator.auth)", "        assert_equal(res.status_code, 201)"]}, {"lines": ["        node = Node.load(res.json['projectUrl'].replace('/', ''))"]}, {"lines": ["        assert_true(node)"]}, {"lines": ["        assert_true(node.template_node, other_node)"]}, {"lines": ["ERROR_PREFIX = \"Unable to render. <a href='?action=download'>Download</a> file to view it.\""]}, {"lines": [""]}, {"lines": ["FILE_OPERATION_SUCCESS = Mail(", "    'file_operation_success',", "    subject='Your ${action} has finished',", ")", "", "FILE_OPERATION_FAILED = Mail(", "    'file_operation_failed',", "    subject='Your ${action} has failed',"]}, {"lines": [")"]}, {"lines": ["from framework import status", "from framework import sentry"]}, {"lines": ["from framework.routing import Rule"]}, {"lines": ["from framework.routing import WebRenderer"]}, {"lines": ["from framework.auth import get_display_name"]}, {"lines": ["from framework.routing import json_renderer", "from framework.routing import process_rules"]}, {"lines": ["from framework.routing import render_mako_string", "from framework.auth.core import _get_current_user"]}, {"lines": ["from website import util", "from website import settings", "from website import language"]}, {"lines": ["from website.util import sanitize"]}, {"lines": ["from website.addons.base import views as addon_views", "from website.discovery import views as discovery_views"]}, {"lines": ["    user = _get_current_user()"]}, {"lines": ["    if _get_current_user():"]}, {"lines": ["        Rule('/search/', 'get', {}, OsfWebRenderer('search.mako')),"]}, {"lines": ["        Rule(['/search/', '/search/<type>/'], ['get', 'post'], search_views.search_search, json_renderer),"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/files/<provider>/<path:path>/',", "                '/project/<pid>/node/<nid>/files/<provider>/<path:path>/',", "            ],", "            'get',"]}, {"lines": ["            addon_views.addon_view_or_download_file,"]}, {"lines": ["            OsfWebRenderer('project/view_file.mako')", "        ),"]}, {"lines": ["        Rule(", "            ["]}, {"lines": [""]}, {"lines": ["                # Legacy Addon view file paths", "                '/project/<pid>/<provider>/files/<path:path>/',", "                '/project/<pid>/node/<nid>/<provider>/files/<path:path>/',", ""]}, {"lines": ["                '/project/<pid>/<provider>/files/<path:path>/download/',", "                '/project/<pid>/node/<nid>/<provider>/files/<path:path>/download/',"]}, {"lines": ["", "                # Legacy routes for `download_file`", "                '/project/<pid>/osffiles/<fid>/download/',", "                '/project/<pid>/node/<nid>/osffiles/<fid>/download/',", "", "                # Legacy routes for `view_file`", "                '/project/<pid>/osffiles/<fid>/',", "                '/project/<pid>/node/<nid>/osffiles/<fid>/',", "", "                # Note: Added these old URLs for backwards compatibility with", "                # hard-coded links.", "                '/project/<pid>/osffiles/download/<fid>/',", "                '/project/<pid>/node/<nid>/osffiles/download/<fid>/',", "                '/project/<pid>/files/<fid>/',", "                '/project/<pid>/node/<nid>/files/<fid>/',", "                '/project/<pid>/files/download/<fid>/',", "                '/project/<pid>/node/<nid>/files/download/<fid>/',", "", "                # Legacy routes for `download_file_by_version`", "                '/project/<pid>/osffiles/<fid>/version/<vid>/download/',", "                '/project/<pid>/node/<nid>/osffiles/<fid>/version/<vid>/download/',", "                # Note: Added these old URLs for backwards compatibility with", "                # hard-coded links.", "                '/project/<pid>/osffiles/<fid>/version/<vid>/',", "                '/project/<pid>/node/<nid>/osffiles/<fid>/version/<vid>/',", "                '/project/<pid>/osffiles/download/<fid>/version/<vid>/',", "                '/project/<pid>/node/<nid>/osffiles/download/<fid>/version/<vid>/',", "                '/project/<pid>/files/<fid>/version/<vid>/',", "                '/project/<pid>/node/<nid>/files/<fid>/version/<vid>/',", "                '/project/<pid>/files/download/<fid>/version/<vid>/',", "                '/project/<pid>/node/<nid>/files/download/<fid>/version/<vid>/',"]}, {"lines": ["                # api/v1 Legacy routes for `download_file`", "                '/api/v1/project/<pid>/osffiles/<fid>/',", "                '/api/v1/project/<pid>/node/<nid>/osffiles/<fid>/',", "                '/api/v1/project/<pid>/files/download/<fid>/',", "                '/api/v1/project/<pid>/node/<nid>/files/download/<fid>/',", "", "                #api/v1 Legacy routes for `download_file_by_version`", "                '/api/v1/project/<pid>/osffiles/<fid>/version/<vid>/',", "                '/api/v1/project/<pid>/node/<nid>/osffiles/<fid>/version/<vid>/',", "                '/api/v1/project/<pid>/files/download/<fid>/version/<vid>/',", "                '/api/v1/project/<pid>/node/<nid>/files/download/<fid>/version/<vid>/',", "            ],", "            'get',", "            addon_views.addon_view_or_download_file_legacy,", "            json_renderer", "        ),", ""]}, {"lines": ["            '/files/auth/',", "            'get',", "            addon_views.get_auth,", "            json_renderer,", "        ),", "", "        Rule(", "            [", "                '/project/<pid>/waterbutler/logs/',", "                '/project/<pid>/node/<nid>/waterbutler/logs/',", "            ],", "            'put',", "            addon_views.create_waterbutler_log,", "            json_renderer,", "        ),", "        Rule("]}, {"lines": ["        Rule("]}, {"lines": ["from website.routes import OsfWebRenderer"]}, {"lines": ["from framework.routing import Rule, json_renderer", "", "from . import views", "", ""]}, {"lines": ["render_routes = {"]}, {"lines": ["    'rules': [", "        Rule([", "            '/project/<pid>/badges/',", "            '/project/<pid>/node/<nid>/badges/',"]}, {"lines": ["        ], 'get', views.render.badges_page, OsfWebRenderer('../addons/badges/templates/badges_page.mako')),"]}, {"lines": ["    ],", "}", ""]}, {"lines": ["api_urls = {", "    'rules': ["]}, {"lines": ["        Rule('/badges/new/', 'post', views.crud.create_badge, json_renderer),"]}, {"lines": ["        Rule(", "            '/dashboard/get_badges/',", "            'get', views.render.dashboard_badges, json_renderer),", "        Rule(", "            '/dashboard/get_assertions/',", "            'get', views.render.dashboard_assertions, json_renderer),", "        Rule(", "            '/profile/<uid>/badges/json/',", "            'get', views.render.organization_badges_listing, json_renderer),"]}, {"lines": ["        Rule([", "            '/project/<pid>/badges/award/',", "            '/project/<pid>/node/<nid>/badges/award/',"]}, {"lines": ["        ], 'post', views.crud.award_badge, json_renderer),"]}, {"lines": ["        Rule([", "            '/project/<pid>/badges/revoke/',", "            '/project/<pid>/node/<nid>/badges/revoke/',"]}, {"lines": ["        ], 'post', views.crud.revoke_badge, json_renderer),", "        Rule(["]}, {"lines": ["            '/project/<pid>/badges/widget/',", "            '/project/<pid>/node/<nid>/badges/widget/',", "        ], 'get', views.render.badges_widget, json_renderer),"]}, {"lines": ["    ],", "    'prefix': '/api/v1',", "}", "", "guid_urls = {", "    'rules': ["]}, {"lines": ["        Rule("]}, {"lines": ["            '/badge/<bid>/',"]}, {"lines": ["            'get', views.render.view_badge, OsfWebRenderer('../addons/badges/templates/view_badge.mako')),", "        Rule("]}, {"lines": ["            '/badge/<bid>/json/',"]}, {"lines": ["            'get', views.openbadge.get_badge_json, json_renderer),", "        Rule("]}, {"lines": ["            '/badge/assertion/json/<aid>/',"]}, {"lines": ["            'get', views.openbadge.get_assertion_json, json_renderer),", "        Rule("]}, {"lines": ["            '/badge/organization/<uid>/json/',"]}, {"lines": ["            'get', views.openbadge.get_organization_json, json_renderer),"]}, {"lines": ["    ]"]}, {"lines": ["}"]}, {"lines": ["", "from website.addons.base import AddonUserSettingsBase, AddonNodeSettingsBase", ""]}, {"lines": ["from . import Badge"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["#TODO Better way around this, No longer needed?", "class BadgesNodeSettings(AddonNodeSettingsBase):", "    pass", "", "", "class BadgesUserSettings(AddonUserSettingsBase):", "", "    revocation_list = fields.DictionaryField()  # {'id':'12345', 'reason':'is a loser'}", "", "    @property"]}, {"lines": ["    def can_award(self):"]}, {"lines": ["        return bool(self.badges) or len(Badge.get_system_badges()) > 0"]}, {"lines": ["", "    @property", "    def badges(self):"]}, {"lines": ["        return list(self.badge__creator) + [badge for badge in Badge.get_system_badges() if badge.creator != self]"]}, {"lines": [""]}, {"lines": ["    @property", "    def issued(self):", "        assertions = []", "        for badge in self.badges:", "            for assertion in badge.assertions:", "                if assertion.awarder == self:", "                    assertions.append(assertion)", "        return assertions", ""]}, {"lines": ["    def get_badges_json(self):", "        return [badge.to_json() for badge in self.badges]", "", "    def get_badges_json_simple(self):"]}, {"lines": ["        return [{'value': badge._id, 'text': badge.name} for badge in self.badges]"]}, {"lines": ["", "    def to_json(self, user):", "        ret = super(BadgesUserSettings, self).to_json(user)"]}, {"lines": ["        ret['badges'] = self.get_badges_json()"]}, {"lines": ["        return ret", "", "    def to_openbadge(self):", "        ret = {", "            'name': self.owner.fullname,"]}, {"lines": ["            'email': self.owner.username,"]}, {"lines": ["        }"]}, {"lines": ["        # Place holder for later when orgaizations get worked on"]}, {"lines": ["        # if self.description:", "        #     ret['description'] = self.description,", "        # if self.image:", "        #     ret['image'] = self.image,", "        # if self.url:", "        #     ret['url'] = self.url", "        # if self.revocation_list:", "        #     ret['revocationList'] = self.revocation_list", "        return ret"]}, {"lines": [""]}, {"lines": ["    def issued_json(self):"]}, {"lines": ["        return [assertion.to_json() for assertion in self.issued]"]}, {"lines": ["import os", "", "from website.settings import BASE_PATH", "", "", "BADGES_LOCATION = '/static/img/badges'", "BADGES_ABS_LOCATION = os.path.join(BASE_PATH, 'static/img/badges')", "", "# 2mb in bytes", "MAX_IMAGE_SIZE = 4 * 1024 ** 2"]}, {"lines": ["$('.badge-popover').popover({", "  container: 'body',", "  trigger: 'click',", "  html: true,", "  placement: 'auto'", "});", "", "$('.badge-popover').on('show.bs.popover', function () {", "  var self = this;", "  $('.badge-popover').each(function(id, popover) {", "    $(popover).not(self).popover('hide');", "  });", "});"]}, {"lines": ["// png-baker.js", "// 2013-10-11", "// Public Domain.", "// For more information, see http://github.com/toolness/png-baker.js.", "", "function PNGBaker(thing) {", "  if (!(this instanceof PNGBaker)) return new PNGBaker(thing);", "", "  var buffer = thing;", "", "  if (typeof(thing) == 'string') buffer = this._dataURLtoBuffer(thing);", "", "  if (!(buffer instanceof ArrayBuffer))", "    throw new Error(\"first argument must be a data URI or ArrayBuffer\");", "", "  this.buffer = buffer;", "  this.textChunks = {};", "  this._chunks = [];", "  this._ensurePNGsignature();", "  for (var i = this.PNG_SIGNATURE.length;", "       i < buffer.byteLength;", "       i += this._readNextChunk(i));", "  if (!this._chunks.length || this._chunks[0].type != \"IHDR\")", "    throw new Error(\"first chunk must be IHDR\");", "  if (this._chunks[this._chunks.length-1].type != \"IEND\")", "    throw new Error(\"last chunk must be IEND\");", "}", "", "PNGBaker.prototype = {", "  PNG_SIGNATURE: [137, 80, 78, 71, 13, 10, 26, 10],", "  _ensurePNGsignature: function() {", "    var bytes = new Uint8Array(this.buffer, 0, this.PNG_SIGNATURE.length);", "    for (var i = 0; i < this.PNG_SIGNATURE.length; i++)", "      if (bytes[i] != this.PNG_SIGNATURE[i])", "        throw new Error(\"PNG signature mismatch at byte \" + i);", "  },", "  _readNextChunk: function(byteOffset) {", "    var i = byteOffset;", "    var buffer = this.buffer;", "    var data = new DataView(buffer);", "    var chunkLength = data.getUint32(i); i += 4;", "    var crcData = new Uint8Array(buffer, i, chunkLength+4);", "    var ourCRC = this._crc32(crcData);", "    var chunkType = this._arrayToStr(new Uint8Array(buffer, i, 4)); i += 4;", "    var chunkBytes = new Uint8Array(buffer, i, chunkLength);", "", "    i += chunkLength;", "", "    var chunkCRC = data.getUint32(i); i += 4;", "", "    if (chunkCRC != ourCRC)", "      throw new Error(\"CRC mismatch for chunk type \" + chunkType);", "", "    if (chunkType == 'tEXt')", "      this._readTextChunk(chunkBytes);", "    else this._chunks.push({", "      type: chunkType,", "      data: chunkBytes", "    });", "", "    return i - byteOffset;", "  },", "  _readTextChunk: function(bytes) {", "    var keyword, text;", "    for (var i = 0; i < bytes.length; i++)", "      if (bytes[i] == 0) {", "        keyword = this._arrayToStr([].slice.call(bytes, 0, i));", "        text = this._arrayToStr([].slice.call(bytes, i+1));", "        break;", "      }", "    if (!keyword) throw new Error(\"malformed tEXt chunk\");", "    this.textChunks[keyword] = text;", "  },", "  _arrayToStr: function(array) {", "    return [].map.call(array, function(charCode) {", "      return String.fromCharCode(charCode);", "    }).join('');", "  },", "  // http://stackoverflow.com/a/7261048", "  _strToArray: function(byteString) {", "    var buffer = new ArrayBuffer(byteString.length);", "    var bytes = new Uint8Array(buffer);", "", "    for (var i = 0; i < byteString.length; i++)", "      bytes[i] = byteString.charCodeAt(i);", "    return bytes;", "  },", "  // http://stackoverflow.com/a/7261048", "  _dataURLtoBuffer: function(url) {", "    // convert base64 to raw binary data held in a string", "    // doesn't handle URLEncoded DataURIs - see SO answer #6850276 for code", "    // that does this", "    var byteString = atob(url.split(',')[1]);", "", "    return this._strToArray(byteString).buffer;", "  },", "  // https://gist.github.com/Yaffle/1287361", "  _crc32: function(s) {", "    var polynomial = 0x04C11DB7,", "        initialValue = 0xFFFFFFFF,", "        finalXORValue = 0xFFFFFFFF,", "        crc = initialValue,", "        table = [], i, j, c;", "", "    function reverse(x, n) {", "      var b = 0;", "      while (n) {", "        b = b * 2 + x % 2;", "        x /= 2;", "        x -= x % 1;", "        n--;", "      }", "      return b;", "    }", "", "    for (i = 255; i >= 0; i--) {", "      c = reverse(i, 32);", "", "      for (j = 0; j < 8; j++) {", "        c = ((c * 2) ^ (((c >>> 31) % 2) * polynomial)) >>> 0;", "      }", "", "      table[i] = reverse(c, 32);", "    }", "", "    // This is a fix for Safari, which dislikes Uint8 arrays, but only", "    // when Web Inspector is disabled.", "    s = [].slice.call(s);", "", "    for (i = 0; i < s.length; i++) {", "      c = s[i];", "      if (c > 255) {", "        throw new RangeError();", "      }", "      j = (crc % 256) ^ c;", "      crc = ((crc / 256) ^ table[j]) >>> 0;", "    }", "", "    return (crc ^ finalXORValue) >>> 0;", "  },", "  _makeChunk: function(chunk) {", "    var i;", "    var buffer = new ArrayBuffer(chunk.data.length + 12);", "    var data = new DataView(buffer);", "    var crcData = new Uint8Array(buffer, 4, chunk.data.length + 4);", "", "    data.setUint32(0, chunk.data.length);", "    for (i = 0; i < 4; i++)", "      data.setUint8(4 + i, chunk.type.charCodeAt(i));", "    for (i = 0; i < chunk.data.length; i++)", "      data.setUint8(8 + i, chunk.data[i]);", "    data.setUint32(8 + chunk.data.length, this._crc32(crcData));", "    return buffer;", "  },", "  toBlob: function() {", "    var parts = [new Uint8Array(this.PNG_SIGNATURE).buffer];", "    var makeChunk = this._makeChunk.bind(this);", "", "    parts.push(makeChunk(this._chunks[0]));", "    parts.push.apply(parts, Object.keys(this.textChunks).map(function(k) {", "      return makeChunk({", "        type: 'tEXt',", "        data: this._strToArray(k + '\\0' + this.textChunks[k])", "      });", "    }, this));", "    parts.push.apply(parts, this._chunks.slice(1).map(makeChunk));", "", "    return new Blob(parts, {type: 'image/png'});", "  }", "};"]}, {"lines": ["<%inherit file=\"project/addon/user_settings.mako\" />"]}, {"lines": ["%if len(badges) < 1:", "You have not created any Badges.", "%endif", "  <div style=\"max-height:200px; overflow-y: auto; overflow-x: hidden;\">"]}, {"lines": ["    <ul class=\"media-list\" id=\"badgeList\">", "        %for badge in badges:", "        <li class=\"media\">"]}, {"lines": ["          <a class=\"pull-left\">"]}, {"lines": ["            <img class=\"media-object\" src=\"${badge['image']}\" width=\"64px\" height=\"64px\">", "          </a>", "          <div class=\"media-body\">", "            <h4 class=\"media-heading\">${badge['name']}<small> ${badge['description']} </small></h4>"]}, {"lines": [""]}, {"lines": ["            ${badge['criteria']}", "          </div>", "        </li>", "        %endfor", "    </ul>"]}, {"lines": ["  </div>"]}, {"lines": [""]}, {"lines": ["  <br />"]}, {"lines": [""]}, {"lines": ["  <button class=\"btn btn-success\" id=\"newBadge\" type=\"button\">"]}, {"lines": ["    New Badge"]}, {"lines": ["  </button>"]}, {"lines": [""]}, {"lines": ["<script type=\"text/javascript\" src=\"/static/vendor/dropzone/dropzone.js\"></script>"]}, {"lines": ["<script type=\"text/javascript\">", "//TODO Make bootbox into a form? [with submit]", "//TODO Image uploading"]}, {"lines": ["    $(document).ready(function() {", "        $('#newBadge').click(function(){", "            bootbox.dialog({", "              message: '<form id=\"badgeForm\">' +"]}, {"lines": ["              '<input type=\"text\" class=\"form-control\" name=\"badgeName\" placeholder=\"Badge Name\"><br />' +", "              '<input type=\"text\" class=\"form-control\" name=\"description\" placeholder=\"Description\"><br />' +", "              '<input type=\"url\" class=\"form-control\" name=\"imageurl\" placeholder=\"Image URL\"><br />' +"]}, {"lines": ["              '<textarea class=\"form-control\" name=\"criteria\" placeholder=\"Criteria\" />' +", "              '</form>',", "              title: 'Create a New Badge',", "              buttons: {", "                submit: {", "                  label: \"Submit\",", "                  className: \"btn-success\",", "                  callback: function() {", "                    var data = AddonHelper.formToObj('#badgeForm');", "                    if(notEmpty(data)) {", "                      $.ajax({", "                        url: '/api/v1/badges/new/',", "                        type: 'POST',", "                        dataType: 'json',", "                        contentType: 'application/json',", "                        data: JSON.stringify(data),", "                        success: function(response) {"]}, {"lines": ["                          %if len(badges) > 0:", "                            $(\"#badgeList\").append(jsonToList(data, response.badgeid));", "                          %else:", "                            document.location.reload(true);", "                          %endif"]}, {"lines": ["                        },", "                        error: function(xhr) {", "                          alert('Failed: ' + xhr.statusText);", "                        }", "                      });", "                    }", "                  else {", "                  alert('All fields must be filled out.')", "                  return false;", "                }", "                  }", "                },"]}, {"lines": ["                // upload: {", "                //   label: \"Upload Image\",", "                //   className: \"btn-primary\",", "                //   callback: function() {", "                //     //Maybe another time", "                //   }", "                // },"]}, {"lines": ["                cancel: {", "                  label: \"Cancel\",", "                  className: \"btn-default\"", "                }", "              }", "            });", "        });", "    });", "", "  var notEmpty = function(list) {", "    for(var key in list) {", "      if(list[key].trim() === \"\")", "        return false;", "    }", "    return true;", "  };", "", "//todo fetch url from server"]}, {"lines": ["  var jsonToList = function(badge, id) {"]}, {"lines": ["    return '<li class=\"media\">' +"]}, {"lines": ["          '<a class=\"pull-left\" href=\"/' + id + '/\">' +"]}, {"lines": ["            '<img class=\"media-object\" src=\"' + badge['imageurl'] + '\" width=\"64px\" height=\"64px\"> </a>' +", "                  '<div class=\"media-body\">' +", "                    '<h4 class=\"media-heading\">' + badge['badgeName'] + '<small> ' + badge['description'] + '</small></h4>' +", "        badge['criteria'] +", "      '</div>' +", "    '</li>'", "  };", "", "</script>", ""]}, {"lines": ["<%def name=\"submit_btn()\">"]}, {"lines": ["</%def>", "<%def name=\"on_submit()\">"]}, {"lines": ["</%def>"]}, {"lines": ["<div class=\"hgrid\" id=\"assertionGrid\" width=\"100%\"></div>", ""]}, {"lines": ["<script type=\"text/javascript\">"]}, {"lines": ["$script.ready('hgrid', function() {", "        var assertions = [", "            %for assertion in assertions:", "                %if not assertion.revoked:", "                    {", "                        date: '${assertion.issued_date}',", "                        badge: '${assertion.badge.name}',", "                        badge_id: '${assertion.badge._id}',", "                        project: '${assertion.node.title}',", "                        project_id:'${assertion.node._id}',", "                        assertion_id: '${assertion._id}',", "                        node_api_url: '${assertion.node.api_url}'", "                    },", "                %endif", "            %endfor", "        ];"]}, {"lines": [""]}, {"lines": ["        var dateColumn = {", "            text: 'Awarded on',", "            itemView: '{{ date }}',", "            sortable: true,"]}, {"lines": ["        };", "        var badgeColumn = {", "            text: 'Badge',", "            itemView: '<a href=\"/{{ badge_id }}/\">{{ badge }}</a>',", "            sortable: true,"]}, {"lines": ["        };", "        var projectColumn = {", "            text: 'Project',", "            itemView: '<a href=\"/{{ project_id }}/\">{{ project }}</a>',", "            sortable: true,"]}, {"lines": ["        };", "        var revokeColumn = {", "            text: 'revoke',"]}, {"lines": ["        };", "        var grid = new HGrid('#assertionGrid', {", "            columns: [", "                badgeColumn,", "                dateColumn,", "                projectColumn,", "                revokeColumn", "            ],", "            data: assertions,", "            width: '100%'", "        });"]}, {"lines": [""]}, {"lines": ["        $('.revoke-badge').click(function() {", "            var $self = $(this);", "            bootbox.confirm('Revoke this badge?', function(result) {", "                var bid = $self.attr('aid');"]}, {"lines": ["                if(result && bid) {", "                    $.ajax({", "                        url: url + 'badges/revoke/',", "                        method: 'POST',", "                        dataType: 'json',", "                        contentType: 'application/json',", "                        data: JSON.stringify({reason: '', id: bid}),", "                        success: function(data) {", "                            location.reload();", "                        },", "                        error: function(xhr, status, error) {"]}, {"lines": ["                        }", "                    });", "                }", "            });", "        });"]}, {"lines": ["});"]}, {"lines": ["</script>"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "", "<%def name=\"title()\">${badge.name}</%def>", "", "<%def name=\"content()\">", ""]}, {"lines": ["<div class=\"media well\">"]}, {"lines": ["  %if badge.is_system_badge:"]}, {"lines": ["  <span class=\"pull-right\" style=\"text-align:end;\">System Badge"]}, {"lines": ["  %else:"]}, {"lines": ["    <span class=\"pull-right\" style=\"text-align:end;\">Endorsed by <a href=\"${badge.creator.owner.profile_url}\">${badge.creator.owner.fullname}</a>"]}, {"lines": ["  %endif", "  <br/>"]}, {"lines": ["  Awarded ${badge.awarded_count} Times to ${badge.unique_awards_count} Projects</span>"]}, {"lines": ["  <a class=\"pull-left\">", "    <img class=\"media-object\" src=\"${badge.image}\" width=\"150px\" height=\"150px\">"]}, {"lines": ["  </a>", "  <div class=\"media-body\">"]}, {"lines": ["    <h4 class=\"media-heading\">${badge.name}", "        <small> ${badge.description} </small>"]}, {"lines": ["        </h4>"]}, {"lines": ["    ${badge.criteria_list}"]}, {"lines": ["  </div>", "</div>"]}, {"lines": ["", "<div class=\"hgrid\" id=\"grid\" width=\"100%\"></div>", "", "</%def>", "", "<%def name=\"javascript_bottom()\">"]}, {"lines": ["<!-- <script src=\"/static/vendor/hgrid/hgrid.js\"></script>", "<script src=\"/static/vendor/dropzone/dropzone.js\"></script> -->"]}, {"lines": ["<script>"]}, {"lines": ["$script.ready('hgrid', function() {"]}, {"lines": [""]}, {"lines": ["    var data = [", "      %for assertion in assertions:", "        %if not assertion.revoked:", "          {", "            name: '<a href=\"${assertion.node.absolute_url}\">${assertion.node.title}</a>',", "            description: '${assertion.node.description or 'No description'}',", "            date: '${assertion.issued_date}',", "            evidence: '${'<a href=\"' + assertion.evidence + '\">' + assertion.evidence + '</a>' if assertion.evidence else 'None provided'}',", "            %if badge.is_system_badge:", "              awarder: '<a href=\"${assertion.awarder.owner.profile_url}\">${assertion.awarder.owner.fullname}</a>',", "            %endif", "            kind: 'item',", "            //children: [],", "          },", "        %endif", "      %endfor", "    ];", "", "    HGrid.Col.Name.text = 'Project Name';", "    HGrid.Col.Name.itemView = '{{ name }}';", "    var dateColumn = {", "      text: 'Awarded on',", "      itemView: '{{ date }}',"]}, {"lines": ["      sortable: true,"]}, {"lines": ["      sortkey: 'date', // property of item object on which to sort on"]}, {"lines": ["    };"]}, {"lines": ["    var descriptionColumn = {", "      text: 'Description',", "      itemView: '{{ description }}',", "      sortable: true,", "      sortkey: 'description', // property of item object on which to sort on", "    };", "    var evidenceColumn = {", "      text: 'Evidence',", "      itemView: '{{ evidence }}',", "      sortable: true,", "      sortkey: 'evidence', // property of item object on which to sort on", "    };", "    %if badge.is_system_badge:", "      var awarderColumn = {", "        text: 'Awarder',", "        itemView: '{{ awarder }}',", "        sortable: true,", "        sortkey: 'awarder', // property of item object on which to sort on", "      };", "    %endif", "    var grid = new HGrid('#grid', {", "      columns: [", "        HGrid.Col.Name,", "        descriptionColumn,", "        dateColumn,", "        %if badge.is_system_badge:", "          awarderColumn,", "        %endif", "        evidenceColumn", "      ],", "      data: data,", "      width: '100%'", "    });", "});"]}, {"lines": ["</script>", "</%def>"]}, {"lines": ["import mock"]}, {"lines": ["import random", "import string"]}, {"lines": ["from nose.tools import *"]}, {"lines": ["import website.app", "from webtest_plus import TestApp"]}, {"lines": [""]}, {"lines": ["from website.util import api_url_for, web_url_for"]}, {"lines": ["from website.addons.base.testing import AddonTestCase"]}, {"lines": [""]}, {"lines": ["from tests.factories import AuthUserFactory"]}, {"lines": ["from utils import create_mock_badger, create_badge_dict, get_garbage", ""]}, {"lines": [""]}, {"lines": ["class TestBadgesViews(AddonTestCase):"]}, {"lines": [""]}, {"lines": ["    ADDON_SHORT_NAME = 'badges'"]}, {"lines": ["", "    def setUp(self):", ""]}, {"lines": ["        super(TestBadgesViews, self).setUp()"]}, {"lines": [""]}, {"lines": ["    def set_node_settings(self, settings):", "        return settings", "", "    def set_user_settings(self, settings):", "        return create_mock_badger(settings)", "", "    def create_app(self):", "        return TestApp(app)", ""]}, {"lines": ["    @mock.patch('website.addons.badges.model.badges.acquire_badge_image')"]}, {"lines": ["    def test_create_badge(self, img_proc):"]}, {"lines": ["        img_proc.return_value = 'temp.png'", "        badge = create_badge_dict()"]}, {"lines": ["        ret = self.app.post_json(api_url_for('create_badge'), badge, auth=self.user.auth)"]}, {"lines": ["        self.user_settings.reload()"]}, {"lines": ["        assert_equals(ret.status_int, 201)"]}, {"lines": ["        assert_equals(ret.content_type, 'application/json')"]}, {"lines": ["        assert_true(ret.json['badgeid'] in [badge._id for badge in self.user_settings.badges])"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.badges.model.badges.acquire_badge_image')"]}, {"lines": ["    def test_create_badge_no_data(self, img_proc):"]}, {"lines": ["        url = api_url_for('create_badge')"]}, {"lines": ["        badge = {}", "        ret = self.app.post_json(url, badge, auth=self.user.auth, expect_errors=True)", "        assert_equals(ret.status_int, 400)", ""]}, {"lines": ["    @mock.patch('website.addons.badges.model.badges.acquire_badge_image')"]}, {"lines": ["    def test_create_badge_some_data(self, img_proc):"]}, {"lines": ["        img_proc.return_value = 'temp.png'"]}, {"lines": ["        url = api_url_for('create_badge')"]}, {"lines": ["        badge = {", "            'badgeName': ''.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(4)),", "            'description': 'Just doesn\\'t '.join(random.choice(string.ascii_letters + string.digits) for _ in range(6))", "        }", "        ret = self.app.post_json(url, badge, auth=self.user.auth, expect_errors=True)", "        assert_equals(ret.status_int, 400)", ""]}, {"lines": ["    @mock.patch('website.addons.badges.model.badges.acquire_badge_image')"]}, {"lines": ["    def test_create_badge_empty_data(self, img_proc):"]}, {"lines": ["        img_proc.return_value = 'temp.png'"]}, {"lines": ["        url = api_url_for('create_badge')"]}, {"lines": ["        badge = create_badge_dict()", "        badge['imageurl'] = ''", "        ret = self.app.post_json(url, badge, auth=self.user.auth, expect_errors=True)", "        assert_equals(ret.status_int, 400)", ""]}, {"lines": ["    @mock.patch('website.addons.badges.model.badges.acquire_badge_image')"]}, {"lines": ["    def test_create_badge_cant_issue(self, img_proc):"]}, {"lines": ["        img_proc.return_value = 'temp.png'"]}, {"lines": ["        self.user.delete_addon('badges')"]}, {"lines": ["        url = api_url_for('create_badge')"]}, {"lines": ["        badge = create_badge_dict()", "        ret = self.app.post_json(url, badge, auth=self.user.auth, expect_errors=True)"]}, {"lines": ["        assert_equals(ret.status_int, 400)"]}, {"lines": [""]}, {"lines": ["    def test_award_badge(self):"]}, {"lines": ["        badgeid = self.user_settings.badges[0]._id", "        initnum = len(self.project.badgeassertion__awarded)"]}, {"lines": ["        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth)"]}, {"lines": ["        self.project.reload()"]}, {"lines": ["        assert_equals(ret.status_int, 200)", "        assert_equals(initnum + 1, len(self.project.badgeassertion__awarded))"]}, {"lines": ["", "    def test_award_badge_bad_badge_id(self):", "        badgeid = 'badid67'", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth, expect_errors=True)", "        assert_equals(ret.status_int, 400)", "", "    def test_award_badge_empty_badge_id(self):", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': ''}, auth=self.user.auth, expect_errors=True)", "        assert_equals(ret.status_int, 400)", "", "    def test_award_badge_no_badge_id(self):", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {}, auth=self.user.auth, expect_errors=True)", "        assert_equals(ret.status_int, 400)", ""]}, {"lines": ["    @mock.patch('website.addons.badges.model.badges.acquire_badge_image')"]}, {"lines": ["    def test_badge_html(self, img_proc):"]}, {"lines": ["        img_proc.return_value = 'temp.png'", "        badge = {", "            'badgeName': get_garbage(),", "            'description': get_garbage(),", "            'imageurl': get_garbage(),", "            'criteria': get_garbage()", "        }"]}, {"lines": ["        ret = self.app.post_json(api_url_for('create_badge'), badge, auth=self.user.auth)"]}, {"lines": ["        self.user_settings.reload()"]}, {"lines": ["        assert_equals(ret.status_int, 201)"]}, {"lines": ["        assert_equals(ret.content_type, 'application/json')"]}, {"lines": ["        assert_true(ret.json['badgeid'] in [badge._id for badge in self.user_settings.badges])"]}, {"lines": ["        with self.app.app.test_request_context():", "            bstr = str(self.user_settings.badges[0].to_openbadge())"]}, {"lines": ["        assert_false('>' in bstr)", "        assert_false('<' in bstr)", ""]}, {"lines": ["    def test_revoke_badge(self):", "        badgeid = self.user_settings.badges[0]._id", "        initnum = len(self.project.badgeassertion__awarded)", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        assert_equals(initnum + 1, len(self.project.badgeassertion__awarded))", "", "        assertion = self.project.badgeassertion__awarded[0]", ""]}, {"lines": ["        revoke = api_url_for('revoke_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(revoke,", "            {", "                'id': assertion._id,", "                'reason': ''", "            }, auth=self.user.auth)", "        self.project.reload()", "        self.user_settings.reload()", "        assertion.reload()", "", "        assert_equals(ret.status_int, 200)", "        assert_true(self.project.badgeassertion__awarded[0]._id, assertion._id)", "        assert_true(assertion.revoked)", "        assert_true(assertion._id in self.user_settings.revocation_list)", "        assert_equals(len(self.user_settings.revocation_list), 1)", "", "    def test_revoke_badge_reason(self):", "        badgeid = self.user_settings.badges[0]._id", "        initnum = len(self.project.badgeassertion__awarded)", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        assert_equals(initnum + 1, len(self.project.badgeassertion__awarded))", "", "        assertion = self.project.badgeassertion__awarded[0]", ""]}, {"lines": ["        revoke = api_url_for('revoke_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(revoke,", "            {", "                'id': assertion._id,", "                'reason': 'Is a loser'", "            }, auth=self.user.auth)", "        self.project.reload()", "        self.user_settings.reload()", "        assertion.reload()", "", "        assert_equals(ret.status_int, 200)", "        assert_true(self.project.badgeassertion__awarded[0]._id, assertion._id)", "        assert_true(assertion._id in self.user_settings.revocation_list)", "        assert_equals(len(self.user_settings.revocation_list), 1)", "        assert_true(assertion.revoked)", "        assert_equals(self.user_settings.revocation_list[assertion._id], 'Is a loser')", ""]}, {"lines": ["    def test_revoke_badge_no_addon(self):", "        badgeid = self.user_settings.badges[0]._id", "        initnum = len(self.project.badgeassertion__awarded)", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        assert_equals(initnum + 1, len(self.project.badgeassertion__awarded))", "", "        assertion = self.project.badgeassertion__awarded[0]", ""]}, {"lines": ["        revoke = api_url_for('revoke_badge', pid=self.project._id)"]}, {"lines": ["        self.user.delete_addon('badges')", "        self.user.save()", "        self.user.reload()", "", "        ret = self.app.post_json(revoke,", "            {", "                'id': assertion._id,", "                'reason': ''", "            }, auth=self.user.auth, expect_errors=True)", "        self.project.reload()", "        self.user_settings.reload()", "        assertion.reload()", "", "        assert_equals(ret.status_int, 400)", "        assert_false(assertion.revoked)", "        assert_true(self.project.badgeassertion__awarded[0]._id, assertion._id)", "        assert_false(assertion._id in self.user_settings.revocation_list)", "", "    def test_revoke_didnt_award(self):", "        badgeid = self.user_settings.badges[0]._id", "        initnum = len(self.project.badgeassertion__awarded)", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        assert_equals(initnum + 1, len(self.project.badgeassertion__awarded))", "", "        assertion = self.project.badgeassertion__awarded[0]", ""]}, {"lines": ["        revoke = api_url_for('revoke_badge', pid=self.project._id)"]}, {"lines": [""]}, {"lines": ["        user2 = AuthUserFactory()"]}, {"lines": ["        user2.add_addon('badges', override=True)"]}, {"lines": ["        user2.save()", "        user2.reload()"]}, {"lines": ["", "        ret = self.app.post_json(revoke,", "            {", "                'id': assertion._id,", "                'reason': ''"]}, {"lines": ["            }, auth=user2.auth, expect_errors=True)"]}, {"lines": ["        self.project.reload()", "        self.user_settings.reload()", "        assertion.reload()", "", "        assert_equals(ret.status_int, 400)", "        assert_false(assertion.revoked)", "        assert_true(self.project.badgeassertion__awarded[0]._id, assertion._id)", "        assert_false(assertion._id in self.user_settings.revocation_list)", ""]}, {"lines": ["    def test_issuer_html(self):", "        pass"]}, {"lines": ["", "    def test_revoke_bad_aid(self):", "        badgeid = self.user_settings.badges[0]._id", "        initnum = len(self.project.badgeassertion__awarded)", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        assert_equals(initnum + 1, len(self.project.badgeassertion__awarded))", "", "        assertion = self.project.badgeassertion__awarded[0]", ""]}, {"lines": ["        revoke = api_url_for('revoke_badge', pid=self.project._id)"]}, {"lines": ["", "        ret = self.app.post_json(revoke,", "            {", "                'id': 'Im a bad id :D',", "                'reason': ''", "            }, auth=self.user.auth, expect_errors=True)", "        self.project.reload()", "        self.user_settings.reload()", "        assertion.reload()", "", "        assert_equals(ret.status_int, 400)", "        assert_false(assertion.revoked)", "        assert_true(self.project.badgeassertion__awarded[0]._id, assertion._id)", "        assert_false(assertion._id in self.user_settings.revocation_list)", "", "    def test_system_badge_awarder(self):", "        badgeid = self.user_settings.badges[0]._id", "        self.user_settings.badges[0].make_system_badge()", "        initnum = len(self.project.badgeassertion__awarded)", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        assert_equals(initnum + 1, len(self.project.badgeassertion__awarded))", "", "        assertion = self.project.badgeassertion__awarded[0]", "        assert_equals(assertion.awarder._id, self.user_settings._id)", "", "    def test_badge_awarder(self):", "        badgeid = self.user_settings.badges[0]._id", "        initnum = len(self.project.badgeassertion__awarded)", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badgeid}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        assert_equals(initnum + 1, len(self.project.badgeassertion__awarded))", "", "        assertion = self.project.badgeassertion__awarded[0]", "        assert_equals(assertion.awarder._id, self.user_settings._id)", "", "    def test_award_times(self):", "        badge = self.user_settings.badges[0]", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        badge.reload()"]}, {"lines": ["        assert_equals(badge.awarded_count, 3)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        badge.reload()"]}, {"lines": ["        assert_equals(badge.awarded_count, 5)"]}, {"lines": ["", "    def test_unique_awards(self):", "        badge = self.user_settings.badges[0]", "        assert_true(self.user_settings.can_award)"]}, {"lines": ["        url = api_url_for('award_badge', pid=self.project._id)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        self.project.reload()", "        assert_equals(ret.status_int, 200)", "        badge.reload()"]}, {"lines": ["        assert_equals(badge.unique_awards_count, 1)"]}, {"lines": ["        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        ret = self.app.post_json(url, {'badgeid': badge._id}, auth=self.user.auth)", "        badge.reload()"]}, {"lines": ["        assert_equals(badge.unique_awards_count, 1)"]}, {"lines": ["import httplib as http", "", "from website.models import User", "", "from framework.exceptions import HTTPError", "", "from ..model import Badge, BadgeAssertion", "", "", "def get_assertion_json(*args, **kwargs):", "    _id = kwargs.get('aid', None)", "    if _id:", "        assertion = BadgeAssertion.load(_id)", "        if not assertion.revoked:", "            return assertion.to_openbadge()"]}, {"lines": ["        return {'revoked': True}, http.GONE"]}, {"lines": ["    raise HTTPError(http.BAD_REQUEST)", "", "", "def get_badge_json(*args, **kwargs):", "    _id = kwargs.get('bid', None)", "    if _id:", "        badge = Badge.load(_id)", "        return badge.to_openbadge()", "    raise HTTPError(http.BAD_REQUEST)", "", "", "def get_organization_json(*args, **kwargs):", "    uid = kwargs.get('uid', None)", "    if uid:", "        user = User.load(uid)", "        if user:", "            badger = user.get_addon('badges')", "            if badger:", "                return badger.to_openbadge()", "    raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["from flask import request"]}, {"lines": ["from mako.lookup import TemplateLookup"]}, {"lines": ["import furl", "import requests"]}, {"lines": ["from website.addons.base import exceptions"]}, {"lines": ["STATUS_EXCEPTIONS = {", "    410: exceptions.FileDeletedError,", "    404: exceptions.FileDoesntExistError", "}", ""]}, {"lines": ["    _metadata_cache = None"]}, {"lines": ["    def provider(self):"]}, {"lines": ["    def waterbutler_path(self):", "        '''The waterbutler formatted path of the specified file.", "        Must being with a /", "        '''", "        raise NotImplementedError", "", "    @property"]}, {"lines": ["    def guid_url(self):", "        return '/{0}/'.format(self._id)", "", "    @property"]}, {"lines": ["    def name(self):"]}, {"lines": ["        try:", "            return self._metadata_cache['name']", "        except (TypeError, KeyError):", "            # If name is not in _metadata_cache or metadata_cache is None", "            raise AttributeError('No attribute name')"]}, {"lines": ["", "    @property"]}, {"lines": ["    def size(self):", "        try:", "            return self._metadata_cache['size']", "        except (TypeError, KeyError):", "            raise AttributeError('No attribute size')", "", "    @property"]}, {"lines": ["    def materialized(self):", "        try:", "            return self._metadata_cache['materialized']", "        except (TypeError, KeyError):", "            # If materialized is not in _metadata_cache or metadata_cache is None", "            raise AttributeError('No attribute materialized')", "", "    @property"]}, {"lines": ["    def joinable_path(self):"]}, {"lines": ["        return self.waterbutler_path.lstrip('/')"]}, {"lines": ["", "    @property", "    def _base_butler_url(self):", "        url = furl.furl(settings.WATERBUTLER_URL)"]}, {"lines": ["        url.args.update({", "            'nid': self.node._id,"]}, {"lines": ["            'provider': self.provider,"]}, {"lines": ["            'path': self.waterbutler_path,"]}, {"lines": ["        })", ""]}, {"lines": ["        if request.args.get('view_only'):", "            url.args['view_only'] = request.args['view_only']", ""]}, {"lines": ["        if self.revision:", "            url.args[self.version_identifier] = self.revision", ""]}, {"lines": ["        return url", "", "    @property", "    def download_url(self):", "        url = self._base_butler_url", "        url.path.add('file')", "        return url.url", "", "    @property"]}, {"lines": ["    def mfr_render_url(self):", "        url = furl.furl(settings.MFR_SERVER_URL)", "        url.path.add('render')"]}, {"lines": ["        return url.url", "", "    @property"]}, {"lines": [""]}, {"lines": ["        url.path.add(self._id + '/')"]}, {"lines": ["        url.args['mode'] = 'render'"]}, {"lines": ["        url.args['action'] = 'download'"]}, {"lines": ["", "        if self.revision:", "            url.args[self.version_identifier] = self.revision"]}, {"lines": [""]}, {"lines": ["        if request.args.get('view_only'):", "            url.args['view_only'] = request.args['view_only']", ""]}, {"lines": ["        return url.url", "", "    @property"]}, {"lines": ["    def metadata_url(self):", "        url = self._base_butler_url", "        url.path.add('data')", "", "        return url.url", "", "    @property"]}, {"lines": ["", "        url = os.path.join(", "            self.node.deep_url,", "            'files',", "            self.provider,", "            self.joinable_path"]}, {"lines": ["        if url.endswith('/'):", "            return url", "        else:", "            return url + '/'", ""]}, {"lines": ["    @property", "    def revision(self):", "        return getattr(self, '_revision', None)"]}, {"lines": [""]}, {"lines": ["    def maybe_set_version(self, **kwargs):"]}, {"lines": ["        self._revision = kwargs.get(self.version_identifier)"]}, {"lines": [""]}, {"lines": ["    def enrich(self, save=True):"]}, {"lines": ["        self._fetch_metadata(should_raise=True)"]}, {"lines": [""]}, {"lines": ["    def _exception_from_response(self, response):"]}, {"lines": ["        if response.ok:", "            return", ""]}, {"lines": ["        if response.status_code in STATUS_EXCEPTIONS:", "            raise STATUS_EXCEPTIONS[response.status_code]"]}, {"lines": ["", "        raise exceptions.AddonEnrichmentError(response.status_code)", ""]}, {"lines": ["    def _fetch_metadata(self, should_raise=False):"]}, {"lines": ["        # Note: We should look into caching this at some point", "        # Some attributes may change however."]}, {"lines": ["        resp = requests.get(self.metadata_url)", "", "        if should_raise:"]}, {"lines": ["            self._exception_from_response(resp)"]}, {"lines": ["        self._metadata_cache = resp.json()['data']"]}, {"lines": [""]}, {"lines": ["    @property"]}, {"lines": ["    def complete(self):", "        \"\"\"Whether or not this addon is properly configured", "        :rtype bool:", "        \"\"\"", "        raise NotImplementedError()", "", "    @property"]}, {"lines": ["    def has_auth(self):", "        \"\"\"Whether the node has added credentials for this addon.\"\"\"", "        return False", ""]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import os"]}, {"lines": ["import json"]}, {"lines": ["import uuid"]}, {"lines": ["import httplib"]}, {"lines": ["import furl"]}, {"lines": ["from flask import redirect"]}, {"lines": ["from flask import make_response"]}, {"lines": ["from modularodm.exceptions import NoResultsFound"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["from framework.sentry import log_exception"]}, {"lines": ["from framework.auth.decorators import must_be_logged_in, must_be_signed", ""]}, {"lines": ["from website import mails"]}, {"lines": ["from website import settings"]}, {"lines": ["from website.addons.base import exceptions", "from website.models import User, Node, NodeLog"]}, {"lines": ["from website.project.decorators import must_be_valid_project, must_be_contributor_or_public"]}, {"lines": ["        raise HTTPError(httplib.BAD_REQUEST)"]}, {"lines": ["        raise HTTPError(httplib.BAD_REQUEST)"]}, {"lines": ["        raise HTTPError(httplib.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["permission_map = {"]}, {"lines": ["    'create_folder': 'write',"]}, {"lines": ["    'revisions': 'read',"]}, {"lines": ["    'metadata': 'read',", "    'download': 'read',", "    'upload': 'write',", "    'delete': 'write',", "    'copy': 'write',", "    'move': 'write',"]}, {"lines": ["    'copyto': 'write',", "    'moveto': 'write',", "    'copyfrom': 'read',", "    'movefrom': 'write',"]}, {"lines": ["}", "", ""]}, {"lines": ["def get_auth(**kwargs):", "    try:", "        action = request.args['action']"]}, {"lines": ["        node_id = request.args['nid']", "        provider_name = request.args['provider']", "    except KeyError:", "        raise HTTPError(httplib.BAD_REQUEST)", ""]}, {"lines": ["    if 'auth_user_id' in session.data:"]}, {"lines": ["    else:", "        user = None"]}, {"lines": [""]}, {"lines": ["    node = Node.load(node_id)", "    if not node:", "        raise HTTPError(httplib.NOT_FOUND)", ""]}, {"lines": ["", "    provider_settings = node.get_addon(provider_name)", "    if not provider_settings:", "        raise HTTPError(httplib.BAD_REQUEST)", ""]}, {"lines": ["    try:", "        credentials = provider_settings.serialize_waterbutler_credentials()", "        settings = provider_settings.serialize_waterbutler_settings()", "    except exceptions.AddonError:", "        log_exception()", "        raise HTTPError(httplib.BAD_REQUEST)"]}, {"lines": ["", "    return {"]}, {"lines": ["        'credentials': credentials,", "        'settings': settings,", "        'callback_url': node.api_url_for("]}, {"lines": ["            _absolute=True,", "        ),", "    }", "", "", "LOG_ACTION_MAP = {"]}, {"lines": ["    'move': NodeLog.FILE_MOVED,", "    'copy': NodeLog.FILE_COPIED,"]}, {"lines": ["    'create': NodeLog.FILE_ADDED,", "    'update': NodeLog.FILE_UPDATED,", "    'delete': NodeLog.FILE_REMOVED,"]}, {"lines": ["    'create_folder': NodeLog.FOLDER_CREATED,"]}, {"lines": ["}", "", "", "@must_be_signed"]}, {"lines": ["@must_be_valid_project", "def create_waterbutler_log(payload, **kwargs):", "    try:", "        auth = payload['auth']"]}, {"lines": ["        action = LOG_ACTION_MAP[payload['action']]"]}, {"lines": ["    except KeyError:", "        raise HTTPError(httplib.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["    user = User.load(auth['id'])", "    if user is None:", "        raise HTTPError(httplib.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["    auth = Auth(user=user)"]}, {"lines": ["    node = kwargs['node'] or kwargs['project']", "", "    if action in (NodeLog.FILE_MOVED, NodeLog.FILE_COPIED):", "        for bundle in ('source', 'destination'):"]}, {"lines": ["            for key in ('provider', 'materialized', 'name', 'nid'):"]}, {"lines": ["                if key not in payload[bundle]:"]}, {"lines": ["                    raise HTTPError(httplib.BAD_REQUEST)", ""]}, {"lines": ["        destination_node = node  # For clarity", "        source_node = Node.load(payload['source']['nid'])", "", "        source = source_node.get_addon(payload['source']['provider'])"]}, {"lines": ["        destination = node.get_addon(payload['destination']['provider'])", ""]}, {"lines": ["        payload['source'].update({", "            'materialized': payload['source']['materialized'].lstrip('/'),", "            'addon': source.config.full_name,", "            'url': source_node.web_url_for(", "                'addon_view_or_download_file',", "                path=payload['source']['path'].lstrip('/'),", "                provider=payload['source']['provider']", "            ),", "            'node': {", "                '_id': source_node._id,", "                'url': source_node.url,", "                'title': source_node.title,", "            }", "        })"]}, {"lines": [""]}, {"lines": ["        payload['destination'].update({", "            'materialized': payload['destination']['materialized'].lstrip('/'),", "            'addon': destination.config.full_name,", "            'url': destination_node.web_url_for(", "                'addon_view_or_download_file',", "                path=payload['destination']['path'].lstrip('/'),", "                provider=payload['destination']['provider']", "            ),", "            'node': {", "                '_id': destination_node._id,", "                'url': destination_node.url,", "                'title': destination_node.title,", "            }", "        })"]}, {"lines": [""]}, {"lines": ["        payload.update({"]}, {"lines": ["            'node': destination_node._id,", "            'project': destination_node.parent_id,"]}, {"lines": ["        })", ""]}, {"lines": ["        if not payload.get('errors'):", "            destination_node.add_log(", "                action=action,", "                auth=auth,", "                params=payload", "            )"]}, {"lines": [""]}, {"lines": ["        if payload.get('email') is True or payload.get('errors'):"]}, {"lines": ["            mails.send_mail(", "                user.username,", "                mails.FILE_OPERATION_FAILED if payload.get('errors')", "                else mails.FILE_OPERATION_SUCCESS,"]}, {"lines": ["                action=payload['action'],"]}, {"lines": ["                source_node=source_node,", "                destination_node=destination_node,", "                source_path=payload['source']['path'],", "                destination_path=payload['source']['path'],", "                source_addon=payload['source']['addon'],", "                destination_addon=payload['destination']['addon'],", "            )"]}, {"lines": ["    else:", "        try:", "            metadata = payload['metadata']", "            node_addon = node.get_addon(payload['provider'])", "        except KeyError:", "            raise HTTPError(httplib.BAD_REQUEST)", "", "        if node_addon is None:", "            raise HTTPError(httplib.BAD_REQUEST)", "", "        metadata['path'] = metadata['path'].lstrip('/')", "", "        node_addon.create_waterbutler_log(auth, action, metadata)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["def addon_view_or_download_file_legacy(**kwargs):"]}, {"lines": ["    query_params = request.args.to_dict()"]}, {"lines": ["    node = kwargs.get('node') or kwargs['project']", ""]}, {"lines": ["    action = query_params.pop('action', 'view')", "    provider = kwargs.get('provider', 'osfstorage')", ""]}, {"lines": ["    if kwargs.get('path'):", "        path = kwargs['path']", "    elif kwargs.get('fid'):", "        path = kwargs['fid']", ""]}, {"lines": ["    if 'download' in request.path or request.path.startswith('/api/v1/'):"]}, {"lines": ["        action = 'download'"]}, {"lines": ["", "    if kwargs.get('vid'):", "        query_params['version'] = kwargs['vid']", ""]}, {"lines": ["", "        try:", "            path = node_settings.root_node.find_child_by_name(path)._id", "        except NoResultsFound:", "            raise HTTPError(", "                404, data=dict(", "                    message_short='File not found',", "                    message_long='You requested a file that does not exist.'", "                )", "            )"]}, {"lines": ["    return redirect(", "        node.web_url_for(", "            'addon_view_or_download_file',", "            path=path,", "            provider=provider,", "            action=action,", "            **query_params", "        ),", "        code=httplib.MOVED_PERMANENTLY", "    )", "", "", "@must_be_valid_project"]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["def addon_view_or_download_file(auth, path, provider, **kwargs):"]}, {"lines": ["    extras = request.args.to_dict()"]}, {"lines": ["    node = kwargs.get('node') or kwargs['project']", "", "    node_addon = node.get_addon(provider)", ""]}, {"lines": ["    if not path:"]}, {"lines": ["        raise HTTPError(httplib.BAD_REQUEST)", ""]}, {"lines": ["    if not node_addon:", "        raise HTTPError(httplib.BAD_REQUEST, {", "            'message_short': 'Bad Request',", "            'message_long': 'The add-on containing this file is no longer connected to the {}.'.format(node.project_or_component)", "        })", ""]}, {"lines": ["    if not node_addon.has_auth:"]}, {"lines": ["        raise HTTPError(httplib.UNAUTHORIZED, {", "            'message_short': 'Unauthorized',", "            'message_long': 'The add-on containing this file is no longer authorized.'", "        })", "", "    if not node_addon.complete:", "        raise HTTPError(httplib.BAD_REQUEST, {", "            'message_short': 'Bad Request',", "            'message_long': 'The add-on containing this file is no longer configured.'", "        })"]}, {"lines": [""]}, {"lines": ["    if not path.startswith('/'):", "        path = '/' + path", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    if request.method == 'HEAD':"]}, {"lines": ["        download_url.args.update(extras)", "        download_url.args['accept_url'] = 'false'"]}, {"lines": ["        return make_response(('', 200, {'Location': download_url.url}))"]}, {"lines": [""]}, {"lines": ["    if action == 'download':"]}, {"lines": ["        download_url.args.update(extras)"]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["    try:"]}, {"lines": ["        guid_file.enrich()"]}, {"lines": ["    except exceptions.AddonEnrichmentError as e:", "        error = e.as_html()", "    else:", "        error = None", ""]}, {"lines": ["    if guid_file._id not in node.file_guid_to_share_uuids:", "        node.file_guid_to_share_uuids[guid_file._id] = uuid.uuid4()"]}, {"lines": ["        node.save()"]}, {"lines": ["    if ret['user']['can_edit']:"]}, {"lines": ["        sharejs_uuid = str(node.file_guid_to_share_uuids[guid_file._id])"]}, {"lines": ["    size = getattr(guid_file, 'size', None)", "    if size is None:  # Size could be 0 which is a falsey value", "        size = 9966699  # if we dont know the size assume its to big to edit", ""]}, {"lines": ["        'error': error.replace('\\n', '') if error else None,"]}, {"lines": ["        'panels_used': ['edit', 'view'],"]}, {"lines": ["        'sharejs_uuid': sharejs_uuid,"]}, {"lines": ["            'files': node.web_url_for('collect_file_trees'),"]}, {"lines": ["            'render': guid_file.mfr_render_url,", "            'sharejs': wiki_settings.SHAREJS_URL,"]}, {"lines": ["            'gravatar': get_gravatar(auth.user, 25),"]}, {"lines": ["        # Note: must be called after get_or_start_render. This is really only for github"]}, {"lines": ["        'size': size,"]}, {"lines": ["        #NOTE: get_or_start_render must be called first to populate name"]}, {"lines": ["    })", ""]}, {"lines": ["from website.addons.base.exceptions import AddonError", ""]}, {"lines": ["                '/project/<pid>/box/folders/',", "                '/project/<pid>/node/<nid>/box/folders/',"]}, {"lines": ["            views.config.box_list_folders,"]}, {"lines": ["    BoxUserSettingsFactory,"]}, {"lines": ["    BoxOAuthSettingsFactory"]}, {"lines": ["        self.node_settings = BoxNodeSettingsFactory(user_settings=self.user_settings)"]}, {"lines": ["import mock"]}, {"lines": ["from website.addons.box.model import BoxNodeSettings"]}, {"lines": ["", "", "class TestBoxAddonFolder(BoxAddonTestCase):", "", "    @mock.patch.object(BoxNodeSettings, 'fetch_folder_name', lambda self: 'foo')", "    def test_works(self):", "        folder = utils.box_addon_folder(", "            self.node_settings, Auth(self.user))", "", "        assert_true(isinstance(folder, list))", "        assert_true(isinstance(folder[0], dict))", "", "    def test_returns_none_unconfigured(self):", "        self.node_settings.folder_id = None", "        assert_is(utils.box_addon_folder(", "            self.node_settings, Auth(self.user)), None)", ""]}, {"lines": ["from website.addons.box.model import BoxOAuthSettings", ""]}, {"lines": ["        oauth = BoxOAuthSettings(user_id='fa;l', access_token='a;lkjadl;kas')", "        oauth.save()", "        settings.oauth_settings = oauth"]}, {"lines": [""]}, {"lines": ["from . import auth, config  # noqa"]}, {"lines": ["import os"]}, {"lines": ["from box.client import BoxClientException"]}, {"lines": ["from urllib3.exceptions import MaxRetryError"]}, {"lines": ["from website.util import web_url_for"]}, {"lines": ["from website.addons.box.client import get_node_client"]}, {"lines": ["@must_have_permission(permissions.WRITE)"]}, {"lines": ["    }"]}, {"lines": ["        'settings': web_url_for('user_addons'),", "        'auth': node.api_url_for('box_oauth_start'),"]}, {"lines": ["        'files': node.web_url_for('collect_file_trees'),"]}, {"lines": ["        'folders': node.api_url_for('box_list_folders'),"]}, {"lines": ["    valid_credentials = True"]}, {"lines": ["    user_is_owner = user_settings is not None and user_settings.owner == current_user"]}, {"lines": ["        'nodeHasAuth': node_settings.has_auth,"]}, {"lines": ["        'validCredentials': valid_credentials,", "        'userHasAuth': current_user_settings is not None and current_user_settings.has_auth,"]}, {"lines": ["            uid=user_settings.owner._id"]}, {"lines": ["        # path = node_settings.folder"]}, {"lines": [""]}, {"lines": ["        if node_settings.folder_id is None:"]}, {"lines": [""]}, {"lines": ["                'path': path,", "                'name': path.replace('All Files', '', 1) if path != 'All Files' else '/ (Full Box)'"]}, {"lines": ["@must_have_permission(permissions.WRITE)"]}, {"lines": [""]}, {"lines": ["    path = folder['path']", ""]}, {"lines": [""]}, {"lines": ["    }"]}, {"lines": ["@must_have_permission(permissions.WRITE)"]}, {"lines": [""]}, {"lines": ["        'result': serialize_settings(node_addon, auth.user),"]}, {"lines": ["    }"]}, {"lines": ["@must_have_addon('box', 'node')", "@must_have_permission(permissions.WRITE)"]}, {"lines": ["@must_have_permission(permissions.WRITE)"]}, {"lines": ["", "    return {", "        'result': {", "            'emails': [", "                contrib.username", "                for contrib in node_addon.owner.contributors"]}, {"lines": ["            ],", "        }"]}, {"lines": ["", "", "@must_have_addon('box', 'node')", "@must_be_addon_authorizer('box')", "def box_list_folders(node_addon, **kwargs):", "    \"\"\"Returns a list of folders in Box\"\"\"", "    if not node_addon.has_auth:", "        raise HTTPError(http.FORBIDDEN)", "", "    node = node_addon.owner", "    folder_id = request.args.get('folderId')", ""]}, {"lines": ["    if folder_id is None:"]}, {"lines": ["        return [{"]}, {"lines": ["            'path': 'All Files',"]}, {"lines": ["            'addon': 'box',", "            'kind': 'folder',"]}, {"lines": ["            'name': '/ (Full Box)',"]}, {"lines": ["            'urls': {", "                'folders': node.api_url_for('box_list_folders', folderId=0),", "            }", "        }]", "", "    try:", "        client = get_node_client(node)"]}, {"lines": ["        raise HTTPError(http.FORBIDDEN)", "", "    try:", "        metadata = client.get_folder(folder_id)", "    except BoxClientException:", "        raise HTTPError(http.NOT_FOUND)", "    except MaxRetryError:", "        raise HTTPError(http.BAD_REQUEST)", "", "    # Raise error if folder was deleted", "    if metadata.get('is_deleted'):", "        raise HTTPError(http.NOT_FOUND)", ""]}, {"lines": ["    folder_path = '/'.join(", "        [", "            x['name']", "            for x in metadata['path_collection']['entries']", "        ] + [metadata['name']]", "    )", ""]}, {"lines": ["    return [", "        {", "            'addon': 'box',", "            'kind': 'folder',", "            'id': item['id'],", "            'name': item['name'],"]}, {"lines": ["            'path': os.path.join(folder_path, item['name']),"]}, {"lines": ["            'urls': {", "                'folders': node.api_url_for('box_list_folders', folderId=item['id']),", "            }", "        }", "        for item in metadata['item_collection']['entries']", "        if item['type'] == 'folder'", "    ]"]}, {"lines": ["    @property"]}, {"lines": ["        if not user or not self.node.can_edit(user=user):"]}, {"lines": ["    }, http.OK"]}, {"lines": ["    return {'data': data}, http.OK"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def get_node_client(node):", "    node_settings = node.get_addon('dropbox')"]}, {"lines": ["    return get_node_addon_client(node_settings)", "", "", "def get_node_addon_client(node_addon):", "    if node_addon:", "        if node_addon.has_auth:", "            return get_client_from_user_settings(node_addon.user_settings)"]}, {"lines": ["        else:", "            raise AddonError('Node is not authorized')"]}, {"lines": ["import logging"]}, {"lines": [""]}, {"lines": ["try:"]}, {"lines": ["except ImportError as error:"]}, {"lines": ["</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"dropbox_folder_created\">", "created folder"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>"]}, {"lines": ["", "<script type=\"text/html\" id=\"dropbox_file_updated\">", "updated file", "<a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect\">{{ params.path }}</a> to"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>"]}, {"lines": ["import mock"]}, {"lines": ["    DropboxUserSettings, DropboxNodeSettings, DropboxFile"]}, {"lines": ["class TestFileGuid(OsfTestCase):", "    def setUp(self):", "        super(OsfTestCase, self).setUp()", "        self.user = UserFactory()", "        self.project = ProjectFactory(creator=self.user)", "        self.project.add_addon('dropbox', auth=Auth(self.user))", "        self.node_addon = self.project.get_addon('dropbox')", "        self.node_addon.folder = '/baz'"]}, {"lines": ["        self.node_addon.save()"]}, {"lines": ["", "    def test_provider(self):", "        assert_equal('dropbox', DropboxFile().provider)", "", "    def test_correct_path(self):", "        guid = DropboxFile(node=self.project, path='baz/foo/bar')", "", "        assert_equals(guid.path, 'baz/foo/bar')", "        assert_equals(guid.waterbutler_path, '/foo/bar')", ""]}, {"lines": ["    def test_path_doesnt_crash_without_addon(self):", "        guid = DropboxFile(node=self.project, path='baz/foo/bar')", "        self.project.delete_addon('dropbox', Auth(self.user))", "", "        assert_is(self.project.get_addon('dropbox'), None)", "", "        assert_true(guid.path)", "        assert_true(guid.waterbutler_path)"]}, {"lines": ["", "    def test_path_doesnt_crash_nonconfig_addon(self):", "        guid = DropboxFile(node=self.project, path='baz/foo/bar')", "        self.node_addon.folder = None", "        self.node_addon.save()", "        self.node_addon.reload()", "", "        assert_true(guid.path)", "        assert_true(guid.waterbutler_path)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.base.requests.get')", "    def test_unique_identifier(self, mock_get):", "        mock_response = mock.Mock(ok=True, status_code=200)", "        mock_get.return_value = mock_response", "        mock_response.json.return_value = {", "            'data': {", "                'name': 'Morty',", "                'extra': {", "                    'revisionId': 'Ricksy'", "                }", "            }", "        }", "", "        guid = DropboxFile(node=self.project, path='/foo/bar')", "", "        guid.enrich()", "        assert_equals('Ricksy', guid.unique_identifier)", "", "    def test_node_addon_get_or_create(self):", "        guid, created = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        assert_true(created)", "        assert_equal(guid.path, 'baz/foo/bar')", "        assert_equal(guid.waterbutler_path, '/foo/bar')", "", "    def test_node_addon_get_or_create_finds(self):", "        guid1, created1 = self.node_addon.find_or_create_file_guid('/foo/bar')", "        guid2, created2 = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        assert_true(created1)", "        assert_false(created2)", "        assert_equals(guid1, guid2)", "", "    def test_node_addon_get_or_create_finds_changed(self):", "        guid1, created1 = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        self.node_addon.folder = '/baz/foo'"]}, {"lines": ["        self.node_addon.save()", "        self.node_addon.reload()"]}, {"lines": ["        guid2, created2 = self.node_addon.find_or_create_file_guid('/bar')", "", "        assert_true(created1)", "        assert_false(created2)", "        assert_equals(guid1, guid2)", "", ""]}, {"lines": ["    def test_complete_true(self):", "        self.node_settings.user_settings.access_token = 'seems legit'", "", "        assert_true(self.node_settings.has_auth)", "        assert_true(self.node_settings.complete)", "", "    def test_complete_false(self):", "        self.node_settings.user_settings.access_token = 'seems legit'", "        self.node_settings.folder = None", "", "        assert_true(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", "", "    def test_complete_auth_false(self):", "        self.node_settings.user_settings = None", "", "        assert_false(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", ""]}, {"lines": ["            self.project.api_url_for('dropbox_hgrid_data_contents', root=1))"]}, {"lines": ["        assert_equal(folder['name'], self.node_settings.folder)"]}, {"lines": ["            contents = [x for x in mock_client.metadata('', list=True)['contents'] if x['is_dir']]"]}, {"lines": [""]}, {"lines": ["            assert_equal(len(res.json), 1)", "            assert_not_equal(len(res.json), len(contents))"]}, {"lines": ["from framework.exceptions import HTTPError", "from framework.auth.decorators import collect_auth"]}, {"lines": ["from framework.status import push_status_message as flash"]}, {"lines": ["from website.util import api_url_for", "from website.util import web_url_for"]}, {"lines": ["def dropbox_oauth_start(auth, **kwargs):", "    user = auth.user"]}, {"lines": ["@collect_auth", "def dropbox_oauth_finish(auth, **kwargs):"]}, {"lines": ["    if not auth.logged_in:"]}, {"lines": ["    user = auth.user", ""]}, {"lines": [""]}, {"lines": ["from website.project.decorators import must_be_contributor_or_public, must_have_addon"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "@must_be_contributor_or_public", "@must_have_addon('dropbox', 'node')"]}, {"lines": ["", "    if 'root' in request.args:", "        return [{", "            'kind': rubeus.FOLDER,", "            'path': '/',", "            'name': '/ (Full Dropbox)',", "            'urls': {", "                'folders': node.api_url_for('dropbox_hgrid_data_contents'),", "            }", "        }]", ""]}, {"lines": [""]}, {"lines": ["    client = get_node_client(node)"]}, {"lines": ["", "    return [", "        metadata_to_hgrid(file_dict, node, permissions) for", "        file_dict in metadata['contents'] if file_dict['is_dir']", "    ]"]}, {"lines": ["", ""]}, {"lines": ["def dropbox_addon_folder(node_settings, auth, **kwargs):"]}, {"lines": ["    node = node_settings.owner"]}, {"lines": ["from requests_oauthlib import OAuth1Session"]}, {"lines": [""]}, {"lines": ["                resource_owner_secret=owner_secret,", "                signature_type='auth_header'"]}, {"lines": ["        self.last_error = None"]}, {"lines": ["    def _get_last_error(self):", "        e = self.last_error", "        self.last_error = None", "        return e", ""]}, {"lines": [""]}, {"lines": ["            self.last_error = req.status_code"]}, {"lines": ["", "    def _send_with_data(self, url, method='post', output='json', **kwargs):"]}, {"lines": [""]}, {"lines": ["            headers = {'content-type': 'application/json'}", "            req = func(url, headers=headers, **kwargs)"]}, {"lines": ["            self.handle_error(req)"]}, {"lines": [""]}, {"lines": ["            return"]}, {"lines": ["        articles = self._send(", "            os.path.join(node_settings.api_url, 'projects', \"{0}\".format(project_id), 'articles'))"]}, {"lines": ["        return project"]}, {"lines": ["    def articles(self, node_settings):", "        articles = self._send(os.path.join(node_settings.api_url, 'articles'))"]}, {"lines": ["    def article_is_public(self, article):"]}, {"lines": ["    def article(self, node_settings, article_id):", "        res = self._send(", "            os.path.join(node_settings.api_url, 'articles', \"{0}\".format(article_id)))"]}, {"lines": [""]}, {"lines": ["        articles = self._send(\"http://api.figshare.com/v1/my_data/articles\")"]}, {"lines": ["            return self._get_last_error()"]}, {"lines": ["", "        return [{'label': project['title'], 'value': 'project_{0}'.format(project['id'])}", "                for project in projects] + \\"]}, {"lines": ["             for article in articles['items'] if article['defined_type'] == 'fileset']"]}, {"lines": ["from website.util.sanitize import escape_html"]}, {"lines": ["from website.addons.base.exceptions import AddonEnrichmentError", ""]}, {"lines": ["", "class FigshareIsDraftError(AddonEnrichmentError):", ""]}, {"lines": ["    def __init__(self, file_guid):", "        self.file_guid = file_guid", ""]}, {"lines": ["    @property"]}, {"lines": ["    def can_delete(self):", "        return True", "", "    @property"]}, {"lines": ["    def renderable_error(self):"]}, {"lines": ["        return u'''"]}, {"lines": ["        <div class=\"alert alert-info\" role=\"alert\">"]}, {"lines": ["        </div>", "        '''.format(name=escape_html(self.file_guid.name))"]}, {"lines": ["from website.addons.base import GuidFile"]}, {"lines": ["from . import messages"]}, {"lines": ["from . import exceptions as fig_exceptions"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class FigShareGuidFile(GuidFile):", ""]}, {"lines": ["    article_id = fields.StringField(index=True)", "    file_id = fields.StringField(index=True)", "", "    @property"]}, {"lines": ["    def waterbutler_path(self):"]}, {"lines": ["        if getattr(self.node.get_addon('figshare'), 'figshare_type', None) == 'project':"]}, {"lines": ["            return '/{}/{}'.format(self.article_id, self.file_id)"]}, {"lines": [""]}, {"lines": ["        return '/' + str(self.file_id)"]}, {"lines": ["", "    @property", "    def provider(self):", "        return 'figshare'", ""]}, {"lines": ["    def _exception_from_response(self, response):"]}, {"lines": ["        try:", "            if response.json()['data']['extra']['status'] == 'drafts':", "                self._metadata_cache = response.json()['data']", "                raise fig_exceptions.FigshareIsDraftError(self)", "        except KeyError:", "            pass"]}, {"lines": [""]}, {"lines": ["        super(FigShareGuidFile, self)._exception_from_response(response)", ""]}, {"lines": ["    @property", "    def version_identifier(self):", "        return ''"]}, {"lines": [""]}, {"lines": ["    @property", "    def unique_identifier(self):", "        return '{}{}'.format(self.article_id, self.file_id)"]}, {"lines": ["", ""]}, {"lines": ["    oauth_access_token_secret = fields.StringField()"]}, {"lines": [""]}, {"lines": ["    figshare_title = fields.StringField()", ""]}, {"lines": ["    user_settings = fields.ForeignField("]}, {"lines": [""]}, {"lines": ["    def find_or_create_file_guid(self, path):", "        # path should be /aid/fid"]}, {"lines": ["        # split return ['', aid, fid] or ['', fid]", "        split_path = path.split('/')", "        if len(split_path) == 3:", "            _, article_id, file_id = split_path", "        else:", "            _, file_id = split_path", "            article_id = self.figshare_id"]}, {"lines": ["            node=self.owner,", "            file_id=file_id,"]}, {"lines": ["    @property", "    def api_url(self):", "        if self.user_settings is None:", "            return figshare_settings.API_URL", "        else:", "            return figshare_settings.API_OAUTH_URL", ""]}, {"lines": ["    @property", "    def has_auth(self):"]}, {"lines": ["        return bool(self.user_settings and self.user_settings.has_auth)"]}, {"lines": [""]}, {"lines": ["    def complete(self):", "        return self.has_auth and self.figshare_id is not None", "", "    @property"]}, {"lines": ["            url = self.owner.web_url_for('addon_view_or_download_file', provider='figshare', path=metadata['path'])"]}, {"lines": ["                'view': url,", "                'download': url + '?action=download'"]}, {"lines": ["", "        figshare_user = user.get_addon('figshare')", ""]}, {"lines": ["            'figshare_title': self.figshare_title or '',"]}, {"lines": ["            'node_has_auth': self.has_auth,"]}, {"lines": ["        if self.has_auth:"]}, {"lines": ["                'authorized_user': self.user_settings.owner.fullname,", "                'owner_url': self.user_settings.owner.url,", "                'is_owner': user == self.user_settings.owner", "            })"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        if not self.figshare_id:", "            return []"]}, {"lines": [""]}, {"lines": ["        connect = Figshare.from_settings(self.user_settings)"]}, {"lines": ["        article_is_public = connect.article_is_public(self.figshare_id)", ""]}, {"lines": ["        article_permissions = 'public' if article_is_public else 'private'"]}, {"lines": ["            return [message]"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                user=removed.fullname,"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            return AddonFigShareNodeSettings(), message"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def project_to_hgrid(node, project, user, expand=False, folders_only=False):"]}, {"lines": ["    if project:"]}, {"lines": ["            hgrid = article_to_hgrid(node, user, article, expand, folders_only)"]}, {"lines": ["    return []"]}, {"lines": [""]}, {"lines": ["def article_to_hgrid(node, user, article, expand=False, folders_only=False):"]}, {"lines": [""]}, {"lines": ["    if article['defined_type'] == 'fileset' or not article['files']:"]}, {"lines": ["        if expand:", "            return [file_to_hgrid(node, article, item) for item in article['files']]", "        return {"]}, {"lines": ["            'name': '{0}:{1}'.format(article['title'] or 'Unnamed', article['article_id']),  # Is often blank?"]}, {"lines": ["            'kind': 'folder' if article['files'] else 'folder',  # TODO Change me"]}, {"lines": ["                'upload': '{base}figshare/{aid}/'.format(base=node.api_url, aid=article['article_id']),"]}, {"lines": ["                'delete': '' if article['status'] == 'public' else node.api_url + 'figshare/' + str(article['article_id']) + '/file/{id}/delete/',"]}, {"lines": ["                'download': '',"]}, {"lines": ["                'fetch': '{base}figshare/hgrid/article/{aid}/'.format(base=node.api_url, aid=article['article_id']),"]}, {"lines": ["                'view': ''", "            },", "            'permissions': {"]}, {"lines": ["                'edit': article['status'] != 'Public',  # This needs to be something else"]}, {"lines": ["                'view': True,"]}, {"lines": ["                'download': article['status'] == 'Public'"]}, {"lines": ["            }", "        }", "    else:"]}, {"lines": ["        return file_to_hgrid(node, article, article['files'][0])", "", "", "def file_to_hgrid(node, article, item):"]}, {"lines": ["    urls = {", "        'upload': '',"]}, {"lines": ["        'delete': '{base}figshare/article/{aid}/file/{fid}/'.format(base=node.api_url, aid=article['article_id'], fid=item.get('id')),"]}, {"lines": ["        'download': item.get('download_url'),"]}, {"lines": ["        'view': '/{base}/figshare/article/{aid}/file/{fid}'.format(base=node._id, aid=article['article_id'], fid=item.get('id'))"]}, {"lines": ["    }", "    permissions = {"]}, {"lines": ["        'edit': article['status'] != 'Public',"]}, {"lines": ["        'view': True,", "        'download': article['status'] == 'Public'", "    }", "", "    return {"]}, {"lines": ["        'addon': 'figshare',"]}, {"lines": ["        'name': item['name'],"]}, {"lines": ["        'published': '',", "        'tags': '',", "        'description': '',", "        'authors': '',", "        'status': article['status'],", "        'versions': '',"]}, {"lines": ["        'permissions': permissions,", "        'size': item.get('size'),", "        'thumbnail': item.get('thumb') or '',", "    }", "", "", "# TODO Finish me", "def build_figshare_urls(node, project_id, file_id=None):", "    urls = {", "        'upload': '',", "        'delete': '',", "        'download': '',", "        'view': ''", "    }", "    return urls"]}, {"lines": ["};"]}, {"lines": ["import mock"]}, {"lines": ["from website.addons.figshare import model", "from website.addons.figshare import exceptions"]}, {"lines": [""]}, {"lines": ["class TestFileGuid(OsfTestCase):", "", "    def setUp(self):", "        super(OsfTestCase, self).setUp()", "        self.user = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.user)"]}, {"lines": ["        self.project.add_addon('figshare', auth=Auth(self.user))", "        self.node_addon = self.project.get_addon('figshare')", "        self.node_addon.figshare_id = 8", "        self.node_addon.figshare_type = 'project'", "        self.node_addon.save()"]}, {"lines": ["", "    def test_provider(self):", "        assert_equal(", "            'figshare',", "            model.FigShareGuidFile().provider", "        )", ""]}, {"lines": ["    def test_path_doesnt_crash_without_addon(self):", "        guid = model.FigShareGuidFile(node=self.project, path='/baz/foo/bar')", "        self.project.delete_addon('figshare', Auth(self.user))", "", "        assert_is(self.project.get_addon('figshare'), None)", "", "        assert_true(guid.path)", "        assert_true(guid.waterbutler_path)", ""]}, {"lines": ["    def test_path_doesnt_crash_nonconfig_addon(self):", "        guid = model.FigShareGuidFile(node=self.project, path='/baz/foo/bar')", "        self.node_addon.figshare_type = None", "        self.node_addon.figshare_id = None", "        self.node_addon.save()", "        self.node_addon.reload()", "", "        assert_true(guid.path)", "        assert_true(guid.waterbutler_path)", ""]}, {"lines": ["    def test_mfr_test_path(self):"]}, {"lines": ["        self.node_addon.figshare_type = 'fileset'", "        self.node_addon.save()", "        self.node_addon.reload()", "", "        guid = model.FigShareGuidFile(file_id=2, article_id=4, node=self.project)", "        assert_equal(guid.waterbutler_path, '/2')", "", "    def test_correct_path_project(self):", "        guid = model.FigShareGuidFile(file_id=2, article_id=4, node=self.project)"]}, {"lines": ["        assert_equal(guid.waterbutler_path, '/4/2')"]}, {"lines": ["", "    def test_unique_identifier(self):", "        guid = model.FigShareGuidFile(file_id=2, article_id=4)", "        assert_equal(guid.unique_identifier, '42')", "", "    def test_exception_from_response(self):", "        mock_response = mock.Mock()", "        mock_response.json.return_value = {", "            'data': {", "                'name': 'Morty',", "                'extra': {", "                    'status': 'drafts'", "                }", "            }", "        }", "        guid = model.FigShareGuidFile(file_id=2, article_id=4)", "", "        with assert_raises(exceptions.FigshareIsDraftError):", "            guid._exception_from_response(mock_response)", "", "        assert_equal(guid.name, 'Morty')", "", "    @mock.patch('website.addons.base.requests.get')", "    def test_enrich_raises(self, mock_get):", "        mock_response = mock.Mock(ok=True, status_code=200)", "        mock_get.return_value = mock_response", "        mock_response.json.return_value = {", "            'data': {", "                'name': 'Morty',", "                'extra': {", "                    'status': 'drafts'", "                }", "            }", "        }", "", "        guid = model.FigShareGuidFile(file_id=2, article_id=4, node=self.project)", "", "        with assert_raises(exceptions.FigshareIsDraftError):", "            guid.enrich()", "", "        assert_equal(guid.name, 'Morty')", "", "    @mock.patch('website.addons.base.requests.get')", "    def test_enrich_works(self, mock_get):", "        mock_response = mock.Mock(ok=True, status_code=200)", "        mock_get.return_value = mock_response", "        mock_response.json.return_value = {", "            'data': {", "                'name': 'Morty',", "                'extra': {", "                    'status': 'Rick'", "                }", "            }", "        }", "", "        guid = model.FigShareGuidFile(file_id=2, article_id=4, node=self.project)", "", "        guid.enrich()", "", "        assert_equal(guid.name, 'Morty')", "", "    def test_node_addon_get_or_create(self):"]}, {"lines": ["        guid, _ = self.node_addon.find_or_create_file_guid('/4/2')"]}, {"lines": ["        assert_equal(guid.waterbutler_path, '/4/2')"]}, {"lines": ["        assert_equal(guid.file_id, '2')", "        assert_equal(guid.article_id, '4')", "", "    def test_node_addon_get_or_create_finds(self):"]}, {"lines": ["        guid, created = self.node_addon.find_or_create_file_guid('/4/2')"]}, {"lines": ["        assert_true(created)", ""]}, {"lines": ["        other, other_created = self.node_addon.find_or_create_file_guid('/4/2')"]}, {"lines": ["        assert_false(other_created)", "        assert_equal(guid, other)", ""]}, {"lines": ["class TestNodeSettings(OsfTestCase):", "    def setUp(self):", "        super(TestNodeSettings, self).setUp()", "        self.user = AuthUserFactory()", "        self.project = ProjectFactory(creator=self.user)", "", "        self.project.add_addon('figshare', auth=Auth(self.user))", "        self.project.creator.add_addon('figshare')", "        self.node_settings = self.project.get_addon('figshare')", "        self.user_settings = self.project.creator.get_addon('figshare')", "        self.user_settings.oauth_access_token = 'legittoken'", "        self.user_settings.oauth_access_token_secret = 'legittoken'", "        self.user_settings.save()", "        self.node_settings.user_settings = self.user_settings", "        self.node_settings.figshare_id = '123456'", "        self.node_settings.figshare_type = 'project'", "        self.node_settings.figshare_title = 'singlefile'", "        self.node_settings.save()", "", "    def test_complete_true(self):", "        assert_true(self.node_settings.has_auth)", "        assert_true(self.node_settings.complete)", "", "    def test_complete_false(self):", "        self.node_settings.figshare_id = None", "", "        assert_true(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", "", "    def test_complete_auth_false(self):", "        self.node_settings.user_settings = None", "", "        assert_false(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", ""]}, {"lines": [""]}, {"lines": ["        self.user = AuthUserFactory()", "        self.consolidated_auth = Auth(user=self.user)", "        self.auth = ('test', self.user.api_keys[0]._primary_key)", "        self.project = ProjectFactory(creator=self.user)", "", "        self.non_authenticator = AuthUserFactory()"]}, {"lines": ["            auth=Auth(self.project.creator),"]}, {"lines": ["        self.project.add_addon('figshare', auth=self.consolidated_auth)"]}, {"lines": ["        self.user_settings.oauth_access_token = 'legittoken'", "        self.user_settings.oauth_access_token_secret = 'legittoken'", "        self.user_settings.save()"]}, {"lines": ["        self.node_settings.figshare_type = 'project'"]}, {"lines": ["        self.node_settings.figshare_title = 'singlefile'"]}, {"lines": ["        }"]}, {"lines": ["        assert_equals(len(self.project.logs), num_logs + 1)"]}, {"lines": ["        }"]}, {"lines": ["        assert_equals(len(self.project.logs), num_logs + 1)"]}, {"lines": ["        }"]}, {"lines": ["        assert_equals(len(self.project.logs), num_logs + 1)"]}, {"lines": ["            'adad': 131313,"]}, {"lines": ["        }"]}, {"lines": ["    def test_api_url_no_user(self):", "        self.node_settings.user_settings = None", "        self.node_settings.save()", "        assert_equal(self.node_settings.api_url, figshare_settings.API_URL)"]}, {"lines": ["    def test_api_url(self):", "        assert_equal(self.node_settings.api_url, figshare_settings.API_OAUTH_URL)"]}, {"lines": ["        )"]}, {"lines": ["        msg = self.node_settings.after_remove_contributor("]}, {"lines": ["", "        assert_in("]}, {"lines": ["            msg"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["    #TODO Test figshare options and figshare to_json"]}, {"lines": ["    figshare_mock.project.return_value = {'articles': [{u'status': u'Draft', u'files': [{u'thumb': None, u'download_url': u'http://files.figshare.com/1348803/0NUTZ', u'name': u'0NUTZ', u'id': 1348803, u'mime_type': u'text/plain', u'size': u'0 KB'}, {u'thumb': None, u'download_url': u'http://files.figshare.com/1348805/0MNXS', u'name': u'0MNXS', u'id': 1348805, u'mime_type': u'text/plain', u'size': u'0 KB'}, {u'thumb': None, u'download_url': u'http://files.figshare.com/1348806/0NUTZ', u'name': u'0NUTZ', u'id': 1348806, u'mime_type': u'text/plain', u'size': u'0 KB'}, {u'thumb': None, u'download_url': u'http://files.figshare.com/1348807/0OX1G', u'name': u'0OX1G', u'id': 1348807, u'mime_type': u'text/plain', u'size': u'0 KB'}, {u'thumb': u'http://previews.figshare.com/1350751/250_1350751.jpg', u'download_url': u'http://files.figshare.com/1350751/Selection_003.png', u'name': u'Selection_003.png', u'id': 1350751, u'mime_type': u'image/png', u'size': u'18 KB'}, {u'thumb': u'http://previews.figshare.com/1350754/250_1350754.jpg', u'download_url': u'http://files.figshare.com/1350754/Selection_003.png', u'name': u'Selection_003.png', u'id': 1350754, u'mime_type': u'image/png', u'size': u'18 KB'}], u'description': u'<p>This is made using python</p>', u'links': [], u'title': u'New fileset', u'total_size': u'34.59 KB', u'master_publisher_id': 0, u'authors': [{u'first_name': u'Samuel', u'last_name': u'Chrisinger', u'id': 506241, u'full_name': u'Samuel Chrisinger'}], u'defined_type': u'fileset', u'version': 15, u'categories': [{u'id': 77, u'name': u'Applied Computer Science'}], u'published_date': u'22:13, Jan 16, 2014', u'description_nohtml': u'This is made using python', u'article_id': 902210, u'tags': [{u'id': 3564, u'name': u'code'}]}, {u'status': u'Drafts', u'files': [{u'id': 1404749, u'name': u'HW6.pdf', u'thumb': u'http://figshare.com/read/private/1404749/250_1404749.png', u'mime_type': u'application/pdf', u'size': u'177 KB'}], u'description': u'', u'links': [], u'title': u'HW6.pdf', u'total_size': u'172.82 KB', u'master_publisher_id': 0, u'authors': [{u'first_name': u'Samuel', u'last_name': u'Chrisinger', u'id': 506241, u'full_name': u'Samuel Chrisinger'}], u'defined_type': u'paper', u'version': 1, u'categories': [], u'published_date': u'09:25, Feb 24, 2014', u'description_nohtml': u'', u'article_id': 949657, u'tags': []}], u'description': u'', u'created': u'06/03/2014', u'id': 862, u'title': u'OSF Test'}"]}, {"lines": ["from framework.auth.decorators import collect_auth", "from framework.auth.decorators import must_be_logged_in"]}, {"lines": ["from website.project.decorators import must_have_addon", "from website.project.decorators import must_have_permission"]}, {"lines": ["def figshare_oauth_start(auth, **kwargs):", "    user = auth.user"]}, {"lines": ["        raise HTTPError(http.FORBIDDEN)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        action='figshare_content_unlinked',", "        params={", "            'project': node.parent_id,", "            'node': node._id,", "            'figshare': {"]}, {"lines": ["            }", "        },", "        auth=auth,", "    )"]}, {"lines": ["@collect_auth", "def figshare_oauth_callback(auth, **kwargs):"]}, {"lines": ["    user = auth.user"]}, {"lines": [""]}, {"lines": ["        figshare_user.oauth_request_token,"]}, {"lines": ["    if not access_token or not access_token_secret:"]}, {"lines": ["", "    if node:", "        figshare_node = node.get_addon('figshare')", ""]}, {"lines": [""]}, {"lines": ["    node = node_settings.owner"]}, {"lines": ["    if node_settings.figshare_type == 'project':", "        item = Figshare.from_settings(node_settings.user_settings).project(node_settings, node_settings.figshare_id)", "    else:", "        item = Figshare.from_settings(node_settings.user_settings).article(node_settings, node_settings.figshare_id)", "    if not node_settings.figshare_id or not node_settings.has_auth or not item:"]}, {"lines": ["        return"]}, {"lines": ["    #TODO Test me", "    #Throw error if neither", "    node_settings.figshare_title = item.get('title') or item['items'][0]['title']"]}, {"lines": ["    node_settings.save()"]}, {"lines": ["    return [", "        rubeus.build_addon_root("]}, {"lines": ["            nodeUrl=node.url, nodeApiUrl=node.api_url,"]}, {"lines": ["            extra={"]}, {"lines": ["                'status': (item.get('articles') or item['items'])[0]['status'].lower()"]}, {"lines": ["            }"]}, {"lines": ["        )", "    ]"]}, {"lines": ["import github3"]}, {"lines": ["from requests.adapters import HTTPAdapter"]}, {"lines": ["default_adapter = HTTPAdapter()"]}, {"lines": ["            self.gh3 = github3.login(token=access_token)"]}, {"lines": ["            self.gh3 = github3.GitHub()"]}, {"lines": ["            self.gh3._session.mount('https://api.github.com/user', default_adapter)"]}, {"lines": ["        return self.gh3.user(user)"]}, {"lines": [""]}, {"lines": ["from website.util.sanitize import escape_html", "from website.addons.base.exceptions import AddonEnrichmentError", ""]}, {"lines": ["    pass", "", "", "class TooBigToRenderError(AddonEnrichmentError):", "", "    def __init__(self, file_guid):", "        self.file_guid = file_guid", "", "    @property"]}, {"lines": ["    def renderable_error(self):"]}, {"lines": ["        return '''", "        <div class=\"alert alert-info\" role=\"alert\">", "        The file \"{name}\" is too large to be retrieved from Github for rendering.", "        </div>", "        '''.format(name=escape_html(self.file_guid.name))"]}, {"lines": ["var m = require('mithril');"]}, {"lines": ["function _uploadUrl(item, file) {"]}, {"lines": ["}", ""]}, {"lines": ["// TODO: Refactor, repeating from core function too much", "function _removeEvent (event, items) {", "    var tb = this;", "    function cancelDelete() {", "        tb.modal.dismiss();", "    }"]}, {"lines": [""]}, {"lines": ["    function runDelete (item) {", "        tb.select('.tb-modal-footer .text-danger').html('<i> Deleting...</i>').css('color', 'grey');;", "        // delete from server, if successful delete from view", "        $.ajax({", "            url: waterbutler.buildTreeBeardDelete(item, {branch: item.data.branch, sha: item.data.extra.fileSha}),"]}, {"lines": ["        }).done(function (data) {"]}, {"lines": ["        }).fail(function (data) {"]}, {"lines": ["        });", "    }"]}, {"lines": [""]}, {"lines": ["    function runDeleteMultiple(items){", "        items.forEach(function(item){", "            runDelete(item);", "        });"]}, {"lines": ["    }"]}, {"lines": ["    // If there is only one item being deleted, don't complicate the issue:", "    if(items.length === 1) {", "        var parent = items[0].parent();", "        var mithrilContentSingle = m('div', [", "            m('h3.break-word', 'Delete \"' + items[0].data.name + '\"'),", "            m('p', 'This action is irreversible.'),", "            parent.children.length < 2 ? m('p', 'If a folder in Github has no children it will automatically be removed.') : ''", "        ]);", "        var mithrilButtonsSingle = m('div', [", "            m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function() { cancelDelete(); } }, 'Cancel'),", "            m('span.tb-modal-btn', { 'class' : 'text-danger', onclick : function() { runDelete(items[0]); }  }, 'Delete')", "        ]);", "        // This is already being checked before this step but will keep this edit permission check", "        if(items[0].data.permissions.edit){", "            tb.modal.update(mithrilContentSingle, mithrilButtonsSingle);", "        }", "    } else {", "        // Check if all items can be deleted", "        var canDelete = true;", "        var deleteList = [];", "        var noDeleteList = [];", "        var mithrilContentMultiple;", "        var mithrilButtonsMultiple;", "        items.forEach(function(item, index, arr){", "            if(!item.data.permissions.edit){", "                canDelete = false;", "                noDeleteList.push(item);", "            } else {", "                deleteList.push(item);", "            }", "        });", "        // If all items can be deleted", "        if(canDelete){", "            mithrilContentMultiple = m('div', [", "                    m('h3.break-word', 'Delete multiple files?'),", "                    m('p', 'This action is irreversible.'),", "                    deleteList.map(function(item){", "                        return m('.fangorn-canDelete.text-success', item.data.name);", "                    })", "                ]);", "            mithrilButtonsMultiple =  m('div', [", "                    m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function() { cancelDelete(); } }, 'Cancel'),", "                    m('span.tb-modal-btn', { 'class' : 'text-danger', onclick : function() { runDeleteMultiple.call(tb, deleteList); }  }, 'Delete All')", "                ]);", "        } else {", "            mithrilContentMultiple = m('div', [", "                    m('h3.break-word', 'Delete multiple files?'),", "                    m('p', 'Some of these files can\\'t be deleted but you can delete the ones highlighted with green. This action is irreversible.'),", "                    deleteList.map(function(n){", "                        return m('.fangorn-canDelete.text-success', n.data.name);", "                    }),", "                    noDeleteList.map(function(n){", "                        return m('.fangorn-noDelete.text-warning', n.data.name);", "                    })", "                ]);", "            mithrilButtonsMultiple =  m('div', [", "                    m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function() { cancelDelete(); } }, 'Cancel'),", "                    m('span.tb-modal-btn', { 'class' : 'text-danger', onclick : function() { runDeleteMultiple.call(tb, deleteList); }  }, 'Delete Some')", "                ]);", "        }", "        tb.modal.update(mithrilContentMultiple, mithrilButtonsMultiple);", "    }"]}, {"lines": [""]}, {"lines": ["    return true; // Let fangorn know this config option was used.", "}"]}, {"lines": ["            buttons.push("]}, {"lines": ["        }"]}, {"lines": ["        if(item.data.provider && !item.data.isAddonRoot && item.data.permissions && item.data.permissions.edit) {", "            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function() {", "                        tb.toolbarMode(Fangorn.Components.toolbarModes.RENAME);", "                    },", "                    tooltip: 'Change the name of the item',", "                    icon: 'fa fa-font',", "                    className : 'text-info'", "                }, 'Rename')", "            );", "        }", ""]}, {"lines": ["", "function changeBranch(item, ref){"]}, {"lines": ["    this.updateFolder(null, item);", "}", "", "function _resolveLazyLoad(item) {"]}, {"lines": ["}", ""]}, {"lines": ["    var tb = this;"]}, {"lines": ["        ]);", "    } else {"]}, {"lines": ["                }, item.data.name)]);"]}, {"lines": ["}"]}, {"lines": ["function _fangornColumns (item) {"]}, {"lines": ["    var columns = [];"]}, {"lines": ["        data : 'name',", "        folderIcons : true,", "        filter: true,", "        custom : _fangornGithubTitle", "    });"]}, {"lines": ["        {", "            data  : 'downloads',", "            filter : false,", "            css : ''", "        });"]}, {"lines": ["    return columns;", "}"]}, {"lines": ["function _fangornFolderIcons(item){", "    if(item.data.iconUrl){"]}, {"lines": ["    return undefined;", "}", "", "function _fangornUploadComplete(item){"]}, {"lines": ["    var index = this.returnIndex(item.id);", "}", ""]}, {"lines": ["// Register configuration", "Fangorn.config.github = {", "    // Handle changing the branch select"]}, {"lines": ["    uploadUrl: _uploadUrl,"]}, {"lines": ["    lazyload: _resolveLazyLoad,", "    resolveRows: _fangornColumns,", "    folderIcon: _fangornFolderIcons,"]}, {"lines": ["};"]}, {"lines": ["from github3.repos import Repository", ""]}, {"lines": ["from website.addons.github.exceptions import TooBigToRenderError"]}, {"lines": ["class TestFileGuid(OsfTestCase):", "", "    def setUp(self):", "        super(OsfTestCase, self).setUp()", "        self.user = UserFactory()", "        self.project = ProjectFactory(creator=self.user)", "", "        self.project.add_addon('github', auth=Auth(self.user))", "        self.node_addon = self.project.get_addon('github')", "", "    def test_provider(self):", "        assert_equal('github', GithubGuidFile().provider)", "", "    def test_correct_path(self):", "        guid, _ = self.node_addon.find_or_create_file_guid('perth')", "        assert_equal(guid.waterbutler_path, 'perth')", "        assert_equal(guid.waterbutler_path, guid.path)", ""]}, {"lines": ["    def test_extra_without_metadata(self):", "        guid, _ = self.node_addon.find_or_create_file_guid('perth')", "", "        assert_equal(guid.extra, {})", ""]}, {"lines": ["    @mock.patch('website.addons.base.requests.get')", "    def test_unique_identifier(self, mock_get):", "        mock_response = mock.Mock(ok=True, status_code=200)", "        mock_get.return_value = mock_response", "        mock_response.json.return_value = {", "            'data': {", "                'name': 'Morty',", "                'extra': {", "                    'fileSha': 'Im a little tea pot'", "                }", "            }", "        }", "", "        guid, _ = self.node_addon.find_or_create_file_guid('perth')", "        guid.enrich()", "", "        assert_equal(guid.unique_identifier, 'Im a little tea pot')", "", "    def test_exception_from_response(self):", "        mock_response = mock.Mock()", "        mock_response.json.return_value = {'errors': [{'code': 'too_large'}]}", "", "        guid, _ = self.node_addon.find_or_create_file_guid('perth')", "", "        with assert_raises(TooBigToRenderError):", "            guid._exception_from_response(mock_response)", "", "    def test_node_addon_get_or_create(self):", "        guid, created = self.node_addon.find_or_create_file_guid('/4/2')", "", "        assert_true(created)", "        assert_equal(guid.waterbutler_path, '/4/2')", "", "    def test_node_addon_get_or_create_finds(self):", "        guid1, created1 = self.node_addon.find_or_create_file_guid('/foo/bar')", "        guid2, created2 = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        assert_true(created1)", "        assert_false(created2)", "        assert_equals(guid1, guid2)", "", ""]}, {"lines": [""]}, {"lines": ["        mock_repo.return_value = Repository.from_json({'private': False})"]}, {"lines": ["        mock_repo.return_value = Repository.from_json({'private': True})"]}, {"lines": ["        mock_repo.return_value = Repository.from_json({'private': False})"]}, {"lines": ["        mock_repo.return_value = Repository.from_json({'private': True})"]}, {"lines": ["        self.user = UserFactory()", "        self.user.add_addon('github')", "        self.user_settings = self.user.get_addon('github')", "        self.oauth_settings = AddonGitHubOauthSettings(oauth_access_token='foobar')"]}, {"lines": ["            owner=ProjectFactory(),"]}, {"lines": ["    def test_complete_true(self):", "        assert_true(self.node_settings.has_auth)", "        assert_true(self.node_settings.complete)", "", "    def test_complete_false(self):", "        self.node_settings.user = None", "", "        assert_true(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", "", "    def test_complete_repo_false(self):", "        self.node_settings.repo = None", "", "        assert_true(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", "", "    def test_complete_auth_false(self):", "        self.node_settings.user_settings = None", "", "        assert_false(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", ""]}, {"lines": ["", "    def test_to_json_noauthorizing_authed_user(self):", "        user = UserFactory()", "        user.add_addon('github')", "        user_settings = user.get_addon('github')", "", "        oauth_settings = AddonGitHubOauthSettings(oauth_access_token='foobar')", "        oauth_settings.github_user_id = 'testuser'", "        oauth_settings.save()", "", "        user_settings.oauth_settings = self.oauth_settings", "        user_settings.save()", "", "        self.node_settings.to_json(user)"]}, {"lines": ["from website.addons.github import views, utils"]}, {"lines": ["from website.addons.github.utils import check_permissions", "from website.addons.github.tests.utils import create_mock_github", ""]}, {"lines": ["        self.node_settings.user = self.github.repo.return_value.owner.login", "        self.node_settings.repo = self.github.repo.return_value.name"]}, {"lines": ["            branch = self.github.repo.return_value.default_branch"]}, {"lines": ["            if each.name == branch:", "                branch_sha = each.commit.sha"]}, {"lines": ["            github_mock.repo.return_value.default_branch"]}, {"lines": ["        url = self.project.api_url + 'fork/before/'"]}, {"lines": ["        mock_repository.to_json.return_value = {", "            'user': 'fred',", "            'repo': 'mock-repo',", "            'permissions': {", "                'push': False,  # this is key", "            },", "        }"]}, {"lines": ["        url = node.web_url_for('addon_view_or_download_file', path=path, provider='github')", "        expected_urls = {", "            'view': '{0}?ref={1}'.format(url, sha),", "            'download': '{0}?action=download&ref={1}'.format(url, sha)", "        }", "", "        assert_equal(urls['view'], expected_urls['view'])", "        assert_equal(urls['download'], expected_urls['download'])"]}, {"lines": ["from . import auth, config, crud, hgrid, hooks, repos  # noqa"]}, {"lines": ["from oauthlib.oauth2 import InvalidGrantError"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from website.addons.googledrive import exceptions"]}, {"lines": [""]}, {"lines": ["", "        try:", "            return client.refresh_token("]}, {"lines": ["                **extra", "            )", "        except InvalidGrantError:", "            raise exceptions.ExpiredAuthError()"]}, {"lines": ["import os"]}, {"lines": ["from urllib import unquote"]}, {"lines": ["from datetime import datetime", ""]}, {"lines": [""]}, {"lines": ["from website.addons.googledrive.utils import GoogleDriveNodeLogger"]}, {"lines": ["        return self.path.replace(self.folder, '', 1)"]}, {"lines": ["    def file_name(self):", "        if self.revision:", "            return '{0}_{1}_{2}.html'.format(self._id, self.revision, base64.b64encode(self.folder))", "        return '{0}_{1}_{2}.html'.format(self._id, self.unique_identifier, base64.b64encode(self.folder))", "", "    @property"]}, {"lines": ["    def folder(self):"]}, {"lines": ["        addon = self.node.get_addon('googledrive')", "        if not addon:", "            return ''  # Must return a str value this will error out properly later", "", "        folder = addon.folder_path", ""]}, {"lines": ["            return ''"]}, {"lines": [""]}, {"lines": ["        return '/' + folder"]}, {"lines": ["", "    @property"]}, {"lines": ["    username = fields.StringField()"]}, {"lines": ["    refresh_token = fields.StringField()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "    @property"]}, {"lines": ["", "    folder_id = fields.StringField(default=None)", "    folder_path = fields.StringField(default=None)", ""]}, {"lines": ["    @property", "    def folder_name(self):"]}, {"lines": ["        if not self.folder_id:", "            return None"]}, {"lines": ["", "        if self.folder_path != '/':"]}, {"lines": ["            return unquote(os.path.split(self.folder_path)[1])"]}, {"lines": ["", "        return '/ (Full Google Drive)'"]}, {"lines": ["    @property", "    def complete(self):", "        return self.has_auth and self.folder_id is not None", ""]}, {"lines": ["        if add_log:"]}, {"lines": ["            extra = {'folder': self.folder_name}"]}, {"lines": ["            nodelogger = GoogleDriveNodeLogger(node=self.owner, auth=auth)", "            nodelogger.log(action=\"node_deauthorized\", extra=extra, save=True)"]}, {"lines": ["        self.folder_id = None", "        self.folder_path = None"]}, {"lines": ["        self.save()", "", "    def set_folder(self, folder, auth, add_log=True):", "        self.folder_id = folder['id']", "        self.folder_path = folder['path']"]}, {"lines": ["        if add_log:", "            nodelogger = GoogleDriveNodeLogger(node=self.owner, auth=auth)", "            nodelogger.log(action=\"folder_selected\", save=True)"]}, {"lines": ["        if not self.folder_id:"]}, {"lines": ["", "        return {", "            'folder': {", "                'id': self.folder_id,", "                'name': self.folder_name,", "                'path': self.folder_path", "            }", "        }"]}, {"lines": ["                'folder': self.folder_path,"]}, {"lines": ["        path = os.path.join(self.folder_path, path.lstrip('/'))"]}, {"lines": ["        if self.folder_path != '/':"]}, {"lines": ["            path = '/' + path"]}, {"lines": ["from urllib import quote"]}, {"lines": ["        'files': node.web_url_for('collect_file_trees'),", "        'config': node.api_url_for('googledrive_config_put'),"]}, {"lines": ["        'importAuth': node.api_url_for('googledrive_import_user_auth'),"]}, {"lines": ["    user_is_owner = user_settings is not None and user_settings.owner == current_user", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        path = node_settings.folder_path"]}, {"lines": ["        if path is not None:"]}, {"lines": ["        ret['urls']['owner'] = web_url_for('profile_view_id', uid=user_settings.owner._id)"]}, {"lines": ["    return ret"]}, {"lines": ["    # quote fails on unicode objects with unicode characters", "    # covert to str with .encode('utf-8')", "    safe_name = quote(item['title'].encode('utf-8'), safe='')"]}, {"lines": ["    path = os.path.join(path, safe_name)"]}, {"lines": [""]}, {"lines": ["        'path': path,"]}, {"lines": ["        'name': safe_name,", "        'addon': 'googledrive',", "        'urls': build_googledrive_urls(item, node, path=path)"]}, {"lines": ["REFRESH_TIME = 5 * 60  # 5 minutes", ""]}, {"lines": ["from datetime import datetime"]}, {"lines": ["import mock", "from dateutil import relativedelta", ""]}, {"lines": ["", "class TestFileGuid(OsfTestCase):", "    def setUp(self):", "        super(OsfTestCase, self).setUp()", "        self.user = UserFactory()", "        self.project = ProjectFactory(creator=self.user)", "        self.project.add_addon('googledrive', auth=Auth(self.user))", "        self.node_addon = self.project.get_addon('googledrive')", "", "        self.node_addon.folder_id = 'Lulz'", "        self.node_addon.folder_path = 'baz'", "        self.node_addon.save()", ""]}, {"lines": ["    def test_path_doesnt_crash_without_addon(self):", "        guid = GoogleDriveGuidFile(node=self.project, path='/baz/foo/bar')", "        self.project.delete_addon('googledrive', Auth(self.user))", "", "        assert_is(self.project.get_addon('googledrive'), None)", "", "        assert_true(guid.path)", "        assert_true(guid.waterbutler_path)", ""]}, {"lines": ["    def test_path_doesnt_crash_nonconfig_addon(self):", "        guid = GoogleDriveGuidFile(node=self.project, path='/baz/foo/bar')", "        self.node_addon.folder_id = None", "        self.node_addon.folder_path = None", "        self.node_addon.save()", "        self.node_addon.reload()", "", "        assert_true(guid.path)", "        assert_true(guid.waterbutler_path)", ""]}, {"lines": ["    def test_provider(self):", "        assert_equal('googledrive', GoogleDriveGuidFile().provider)", "", "    def test_correct_path(self):", "        guid = GoogleDriveGuidFile(node=self.project, path='/baz/foo/bar')", "", "        assert_equals(guid.path, '/baz/foo/bar')", "        assert_equals(guid.waterbutler_path, '/foo/bar')", "", "    @mock.patch('website.addons.base.requests.get')", "    def test_unique_identifier(self, mock_get):", "        mock_response = mock.Mock(ok=True, status_code=200)", "        mock_get.return_value = mock_response", "        mock_response.json.return_value = {", "            'data': {", "                'name': 'Morty',", "                'extra': {", "                    'revisionId': 'Ricksy'", "                }", "            }", "        }", "", "        guid = GoogleDriveGuidFile(node=self.project, path='/foo/bar')", "", "        guid.enrich()", "        assert_equals('Ricksy', guid.unique_identifier)", "", "    def test_node_addon_get_or_create(self):", "        guid, created = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        assert_true(created)", "        assert_equal(guid.path, '/baz/foo/bar')", "        assert_equal(guid.waterbutler_path, '/foo/bar')", "", "    def test_node_addon_get_or_create_finds(self):", "        guid1, created1 = self.node_addon.find_or_create_file_guid('/foo/bar')", "        guid2, created2 = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        assert_true(created1)", "        assert_false(created2)", "        assert_equals(guid1, guid2)", "", "    def test_node_addon_get_or_create_finds_changed(self):", "        self.node_addon.folder_path = 'baz'", "        self.node_addon.save()", "        self.node_addon.reload()", "", "        guid1, created1 = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        self.node_addon.folder_path = 'baz/foo'", "        self.node_addon.save()", "        self.node_addon.reload()", "        guid2, created2 = self.node_addon.find_or_create_file_guid('/bar')", "", "        assert_true(created1)", "        assert_false(created2)", "        assert_equals(guid1, guid2)", "", "    def test_node_addon_get_or_create_finds_changed_root(self):", "        self.node_addon.folder_path = 'baz'", "        self.node_addon.save()", "        self.node_addon.reload()", "", "        guid1, created1 = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        self.node_addon.folder_path = '/'", "        self.node_addon.save()", "        self.node_addon.reload()", "        guid2, created2 = self.node_addon.find_or_create_file_guid('/baz/foo/bar')", "", "        assert_true(created1)", "        assert_false(created2)", "        assert_equals(guid1, guid2)", "", ""]}, {"lines": [""]}, {"lines": ["        assert_true(retrieved.access_token)", ""]}, {"lines": ["", "        user_settings.access_token", ""]}, {"lines": [""]}, {"lines": ["    def test_access_token_refreshes_timeout(self, mock_refresh):"]}, {"lines": ["", "        user_settings.access_token", ""]}, {"lines": [""]}, {"lines": ["    def test_access_token_refreshes_timeout_longer(self, mock_refresh):"]}, {"lines": ["        user_settings.access_token"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        assert_true(hasattr(node_settings, 'folder_id'))", "        assert_true(hasattr(node_settings, 'folder_path'))", "        assert_true(hasattr(node_settings, 'folder_name'))"]}, {"lines": ["    def test_complete_true(self):", "        assert_true(self.node_settings.has_auth)", "        assert_true(self.node_settings.complete)", "", "    def test_complete_false(self):", "        self.node_settings.folder_id = None", "", "        assert_true(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", "", "    def test_complete_auth_false(self):", "        self.node_settings.user_settings = None", "", "        assert_false(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", ""]}, {"lines": ["", "        assert_is_none(node_settings.folder_id)", "        assert_is_none(node_settings.folder_path)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        assert_true(self.node_settings.folder_id)"]}, {"lines": [""]}, {"lines": ["", "        assert_is(self.node_settings.folder_id, None)"]}, {"lines": [""]}, {"lines": ["        assert_in('project', params)", "        assert_equal(last_log.action, 'googledrive_node_deauthorized')"]}, {"lines": ["            'name': 'freddie',", "            'path': 'queen/freddie',"]}, {"lines": ["        assert_equal(self.node_settings.folder_name, folder_name['name'])"]}, {"lines": [""]}, {"lines": ["        assert_equal(last_log.action, 'googledrive_node_authorized')", "        assert_equal(log_params['node'], node_settings.owner._primary_key)"]}, {"lines": [""]}, {"lines": ["        self.node_settings.folder_path = 'camera uploads/pizza.nii'"]}, {"lines": [""]}, {"lines": ["", "        expected = {", "            'folder': {", "                'id': '12345',", "                'name': 'pizza.nii',", "                'path': 'camera uploads/pizza.nii',", "            }", "        }", ""]}, {"lines": ["        self.node_settings.folder_id = None"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        assert_true(self.node_settings.folder_id is None)", "        assert_true(self.node_settings.folder_path is None)"]}, {"lines": ["           \"title\": u\"\u041d\u043e\u0432\u0430\u044f \u043f\u0430\u043f\u043a\u0430\",  # Google drive actually sends back in unicode, this will work without the u\"..\""]}, {"lines": ["     mock_folders[key] = val"]}, {"lines": ["from framework.exceptions import HTTPError", "from framework.auth.decorators import must_be_logged_in", "from framework.status import push_status_message as flash"]}, {"lines": ["from website.util import permissions"]}, {"lines": ["from website.project.model import Node"]}, {"lines": ["from website.project.decorators import (", "    must_have_addon,", "    must_have_permission", ")"]}, {"lines": [""]}, {"lines": ["from website.addons.googledrive.utils import serialize_settings"]}, {"lines": ["    nid = kwargs.get('nid') or kwargs.get('pid')"]}, {"lines": [""]}, {"lines": ["", "    # If user has already authorized google drive, flash error message", "    if node_addon and node_addon.has_auth:"]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["", "    code = request.args.get('code')"]}, {"lines": [""]}, {"lines": ["def googledrive_oauth_delete_user(user_addon, **kwargs):"]}, {"lines": ["@must_have_permission(permissions.WRITE)"]}, {"lines": ["@must_have_permission(permissions.WRITE)"]}, {"lines": ["", "    if user_addon is None:"]}, {"lines": [""]}, {"lines": ["from website.project.decorators import must_have_addon", "from website.project.decorators import must_be_addon_authorizer"]}, {"lines": ["from website.addons.googledrive.utils import to_hgrid"]}, {"lines": ["def googledrive_folders(node_addon, user_addon, **kwargs):"]}, {"lines": ["    node = kwargs.get('node') or kwargs['project']"]}, {"lines": [""]}, {"lines": ["    if folder_id == 'root':"]}, {"lines": ["", "        return [{", "            'path': '/',"]}, {"lines": ["            'urls': {"]}, {"lines": ["            }", "        }]", "", "    contents = [", "        to_hgrid(item, node, path=path)", "        for item in client.folders(folder_id)", "    ]", ""]}, {"lines": ["    if not node_settings.has_auth or not node_settings.folder_id:"]}, {"lines": ["        name=node_settings.folder_name,"]}, {"lines": ["        return super(APISession, self).request(*args, **kwargs)"]}, {"lines": ["from . import routes, views, model, oldels"]}, {"lines": ["    oldels.OsfStorageFileTree,", "    oldels.OsfStorageFileRecord,"]}, {"lines": ["    model.OsfStorageFileNode,"]}, {"lines": ["    model.OsfStorageFileVersion,", "    model.OsfStorageNodeSettings,"]}, {"lines": ["    model.OsfStorageTrashedFileNode,"]}, {"lines": ["    routes.api_routes"]}, {"lines": ["", "class InvalidPath(OsfStorageError):", "    pass"]}, {"lines": ["# encoding: utf-8", "", "import os", "import bson", "import logging", "", "import pymongo", "", "from modularodm import fields, Q", "from modularodm import exceptions as modm_errors", "from modularodm.storage.base import KeyExistsException", "", "from framework.auth import Auth", "from framework.mongo import StoredObject", "from framework.analytics import get_basic_counters", "from website.models import NodeLog", ""]}, {"lines": ["from website.addons.osfstorage import errors"]}, {"lines": ["from website.addons.osfstorage.model import OsfStorageFileVersion"]}, {"lines": ["", "", "logger = logging.getLogger(__name__)", "", "oid_primary_key = fields.StringField(", "    primary=True,", "    default=lambda: str(bson.ObjectId())", ")", "", "", "class BaseFileObject(StoredObject):", "    __indices__ = [", "        {", "            'key_or_list': [", "                ('path', pymongo.ASCENDING),", "                ('node_settings', pymongo.ASCENDING),", "            ],", "            'unique': True,", "        }", "    ]", "", "    path = fields.StringField(required=True, index=True)", "    node_settings = fields.ForeignField(", "        'OsfStorageNodeSettings',", "        required=True,", "        index=True,", "    )", "", "    _meta = {", "        'abstract': True,", "    }", "", "    @property", "    def name(self):", "        _, value = os.path.split(self.path)", "        return value", "", "    @property", "    def extension(self):", "        _, value = os.path.splitext(self.path)", "        return value", "", "    @property", "    def node(self):", "        return self.node_settings.owner", "", "    @classmethod", "    def parent_class(cls):", "        raise NotImplementedError", "", "    @classmethod", "    def find_by_path(cls, path, node_settings):", "        \"\"\"Find a record by path and root settings record.", "", "        :param str path: Path to file or directory", "        :param node_settings: Root node settings record", "        \"\"\"", "        try:", "            obj = cls.find_one(", "                Q('path', 'eq', path.rstrip('/')) &", "                Q('node_settings', 'eq', node_settings._id)", "            )", "            return obj", "        except modm_errors.NoResultsFound:", "            return None", "", "    @classmethod", "    def get_or_create(cls, path, node_settings):", "        \"\"\"Get or create a record by path and root settings record.", "", "        :param str path: Path to file or directory", "        :param node_settings: Root node settings record", "        :returns: Tuple of (record, created)", "        \"\"\"", "        path = path.rstrip('/')", "", "        try:", "            obj = cls(path=path, node_settings=node_settings)", "            obj.save()", "        except KeyExistsException:", "            obj = cls.find_by_path(path, node_settings)", "            assert obj is not None", "            return obj, False", "", "        # Ensure all intermediate paths", "        if path:", "            parent_path, _ = os.path.split(path)", "            parent_class = cls.parent_class()", "            parent_obj, _ = parent_class.get_or_create(parent_path, node_settings)", "            parent_obj.append_child(obj)", "        else:", "            node_settings.file_tree = obj", "            node_settings.save()", "", "        return obj, True", "", "    def get_download_count(self, version=None):", "        \"\"\"Return download count or `None` if this is not a file object (e.g. a", "        folder).", "        \"\"\"", "        return None", "", "    def __repr__(self):", "        return '<{}(path={!r}, node_settings={!r})>'.format(", "            self.__class__.__name__,", "            self.path,"]}, {"lines": ["            self.to_storage()['node_settings']"]}, {"lines": ["        )", "", "", "class OsfStorageFileTree(BaseFileObject):", "", "    _id = oid_primary_key", "    children = fields.AbstractForeignField(list=True)", "", "    @classmethod", "    def parent_class(cls):", "        return OsfStorageFileTree", "", "    def append_child(self, child):", "        \"\"\"Appending children through ODM introduces a race condition such that", "        concurrent requests can overwrite previously added items; use the native", "        `addToSet` operation instead.", "        \"\"\"", "        collection = self._storage[0].store", "        collection.update(", "            {'_id': self._id},", "            {'$addToSet': {'children': (child._id, child._name)}}", "        )", "        # Updating MongoDB directly means the cache is wrong; reload manually", "        self.reload()", "", "    @property", "    def is_deleted(self):", "        return False", "", "", "class OsfStorageFileRecord(BaseFileObject):", "", "    _id = oid_primary_key", "    is_deleted = fields.BooleanField(default=False)", "    versions = fields.ForeignField('OsfStorageFileVersion', list=True)", "", "    @classmethod", "    def parent_class(cls):", "        return OsfStorageFileTree", "", "    def get_version(self, index=-1, required=False):", "        try:", "            return self.versions[index]", "        except IndexError:", "            if required:", "                raise errors.VersionNotFoundError", "            return None", ""]}, {"lines": ["        start = len(self.versions) - (page * size)", "        stop = max(0, start - size)", "        indices = range(start, stop, -1)", "        versions = [self.versions[idx - 1] for idx in indices]", "        more = stop > 0", "        return indices, versions, more", "", "    def create_version(self, creator, location, metadata=None):", "        latest_version = self.get_version()", "        version = OsfStorageFileVersion(creator=creator, location=location)", "", "        if latest_version and latest_version.is_duplicate(version):", "            if self.is_deleted:", "                self.undelete(Auth(creator))", "            return latest_version", "", "        if metadata:", "            version.update_metadata(metadata)", "", "        version.save()", "        self.versions.append(version)", "        self.is_deleted = False", "        self.save()", "        self.log(", "            Auth(creator),", "            NodeLog.FILE_UPDATED if len(self.versions) > 1 else NodeLog.FILE_ADDED,", "        )", "        return version", "", "    def update_version_metadata(self, location, metadata):", "        for version in reversed(self.versions):", "            if version.location == location:", "                version.update_metadata(metadata)", "                return", "        raise errors.VersionNotFoundError", ""]}, {"lines": ["    def delete(self, auth, log=True):", "        if self.is_deleted:", "            raise errors.DeleteError", "        self.is_deleted = True", "        self.save()", "        if log:", "            self.log(auth, NodeLog.FILE_REMOVED, version=False)", "", "    def undelete(self, auth, log=True):", "        if not self.is_deleted:", "            raise errors.UndeleteError", "        self.is_deleted = False", "        self.save()", "        if log:", "            self.log(auth, NodeLog.FILE_ADDED)", "", "    def get_download_count(self, version=None):", "        \"\"\"", "        :param int version: Optional one-based version index", "        \"\"\"", "        parts = ['download', self.node._id, self.path]", "        if version is not None:", "            parts.append(version)", "        page = ':'.join([format(part) for part in parts])", "        _, count = get_basic_counters(page)", "        return count or 0"]}, {"lines": ["import functools"]}, {"lines": ["from modularodm.exceptions import ValidationValueError"]}, {"lines": ["from framework.analytics import update_counter", ""]}, {"lines": ["from website.addons.osfstorage import settings"]}, {"lines": ["LOCATION_KEYS = ['service', settings.WATERBUTLER_RESOURCE, 'object']", "", ""]}, {"lines": ["def update_analytics(node, file_id, version_idx):"]}, {"lines": ["    \"\"\"", "    :param Node node: Root node to update"]}, {"lines": ["    :param str file_id: The _id field of a filenode"]}, {"lines": ["    :param int version_idx: Zero-based version index"]}, {"lines": ["    \"\"\""]}, {"lines": ["    update_counter(u'download:{0}:{1}'.format(node._id, file_id))", "    update_counter(u'download:{0}:{1}:{2}'.format(node._id, file_id, version_idx))"]}, {"lines": ["", ""]}, {"lines": ["def serialize_revision(node, record, version, index, anon=False):"]}, {"lines": ["", "    if anon:", "        user = None", "    else:", "        user = {"]}, {"lines": ["        }", "", "    return {", "        'user': user,"]}, {"lines": ["        'index': index + 1,"]}, {"lines": ["        'date': version.date_created.isoformat(),"]}, {"lines": ["def validate_location(value):", "    for key in LOCATION_KEYS:", "        if key not in value:", "            raise ValidationValueError", "", "", "def must_be(_type):"]}, {"lines": ["    \"\"\"A small decorator factory for OsfStorageFileNode. Acts as a poor mans", "    polymorphic inheritance, ensures that the given instance is of \"kind\" folder or file", "    \"\"\""]}, {"lines": ["    def _must_be(func):", "        @functools.wraps(func)", "        def wrapped(self, *args, **kwargs):", "            if not self.kind == _type:", "                raise ValueError('This instance is not a {}'.format(_type))", "            return func(self, *args, **kwargs)", "        return wrapped", "    return _must_be", "", ""]}, {"lines": ["def copy_files(src, target_settings, parent=None, name=None):"]}, {"lines": ["    \"\"\"Copy the files from src to the target nodesettings", "    :param OsfStorageFileNode src: The source to copy children from", "    :param OsfStorageNodeSettings target_settings: The node settings of the project to copy files to", "    :param OsfStorageFileNode parent: The parent of to attach the clone of src to, if applicable", "    \"\"\""]}, {"lines": ["    cloned = src.clone()"]}, {"lines": ["    cloned.parent = parent"]}, {"lines": ["    cloned.name = name or cloned.name"]}, {"lines": ["    cloned.node_settings = target_settings", "", "    if src.is_file:", "        cloned.versions = src.versions", ""]}, {"lines": ["    cloned.save()"]}, {"lines": ["", "    if src.is_folder:", "        for child in src.children:", "            copy_files(child, target_settings, parent=cloned)", ""]}, {"lines": ["    return cloned"]}, {"lines": ["<script type=\"text/html\" id=\"osf_storage_folder_created\">", "created folder"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", ""]}, {"lines": ["from website.addons.osfstorage.tests.utils import StorageTestCase"]}, {"lines": ["        self.path = 'kind-of-magic.webm'", "        self.record = self.node_settings.root_node.append_file(self.path)"]}, {"lines": ["            for __ in range(3)"]}, {"lines": ["        utils.update_analytics(self.project, self.record._id, 0)", "        utils.update_analytics(self.project, self.record._id, 0)", "        utils.update_analytics(self.project, self.record._id, 2)"]}, {"lines": ["            0,"]}, {"lines": ["        assert_equal(self.record.get_download_count(), 3)", "        assert_equal(self.record.get_download_count(version=2), 1)", "        assert_equal(self.record.get_download_count(version=0), 2)"]}, {"lines": ["", "    def test_anon_revisions(self):", "        sessions.sessions[request._get_current_object()] = Session()"]}, {"lines": ["        utils.update_analytics(self.project, self.record._id, 0)", "        utils.update_analytics(self.project, self.record._id, 0)", "        utils.update_analytics(self.project, self.record._id, 2)"]}, {"lines": ["        expected = {"]}, {"lines": ["            'index': 2,"]}, {"lines": ["            'user': None,", "            'date': self.versions[0].date_created.isoformat(),"]}, {"lines": ["            'downloads': 0,"]}, {"lines": ["        }", "        observed = utils.serialize_revision(", "            self.project,", "            self.record,", "            self.versions[0],", "            1,", "            anon=True", "        )", "        assert_equal(expected, observed)"]}, {"lines": ["", "", "def recursively_create_file(settings, path):", "    path = path.split('/')", "    final = path.pop(-1)", "    current = settings.root_node", "    for subpath in path:", "        current = current.append_folder(subpath)", "    return current.append_file(final)", "", "", "def recursively_create_folder(settings, path):", "    path = path.split('/')", "    final = path.pop(-1)", "    current = settings.root_node", "    for subpath in path:", "        current = current.append_folder(subpath)", "    return current.append_file(final)"]}, {"lines": ["from website.addons.s3 import utils"]}, {"lines": ["    def waterbutler_path(self):"]}, {"lines": ["        return '/' + self.path"]}, {"lines": ["", "    @property"]}, {"lines": ["    def provider(self):", "        return 's3'"]}, {"lines": ["    @property", "    def version_identifier(self):", "        return 'version'", ""]}, {"lines": ["    @property", "    def unique_identifier(self):", "        return self._metadata_cache['extra']['md5']", ""]}, {"lines": ["        return utils.can_list(self.access_key, self.secret_key)"]}, {"lines": [""]}, {"lines": ["        return True"]}, {"lines": [""]}, {"lines": ["    def find_or_create_file_guid(self, path):"]}, {"lines": ["        path = path.lstrip('/')"]}, {"lines": [""]}, {"lines": ["    @property", "    def display_name(self):", "        return u'{0}: {1}'.format(self.config.full_name, self.bucket)", ""]}, {"lines": ["    @property", "    def complete(self):", "        return self.has_auth and self.bucket is not None", ""]}, {"lines": ["        self.bucket, self.user_settings = None, None"]}, {"lines": ["    def serialize_waterbutler_credentials(self):", "        if not self.has_auth:"]}, {"lines": ["        return {", "            'access_key': self.user_settings.access_key,", "            'secret_key': self.user_settings.secret_key,", "        }", "", "    def serialize_waterbutler_settings(self):", "        if not self.bucket:"]}, {"lines": ["        return {'bucket': self.bucket}", "", "    def create_waterbutler_log(self, auth, action, metadata):"]}, {"lines": ["        url = self.owner.web_url_for('addon_view_or_download_file', path=metadata['path'], provider='s3')", ""]}, {"lines": ["        self.owner.add_log(", "            's3_{0}'.format(action),", "            auth=auth,", "            params={", "                'project': self.owner.parent_id,", "                'node': self.owner._id,"]}, {"lines": ["                'path': metadata['materialized'],"]}, {"lines": ["                'bucket': self.bucket,"]}, {"lines": ["                'urls': {", "                    'view': url,", "                    'download': url + '?action=download'", "                }"]}, {"lines": ["            },", "        )", ""]}, {"lines": ["            'bucket': self.bucket or '',", "            'has_bucket': self.bucket is not None,"]}, {"lines": ["                self.user_settings and self.user_settings.owner == user", "            ),"]}, {"lines": ["        })"]}, {"lines": ["import re"]}, {"lines": ["import httplib"]}, {"lines": [""]}, {"lines": ["from boto import exception", "from boto.s3.connection import S3Connection", "from boto.s3.connection import OrdinaryCallingFormat"]}, {"lines": ["def connect_s3(access_key=None, secret_key=None, user_settings=None):", "    \"\"\"Helper to build an S3Connection object", "    Can be used to change settings on all S3Connections", "    See: CallingFormat", "    \"\"\"", "    if user_settings is not None:", "        access_key, secret_key = user_settings.access_key, user_settings.secret_key", "    connection = S3Connection(access_key, secret_key)", "    return connection"]}, {"lines": ["def get_bucket_names(user_settings):"]}, {"lines": ["    try:"]}, {"lines": ["        buckets = connect_s3(user_settings=user_settings).get_all_buckets()", "    except exception.NoAuthHandlerFound:", "        raise HTTPError(httplib.FORBIDDEN)", "    except exception.BotoServerError as e:"]}, {"lines": [""]}, {"lines": ["    return [bucket.name for bucket in buckets]", "", "", "def validate_bucket_name(name):", "    validate_name = re.compile('^(?!.*(\\.\\.|-\\.))[^.][a-z0-9\\d.-]{2,61}[^.]$')", "    return bool(validate_name.match(name))"]}, {"lines": [""]}, {"lines": ["def create_bucket(user_settings, bucket_name):", "    return connect_s3(user_settings=user_settings).create_bucket(bucket_name)"]}, {"lines": ["def bucket_exists(access_key, secret_key, bucket_name):", "    \"\"\"Tests for the existance of a bucket and if the user", "    can access it with the given keys", "    \"\"\"", "    if not bucket_name:", "        return False", "", "    connection = connect_s3(access_key, secret_key)", "", "    if bucket_name != bucket_name.lower():", "        # Must use ordinary calling format for mIxEdCaSe bucket names", "        # otherwise use the default as it handles bucket outside of the US", "        connection.calling_format = OrdinaryCallingFormat()"]}, {"lines": ["", "    try:"]}, {"lines": ["        # Will raise an exception if bucket_name doesn't exist", "        connect_s3(access_key, secret_key).head_bucket(bucket_name)", "    except exception.S3ResponseError as e:", "        if e.status not in (301, 302):", "            return False", "    return True"]}, {"lines": ["", ""]}, {"lines": ["def can_list(access_key, secret_key):", "    \"\"\"Return whether or not a user can list", "    all buckets accessable by this keys", "    \"\"\"", "    # Bail out early as boto does not handle getting", "    # Called with (None, None)", "    if not (access_key and secret_key):", "        return False"]}, {"lines": ["    try:", "        connect_s3(access_key, secret_key).get_all_buckets()", "    except exception.S3ResponseError:", "        return False", "    return True"]}, {"lines": ["def serialize_urls(node_addon, user):"]}, {"lines": ["        'create_bucket': node.api_url_for('create_bucket'),"]}, {"lines": ["        'deauthorize': node.api_url_for('s3_delete_node_settings'),", "        'bucket_list': node.api_url_for('s3_get_bucket_list'),", "        'set_bucket': node.api_url_for('s3_get_node_settings'),"]}, {"lines": ["        result['owner'] = user_settings.owner.profile_url"]}, {"lines": ["import json"]}, {"lines": ["OSF_USER = 'osf-user{0}'", "OSF_USER_POLICY_NAME = 'osf-user-policy'", "OSF_USER_POLICY = json.dumps(", "    {", "        \"Version\": \"2012-10-17\",", "        \"Statement\": [", "            {", "                \"Sid\": \"Stmt1392138408000\",", "                \"Effect\": \"Allow\",", "                \"Action\": [", "                    \"s3:*\"", "                ],", "                \"Resource\": [", "                    \"*\"", "                ]", "            },", "            {", "                \"Sid\": \"Stmt1392138440000\",", "                \"Effect\": \"Allow\",", "                \"Action\": [", "                    \"iam:DeleteAccessKey\",", "                    \"iam:DeleteUser\",", "                    \"iam:DeleteUserPolicy\"", "                ],", "                \"Resource\": [", "                    \"*\"", "                ]", "            }", "        ]", "    }"]}, {"lines": ["            file.signedUrlFrom = parent.urls.upload;"]}, {"lines": ["<script type=\"text/html\" id=\"s3_file_added\">", "added file"]}, {"lines": ["bucket", "<span data-bind=\"text: params.bucket\"></span> in"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"s3_folder_created\">", "created folder"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"s3_file_updated\">", "updated file"]}, {"lines": ["bucket", "<span data-bind=\"text: params.bucket\"></span> in"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>", "", "<script type=\"text/html\" id=\"s3_file_removed\">"]}, {"lines": ["bucket", "<span data-bind=\"text: params.bucket\"></span> in"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>"]}, {"lines": [""]}, {"lines": ["from website.addons.s3.model import AddonS3NodeSettings, AddonS3UserSettings, S3GuidFile", "", "", "class TestFileGuid(OsfTestCase):", "    def setUp(self):", "        super(OsfTestCase, self).setUp()", "        self.user = UserFactory()", "        self.project = ProjectFactory(creator=self.user)", "        self.project.add_addon('s3', auth=Auth(self.user))", "        self.node_addon = self.project.get_addon('s3')", "", "    def test_provider(self):", "        assert_equal('s3', S3GuidFile().provider)", "", "    def test_correct_path(self):", "        guid = S3GuidFile(node=self.project, path='baz/foo/bar')", "", "        assert_equals(guid.path, 'baz/foo/bar')", "        assert_equals(guid.waterbutler_path, '/baz/foo/bar')", "", "    @mock.patch('website.addons.base.requests.get')", "    def test_unique_identifier(self, mock_get):", "        mock_response = mock.Mock(ok=True, status_code=200)", "        mock_get.return_value = mock_response", "        mock_response.json.return_value = {", "            'data': {", "                'name': 'Morty',", "                'extra': {", "                    'md5': 'Terran it up'", "                }", "            }", "        }", "", "        guid = S3GuidFile(node=self.project, path='/foo/bar')", "", "        guid.enrich()", "        assert_equals('Terran it up', guid.unique_identifier)", "", "    def test_node_addon_get_or_create(self):", "        guid, created = self.node_addon.find_or_create_file_guid('baz/foo/bar')", "", "        assert_true(created)", "        assert_equal(guid.path, 'baz/foo/bar')", "        assert_equal(guid.waterbutler_path, '/baz/foo/bar')", "", "    def test_node_addon_get_or_create_finds(self):", "        guid1, created1 = self.node_addon.find_or_create_file_guid('/foo/bar')", "        guid2, created2 = self.node_addon.find_or_create_file_guid('/foo/bar')", "", "        assert_true(created1)", "        assert_false(created2)", "        assert_equals(guid1, guid2)"]}, {"lines": ["class TestNodeSettings(OsfTestCase):", "    def setUp(self):", "        super(TestNodeSettings, self).setUp()", "        self.user = UserFactory()", "        self.project = ProjectFactory(creator=self.user)", "", "        self.user.add_addon('s3')", "        self.project.add_addon('s3', auth=Auth(self.user))", "", "        self.user_settings = self.user.get_addon('s3')", "        self.node_settings = self.project.get_addon('s3')", "", "        self.user_settings.access_key = 'We-Will-Rock-You'", "        self.user_settings.secret_key = 'Idontknowanyqueensongs'", "        self.user_settings.save()", "", "        self.node_settings.bucket = 'Sheer-Heart-Attack'", "        self.node_settings.user_settings = self.user_settings", "        self.node_settings.save()", "", "    def test_complete_true(self):", "        assert_true(self.node_settings.has_auth)", "        assert_true(self.node_settings.complete)", "", "    def test_complete_false(self):", "        self.node_settings.bucket = None", "", "        assert_true(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", "", "    def test_complete_auth_false(self):", "        self.node_settings.user_settings = None", "", "        assert_false(self.node_settings.has_auth)", "        assert_false(self.node_settings.complete)", ""]}, {"lines": ["    def test_is_valid_none_none(self):", "        self.user_settings.access_key = None", "        self.user_settings.secret_key = None", "        assert_false(self.user_settings.is_valid)", ""]}, {"lines": [""]}, {"lines": ["import httplib"]}, {"lines": ["from boto import exception"]}, {"lines": ["from website.addons.s3 import utils"]}, {"lines": ["from website.project.decorators import must_be_contributor_or_public", ""]}, {"lines": ["", "@must_be_contributor_or_public", "@must_have_addon('s3', 'node')"]}, {"lines": ["def create_bucket(auth, node_addon, **kwargs):", "    bucket_name = request.json.get('bucket_name', '')"]}, {"lines": [""]}, {"lines": ["        }, httplib.NOT_ACCEPTABLE", ""]}, {"lines": ["    try:"]}, {"lines": ["        utils.create_bucket(node_addon.user_settings, bucket_name)", "    except exception.S3ResponseError as e:"]}, {"lines": ["        }, httplib.NOT_ACCEPTABLE", "    except exception.S3CreateError as e:"]}, {"lines": ["        }, httplib.NOT_ACCEPTABLE", "    except exception.BotoClientError as e:  # Base class catchall"]}, {"lines": ["        }, httplib.NOT_ACCEPTABLE", "", "    return {", "        'buckets': utils.get_bucket_names(node_addon.user_settings)", "    }"]}, {"lines": ["        )"]}, {"lines": ["        assert_false(self.user_settings.is_confirmed)"]}, {"lines": ["    pass"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        Rule(["]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "}"]}, {"lines": ["module.exports = ShareJSDoc;"]}, {"lines": [""]}, {"lines": ["ZOTERO_CLIENT_SECRET = None"]}, {"lines": ["        assert_is_none(serialize_account(None))"]}, {"lines": ["    return {'date-parts': [[dt.year, dt.month, dt.day]]}"]}, {"lines": ["from website import util"]}, {"lines": ["    upload_url = util.waterbutler_url_for('upload', 'osfstorage', name, node, user=user)", ""]}, {"lines": ["def get_node_lineage(node):", "    \"\"\" Get a list of node ids in order from the node to top most project", "        e.g. [parent._id, node._id]"]}, {"lines": ["    lineage = [node._id]"]}, {"lines": ["    while node.parent_id:", "        node = website_models.Node.load(node.parent_id)", "        lineage = [node._id] + lineage", "", "    return lineage"]}, {"lines": ["", "    node = website_models.Node.load(uid)", "    assert node, 'get_settings_url recieved an invalid Node id'", "    return node.web_url_for('node_setting', _guid=True, _absolute=True)"]}, {"lines": ["    return u'{time} on {date}'.format(time=formatted_time, date=formatted_date)"]}, {"lines": ["    configured_project_ids = set()"]}, {"lines": [""]}, {"lines": ["        # If the user has opted out of emails skip"]}, {"lines": ["        node = subscription.owner"]}, {"lines": [""]}, {"lines": ["        if not isinstance(node, Node) or (user in subscription.none and not node.parent_id):", "            continue", ""]}, {"lines": ["        while node.parent_id and not node.is_deleted:", "            node = Node.load(node.parent_id)"]}, {"lines": [""]}, {"lines": ["        if not node.is_deleted:"]}, {"lines": ["            configured_project_ids.add(node._id)"]}, {"lines": ["    return list(configured_project_ids)"]}, {"lines": ["        if s.owner == node:"]}, {"lines": ["def format_data(user, node_ids):"]}, {"lines": ["    items = []"]}, {"lines": [""]}, {"lines": ["    for node_id in node_ids:"]}, {"lines": ["        assert node, '{} is not a valid Node.'.format(node_id)", ""]}, {"lines": ["        can_read = node.has_permission(user, 'read')", "        can_read_children = node.can_read_children(user)"]}, {"lines": ["        if not can_read and not can_read_children:", "            continue"]}, {"lines": ["        children = []"]}, {"lines": ["", "        if can_read:"]}, {"lines": ["            for subscription in constants.NODE_SUBSCRIPTIONS_AVAILABLE:", "                children.append(serialize_event(user, subscription, constants.NODE_SUBSCRIPTIONS_AVAILABLE, node_subscriptions, node))"]}, {"lines": ["", "        children.extend(format_data(", "            user,", "            [", "                n._id", "                for n in node.nodes", "                if n.primary and"]}, {"lines": ["                not n.is_deleted"]}, {"lines": ["            ]", "        ))", ""]}, {"lines": ["        item = {", "            'node': {", "                'id': node_id,", "                'url': node.url if can_read else '',", "                'title': node.title if can_read else 'Private Project',", "            },", "            'children': children,", "            'kind': 'folder' if not node.node__parent or not node.parent_node.has_permission(user, 'read') else 'node',"]}, {"lines": ["        }"]}, {"lines": [""]}, {"lines": ["        items.append(item)", "", "    return items"]}, {"lines": ["            'children': format_data(user, get_configured_projects(user))"]}, {"lines": ["    return PROVIDER_LOOKUP[name]()"]}, {"lines": ["import httplib as http"]}, {"lines": [""]}, {"lines": ["from framework import forms"]}, {"lines": ["from framework.flask import redirect  # VOL-aware redirect", "from framework.sessions import session"]}, {"lines": ["from framework.auth import User, get_user"]}, {"lines": ["from framework.auth.decorators import collect_auth, must_be_logged_in", "from framework.auth.forms import PasswordForm, SetEmailAndPasswordForm"]}, {"lines": ["from website import mails", "from website import language"]}, {"lines": ["from website import settings"]}, {"lines": ["from website.project.model import has_anonymous_link"]}, {"lines": ["from website.util import web_url_for, is_json_request"]}, {"lines": ["from website.util.permissions import expand_permissions, ADMIN", "from website.project.decorators import (must_have_permission, must_be_valid_project,", "        must_not_be_registration, must_be_contributor_or_public, must_be_contributor)"]}, {"lines": ["        utils.add_contributor_json(most_contrib, auth.user)"]}, {"lines": ["        utils.add_contributor_json(contrib, auth.user)"]}, {"lines": ["@collect_auth"]}, {"lines": ["    current_user = auth.user"]}, {"lines": [""]}, {"lines": ["@collect_auth"]}, {"lines": ["def claim_user_form(auth, **kwargs):"]}, {"lines": ["    if auth.logged_in:"]}, {"lines": ["def project_new_post(auth, **kwargs):", "    user = auth.user"]}, {"lines": ["    if template:", "        original_node = Node.load(template)", "        changes = {"]}, {"lines": ["        }", "", "        if description:"]}, {"lines": ["            changes['description'] = description"]}, {"lines": ["", "        project = original_node.use_as_template(", "            auth=auth,"]}, {"lines": ["            changes={"]}, {"lines": ["    return {"]}, {"lines": ["    }, http.CREATED"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                         and not node.is_registration),"]}, {"lines": ["        'badges': _get_badge(user),"]}, {"lines": ["def _get_badge(user):", "    if user:", "        badger = user.get_addon('badges')", "        if badger:", "            return {"]}, {"lines": ["                'can_award': badger.can_award,"]}, {"lines": ["                'badges': badger.get_badges_json()", "            }", "    return {}", "", ""]}, {"lines": ["            children.extend(_get_children(child, auth, indent + 1))"]}, {"lines": ["        }"]}, {"lines": ["    non_ua_count = total_count - ua_count  # base length of blue bar"]}, {"lines": ["            if node.is_registration", "            else None,"]}, {"lines": ["    private_link_id = request.json.get('pk', '')"]}, {"lines": ["from website.util.sanitize import clean_tag"]}, {"lines": ["    tag = clean_tag(kwargs['tag'])"]}, {"lines": ["    tag = clean_tag(kwargs['tag'])"]}, {"lines": ["    if tag:"]}, {"lines": ["        return {'status': 'success'}"]}, {"lines": ["", "", "class IndexNotFoundError(SearchException):", "    pass", "", "", "class MalformedQueryError(SearchException):", "    pass"]}, {"lines": ["    for_charts['shareDonutGraph'] = source_and_counts"]}, {"lines": ["", "    all_data['charts'] = {", "        'shareDonutGraph': {", "            'type': 'donut',"]}, {"lines": ["        },", "        'shareTimeGraph': {", "            'x': 'x',", "            'type': 'area-spline',", "            'columns': for_charts['date_totals']['date_numbers'],"]}, {"lines": ["        }", "    }"]}, {"lines": ["import functools"]}, {"lines": ["import httplib as http"]}, {"lines": ["import bleach", ""]}, {"lines": [""]}, {"lines": ["from framework.auth.decorators import collect_auth"]}, {"lines": ["from website.models import Node", "from website.models import User"]}, {"lines": ["from website.search import exceptions"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["def handle_search_errors(func):"]}, {"lines": ["    @functools.wraps(func)"]}, {"lines": ["            raise HTTPError(http.SERVICE_UNAVAILABLE, data={"]}, {"lines": ["                'message_short': 'Search unavailable',", "                'message_long': ('Our search service is currently unavailable, if the issue persists, '", "                'please report it to <a href=\"mailto:support@osf.io\">support@osf.io</a>.'),", "            })"]}, {"lines": ["    return wrapped"]}, {"lines": ["@handle_search_errors"]}, {"lines": ["def search_search(**kwargs):"]}, {"lines": [""]}, {"lines": ["    if request.method == 'POST':"]}, {"lines": ["        # TODO Match javascript params?"]}, {"lines": ["@collect_auth", "def search_contributor(auth):", "    user = auth.user if auth else None"]}, {"lines": ["    exclude = Node.load(nid).contributors if nid else []"]}, {"lines": ["                                     exclude=exclude, current_user=user)"]}, {"lines": ["    app = app or init_app(\"website.settings\", set_backends=True, routes=True)"]}, {"lines": ["import hashlib"]}, {"lines": [""]}, {"lines": ["SEARCH_ENGINE = 'elastic'  # Can be 'elastic', or None"]}, {"lines": ["SYSTEM_ADDED_ADDONS = {"]}, {"lines": ["}", ""]}, {"lines": [""]}, {"lines": ["DEFAULT_HMAC_SECRET = 'changeme'"]}, {"lines": ["DEFAULT_HMAC_ALGORITHM = hashlib.sha256"]}, {"lines": ["MFR_SERVER_URL = 'http://localhost:7778'"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": [""]}, {"lines": ["var STATE_MAP = {", "    upload: {", "        display: 'Upload pending...'", "    },", "    copy: {"]}, {"lines": ["        display: 'Copying '"]}, {"lines": ["    },", "    delete: {"]}, {"lines": ["        display: 'Deleting '"]}, {"lines": ["    },", "    move: {"]}, {"lines": ["        display: 'Moving '"]}, {"lines": ["    },", "    rename: {", "        display: 'Renaming '", "    }", "};", "", "", "var OPERATIONS = {", "    RENAME: {"]}, {"lines": ["        verb: 'Rename',"]}, {"lines": ["        status: 'rename',"]}, {"lines": ["        passed: 'renamed',"]}, {"lines": ["        action: 'Renaming',"]}, {"lines": ["    },", "    MOVE: {"]}, {"lines": ["        verb: 'Move',"]}, {"lines": ["        status: 'move',"]}, {"lines": ["        passed: 'moved',"]}, {"lines": ["        action: 'Moving',"]}, {"lines": ["    },", "    COPY: {"]}, {"lines": ["        verb: 'Copy',"]}, {"lines": ["        status: 'copy',"]}, {"lines": ["        passed: 'copied',"]}, {"lines": ["        action: 'Copying',"]}, {"lines": ["    }", "};", ""]}, {"lines": ["    if (item && item.data.provider && Fangorn.config[item.data.provider]) {", "        return Fangorn.config[item.data.provider][key];"]}, {"lines": ["    inheritedFields.concat(fields || []).forEach(function(field) {"]}, {"lines": [""]}, {"lines": ["function checkConflicts(tb, item, folder, cb) {"]}, {"lines": ["    for(var i = 0; i < folder.children.length; i++) {", "        var child = folder.children[i];", "        if (child.data.name === item.data.name && child.id !== item.id) {", "            tb.modal.update(m('', [", "                m('h3.break-word', 'An item named \"' + item.data.name + '\" already exists in this location.'),", "                m('p', 'Do you want to replace it?')", "            ]), m('', ["]}, {"lines": ["                m('span.tb-modal-btn.text-default', {onclick: cb.bind(tb, 'keep')}, 'Keep Both'),"]}, {"lines": ["            ]));", "            return;", "        }", "    }"]}, {"lines": ["    cb('replace');"]}, {"lines": ["}", ""]}, {"lines": ["function checkConflictsRename(tb, item, name, cb) {", "    var parent = item.parent();", "    for(var i = 0; i < parent.children.length; i++) {", "        var child = parent.children[i];", "        if (child.data.name === name && child.id !== item.id) {", "            tb.modal.update(m('', [", "                m('h3.break-word', 'An item named \"' + name + '\" already exists in this location.'),", "                m('p', 'Do you want to replace it?')", "            ]), m('', [", "                m('span.tb-modal-btn.text-default', {onclick: cb.bind(tb, 'keep')}, 'Keep Both'),"]}, {"lines": ["            ]));", "            return;", "        }", "    }", "    cb('replace');", "}", ""]}, {"lines": ["function doItemOp(operation, to, from, rename, conflict) {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    tb.modal.dismiss();"]}, {"lines": ["    var ogParent = from.parentID;"]}, {"lines": [""]}, {"lines": ["    if (operation === OPERATIONS.COPY) {"]}, {"lines": ["        from = tb.createItem($.extend(true, {status: operation.status}, from.data), to.id);"]}, {"lines": ["    } else {"]}, {"lines": ["        from.data.status = operation.status;"]}, {"lines": ["        from.move(to.id);"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["    if (to.data.provider === from.provider) {", "        tb.pendingFileOps.push(from.id);", "    }"]}, {"lines": [""]}, {"lines": ["    $.ajax({", "        type: 'POST',"]}, {"lines": ["        beforeSend: $osf.setXHRAuthorization,"]}, {"lines": ["        url: operation === OPERATIONS.COPY ? waterbutler.copyUrl() : waterbutler.moveUrl(),"]}, {"lines": ["        headers: {", "            'Content-Type': 'Application/json'", "        },", "        data: JSON.stringify({", "            'rename': rename,", "            'conflict': conflict,", "            'source': waterbutler.toJsonBlob(from),", "            'destination': waterbutler.toJsonBlob(to),", "        })"]}, {"lines": ["    }).done(function(resp, _, xhr) {"]}, {"lines": ["        if (to.data.provider === from.provider) {", "            tb.pendingFileOps.pop();", "        }"]}, {"lines": ["        if (xhr.status === 202) {", "            var mithrilContent = m('div', ["]}, {"lines": ["                m('h3.break-word', operation.action + ' \"' + from.data.materialized + '\" to \"' + (to.data.materialized || '/') + '\" is taking a bit longer than expected.'),"]}, {"lines": ["                m('p', 'We\\'ll send you an email when it has finished.'),"]}, {"lines": ["                m('p', 'In the mean time you can leave this page; your ' + operation.status + ' will still be completed.')"]}, {"lines": ["            ]);", "            var mithrilButtons = m('div', [", "                m('span.tb-modal-btn', { 'class' : 'text-default', onclick : function() { tb.modal.dismiss(); }}, 'OK')", "            ]);", "            tb.modal.update(mithrilContent, mithrilButtons);", "            return;"]}, {"lines": ["        }"]}, {"lines": ["        from.data = resp;", "        from.data.status = undefined;"]}, {"lines": ["        from.notify.update('Successfully ' + operation.passed + '.', 'success', null, 1000);"]}, {"lines": [""]}, {"lines": ["        if (xhr.status === 200) {"]}, {"lines": ["            to.children.forEach(function(child) {", "                if (child.data.name === from.data.name && child.id !== from.id) {", "                    child.removeSelf();", "                }", "            });", "        }", ""]}, {"lines": ["        inheritFromParent(from, from.parent());"]}, {"lines": [""]}, {"lines": ["        if (from.data.kind === 'folder' && from.data.children) {", "            from.children = [];", "            var child;", "            from.data.children.forEach(function(item) {", "                child = tb.buildTree(item, from);", "                inheritFromParent(child, from);", "                from.add(child);", "            });", "            from.open = true;", "            from.load = true;"]}, {"lines": ["        }"]}, {"lines": ["    }).fail(function(xhr, textStatus) {"]}, {"lines": ["        if (to.data.provider === from.provider) {", "            tb.pendingFileOps.pop();", "        }"]}, {"lines": ["        if (operation === OPERATIONS.COPY) {", "            from.removeSelf();", "        } else {"]}, {"lines": ["            from.move(ogParent);", "            from.data.status = undefined;"]}, {"lines": ["        }", ""]}, {"lines": ["        var message;", ""]}, {"lines": ["        if (xhr.status !== 500 && xhr.responseJSON && xhr.responseJSON.message) {"]}, {"lines": ["            message = xhr.responseJSON.message;"]}, {"lines": ["        } else if (xhr.status === 503) {", "            message = textStatus;"]}, {"lines": ["        } else {", "            message = 'Please refresh the page or ' +", "                'contact <a href=\"mailto: support@cos.io\">support@cos.io</a> if the ' +", "                'problem persists.';", "        }", "", "        $osf.growl(operation.verb + ' failed.', message);", ""]}, {"lines": ["        Raven.captureMessage('Failed to move or copy file', {", "            xhr: xhr,", "            requestData: {", "                rename: rename,", "                conflict: conflict,", "                source: waterbutler.toJsonBlob(from),", "                destination: waterbutler.toJsonBlob(to),", "            }", "        });", ""]}, {"lines": ["    });", "}", ""]}, {"lines": ["function _fangornResolveUploadUrl(item, file) {"]}, {"lines": ["    return configOption || waterbutler.buildTreeBeardUpload(item, file);"]}, {"lines": ["    var parent = file.treebeardParent;", "", "    var item,"]}, {"lines": ["    xhr = $osf.setXHRAuthorization(xhr);"]}, {"lines": ["    var _send = xhr.send;", "    xhr.send = function() {", "        _send.call(xhr, file);", "    };"]}, {"lines": ["    var item = file.treebeardParent;"]}, {"lines": ["    var configOption = resolveconfigOption.call(treebeard, item, 'uploadAdd', [file, item]);"]}, {"lines": [""]}, {"lines": ["    var item = file.treebeardParent;"]}, {"lines": ["    treebeard.options.uploadInProgress = false;", "    var parent = file.treebeardParent,", "        item,"]}, {"lines": ["        child;"]}, {"lines": ["        item.data = response;"]}, {"lines": ["            child.removeSelf();"]}, {"lines": ["    treebeard.options.uploadInProgress = false;"]}, {"lines": ["    window.location = waterbutler.buildTreeBeardDownload(item);"]}, {"lines": ["function _downloadZipEvent (event, item, col) {", "    try {", "        event.stopPropagation();", "    } catch (e) {", "        window.event.cancelBubble = true;", "    }", "    window.location = waterbutler.buildTreeBeardDownloadZip(item);", "}", ""]}, {"lines": ["    }"]}, {"lines": ["    }", ""]}, {"lines": ["    var extra = {};"]}, {"lines": ["    if (parent.data.provider === 'github') {", "        extra.branch = parent.data.branch;", "    }", ""]}, {"lines": ["        config: $osf.setXHRAuthorization,"]}, {"lines": ["        inheritFromParent({data: item}, parent, ['branch']);"]}, {"lines": ["}"]}, {"lines": ["        })", "        .done(function(data) {"]}, {"lines": ["        })", "        .fail(function(data){"]}, {"lines": ["    function doDelete() {"]}, {"lines": ["                var mithrilContent = m('div', ["]}, {"lines": ["                    ]);", "                var mithrilButtons = m('div', ["]}, {"lines": ["                    ]);", "                tb.modal.update(mithrilContent, mithrilButtons);"]}, {"lines": ["        } else {"]}, {"lines": ["        }", "    }", ""]}, {"lines": ["", "    if (item.data.provider === undefined) {", "        return false;", "    }"]}, {"lines": ["    return waterbutler.buildTreeBeardMetadata(item);"]}, {"lines": ["    return configOption || 'PUT';"]}, {"lines": [""]}, {"lines": ["        return [{"]}, {"lines": ["            data : '',  // Data field name", "            css : 't-a-c',", "            custom : function(){ return m('span.text-muted', [STATE_MAP[item.data.status].display, item.data.name, '...']); }", "        }, {", "            data : '',  // Data field name", "            custom : function(){ return '';}"]}, {"lines": ["        }];"]}, {"lines": ["", "    if (item.data.kind === 'file') {", "        default_columns.push(", "        {", "            data : 'size',  // Data field name", "            filter : true,", "            custom : function() {return item.data.size ? $osf.humanFileSize(item.data.size, true) : '';}"]}, {"lines": ["        if (item.data.provider === 'osfstorage') {", "            default_columns.push({", "                data : 'downloads',", "                sortInclude : false,", "                filter : false,", "                custom: function() { return item.data.extra ? item.data.extra.downloads.toString() : ''; }", "            });", "        } else {", "            default_columns.push({", "                data : 'downloads',", "                sortInclude : false,", "                filter : false,", "                custom : function() { return m(''); }", "            });", "        }"]}, {"lines": ["        width : '80%',"]}, {"lines": ["        title : 'Size',", "        width : '10%',", "        sort : false", "    }, {"]}, {"lines": ["    //TODO Error message?"]}, {"lines": ["    checkConflictsRename(tb, item, val, doItemOp.bind(tb, OPERATIONS.RENAME, folder, item, val));"]}, {"lines": ["            rowButtons.push(", "                m.component(FGButton, {", "                    onclick: function(event) { _downloadZipEvent.call(tb, event, item); },", "                    icon: 'fa fa-download',", "                    className : 'text-success'", "                }, 'Download as zip')", "            );"]}, {"lines": ["        self.tb.inputValue = m.prop('');"]}, {"lines": ["                        ctrl.tb.inputValue($(event.target).val());"]}, {"lines": ["                    value : ctrl.tb.inputValue(),"]}, {"lines": ["        templates[toolbarModes.DEFAULT] =  m('.col-xs-12', m('.pull-right', [finalRowButtons, generalButtons]));"]}, {"lines": ["    tb.inputValue(tb.multiselected()[0].data.name);"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    // if (items[0].data.kind === 'folder' && ['github', 'figshare', 'dataverse'].indexOf(folder.data.provider) !== -1) { return; }"]}, {"lines": [""]}, {"lines": ["    if (!folder.open) {"]}, {"lines": ["        return tb.updateFolder(null, folder, _dropLogic.bind(tb, event, items, folder));"]}, {"lines": ["    }", "", "    $.each(items, function(index, item) {"]}, {"lines": ["        checkConflicts(tb, item, folder, doItemOp.bind(tb, copyMode === 'move' ? OPERATIONS.MOVE : OPERATIONS.COPY, folder, item, undefined));"]}, {"lines": ["    });"]}, {"lines": ["    var canMove = true,", "    folder = this.find($(event.target).attr('data-id')),", "    dragGhost = $('.tb-drag-ghost');"]}, {"lines": [""]}, {"lines": ["    copyMode = getCopyMode(folder, items);"]}, {"lines": ["", "function getCopyMode(folder, items) {", "    var tb = this;", "    var canMove = true;"]}, {"lines": ["    var mustBeIntra = (folder.data.provider === 'github');"]}, {"lines": ["    var cannotBeFolder = (folder.data.provider === 'figshare' || folder.data.provider === 'dataverse');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    //Disallow moving INTO a public figshare folder"]}, {"lines": ["    if (", "        folder.data.provider === 'figshare' &&", "        folder.data.extra &&"]}, {"lines": ["        folder.data.extra.status &&"]}, {"lines": ["        folder.data.extra.status === 'public'"]}, {"lines": [""]}, {"lines": ["    for(var i = 0; i < items.length; i++) {", "        var item = items[i];"]}, {"lines": ["        if (", "            item.data.nodeType ||", "            item.data.isAddonRoot ||", "            item.id === folder.id ||", "            item.parentID === folder.id ||"]}, {"lines": ["            item.data.provider === 'dataverse' ||"]}, {"lines": ["            (cannotBeFolder && item.data.kind === 'folder') ||"]}, {"lines": ["            (mustBeIntra && item.data.provider !== folder.data.provider) ||", "            //Disallow moving OUT of a public figshare folder", "            (item.data.provider === 'figshare' && item.data.extra && item.data.status && item.data.status !== 'public')"]}, {"lines": [""]}, {"lines": ["        mustBeIntra = mustBeIntra || item.data.provider === 'github';"]}, {"lines": ["        canMove = (", "            canMove &&", "            item.data.permissions.edit &&", "            //Can only COPY OUT of figshare", "            item.data.provider !== 'figshare' &&", "            (!mustBeIntra || (item.data.provider === folder.data.provider && item.data.nodeId === folder.data.nodeId))", "        );"]}, {"lines": ["    }"]}, {"lines": ["    return 'move';", "}"]}, {"lines": ["    allowMove : true,       // Turn moving on or off."]}, {"lines": ["        tb.pendingFileOps = [];"]}, {"lines": ["            if(tb.dropzone && tb.dropzone.getUploadingFiles().length) {", "                return 'You have pending uploads, if you leave this page they may not complete.';"]}, {"lines": ["            if(tb.pendingFileOps.length > 0) {", "                return 'You have pending file operations, if you leave this page they may not complete.';", "            }"]}, {"lines": ["    _downloadZipEvent: _downloadZipEvent,"]}, {"lines": ["    _removeEvent: _removeEvent,"]}, {"lines": ["module.exports = Fangorn;"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": [""]}, {"lines": ["    return item.open ?"]}, {"lines": ["    return item.open ?"]}, {"lines": ["    }, ' ');"]}, {"lines": ["            tb.options.onPickFolder(evt, item);", "        },"]}, {"lines": ["    }, ' ');"]}, {"lines": ["        return templateUnchecked;"]}, {"lines": ["    if (item.data.path === tb.options.folderPath || (tb.options.folderArray && tb.options.folderArray[tb.options.folderArray.length - 1] === item.data.name)) {"]}, {"lines": ["", "    tb.options.folderIndex = 0;", "    if (tb.options.folderPath) {", "        tb.options.folderArray = tb.options.folderPath.split('/');"]}, {"lines": ["        if (tb.options.folderArray.length > 1) {", "            tb.options.folderArray.splice(0, 1);", "        }"]}, {"lines": ["    } else {", "        tb.options.folderArray = [''];", "    }", ""]}, {"lines": ["        tb.updateFolder(null, tb.treeData.children[0]);"]}, {"lines": ["    self.options.folderPath = opts.initialFolderPath;"]}, {"lines": ["    self.options.rootName = opts.rootName;"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    return $osf.urlParams().view_only;"]}, {"lines": ["function getDefaultOptions(path, provider) {"]}, {"lines": ["        path: path,"]}, {"lines": ["    };"]}, {"lines": ["}", ""]}, {"lines": ["    path = path || '/';"]}, {"lines": ["}", "", "var buildCrudUrl = buildUrl.bind(this, 'file?');"]}, {"lines": ["var buildCopyUrl = buildUrl.bind(this, 'copy?');", "var buildMoveUrl = buildUrl.bind(this, 'move?');"]}, {"lines": ["var buildMetadataUrl = buildUrl.bind(this, 'data?');"]}, {"lines": ["var buildRevisionsUrl = buildUrl.bind(this, 'revisions?');"]}, {"lines": ["var buildCreateFolderUrl = buildUrl.bind(this, 'folders?');"]}, {"lines": ["", ""]}, {"lines": ["    path = (path || '/') + file.name;"]}, {"lines": ["}", "", "function buildFromTreebeard(suffix, item, options) {"]}, {"lines": ["}", ""]}, {"lines": ["function buildFromTreebeardFile(item, file, options) {"]}, {"lines": ["}", ""]}, {"lines": ["function toJsonBlob(item, options) {", "    return $.extend(getDefaultOptions(item.data.path || '/', item.data.provider), {nid: item.data.nodeId}, options);", "}", ""]}, {"lines": ["module.exports = {"]}, {"lines": ["    toJsonBlob: toJsonBlob,"]}, {"lines": ["    buildDeleteUrl: buildCrudUrl,", "    buildUploadUrl: buildUploadUrl,"]}, {"lines": ["    buildMetadataUrl: buildMetadataUrl,"]}, {"lines": ["    buildCreateFolderUrl: buildCrudUrl,"]}, {"lines": ["    buildRevisionsUrl: buildRevisionsUrl,"]}, {"lines": ["    buildTreeBeardUpload: buildFromTreebeardFile,"]}, {"lines": ["    buildTreeBeardCopy: buildFromTreebeard.bind(this, 'copy?'),", "    buildTreeBeardMove: buildFromTreebeard.bind(this, 'move?'),"]}, {"lines": ["    buildTreeBeardDelete: buildFromTreebeard.bind(this, 'file?'),"]}, {"lines": ["    buildTreeBeardDownload: function(item, options) {", "        if (window.contextVars.accessToken) {", "            options = $.extend(options || {}, {token: window.contextVars.accessToken});", "        }", "        return buildFromTreebeard('file?', item, options);", "    },"]}, {"lines": ["    buildTreeBeardMetadata: buildFromTreebeard.bind(this, 'data?'),"]}, {"lines": ["    copyUrl: function(){return window.contextVars.waterbutlerURL + 'ops/copy';},", "    moveUrl: function(){return window.contextVars.waterbutlerURL + 'ops/move';}"]}, {"lines": ["};"]}, {"lines": ["var m = require('mithril');"]}, {"lines": ["var Raven = require('raven-js');", "var $osf = require('js/osfHelpers');"]}, {"lines": ["var ShareJSDoc = require('js/pages/ShareJSDocFile.js');"]}, {"lines": ["require('ace-noconflict');", "require('ace-mode-markdown');", "require('ace-ext-language_tools');", "require('addons/wiki/static/ace-markdown-snippets.js');"]}, {"lines": ["var Markdown = require('pagedown-ace-converter');", "Markdown.getSanitizingConverter = require('pagedown-ace-sanitizer').getSanitizingConverter;", "require('imports?Markdown=pagedown-ace-converter!pagedown-ace-editor');"]}, {"lines": ["", "", "var util = require('./util.js');"]}, {"lines": [""]}, {"lines": ["var model = {};", ""]}, {"lines": ["var FileEditor = {"]}, {"lines": ["    controller: function(contentUrl, shareWSUrl, editorMeta, observables) {"]}, {"lines": ["        var self = {};", ""]}, {"lines": ["        self.url = contentUrl;", "        self.loaded = false;", "        self.initialText = '';"]}, {"lines": ["        self.editorMeta = editorMeta;"]}, {"lines": [""]}, {"lines": ["        self.observables = observables;"]}, {"lines": ["        self.unthrottledStatus = self.observables.status;"]}, {"lines": ["        $osf.throttle(self.observables.status, 4000, {leading: false});"]}, {"lines": ["        self.bindAce = function(element, isInitialized, context) {"]}, {"lines": ["            model.editor = ace.edit(element.id);"]}, {"lines": ["            model.editor.setValue(self.initialText, -1);"]}, {"lines": ["            new ShareJSDoc(shareWSUrl, self.editorMeta, model.editor, self.observables);"]}, {"lines": ["        };", "", "        self.reloadFile = function() {", "            self.loaded = false;", "            $.ajax({", "                type: 'GET',", "                url: self.url,"]}, {"lines": ["                dataType: 'text',"]}, {"lines": ["                beforeSend: $osf.setXHRAuthorization,", "            }).done(function (parsed, status, response) {"]}, {"lines": ["                m.startComputation();", "                self.loaded = true;"]}, {"lines": ["                self.initialText = response.responseText;"]}, {"lines": ["                if (model.editor) {", "                    model.editor.setValue(self.initialText);"]}, {"lines": ["                }"]}, {"lines": ["                m.endComputation();", "            }).fail(function (xhr, textStatus, error) {", "                $osf.growl('Error','The file content could not be loaded.');", "                Raven.captureMessage('Could not GET file contents.', {", "                    url: self.url,", "                    textStatus: textStatus,", "                    error: error", "                });", "            });", "        };", ""]}, {"lines": ["        self.saveFile = $osf.throttle(function() {"]}, {"lines": ["                var oldstatus = self.observables.status();"]}, {"lines": ["                model.editor.setReadOnly(true);"]}, {"lines": ["                self.unthrottledStatus('saving');"]}, {"lines": ["                m.redraw();"]}, {"lines": ["                    url: self.url,"]}, {"lines": ["                    data: model.editor.getValue(),"]}, {"lines": ["                    model.editor.setReadOnly(false);"]}, {"lines": ["                    self.unthrottledStatus(oldstatus);"]}, {"lines": ["                    $(document).trigger('fileviewpage:reload');"]}, {"lines": ["                    self.initialText = model.editor.getValue();"]}, {"lines": ["                    m.redraw();"]}, {"lines": ["                    model.editor.setReadOnly(false);"]}, {"lines": ["                    self.unthrottledStatus(oldstatus);"]}, {"lines": ["                    $(document).trigger('fileviewpage:reload');"]}, {"lines": ["                    model.editor.setValue(self.initialText);"]}, {"lines": ["                    m.redraw();"]}, {"lines": ["                });"]}, {"lines": ["        }, 500);"]}, {"lines": [""]}, {"lines": ["        self.changed = function() {"]}, {"lines": ["            var file1 = self.initialText;"]}, {"lines": ["            var file2 = !model.editor ? '' : model.editor.getValue();"]}, {"lines": ["", "            var clean1 = typeof file1 === 'string' ?", "                file1.replace(/(\\r\\n|\\n|\\r)/gm, '\\n') : '';", "            var clean2 = typeof file2 === 'string' ?", "                file2.replace(/(\\r\\n|\\n|\\r)/gm, '\\n') : '';", ""]}, {"lines": ["            return clean1 !== clean2;"]}, {"lines": ["        };", ""]}, {"lines": ["        self.reloadFile();"]}, {"lines": ["        return self;"]}, {"lines": ["    },"]}, {"lines": ["    view: function(ctrl) {"]}, {"lines": ["", "        return m('.editor-pane', ["]}, {"lines": ["                m('.ul.list-inline', {style: {'margin-top': '10px'}}, ["]}, {"lines": ["                    ctrl.observables.activeUsers().map(function(user) {"]}, {"lines": ["                        return m('li', m('a', {href: user.url}, ["]}, {"lines": ["                            m('img', {", "                                title: user.name,", "                                src: user.gravatar,"]}, {"lines": ["                                'data-container': 'body',"]}, {"lines": ["                                'data-placement': 'top',", "                                'data-toggle': 'tooltip',", "                                style: {border: '1px solid black'}", "                            })", "                        ]));", "                    })", "", "                ])", "            ]))),"]}, {"lines": ["            m('', {style: {'padding-top': '10px'}}, ["]}, {"lines": ["            m('br'),", "            m('.osf-panel-footer[style=position:inherit]', ["]}, {"lines": ["                    m('.pull-right', ["]}, {"lines": ["                        m('button#fileEditorRevert.btn.btn-sm.btn-danger', {onclick: function(){ctrl.reloadFile();}}, 'Revert'),"]}, {"lines": ["                        ' ',"]}, {"lines": ["                        m('button#fileEditorSave.btn.btn-sm.btn-success', {onclick: function() {ctrl.saveFile();}}, 'Save')"]}, {"lines": ["                    ])", "                ]))", "            ])"]}, {"lines": ["        ]);", ""]}, {"lines": ["    }", "};", "", "module.exports = FileEditor;"]}, {"lines": ["var m = require('mithril');", "var $ = require('jquery');", "var $osf = require('js/osfHelpers');"]}, {"lines": ["var waterbutler = require('js/waterbutler');"]}, {"lines": ["", "var util = require('./util.js');", ""]}, {"lines": ["// Helper for filtering", "function TRUTHY(item) {", "    return !!item; //Force cast to a bool", "}", "", ""]}, {"lines": ["    hasUser: false,", "    hasDate: false,"]}, {"lines": ["var FileRevisionsTable = {"]}, {"lines": ["    controller: function(file, node, enableEditing, canEdit) {"]}, {"lines": ["        var self = {};"]}, {"lines": ["        self.node = node;"]}, {"lines": ["        self.file = file;"]}, {"lines": ["        self.canEdit = canEdit;"]}, {"lines": ["        self.enableEditing = enableEditing;"]}, {"lines": [""]}, {"lines": ["", "        self.reload = function() {"]}, {"lines": ["            m.redraw();"]}, {"lines": ["            $.ajax({", "                dataType: 'json',"]}, {"lines": ["                url: self.file.urls.revisions,", "                beforeSend: $osf.setXHRAuthorization", "            }).done(function(response) {"]}, {"lines": ["                m.startComputation();"]}, {"lines": ["                var urlParmas = $osf.urlParams();"]}, {"lines": ["                    rev = FileRevisionsTable.postProcessRevision(self.file, self.node, rev, index);", "                    if (urlParmas[rev.versionIdentifier] === rev.version) {"]}, {"lines": ["                    }", "                    return rev;", "                });"]}, {"lines": ["                // Can only edit the latest version of a file"]}, {"lines": ["                    self.enableEditing();"]}, {"lines": ["                }"]}, {"lines": ["                m.endComputation();"]}, {"lines": ["            }).fail(function(response) {"]}, {"lines": ["                m.startComputation();"]}, {"lines": ["                    response.responseJSON.message || 'Unable to fetch versions' :", "                    'Unable to fetch versions';"]}, {"lines": ["                m.endComputation();"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                if (self.file.provider === 'figshare') {", "                    // Hack for Figshare", "                    // only figshare will error on a revisions request", "                    // so dont allow downloads and set a fake current version", "                    $.ajax({", "                        method: 'GET',", "                        url: self.file.urls.metadata,", "                        beforeSend: $osf.setXHRAuthorization", "                    }).done(function(resp) {", "                        self.canEdit(self.canEdit() && resp.data.extra.canDelete);", "                        m.redraw();", "                    }).fail(function(xhr) {", "                        self.canEdit(false);", "                        m.redraw();", "                    });", "                }"]}, {"lines": ["            });", "        };", "", "        self.getTableHead = function() {", "            return m('thead', [", "                m('tr', [", "                    m('th', 'Version ID'),"]}, {"lines": ["                    m('th[colspan=2]', 'Download'),", "                ].filter(TRUTHY))", "            ]);", "        };", "", "        self.makeTableRow = function(revision, index) {"]}, {"lines": [""]}, {"lines": ["            return m('tr' + (isSelected ? '.active' : ''), [", "                m('td',  isSelected ?"]}, {"lines": ["                  revision.displayVersion :", "                  m('a', {href: revision.osfViewUrl}, revision.displayVersion)", "                ),"]}, {"lines": ["                    m('td', revision.extra.user.url ?", "                        m('a', {href: revision.extra.user.url}, revision.extra.user.name) :", "                        revision.extra.user.name", "                    ) : false,", "                m('td', revision.extra.downloads > -1 ? m('.badge', revision.extra.downloads) : ''),", "                m('td',", "                  m('a.btn.btn-primary.btn-sm.file-download', {", "                        href: revision.osfDownloadUrl,", "                        onclick: function() {", "                            window.location = revision.waterbutlerDownloadUrl;", "                            return false;", "                        }", "                    }, m('i.fa.fa-download'))", "                ),", "            ].filter(TRUTHY));", "        };", ""]}, {"lines": ["        $(document).on('fileviewpage:reload', self.reload);"]}, {"lines": ["        return self;"]}, {"lines": ["    },", "    view: function(ctrl) {"]}, {"lines": ["        return m('#revisionsPanel', [", "            m('.osf-panel-header', 'Revisions'),", "            m('', (function() {"]}, {"lines": [""]}, {"lines": ["                return m('table.table', [", "                    ctrl.getTableHead(),", "                    m('tbody', model.revisions.map(ctrl.makeTableRow))", "                ]);", "            })())"]}, {"lines": ["        ]);"]}, {"lines": [""]}, {"lines": ["    },", "    postProcessRevision: function(file, node, revision, index) {", "        var options = {};", "        var urlParams = $osf.urlParams();", "", "        if (urlParams.branch !== undefined) {", "            options.branch = urlParams.branch;", "        }"]}, {"lines": ["        options[revision.versionIdentifier] = revision.version;"]}, {"lines": ["", "        revision.date = new $osf.FormattableDate(revision.modified);", "        revision.displayDate = revision.date.local !== 'Invalid date' ?", "            revision.date.local :", "            revision.date;", "", "        switch (file.provider) {", "            // Note: Google Drive version identifiers often begin with the same sequence", "            case 'googledrive':", "                revision.displayVersion = revision.version.substring(revision.version.length - 8);", "                break;", "            // Note: Dataverse internal version names are ugly; Substitute our own", "            case 'dataverse':", "                var displayMap = {", "                    'latest': 'Draft',", "                    'latest-published': 'Published'", "                };", "", "                revision.displayVersion = revision.version in displayMap ?", "                    displayMap[revision.version] : revision.version.substring(0, 8);", "                break;", "            default:", "                revision.displayVersion = revision.version.substring(0, 8);", "        }", ""]}, {"lines": ["        if (file.provider === 'osfstorage' && file.name && index !== 0) {", "            var parts = file.name.split('.');", "            if (parts.length === 1) {", "                options.displayName = parts[0] + '-' + revision.modified;", "            } else {", "                options.displayName = parts.slice(0, parts.length - 1).join('') + '-' + revision.modified + '.' + parts[parts.length - 1];", "            }", "        }", "", "        revision.osfViewUrl = '?' + $.param(options);", "        revision.osfDownloadUrl = '?' + $.param($.extend({action: 'download'}, options));", "        revision.waterbutlerDownloadUrl = waterbutler.buildDownloadUrl(file.path, file.provider, node.id, options);"]}, {"lines": ["", "        return revision;"]}, {"lines": ["    }", "};", "", "module.exports = FileRevisionsTable;"]}, {"lines": ["    var clientTimezone = jstz.determine().name();"]}, {"lines": ["});"]}, {"lines": ["var m = require('mithril');"]}, {"lines": ["    self.activeUsers = observables.activeUsers;"]}, {"lines": ["    var ctx = window.contextVars.file;"]}, {"lines": ["    self.collaborative = collaborative;"]}, {"lines": [""]}, {"lines": ["        if (!collaborative) {", "            if (typeof WebSocket === 'undefined') {", "                self.observables.status('unsupported');", "            } else {", "                self.observables.status('disconnected');", "            }", "            return;", "        }"]}, {"lines": ["            var x = self.editor.getValue();"]}, {"lines": ["            doc.attachAce(self.editor);", "            self.editor.setValue(x);", "        } else {", "            doc.attachAce(self.editor);"]}, {"lines": ["        unlockEditor();", "        self.observables.status('connected');", "        madeConnection = true;"]}, {"lines": ["            window.location.reload();"]}, {"lines": ["                self.activeUsers(Object.keys(data.users).filter(function(key) {", "                    return key !== self.observables.userId;", "                }).map(function(key) {", "                    data.users[key].id = key;", "                    return data.users[key];", "                }));", "                m.redraw();"]}, {"lines": ["module.exports = ShareJSDoc;"]}, {"lines": ["            // buttonState = the visibility of column after click, taen from data-osf-toggle attribute,"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["require('c3/c3.css');"]}, {"lines": ["require('../../css/share-search.css');", ""]}, {"lines": ["var History = require('exports?History!history');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    History.Adapter.bind(window, 'statechange', function(e) {", "        var state = History.getState().data;"]}, {"lines": ["        utils.search(self.vm);", "    });"]}, {"lines": ["                        'text-align': 'center'", "                    }"]}, {"lines": ["            }, ["]}, {"lines": ["                m('img[src=/static/img/share-logo-icon.png]', {", "                    style: {", "                        height: 'auto',", "                        'max-width': '15%',"]}, {"lines": ["                    // class: 'animated pulse'"]}, {"lines": ["                m('span.about-share-header', 'SHARE'),"]}, {"lines": ["                ])),"]}, {"lines": ["                m('br'),"]}, {"lines": ["                    m('input.share-search-input.form-control[type=text][placeholder=Search][autofocus]', {"]}, {"lines": ["    return c3.generate({", "        bindto: '#shareDonutGraph',"]}, {"lines": ["            height: 200"]}, {"lines": ["        data: data.charts.shareDonutGraph,"]}, {"lines": ["function timeGraph (data) {", "    return c3.generate({"]}, {"lines": ["            height: 200"]}, {"lines": ["        data: data.charts.shareTimeGraph,"]}, {"lines": ["                   text: 'Number of Events',"]}, {"lines": [""]}, {"lines": ["created"]}, {"lines": ["deleted"]}, {"lines": ["created"]}, {"lines": ["created"]}, {"lines": ["removed"]}, {"lines": ["made"]}, {"lines": ["made"]}, {"lines": ["from"]}, {"lines": ["to"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{{ params.title_new }}}</a>"]}, {"lines": ["registered"]}, {"lines": ["created fork from"]}, {"lines": ["to"]}, {"lines": ["from"]}, {"lines": ["to"]}, {"lines": ["on"]}, {"lines": ["on"]}, {"lines": ["visible on"]}, {"lines": ["invisible on"]}, {"lines": ["", "<script type=\"text/html\" id=\"addon_file_copied\">"]}, {"lines": ["  {{#if params.source.materialized.endsWith('/')}}", "    copied <span class=\"overflow log-folder\">{{ params.source.materialized }}</span> from {{ params.source.addon }} in"]}, {"lines": ["    <a class=\"log-node-title-link overflow\" href=\"{{ params.source.node.url }}\">{{{ params.source.node.title }}}</a>"]}, {"lines": ["    to <span class=\"overflow log-folder\">{{ params.destination.materialized }}</span> in {{ params.destination.addon }} in", "    <a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: $parent.nodeUrl}, text: $parent.nodeTitle\"></a>", "  {{/if}}", "  {{#ifnot params.source.materialized.endsWith('/')}}", "    copied <a href=\"{{ params.source.url }}\" class=\"overflow\">{{ params.source.materialized }}</a> from {{ params.source.addon }} in"]}, {"lines": ["    <a class=\"log-node-title-link overflow\" href=\"{{ params.source.node.url }}\">{{{ params.source.node.title }}}</a>"]}, {"lines": ["    to <a href=\"{{ params.destination.url }}\" class=\"overflow\">{{ params.destination.materialized }}</a> in {{ params.destination.addon }} in", "    <a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: $parent.nodeUrl}, text: $parent.nodeTitle\"></a>", "  {{/ifnot}}"]}, {"lines": ["</script>", "", "<script type=\"text/html\" id=\"addon_file_moved\">"]}, {"lines": ["  {{#if params.source.materialized.endsWith('/')}}", "  moved <span class=\"overflow\">{{ params.source.materialized }}</span> from {{ params.source.addon }} in"]}, {"lines": ["  <a class=\"log-node-title-link overflow\" href=\"{{ params.source.node.url }}\">{{{ params.source.node.title }}}</a>"]}, {"lines": ["  to <span class=\"overflow log-folder\">{{ params.destination.materialized }}</span> in {{ params.destination.addon }} in", "  <a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: $parent.nodeUrl}, text: $parent.nodeTitle\"></a>", "  {{/if}}", "  {{#ifnot params.source.materialized.endsWith('/')}}"]}, {"lines": ["  moved <span class=\"overflow\">{{ params.source.materialized }}</span> from {{ params.source.addon }} in"]}, {"lines": ["  <a class=\"log-node-title-link overflow\" href=\"{{ params.source.node.url }}\">{{{ params.source.node.title }}}</a>"]}, {"lines": ["  to <a href=\"{{ params.destination.url }}\" class=\"overflow\">{{ params.destination.materialized }}</a> in {{ params.destination.addon }} in"]}, {"lines": ["  <a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: $parent.nodeUrl}, text: $parent.nodeTitle\"></a>"]}, {"lines": ["  {{/ifnot}}"]}, {"lines": ["</script>"]}, {"lines": [""]}, {"lines": ["on"]}, {"lines": ["<!doctype html>", "<html class=\"no-js\" lang=\"\">", "<head>", "    <meta charset=\"utf-8\">", "    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">", "    <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\">", "    <title>COS Email Notification Template</title>", "    <meta name=\"description\" content=\"Center for Open Science Notifications\">", "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">", "</head>", "<body leftmargin=\"0\" marginwidth=\"0\" topmargin=\"0\" marginheight=\"0\" offset=\"0\" style=\"-webkit-text-size-adjust: none;font-family: 'Helvetica', sans-serif;background: #eeeeee;padding: 0;margin: 0;border: none;list-style: none;width: 100% !important;\">", "<table id=\"layout-table\" width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">", "    <tr>", "        <td style=\"border-collapse: collapse;\">", "            <table id=\"layout-table\" width=\"100%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\" height=\"100%\">", "                <tbody>", "                    <tr class=\"banner\" style=\"background: #214762;color: white;\">", "                        <td class=\"text-center\" style=\"border-collapse: collapse;text-align: center;\">", "                            <table id=\"header-logo\" border=\"0\" style=\"margin: 0 auto;padding: 0px;\">", "                                <tr>", "                                    <td style=\"border-collapse: collapse;\">", "                                        <img src=\"https://osf.io/static/img/cos-white2.png\" alt=\"COS logo\" width=\"36\" style=\"border: 0;height: auto;line-height: 100%;outline: none;text-decoration: none;\">", "                                    </td>", "                                    <td style=\"border-collapse: collapse;\">", "                                        <h2 style=\"padding: 0;margin: 0;border: none;list-style: none;font-weight: 300;font-size: 20px;text-align: left; color:white;\">Open Science Framework</h2>", "                                    </td>", "                                </tr>", "                            </table>", "                        </td>", "                    </tr>", "                </tbody>", "            </table>", "        </td>", "    </tr>", "    <tr>", "        <td style=\"border-collapse: collapse;\">", "            <table id=\"content\" width=\"600\" border=\"0\" cellpadding=\"25\" cellspacing=\"0\" align=\"center\" style=\"margin: 30px auto 0 auto;background: white;box-shadow: 0 0 2px #ccc;\">", "                <tbody>", "                    <tr>", "                        <td style=\"border-collapse: collapse;\">", "                            <h3 class=\"text-center\" style=\"padding: 0;margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300;text-align: center;\">Recent Activity</h3>", "                        </td>", "                    </tr>", "                    <tr>", "                        <th colspan=\"2\" style=\"padding: 0px 15px 0 15px\">", "                            <h3 style=\"padding: 0 15px 5px 15px; margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300; border-bottom: 1px solid #eee; text-align: left;\">", "                              ${destination_node.title}", "                              %if destination_node.parent_node:", "                                <small style=\"font-size: 14px;color: #999;\"> in ${destination_node.parent_node.title} </small>", "                              %endif", "                            </h3>", "                        </th>", "                    </tr>", "                </tbody>", "                <tbody>", "                    <tr>", "                        <td style=\"border-collapse: collapse;\">", "                          An error has occurred, and the ${'folder' if source_path.endswith('/') else 'file'} from ${source_node.title} on The Open Science Framework was not successfully ${'moved' if action == 'move' else 'copied'}.", "                          Please log in and try this action again. If the problem persists, please email support@osf.io.", "                        </td>", "                    </tr>", "                </tbody>", "            </table>", "        </td>", "    </tr>", "    <tr>", "        <td style=\"border-collapse: collapse; padding-top: 15px;\">", "            <table width=\"80%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\" align=\"center\" class=\"footer\" style=\"margin-top: 45px;padding: 25px 0 35px;background-color: rgb(244, 244, 244);border-top: 1px solid #E5E5E5;border-bottom: 1px solid #E5E5E5;width: 100%;color: #555;\">", "                <tbody>", "                    <tr>", "                        <td style=\"border-collapse: collapse;\">", "                            <p class=\"small text-center\" style=\"text-align: center;font-size: 12px;\">Copyright &copy; 2015 Center For Open Science, All rights reserved. </p>", "                            <p class=\"small text-center\" style=\"text-align: center;font-size: 12px; line-height: 20px;\">You received this email because you are subscribed to email notifications. <br><a href=\"${url}\" style=\"padding: 0;margin: 0;border: none;list-style: none;color: #008de5;text-decoration: none;font-weight: bold;\">Update Subscription Preferences</a></p>", "                        </td>", "                    </tr>", "                </tbody>", "            </table>", "        </td>", "    </tr>", "</table>", "</body>", "</html>"]}, {"lines": ["<!doctype html>", "<html class=\"no-js\" lang=\"\">", "<head>", "    <meta charset=\"utf-8\">", "    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">", "    <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\">", "    <title>COS Email Notification Template</title>", "    <meta name=\"description\" content=\"Center for Open Science Notifications\">", "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">", "</head>", "<body leftmargin=\"0\" marginwidth=\"0\" topmargin=\"0\" marginheight=\"0\" offset=\"0\" style=\"-webkit-text-size-adjust: none;font-family: 'Helvetica', sans-serif;background: #eeeeee;padding: 0;margin: 0;border: none;list-style: none;width: 100% !important;\">", "<table id=\"layout-table\" width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">", "    <tr>", "        <td style=\"border-collapse: collapse;\">", "            <table id=\"layout-table\" width=\"100%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\" height=\"100%\">", "                <tbody>", "                    <tr class=\"banner\" style=\"background: #214762;color: white;\">", "                        <td class=\"text-center\" style=\"border-collapse: collapse;text-align: center;\">", "                            <table id=\"header-logo\" border=\"0\" style=\"margin: 0 auto;padding: 0px;\">", "                                <tr>", "                                    <td style=\"border-collapse: collapse;\">", "                                        <img src=\"https://osf.io/static/img/cos-white2.png\" alt=\"COS logo\" width=\"36\" style=\"border: 0;height: auto;line-height: 100%;outline: none;text-decoration: none;\">", "                                    </td>", "                                    <td style=\"border-collapse: collapse;\">", "                                        <h2 style=\"padding: 0;margin: 0;border: none;list-style: none;font-weight: 300;font-size: 20px;text-align: left; color:white;\">Open Science Framework</h2>", "                                    </td>", "                                </tr>", "                            </table>", "                        </td>", "                    </tr>", "                </tbody>", "            </table>", "        </td>", "    </tr>", "    <tr>", "        <td style=\"border-collapse: collapse;\">", "            <table id=\"content\" width=\"600\" border=\"0\" cellpadding=\"25\" cellspacing=\"0\" align=\"center\" style=\"margin: 30px auto 0 auto;background: white;box-shadow: 0 0 2px #ccc;\">", "                <tbody>", "                    <tr>", "                        <td style=\"border-collapse: collapse;\">", "                            <h3 class=\"text-center\" style=\"padding: 0;margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300;text-align: center;\">Recent Activity</h3>", "                        </td>", "                    </tr>", "                    <tr>", "                        <th colspan=\"2\" style=\"padding: 0px 15px 0 15px\">", "                            <h3 style=\"padding: 0 15px 5px 15px; margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300; border-bottom: 1px solid #eee; text-align: left;\">", "                              ${destination_node.title}", "                              %if destination_node.parent_node:", "                                <small style=\"font-size: 14px;color: #999;\"> in ${destination_node.parent_node.title} </small>", "                              %endif", "                            </h3>", "                        </th>", "                    </tr>", "                </tbody>", "                <tbody>", "                    <tr>", "                        <td style=\"border-collapse: collapse;\">", "                          The ${'folder' if source_path.endswith('/') else 'file'} \"${source_path.strip('/')}\" has been successfully ${'moved' if action == 'move' else 'copied'} from ${source_addon} in ${source_node.title} to ${destination_addon}.", "                        </td>", "                    </tr>", "                </tbody>", "            </table>", "        </td>", "    </tr>", "    <tr>", "        <td style=\"border-collapse: collapse; padding-top: 15px;\">", "            <table width=\"80%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\" align=\"center\" class=\"footer\" style=\"margin-top: 45px;padding: 25px 0 35px;background-color: rgb(244, 244, 244);border-top: 1px solid #E5E5E5;border-bottom: 1px solid #E5E5E5;width: 100%;color: #555;\">", "                <tbody>", "                    <tr>", "                        <td style=\"border-collapse: collapse;\">", "                            <p class=\"small text-center\" style=\"text-align: center;font-size: 12px;\">Copyright &copy; 2015 Center For Open Science, All rights reserved. </p>", "                            <p class=\"small text-center\" style=\"text-align: center;font-size: 12px; line-height: 20px;\">You received this email because you are subscribed to email notifications. <br><a href=\"${url}\" style=\"padding: 0;margin: 0;border: none;list-style: none;color: #008de5;text-decoration: none;font-weight: bold;\">Update Subscription Preferences</a></p>", "                        </td>", "                    </tr>", "                </tbody>", "            </table>", "        </td>", "    </tr>", "</table>", "</body>", "</html>"]}, {"lines": ["        <h4>"]}, {"lines": ["            <span data-bind=\"foreach: {data: discussion, afterAdd: setupToolTips}\" class=\"pull-right\">", "                <a data-toggle=\"tooltip\" data-bind=\"attr: {href: url, title: fullname}\" data-placement=\"bottom\">", "                    <img data-bind=\"attr: {src: gravatarUrl}\"/>", "                </a>", "            </span>", "        </h4>"]}, {"lines": ["        <div data-bind=\"if: canComment\" style=\"margin-top: 20px\">"]}, {"lines": ["                <div data-bind=\"if: replyNotEmpty\" class=\"form-inline\">"]}, {"lines": ["    <div class=\"comment-container\" data-bind=\"if: shouldShow\">"]}, {"lines": ["                        <img data-bind=\"attr: {src: author.gravatarUrl}\"/>"]}, {"lines": ["                            <div class=\"form-group\" style=\"padding-top: 10px\">"]}, {"lines": ["                            <div class=\"form-inline\">"]}, {"lines": ["                        <span>&nbsp;</span>"]}, {"lines": ["                        <div data-bind=\"ifnot: editing\" class=\"comment-actions pull-right\">"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                    <div class=\"form-group\" style=\"padding-top: 10px\">"]}, {"lines": ["                    <div>"]}, {"lines": [""]}, {"lines": ["                    <br />", ""]}, {"lines": [""]}, {"lines": ["<%inherit file=\"project/project_base.mako\"/>"]}, {"lines": ["<%def name=\"title()\">${file_name | h}</%def>"]}, {"lines": ["<div class=\"row\">"]}, {"lines": ["    <h2 class=\"break-word\">", "      ${file_name | h}", "      % if file_revision:", "        <small>&nbsp;${file_revision | h}</small>", "      % endif"]}, {"lines": ["    </h2>", "  </div>"]}, {"lines": ["    <div id=\"toggleBar\" class=\"pull-right\"></div>"]}, {"lines": ["  </div>"]}, {"lines": ["</div>", "<hr>", "<div class=\"row\">"]}, {"lines": [""]}, {"lines": ["      <div class=\"osf-panel-header osf-panel-header-flex\" style=\"display:none\">", "        <div id=\"filesSearch\"></div>", "        <div id=\"toggleIcon\" class=\"pull-right\">"]}, {"lines": ["      </div>"]}, {"lines": ["      <div class=\"osf-panel-body osf-panel-body-flex file-page reset-height\">", "        <div id=\"grid\">", "          <div class=\"fangorn-loading\">", "            <div class=\"logo-spin text-center\"><img src=\"/static/img/logo_spin.png\" alt=\"loader\"> </div>", "            <p class=\"m-t-sm fg-load-message\"> Loading files...  </p>", "          </div>", "        </div>", "      </div>", "    </div>"]}, {"lines": ["    <!-- Menu toggle closed -->"]}, {"lines": ["      <div class=\"osf-panel-header\">", "        <i class=\"fa fa-file\"></i>", "        <i class=\"fa fa-angle-right\"></i>", "      </div>", "    </div>"]}, {"lines": ["  </div>"]}, {"lines": ["    <div class=\"row\">"]}, {"lines": ["        <div id=\"mfrIframe\" class=\"mfr mfr-file\"></div>", "      </div>"]}, {"lines": [""]}, {"lines": ["    </div>", "  </div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["## Begin Modals", "<div class=\"modal fade\" id=\"connectedModal\" tabindex=\"-1\">", "  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>", "        <h3 class=\"modal-title\">Connected to collaborative file editing</h3>", "      </div>", "      <div class=\"modal-body\">", "        <p>", "          This page is currently connected to collaborative file editing. All edits made will be visible to", "          contributors with write permission in real time. Changes will be stored", "          but not published until you click the \"Save\" button.", "        </p>", "      </div>", "    </div>", "  </div>", "</div>"]}, {"lines": [""]}, {"lines": ["<div class=\"modal fade\" id=\"connectingModal\" tabindex=\"-1\">", "  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>", "        <h3 class=\"modal-title\">Connecting to collaborative file editing</h3>", "      </div>", "      <div class=\"modal-body\">", "        <p>", "          This page is currently attempting to connect to collaborative file editing. You may continue to make edits.", "          <strong>Changes will not be saved until you press the \"Save\" button.</strong>", "        </p>", "      </div>", "    </div>", "  </div>", "</div>"]}, {"lines": [""]}, {"lines": ["<div class=\"modal fade\" id=\"disconnectedModal\" tabindex=\"-1\">", "  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>", "        <h3 class=\"modal-title\">Collaborative file editing is unavailable</h3>", "      </div>", "      <div class=\"modal-body\">", "        <p>", "          Collaborative file editing is currently unavailable. You may continue to make edits.", "          <strong>Changes will not be saved until you press the \"Save\" button.</strong>", "        </p>", "      </div>", "    </div>", "  </div>", "</div>"]}, {"lines": [""]}, {"lines": ["<div class=\"modal fade\" id=\"unsupportedModal\" tabindex=\"-1\">", "  <div class=\"modal-dialog\">", "    <div class=\"modal-content\">", "      <div class=\"modal-header\">", "        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>", "        <h3 class=\"modal-title\">Browser unsupported</h3>", "      </div>", "      <div class=\"modal-body\">", "        <p>", "          Your browser does not support collaborative editing. You may continue to make edits.", "          <strong>Changes will not be saved until you press the \"Save\" button.</strong>", "        </p>", "      </div>", "    </div>", "  </div>", "</div>", "## End Modals block"]}, {"lines": ["<%def name=\"javascript_bottom()\">", "    ${parent.javascript_bottom()}"]}, {"lines": ["            size: ${size},"]}, {"lines": ["            error: '${error | js_str}',"]}, {"lines": ["            safeName: '${file_name | h,js_str}',", "            materializedPath: '${materialized_path | js_str}',"]}, {"lines": ["          urls: {", "        %if error is None:", "              render: '${urls['render']}',", "        %endif"]}, {"lines": ["              sharejs: '${urls['sharejs'] | js_str}',", "            }", "        },", "        editor: {", "            registration: true,", "            docId: '${sharejs_uuid}',", "            userId: '${user['id']}',", "            userName: '${user['fullname'] | js_str}',", "            userUrl: '/${user['id']}/',", "            userGravatar: '${urls['gravatar']}'.replace('&amp;', '&')"]}, {"lines": ["            files: '${urls['files'] | js_str}'"]}, {"lines": ["        panelsUsed: ['edit', 'view'],"]}, {"lines": ["        }"]}, {"lines": ["    <script src=\"//${urls['sharejs']}/text.js\"></script>", "    <script src=\"//${urls['sharejs']}/share.js\"></script>"]}, {"lines": ["    <script src=${\"/static/public/js/file-page.js\" | webpack_asset}></script>"]}, {"lines": ["    <script src=${\"/static/public/js/view-file-tree-page.js\" | webpack_asset}></script>"]}, {"lines": ["</%def>"]}, {"lines": ["</div>"]}, {"lines": ["    ${self.title()}"]}, {"lines": ["", "<%def name=\"title()\">", "    <h4>${addon_full_name}</h4>", "</%def>"]}, {"lines": ["import furl", ""]}, {"lines": ["waterbutler_action_map = {", "    'upload': 'file',", "    'delete': 'file',", "    'download': 'file',", "    'metadata': 'data',"]}, {"lines": ["    'create_folder': 'file',"]}, {"lines": ["}"]}, {"lines": ["def api_url_for(view_name, _absolute=False, _xml=False, *args, **kwargs):"]}, {"lines": ["        return urlparse.urljoin(website_settings.DOMAIN, url)"]}, {"lines": ["def web_url_for(view_name, _absolute=False, _guid=False, *args, **kwargs):"]}, {"lines": ["        return urlparse.urljoin(website_settings.DOMAIN, url)"]}, {"lines": ["    \"\"\"Reverse URL lookup for WaterButler routes", "    :param str route: The action to preform, upload, download, delete...", "    :param str provider: The name of the requested provider", "    :param str path: The path of the requested file or folder", "    :param Node node: The node being accessed", "    :param User user: The user whos cookie will be used or None", "    :param dict **query: Addition query parameters to be appended", "    \"\"\""]}, {"lines": ["    url.path.segments.append(waterbutler_action_map[route])", "", "    url.args.update({", "        'path': path,", "        'nid': node._id,", "        'provider': provider,"]}, {"lines": ["    })", ""]}, {"lines": ["    if user:"]}, {"lines": ["        url.args['cookie'] = user.get_or_create_cookie()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    return url.url"]}, {"lines": ["import bleach"]}, {"lines": [""]}, {"lines": ["", "#Thank you Lyndsy"]}, {"lines": ["", "", "def clean_tag(data):"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    if isinstance(data, dict):", "        return {"]}, {"lines": ["            for (key, value) in data.iteritems()", "        }"]}, {"lines": ["        return ["]}, {"lines": ["            for value in data", "        ]", "    if isinstance(data, basestring):"]}, {"lines": ["    return data", "", ""]}], "name": "Chris Seto"}, {"commits": [{"lines": ["    'profile-account-settings-page': staticPath('js/pages/profile-account-settings-page.js'),"]}, {"lines": ["    'profile-settings-addons-page': staticPath('js/pages/profile-settings-addons-page.js'),"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["", "import datetime", "import logging", "import sys", "", "from modularodm import Q", "", "from website.models import NodeLog"]}, {"lines": ["", "from bson import ObjectId"]}, {"lines": ["", "from tests.base import OsfTestCase", "from tests.factories import NodeLogFactory", "", "", "logger = logging.getLogger(__name__)", "logger.setLevel(logging.DEBUG)", "", "", "def find_invalid_logs():", "    for log in NodeLog.find(Q('action', 'eq', NodeLog.WIKI_DELETED)):", "        # Derive UTC datetime object from ObjectId", "        id_date = ObjectId(log._id).generation_time", "        id_date = id_date.replace(tzinfo=None) - id_date.utcoffset()", "", "        if id_date > log.date:", "            yield log", "", "", "def fix_invalid_log(log):", "    new_dt = ObjectId(log._id).generation_time", "    new_dt = new_dt.replace(tzinfo=None) - new_dt.utcoffset()", "    NodeLog._fields['date'].__set__(", "        log,", "        new_dt,", "        safe=False", "    )", "    log.save()", "", "", "if __name__ == '__main__':"]}, {"lines": ["    if 'dry' in sys.argv:", "        for log in find_invalid_logs():", "            print(log._id)"]}, {"lines": ["    else:", "        for log in find_invalid_logs():", "            fix_invalid_log(log)"]}, {"lines": ["", "", "class TestEnsureLogDates(OsfTestCase):", "", "    def setUp(self):", "        super(TestEnsureLogDates, self).setUp()", "        self.good_log = NodeLogFactory(action=NodeLog.WIKI_DELETED)", "        self.bad_log = NodeLogFactory(action=NodeLog.WIKI_DELETED)", "", "        self.mongo = self.good_log._storage[0].db['nodelog']", "", "        self.mongo.update(", "            {'_id': self.bad_log._id},", "            {'$set': {'date': datetime.datetime.utcnow() - datetime.timedelta(weeks=52)}},", "        )", "        self.bad_log.reload()", "", "    def tearDown(self):", "        super(TestEnsureLogDates, self).tearDown()", "", "    def test_find_invalid_logs(self):", "        assert_equal(", "            1,", "            len(list(find_invalid_logs()))", "        )", "", "    def test_fix_invalid_log(self):", "        fix_invalid_log(self.bad_log)", "        assert_true(", "            self.good_log.date - self.bad_log.date < datetime.timedelta(seconds=1)", "        )", "", ""]}, {"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-", "\"\"\"Update Piwik for nodes that were forked, registered or templated prior to", "October 2014.", "\"\"\"", "", "import datetime", "import logging", "import sys", "import time", "", "from modularodm import Q", "", "from framework.analytics.piwik import _update_node_object", "from scripts import utils as scripts_utils", "from website.app import init_app", "from website.models import Node", "", "", "logger = logging.getLogger('root')", "", "", "def get_nodes():", "    forked = Q('__backrefs.forked.node.forked_from', 'ne', None)", "    registered = Q('__backrefs.registrations.node.registered_from', 'ne', None)", "    templated = Q('__backrefs.template_node.node.template_node', 'ne', None)", "    duplicate = (forked | registered | templated)", ""]}, {"lines": ["        duplicate and Q('date_created', 'lt', datetime.datetime(2014, 10, 31))", "    )", "", "", "def main():", "    init_app('website.settings', set_backends=True, routes=False)", "", "    if 'dry' in sys.argv:", "        if 'list' in sys.argv:"]}, {"lines": ["            logger.info('=== Nodes ===')"]}, {"lines": ["            for node in get_nodes():", "                logger.info(node._id)", "        else:"]}, {"lines": ["            logger.info('{} Nodes to be updated'.format(get_nodes().count()))"]}, {"lines": ["    else:", "        # Log to a file", "        scripts_utils.add_file_logger(logger, __file__)", "        nodes = get_nodes()"]}, {"lines": ["        logger.info('=== Updating {} Nodes ==='.format(nodes.count()))"]}, {"lines": ["        for node in nodes:", "            # Wait a second between requests to reduce load on Piwik", "            time.sleep(1)"]}, {"lines": ["            _update_node_object(node)"]}, {"lines": ["", "", "if __name__ == \"__main__\":", "    main()"]}, {"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-", "\"\"\"Ensure all projects modified today are consistent between the OSF and Piwik", "\"\"\"", "", "import datetime", "import logging", "import sys", "import time", "", "from modularodm import Q", "", "from framework.analytics import piwik", "from scripts import utils as scripts_utils", "from website.app import init_app", "from website.project.model import NodeLog", "", ""]}, {"lines": ["", "", "def get_nodes():", "    \"\"\"Return a set of node with log events for today\"\"\"", "    today = datetime.date.today()", "    midnight = datetime.datetime(", "        year=today.year,", "        month=today.month,", "        day=today.day,", "    )", "", "    return set(", "        (", "            log.node", "            for log in NodeLog.find(Q('date', 'gt', midnight))", "        )", "    )", "", "", "def main():", "    init_app('website.settings', set_backends=True, routes=False)", "", "    if 'dry' in sys.argv:", "        if 'list' in sys.argv:", "            logger.info('=== Nodes modified today ===')", "            for node in get_nodes():", "                logger.info(node._id)", "        else:", "            logger.info('{} Nodes to be updated'.format(len(get_nodes())))", "    else:", "        # Log to a file", "        scripts_utils.add_file_logger(logger, __file__)", "        nodes = get_nodes()", "        logger.info('=== Updating {} Nodes ==='.format(len(nodes)))", "        for node in nodes:", "            # Wait a second between requests to reduce load on Piwik", "            time.sleep(1)", "            piwik._update_node_object(node)", "            logger.info(node._id)", "", "", "if __name__ == \"__main__\":", "    main()"]}, {"lines": ["\"\"\"Fixes nodes with two copies of the files and wiki addons attached.", "", "This script must be run from the OSF root directory for the imports to work."]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website.app import init_app", "from website.project.model import Node"]}, {"lines": ["from website.addons.wiki.model import AddonWikiNodeSettings", "from website.addons.osffiles.model import AddonFilesNodeSettings", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    query = db['node'].find({", "        '.'.join(", "            ('__backrefs',"]}, {"lines": ["            )", "        ): {'$size': 2}", "    })"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["\"\"\"Removes User.username from User.emails for unconfirmed users."]}, {"lines": ["", "\"\"\"", "", "import logging"]}, {"lines": ["import sys"]}, {"lines": ["", "from modularodm import Q", "from nose.tools import *", "", "from website import models", "from website.app import init_app", "from scripts import utils as scripts_utils"]}, {"lines": ["", "", "logger = logging.getLogger(__name__)", "", "", "def main():", "    # Set up storage backends", "    init_app(routes=False)", "    dry_run = 'dry' in sys.argv", "    if not dry_run:", "        scripts_utils.add_file_logger(logger, __file__)", "    logger.info(\"Iterating users with unconfirmed email\"", "                \"s\")", "    for user in get_users_with_unconfirmed_emails():", "        remove_unconfirmed_emails(user)", "        logger.info(repr(user))", "        if not dry_run:", "            user.save()", "", "", "def get_users_with_unconfirmed_emails():", "    return models.User.find(", "        Q('date_confirmed', 'eq', None)", "        & Q('emails', 'ne', [])", "    )", "", "", "def remove_unconfirmed_emails(user):", "    user.emails = []", "", ""]}, {"lines": ["if __name__ == '__main__':", "    main()"]}, {"lines": [""]}, {"lines": ["        assert_equal(User.load(user._id), user)"]}, {"lines": ["    def test_get_user_by_email(self):"]}, {"lines": ["        assert_equal(auth.get_user(email=user.username), user)"]}, {"lines": ["            auth.get_user(email=user.username, password='wrong')"]}, {"lines": ["    def test_disabled_user(self):"]}, {"lines": ["", "        user = UserFactory(fullname='Bettie Page')", "        user.save()", "", "        # Ensure user is in search index", "        assert_equal(len(query_user(user.fullname)['results']), 1)", "", "        # Disable the user", "        user.is_disabled = True", "        user.save()", "", "        # Ensure user is not in search index", "        assert_equal(len(query_user(user.fullname)['results']), 0)", ""]}, {"lines": ["import datetime", "import mock"]}, {"lines": [""]}, {"lines": ["from modularodm import Q", "from modularodm.exceptions import NoResultsFound"]}, {"lines": [""]}, {"lines": ["from framework.auth.core import User", "from framework.auth.signals import contributor_removed", "from framework.auth.signals import node_deleted", "from scripts.send_digest import group_digest_notifications_by_user", "from scripts.send_digest import group_messages_by_node", "from scripts.send_digest import remove_sent_digest_notifications", "from scripts.send_digest import send_digest", "from website.notifications import constants"]}, {"lines": ["from website.notifications import emails", "from website.notifications import utils"]}, {"lines": ["from website.util import api_url_for", "from website.util import web_url_for", "", "from tests import factories", "from tests.base import capture_signals", "from tests.base import OsfTestCase"]}, {"lines": ["class TestNotificationsModels(OsfTestCase):", "", "    def setUp(self):", "        super(TestNotificationsModels, self).setUp()", "        # Create project with component", "        self.user = factories.UserFactory()", "        self.consolidate_auth = Auth(user=self.user)", "        self.parent = factories.ProjectFactory(creator=self.user)"]}, {"lines": [""]}, {"lines": ["        non_admin_user = factories.UserFactory()", "        parent = factories.ProjectFactory()", "        parent.add_contributor(contributor=non_admin_user, permissions=['read'])", "        parent.save()", ""]}, {"lines": ["        sub_component.add_contributor(contributor=non_admin_user)", "        sub_component.save()"]}, {"lines": [""]}, {"lines": ["        assert_true(has_permission_on_child_node)", "", "    def test_check_user_has_permission_excludes_deleted_components(self):", "        non_admin_user = factories.UserFactory()", "        parent = factories.ProjectFactory()", "        parent.add_contributor(contributor=non_admin_user, permissions=['read'])", "        parent.save()", ""]}, {"lines": ["        sub_component.add_contributor(contributor=non_admin_user)", "        sub_component.is_deleted = True", "        sub_component.save()"]}, {"lines": [""]}, {"lines": ["        assert_false(has_permission_on_child_node)", "", "    def test_check_user_does_not_have_permission_on_private_node_child(self):", "        non_admin_user = factories.UserFactory()", "        parent = factories.ProjectFactory()", "        parent.add_contributor(contributor=non_admin_user, permissions=['read'])", "        parent.save()"]}, {"lines": ["        assert_false(has_permission_on_child_node)", "", "    def test_check_user_child_node_permissions_false_if_no_children(self):", "        non_admin_user = factories.UserFactory()", "        parent = factories.ProjectFactory()", "        parent.add_contributor(contributor=non_admin_user, permissions=['read'])", "        parent.save()"]}, {"lines": ["        assert_false(has_permission_on_child_node)", "", "    def test_check_admin_has_permissions_on_private_component(self):", "        parent = factories.ProjectFactory()"]}, {"lines": ["        assert_true(has_permission_on_child_node)", "", "    def test_check_user_private_node_child_permissions_excludes_pointers(self):", "        user = factories.UserFactory()", "        parent = factories.ProjectFactory()", "        pointed = factories.ProjectFactory(contributor=user)", "        parent.add_pointer(pointed, Auth(parent.creator))", "        parent.save()"]}, {"lines": ["        assert_false(has_permission_on_child_nodes)", "", ""]}, {"lines": ["", "    def setUp(self):", "        super(TestSubscriptionView, self).setUp()", "        self.node = factories.NodeFactory()", "        self.user = self.node.creator", ""]}, {"lines": ["            'id': self.node._id,"]}, {"lines": ["        self.app.post_json(url, payload, auth=self.node.creator.auth)"]}, {"lines": ["        event_id = self.node._id + '_' + 'comments'"]}, {"lines": ["        assert_in(self.node.creator, getattr(s, payload['notification_type']))"]}, {"lines": ["            'id': self.node._id,"]}, {"lines": ["        self.app.post_json(url, new_payload, auth=self.node.creator.auth)"]}, {"lines": ["        assert_false(self.node.creator in getattr(s, payload['notification_type']))", "        assert_in(self.node.creator, getattr(s, new_payload['notification_type']))"]}, {"lines": ["            'id': self.node._id,"]}, {"lines": ["        self.app.post_json(url, payload, auth=self.node.creator.auth)", "        event_id = self.node._id + '_' + 'comments'"]}, {"lines": ["            'id': self.node._id,"]}, {"lines": ["        self.app.post_json(url, payload, auth=self.node.creator.auth)"]}, {"lines": ["        event_id = self.node._id + '_' + 'comments'"]}, {"lines": ["            'id': self.node._id,"]}, {"lines": ["        self.app.post_json(url, new_payload, auth=self.node.creator.auth)"]}, {"lines": ["        for n in constants.NOTIFICATION_TYPES:"]}, {"lines": ["            assert_false(self.node.creator in getattr(s, n))"]}, {"lines": ["        self.project = factories.ProjectFactory()", "        self.contributor = factories.UserFactory()"]}, {"lines": ["            project = factories.ProjectFactory()"]}, {"lines": ["        self.user = factories.UserFactory()", "        self.project = factories.ProjectFactory(creator=self.user)"]}, {"lines": ["        project = factories.ProjectFactory()"]}, {"lines": ["        private_project = factories.ProjectFactory()"]}, {"lines": ["        private_project = factories.ProjectFactory()"]}, {"lines": ["        node = factories.NodeFactory()"]}, {"lines": ["        project = factories.ProjectFactory()"]}, {"lines": ["                            'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["                                    'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["                            'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["                                    'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["                                    'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["        project = factories.ProjectFactory()"]}, {"lines": ["        pointed = factories.ProjectFactory()"]}, {"lines": ["                        'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["        private_project = factories.ProjectFactory()"]}, {"lines": ["                                    'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["        data = utils.serialize_event(self.user, 'comment_replies', constants.USER_SUBSCRIPTIONS_AVAILABLE, user_subscriptions)"]}, {"lines": ["                'description': constants.USER_SUBSCRIPTIONS_AVAILABLE['comment_replies'],"]}, {"lines": ["        data = utils.serialize_event(self.user, 'comments', constants.NODE_SUBSCRIPTIONS_AVAILABLE, node_subscriptions, self.node)"]}, {"lines": ["                'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["        user = factories.UserFactory()"]}, {"lines": ["        data = utils.serialize_event(user, 'comments', constants.NODE_SUBSCRIPTIONS_AVAILABLE, node_subscriptions, self.node)"]}, {"lines": ["                'description': constants.NODE_SUBSCRIPTIONS_AVAILABLE['comments'],"]}, {"lines": ["        self.user = factories.UserFactory()", "        self.project = factories.ProjectFactory()"]}, {"lines": ["        node = factories.NodeFactory()"]}, {"lines": ["        node = factories.NodeFactory()"]}, {"lines": ["        node = factories.NodeFactory()", "        user = factories.UserFactory()"]}, {"lines": ["        user = factories.UserFactory()"]}, {"lines": ["        user = factories.UserFactory()"]}, {"lines": ["        project = factories.ProjectFactory()"]}, {"lines": ["        target = factories.CommentFactory(node=project, user=user)"]}, {"lines": ["        project = factories.ProjectFactory()"]}, {"lines": ["        project = factories.ProjectFactory()"]}, {"lines": ["        user = factories.UserFactory()", "        project = factories.ProjectFactory()"]}, {"lines": [""]}, {"lines": ["", "class TestSendDigest(OsfTestCase):", "    def test_group_digest_notifications_by_user(self):", "        user = factories.UserFactory()", "        user2 = factories.UserFactory()", "        project = factories.ProjectFactory()", "        timestamp = (datetime.datetime.utcnow() - datetime.timedelta(hours=1)).replace(microsecond=0)"]}, {"lines": ["            user_id=user._id,", "            timestamp=timestamp,", "            message='Hello',", "            node_lineage=[project._id]", "        )", "        d.save()"]}, {"lines": ["            user_id=user2._id,", "            timestamp=timestamp,", "            message='Hello',", "            node_lineage=[project._id]", "        )", "        d2.save()", "        user_groups = group_digest_notifications_by_user()", "        expected = [{", "                    u'user_id': user._id,", "                    u'info': [{"]}, {"lines": ["                        u'node_lineage': [unicode(project._id)],", "                        u'_id': d._id", "                    }]", "                    },", "                    {", "                    u'user_id': user2._id,", "                    u'info': [{"]}, {"lines": ["                        u'node_lineage': [unicode(project._id)],", "                        u'_id': d2._id", "                    }]"]}, {"lines": ["        assert_equal(len(user_groups), 2)", "        assert_equal(user_groups, expected)", "", "    @mock.patch('scripts.send_digest.remove_sent_digest_notifications')", "    @mock.patch('website.mails.send_mail')", "    def test_send_digest_called_with_correct_args(self, mock_send_mail, mock_callback):"]}, {"lines": ["            user_id=factories.UserFactory()._id,", "            timestamp=datetime.datetime.utcnow(),", "            message='Hello',", "            node_lineage=[factories.ProjectFactory()._id]", "        )", "        d.save()", "        user_groups = group_digest_notifications_by_user()", "        send_digest(user_groups)", "        assert_true(mock_send_mail.called)", "        assert_equals(mock_send_mail.call_count, len(user_groups))", "", "        last_user_index = len(user_groups) - 1", "        user = User.load(user_groups[last_user_index]['user_id'])", "        digest_notification_ids = [message['_id'] for message in user_groups[last_user_index]['info']]", ""]}, {"lines": ["", "    def test_remove_sent_digest_notifications(self):"]}, {"lines": ["            user_id=factories.UserFactory()._id,", "            timestamp=datetime.datetime.utcnow(),", "            message='Hello',", "            node_lineage=[factories.ProjectFactory()._id]", "        )", "        digest_id = d._id"]}, {"lines": ["        with assert_raises(NoResultsFound):"]}, {"lines": ["    def test_escape_html(self):", "        assert_equal(", "            sanitize.clean_tag('<script> evil code </script>'),"]}, {"lines": ["        )", "        assert_equal(", "            sanitize.clean_tag('<img src=javascript:moreevil><img>'),"]}, {"lines": ["        )", "        assert_equal(", "            sanitize.clean_tag('<iframe src=evilsite>'),"]}, {"lines": ["        )", "        assert_equal(", "            sanitize.clean_tag(');</span><script></script><span>'),", "            ');&lt;/span&gt;&lt;script&gt;&lt;/script&gt;&lt;span&gt;',", "        )"]}, {"lines": ["    def test_clean_tag(self):", "        assert_equal(", "            sanitize.clean_tag('\\'\\'\\'\\'\\'\"\"\"\"\"\"\"<script></script>'),", "            '&quot;&quot;&quot;&quot;&quot;&quot;&quot;'"]}, {"lines": ["        )"]}, {"lines": ["    def test_strip_html(self):", "        assert_equal(", "            sanitize.strip_html('<foo>bar</foo>'),", "            'bar'"]}, {"lines": ["        assert_equal(d['date'], framework_utils.iso8601format(log.date))"]}, {"lines": ["from tests.base import (", "    OsfTestCase,", "    fake,", "    capture_signals,", "    assert_is_redirect,", "    assert_datetime_equal,", ")"]}, {"lines": ["    ProjectWithAddonFactory,"]}, {"lines": ["        assert_equal(", "            project.visible_contributors,"]}, {"lines": ["        )", ""]}, {"lines": ["        new_unreg = auth.get_user(email=email)"]}, {"lines": ["    @mock.patch('website.project.views.contributor.mails.send_mail')", "    def test_claim_user_post_with_registered_user_id(self, send_mail):", "        # registered user who is attempting to claim the unclaimed contributor"]}, {"lines": ["            uid=self.user._primary_key,", "            pid=self.project._primary_key,", "        )", ""]}, {"lines": ["", "        # mail was sent", "        assert_true(send_mail.called)", "        # ... to the correct address", "        assert_true(send_mail.called_with(to_addr=self.given_email))", "", "        # view returns the correct JSON", "        assert_equal(res.json, {", "            'status': 'success',", "            'email': reg_user.username,", "            'fullname': self.given_name,", "        })"]}, {"lines": ["        \"\"\" Tests that when an unclaimed user is removed from a project, the", "        unregistered user object does not retain the token.", "        \"\"\"", "        self.project.remove_contributor(self.user, Auth(user=self.referrer))"]}, {"lines": ["        assert_not_in(", "            self.project._primary_key,", "            self.user.unclaimed_records.keys()", "        )"]}, {"lines": ["    def test_user_with_claim_url_cannot_claim_twice(self):", "        \"\"\" Tests that when an unclaimed user is replaced on a project with a", "        claimed user, the unregistered user object does not retain the token.", "        \"\"\"", "        reg_user = AuthUserFactory()"]}, {"lines": ["        self.project.replace_contributor(self.user, reg_user)"]}, {"lines": ["        assert_not_in(", "            self.project._primary_key,", "            self.user.unclaimed_records.keys()", "        )"]}, {"lines": ["        url = self.user.get_claim_url(self.project._primary_key)"]}, {"lines": ["        assert_true(self.user.is_active)"]}, {"lines": ["        assert_true(new_user.is_confirmed)"]}, {"lines": ["        assert_equal(brian['active'], self.contrib.is_active)"]}, {"lines": ["    @unittest.skipIf(not settings.USE_EMAIL,", "                     \"settings.USE_EMAIL is False\")"]}, {"lines": ["from nose.tools import *", "", "from framework.sessions import utils", "from tests import factories", "from tests.base import DbTestCase", "from website.models import User", "from website.models import Session", "", "", "class SessionUtilsTestCase(DbTestCase):", "    def setUp(self, *args, **kwargs):", "        super(SessionUtilsTestCase, self).setUp(*args, **kwargs)", "        self.user = factories.UserFactory()", "", "    def tearDown(self, *args, **kwargs):", "        super(SessionUtilsTestCase, self).tearDown(*args, **kwargs)", "        User.remove()", "        Session.remove()", "", "    def test_remove_session_for_user(self):", "        factories.SessionFactory(user=self.user)", "", "        # sanity check", "        assert_equal(1, Session.find().count())", "", "        utils.remove_sessions_for_user(self.user)", "        assert_equal(0, Session.find().count())", "", "        factories.SessionFactory()", "        factories.SessionFactory(user=self.user)", "", "        # sanity check", "        assert_equal(2, Session.find().count())", "", "        utils.remove_sessions_for_user(self.user)", "        assert_equal(1, Session.find().count())"]}, {"lines": ["import datetime", ""]}, {"lines": ["from modularodm import Q"]}, {"lines": [""]}, {"lines": ["from framework import auth"]}, {"lines": ["from framework.auth import exceptions"]}, {"lines": ["from website import models", "from tests import base"]}, {"lines": ["from tests import factories"]}, {"lines": ["", ""]}, {"lines": ["class TestUser(base.OsfTestCase):"]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        super(TestUser, self).setUp()"]}, {"lines": ["        self.user = factories.AuthUserFactory()"]}, {"lines": ["", "    def tearDown(self):", "        models.Node.remove()", "        models.User.remove()"]}, {"lines": ["        models.Session.remove()"]}, {"lines": ["        super(TestUser, self).tearDown()"]}, {"lines": [""]}, {"lines": ["    def test_unconfirmed_emails(self):", "        assert_equal(", "            self.user.unconfirmed_emails,", "            []", "        )", "        self.user.add_unconfirmed_email('foo@bar.com')", "        assert_equal(", "            self.user.unconfirmed_emails,", "            ['foo@bar.com']", "        )", ""]}, {"lines": ["        # email_verifications field may be None", "        self.user.email_verifications = None", "        self.user.save()", "        assert_equal(self.user.unconfirmed_emails, [])", "", "    def test_unconfirmed_emails_unregistered_user(self):", ""]}, {"lines": ["        assert_equal("]}, {"lines": ["            factories.UnregUserFactory().unconfirmed_emails,"]}, {"lines": ["            []", "        )", ""]}, {"lines": ["    def test_unconfirmed_emails_unconfirmed_user(self):", "        user = factories.UnconfirmedUserFactory()", ""]}, {"lines": ["        assert_equal("]}, {"lines": ["            user.unconfirmed_emails,", "            [user.username]"]}, {"lines": ["        )", ""]}, {"lines": ["    def test_remove_unconfirmed_email(self):", "        self.user.add_unconfirmed_email('foo@bar.com')", "        self.user.save()", "", "        assert_in('foo@bar.com', self.user.unconfirmed_emails) # sanity check", "", "        self.user.remove_unconfirmed_email('foo@bar.com')", "        self.user.save()", "", "        assert_not_in('foo@bar.com', self.user.unconfirmed_emails)", ""]}, {"lines": ["    def test_confirm_email(self):", "        token = self.user.add_unconfirmed_email('foo@bar.com')", "        self.user.confirm_email(token)", "", "        assert_not_in('foo@bar.com', self.user.unconfirmed_emails)", "        assert_in('foo@bar.com', self.user.emails)", ""]}, {"lines": ["    def test_confirm_email_comparison_is_case_insensitive(self):"]}, {"lines": ["        )"]}, {"lines": ["        assert_false(u.is_confirmed)  # sanity check", "", "        token = u.get_confirmation_token('LetsGetTacos@LGT.com')", "", "        confirmed = u.confirm_email(token)", "        assert_true(confirmed)"]}, {"lines": [""]}, {"lines": ["class TestUserMerging(base.OsfTestCase):"]}, {"lines": ["    ADDONS_UNDER_TEST = {", "        'unmergeable': {", "            'user_settings': factories.MockAddonUserSettings,", "            'node_settings': factories.MockAddonNodeSettings,", "        },", "        'mergeable': {", "            'user_settings': factories.MockAddonUserSettingsMergeable,", "            'node_settings': factories.MockAddonNodeSettings,", "        }", "    }", "", "    def setUp(self):"]}, {"lines": ["        super(TestUserMerging, self).setUp()"]}, {"lines": ["        self.user = factories.UserFactory()"]}, {"lines": [""]}, {"lines": ["    def _add_unconfirmed_user(self):", "", "        self.unconfirmed = factories.UnconfirmedUserFactory()", "", "        self.user.system_tags = ['shared', 'user']", "        self.unconfirmed.system_tags = ['shared', 'unconfirmed']", "", "        self.user.aka = ['shared', 'user']", "        self.unconfirmed.aka = ['shared', 'unconfirmed']", "", "    def _add_unregistered_user(self):", "        self.unregistered = factories.UnregUserFactory()", "", "        self.project_with_unreg_contrib = factories.ProjectFactory()", "        self.project_with_unreg_contrib.add_unregistered_contributor(", "            fullname='Unreg',", "            email=self.unregistered.username,", "            auth=auth.Auth(self.project_with_unreg_contrib.creator)", "        )", "        self.project_with_unreg_contrib.save()", ""]}, {"lines": ["    def test_can_be_merged_no_addons(self):", "        # No addons present", "        assert_true(self.user.can_be_merged)", "", "    def test_can_be_merged_unmergable_addon(self):", "        self.user.add_addon('unmergeable')", "", "        assert_false(self.user.can_be_merged)", "", "    def test_can_be_merged_mergable_addon(self):", "        self.user.add_addon('mergeable')", "", "        assert_true(self.user.can_be_merged)", "", "    def test_can_be_merged_both_addons(self):", "        self.user.add_addon('mergeable')", "        self.user.add_addon('unmergeable')", ""]}, {"lines": ["        assert_false(self.user.can_be_merged)", ""]}, {"lines": ["    def test_merge_unconfirmed_into_unmergeable(self):", "        self.user.add_addon('unmergeable')", "        self.user.save()", "        # sanity check", "        assert_false(self.user.can_be_merged)", "", "        unconf = factories.UnconfirmedUserFactory()", "        # make sure this doesn't raise an exception", "        self.user.merge_user(unconf)", "", "        unreg = factories.UnregUserFactory()", "        # make sure this doesn't raise an exception", "        self.user.merge_user(unreg)", "", "    def test_merge_unmergeable_into_mergeable(self):", "        # These states should never happen in the current codebase...", "        #   but that's why we have tests.", "        unconfirmed = factories.UnconfirmedUserFactory()", "        unconfirmed.add_addon('unmergeable')", "", "        with assert_raises(exceptions.MergeConflictError):", "            self.user.merge_user(unconfirmed)", "", "        unregistered = factories.UnregUserFactory()", "        unregistered.add_addon('unmergeable')", "", "        with assert_raises(exceptions.MergeConflictError):", "            self.user.merge_user(unregistered)", "", "    def test_merge_unmergeabled_into_unmergeable(self):", "        self.user.add_addon('unmergeable')", "        # These states should never happen in the current codebase...", "        #   but that's why we have tests.", "        unconfirmed = factories.UnconfirmedUserFactory()", "        unconfirmed.add_addon('unmergeable')", "", "        with assert_raises(exceptions.MergeConflictError):", "            self.user.merge_user(unconfirmed)", "", "        unregistered = factories.UnregUserFactory()", "        unregistered.add_addon('unmergeable')", "", "        with assert_raises(exceptions.MergeConflictError):", "            self.user.merge_user(unregistered)", ""]}, {"lines": ["        other_user = factories.UserFactory()", "        other_user.save()", "", "        # define values for users' fields", "        today = datetime.datetime.now()", "        yesterday = today - datetime.timedelta(days=1)", "", "        self.user.aka = ['foo']", "        other_user.aka = ['bar']", "", "        self.user.api_keys = [factories.ApiKeyFactory()]", "        other_user.api_keys = [factories.ApiKeyFactory()]", "", "        self.user.comments_viewed_timestamp['shared_gt'] = today", "        other_user.comments_viewed_timestamp['shared_gt'] = yesterday", "        self.user.comments_viewed_timestamp['shared_lt'] = yesterday", "        other_user.comments_viewed_timestamp['shared_lt'] = today", "        self.user.comments_viewed_timestamp['user'] = yesterday", "        other_user.comments_viewed_timestamp['other'] = yesterday", "", "        self.user.email_verifications = {'user': {'email': 'a'}}", "        other_user.email_verifications = {'other': {'email': 'b'}}", "", "        self.user.external_accounts = [factories.ExternalAccountFactory()]", "        other_user.external_accounts = [factories.ExternalAccountFactory()]", "", "        self.user.mailing_lists = {", "            'user': True,", "            'shared_gt': True,", "            'shared_lt': False,", "        }", "        other_user.mailing_lists = {", "            'other': True,", "            'shared_gt': False,", "            'shared_lt': True,", "        }", "", "        self.user.piwik_token = 'abc'", "        other_user.piwik_token = 'def'", "", "        self.user.security_messages = {", "            'user': today,", "            'shared': today,", "        }", "        other_user.security_messages = {", "            'other': today,", "            'shared': today,", "        }", "", "        self.user.system_tags = ['user', 'shared']", "        other_user.system_tags = ['other', 'shared']", "", "        self.user.watched = [factories.WatchConfigFactory()]", "        other_user.watched = [factories.WatchConfigFactory()]", "", "        self.user.save()", "        other_user.save()", "", "        # define expected behavior for ALL FIELDS of the User object", "        default_to_master_user_fields = [", "            '_id',", "            'date_confirmed',", "            'date_disabled',", "            'date_last_login',", "            'date_registered',", "            'family_name',", "            'fullname',", "            'given_name',", "            'is_claimed',", "            'is_invited',", "            'is_registered',", "            'jobs',", "            'locale',", "            'merged_by',", "            'middle_names',", "            'password',", "            'piwik_token',", "            'recently_added',", "            'schools',", "            'social',", "            'suffix',", "            'timezone',", "            'username',", "            'verification_key',", "        ]", "", "        calculated_fields = {", "            'aka': ['foo', 'bar'],", "            'api_keys': [", "                self.user.api_keys[0]._id,", "                other_user.api_keys[0]._id,", "            ],", "            'comments_viewed_timestamp': {", "                'user': yesterday,", "                'other': yesterday,", "                'shared_gt': today,", "                'shared_lt': today,", "            },", "            'email_verifications': {", "                'user': {'email': 'a'},", "                'other': {'email': 'b'},", "            },", "            'emails': [", "                self.user.username,", "                other_user.username,", "            ],", "            'external_accounts': [", "                self.user.external_accounts[0]._id,", "                other_user.external_accounts[0]._id,", "            ],", "            'mailing_lists': {", "                'user': True,", "                'other': True,", "                'shared_gt': True,", "                'shared_lt': True,", "            },", "            'security_messages': {", "                'user': today,", "                'other': today,", "                'shared': today,", "            },", "            'system_tags': ['user', 'shared', 'other'],", "            'unclaimed_records': {},", "            'watched': [", "                self.user.watched[0]._id,", "                other_user.watched[0]._id,", "            ],", "        }", "", "        # from the explicit rules above, compile expected field/value pairs", "        expected = {}", "        expected.update(calculated_fields)", "        for key in default_to_master_user_fields:", "            expected[key] = getattr(self.user, key)", "", "        # ensure all fields of the user object have an explicit expectation", "        assert_equal(", "            set(expected.keys()),", "            set(self.user._fields),", "        )", ""]}, {"lines": ["        # perform the merge", "        self.user.merge_user(other_user)", "        self.user.save()"]}, {"lines": ["", "        # check each field/value pair", "        for k, v in expected.iteritems():", "            assert_equal(", "                getattr(self.user, k),", "                v,", "                # \"{} doesn't match expectation\".format(k)", "            )", "", "        # check fields set on merged user", "        assert_equal(other_user.merged_by, self.user)", ""]}, {"lines": ["        assert_equal(", "            0,", "            models.Session.find(", "                Q('data.auth_user_id', 'eq', other_user._id)", "            ).count()", "        )", ""]}, {"lines": ["    def test_merge_unconfirmed(self):", "        self._add_unconfirmed_user()"]}, {"lines": ["        self.user.merge_user(self.unconfirmed)", "", "        assert_true(self.unconfirmed.is_merged)", "        assert_equal(self.unconfirmed.merged_by, self.user)", "", "        assert_true(self.user.is_claimed)", "        assert_false(self.user.is_invited)", "", "        # TODO: test profile fields - jobs, schools, social", "        # TODO: test security_messages", "        # TODO: test mailing_lists", "", "        assert_equal(self.user.system_tags, ['shared', 'user', 'unconfirmed'])", "        assert_equal(self.user.aka, ['shared', 'user', 'unconfirmed'])", "", "        # TODO: test emails", "        # TODO: test watched", "        # TODO: test external_accounts", "", "        # TODO: test api_keys", "        assert_equal(self.unconfirmed.email_verifications, {})", "        assert_is_none(self.unconfirmed.username)", "        assert_is_none(self.unconfirmed.password)", "        assert_is_none(self.unconfirmed.verification_key)"]}, {"lines": ["", "    def test_merge_unregistered(self):", "        # test only those behaviors that are not tested with unconfirmed users", "        self._add_unregistered_user()", "", "        self.user.merge_user(self.unregistered)", "", "        assert_true(self.user.is_invited)", ""]}, {"lines": ["class OSFError(Exception):", "    \"\"\"Base class for exceptions raised by the Osf application\"\"\"", "    pass", "", "", "class NodeError(OSFError):", "    \"\"\"Raised when an action cannot be performed on a Node model\"\"\"", "    pass", "", "", "class NodeStateError(NodeError):", "    \"\"\"Raised when the Node's state is not suitable for the requested action", "", "    Example: Node.remove_node() is called, but the node has non-deleted children", "    \"\"\""]}, {"lines": [""]}, {"lines": ["# Shown upon successful email address confirmation", "CONFIRMED_EMAIL = 'Email address confirmation successful.'", ""]}, {"lines": ["# Shown if the user's account is disabled", "DISABLED = '''", "Log-in failed: Deactivated account.", "'''", ""]}, {"lines": ["EXPIRED_EMAIL_CONFIRM_TOKEN = 'This confirmation link has expired. Please <a href=\"/login/\">log in</a> to continue.'", "", "INVALID_EMAIL_CONFIRM_TOKEN = 'This confirmation link is invalid. Please <a href=\"/login/\">log in</a> to continue.'"]}, {"lines": ["CANNOT_MERGE_ACCOUNTS_SHORT = 'Cannot Merge Accounts'", ""]}, {"lines": ["", "MERGE_COMPLETE = 'Accounts successfully merged.'", "", "MERGE_CONFIRMATION_REQUIRED_SHORT = 'Confirmation Required: Merge Accounts'", "", "MERGE_CONFIRMATION_REQUIRED_LONG = ("]}, {"lines": [")", ""]}, {"lines": ["", "# Nodes: forking, templating, linking", "", "LINK_ACTION = 'Link to this Project'", "LINK_DESCRIPTION = \"\"\"", "<p>Linking to this project will reference it in another project, without", "creating a copy. The link will always point to the most up-to-date version.</p>", "\"\"\"", "", "TEMPLATE_ACTION = 'Copy Project Structure'", "TEMPLATE_DESCRIPTION = \"\"\"", "<p>This option will create a new project, using this project as a template.", "The new project will be structured in the same way, but contain no data.</p>", "\"\"\"", "", "FORK_ACTION = 'Fork this Project'", "FORK_DESCRIPTION = \"\"\"", "<p>Fork this project if you plan to build upon it in your own work.", "The new project will be an exact duplicate of this project's current state,", "with you as the only contributor.</p>"]}, {"lines": ["\"\"\"", "", "TEMPLATE_DROPDOWN_HELP = \"\"\"Start typing to search. Selecting project as", "template will duplicate its structure in the new project without importing the"]}, {"lines": ["content of that project.\"\"\"", ""]}, {"lines": ["from framework.email import tasks"]}, {"lines": ["    :param function callback: celery task to execute after send_mail completes"]}, {"lines": ["         Uses celery if available"]}, {"lines": ["    mailer = mailer or tasks.send_email"]}, {"lines": [""]}, {"lines": ["CONFIRM_MERGE = Mail('confirm_merge', subject='Confirm account merge')", ""]}, {"lines": ["REMOVED_EMAIL = Mail('email_removed', subject='Email address removed from your OSF account')"]}, {"lines": ["PRIMARY_EMAIL_CHANGED = Mail('primary_email_changed', subject='Primary email changed')"]}, {"lines": ["REQUEST_EXPORT = Mail('support_request', subject='[via OSF] Export Request')", "REQUEST_DEACTIVATION = Mail('support_request', subject='[via OSF] Deactivation Request')", ""]}, {"lines": [""]}, {"lines": ["from website import landing_pages as landing_page_views"]}, {"lines": ["from website.citations import views as citation_views"]}, {"lines": ["from website.oauth import views as oauth_views"]}, {"lines": ["        'piwik_host': settings.PIWIK_HOST,"]}, {"lines": ["        'piwik_site_id': settings.PIWIK_SITE_ID,"]}, {"lines": ["        'sentry_dsn_js': settings.SENTRY_DSN_JS if sentry.enabled else None,"]}, {"lines": ["        'sanitize': sanitize,"]}, {"lines": ["    # Site-wide API routes", "", "    process_rules(app, ["]}, {"lines": ["        Rule("]}, {"lines": ["            '/citations/styles/',"]}, {"lines": ["            'get',"]}, {"lines": ["            citation_views.list_citation_styles,"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": ["    ], prefix='/api/v1')"]}, {"lines": ["    # OAuth", "", "    process_rules(app, ["]}, {"lines": ["        Rule(", "            '/oauth/connect/<service_name>/',", "            'get',"]}, {"lines": ["            oauth_views.oauth_connect,", "            json_renderer,", "        ),", ""]}, {"lines": ["        Rule(", "            '/oauth/callback/<service_name>/',", "            'get',"]}, {"lines": ["            oauth_views.oauth_callback,", "            OsfWebRenderer('util/oauth_complete.mako'),", "        ),", "    ])", ""]}, {"lines": ["        Rule(", "            [", "                '/oauth/accounts/<external_account_id>/',", "            ],", "            'delete',", "            oauth_views.oauth_disconnect,", "            json_renderer,", "        )", "    ], prefix='/api/v1')", ""]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["            ],", "            'get',"]}, {"lines": ["            citation_views.node_citation,"]}, {"lines": ["            json_renderer,", "        ),", ""]}, {"lines": ["        Rule('/login/connected_tools/',", "             'get',", "             landing_page_views.connected_tools,"]}, {"lines": ["             OsfWebRenderer('public/login_landing.mako')),"]}, {"lines": ["", "        Rule('/login/enriched_profile/',", "             'get',", "             landing_page_views.enriched_profile,"]}, {"lines": ["             OsfWebRenderer('public/login_landing.mako')),"]}, {"lines": [""]}, {"lines": ["        Rule('/profile/', 'put', profile_views.update_user, json_renderer),"]}, {"lines": ["            '/profile/export/',", "            'post',", "            profile_views.request_export,", "            json_renderer,", "        ),", "", "        Rule(", "            '/profile/deactivate/',", "            'post',", "            profile_views.request_deactivation,", "            json_renderer,", "        ),", "", "        Rule("]}, {"lines": ["        Rule('/search/projects/', 'get', search_views.search_projects_by_title, json_renderer),"]}, {"lines": ["        # Create, using existing project as a template", "        Rule([", "            '/project/new/<nid>/',", "        ], 'post', project_views.node.project_new_from_template, json_renderer),", ""]}, {"lines": ["        Rule([", "            '/project/<pid>/permissions/beforepublic/',", "            '/project/<pid>/node/<nid>/permissions/beforepublic/',", "        ], 'get', project_views.node.project_before_set_public, json_renderer),"]}, {"lines": ["from framework.auth import signals as auth"]}, {"lines": ["ALL_SIGNALS = [", "    auth.contributor_removed,", "    auth.node_deleted,", "    project.unreg_contributor_added,", "    auth.user_confirmed,", "    auth.user_email_removed,", "    auth.user_registered,"]}, {"lines": ["from website.addons.base import serializer"]}, {"lines": ["from website.project.model import Node"]}, {"lines": ["                 node_settings_template=None, user_settings_template=None,"]}, {"lines": ["        # Provide the path the the user_settings template", "        self.user_settings_template = user_settings_template"]}, {"lines": [""]}, {"lines": ["        self.node_settings_template = node_settings_template"]}, {"lines": [""]}, {"lines": ["        )"]}, {"lines": ["            )"]}, {"lines": ["        else:"]}, {"lines": [""]}, {"lines": ["        self.on_delete()"]}, {"lines": ["        self.on_add()"]}, {"lines": ["    #############", "    # Callbacks #", "    #############", "", "    def on_add(self):"]}, {"lines": ["        pass", "", "    def on_delete(self):"]}, {"lines": ["        pass"]}, {"lines": ["    @property", "    def can_be_merged(self):", "        return hasattr(self, 'merge')", ""]}, {"lines": ["class AddonOAuthUserSettingsBase(AddonUserSettingsBase):"]}, {"lines": [""]}, {"lines": ["    # Keeps track of what nodes have been given permission to use external", "    #   accounts belonging to the user."]}, {"lines": ["    oauth_grants = fields.DictionaryField()", "    # example:"]}, {"lines": ["    # {", "    #     '<Node._id>': {", "    #         '<ExternalAccount._id>': {", "    #             <metadata>", "    #         },", "    #     }", "    # }", "    #", "    # metadata here is the specific to each addon.", ""]}, {"lines": ["    # The existence of this property is used to determine whether or not", "    #   an addon instance is an \"OAuth addon\" in", "    #   AddonModelMixin.get_oauth_addons()."]}, {"lines": ["    oauth_provider = None", ""]}, {"lines": ["    serializer = serializer.OAuthAddonSerializer", ""]}, {"lines": ["    @property"]}, {"lines": ["    def has_auth(self):", "        return bool(self.external_accounts)", ""]}, {"lines": ["    @property"]}, {"lines": ["    def external_accounts(self):"]}, {"lines": ["        \"\"\"The user's list of ``ExternalAccount`` instances for this provider\"\"\""]}, {"lines": ["        return [", "            x for x in self.owner.external_accounts", "            if x.provider == self.oauth_provider.short_name", "        ]", "", "    def grant_oauth_access(self, node, external_account, metadata=None):"]}, {"lines": ["        \"\"\"Give a node permission to use an ``ExternalAccount`` instance.\"\"\""]}, {"lines": ["        # ensure the user owns the external_account", "        if external_account not in self.owner.external_accounts:", "            raise PermissionsError()", "", "        metadata = metadata or {}", "", "        # create an entry for the node, if necessary", "        if node._id not in self.oauth_grants:", "            self.oauth_grants[node._id] = {}", "", "        # create an entry for the external account on the node, if necessary", "        if external_account._id not in self.oauth_grants[node._id]:", "            self.oauth_grants[node._id][external_account._id] = {}", "", "        # update the metadata with the supplied values", "        for key, value in metadata.iteritems():", "            self.oauth_grants[node._id][external_account._id][key] = value", "", "        self.save()", ""]}, {"lines": ["    def revoke_oauth_access(self, external_account):"]}, {"lines": ["        \"\"\"Revoke all access to an ``ExternalAccount``.", "", "        TODO: This should accept node and metadata params in the future, to", "            allow fine-grained revocation of grants. That's not yet been needed,", "            so it's not yet been implemented.", "        \"\"\""]}, {"lines": ["        for key in self.oauth_grants:", "            self.oauth_grants[key].pop(external_account._id, None)", "", "        self.save()", ""]}, {"lines": ["    def verify_oauth_access(self, node, external_account, metadata=None):"]}, {"lines": ["        \"\"\"Verify that access has been previously granted.", "", "        If metadata is not provided, this checks only if the node can access the", "        account. This is suitable to check to see if the node's addon settings", "        is still connected to an external account (i.e., the user hasn't revoked", "        it in their user settings pane).", "", "        If metadata is provided, this checks to see that all key/value pairs", "        have been granted. This is suitable for checking access to a particular", "        folder or other resource on an external provider.", "        \"\"\"", ""]}, {"lines": ["        metadata = metadata or {}", "", "        # ensure the grant exists", "        try:", "            grants = self.oauth_grants[node._id][external_account._id]", "        except KeyError:", "            return False", "", "        # Verify every key/value pair is in the grants dict", "        for key, value in metadata.iteritems():", "            if key not in grants or grants[key] != value:", "                return False", "", "        return True", ""]}, {"lines": ["    def get_nodes_with_oauth_grants(self, external_account):", "        # Generator of nodes which have grants for this external account", "        return (", "            Node.load(node_id)", "            for node_id, grants in self.oauth_grants.iteritems()", "            if external_account._id in grants.keys()", "        )", ""]}, {"lines": ["    def get_attached_nodes(self, external_account):", "        for node in self.get_nodes_with_oauth_grants(external_account):"]}, {"lines": ["            node_settings = node.get_addon(self.oauth_provider.short_name)", "", "            if node_settings is None:", "                continue", "", "            if node_settings.external_account == external_account:", "                yield node", ""]}, {"lines": ["    def merge(self, user_settings):", "        \"\"\"Merge `user_settings` into this instance\"\"\"", "        if user_settings.__class__ is not self.__class__:", "            raise TypeError('Cannot merge different addons')", "", "        for node_id, data in user_settings.oauth_grants.iteritems():", "            if node_id not in self.oauth_grants:", "                self.oauth_grants[node_id] = data", "            else:"]}, {"lines": ["                node_grants = user_settings.oauth_grants[node_id].iteritems()", "                for ext_acct, meta in node_grants:"]}, {"lines": ["                    if ext_acct not in self.oauth_grants[node_id]:", "                        self.oauth_grants[node_id][ext_acct] = meta", "                    else:", "                        for k, v in meta:", "                            if k not in self.oauth_grants[node_id][ext_acct]:", "                                self.oauth_grants[node_id][ext_acct][k] = v", "", "        user_settings.oauth_grants = {}", "        user_settings.save()"]}, {"lines": ["", "        try:", "            config = settings.ADDONS_AVAILABLE_DICT[", "                self.oauth_provider.short_name", "            ]", "            Model = config.settings_models['node']", "        except KeyError:", "            pass", "        else:", "            connected = Model.find(Q('user_settings', 'eq', user_settings))", "            for node_settings in connected:", "                node_settings.user_settings = self", "                node_settings.save()", ""]}, {"lines": ["        self.save()", ""]}, {"lines": ["    def to_json(self, user):", "        ret = super(AddonOAuthUserSettingsBase, self).to_json(user)"]}, {"lines": ["", "        ret['accounts'] = self.serializer(", "            user_settings=self", "        ).serialized_accounts", ""]}, {"lines": ["        return ret", ""]}, {"lines": ["    #############", "    # Callbacks #", "    #############", "", "    def on_delete(self):"]}, {"lines": ["        \"\"\"When the user deactivates the addon, clear auth for connected nodes.", "        \"\"\""]}, {"lines": ["        super(AddonOAuthUserSettingsBase, self).on_delete()", "        nodes = [Node.load(node_id) for node_id in self.oauth_grants.keys()]", "        for node in nodes:", "            node_addon = node.get_addon(self.oauth_provider.short_name)", "            if node_addon and node_addon.user_settings == self:", "                node_addon.clear_auth()", ""]}, {"lines": ["class AddonOAuthNodeSettingsBase(AddonNodeSettingsBase):"]}, {"lines": ["", "    # TODO: Validate this field to be sure it matches the provider's short_name"]}, {"lines": ["    # NOTE: Do not set this field directly. Use ``set_auth()``"]}, {"lines": ["    external_account = fields.ForeignField('externalaccount',", "                                           backref='connected')", ""]}, {"lines": ["    # NOTE: Do not set this field directly. Use ``set_auth()``"]}, {"lines": ["    user_settings = fields.AbstractForeignField()", ""]}, {"lines": ["    # The existence of this property is used to determine whether or not", "    #   an addon instance is an \"OAuth addon\" in", "    #   AddonModelMixin.get_oauth_addons()."]}, {"lines": ["    oauth_provider = None", "", "    @property", "    def has_auth(self):"]}, {"lines": ["        \"\"\"Instance has an external account and *active* permission to use it\"\"\""]}, {"lines": ["        if not (self.user_settings and self.external_account):", "            return False", "", "        return self.user_settings.verify_oauth_access(", "            node=self.owner,", "            external_account=self.external_account", "        )", "", "    def set_auth(self, external_account, user):", "        \"\"\"Connect the node addon to a user's external account."]}, {"lines": ["", "        This method also adds the permission to use the account in the user's", "        addon settings."]}, {"lines": ["        \"\"\"", "        # tell the user's addon settings that this node is connected to it", "        user_settings = user.get_or_add_addon(self.oauth_provider.short_name)", "        user_settings.grant_oauth_access(", "            node=self.owner,", "            external_account=external_account", "            # no metadata, because the node has access to no folders", "        )", "        user_settings.save()", "", "        # update this instance", "        self.user_settings = user_settings", "        self.external_account = external_account", "", "        self.save()", "", "    def clear_auth(self):"]}, {"lines": ["        \"\"\"Disconnect the node settings from the user settings.", "", "        This method does not remove the node's permission in the user's addon", "        settings.", "        \"\"\""]}, {"lines": ["        self.external_account = None", "        self.user_settings = None", "        self.save()", ""]}, {"lines": [""]}, {"lines": ["from framework.auth.decorators import collect_auth"]}, {"lines": [""]}, {"lines": ["    def __init__(self, node_settings=None, user_settings=None):", "        self.node_settings = node_settings", "        self.user_settings = user_settings"]}, {"lines": ["    def serialized_node_settings(self):"]}, {"lines": ["            'nodeHasAuth': self.node_settings.has_auth,"]}, {"lines": ["        if self.user_settings:", "            result['userHasAuth'] = self.user_settings.has_auth", "        else:", "            result['userHasAuth'] = False", "", "        if self.node_settings.has_auth:"]}, {"lines": ["    @property", "    def serialized_user_settings(self):", "        return {}", "", ""]}, {"lines": ["class OAuthAddonSerializer(AddonSerializer):", "    @property", "    def serialized_accounts(self):", "        return [", "            self.serialize_account(each)", "            for each in self.user_settings.external_accounts", "        ]", "", "    @property", "    def serialized_user_settings(self):", "        retval = super(OAuthAddonSerializer, self).serialized_user_settings"]}, {"lines": ["", "        return retval", "", "    def serialize_account(self, external_account):", "        if external_account is None:", "            return None", "        return {", "            'id': external_account._id,", "            'provider_id': external_account.provider_id,"]}, {"lines": ["            'display_name': external_account.display_name,"]}, {"lines": ["            'profile_url': external_account.profile_url,"]}, {"lines": ["            'nodes': [", "                self.serialize_granted_node(node)"]}, {"lines": ["                for node in self.user_settings.get_attached_nodes("]}, {"lines": ["                    external_account=external_account", "                )"]}, {"lines": ["        }", "", "    @collect_auth", "    def serialize_granted_node(self, node, auth):", "", "        node_settings = node.get_addon(", "            self.user_settings.oauth_provider.short_name", "        )", "        serializer = node_settings.serializer(node_settings=node_settings)"]}, {"lines": ["        urls = serializer.addon_serialized_urls", "        urls['view'] = node.url"]}, {"lines": ["", "        return {", "            'id': node._id,", "            'title': node.title if node.can_view(auth) else None,"]}, {"lines": ["            'urls': urls,"]}, {"lines": ["        }", ""]}, {"lines": [""]}, {"lines": ["class CitationsAddonSerializer(OAuthAddonSerializer):"]}, {"lines": ["        external_account = self.node_settings.external_account"]}, {"lines": ["                                service_name=self.node_settings.provider_name),"]}, {"lines": ["            'files': self.node_settings.owner.url,"]}, {"lines": ["    def serialized_node_settings(self):", "        result = super(CitationsAddonSerializer, self).serialized_node_settings"]}, {"lines": ["        if self.user_settings is None:", "            return False", "", "        user_accounts = self.user_settings.external_accounts", "        return bool(", "            (", "                self.node_settings.has_auth and", "                (self.node_settings.external_account in user_accounts)", "            ) or len(user_accounts)", "        )"]}, {"lines": ["        return self.node_settings.user_settings.owner"]}, {"lines": ["from framework.exceptions import PermissionsError"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                self.serializer("]}, {"lines": ["                ).serialize_account(each)"]}, {"lines": ["        external_account = ExternalAccount.load(external_account_id)"]}, {"lines": ["        try:", "            node_addon.set_auth(external_account, user)", "        except PermissionsError:", "            raise HTTPError(http.FORBIDDEN)"]}, {"lines": ["        result = self.serializer(", "            node_settings=node_addon,", "            user_settings=user.get_addon(self.provider_name),", "        ).serialized_node_settings"]}, {"lines": ["        node_addon.clear_auth()"]}, {"lines": ["        node_addon.reload()"]}, {"lines": ["        result = self.serializer(", "            node_settings=node_addon,", "            user_settings=user.get_addon(self.provider_name),", "        ).serialized_node_settings"]}, {"lines": [""]}, {"lines": ["                    self.serializer(", "                        node_settings=node_addon,"]}, {"lines": ["                    ).serialize_folder(each)"]}, {"lines": ["                    self.serializer(", "                        node_settings=node_addon,"]}, {"lines": ["                    ).serialize_citation(each)"]}, {"lines": [""]}, {"lines": ["from website.util.sanitize import escape_html", ""]}, {"lines": ["            return escape_html(rv)"]}, {"lines": ["                return mapper(escape_html(rv))"]}, {"lines": ["                return escape_html(rv())"]}, {"lines": [""]}, {"lines": ["logger = logging.getLogger(__name__)"]}, {"lines": [""]}, {"lines": ["    logger.warn('No local.py settings file found')"]}, {"lines": ["logger = logging.getLogger(__name__)"]}, {"lines": ["            logger.error('Could not access GitHub repo')"]}, {"lines": ["from mendeley.session import MendeleySession", "", "", "class APISession(MendeleySession):", "", "    def request(self, *args, **kwargs):", "        kwargs['params'] = {'view': 'all'}"]}, {"lines": ["                'fetch': self.node_settings.owner.api_url_for("]}, {"lines": ["        node = self.node_settings.owner"]}, {"lines": ["from flask import request", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    provider = MendeleyCitationsProvider()"]}, {"lines": ["    return provider.serializer(", "        user_settings=auth.user.get_addon('mendeley')", "    ).serialized_user_settings"]}, {"lines": ["", ""]}, {"lines": ["@must_have_permission('read')"]}, {"lines": ["@must_have_addon('mendeley', 'node')"]}, {"lines": ["    )"]}, {"lines": [""]}, {"lines": ["    return provider.add_user_auth(node_addon, auth.user, external_account_id)"]}, {"lines": ["@must_not_be_registration"]}, {"lines": [""]}, {"lines": ["", "", "@must_be_contributor_or_public", "@must_have_addon('mendeley', 'node')"]}, {"lines": [""]}, {"lines": ["", "", "@must_be_contributor_or_public", "@must_have_addon('mendeley', 'node')"]}, {"lines": ["    This function collects a listing of folders and citations based on the", "    passed mendeley_list_id. If mendeley_list_id is None, then all of the", "    authorizer's folders and citations are listed"]}, {"lines": ["# OAuth app keys", "MENDELEY_CLIENT_ID = None", "MENDELEY_CLIENT_SECRET = None"]}, {"lines": ["var $ = require('jquery');", "var ko = require('knockout');"]}, {"lines": ["////////////////", "// Public API //", "////////////////", ""]}, {"lines": ["    var apiUrl = window.contextVars.node.urls.api + 'mendeley/citations/' + window.contextVars.mendeley.folder_id + '/';"]}, {"lines": ["}", "", "CitationsWidget.prototype.init = function() {", "    var self = this;", "    ko.applyBindings(self.viewModel, self.$element[0]);", "};"]}, {"lines": [""]}, {"lines": ["from framework.exceptions import PermissionsError", ""]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["    ExternalAccountFactory,"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "class MendeleyProviderTestCase(OsfTestCase):"]}, {"lines": ["        # Must return provider_id and display_name"]}, {"lines": [""]}, {"lines": ["        # The first call to .client returns a new client"]}, {"lines": [""]}, {"lines": ["        # Repeated calls to .client returns the same client"]}, {"lines": [""]}, {"lines": ["class MendeleyNodeSettingsTestCase(OsfTestCase):"]}, {"lines": ["        self.node = ProjectFactory()"]}, {"lines": ["        self.node_settings.save()", "        self.user = self.node.creator", "        self.user_settings = self.user.get_or_add_addon('mendeley')"]}, {"lines": ["    def tearDown(self):", "        super(MendeleyNodeSettingsTestCase, self).tearDown()", "        self.user_settings.remove()", "        self.node_settings.remove()", "        self.node.remove()", "        self.user.remove()", ""]}, {"lines": ["        # The first call to .api returns a new object"]}, {"lines": ["        api = self.node_settings.api"]}, {"lines": [""]}, {"lines": ["        # Repeated calls to .api returns the same object"]}, {"lines": ["        self.node_settings._api = 'testapi'", "        api = self.node_settings.api"]}, {"lines": [""]}, {"lines": ["    def test_set_auth(self):", "        external_account = ExternalAccountFactory()", "        self.user.external_accounts.append(external_account)", "        self.user.save()", "", "        # this should be reset after the call", "        self.node_settings.mendeley_list_id = 'anything'", "", "        self.node_settings.set_auth(", "            external_account=external_account,", "            user=self.user", "        )", "", "        # this instance is updated", "        assert_equal(", "            self.node_settings.external_account,", "            external_account", "        )", "        assert_equal(", "            self.node_settings.user_settings,", "            self.user_settings", "        )", "        assert_is_none(", "            self.node_settings.mendeley_list_id", "        )", "", "        # user_settings was updated", "        # TODO: The call to grant_oauth_access in set_auth should be mocked", "        assert_true(", "            self.user_settings.verify_oauth_access(", "                node=self.node,", "                external_account=external_account,"]}, {"lines": ["        )", "", "    def test_set_auth_wrong_user(self):", "        external_account = ExternalAccountFactory()", "        self.user.external_accounts.append(external_account)", "        self.user.save()", "", "        with assert_raises(PermissionsError):", "            self.node_settings.set_auth(", "                external_account=external_account,", "                user=UserFactory()", "            )", "", "    def test_clear_auth(self):", "        self.node_settings.external_account = ExternalAccountFactory()", "        self.node_settings.mendeley_list_id = 'something'", "        self.node_settings.user_settings = self.user_settings", "        self.node_settings.save()", "", "        self.node_settings.clear_auth()", "", "        assert_is_none(self.node_settings.external_account)", "        assert_is_none(self.node_settings.mendeley_list_id)", "        assert_is_none(self.node_settings.user_settings)", "", "    def test_set_target_folder(self):"]}, {"lines": ["        external_account = ExternalAccountFactory()", "        self.user.external_accounts.append(external_account)", "        self.user.save()", "", "        self.node_settings.set_auth(", "            external_account=external_account,"]}, {"lines": ["        )", "", "        assert_is_none(self.node_settings.mendeley_list_id)", ""]}, {"lines": ["", "        # instance was updated", "        assert_equal(", "            self.node_settings.mendeley_list_id,", "            'fake-folder-id',", "        )", "", "        # user_settings was updated", "        # TODO: the call to grant_oauth_access should be mocked", "        assert_true(", "            self.user_settings.verify_oauth_access(", "                node=self.node,", "                external_account=external_account,", "                metadata={'folder': 'fake-folder-id'}", "            )", "        )", ""]}, {"lines": ["    def test_has_auth_false(self):", "        external_account = ExternalAccountFactory()", "", "        assert_false(self.node_settings.has_auth)", "", "        # both external_account and user_settings must be set to have auth", "        self.node_settings.external_account = external_account", "        assert_false(self.node_settings.has_auth)", "", "        self.node_settings.external_account = None", "        self.node_settings.user_settings = self.user_settings", "        assert_false(self.node_settings.has_auth)", "", "        # set_auth must be called to have auth", "        self.node_settings.external_account = external_account", "        self.node_settings.user_settings = self.user_settings", "        assert_false(self.node_settings.has_auth)", "", "    def test_has_auth_true(self):", "        external_account = ExternalAccountFactory()", "        self.user.external_accounts.append(external_account)", "", "        self.node_settings.set_auth(external_account, self.user)", "", "        # mendeley_list_id should have no effect", "        self.node_settings.mendeley_list_id = None", "        assert_true(self.node_settings.has_auth)", "", "        # mendeley_list_id should have no effect", "        self.node_settings.mendeley_list_id = 'totally fake ID'", "        assert_true(self.node_settings.has_auth)", "", "    def test_selected_folder_name_root(self):", "        self.node_settings.mendeley_list_id = 'ROOT'", "", "        assert_equal(", "            self.node_settings.selected_folder_name,", "            \"All Documents\"", "        )", "", "    def test_selected_folder_name_empty(self):", "        self.node_settings.mendeley_list_id = None", "", "        assert_equal(", "            self.node_settings.selected_folder_name,", "            ''", "        )", "", "    @mock.patch('website.addons.mendeley.model.Mendeley._folder_metadata')", "    def test_selected_folder_name(self, mock_folder_metadata):", "        # Mock the return from api call to get the folder's name", "        mock_folder = mock.Mock()", "        mock_folder.name = 'Fake Folder'", "", "        # Add the mocked return object to the mocked api client", "        mock_folder_metadata.return_value = mock_folder", "", "        self.node_settings.mendeley_list_id = 'fake-list-id'", "", "        assert_equal(", "            self.node_settings.selected_folder_name,", "            'Fake Folder'", "        )", ""]}, {"lines": [""]}, {"lines": ["class MendeleyUserSettingsTestCase(OsfTestCase):"]}, {"lines": ["", "    def _prep_oauth_case(self):", "        self.node = ProjectFactory()", "        self.user = self.node.creator", "", "        self.external_account = ExternalAccountFactory()", "", "        self.user.external_accounts.append(self.external_account)", "        self.user.save()", "", "        self.user_settings = self.user.get_or_add_addon('mendeley')", "", "    def test_grant_oauth_access_no_metadata(self):", "        self._prep_oauth_case()", "", "        self.user_settings.grant_oauth_access(", "            node=self.node,", "            external_account=self.external_account,", "        )", "        self.user_settings.save()", "", "        assert_equal(", "            self.user_settings.oauth_grants,", "            {self.node._id: {self.external_account._id: {}}},", "        )", "", "    def test_grant_oauth_access_metadata(self):", "        self._prep_oauth_case()", "", "        self.user_settings.grant_oauth_access(", "            node=self.node,", "            external_account=self.external_account,", "            metadata={'folder': 'fake_folder_id'}", "        )", "        self.user_settings.save()", "", "        assert_equal(", "            self.user_settings.oauth_grants,", "            {", "                self.node._id: {", "                    self.external_account._id: {'folder': 'fake_folder_id'}", "                },", "            }", "        )", "", "    def test_verify_oauth_access_no_metadata(self):", "        self._prep_oauth_case()", "", "        self.user_settings.grant_oauth_access(", "            node=self.node,", "            external_account=self.external_account,", "        )", "        self.user_settings.save()", "", "        assert_true(", "            self.user_settings.verify_oauth_access(", "                node=self.node,", "                external_account=self.external_account", "            )", "        )", "", "        assert_false(", "            self.user_settings.verify_oauth_access(", "                node=self.node,", "                external_account=ExternalAccountFactory()", "            )", "        )", "", "    def test_verify_oauth_access_metadata(self):", "        self._prep_oauth_case()", "", "        self.user_settings.grant_oauth_access(", "            node=self.node,", "            external_account=self.external_account,", "            metadata={'folder': 'fake_folder_id'}", "        )", "        self.user_settings.save()", "", "        assert_true(", "            self.user_settings.verify_oauth_access(", "                node=self.node,", "                external_account=self.external_account,", "                metadata={'folder': 'fake_folder_id'}", "            )", "        )", "", "        assert_false(", "            self.user_settings.verify_oauth_access(", "                node=self.node,", "                external_account=self.external_account,", "                metadata={'folder': 'another_folder_id'}", "            )", "        )"]}, {"lines": ["", "from tests.base import OsfTestCase"]}, {"lines": ["", "class MendeleyViewsTestCase(OsfTestCase):"]}, {"lines": ["    def test_set_auth(self):", ""]}, {"lines": ["            self.project.api_url_for('mendeley_add_user_auth'),"]}, {"lines": ["        assert_equal(", "            res.status_code,", "            200"]}, {"lines": [""]}, {"lines": ["        assert_true(res.json['result']['userHasAuth'])", "", "        assert_equal(", "            self.node_addon.user_settings,", "            self.user_addon", "        )", "        assert_equal(", "            self.node_addon.external_account,", "            self.account", "        )", ""]}, {"lines": ["    def test_remove_user_auth(self):"]}, {"lines": ["        self.node_addon.set_auth(self.account, self.user)", "", "        res = self.app.delete_json(", "            self.project.api_url_for('mendeley_remove_user_auth'),"]}, {"lines": ["        assert_equal(", "            res.status_code,", "            200", "        )", ""]}, {"lines": ["        self.node_addon.reload()"]}, {"lines": ["", "        assert_is_none(self.node_addon.user_settings)", "        assert_is_none(self.node_addon.external_account)", ""]}, {"lines": ["        # Settings config updates node settings"]}, {"lines": ["                'external_account_id': self.account._id,"]}, {"lines": ["            auth=self.user.auth,"]}, {"lines": ["        assert_equal(self.user_addon, self.node_addon.user_settings)"]}, {"lines": ["        user = AuthUserFactory()", "        user.add_addon('mendeley')", "        self.project.add_contributor(user)", "        self.project.save()"]}, {"lines": ["            auth=user.auth,"]}, {"lines": ["        assert_equal(self.user_addon, self.node_addon.user_settings)"]}, {"lines": [""]}, {"lines": ["        # JSON: everything a widget needs"]}, {"lines": ["", "    def test_widget_view_incomplete(self):"]}, {"lines": ["        # JSON: tell the widget when it hasn't been configured"]}, {"lines": [""]}, {"lines": ["SHORT_NAME = 'twofactor'", "FULL_NAME = 'Two-factor Authentication'", "WIDGET_HELP = 'Two-Factor Authentication (Alpha)'", ""]}, {"lines": ["USER_SETTINGS_MODEL = TwoFactorUserSettings"]}, {"lines": ["", "MODELS = [TwoFactorUserSettings]", "", "ROUTES = [settings_routes, ]", "", "OWNERS = ['user', ]", "", "ADDED_TO = {", "    'user': False,", "    'node': False,", "}", "", "VIEWS = []", "CONFIGS = ['user']", ""]}, {"lines": ["from framework.routing import Rule, json_renderer", ""]}, {"lines": ["", "settings_routes = {", "    'rules': [", "", "        # OAuth: General", "        Rule(["]}, {"lines": ["        ], 'post', views.user_settings, json_renderer),", "    ],", "    'prefix': '/api/v1',"]}, {"lines": ["(function(r){r.fn.qrcode=function(h){var s;function u(a){this.mode=s;this.data=a}function o(a,c){this.typeNumber=a;this.errorCorrectLevel=c;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[]}function q(a,c){if(void 0==a.length)throw Error(a.length+\"/\"+c);for(var d=0;d<a.length&&0==a[d];)d++;this.num=Array(a.length-d+c);for(var b=0;b<a.length-d;b++)this.num[b]=a[b+d]}function p(a,c){this.totalCount=a;this.dataCount=c}function t(){this.buffer=[];this.length=0}u.prototype={getLength:function(){return this.data.length},", "write:function(a){for(var c=0;c<this.data.length;c++)a.put(this.data.charCodeAt(c),8)}};o.prototype={addData:function(a){this.dataList.push(new u(a));this.dataCache=null},isDark:function(a,c){if(0>a||this.moduleCount<=a||0>c||this.moduleCount<=c)throw Error(a+\",\"+c);return this.modules[a][c]},getModuleCount:function(){return this.moduleCount},make:function(){if(1>this.typeNumber){for(var a=1,a=1;40>a;a++){for(var c=p.getRSBlocks(a,this.errorCorrectLevel),d=new t,b=0,e=0;e<c.length;e++)b+=c[e].dataCount;", "for(e=0;e<this.dataList.length;e++)c=this.dataList[e],d.put(c.mode,4),d.put(c.getLength(),j.getLengthInBits(c.mode,a)),c.write(d);if(d.getLengthInBits()<=8*b)break}this.typeNumber=a}this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(a,c){this.moduleCount=4*this.typeNumber+17;this.modules=Array(this.moduleCount);for(var d=0;d<this.moduleCount;d++){this.modules[d]=Array(this.moduleCount);for(var b=0;b<this.moduleCount;b++)this.modules[d][b]=null}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-", "7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.setupTypeInfo(a,c);7<=this.typeNumber&&this.setupTypeNumber(a);null==this.dataCache&&(this.dataCache=o.createData(this.typeNumber,this.errorCorrectLevel,this.dataList));this.mapData(this.dataCache,c)},setupPositionProbePattern:function(a,c){for(var d=-1;7>=d;d++)if(!(-1>=a+d||this.moduleCount<=a+d))for(var b=-1;7>=b;b++)-1>=c+b||this.moduleCount<=c+b||(this.modules[a+d][c+b]=", "0<=d&&6>=d&&(0==b||6==b)||0<=b&&6>=b&&(0==d||6==d)||2<=d&&4>=d&&2<=b&&4>=b?!0:!1)},getBestMaskPattern:function(){for(var a=0,c=0,d=0;8>d;d++){this.makeImpl(!0,d);var b=j.getLostPoint(this);if(0==d||a>b)a=b,c=d}return c},createMovieClip:function(a,c,d){a=a.createEmptyMovieClip(c,d);this.make();for(c=0;c<this.modules.length;c++)for(var d=1*c,b=0;b<this.modules[c].length;b++){var e=1*b;this.modules[c][b]&&(a.beginFill(0,100),a.moveTo(e,d),a.lineTo(e+1,d),a.lineTo(e+1,d+1),a.lineTo(e,d+1),a.endFill())}return a},", "setupTimingPattern:function(){for(var a=8;a<this.moduleCount-8;a++)null==this.modules[a][6]&&(this.modules[a][6]=0==a%2);for(a=8;a<this.moduleCount-8;a++)null==this.modules[6][a]&&(this.modules[6][a]=0==a%2)},setupPositionAdjustPattern:function(){for(var a=j.getPatternPosition(this.typeNumber),c=0;c<a.length;c++)for(var d=0;d<a.length;d++){var b=a[c],e=a[d];if(null==this.modules[b][e])for(var f=-2;2>=f;f++)for(var i=-2;2>=i;i++)this.modules[b+f][e+i]=-2==f||2==f||-2==i||2==i||0==f&&0==i?!0:!1}},setupTypeNumber:function(a){for(var c=", "j.getBCHTypeNumber(this.typeNumber),d=0;18>d;d++){var b=!a&&1==(c>>d&1);this.modules[Math.floor(d/3)][d%3+this.moduleCount-8-3]=b}for(d=0;18>d;d++)b=!a&&1==(c>>d&1),this.modules[d%3+this.moduleCount-8-3][Math.floor(d/3)]=b},setupTypeInfo:function(a,c){for(var d=j.getBCHTypeInfo(this.errorCorrectLevel<<3|c),b=0;15>b;b++){var e=!a&&1==(d>>b&1);6>b?this.modules[b][8]=e:8>b?this.modules[b+1][8]=e:this.modules[this.moduleCount-15+b][8]=e}for(b=0;15>b;b++)e=!a&&1==(d>>b&1),8>b?this.modules[8][this.moduleCount-", "b-1]=e:9>b?this.modules[8][15-b-1+1]=e:this.modules[8][15-b-1]=e;this.modules[this.moduleCount-8][8]=!a},mapData:function(a,c){for(var d=-1,b=this.moduleCount-1,e=7,f=0,i=this.moduleCount-1;0<i;i-=2)for(6==i&&i--;;){for(var g=0;2>g;g++)if(null==this.modules[b][i-g]){var n=!1;f<a.length&&(n=1==(a[f]>>>e&1));j.getMask(c,b,i-g)&&(n=!n);this.modules[b][i-g]=n;e--; -1==e&&(f++,e=7)}b+=d;if(0>b||this.moduleCount<=b){b-=d;d=-d;break}}}};o.PAD0=236;o.PAD1=17;o.createData=function(a,c,d){for(var c=p.getRSBlocks(a,", "c),b=new t,e=0;e<d.length;e++){var f=d[e];b.put(f.mode,4);b.put(f.getLength(),j.getLengthInBits(f.mode,a));f.write(b)}for(e=a=0;e<c.length;e++)a+=c[e].dataCount;if(b.getLengthInBits()>8*a)throw Error(\"code length overflow. (\"+b.getLengthInBits()+\">\"+8*a+\")\");for(b.getLengthInBits()+4<=8*a&&b.put(0,4);0!=b.getLengthInBits()%8;)b.putBit(!1);for(;!(b.getLengthInBits()>=8*a);){b.put(o.PAD0,8);if(b.getLengthInBits()>=8*a)break;b.put(o.PAD1,8)}return o.createBytes(b,c)};o.createBytes=function(a,c){for(var d=", "0,b=0,e=0,f=Array(c.length),i=Array(c.length),g=0;g<c.length;g++){var n=c[g].dataCount,h=c[g].totalCount-n,b=Math.max(b,n),e=Math.max(e,h);f[g]=Array(n);for(var k=0;k<f[g].length;k++)f[g][k]=255&a.buffer[k+d];d+=n;k=j.getErrorCorrectPolynomial(h);n=(new q(f[g],k.getLength()-1)).mod(k);i[g]=Array(k.getLength()-1);for(k=0;k<i[g].length;k++)h=k+n.getLength()-i[g].length,i[g][k]=0<=h?n.get(h):0}for(k=g=0;k<c.length;k++)g+=c[k].totalCount;d=Array(g);for(k=n=0;k<b;k++)for(g=0;g<c.length;g++)k<f[g].length&&", "(d[n++]=f[g][k]);for(k=0;k<e;k++)for(g=0;g<c.length;g++)k<i[g].length&&(d[n++]=i[g][k]);return d};s=4;for(var j={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,", "78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(a){for(var c=a<<10;0<=j.getBCHDigit(c)-j.getBCHDigit(j.G15);)c^=j.G15<<j.getBCHDigit(c)-j.getBCHDigit(j.G15);return(a<<10|c)^j.G15_MASK},getBCHTypeNumber:function(a){for(var c=a<<12;0<=j.getBCHDigit(c)-", "j.getBCHDigit(j.G18);)c^=j.G18<<j.getBCHDigit(c)-j.getBCHDigit(j.G18);return a<<12|c},getBCHDigit:function(a){for(var c=0;0!=a;)c++,a>>>=1;return c},getPatternPosition:function(a){return j.PATTERN_POSITION_TABLE[a-1]},getMask:function(a,c,d){switch(a){case 0:return 0==(c+d)%2;case 1:return 0==c%2;case 2:return 0==d%3;case 3:return 0==(c+d)%3;case 4:return 0==(Math.floor(c/2)+Math.floor(d/3))%2;case 5:return 0==c*d%2+c*d%3;case 6:return 0==(c*d%2+c*d%3)%2;case 7:return 0==(c*d%3+(c+d)%2)%2;default:throw Error(\"bad maskPattern:\"+", "a);}},getErrorCorrectPolynomial:function(a){for(var c=new q([1],0),d=0;d<a;d++)c=c.multiply(new q([1,l.gexp(d)],0));return c},getLengthInBits:function(a,c){if(1<=c&&10>c)switch(a){case 1:return 10;case 2:return 9;case s:return 8;case 8:return 8;default:throw Error(\"mode:\"+a);}else if(27>c)switch(a){case 1:return 12;case 2:return 11;case s:return 16;case 8:return 10;default:throw Error(\"mode:\"+a);}else if(41>c)switch(a){case 1:return 14;case 2:return 13;case s:return 16;case 8:return 12;default:throw Error(\"mode:\"+", "a);}else throw Error(\"type:\"+c);},getLostPoint:function(a){for(var c=a.getModuleCount(),d=0,b=0;b<c;b++)for(var e=0;e<c;e++){for(var f=0,i=a.isDark(b,e),g=-1;1>=g;g++)if(!(0>b+g||c<=b+g))for(var h=-1;1>=h;h++)0>e+h||c<=e+h||0==g&&0==h||i==a.isDark(b+g,e+h)&&f++;5<f&&(d+=3+f-5)}for(b=0;b<c-1;b++)for(e=0;e<c-1;e++)if(f=0,a.isDark(b,e)&&f++,a.isDark(b+1,e)&&f++,a.isDark(b,e+1)&&f++,a.isDark(b+1,e+1)&&f++,0==f||4==f)d+=3;for(b=0;b<c;b++)for(e=0;e<c-6;e++)a.isDark(b,e)&&!a.isDark(b,e+1)&&a.isDark(b,e+", "2)&&a.isDark(b,e+3)&&a.isDark(b,e+4)&&!a.isDark(b,e+5)&&a.isDark(b,e+6)&&(d+=40);for(e=0;e<c;e++)for(b=0;b<c-6;b++)a.isDark(b,e)&&!a.isDark(b+1,e)&&a.isDark(b+2,e)&&a.isDark(b+3,e)&&a.isDark(b+4,e)&&!a.isDark(b+5,e)&&a.isDark(b+6,e)&&(d+=40);for(e=f=0;e<c;e++)for(b=0;b<c;b++)a.isDark(b,e)&&f++;a=Math.abs(100*f/c/c-50)/5;return d+10*a}},l={glog:function(a){if(1>a)throw Error(\"glog(\"+a+\")\");return l.LOG_TABLE[a]},gexp:function(a){for(;0>a;)a+=255;for(;256<=a;)a-=255;return l.EXP_TABLE[a]},EXP_TABLE:Array(256),", "LOG_TABLE:Array(256)},m=0;8>m;m++)l.EXP_TABLE[m]=1<<m;for(m=8;256>m;m++)l.EXP_TABLE[m]=l.EXP_TABLE[m-4]^l.EXP_TABLE[m-5]^l.EXP_TABLE[m-6]^l.EXP_TABLE[m-8];for(m=0;255>m;m++)l.LOG_TABLE[l.EXP_TABLE[m]]=m;q.prototype={get:function(a){return this.num[a]},getLength:function(){return this.num.length},multiply:function(a){for(var c=Array(this.getLength()+a.getLength()-1),d=0;d<this.getLength();d++)for(var b=0;b<a.getLength();b++)c[d+b]^=l.gexp(l.glog(this.get(d))+l.glog(a.get(b)));return new q(c,0)},mod:function(a){if(0>", "this.getLength()-a.getLength())return this;for(var c=l.glog(this.get(0))-l.glog(a.get(0)),d=Array(this.getLength()),b=0;b<this.getLength();b++)d[b]=this.get(b);for(b=0;b<a.getLength();b++)d[b]^=l.gexp(l.glog(a.get(b))+c);return(new q(d,0)).mod(a)}};p.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],", "[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,", "116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,", "43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,", "3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,", "55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,", "45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];p.getRSBlocks=function(a,c){var d=p.getRsBlockTable(a,c);if(void 0==d)throw Error(\"bad rs block @ typeNumber:\"+a+\"/errorCorrectLevel:\"+c);for(var b=d.length/3,e=[],f=0;f<b;f++)for(var h=d[3*f+0],g=d[3*f+1],j=d[3*f+2],l=0;l<h;l++)e.push(new p(g,j));return e};p.getRsBlockTable=function(a,c){switch(c){case 1:return p.RS_BLOCK_TABLE[4*(a-1)+0];case 0:return p.RS_BLOCK_TABLE[4*(a-1)+1];case 3:return p.RS_BLOCK_TABLE[4*", "(a-1)+2];case 2:return p.RS_BLOCK_TABLE[4*(a-1)+3]}};t.prototype={get:function(a){return 1==(this.buffer[Math.floor(a/8)]>>>7-a%8&1)},put:function(a,c){for(var d=0;d<c;d++)this.putBit(1==(a>>>c-d-1&1))},getLengthInBits:function(){return this.length},putBit:function(a){var c=Math.floor(this.length/8);this.buffer.length<=c&&this.buffer.push(0);a&&(this.buffer[c]|=128>>>this.length%8);this.length++}};\"string\"===typeof h&&(h={text:h});h=r.extend({},{render:\"canvas\",width:256,height:256,typeNumber:-1,", "correctLevel:2,background:\"#ffffff\",foreground:\"#000000\"},h);return this.each(function(){var a;if(\"canvas\"==h.render){a=new o(h.typeNumber,h.correctLevel);a.addData(h.text);a.make();var c=document.createElement(\"canvas\");c.width=h.width;c.height=h.height;for(var d=c.getContext(\"2d\"),b=h.width/a.getModuleCount(),e=h.height/a.getModuleCount(),f=0;f<a.getModuleCount();f++)for(var i=0;i<a.getModuleCount();i++){d.fillStyle=a.isDark(f,i)?h.foreground:h.background;var g=Math.ceil((i+1)*b)-Math.floor(i*b),", "j=Math.ceil((f+1)*b)-Math.floor(f*b);d.fillRect(Math.round(i*b),Math.round(f*e),g,j)}}else{a=new o(h.typeNumber,h.correctLevel);a.addData(h.text);a.make();c=r(\"<table></table>\").css(\"width\",h.width+\"px\").css(\"height\",h.height+\"px\").css(\"border\",\"0px\").css(\"border-collapse\",\"collapse\").css(\"background-color\",h.background);d=h.width/a.getModuleCount();b=h.height/a.getModuleCount();for(e=0;e<a.getModuleCount();e++){f=r(\"<tr></tr>\").css(\"height\",b+\"px\").appendTo(c);for(i=0;i<a.getModuleCount();i++)r(\"<td></td>\").css(\"width\",", "d+\"px\").css(\"background-color\",a.isDark(e,i)?h.foreground:h.background).appendTo(f)}}a=c;jQuery(a).appendTo(this)})}})(jQuery);"]}, {"lines": ["import time", "", "from oath import totp", "", "", "def _valid_code(seed, drift=0):", "        \"\"\"Generate a valid code.", "", "        :param drift: Number of periods to drift from current time. Optional.", "        :return: valid 6-character two-factor response", "        :rtype: str", "        \"\"\"", "        return totp(", "            key=seed,", "            t=int(time.time()) + (drift * 30)"]}, {"lines": ["import mock"]}, {"lines": ["from nose.tools import *"]}, {"lines": ["", "from tests.base import OsfTestCase", "from tests.factories import AuthUserFactory"]}, {"lines": ["from website.addons.twofactor.tests import _valid_code", ""]}, {"lines": ["", "class TestViews(OsfTestCase):"]}, {"lines": ["    @mock.patch('website.addons.twofactor.models.push_status_message')", "    def setUp(self, mocked):"]}, {"lines": ["        super(TestViews, self).setUp()", "        self.user = AuthUserFactory()", "        self.user.add_addon('twofactor')", "        self.user_settings = self.user.get_addon('twofactor')", ""]}, {"lines": ["    def test_confirm_code(self):", "        # Send a valid code to the API endpoint for the user settings.", "        res = self.app.post_json(", "            '/api/v1/settings/twofactor/',", "            {'code': _valid_code(self.user_settings.totp_secret)},", "            auth=self.user.auth", "        )", "", "        # reload the user settings object from the DB", "        self.user_settings.reload()", "", "        assert_true(self.user_settings.is_confirmed)", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["    def test_confirm_code_failure(self):"]}, {"lines": ["", "        # reload the user settings object from the DB", "        self.user_settings.reload()", ""]}, {"lines": ["from pyzotero import zotero"]}, {"lines": ["from website.addons.base import AddonOAuthNodeSettingsBase", "from website.addons.base import AddonOAuthUserSettingsBase"]}, {"lines": ["from website.addons.citations.utils import serialize_folder"]}, {"lines": ["from website.addons.zotero import serializer"]}, {"lines": ["from website.addons.zotero import settings", "from website.oauth.models import ExternalProvider"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            'display_name': response['username'],", "            'provider_id': response['userID'],", "            'profile_url': 'https://zotero.org/users/{}/'.format(", "                response['userID']", "            ),"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class ZoteroUserSettings(AddonOAuthUserSettingsBase):", "    oauth_provider = Zotero"]}, {"lines": ["    serializer = serializer.ZoteroSerializer"]}, {"lines": [""]}, {"lines": ["", "class ZoteroNodeSettings(AddonOAuthNodeSettingsBase):", "    oauth_provider = Zotero"]}, {"lines": ["    serializer = serializer.ZoteroSerializer"]}, {"lines": ["", "    zotero_list_id = fields.StringField()", "", "    _api = None", "", "    @property", "    def api(self):", "        \"\"\"authenticated ExternalProvider instance\"\"\"", "        if self._api is None:", "            self._api = Zotero()", "            self._api.account = self.external_account", "        return self._api", "", "    @property", "    def complete(self):", "        return self.has_auth and self.user_settings.verify_oauth_access(", "            node=self.owner,", "            external_account=self.external_account,", "            metadata={'folder': self.zotero_list_id},", "        )", "", "    @property", "    def selected_folder_name(self):", "        if self.zotero_list_id is None:", "            return ''", "        elif self.zotero_list_id != 'ROOT':", "            folder = self.api._folder_metadata(self.zotero_list_id)", "            return folder['data'].get('name')", "        else:", "            return 'All Documents'", "", "    @property", "    def root_folder(self):", "        root = serialize_folder(", "            'All Documents',", "            id='ROOT',", "            parent_id='__'", "        )", "        root['kind'] = 'folder'", "        return root", "", "    @property", "    def provider_name(self):", "        return 'zotero'", "", "    def set_auth(self, *args, **kwargs):", "        self.zotero_list_id = None", "        return super(ZoteroNodeSettings, self).set_auth(*args, **kwargs)", "", "    def clear_auth(self):", "        self.zotero_list_id = None", "        return super(ZoteroNodeSettings, self).clear_auth()", ""]}, {"lines": ["        \"\"\"Configure this addon to point to a Zotero folder", "", "        :param str zotero_list_id:", "        :param ExternalAccount external_account:", "        :param User user:", "        \"\"\"", "", "        # Tell the user's addon settings that this node is connecting", "        self.user_settings.grant_oauth_access(", "            node=self.owner,", "            external_account=self.external_account,", "            metadata={'folder': zotero_list_id}", "        )", "        self.user_settings.save()", "", "        # update this instance", "        self.zotero_list_id = zotero_list_id"]}, {"lines": ["        self.save()"]}, {"lines": ["# OAuth app keys", "ZOTERO_CLIENT_ID = None"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from factory import SubFactory, Sequence", "", "from tests.factories import ModularOdmFactory, UserFactory, ProjectFactory, ExternalAccountFactory", "", "import datetime", "", "from dateutil.relativedelta import relativedelta", "", "from website.addons.zotero import model", "", "", "class ZoteroAccountFactory(ExternalAccountFactory):", "    provider = 'zotero'", "    provider_id = Sequence(lambda n: 'id-{0}'.format(n))"]}, {"lines": ["    oauth_key = Sequence(lambda n: 'key-{0}'.format(n))", "    oauth_secret = Sequence(lambda n: 'secret-{0}'.format(n))", "    expires_at = datetime.datetime.now() + relativedelta(days=1)", "", "", "class ZoteroUserSettingsFactory(ModularOdmFactory):"]}, {"lines": ["", "    owner = SubFactory(UserFactory)", "", "", "class ZoteroNodeSettingsFactory(ModularOdmFactory):"]}, {"lines": ["", "    owner = SubFactory(ProjectFactory)"]}, {"lines": ["import unittest", "", "from nose.tools import *", "", "from website.addons.citations.utils import serialize_account", "", "", "class TestSerializeAccount(unittest.TestCase):", "    # TODO: Move to website/addons/citations/tests", "    def test_serialize_account_none(self):"]}, {"lines": ["# -*- coding: utf-8 -*-", "import mock", "from contextlib import contextmanager", "", "from modularodm import storage", "", "from framework.mongo import set_up_storage", "", "from website.addons.base.testing import AddonTestCase", "from website.addons.zotero import MODELS", "", "from json import dumps", "", "def init_storage():", "    set_up_storage(MODELS, storage_class=storage.MongoStorage)", ""]}, {"lines": ["mock_responses = {", "    'folders': [", "        {", "            'data': {", "                \"key\": \"4901a8f5-9840-49bf-8a17-bdb3d5900417\",", "                \"name\": \"subfolder\",", "            },", "        },", "        {", "            'data': {", "                \"key\": \"a6b12ebf-bd07-4f4e-ad73-f9704555f032\",", "                \"name\": \"subfolder2\",", "                \"parentCollection\": \"4901a8f5-9840-49bf-8a17-bdb3d5900417\",", "            },", "        },", "        {", "            'data': {", "                \"key\": \"e843da05-8818-47c2-8c37-41eebfc4fe3f\",", "                \"name\": \"subfolder3\",", "                \"parentCollection\": \"a6b12ebf-bd07-4f4e-ad73-f9704555f032\",", "            },", "        },", "    ],", "    'documents': ["]}, {"lines": ["                },"]}, {"lines": ["                },"]}, {"lines": ["                },"]}, {"lines": ["                },"]}, {"lines": ["                },"]}, {"lines": ["                }"]}, {"lines": ["}", ""]}, {"lines": ["def datetime_to_csl(dt):", "    \"\"\"Given a datetime, return a dict in CSL-JSON date-variable schema\"\"\""]}, {"lines": ["from mako.lookup import Template"]}, {"lines": [""]}, {"lines": ["from website import models as website_models", "from website.notifications import constants"]}, {"lines": ["from website.util import web_url_for"]}, {"lines": ["    node = website_models.Node.load(uid)"]}, {"lines": ["    \"\"\"Dispatch to the handler for the provided notification_type\"\"\"", "", "    if notification_type == 'none':", "        return", "", "    try:"]}, {"lines": ["            uid=uid,", "            event=event,"]}, {"lines": ["        )", "    except KeyError:", "        raise ValueError('Unrecognized notification_type')"]}, {"lines": [""]}, {"lines": ["from framework.auth import signals", "from website.models import Node", "from website.notifications import constants", "from website.notifications import model", ""]}, {"lines": ["    \"\"\"Build the Subscription primary key for the given guid and event\"\"\""]}, {"lines": ["@signals.contributor_removed.connect"]}, {"lines": ["@signals.node_deleted.connect"]}, {"lines": ["    for notification_type in constants.NOTIFICATION_TYPES:"]}, {"lines": ["    for subscription in constants.USER_SUBSCRIPTIONS_AVAILABLE:", "        event = serialize_event(user, subscription, constants.USER_SUBSCRIPTIONS_AVAILABLE, user_subscriptions)"]}, {"lines": ["            for notification_type in constants.NOTIFICATION_TYPES:"]}, {"lines": ["            for notification_type in constants.NOTIFICATION_TYPES:"]}, {"lines": ["# This dict is built through the metaclass applied to ExternalProvider.", "#   It is intentionally empty here, and should remain empty."]}, {"lines": ["PROVIDER_LOOKUP = dict()", "", "", "def get_service(name):", "    \"\"\"Given a service name, return the provider class\"\"\""]}, {"lines": ["import abc"]}, {"lines": ["import logging"]}, {"lines": ["", "from flask import request"]}, {"lines": ["from modularodm import Q"]}, {"lines": ["from requests_oauthlib import OAuth1Session", "from requests_oauthlib import OAuth2Session", ""]}, {"lines": ["from framework.mongo import ObjectId", "from framework.mongo import StoredObject"]}, {"lines": ["from framework.sessions import session"]}, {"lines": ["from website.util import web_url_for"]}, {"lines": ["", "", "logger = logging.getLogger(__name__)", "", "OAUTH1 = 1", "OAUTH2 = 2", "", ""]}, {"lines": ["class ExternalAccount(StoredObject):"]}, {"lines": ["    \"\"\"An account on an external service.", "", "    Note that this object is not and should not be aware of what other objects", "    are associated with it. This is by design, and this object should be kept as", "    thin as possible, containing only those fields that must be stored in the", "    database.", "", "    The ``provider`` field is a de facto foreign key to an ``ExternalProvider``", "    object, as providers are not stored in the database.", "    \"\"\""]}, {"lines": ["    _id = fields.StringField(default=lambda: str(ObjectId()), primary=True)"]}, {"lines": [""]}, {"lines": ["    # The OAuth credentials. One or both of these fields should be populated.", "    # For OAuth1, this is usually the \"oauth_token\"", "    # For OAuth2, this is usually the \"access_token\""]}, {"lines": ["    oauth_key = fields.StringField()"]}, {"lines": ["", "    # For OAuth1, this is usually the \"oauth_token_secret\"", "    # For OAuth2, this is not used"]}, {"lines": ["    oauth_secret = fields.StringField()"]}, {"lines": ["", "    # Used for OAuth2 only"]}, {"lines": ["    refresh_token = fields.StringField()", "    expires_at = fields.DateTimeField()"]}, {"lines": ["    scopes = fields.StringField(list=True, default=lambda: list())", "", "    # The `name` of the service"]}, {"lines": ["    # This lets us query for only accounts on a particular provider"]}, {"lines": ["    provider = fields.StringField(required=True)"]}, {"lines": ["", "    # The unique, persistent ID on the remote service.", "    provider_id = fields.StringField()", ""]}, {"lines": ["    # The user's name on the external service"]}, {"lines": ["    display_name = fields.StringField()"]}, {"lines": ["    # A link to the user's profile on the external service"]}, {"lines": ["    profile_url = fields.StringField()"]}, {"lines": ["", "    def __repr__(self):", "        return '<ExternalAccount: {}/{}>'.format(self.provider,", "                                                 self.provider_id)", "", "", "class ExternalProviderMeta(abc.ABCMeta):"]}, {"lines": ["    \"\"\"Keeps track of subclasses of the ``ExternalProvider`` object\"\"\""]}, {"lines": ["", "    def __init__(cls, name, bases, dct):", "        super(ExternalProviderMeta, cls).__init__(name, bases, dct)", "        if not isinstance(cls.short_name, abc.abstractproperty):", "            PROVIDER_LOOKUP[cls.short_name] = cls", "", "", "class ExternalProvider(object):"]}, {"lines": ["    \"\"\"A connection to an external service (ex: GitHub)."]}, {"lines": [""]}, {"lines": ["    This object contains no credentials, and is not saved in the database.", "    It provides an unauthenticated session with the provider, unless ``account``", "    has been set - in which case, it provides a connection authenticated as the", "    ``ExternalAccount`` instance.", "", "    Conceptually, this can be thought of as an extension of ``ExternalAccount``.", "    It's a separate object because this must be subclassed for each provider,", "    and ``ExternalAccount`` instances are stored within a single collection."]}, {"lines": ["    \"\"\"", "", "    __metaclass__ = ExternalProviderMeta", ""]}, {"lines": ["    # Default to OAuth v2.0."]}, {"lines": ["    _oauth_version = OAUTH2", ""]}, {"lines": ["    def __init__(self):", "        super(ExternalProvider, self).__init__()", ""]}, {"lines": ["        # provide an unauthenticated session by default"]}, {"lines": ["        self.account = None", ""]}, {"lines": ["    def __repr__(self):", "        return '<{name}: {status}>'.format(", "            name=self.__class__.__name__,", "            status=self.account.provider_id if self.account else 'anonymous'", "        )", "", "    @abc.abstractproperty", "    def auth_url_base(self):", "        \"\"\"The base URL to begin the OAuth dance\"\"\""]}, {"lines": ["        pass"]}, {"lines": ["", "    @property", "    def auth_url(self):", "        \"\"\"The URL to begin the OAuth dance.", ""]}, {"lines": ["        This property method has side effects - it at least adds temporary", "        information to the session so that callbacks can be associated with", "        the correct user.  For OAuth1, it calls the provider to obtain", "        temporary credentials to start the flow.", "        \"\"\""]}, {"lines": [""]}, {"lines": ["        # create a dict on the session object if it's not already there", "        if session.data.get(\"oauth_states\") is None:", "            session.data['oauth_states'] = {}", "", "        if self._oauth_version == OAUTH2:", "            # build the URL", "            oauth = OAuth2Session(", "                self.client_id,", "                redirect_uri=web_url_for('oauth_callback',", "                                         service_name=self.short_name,", "                                         _absolute=True),", "                scope=self.default_scopes,", "            )", "", "            url, state = oauth.authorization_url(self.auth_url_base)", ""]}, {"lines": ["            # save state token to the session for confirmation in the callback"]}, {"lines": ["            session.data['oauth_states'][self.short_name] = {'state': state}", "", "        elif self._oauth_version == OAUTH1:", "            # get a request token", "            oauth = OAuth1Session(", "                client_key=self.client_id,", "                client_secret=self.client_secret,", "            )", ""]}, {"lines": ["            # request temporary credentials from the provider"]}, {"lines": ["            response = oauth.fetch_request_token(self.request_token_url)", ""]}, {"lines": ["            # store them in the session for use in the callback"]}, {"lines": ["            session.data['oauth_states'][self.short_name] = {", "                'token': response.get('oauth_token'),", "                'secret': response.get('oauth_token_secret'),", "            }", "", "            url = oauth.authorization_url(self.auth_url_base)", "", "        return url", "", "    @abc.abstractproperty", "    def callback_url(self):", "        \"\"\"The provider URL to exchange the code for a token\"\"\""]}, {"lines": ["        pass"]}, {"lines": ["", "    @abc.abstractproperty", "    def client_id(self):", "        \"\"\"OAuth Client ID. a/k/a: Application ID\"\"\""]}, {"lines": ["        pass"]}, {"lines": ["", "    @abc.abstractproperty", "    def client_secret(self):", "        \"\"\"OAuth Client Secret. a/k/a: Application Secret, Application Key\"\"\""]}, {"lines": ["        pass"]}, {"lines": ["", "    default_scopes = list()", "", "    @abc.abstractproperty", "    def name(self):", "        \"\"\"Human-readable name of the service. e.g.: ORCiD, GitHub\"\"\""]}, {"lines": ["        pass"]}, {"lines": ["", "    @abc.abstractproperty", "    def short_name(self):", "        \"\"\"Name of the service to be used internally. e.g.: orcid, github\"\"\""]}, {"lines": ["        pass"]}, {"lines": ["", "    def auth_callback(self, user):"]}, {"lines": ["        \"\"\"Exchange temporary credentials for permanent credentials", "", "        This is called in the view that handles the user once they are returned", "        to the OSF after authenticating on the external service.", "        \"\"\""]}, {"lines": [""]}, {"lines": ["        # make sure the user has temporary credentials for this provider"]}, {"lines": ["        try:", "            cached_credentials = session.data['oauth_states'][self.short_name]", "        except KeyError:", "            raise PermissionsError(\"OAuth flow not recognized.\")", "", "        if self._oauth_version == OAUTH1:", "            request_token = request.args.get('oauth_token')", ""]}, {"lines": ["            # make sure this is the same user that started the flow"]}, {"lines": ["            if cached_credentials.get('token') != request_token:", "                raise PermissionsError(\"Request token does not match\")", "", "            response = OAuth1Session(", "                client_key=self.client_id,", "                client_secret=self.client_secret,", "                resource_owner_key=cached_credentials.get('token'),", "                resource_owner_secret=cached_credentials.get('secret'),", "                verifier=request.args.get('oauth_verifier'),", "            ).fetch_access_token(self.callback_url)", "", "        elif self._oauth_version == OAUTH2:", "            state = request.args.get('state')", ""]}, {"lines": ["            # make sure this is the same user that started the flow"]}, {"lines": ["            if cached_credentials.get('state') != state:", "                raise PermissionsError(\"Request token does not match\")", ""]}, {"lines": [""]}, {"lines": ["        # pre-set as many values as possible for the ``ExternalAccount``"]}, {"lines": ["        info = self._default_handle_callback(response)"]}, {"lines": ["        # call the hook for subclasses to parse values from the response"]}, {"lines": ["        info.update(self.handle_callback(response))", "", "        try:"]}, {"lines": ["            # create a new ``ExternalAccount`` ..."]}, {"lines": ["            # ... or get the old one"]}, {"lines": ["            self.account = ExternalAccount.find_one(", "                Q('provider', 'eq', self.short_name) &", "                Q('provider_id', 'eq', info['provider_id'])", "            )"]}, {"lines": [""]}, {"lines": ["        # required", "        self.account.oauth_key = info['key']", "", "        # only for OAuth1", "        self.account.oauth_secret = info.get('secret')", "", "        # only for OAuth2", "        self.account.expires_at = info.get('expires_at')", "        self.account.refresh_token = info.get('refresh_token')", "", "        # additional information", "        self.account.display_name = info.get('display_name')"]}, {"lines": ["        self.account.profile_url = info.get('profile_url')"]}, {"lines": ["", "        self.account.save()", ""]}, {"lines": ["        # add it to the user's list of ``ExternalAccounts``"]}, {"lines": ["        if self.account not in user.external_accounts:", "            user.external_accounts.append(self.account)", "            user.save()", "", "    def _default_handle_callback(self, data):"]}, {"lines": ["        \"\"\"Parse as much out of the key exchange's response as possible.", "", "        This should not be over-ridden in subclasses.", "        \"\"\""]}, {"lines": ["        if self._oauth_version == OAUTH1:", "            key = data.get('oauth_token')", "            secret = data.get('oauth_token_secret')", "", "            values = {}", "", "            if key:", "                values['key'] = key", "            if secret:", "                values['secret'] = secret", "", "            return values", "", "        elif self._oauth_version == OAUTH2:", "            key = data.get('access_token')", "            refresh_token = data.get('refresh_token')", "            expires_at = data.get('expires_at')", "            scopes = data.get('scope')", "", "            values = {}", "", "            if key:", "                values['key'] = key", "            if scopes:", "                values['scope'] = scopes", "            if refresh_token:", "                values['refresh_token'] = refresh_token", "            if expires_at:", "                values['expires_at'] = datetime.datetime.fromtimestamp(", "                    float(expires_at)", "                )", "", "            return values", ""]}, {"lines": ["    @abc.abstractmethod"]}, {"lines": ["    def handle_callback(self, response):"]}, {"lines": ["        \"\"\"Hook for allowing subclasses to parse information from the callback.", ""]}, {"lines": ["        Subclasses should implement this method to provide `provider_id`"]}, {"lines": ["        and `profile_url`.", "", "        Values provided by ``self._default_handle_callback`` can be over-ridden", "        here as well, in the unexpected case that they are parsed incorrectly", "        by default.", "", "        :param response: The JSON returned by the provider during the exchange", "        :return dict:", "        \"\"\""]}, {"lines": ["        pass"]}, {"lines": ["        'active': user.is_active,"]}, {"lines": ["        # Add emails", "        ret['emails'] = [", "            {", "                'address': each,", "                'primary': each == user.username,", "                'confirmed': True,", "            } for each in user.emails", "        ] + [", "            {", "                'address': each,", "                'primary': each == user.username,", "                'confirmed': False", "            }", "            for each in user.unconfirmed_emails", "        ]", ""]}, {"lines": ["        'active': user.is_active,"]}, {"lines": ["    user = framework.auth.get_user(email=email)"]}, {"lines": ["from framework.forms.utils import sanitize"]}, {"lines": ["    title = sanitize(title.strip())"]}, {"lines": ["        description = sanitize(description.strip())"]}, {"lines": ["    ('_', ' '),"]}, {"lines": ["        lambda c: User.load(c[0]).is_active,"]}, {"lines": ["        lambda c: c.is_active and c._id not in node.contributors,"]}, {"lines": ["                contributor = get_user(email=email)"]}, {"lines": ["    user = User.load(uid)  # The unregistered user"]}, {"lines": ["    user = get_user(email=email)"]}, {"lines": ["        claimer = get_user(email=email)"]}, {"lines": ["from framework.utils import iso8601format"]}, {"lines": [""]}, {"lines": ["from website.exceptions import NodeStateError"]}, {"lines": ["    must_be_contributor_or_public,"]}, {"lines": ["    must_be_valid_project,", "    must_have_permission,", "    must_not_be_registration,"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_logged_in", "@must_be_valid_project"]}, {"lines": ["        changes=dict(),", "    )"]}, {"lines": ["    return {'url': new_node.url}, http.CREATED, None"]}, {"lines": [""]}, {"lines": ["", "    return {"]}, {"lines": ["    }", ""]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["    try:"]}, {"lines": ["    except NodeStateError as e:", "        raise HTTPError(", "            http.BAD_REQUEST,", "            data={"]}, {"lines": ["                'message_long': 'Could not delete component: ' + e.message", "            },"]}, {"lines": ["", "    message = '{} deleted'.format("]}, {"lines": ["    status.push_status_message(message)"]}, {"lines": ["    else:", "        redirect_url = '/dashboard/'", "", "    return {", "        'url': redirect_url,", "    }", ""]}, {"lines": ["            'description': node.description or '',"]}, {"lines": ["            'date_created': iso8601format(node.date_created),", "            'date_modified': iso8601format(node.logs[-1].date) if node.logs else '',"]}, {"lines": ["            'registered_date': iso8601format(node.registered_date) if node.is_registration else '',"]}, {"lines": ["            'forked_date': iso8601format(node.forked_date) if node.is_fork else '',"]}, {"lines": ["            'fork_count': len(node.forks),"]}, {"lines": ["            'templated_count': len(node.templated_list),"]}, {"lines": ["    return _render_nodes(nodes=node.forks, auth=auth)"]}, {"lines": ["import logging"]}, {"lines": ["from website.project.views.contributor import get_node_contributors_abbrev"]}, {"lines": ["logger = logging.getLogger(__name__)"]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["    user = kwargs['auth'].user", ""]}, {"lines": ["", "    matching_title = ("]}, {"lines": ["        Q('title', 'icontains', term) &  # search term (case insensitive)"]}, {"lines": ["    )", ""]}, {"lines": [""]}, {"lines": ["        public_projects = Node.find(", "            matching_title &", "            Q('is_public', 'eq', True)  # is public"]}, {"lines": ["    results = list(my_projects) + list(public_projects)"]}, {"lines": ["", "    for project in results:", "        authors = get_node_contributors_abbrev(project=project, auth=kwargs['auth'])"]}, {"lines": ["        for author in authors['contributors']:", "            a = User.load(author['user_id'])"]}, {"lines": [""]}, {"lines": ["            'id': project._id,", "            'label': project.title,", "            'value': project.title,", "            'category': 'My Projects' if user in project.contributors else 'Public Projects',"]}, {"lines": ["        })", ""]}, {"lines": [""]}, {"lines": ["    nid = request.args.get('excludeNode')"]}, {"lines": ["from framework.auth import User"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["import os"]}, {"lines": ["", "# User management & registration"]}, {"lines": [""]}, {"lines": ["# External services"]}, {"lines": [""]}, {"lines": ["SUPPORT_EMAIL = 'support@osf.io'"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["# Gravatar options"]}, {"lines": ["        'height', 'href', 'id', 'src', 'style', 'title', 'type', 'width',"]}, {"lines": ["    'documentation',", "    'storage',", "    'bibliography',", "    'other',"]}, {"lines": ["    'citations',"]}, {"lines": ["# TODO: Override in local.py in production"]}, {"lines": ["PIWIK_HOST = None", "PIWIK_ADMIN_TOKEN = None", "PIWIK_SITE_ID = None"]}, {"lines": ["", "SENTRY_DSN = None"]}, {"lines": ["SENTRY_DSN_JS = None"]}, {"lines": ["", "SENTRY_DSN = None"]}, {"lines": ["                        callback: function(accountId) {", "                            if (accountId) {", "                                self.connectExistingAccount.call(self, (accountId));", "                            }", "                        }"]}, {"lines": [""]}, {"lines": ["    var constructor = prototype.hasOwnProperty('constructor') ? prototype.constructor : function() {};"]}, {"lines": [""]}, {"lines": ["    $('#citation-more').on('click', function() {"]}, {"lines": ["        panel.slideToggle(200, function() {"]}, {"lines": ["            }"]}, {"lines": ["        return false;"]}, {"lines": [""]}, {"lines": ["        url: '/api/v1/search/projects/?term=%QUERY&maxResults=20&includePublic=yes&includeContributed=no',"]}, {"lines": ["        url: '/api/v1/search/projects/?term=%QUERY&maxResults=20&includePublic=no&includeContributed=yes',"]}, {"lines": ["    if (", "        $(sliderSelector).length > 0 &&", "        window.contextVars.node", "    ) {"]}, {"lines": [""]}, {"lines": ["        var url = '/api/v1/profile/';", "", "        var request = $osf.putJSON(", "            url,"]}, {"lines": ["        );", "        request.fail(function(xhr, textStatus, error) {"]}, {"lines": ["                url: url,", "                textStatus: textStatus,", "                error: error", "            });", "        });", "    }", "};"]}, {"lines": ["    var request = $.ajax({", "        url:  '/api/v1/dashboard/'", "    });", "    request.done(function(data) {"]}, {"lines": ["            placement : 'dashboard',", "            divID: 'project-grid',", "            filesData: data.data,", "            multiselect : true", "        });", ""]}, {"lines": ["    });", "    request.fail(function(xhr, textStatus, error) {", "        Raven.captureMessage('Failed to populate user dashboard', {", "            url: url,", "            textStatus: textStatus,", "            error: error"]}, {"lines": [""]}, {"lines": ["var bootbox = require('bootbox');"]}, {"lines": ["", "    describe('confirmDangerousAction', () => {", "        var bootboxStub, callbackStub;", "        beforeEach(() => {", "            bootboxStub = new sinon.stub(bootbox, 'dialog');", "            callbackStub = new sinon.spy();", "        });", "        afterEach(() => {", "            bootboxStub.restore();", "        });", "        it('should trigger bootbox', () => {", "            $osf.confirmDangerousAction({callback: callbackStub});", "            assert.calledOnce(bootboxStub);", "        });", "    });"]}, {"lines": ["    % if sentry_dsn_js:", "    <script src=\"/static/vendor/bower_components/raven-js/dist/raven.min.js\"></script>"]}, {"lines": ["        Raven.config('${ sentry_dsn_js }', {}).install();", "    </script>"]}, {"lines": ["    % endif"]}, {"lines": ["% if not user_id:", "<div id=\"footerSlideIn\">", "    <div class=\"container\">", "        <div class=\"row\">"]}, {"lines": ["            </div>", "            <div class='col-sm-10 col-xs-12'>"]}, {"lines": ["                <a data-bind=\"click: dismiss\" class=\"close\" href=\"#\">&times;</a>"]}, {"lines": ["                <h1>Start managing your projects on the OSF today.</h1>"]}, {"lines": ["                <p>Free and easy to use, the Open Science Framework supports the entire research lifecycle: planning, execution, reporting, archiving, and discovery.</p>", "                <div>"]}, {"lines": ["                    <a data-bind=\"click: dismiss\">Hide this message</a>"]}, {"lines": ["                </div>", "            </div>", "        </div>", "    </div>", "</div>", "% endif", ""]}, {"lines": ["", "        % if piwik_host:"]}, {"lines": ["            <script src=\"${ piwik_host }piwik.js\" type=\"text/javascript\"></script>"]}, {"lines": ["            <% is_public = node.get('is_public', 'ERROR') if node else True %>", "            <script type=\"text/javascript\">"]}, {"lines": [""]}, {"lines": ["                $(function() {"]}, {"lines": ["                    var cvars = [];"]}, {"lines": ["                        cvars.push([1, \"User ID\", \"${ user_id }\", \"visit\"])", "                        cvars.push([2, \"User Name\", \"${ user_full_name }\", \"visit\"])"]}, {"lines": ["                        cvars.push([2, \"Project ID\", \"${ parent_project }\", \"page\"]);", "                        cvars.push([3, \"Node ID\", \"${ node.get('id') }\", \"page\"]);"]}, {"lines": ["                });"]}, {"lines": ["            </script>", "        % endif"]}, {"lines": ["    % if settings.USE_CDN_FOR_CLIENT_LIBS:", "        <script src=\"//code.jquery.com/jquery-1.11.2.min.js\"></script>"]}, {"lines": ["        <script src=\"//code.jquery.com/ui/1.10.3/jquery-ui.min.js\"></script>", "        <script>window.jQuery.ui || document.write('<script src=\"/static/vendor/bower_components/jquery-ui/ui/minified/jquery-ui.min.js\">\\x3C/script>')</script>", "    % else:"]}, {"lines": ["        <script src=\"/static/vendor/bower_components/jquery-ui/ui/minified/jquery-ui.min.js\"></script>", "    % endif"]}, {"lines": ["<%def name=\"title()\">${message_short}</%def>"]}, {"lines": ["            <h2 id='error' data-http-status-code=\"${code}\">${message_short}</h2>"]}, {"lines": ["<script type=\"text/html\" id=\"created_from\">"]}, {"lines": ["</script>", ""]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a> as <a class='tag' data-bind=\"attr: {href: '/search/?q=%22' + params.tag + '%22'}, text: params.tag\"></a>"]}, {"lines": ["removed tag <a class='tag' data-bind=\"attr: {href: '/search/?q=%22' + params.tag + '%22'}, text: params.tag\"></a>"]}, {"lines": ["    No public nodes tagged as <span class='tag'>${tag}</span>"]}, {"lines": ["Please confirm your email address by visiting this link:"]}, {"lines": ["${confirmation_url}"]}, {"lines": ["From the Open Science Framework Robot"]}, {"lines": ["            <span>${node['title']} Discussion</span>"]}, {"lines": ["", "        <div data-bind=\"template: {name: 'commentTemplate', foreach: comments}\"></div>", ""]}, {"lines": ["            <!-- ko if: showChildren -->", "                <!-- ko template: {name:  'commentTemplate', foreach: comments} -->", "                <!-- /ko -->", "            <!-- /ko -->", ""]}, {"lines": ["    <div id=\"accountSettings\">"]}, {"lines": ["        <h2 class=\"page-header\">Account Settings</h2>", "        <div class=\"row\">", "            <div class=\"col-md-3\">", "                <div class=\"panel panel-default\">", "                    <ul class=\"nav nav-stacked nav-pills\">", "                        <li><a href=\"${ web_url_for('user_profile') }\">Profile Information</a></li>", "                        <li><a href=\"#\">Account Settings</a></li>", "                        <li><a href=\"${ web_url_for('user_addons') }\">Configure Add-ons</a></li>", "                        <li><a href=\"${ web_url_for('user_notifications') }\">Notifications</a></li>", "                    </ul>", "                </div>"]}, {"lines": ["            <div class=\"col-md-6\">"]}, {"lines": ["                <div id=\"connectedEmails\" class=\"panel panel-default scripted\">"]}, {"lines": ["                    <div class=\"panel-heading\"><h3 class=\"panel-title\">Connected Emails</h3></div>", "                    <div class=\"panel-body\">"]}, {"lines": ["                        <table class=\"table\">", "                            <thead>", "                                <tr>", "                                    <th colspan=\"2\">Primary Email</th>", "                                </tr>", "                            </thead>", "                            <tbody>", "                                <tr>"]}, {"lines": ["                                    <td>{{ profile().primaryEmail().address }}</td>"]}, {"lines": ["                                    <td></td>", "                                </tr>", "                            </tbody>", "                        </table>", "", "                        <table class=\"table\">", "                            <thead>", "                                <tr>", "                                    <th colspan=\"3\">Alternate Emails</th>", "                                </tr>", "                            </thead>"]}, {"lines": ["                            <tbody data-bind=\"foreach: profile().alternateEmails()\">"]}, {"lines": ["                                <tr>", "                                    <td style=\"width:100%\">{{ $data.address }}</td>", "                                    <td><a data-bind=\"click: $parent.makeEmailPrimary\">make&nbsp;primary</a></td>", "                                    <td><a data-bind=\"click: $parent.removeEmail\"><i class=\"fa fa-times text-danger\"></i></a></td>", "                                </tr>", "                            </tbody>", "                        </table>", "", "                        <table class=\"table\">", "                            <thead>", "                                <tr>", "                                    <th colspan=\"2\">Unconfirmed Emails</th>", "                                </tr>", "                            </thead>", "                            <tbody>"]}, {"lines": ["                                <!-- ko foreach: profile().unconfirmedEmails() -->"]}, {"lines": ["                                <tr>", "                                    <td style=\"width:100%\">{{ $data.address }}</td>"]}, {"lines": ["                                    <td><a data-bind=\"click: $parent.removeEmail\"><i class=\"fa fa-times text-danger\"></i></a></td>", "                                </tr>"]}, {"lines": ["                                <!-- /ko -->"]}, {"lines": ["                                <tr>", "                                    <td colspan=\"2\">", "                                        <form data-bind=\"submit: addEmail\">", "                                            <div class=\"form-group\">"]}, {"lines": ["                                            </div>"]}, {"lines": ["                                        </form>"]}, {"lines": ["                                    </td>"]}, {"lines": ["                                </tr>", "                            </tbody>", "                        </table>"]}, {"lines": ["                    </div>", "                </div>", "                <div id=\"changePassword\" class=\"panel panel-default\">", "                    <div class=\"panel-heading\"><h3 class=\"panel-title\">Change Password</h3></div>", "                    <div class=\"panel-body\">", "                        <form id=\"changePasswordForm\" role=\"form\" action=\"${ web_url_for('user_account_password') }\" method=\"post\">", "                            <div class=\"form-group\">"]}, {"lines": ["                                <label for=\"old_password\">Old password</label>"]}, {"lines": ["                                <input type=\"password\" class=\"form-control\" name=\"old_password\">", "                            </div>", "                            <div class=\"form-group\">"]}, {"lines": ["                                <label for=\"new_password\">New password</label>"]}, {"lines": ["                                <input type=\"password\" class=\"form-control\" name=\"new_password\">", "                            </div>", "                            <div class=\"form-group\">"]}, {"lines": ["                                <label for=\"confirm_password\">Confirm new password</label>"]}, {"lines": ["                                <input type=\"password\" class=\"form-control\" name=\"confirm_password\">", "                            </div>", "                            <button type=\"submit\" class=\"btn btn-default\">Update password</button>", "                        </form>", "                    </div>"]}, {"lines": ["                <div id=\"exportAccount\" class=\"panel panel-default\">", "                    <div class=\"panel-heading\"><h3 class=\"panel-title\">Export Account Data</h3></div>", "                    <div class=\"panel-body\">", "                        <p>Exporting your account data allows you to keep a permanent copy of the current state of your account. Keeping a copy of your account data can provide peace of mind or assist in transferring your information to another provider.</p>"]}, {"lines": ["                        <a class=\"btn btn-default\" data-bind=\"click: submit, css: success() === true ? 'disabled' : ''\">Request Export</a>"]}, {"lines": ["                    </div>", "                </div>", "                <div id=\"deactivateAccount\" class=\"panel panel-default\">", "                    <div class=\"panel-heading\"><h3 class=\"panel-title\">Deactivate Account</h3></div>", "                    <div class=\"panel-body\">", "                        <p class=\"alert alert-warning\"><strong>Warning:</strong> This action is irreversible.</p>", "                        <p>Deactivating your account will remove you from all public projects to which you are a contributor. Your account will no longer be associated with OSF projects, and your work on the OSF will be inaccessible.</p>"]}, {"lines": ["                        <a class=\"btn btn-danger\" data-bind=\"click: submit, css: success() === true ? 'disabled' : ''\">Request Deactivation</a>"]}, {"lines": ["                    </div>", "                </div>"]}, {"lines": ["    <script src=${\"/static/public/js/profile-account-settings-page.js\" | webpack_asset}></script>"]}, {"lines": ["    <script src=\"${\"/static/public/js/profile-settings-addons-page.js\" | webpack_asset}\"></script>"]}, {"lines": ["<div class=\"modal fade\" id=\"changeAvatarModal\">", "    <div class=\"modal-dialog modal-lg\">", "        <div class=\"modal-content\">", "            <div class=\"modal-header\">", "                <h3>Change Avatar</h3>", "            </div>", "            <div class=\"modal-body\">", "                <p>Avatars on the OSF use", "                    <a href=\"http://gravatar.org/\">gravatar.org</a>, a free", "                    service that allows users to easily control their identity", "                    and profile on multiple service across the Internet.", "                </p>", "                <p>To change your avatar image, please login or register at", "                   <a href=\"http://gravatar.org/\">gravatar.org</a>, and add the"]}, {"lines": ["                   email address you use on the OSF to your Gravatar account."]}, {"lines": ["                </p>", "            </div>", "            <div class=\"modal-footer\">", "                <button type=\"button\" class=\"btn btn-primary\" data-dismiss=\"modal\">OK</button>", "            </div>", "        </div><!-- /.modal-content -->", "    </div><!-- /.modal-dialog -->", "</div><!-- /.modal -->"]}, {"lines": ["        <div class=\"modal-content\">"]}, {"lines": ["                                <div class=\"input-group\">", "                                    <input class='form-control'"]}, {"lines": ["                                    <span class=\"input-group-btn\">"]}, {"lines": ["                                    </span>"]}, {"lines": ["                            <!-- ko if: notification -->"]}, {"lines": ["                            <!-- /ko -->"]}, {"lines": ["<div class=\"modal fade\" id=\"duplicateModal\">", "    <div class=\"modal-dialog modal-lg\">", "        <div class=\"modal-content\">"]}, {"lines": ["            <div class=\"modal-body\">", "                <div class=\"row\">", "                    <div class=\"col-md-4\">", "                        <h4>Links"]}, {"lines": ["                        </h4>", "                        ${ language.LINK_DESCRIPTION }", "                    </div>", "                    <div class=\"col-md-4\">", "                        <h4>Templated From", "                            <span class=\"well well-inline pull-right\">", "                                ${ node['templated_count'] }", "                            </span>", "                        </h4>", "                        ${ language.TEMPLATE_DESCRIPTION }", "                    </div>", "                    <div class=\"col-md-4\">", "                        <h4>Forks", "                            <a class=\"btn btn-primary pull-right\"", "                               href=\"${ node['url'] }forks/\"", "                            >", "                                ${ node['fork_count'] }", "                            </a>", "                        </h4>"]}, {"lines": ["                    </div>"]}, {"lines": ["                </div>"]}, {"lines": ["                <div class=\"row\">", "                    <div class=\"col-md-4\">", "##                        <a class=\"btn btn-primary form-control disabled\">${ language.LINK_ACTION }</a>", "                    </div>", "                    <div class=\"col-md-4\">", "                        <a class=\"btn btn-primary form-control${'' if user_name and (user['is_contributor'] or node['is_public']) else ' disabled'}\"", "                           data-dismiss=\"modal\"", "                           onclick=\"NodeActions.useAsTemplate();\"", "                        >", "                            ${ language.TEMPLATE_ACTION }", "                        </a>", "                    </div>"]}, {"lines": ["                    <div class=\"col-md-4\">"]}, {"lines": ["                    </div>"]}, {"lines": ["                </div>", "            </div>", "            <div class=\"modal-footer\">", "                <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Cancel</button>", "            </div>", "        </div><!-- /.modal-content -->", "    </div><!-- /.modal-dialog -->"]}, {"lines": ["        ${sanitize.strip_html(node['description']) + ' | '}"]}, {"lines": ["<!-- Authorization -->"]}, {"lines": ["<div class=\"addon-oauth\"", "     data-addon-short-name=\"${ addon_short_name }\"", "     data-addon-name=\"${ addon_full_name }\">"]}, {"lines": ["    <a data-bind=\"click: connectAccount\" class=\"pull-right text-primary\">Connect an account</a>"]}, {"lines": ["    <h4 class=\"addon-title\">{{ properName }}</h4>"]}, {"lines": ["    <!-- ko foreach: accounts -->", "", "", "    <table class=\"table\">", "        <thead>", "            <tr>"]}, {"lines": ["                <th>Authorized as <a href=\"{{ profileUrl }}\"><em>{{ name }}</em></a></th>", "                <th><a data-bind=\"click: $root.askDisconnect\" class=\"text-danger\">Delete Access Token</a></th>"]}, {"lines": ["            </tr>", "        </thead>"]}, {"lines": ["        <!-- ko if: connectedNodes().length > 0 -->"]}, {"lines": ["        <tbody data-bind=\"foreach: connectedNodes()\">", "            <tr>", "                <td class=\"authorized-nodes\">", "                    <!-- ko if: title --><a href=\"{{ urls.view }}\">{{ title }}</a><!-- /ko -->"]}, {"lines": ["                </td>", "                <td>", "                    <a data-bind=\"click: $parent.deauthorizeNode\">"]}, {"lines": ["                    </a>", "                </td>", "            </tr>", "        </tbody>"]}, {"lines": ["        <!-- /ko -->"]}, {"lines": ["    </table>", "    <!-- /ko -->"]}, {"lines": ["<%inherit file=\"/base.mako\"/>", "", "<%def name=\"title()\">${title_text}</%def>", "", "<%def name=\"content()\">", "    <div class=\"row\">", "        <div class=\"col-sm-7\">", "            <%include file=\"${content_template_path}\"/>", "        </div>", "        <div class=\"col-sm-5\">", "            <h2>Sign-In</h2>", "            <div mod-meta='{", "                \"tpl\": \"util/render_form.mako\",", "                \"uri\": \"/api/v1/forms/signin/\",", "                \"kwargs\": {", "                    \"id\": \"signinForm\",", "                    \"name\": \"signin\",", "                    \"method_string\": \"POST\","]}, {"lines": ["                    \"form_class\": \"form-stacked\",", "                    \"submit_string\": \"Sign In\",", "                    \"submit_btn_class\": \"btn-primary\","]}, {"lines": ["                },", "                \"replace\": true", "            }'></div>", "            <hr />", "            <h3>Forgot Password</h3>", "            <div mod-meta='{", "                \"tpl\": \"util/render_form.mako\",", "                \"uri\": \"/api/v1/forms/forgot_password/\",", "                \"kwargs\": {", "                    \"id\": \"forgotPassword\",", "                    \"name\": \"forgotpassword\",", "                    \"method_string\": \"POST\",", "                    \"action_string\": \"/forgotpassword/\",", "                    \"form_class\": \"form-stacked\",", "                    \"submit_string\": \"Reset Password\",", "                    \"submit_btn_class\": \"btn-default\"", "                },", "                \"replace\": true", "            }'></div>", "        </div>", "    </div>", "    <div class=\"modal fade\" id=\"twoFactor\">", "        <div class=\"modal-dialog\">", "            <div class=\"modal-content\">", "                <div class=\"modal-header\">", "                    <h4 style=\"margin-bottom:0\">Two-factor Authentication</h4>", "                </div>", "                <div class=\"modal-body\">", "                    <p>Two-factor authentication helps protect your OSF account by requiring both a password and a code generated on your mobile phone to log in. This addon may be enabled on your account's <a href=\"${ web_url_for('user_addons') }\">addon settings</a>.</p>", "                    <p>If you have enabled two-factor authentication on your account, enter the current verification code from your device in this field.</p>", "                </div>", "                <div class=\"modal-footer\">", "", "                    <a href=\"#\" class=\"btn btn-default\" data-dismiss=\"modal\">OK</a>", "                </div>", "            </div>", "        </div>", "    </div>", "    <script>", "        $(function() {", "            $('#twoFactorHelpText').wrap('<a data-toggle=\"modal\" href=\"#twoFactor\">');", "        });", "    </script>", "    <script type=\"text/javascript\" src=\"/static/vendor/youtube/youtube-loader.js\"></script>", "</%def>", ""]}, {"lines": ["    maintained and developed by the Center for Open Science (COS), a non-profit"]}, {"lines": ["<h3>How will the OSF be useful to my research?</h3><p>The OSF integrates with", "    the scientist's daily workflow. OSF helps document and archive study"]}, {"lines": ["    individual contributions for all aspects of the research process. To see how"]}, {"lines": ["<h3>How can I use the OSF?</h3><p>OSF membership is open and free, so you can", "    just register and get started!</p>"]}, {"lines": ["<h3>What if I don't want to make anything available publicly in the OSF?</h3><p>", "    The OSF is designed to support both private and public workflows. You can", "    keep projects, or individual components of projects, private so that only"]}, {"lines": ["", "<h3>What is a registration?</h3><p>A registration certifies what was done in"]}, {"lines": ["    onset of data collection.</p>", ""]}, {"lines": ["<h3>What if I don't want to register anything in the OSF?</h3><p>Registering is", "    an optional feature of the OSF.</p>", ""]}, {"lines": ["    the OSF. When you sign up and create a password, your password is not", "    recorded. Instead, we store a <a href=\"http://bcrypt.sourceforge.net/\">bcrypt", "        hash</a> of your password. This is a computation on your password that", "    cannot be reversed, but is the same every time it is computed from your", "    password. This provides extra security. No one but you can know your"]}, {"lines": [""]}, {"lines": ["    them before uploading to the site. This means that if our servers were", "    compromised, the intruder would have access to raw data. While we have taken", "    technological measures to minimize this risk, the level of security can be", "    improved further. We will offer encryption soon, and we will partner with", "    data storage services that offer strong security features.</p>", ""]}, {"lines": ["<p>The OSF infrastructure will be open-sourced to encourage a community of", "    developers to contribute to open science by adding features and improving"]}, {"lines": ["        Group</a>, find us on <a", "            href=\"https://twitter.com/osframework\">Twitter</a> and on <a", "            href=\"https://www.facebook.com/OpenScienceFramework\">Facebook</a>,", "    or follow the COS <a", "            href=\"https://github.com/centerforopenscience\">GitHub</a> page.</p>", "<h3>How can I help develop the OSF?</h3><p>If you are a developer, email the <a"]}, {"lines": ["    more information. If you want to comment on how to make the OSF more useful", "    for managing your workflow, send comments <a"]}, {"lines": ["    <li data-pk=\"${contributor['id']}\""]}, {"lines": ["def strip_html(unclean):", "    \"\"\"Sanitize a string, removing (as opposed to escaping) HTML tags", "", "    :param unclean: A string to be stripped of HTML tags", "", "    :return: stripped string", "    :rtype: str", "    \"\"\"", "    return bleach.clean(unclean, strip=True, tags=[], attributes=[], styles=[])"]}, {"lines": ["    \"\"\"Format as a valid Tag", "", "    :param data: A string to be cleaned", "", "    :return: cleaned string", "    :rtype: str", "    \"\"\"", "    #TODO: make this a method of Tag?", "    return escape_html(data).replace('\"', '&quot;').replace(\"'\", '')", ""]}, {"lines": ["def escape_html(data):", "    \"\"\"Escape HTML characters in data."]}, {"lines": ["    :param data: A string, dict, or list to clean of HTML characters", "", "    :return: A cleaned object", "    :rtype: str or list or dict", "    \"\"\""]}, {"lines": ["            key: escape_html(value)"]}, {"lines": ["            escape_html(value)"]}, {"lines": ["        return bleach.clean(data)"]}, {"lines": ["def assert_clean(data):", "    \"\"\"Ensure that data is cleaned"]}, {"lines": ["    :raise: AssertionError", "    \"\"\"", "    def _ensure_clean(value):", "        if value != bleach.clean(value):", "            raise ValueError"]}, {"lines": ["    return escape_html(data)"]}], "name": "Lyndsy Simon"}, {"commits": [{"lines": ["    'view-file-tree-page': staticPath('js/pages/view-file-tree-page.js'),"]}, {"lines": ["    'notifications-config-page': staticPath('js/pages/notifications-config-page.js'),"]}, {"lines": ["from django.conf.urls import include, url, patterns"]}, {"lines": ["        elif userid is None and password is None:"]}, {"lines": ["    'rest_framework_swagger',"]}, {"lines": ["        'api.base.renderers.JSONAPIRenderer',"]}, {"lines": ["TEMPLATES = [", "    {", "        'BACKEND': 'django.template.backends.django.DjangoTemplates',", "        'DIRS': [os.path.join(BASE_DIR, 'templates')],", "        'APP_DIRS': True", "    }]", "", ""]}, {"lines": ["STATIC_ROOT = os.path.join(BASE_DIR, 'static/vendor')"]}, {"lines": ["STATICFILES_DIRS = ("]}, {"lines": ["    ('rest_framework_swagger/css', os.path.join(BASE_DIR, 'static/css')),", "    ('rest_framework_swagger/images', os.path.join(BASE_DIR, 'static/images')),"]}, {"lines": [")", "", "SWAGGER_SETTINGS = {"]}, {"lines": ["    'info': {", "        'description':"]}, {"lines": ["        \"\"\""]}, {"lines": ["        <p>Each endpoint will have its own documentation, but there are some general things that should work pretty much everywhere.</p>"]}, {"lines": ["        <p>Collections can be filtered by adding a query parameter in the form:</p>", "        <pre>filter[&lt;fieldname&gt;]=&lt;matching information&gt;</pre>", "        <p>For example, if you were trying to find <a href=\"http://en.wikipedia.org/wiki/Lise_Meitner\">Lise Metiner</a>:</p>", "        <pre>/users?filter[fullname]=meitn</pre>", "        <p>You can filter on multiple fields, or the same field in different ways, by &-ing the query parameters together.</p>", "        <pre>/users?filter[fullname]=lise&filter[family_name]=mei</pre>"]}, {"lines": ["        <p>Responses will generally have associated links. These are helpers to keep you from having to construct", "        URLs in your code or by hand. If you know the route to a high-level resource, then feel free to just go to that", "        route. For example, going to:</p>", "        <pre>/nodes/&lt;node_id&gt;</pre>", "        <p>is a perfectly good route to create rather than going to /nodes/ and navigating from there by filtering by id", "        (which would be ridiculous). However, if you are creating something that crawls the structure of a node", "        going to child node or gathering children, contributors, and similar related resources, then grab the link from", "        the object you\\'re crawling rather than constructing the link yourself.", "        In general, links include:</p>", "        <ol>", "        <li>1. \"Related\" links, which will give you detail information on individual items or a collection of related resources;</li>", "        <li>2. \"Self\" links, which is what you use for general REST operations (POST, DELETE, and so on);</li>", "        <li>3. Pagination links such as \"next\", \"prev\", \"first\", and \"last\". These are great for navigating long lists of information.</li></ol>", "        <p>Some routes may have extra rules for links, especially if those links work with external services. Collections", "        may have counts with them to indicate how many items are in that collection.</p>\"\"\",", "        'title': 'OSF API Documentation',"]}, {"lines": ["from modularodm import Q", "from modularodm.exceptions import NoResultsFound", "", "from framework.guid.model import BlacklistGuid", "from tests.base import OsfTestCase", "from scripts.add_blacklist_guids import create_blacklist_guid_objects", "", "", "class TestBlacklistGuids(OsfTestCase):", "", "    def test_create_whitelist_db_items(self):", "        clean_list = ['bad']", "        create_blacklist_guid_objects(clean_list)", "        try:", "            guid = BlacklistGuid.find_one(Q('_id', 'eq', 'bad'))", "        except NoResultsFound:", "            assert False"]}, {"lines": ["from website.util import api_url_for, rubeus"]}, {"lines": ["        ret.update(rubeus.collect_addon_assets(self.project))"]}, {"lines": ["import mock"]}, {"lines": ["from website import mailchimp_utils"]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["from tests.factories import UserFactory"]}, {"lines": ["import mailchimp"]}, {"lines": [""]}, {"lines": ["", "class TestMailChimpHelpers(OsfTestCase):", ""]}, {"lines": ["    @mock.patch('website.mailchimp_utils.get_mailchimp_api')"]}, {"lines": ["    def test_get_list_id_from_name(self, mock_get_mailchimp_api):", "        list_name = 'foo'", "        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': 1, 'list_name': list_name}]}"]}, {"lines": ["        list_id = mailchimp_utils.get_list_id_from_name(list_name)"]}, {"lines": ["        mock_client.lists.list.assert_called_with(filters={'list_name': list_name})", "        assert_equal(list_id, 1)", ""]}, {"lines": ["    @mock.patch('website.mailchimp_utils.get_mailchimp_api')"]}, {"lines": ["    def test_get_list_name_from_id(self, mock_get_mailchimp_api):", "        list_id = '12345'", "        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': list_id, 'name': 'foo'}]}"]}, {"lines": ["        list_name = mailchimp_utils.get_list_name_from_id(list_id)"]}, {"lines": ["        mock_client.lists.list.assert_called_with(filters={'list_id': list_id})", "        assert_equal(list_name, 'foo')", ""]}, {"lines": ["    @mock.patch('website.mailchimp_utils.get_mailchimp_api')"]}, {"lines": ["    def test_subscribe_called_with_correct_arguments(self, mock_get_mailchimp_api):", "        list_name = 'foo'"]}, {"lines": ["        user = UserFactory()"]}, {"lines": ["        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': 1, 'list_name': list_name}]}"]}, {"lines": ["        list_id = mailchimp_utils.get_list_id_from_name(list_name)"]}, {"lines": ["        mailchimp_utils.subscribe_mailchimp(list_name, user._id)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.mailchimp_utils.get_mailchimp_api')"]}, {"lines": ["    def test_subscribe_fake_email_does_not_throw_validation_error(self, mock_get_mailchimp_api):", "        list_name = 'foo'", "        user = UserFactory(username='fake@fake.com')", "        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': 1, 'list_name': list_name}]}", "        mock_client.lists.subscribe.side_effect = mailchimp.ValidationError"]}, {"lines": ["        mailchimp_utils.subscribe_mailchimp(list_name, user._id)"]}, {"lines": ["        assert_false(user.mailing_lists[list_name])"]}, {"lines": ["", "    @mock.patch('website.mailchimp_utils.get_mailchimp_api')"]}, {"lines": ["    def test_unsubscribe_called_with_correct_arguments(self, mock_get_mailchimp_api):", "        list_name = 'foo'"]}, {"lines": ["        user = UserFactory()"]}, {"lines": ["        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client"]}, {"lines": ["        mock_client.lists.list.return_value = {'data': [{'id': 2, 'list_name': list_name}]}"]}, {"lines": ["        list_id = mailchimp_utils.get_list_id_from_name(list_name)"]}, {"lines": ["        mailchimp_utils.unsubscribe_mailchimp(list_name, user._id)"]}, {"lines": ["import collections"]}, {"lines": ["import pytz"]}, {"lines": ["from babel import dates, Locale"]}, {"lines": ["from mako.lookup import Template"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["from website import mails"]}, {"lines": ["", ""]}, {"lines": ["class TestSubscriptionView(OsfTestCase):"]}, {"lines": ["    def test_create_new_subscription(self):"]}, {"lines": ["        payload = {"]}, {"lines": ["            'event': 'comments',", "            'notification_type': 'email_transactional'", "        }"]}, {"lines": ["        url = api_url_for('configure_subscription')"]}, {"lines": [""]}, {"lines": ["        # check that subscription was created"]}, {"lines": [""]}, {"lines": ["        # check that user was added to notification_type field"]}, {"lines": ["        assert_equal(payload['event'], s.event_name)"]}, {"lines": ["", "        # change subscription", "        new_payload = {"]}, {"lines": ["            'event': 'comments',", "            'notification_type': 'email_digest'", "        }"]}, {"lines": ["        url = api_url_for('configure_subscription')"]}, {"lines": ["        s.reload()"]}, {"lines": ["", "    def test_adopt_parent_subscription_default(self):"]}, {"lines": ["        payload = {"]}, {"lines": ["            'event': 'comments',", "            'notification_type': 'adopt_parent'", "        }"]}, {"lines": ["        url = api_url_for('configure_subscription')"]}, {"lines": ["        # confirm subscription was not created", "        with assert_raises(NoResultsFound):"]}, {"lines": ["", "    def test_change_subscription_to_adopt_parent_subscription_removes_user(self):"]}, {"lines": ["        payload = {"]}, {"lines": ["            'event': 'comments',", "            'notification_type': 'email_transactional'", "        }"]}, {"lines": ["        url = api_url_for('configure_subscription')"]}, {"lines": [""]}, {"lines": ["        # check that subscription was created"]}, {"lines": ["", "        # change subscription to adopt_parent", "        new_payload = {"]}, {"lines": ["            'event': 'comments',", "            'notification_type': 'adopt_parent'", "        }"]}, {"lines": ["        url = api_url_for('configure_subscription')"]}, {"lines": ["        s.reload()", "", "        # assert that user is removed from the subscription entirely"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestRemoveContributor(OsfTestCase):", "    def setUp(self):", "        super(OsfTestCase, self).setUp()"]}, {"lines": ["        self.project.add_contributor(contributor=self.contributor, permissions=['read'])"]}, {"lines": ["        self.project.save()", ""]}, {"lines": ["            _id=self.project._id + '_comments',"]}, {"lines": ["        )", "        self.subscription.save()", "        self.subscription.email_transactional.append(self.contributor)"]}, {"lines": ["        self.subscription.email_transactional.append(self.project.creator)"]}, {"lines": ["        self.subscription.save()", ""]}, {"lines": ["        self.node.add_contributor(contributor=self.project.creator, permissions=['read', 'write', 'admin'])", "        self.node.save()"]}, {"lines": ["            _id=self.node._id + '_comments',"]}, {"lines": ["        )", "        self.node_subscription.save()", "        self.node_subscription.email_transactional.append(self.project.creator)", "        self.node_subscription.email_transactional.append(self.node.creator)", "        self.node_subscription.save()", "", "    def test_removed_non_admin_contributor_is_removed_from_subscriptions(self):"]}, {"lines": ["        assert_in(self.contributor, self.subscription.email_transactional)"]}, {"lines": ["        self.project.remove_contributor(self.contributor, auth=Auth(self.project.creator))", "        assert_not_in(self.contributor, self.project.contributors)"]}, {"lines": ["        assert_not_in(self.contributor, self.subscription.email_transactional)", ""]}, {"lines": ["    def test_removed_non_parent_admin_contributor_is_removed_from_subscriptions(self):", "        assert_in(self.node.creator, self.node_subscription.email_transactional)", "        self.node.remove_contributor(self.node.creator, auth=Auth(self.node.creator))", "        assert_not_in(self.node.creator, self.node.contributors)", "        assert_not_in(self.node.creator, self.node_subscription.email_transactional)", "", "    def test_removed_contributor_admin_on_parent_not_removed_from_node_subscription(self):"]}, {"lines": ["        assert_in(self.project.creator, self.node_subscription.email_transactional)", "        self.node.remove_contributor(self.project.creator, auth=Auth(self.project.creator))", "        assert_not_in(self.project.creator, self.node.contributors)", "        assert_in(self.project.creator, self.node_subscription.email_transactional)", ""]}, {"lines": ["    def test_remove_contributor_signal_called_when_contributor_is_removed(self):", "        with capture_signals() as mock_signals:"]}, {"lines": ["            self.project.remove_contributor(self.contributor, auth=Auth(self.project.creator))"]}, {"lines": ["        assert_equal(mock_signals.signals_sent(), set([contributor_removed]))", "", ""]}, {"lines": ["class TestRemoveNodeSignal(OsfTestCase):", "        def test_node_subscriptions_and_backrefs_removed_when_node_is_deleted(self):"]}, {"lines": ["                _id=project._id + '_comments',"]}, {"lines": ["            )", "            subscription.save()", "            subscription.email_transactional.append(project.creator)", "            subscription.save()", "", "            s = getattr(project.creator, 'email_transactional', [])", "            assert_equal(len(s), 1)", "", "            with capture_signals() as mock_signals:", "                project.remove_node(auth=Auth(project.creator))", "            assert_true(project.is_deleted)", "            assert_equal(mock_signals.signals_sent(), set([node_deleted]))", "", "            s = getattr(project.creator, 'email_transactional', [])", "            assert_equal(len(s), 0)", "", "            with assert_raises(NoResultsFound):"]}, {"lines": ["", ""]}, {"lines": ["class TestNotificationUtils(OsfTestCase):"]}, {"lines": ["    def setUp(self):", "        super(TestNotificationUtils, self).setUp()"]}, {"lines": ["            _id=self.project._id + '_' + 'comments',"]}, {"lines": ["            event_name='comments'", "        )", "        self.project_subscription.save()", "        self.project_subscription.email_transactional.append(self.user)", "        self.project_subscription.save()", ""]}, {"lines": ["            _id=self.node._id + '_' + 'comments',"]}, {"lines": ["            event_name='comments'", "        )", "        self.node_subscription.save()", "        self.node_subscription.email_transactional.append(self.user)", "        self.node_subscription.save()", ""]}, {"lines": ["            _id=self.user._id + '_' + 'comment_replies',"]}, {"lines": ["            event_name='comment_replies'"]}, {"lines": ["        )"]}, {"lines": ["        self.user_subscription.save()", "        self.user_subscription.email_transactional.append(self.user)", "        self.user_subscription.save()"]}, {"lines": [""]}, {"lines": ["    def test_to_subscription_key(self):", "        key = utils.to_subscription_key('xyz', 'comments')", "        assert_equal(key, 'xyz_comments')", "", "    def test_from_subscription_key(self):", "        parsed_key = utils.from_subscription_key('xyz_comment_replies')", "        assert_equal(parsed_key, {", "            'uid': 'xyz',", "            'event': 'comment_replies'", "        })", ""]}, {"lines": ["    def test_get_all_user_subscriptions(self):"]}, {"lines": ["        user_subscriptions = utils.get_all_user_subscriptions(self.user)"]}, {"lines": ["        assert_in(self.project_subscription, user_subscriptions)", "        assert_in(self.node_subscription, user_subscriptions)", "        assert_in(self.user_subscription, user_subscriptions)"]}, {"lines": ["        assert_equal(len(utils.get_all_user_subscriptions(self.user)), 3)"]}, {"lines": [""]}, {"lines": ["    def test_get_all_node_subscriptions_given_user_subscriptions(self):", "        user_subscriptions = utils.get_all_user_subscriptions(self.user)", "        node_subscriptions = utils.get_all_node_subscriptions(self.user, self.node, user_subscriptions=user_subscriptions)", "        assert_equal(node_subscriptions, [self.node_subscription])", "", "    def test_get_all_node_subscriptions_given_user_and_node(self):", "        node_subscriptions = utils.get_all_node_subscriptions(self.user, self.node)", "        assert_equal(node_subscriptions, [self.node_subscription])", ""]}, {"lines": ["    def test_get_configured_project_ids_does_not_return_user_or_node_ids(self):"]}, {"lines": ["", "    def test_get_configured_project_ids_excludes_deleted_projects(self):"]}, {"lines": ["            _id=project._id + '_' + 'comments',"]}, {"lines": ["        )"]}, {"lines": ["        subscription.save()"]}, {"lines": ["        subscription.email_transactional.append(self.user)"]}, {"lines": ["        subscription.save()", "        project.is_deleted = True", "        project.save()"]}, {"lines": ["        assert_not_in(project._id, utils.get_configured_projects(self.user))", "", "    def test_get_configured_project_ids_excludes_node_with_project_category(self):"]}, {"lines": ["            _id=node._id + '_' + 'comments',"]}, {"lines": ["            event_name='comments'", "        )", "        node_subscription.save()", "        node_subscription.email_transactional.append(self.user)", "        node_subscription.save()", "        assert_not_in(node._id, utils.get_configured_projects(self.user))"]}, {"lines": [""]}, {"lines": ["    def test_get_configured_project_ids_includes_top_level_private_projects_if_subscriptions_on_node(self):"]}, {"lines": ["            _id=node._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        node_subscription.email_transactional.append(node.creator)", "        node_subscription.save()", "        configured_project_ids = utils.get_configured_projects(node.creator)", "        assert_in(private_project._id, configured_project_ids)", "", "    def test_get_configured_project_ids_excludes_private_projects_if_no_subscriptions_on_node(self):"]}, {"lines": ["        configured_project_ids = utils.get_configured_projects(node.creator)", "        assert_not_in(private_project._id, configured_project_ids)", ""]}, {"lines": ["    def test_get_parent_notification_type(self):"]}, {"lines": ["        nt = utils.get_parent_notification_type(self.node._id, 'comments', self.user)"]}, {"lines": ["        assert_equal(nt, 'email_transactional')", "", "    def test_get_parent_notification_type_no_parent_subscriptions(self):"]}, {"lines": ["        nt = utils.get_parent_notification_type(node._id, 'comments', self.user)"]}, {"lines": ["        assert_equal(nt, None)", "", "    def test_get_parent_notification_type_no_parent(self):"]}, {"lines": ["        nt = utils.get_parent_notification_type(project._id, 'comments', self.user)"]}, {"lines": ["        assert_equal(nt, None)", "", "    def test_get_parent_notification_type_handles_user_id(self):"]}, {"lines": ["        nt = utils.get_parent_notification_type(self.user._id, 'comments', self.user)"]}, {"lines": ["        assert_equal(nt, None)", "", "    def test_format_data_project_settings(self):"]}, {"lines": ["        expected = [", "            {"]}, {"lines": ["                'node': {", "                    'id': self.project._id,", "                    'title': self.project.title,", "                    'url': self.project.url,", "                },"]}, {"lines": ["                'kind': 'folder',"]}, {"lines": ["                'children': [", "                    {"]}, {"lines": ["                        'event': {", "                            'title': 'comments',"]}, {"lines": ["                            'notificationType': 'email_transactional',", "                            'parent_notification_type': None", "                        },", ""]}, {"lines": ["                        'kind': 'event',"]}, {"lines": ["                        'children': []"]}, {"lines": ["                    },", "                    {"]}, {"lines": ["                        'node': {", "                            'id': self.node._id,", "                            'title': self.node.title,", "                            'url': self.node.url,", "                        },", ""]}, {"lines": ["                        'kind': 'node',"]}, {"lines": ["                        'children': [", "                            {"]}, {"lines": ["                                'event': {", "                                    'title': 'comments',"]}, {"lines": ["                                    'notificationType': 'email_transactional',"]}, {"lines": ["                                    'parent_notification_type': 'email_transactional'"]}, {"lines": ["                                },"]}, {"lines": ["                                'kind': 'event',"]}, {"lines": ["                                'children': [],"]}, {"lines": ["                            }", "                        ]", "                    }", "                ]", "            }", "        ]", "        assert_equal(data, expected)"]}, {"lines": ["", "    def test_format_data_node_settings(self):"]}, {"lines": ["        expected = [{"]}, {"lines": ["                    },"]}, {"lines": ["        assert_equal(data, expected)", ""]}, {"lines": ["    def test_format_includes_admin_view_only_component_subscriptions(self):", "        \"\"\" Test private components in which parent project admins are not contributors still appear in their", "            notifications settings.", "        \"\"\""]}, {"lines": ["        expected = [", "            {", "                'node': {", "                    'id': self.project._id,", "                    'title': self.project.title,", "                    'url': self.project.url,", "                },"]}, {"lines": ["                'kind': 'folder',"]}, {"lines": ["                'children': [", "                    {", "                        'event': {", "                            'title': 'comments',"]}, {"lines": ["                            'notificationType': 'email_transactional',", "                            'parent_notification_type': None", "                        },", "                        'kind': 'event',", "                        'children': []", "                    },", "                    {", "                        'node': {", "                            'id': self.node._id,", "                            'title': self.node.title,", "                            'url': self.node.url,", "                        },", ""]}, {"lines": ["                        'kind': 'node',"]}, {"lines": ["                        'children': [", "                            {", "                                'event': {", "                                    'title': 'comments',"]}, {"lines": ["                                    'notificationType': 'email_transactional',"]}, {"lines": ["                                    'parent_notification_type': 'email_transactional'"]}, {"lines": ["                                },", "                                'kind': 'event',", "                                'children': [],", "                            }", "                        ]", "                    },", "                    {", "                        'node': {", "                            'id': node._id,", "                            'title': node.title,", "                            'url': node.url,", "                        },", ""]}, {"lines": ["                        'kind': 'node',"]}, {"lines": ["                        'children': [", "                            {", "                                'event': {", "                                    'title': 'comments',"]}, {"lines": ["                                    'notificationType': 'adopt_parent',", "                                    'parent_notification_type': 'email_transactional'", "                                },", "                                'kind': 'event',", "                                'children': [],", "                            }", "                        ]", "                    }", "                ]", "            }", "        ]"]}, {"lines": ["        assert_equal(data, expected)", ""]}, {"lines": ["    def test_format_data_excludes_pointers(self):"]}, {"lines": ["            _id=project._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        subscription.email_transactional.append(project.creator)", "        subscription.save()"]}, {"lines": ["        project.add_pointer(pointed, Auth(project.creator))", "        project.save()", "        configured_project_ids = utils.get_configured_projects(project.creator)"]}, {"lines": ["        expected = [{", "            'node': {", "                'id': project._id,", "                'title': project.title,", "                'url': project.url,", "            },", "            'kind': 'folder',"]}, {"lines": ["            'children': [", "                {", "                    'event': {", "                        'title': 'comments',"]}, {"lines": ["                        'notificationType': 'email_transactional',", "                        'parent_notification_type': None", "                    },", "                    'kind': 'event',", "                    'children': [],", "                }"]}, {"lines": ["        assert_equal(data, expected)", ""]}, {"lines": ["    def test_format_data_user_subscriptions_includes_private_parent_if_configured_children(self):"]}, {"lines": ["            _id=node._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        node_subscription.email_transactional.append(node.creator)", "        node_subscription.save()", "        configured_project_ids = utils.get_configured_projects(node.creator)"]}, {"lines": ["        expected = [", "            {", "                'node': {", "                    'id': private_project._id,", "                    'title': 'Private Project',", "                    'url': '',", "                },", "                'kind': 'folder',"]}, {"lines": ["                'children': [", "                    {", "                        'node': {", "                            'id': node._id,", "                            'title': node.title,", "                            'url': node.url,", "                        },", "", "                        'kind': 'folder',"]}, {"lines": ["                        'children': [", "                            {", "                                'event': {", "                                    'title': 'comments',"]}, {"lines": ["                                    'notificationType': 'email_transactional',", "                                    'parent_notification_type': None", "                                },", "                                'kind': 'event',", "                                'children': [],", "                            }", "                        ]", "                    }", "                ]", "            }", "        ]", "        assert_equal(data, expected)", ""]}, {"lines": ["    def test_format_user_subscriptions(self):"]}, {"lines": ["        data = utils.format_user_subscriptions(self.user, [])"]}, {"lines": ["        expected = [{"]}, {"lines": ["        assert_equal(data, expected)"]}, {"lines": ["", "    def test_format_data_user_settings(self):"]}, {"lines": ["        data = utils.format_user_and_project_subscriptions(self.user)"]}, {"lines": ["        expected = [", "            {"]}, {"lines": ["                'node': {", "                    'id': self.user._id,", "                    'title': 'User Notifications'", "            },"]}, {"lines": ["                'kind': 'heading',"]}, {"lines": ["                'children': utils.format_user_subscriptions(self.user, [])"]}, {"lines": ["            },", "            {"]}, {"lines": ["                'node': {", "                    'id': '',", "                    'title': 'Project Notifications'", "                },"]}, {"lines": ["                'kind': 'heading',"]}, {"lines": ["            }]", "", "        assert_equal(data, expected)"]}, {"lines": [""]}, {"lines": ["    def test_serialize_user_level_event(self):", "        user_subscriptions = utils.get_all_user_subscriptions(self.user)"]}, {"lines": ["        expected = {"]}, {"lines": ["            'event': {", "                'title': 'comment_replies',"]}, {"lines": ["                'notificationType': 'email_transactional',"]}, {"lines": ["                'parent_notification_type': None"]}, {"lines": ["            },", "            'kind': 'event',", "            'children': []"]}, {"lines": ["        assert_equal(data, expected)", "", "    def test_serialize_node_level_event(self):", "        node_subscriptions = utils.get_all_node_subscriptions(self.user, self.node)"]}, {"lines": ["        expected = {"]}, {"lines": ["            'event': {", "                'title': 'comments',"]}, {"lines": ["                'notificationType': 'email_transactional',"]}, {"lines": ["                'parent_notification_type': 'email_transactional'"]}, {"lines": ["            },"]}, {"lines": ["            'kind': 'event',"]}, {"lines": ["            'children': [],"]}, {"lines": ["        }", "        assert_equal(data, expected)", "", "    def test_serialize_node_level_event_that_adopts_parent_settings(self):"]}, {"lines": ["        self.project.add_contributor(contributor=user, permissions=['read'])", "        self.project.save()"]}, {"lines": ["        self.project_subscription.email_transactional.append(user)"]}, {"lines": ["        self.project_subscription.save()", "        self.node.add_contributor(contributor=user, permissions=['read'])", "        self.node.save()"]}, {"lines": ["        node_subscriptions = utils.get_all_node_subscriptions(user, self.node)"]}, {"lines": ["        expected = {"]}, {"lines": ["            'event': {", "                'title': 'comments',"]}, {"lines": ["                'notificationType': 'adopt_parent',", "                'parent_notification_type': 'email_transactional'", "            },"]}, {"lines": ["            'kind': 'event',"]}, {"lines": ["            'children': [],"]}, {"lines": ["        }", "        assert_equal(data, expected)", ""]}, {"lines": ["", "class TestNotificationsDict(OsfTestCase):"]}, {"lines": ["    def test_notifications_dict_add_message_returns_proper_format(self):", "        d = utils.NotificationsDict()", "        message = {", "            'message': 'Freddie commented on your project',"]}, {"lines": ["            'timestamp': datetime.datetime.utcnow().replace(tzinfo=pytz.utc)"]}, {"lines": ["        }", "        message2 = {", "            'message': 'Mercury commented on your component',"]}, {"lines": ["            'timestamp':datetime.datetime.utcnow().replace(tzinfo=pytz.utc)"]}, {"lines": ["        }", "", "        d.add_message(['project'], message)", "        d.add_message(['project', 'node'], message2)", "", "        expected = {", "            'messages': [],", "            'children': collections.defaultdict(", "                utils.NotificationsDict, {", "                    'project': {", "                        'messages': [message],", "                        'children': collections.defaultdict(utils.NotificationsDict, {", "                            'node': {", "                                'messages': [message2],", "                                'children': collections.defaultdict(utils.NotificationsDict, {})", "                            }", "                        })", "                    }", "                }", "            )}", "        assert_equal(d, expected)"]}, {"lines": ["", "", "class TestSendEmails(OsfTestCase):"]}, {"lines": ["    def setUp(self):", "        super(TestSendEmails, self).setUp()"]}, {"lines": ["            _id=self.project._id + '_' + 'comments',"]}, {"lines": ["            event_name='comments'", "        )", "        self.project_subscription.save()"]}, {"lines": ["        self.project_subscription.email_transactional.append(self.project.creator)"]}, {"lines": ["        self.project_subscription.save()"]}, {"lines": [""]}, {"lines": ["            _id=self.node._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        self.node_subscription.save()"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.notifications.emails.send')", "    def test_notify_no_subscription(self, send):"]}, {"lines": ["        assert_false(send.called)", "", "    @mock.patch('website.notifications.emails.send')", "    def test_notify_no_subscribers(self, send):"]}, {"lines": ["            _id=node._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        node_subscription.save()"]}, {"lines": ["        assert_false(send.called)", "", "    @mock.patch('website.notifications.emails.send')", "    def test_notify_sends_with_correct_args(self, send):", "        subscribed_users = getattr(self.project_subscription, 'email_transactional')"]}, {"lines": ["        assert_true(send.called)"]}, {"lines": ["", "    @mock.patch('website.notifications.emails.send')", "    def test_notify_does_not_send_to_users_subscribed_to_none(self, send):"]}, {"lines": ["            _id=node._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        node_subscription.save()"]}, {"lines": ["        node_subscription.none.append(user)"]}, {"lines": ["        node_subscription.save()"]}, {"lines": ["        assert_false(send.called)", "", "    @mock.patch('website.notifications.emails.send')"]}, {"lines": ["    def test_notify_sends_comment_reply_event_if_comment_is_direct_reply(self, mock_send):"]}, {"lines": ["", "    @mock.patch('website.notifications.emails.send')", "    def test_notify_sends_comment_event_if_comment_reply_is_not_direct_reply(self, mock_send):"]}, {"lines": ["", "    @mock.patch('website.mails.send_mail')", "    @mock.patch('website.notifications.emails.send')", "    def test_notify_does_not_send_comment_if_they_reply_to_their_own_comment(self, mock_send, mock_send_mail):", "        user = factories.UserFactory()"]}, {"lines": ["        assert_false(mock_send_mail.called)", ""]}, {"lines": ["    @mock.patch('website.notifications.emails.send')", "    def test_notify_sends_comment_event_if_comment_reply_is_not_direct_reply_on_component(self, mock_send):", "        \"\"\" Test that comment replies on components that are not direct replies to the subscriber use the", "            \"comments\" email template.", "        \"\"\"", "        user = factories.UserFactory()"]}, {"lines": ["", "    # @mock.patch('website.notifications.emails.notify')", "    @mock.patch('website.project.views.comment.notify')", "    def test_check_user_comment_reply_subscription_if_email_not_sent_to_target_user(self, mock_notify):", "        # user subscribed to comment replies"]}, {"lines": ["            _id=user._id + '_comments',"]}, {"lines": ["            event_name='comment_replies'", "        )", "        user_subscription.email_transactional.append(user)", "        user_subscription.save()", "", "        # user is not subscribed to project comment notifications"]}, {"lines": ["", "        # reply to user"]}, {"lines": ["        content = 'hammer to fall'", "", "        # auth=project.creator.auth", "        url = project.api_url + 'comment/'", "        self.app.post_json(", "            url,", "            {", "                'content': content,", "                'isPublic': 'public',", "                'target': target._id", "", "            },", "            auth=project.creator.auth", "        )", "        assert_true(mock_notify.called)", "        assert_equal(mock_notify.call_count, 2)", "", "    @mock.patch('website.notifications.emails.send')"]}, {"lines": ["    def test_check_parent(self, send):"]}, {"lines": ["        assert_true(send.called)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.notifications.emails.send')", "    def test_check_parent_does_not_send_if_notification_type_is_none(self, mock_send):"]}, {"lines": ["            _id=project._id,"]}, {"lines": ["            event_name='comments'", "        )", "        project_subscription.save()"]}, {"lines": ["        project_subscription.none.append(project.creator)"]}, {"lines": ["        project_subscription.save()"]}, {"lines": ["        assert_false(mock_send.called)", ""]}, {"lines": ["    @mock.patch('website.notifications.emails.send')", "    def test_check_parent_sends_to_subscribers_with_admin_read_access_to_component(self, mock_send):", "        # Admin user is subscribed to receive emails on the parent project"]}, {"lines": ["            _id=project._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        project_subscription.save()", "        project_subscription.email_transactional.append(project.creator)", "        project_subscription.save()", "", "        # User has admin read-only access to the component", "        # Default is to adopt parent project settings"]}, {"lines": ["            _id=node._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        node_subscription.save()", "", "        # Assert that user receives an email when someone comments on the component"]}, {"lines": ["        assert_true(mock_send.called)", "", "    @mock.patch('website.notifications.emails.send')", "    def test_check_parent_does_not_send_to_subscribers_without_access_to_component(self, mock_send):", "        # Non-admin user is subscribed to receive emails on the parent project"]}, {"lines": ["        project.add_contributor(contributor=user, permissions=['read'])"]}, {"lines": ["            _id=project._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        project_subscription.save()", "        project_subscription.email_transactional.append(user)", "        project_subscription.save()", "", "        # User does not have access to the component"]}, {"lines": ["            _id=node._id + '_comments',"]}, {"lines": ["            event_name='comments'", "        )", "        node_subscription.save()", "", "        # Assert that user does not receive an email when someone comments on the component"]}, {"lines": ["        assert_false(mock_send.called)", ""]}, {"lines": ["    # @mock.patch('website.notifications.emails.email_transactional')", "    # def test_send_calls_correct_mail_function(self, email_transactional):", "    #     emails.send([self.user], 'email_transactional', self.project._id, 'comments',"]}, {"lines": ["    #                 timestamp=datetime.datetime.utcnow(),"]}, {"lines": ["    #                 gravatar_url=self.user.gravatar_url,"]}, {"lines": ["    #                 content='',", "    #                 parent_comment='',", "    #                 title=self.project.title,", "    #                 url=self.project.absolute_url", "    #     )", "    #     assert_true(email_transactional.called)", "", "    @mock.patch('website.mails.send_mail')", "    def test_send_email_transactional(self, send_mail):", "        # assert that send_mail is called with the correct person & args"]}, {"lines": ["        subscribed_users = [self.user._id]"]}, {"lines": ["        timestamp = datetime.datetime.utcnow().replace(tzinfo=pytz.utc)"]}, {"lines": ["", "        emails.email_transactional(", "            subscribed_users, self.project._id, 'comments',"]}, {"lines": ["            gravatar_url=self.user.gravatar_url,"]}, {"lines": ["            content='',", "            parent_comment='',", "            title=self.project.title,"]}, {"lines": ["        )"]}, {"lines": ["            timestamp=timestamp,"]}, {"lines": ["            gravatar_url=self.user.gravatar_url,"]}, {"lines": ["            content='',", "            parent_comment='',", "            title=self.project.title,"]}, {"lines": ["        message = mails.render_message("]}, {"lines": ["            'comments.html.mako',"]}, {"lines": ["            timestamp=timestamp,"]}, {"lines": ["            gravatar_url=self.user.gravatar_url,"]}, {"lines": ["            content='',", "            parent_comment='',", "            title=self.project.title,"]}, {"lines": ["            url=self.project.absolute_url,"]}, {"lines": ["", "        assert_true(send_mail.called)", "        send_mail.assert_called_with(", "            to_addr=self.user.username,", "            mail=mails.TRANSACTIONAL,"]}, {"lines": ["            mimetype='html',"]}, {"lines": ["            name=self.user.fullname,"]}, {"lines": ["            node_title=self.project.title,"]}, {"lines": ["            node_id=self.project._id,"]}, {"lines": ["            subject=subject,", "            message=message,"]}, {"lines": ["        )"]}, {"lines": ["", "    def test_send_email_digest_creates_digest_notification(self):"]}, {"lines": ["        subscribed_users = [factories.UserFactory()._id]"]}, {"lines": ["        emails.email_digest(subscribed_users, self.project._id, 'comments',"]}, {"lines": ["                            timestamp=datetime.datetime.utcnow().replace(tzinfo=pytz.utc),"]}, {"lines": ["                            gravatar_url=self.user.gravatar_url,"]}, {"lines": ["                            content='',", "                            parent_comment='',", "                            title=self.project.title,", "                            url=self.project.absolute_url", "        )"]}, {"lines": ["        assert_equal((digest_count - digest_count_before), 1)"]}, {"lines": ["", "    def test_send_email_digest_not_created_for_user_performed_actions(self):"]}, {"lines": ["        subscribed_users = [self.user._id]"]}, {"lines": ["        emails.email_digest(subscribed_users, self.project._id, 'comments',"]}, {"lines": ["                            gravatar_url=self.user.gravatar_url,"]}, {"lines": ["                            content='',", "                            parent_comment='',", "                            title=self.project.title,", "                            url=self.project.absolute_url", "        )"]}, {"lines": ["        assert_equal(digest_count_before, digest_count)"]}, {"lines": ["", "    def test_get_settings_url_for_node(self):", "        url = emails.get_settings_url(self.project._id, self.user)", "        assert_equal(url, self.project.absolute_url + 'settings/')", "", "    def test_get_settings_url_for_user(self):", "        url = emails.get_settings_url(self.user._id, self.user)"]}, {"lines": ["        assert_equal(url, web_url_for('user_notifications', _absolute=True))"]}, {"lines": ["", "    def test_get_node_lineage(self):"]}, {"lines": ["", "    def test_localize_timestamp(self):", "        timestamp = datetime.datetime.utcnow().replace(tzinfo=pytz.utc)"]}, {"lines": ["        self.user.locale = 'en_US'"]}, {"lines": ["        self.user.save()"]}, {"lines": ["        tz = dates.get_timezone(self.user.timezone)", "        locale = Locale(self.user.locale)"]}, {"lines": ["        formatted_date = dates.format_date(timestamp, format='full', locale=locale)"]}, {"lines": ["        formatted_time = dates.format_time(timestamp, format='short', tzinfo=tz, locale=locale)"]}, {"lines": ["        formatted_datetime = u'{time} on {date}'.format(time=formatted_time, date=formatted_date)"]}, {"lines": ["        assert_equal(emails.localize_timestamp(timestamp, self.user), formatted_datetime)"]}, {"lines": ["    def test_localize_timestamp_empty_timezone(self):"]}, {"lines": ["        self.user.locale = 'en_US'"]}, {"lines": ["        tz = dates.get_timezone('Etc/UTC')", "        locale = Locale(self.user.locale)"]}, {"lines": ["        formatted_date = dates.format_date(timestamp, format='full', locale=locale)"]}, {"lines": ["        formatted_time = dates.format_time(timestamp, format='short', tzinfo=tz, locale=locale)"]}, {"lines": ["        formatted_datetime = u'{time} on {date}'.format(time=formatted_time, date=formatted_date)"]}, {"lines": ["        assert_equal(emails.localize_timestamp(timestamp, self.user), formatted_datetime)"]}, {"lines": ["", "    def test_localize_timestamp_empty_locale(self):", "        timestamp = datetime.datetime.utcnow().replace(tzinfo=pytz.utc)", "        self.user.timezone = 'America/New_York'", "        self.user.locale = ''", "        self.user.save()", "        tz = dates.get_timezone(self.user.timezone)", "        locale = Locale('en')"]}, {"lines": ["        formatted_date = dates.format_date(timestamp, format='full', locale=locale)"]}, {"lines": ["        formatted_time = dates.format_time(timestamp, format='short', tzinfo=tz, locale=locale)"]}, {"lines": ["        formatted_datetime = u'{time} on {date}'.format(time=formatted_time, date=formatted_date)", "        assert_equal(emails.localize_timestamp(timestamp, self.user), formatted_datetime)", "", "    def test_localize_timestamp_handles_unicode(self):", "        timestamp = datetime.datetime.utcnow().replace(tzinfo=pytz.utc)", "        self.user.timezone = 'Europe/Moscow'", "        self.user.locale = 'ru_RU'", "        self.user.save()", "        tz = dates.get_timezone(self.user.timezone)", "        locale = Locale(self.user.locale)", "        formatted_date = dates.format_date(timestamp, format='full', locale=locale)", "        formatted_time = dates.format_time(timestamp, format='short', tzinfo=tz, locale=locale)", "        formatted_datetime = u'{time} on {date}'.format(time=formatted_time, date=formatted_date)"]}, {"lines": ["        assert_equal(emails.localize_timestamp(timestamp, self.user), formatted_datetime)"]}, {"lines": ["from framework import utils as framework_utils"]}, {"lines": ["from website.project.views.node import _get_summary, _view_project, _serialize_node_search"]}, {"lines": ["from website.profile import utils"]}, {"lines": ["from website.views import serialize_log"]}, {"lines": ["    def test_get_summary_private_node_should_include_id_and_primary_boolean_reg_and_fork(self):"]}, {"lines": ["        assert_equal(result['summary']['is_registration'], node.is_registration)", "        assert_equal(result['summary']['is_fork'], node.is_fork)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    # https://github.com/CenterForOpenScience/openscienceframework.org/issues/858", "    def test_get_summary_private_registration_should_include_is_registration(self):", "        user = UserFactory()", "        # non-contributor cannot see private registration of public project", "        node = ProjectFactory(public=True)"]}, {"lines": ["        res = _get_summary(reg, auth=Auth(user), rescale_ratio=None)", "", "        # serialized result should have is_registration"]}, {"lines": ["        assert_true(res['summary']['is_registration'])"]}, {"lines": [""]}, {"lines": ["    def test_get_summary_private_fork_should_include_is_fork(self):"]}, {"lines": ["        user = UserFactory()", "        # non-contributor cannot see private fork of public project", "        node = ProjectFactory(public=True)", "        consolidated_auth = Auth(user=node.creator)", "        fork = node.fork_node(consolidated_auth)", ""]}, {"lines": ["            rescale_ratio=None,", "            primary=True,", "            link_id=None", "        )", "        # serialized result should have is_fork"]}, {"lines": ["        assert_true(res['summary']['is_fork'])"]}, {"lines": ["", "    def test_get_summary_private_fork_private_project_should_include_is_fork(self):", "        # contributor on a private project", "        user = UserFactory()", "        node = ProjectFactory(public=False)", "        node.add_contributor(user)", "", "        # contributor cannot see private fork of this project", "        consolidated_auth = Auth(user=node.creator)", "        fork = node.fork_node(consolidated_auth)", ""]}, {"lines": ["            rescale_ratio=None,", "            primary=True,", "            link_id=None", "        )", "        # serialized result should have is_fork"]}, {"lines": [""]}, {"lines": ["    def test_serialize_node_search_returns_only_visible_contributors(self):", "        node = NodeFactory()", "        non_visible_contributor = UserFactory()", "        node.add_contributor(non_visible_contributor, visible=False)", "        serialized_node = _serialize_node_search(node)", "", "        assert_equal(serialized_node['firstAuthor'], node.visible_contributors[0].family_name)", "        assert_equal(len(node.visible_contributors), 1)", "        assert_false(serialized_node['etal'])", ""]}, {"lines": ["class TestNodeLogSerializers(OsfTestCase):", "", "    def test_serialize_log(self):", "        node = NodeFactory(category='hypothesis')", "        log = NodeLogFactory(params={'node': node._primary_key})", "        node.logs.append(log)", "        node.save()", "        d = serialize_log(log)", "        assert_equal(d['action'], log.action)", "        assert_equal(d['node']['node_type'], 'component')", "        assert_equal(d['node']['category'], 'Hypothesis')", "", "        assert_equal(d['node']['url'], log.node.url)"]}, {"lines": ["        assert_in('contributors', d)", "        assert_equal(d['user']['fullname'], log.user.fullname)", "        assert_equal(d['user']['url'], log.user.url)", "        assert_in('api_key', d)", "        assert_equal(d['params'], log.params)", "        assert_equal(d['node']['title'], log.node.title)", "", "    def test_serialize_node_for_logs(self):", "        node = NodeFactory()", "        d = node.serialize()", "", "        assert_equal(d['id'], node._primary_key)", "        assert_equal(d['category'], node.category_display)", "        assert_equal(d['node_type'], node.project_or_component)", "        assert_equal(d['url'], node.url)", "        assert_equal(d['title'], node.title)", "        assert_equal(d['api_url'], node.api_url)", "        assert_equal(d['is_public'], node.is_public)", "        assert_equal(d['is_registration'], node.is_registration)", ""]}, {"lines": ["class TestAddContributorJson(OsfTestCase):", ""]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        self.user = UserFactory()", "        self.profile = self.user.profile_url", "        self.user_id = self.user._primary_key"]}, {"lines": ["        self.fullname = self.user.fullname", "        self.username = self.user.username"]}, {"lines": [""]}, {"lines": ["        self.jobs = [{"]}, {"lines": ["            'institution': 'School of Lover Boys',", "            'department': 'Fancy Patter',"]}, {"lines": ["            'start': None,", "            'end': None,"]}, {"lines": [""]}, {"lines": ["        self.schools = [{", "            'degree': 'Vibing',", "            'institution': 'Queens University',", "            'department': '',", "            'location': '',", "            'start': None,", "            'end': None,"]}, {"lines": [""]}, {"lines": ["    def test_add_contributor_json(self):"]}, {"lines": ["        # User with no employment or education info listed"]}, {"lines": ["        user_info = utils.add_contributor_json(self.user)", "", "        assert_equal(user_info['fullname'], self.fullname)", "        assert_equal(user_info['email'], self.username)", "        assert_equal(user_info['id'], self.user_id)", "        assert_equal(user_info['employment'], None)", "        assert_equal(user_info['education'], None)"]}, {"lines": ["        assert_equal(user_info['n_projects_in_common'], 0)"]}, {"lines": ["        assert_equal(user_info['registered'], True)", "        assert_equal(user_info['active'], True)", "        assert_in('secure.gravatar.com', user_info['gravatar_url'])", "        assert_equal(user_info['profile_url'], self.profile)"]}, {"lines": ["", "    def test_add_contributor_json_with_edu(self):", "        # Test user with only education information", "        self.user.schools = self.schools"]}, {"lines": ["        user_info = utils.add_contributor_json(self.user)"]}, {"lines": [""]}, {"lines": ["        assert_equal(user_info['fullname'], self.fullname)", "        assert_equal(user_info['email'], self.username)", "        assert_equal(user_info['id'], self.user_id)", "        assert_equal(user_info['employment'], None)", "        assert_equal(user_info['education'], self.user.schools[0]['institution'])"]}, {"lines": ["        assert_equal(user_info['n_projects_in_common'], 0)"]}, {"lines": ["        assert_equal(user_info['registered'], True)", "        assert_equal(user_info['active'], True)", "        assert_in('secure.gravatar.com', user_info['gravatar_url'])", "        assert_equal(user_info['profile_url'], self.profile)"]}, {"lines": [""]}, {"lines": ["    def test_add_contributor_json_with_job(self):", "        # Test user with only employment information", "        self.user.jobs = self.jobs"]}, {"lines": ["        user_info = utils.add_contributor_json(self.user)", "", "        assert_equal(user_info['fullname'], self.fullname)", "        assert_equal(user_info['email'], self.username)", "        assert_equal(user_info['id'], self.user_id)", "        assert_equal(user_info['employment'], self.user.jobs[0]['institution'])", "        assert_equal(user_info['education'], None)"]}, {"lines": ["        assert_equal(user_info['n_projects_in_common'], 0)"]}, {"lines": ["        assert_equal(user_info['registered'], True)", "        assert_equal(user_info['active'], True)", "        assert_in('secure.gravatar.com', user_info['gravatar_url'])", "        assert_equal(user_info['profile_url'], self.profile)"]}, {"lines": ["", "    def test_add_contributor_json_with_job_and_edu(self):"]}, {"lines": ["        # User with both employment and education information"]}, {"lines": ["        self.user.jobs = self.jobs", "        self.user.schools = self.schools"]}, {"lines": ["        user_info = utils.add_contributor_json(self.user)", "", "        assert_equal(user_info['fullname'], self.fullname)", "        assert_equal(user_info['email'], self.username)", "        assert_equal(user_info['id'], self.user_id)", "        assert_equal(user_info['employment'], self.user.jobs[0]['institution'])", "        assert_equal(user_info['education'], self.user.schools[0]['institution'])"]}, {"lines": ["        assert_equal(user_info['n_projects_in_common'], 0)"]}, {"lines": ["        assert_equal(user_info['registered'], True)", "        assert_equal(user_info['active'], True)", "        assert_in('secure.gravatar.com', user_info['gravatar_url'])"]}, {"lines": ["from website import mailchimp_utils"]}, {"lines": ["from website import mails, settings"]}, {"lines": ["from website.project.views.comment import serialize_comment"]}, {"lines": ["        assert_equal(len(self.project.node__registrations), 1)"]}, {"lines": ["        reg = Node.load(self.project.node__registrations[-1])"]}, {"lines": ["            'startMonth': 'January',", "            'startYear': '2001',", "            'endMonth': 'March',", "            'endYear': '2001',"]}, {"lines": ["            'startMonth': 'May',", "            'startYear': '2001',", "            'endMonth': None,", "            'endYear': None,"]}, {"lines": ["    def test_unserialize_and_serialize_schools(self):"]}, {"lines": ["            'startMonth': 1,"]}, {"lines": ["            'startYear': '2001',"]}, {"lines": ["            'endMonth': 5,"]}, {"lines": ["            'endYear': '2001',"]}, {"lines": ["            'startMonth': 5,"]}, {"lines": ["            'startYear': '2001',"]}, {"lines": ["            'endMonth': None,", "            'endYear': None,"]}, {"lines": ["                'startYear': '2013',"]}, {"lines": ["                'endYear': '2014',"]}, {"lines": ["    def test_unserialize_schools(self):"]}, {"lines": ["                'startYear': '2013',"]}, {"lines": ["                'endYear': '2014',"]}, {"lines": ["    def test_unserialize_jobs_valid(self):"]}, {"lines": ["                'startYear': '2013',"]}, {"lines": ["                'endYear': '2014',"]}, {"lines": ["        res = self.app.put_json(url, payload, auth=self.user.auth)", "        assert_equal(res.status_code, 200)"]}, {"lines": ["    def test_update_user_timezone(self):", "        assert_equal(self.user.timezone, 'Etc/UTC')"]}, {"lines": ["        url = api_url_for('update_user', uid=self.user._id)", "        self.app.put_json(url, payload, auth=self.user.auth)", "        self.user.reload()", "        assert_equal(self.user.timezone, 'America/New_York')", "", "    def test_update_user_locale(self):", "        assert_equal(self.user.locale, 'en_US')"]}, {"lines": ["        url = api_url_for('update_user', uid=self.user._id)", "        self.app.put_json(url, payload, auth=self.user.auth)", "        self.user.reload()", "        assert_equal(self.user.locale, 'de_DE')", "", "    def test_update_user_locale_none(self):", "        assert_equal(self.user.locale, 'en_US')"]}, {"lines": ["        url = api_url_for('update_user', uid=self.user._id)", "        self.app.put_json(url, payload, auth=self.user.auth)", "        self.user.reload()", "        assert_equal(self.user.locale, 'en_US')", "", "    def test_update_user_locale_empty_string(self):", "        assert_equal(self.user.locale, 'en_US')"]}, {"lines": ["        url = api_url_for('update_user', uid=self.user._id)", "        self.app.put_json(url, payload, auth=self.user.auth)", "        self.user.reload()", "        assert_equal(self.user.locale, 'en_US')", ""]}, {"lines": ["class TestConfigureMailingListViews(OsfTestCase):", ""]}, {"lines": ["    @classmethod", "    def setUpClass(cls):", "        super(TestConfigureMailingListViews, cls).setUpClass()", "        cls._original_enable_email_subscriptions = settings.ENABLE_EMAIL_SUBSCRIPTIONS", "        settings.ENABLE_EMAIL_SUBSCRIPTIONS = True", ""]}, {"lines": ["    @mock.patch('website.mailchimp_utils.get_mailchimp_api')"]}, {"lines": ["    def test_user_choose_mailing_lists_updates_user_dict(self, mock_get_mailchimp_api):", "        user = AuthUserFactory()", "        list_name = 'OSF General'"]}, {"lines": ["        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': 1, 'list_name': list_name}]}"]}, {"lines": ["        list_id = mailchimp_utils.get_list_id_from_name(list_name)"]}, {"lines": [""]}, {"lines": ["        url = api_url_for('user_choose_mailing_lists')", "        res = self.app.post_json(url, payload, auth=user.auth)", "        user.reload()", "", "        # check user.mailing_lists is updated"]}, {"lines": ["", "        # check that user is subscribed"]}, {"lines": ["        mock_client.lists.subscribe.assert_called_with(id=list_id,", "                                                       email={'email': user.username},", "                                                       merge_vars= {'fname': user.given_name,", "                                                                    'lname': user.family_name,", "                                                       },", "                                                       double_optin=False,", "                                                       update_existing=True)"]}, {"lines": ["", "    def test_get_mailchimp_get_endpoint_returns_200(self):", "        url = api_url_for('mailchimp_get_endpoint')", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["    @mock.patch('website.mailchimp_utils.get_mailchimp_api')"]}, {"lines": ["    def test_mailchimp_webhook_subscribe_action_does_not_change_user(self, mock_get_mailchimp_api):", "        \"\"\" Test that 'subscribe' actions sent to the OSF via mailchimp"]}, {"lines": ["            webhooks update the OSF database."]}, {"lines": ["        \"\"\"", "        list_id = '12345'", "        list_name = 'OSF General'", "        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': list_id, 'name': list_name}]}", "", "        # user is not subscribed to a list", "        user = AuthUserFactory()", "        user.mailing_lists = {'OSF General': False}", "        user.save()", ""]}, {"lines": ["        # user subscribes and webhook sends request to OSF"]}, {"lines": ["        data = {'type': 'subscribe',", "                'data[list_id]': list_id,", "                'data[email]': user.username", "        }", "        url = api_url_for('sync_data_from_mailchimp') + '?key=' + settings.MAILCHIMP_WEBHOOK_SECRET_KEY", "        res = self.app.post(url,", "                            data,", "                            content_type=\"application/x-www-form-urlencoded\",", "                            auth=user.auth)", ""]}, {"lines": ["        # user field is updated on the OSF"]}, {"lines": ["        user.reload()"]}, {"lines": ["        assert_true(user.mailing_lists[list_name])"]}, {"lines": ["", "    @mock.patch('website.mailchimp_utils.get_mailchimp_api')", "    def test_mailchimp_webhook_profile_action_does_not_change_user(self, mock_get_mailchimp_api):", "        \"\"\" Test that 'profile' actions sent to the OSF via mailchimp", "            webhooks do not cause any database changes.", "        \"\"\"", "        list_id = '12345'", "        list_name = 'OSF General'", "        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': list_id, 'name': list_name}]}", "", "        # user is subscribed to a list", "        user = AuthUserFactory()", "        user.mailing_lists = {'OSF General': True}", "        user.save()", "", "        # user hits subscribe again, which will update the user's existing info on mailchimp", "        # webhook sends request (when configured to update on changes made through the API)", "        data = {'type': 'profile',", "                'data[list_id]': list_id,", "                'data[email]': user.username", "        }", "        url = api_url_for('sync_data_from_mailchimp') + '?key=' + settings.MAILCHIMP_WEBHOOK_SECRET_KEY", "        res = self.app.post(url,", "                            data,", "                            content_type=\"application/x-www-form-urlencoded\",", "                            auth=user.auth)", "", "        # user field does not change", "        user.reload()", "        assert_true(user.mailing_lists[list_name])", "", "    @mock.patch('website.mailchimp_utils.get_mailchimp_api')", "    def test_sync_data_from_mailchimp_unsubscribes_user(self, mock_get_mailchimp_api):"]}, {"lines": ["        list_id = '12345'", "        list_name = 'OSF General'", "        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': list_id, 'name': list_name}]}", "", "        # user is subscribed to a list", "        user = AuthUserFactory()", "        user.mailing_lists = {'OSF General': True}", "        user.save()", "", "        # user unsubscribes through mailchimp and webhook sends request", "        data = {'type': 'unsubscribe',", "                'data[list_id]': list_id,", "                'data[email]': user.username", "        }"]}, {"lines": ["        url = api_url_for('sync_data_from_mailchimp') + '?key=' + settings.MAILCHIMP_WEBHOOK_SECRET_KEY"]}, {"lines": ["        res = self.app.post(url,", "                            data,", "                            content_type=\"application/x-www-form-urlencoded\",", "                            auth=user.auth)", "", "        # user field is updated on the OSF", "        user.reload()", "        assert_false(user.mailing_lists[list_name])", "", "    def test_sync_data_from_mailchimp_fails_without_secret_key(self):", "        user = AuthUserFactory()", "        payload = {'values': {'type': 'unsubscribe',", "                              'data': {'list_id': '12345',", "                                       'email': 'freddie@cos.io'}}}", "        url = api_url_for('sync_data_from_mailchimp')"]}, {"lines": ["        assert_equal(res.status_code, http.UNAUTHORIZED)", ""]}, {"lines": ["    @classmethod", "    def tearDownClass(cls):", "        super(TestConfigureMailingListViews, cls).tearDownClass()", "        settings.ENABLE_EMAIL_SUBSCRIPTIONS = cls._original_enable_email_subscriptions"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        self.user = AuthUserFactory()"]}, {"lines": ["        self.project.add_contributor(self.user)", "        self.project.save()"]}, {"lines": ["        self.user.save()"]}, {"lines": ["        res_comment = res.json['comment']"]}, {"lines": ["", "        serialized_comment = serialize_comment(self.project.commented[0], self.consolidated_auth)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        assert_equal(res_comment, serialized_comment)"]}, {"lines": ["        res_comment = res.json['comment']"]}, {"lines": ["", "        serialized_comment = serialize_comment(self.project.commented[0], Auth(user=self.non_contributor))"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        assert_equal(res_comment, serialized_comment)"]}, {"lines": ["        res_comment = res.json['comment']"]}, {"lines": ["", "        serialized_comment = serialize_comment(self.project.commented[0], self.consolidated_auth)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        assert_equal(res_comment, serialized_comment)", ""]}, {"lines": ["    def test_view_comments_updates_user_comments_view_timestamp(self):"]}, {"lines": ["        CommentFactory(node=self.project)", ""]}, {"lines": ["        url = self.project.api_url_for('update_comments_timestamp')"]}, {"lines": ["        res = self.app.put_json(url, auth=self.user.auth)"]}, {"lines": ["        self.user.reload()", ""]}, {"lines": ["        user_timestamp = self.user.comments_viewed_timestamp[self.project._id]"]}, {"lines": [""]}, {"lines": ["    def test_confirm_non_contrib_viewers_dont_have_pid_in_comments_view_timestamp(self):"]}, {"lines": ["        url = self.project.api_url_for('update_comments_timestamp')"]}, {"lines": ["        res = self.app.put_json(url, auth=self.user.auth)"]}, {"lines": ["", "        self.non_contributor.reload()"]}, {"lines": ["        assert_not_in(self.project._id, self.non_contributor.comments_viewed_timestamp)"]}, {"lines": [""]}, {"lines": ["    def test_n_unread_comments_updates_when_comment_is_added(self):"]}, {"lines": ["        self._add_comment(self.project, auth=self.project.creator.auth)", "        self.project.reload()"]}, {"lines": ["        url = self.project.api_url_for('list_comments')"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.json.get('nUnread'), 1)"]}, {"lines": [""]}, {"lines": ["        url = self.project.api_url_for('update_comments_timestamp')"]}, {"lines": ["        res = self.app.put_json(url, auth=self.user.auth)", "        self.user.reload()"]}, {"lines": ["", "        url = self.project.api_url_for('list_comments')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.json.get('nUnread'), 0)"]}, {"lines": [""]}, {"lines": ["    def test_n_unread_comments_updates_when_comment_reply(self):", "        comment = CommentFactory(node=self.project, user=self.project.creator)", "        reply = CommentFactory(node=self.project, user=self.user, target=comment)", "        self.project.reload()", "", "        url = self.project.api_url_for('list_comments')", "        res = self.app.get(url, auth=self.project.creator.auth)", "        assert_equal(res.json.get('nUnread'), 1)", "", ""]}, {"lines": ["    def test_n_unread_comments_updates_when_comment_is_edited(self):"]}, {"lines": ["        self.test_edit_comment()", "        self.project.reload()"]}, {"lines": [""]}, {"lines": ["        url = self.project.api_url_for('list_comments')"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.json.get('nUnread'), 1)"]}, {"lines": [""]}, {"lines": ["    def test_n_unread_comments_is_zero_when_no_comments(self):", "        url = self.project.api_url_for('list_comments')"]}, {"lines": ["        res = self.app.get(url, auth=self.project.creator.auth)"]}, {"lines": ["        assert_equal(res.json.get('nUnread'), 0)"]}, {"lines": ["", ""]}, {"lines": ["class TestWikiWidgetViews(OsfTestCase):", "", "    def setUp(self):", "        super(TestWikiWidgetViews, self).setUp()", "", "        # project with no home wiki page", "        self.project = ProjectFactory()", "        self.read_only_contrib = AuthUserFactory()", "        self.project.add_contributor(self.read_only_contrib, permissions='read')", "        self.noncontributor = AuthUserFactory()", "", "        # project with no home wiki content"]}, {"lines": ["        self.project2.add_contributor(self.read_only_contrib, permissions='read')"]}, {"lines": ["", "    def test_show_wiki_for_contributors_when_no_wiki_or_content(self):"]}, {"lines": ["", "    def test_show_wiki_is_false_for_read_contributors_when_no_wiki_or_content(self):"]}, {"lines": ["", "    def test_show_wiki_is_false_for_noncontributors_when_no_wiki_or_content(self):"]}, {"lines": ["", ""]}, {"lines": ["class TestForkViews(OsfTestCase):", "", "    def setUp(self):", "        super(TestForkViews, self).setUp()"]}, {"lines": ["        self.user = AuthUserFactory()"]}, {"lines": ["        self.consolidated_auth = Auth(user=self.project.creator)", "        self.user.save()", "        self.project.save()", ""]}, {"lines": ["    def test_registered_forks_dont_show_in_fork_list(self):"]}, {"lines": ["        fork = self.project.fork_node(self.consolidated_auth)", "        RegistrationFactory(project=fork)", ""]}, {"lines": ["        url = self.project.api_url_for('get_forks')"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "", "        assert_equal(len(res.json['nodes']), 1)", "        assert_equal(res.json['nodes'][0]['id'], fork._id)", "", ""]}, {"lines": ["    def test_project_before_template_no_addons(self):", "        project = ProjectFactory()", "        res = self.app.get(project.api_url_for('project_before_template'), auth=project.creator.auth)", "        assert_equal(res.json['prompts'], [])", "", "    def test_project_before_template_with_addons(self):", "        project = ProjectWithAddonFactory(addon='github')", "        res = self.app.get(project.api_url_for('project_before_template'), auth=project.creator.auth)", "        assert_in('GitHub', res.json['prompts'])", ""]}, {"lines": [""]}, {"lines": ["", "class TestUserConfirmSignal(OsfTestCase):", "", "    def test_confirm_user_signal_called_when_user_claims_account(self):", "        unclaimed_user = UnconfirmedUserFactory()", "        # unclaimed user has been invited to a project.", "        referrer = UserFactory()", "        project = ProjectFactory(creator=referrer)", "        unclaimed_user.add_unclaimed_record(project, referrer, 'foo')", "        unclaimed_user.save()", "", "        token = unclaimed_user.get_unclaimed_record(project._primary_key)['token']", "        with capture_signals() as mock_signals:", "            url = web_url_for('claim_user_form', pid=project._id, uid=unclaimed_user._id, token=token)", "            payload = {'username': unclaimed_user.username,", "                       'password': 'password',", "                       'password2': 'password'}", "            res = self.app.post(url, payload)", "            assert_equal(res.status_code, 302)", "", "        assert_equal(mock_signals.signals_sent(), set([auth.signals.user_confirmed]))", "", "    def test_confirm_user_signal_called_when_user_confirms_email(self):", "        unconfirmed_user = UnconfirmedUserFactory()", "        unconfirmed_user.save()", "", "        # user goes to email confirmation link", "        token = unconfirmed_user.get_confirmation_token(unconfirmed_user.username)", "        with capture_signals() as mock_signals:", "            url = web_url_for('confirm_email_get', uid=unconfirmed_user._id, token=token)", "            res = self.app.get(url)", "            assert_equal(res.status_code, 302)", "", "        assert_equal(mock_signals.signals_sent(), set([auth.signals.user_confirmed]))", ""]}, {"lines": [""]}, {"lines": ["import mock"]}, {"lines": ["from framework.tasks import handlers"]}, {"lines": ["        with self.context:", "            handlers.celery_before_request()"]}, {"lines": ["    @mock.patch('website.mailchimp_utils.get_mailchimp_api')", "    def test_merge(self, mock_get_mailchimp_api):"]}, {"lines": ["        # mock mailchimp", "        mock_client = mock.MagicMock()", "        mock_get_mailchimp_api.return_value = mock_client", "        mock_client.lists.list.return_value = {'data': [{'id': x, 'list_name': list_name} for x, list_name in enumerate(self.user.mailing_lists)]}", ""]}, {"lines": ["        handlers.celery_teardown_request()"]}, {"lines": ["            username=None, password=None, mail_server=None, callback=None, **context):"]}, {"lines": ["", "    kwargs = dict("]}, {"lines": ["        mail_server=mail_server)", ""]}, {"lines": ["    if settings.USE_CELERY:"]}, {"lines": ["        return mailer.apply_async(kwargs=kwargs, link=callback)", "    else:", "        ret = mailer(**kwargs)", "        if callback:", "            callback()", "", "        return ret"]}, {"lines": ["DIGEST = Mail('digest', subject='OSF Email Digest')", "TRANSACTIONAL = Mail('transactional', subject='OSF: ${subject}')"]}, {"lines": ["from website.notifications import views as notification_views"]}, {"lines": ["                '/project/<pid>/comments/timestamps/',", "                '/project/<pid>/node/<nid>/comments/timestamps/',"]}, {"lines": ["            ],"]}, {"lines": ["            'put',"]}, {"lines": ["            project_views.comment.update_comments_timestamp,"]}, {"lines": ["            json_renderer,", "        ),", "", "        Rule(", "            ["]}, {"lines": ["        Rule(", "            '/settings/notifications/',", "            'get',", "            profile_views.user_notifications,", "            OsfWebRenderer('profile/notifications.mako'),", "        ),", ""]}, {"lines": [""]}, {"lines": ["        Rule('/mailchimp/hooks/', 'get', profile_views.mailchimp_get_endpoint, json_renderer),", "", "        Rule('/mailchimp/hooks/', 'post', profile_views.sync_data_from_mailchimp, json_renderer),"]}, {"lines": ["            '/settings/notifications/',"]}, {"lines": ["            'get',", "            profile_views.user_notifications,", "            json_renderer,", "        ),", "", "        Rule(", "            '/settings/notifications/',"]}, {"lines": ["            'post',", "            profile_views.user_choose_mailing_lists,", "            json_renderer,", "        ),", "", "        Rule("]}, {"lines": ["            '/subscriptions/',", "            'get',", "            notification_views.get_subscriptions,", "            json_renderer,", "        ),", "", "        Rule("]}, {"lines": ["            [", "                '/project/<pid>/subscriptions/',", "                '/project/<pid>/node/<nid>/subscriptions/'", "            ],", "            'get',", "            notification_views.get_node_subscriptions,", "            json_renderer,", "        ),", "", "        Rule(", "            '/subscriptions/',"]}, {"lines": ["            'post',"]}, {"lines": ["            notification_views.configure_subscription,"]}, {"lines": ["            json_renderer,", "        ),", "", "        Rule("]}, {"lines": ["    auth.user_merged"]}, {"lines": ["from website.util import rubeus"]}, {"lines": ["    ret.update(rubeus.collect_addon_assets(node))"]}, {"lines": ["VIEWS = ['widget']"]}, {"lines": ["    'widget': ['dataverse.css'],"]}, {"lines": ["'use strict';", "var ko = require('knockout');"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["ko.punches.enableAll();"]}, {"lines": ["function ViewModel(url) {", "    var self = this;", "    self.connected = ko.observable();", "    self.dataverse = ko.observable();", "    self.dataverseUrl = ko.observable();"]}, {"lines": ["    self.doi = ko.observable();"]}, {"lines": ["    self.citation = ko.observable('');", "    self.loaded = ko.observable(false);"]}, {"lines": ["    // Flashed messages", "    self.message = ko.observable('');"]}, {"lines": ["    self.init = function() {", "        $.ajax({", "            url: url, type: 'GET', dataType: 'json',", "            success: function(response) {", "                var data = response.data;", "                self.connected(data.connected);", "                self.dataverse(data.dataverse);", "                self.dataverseUrl(data.dataverseUrl);"]}, {"lines": ["                self.doi(data.doi);"]}, {"lines": ["                self.citation(data.citation);", "                self.loaded(true);", "            },", "            error: function(xhr) {", "                self.loaded(true);", "                var errorMessage = (xhr.status === 403) ? language.widgetInvalid : language.widgetError;", "                self.changeMessage(errorMessage, 'text-danger');"]}, {"lines": ["        });", "    };", "", "    /** Change the flashed status message */", "    self.changeMessage = function(text, css, timeout) {", "        self.message(text);", "        var cssClass = css || 'text-info';", "        self.messageClass(cssClass);", "        if (timeout) {", "            // Reset message after timeout period", "            setTimeout(function() {", "                self.message('');", "                self.messageClass('text-info');", "            }, timeout);", "        }", "    };", "}"]}, {"lines": ["// Public API", "function DataverseWidget(selector, url) {", "    var self = this;", "    self.viewModel = new ViewModel(url);", "    $osf.applyBindings(self.viewModel, selector);", "    self.viewModel.init();", "}"]}, {"lines": ["module.exports = DataverseWidget;"]}, {"lines": ["var DataverseWidget = require('./dataverseWidget.js');", "", "var url = window.contextVars.node.urls.api + 'dataverse/widget/contents/';"]}, {"lines": ["from urllib3.exceptions import MaxRetryError"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.disable_access_token')"]}, {"lines": ["    def test_dropbox_oauth_delete_user_with_invalid_credentials(self, mock_disable_access_token):"]}, {"lines": ["        self.user.add_addon('dropbox')", "        settings = self.user.get_addon('dropbox')", "        settings.access_token = '12345abc'", "        settings.save()", "        assert_true(settings.has_auth)", "", "        mock_response = mock.Mock()", "        mock_response.status = 401", "        mock_disable_access_token.side_effect = ErrorResponse(mock_response, \"The given OAuth 2 access token doesn't exist or has expired.\")", "", "        self.user.save()", "        url = api_url_for('dropbox_oauth_delete_user')", "        self.app.delete(url)", "        settings.reload()", "        assert_false(settings.has_auth)", ""]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_dropbox_user_config_get_has_valid_credentials(self, mock_account_info):", "        mock_account_info.return_value = {'display_name': 'Mr. Drop Box'}"]}, {"lines": ["        url = api_url_for('dropbox_user_config_get')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        # The JSON result", "        result = res.json['result']", "        assert_true(result['validCredentials'])", ""]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_dropbox_user_config_get_has_invalid_credentials(self, mock_account_info):"]}, {"lines": ["        mock_response = mock.Mock()", "        mock_response.status = 401"]}, {"lines": ["        mock_account_info.side_effect = ErrorResponse(mock_response, \"The given OAuth 2 access token doesn't exist or has expired.\")"]}, {"lines": ["        url = api_url_for('dropbox_user_config_get')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        # The JSON result", "        result = res.json['result']", "        assert_false(result['validCredentials'])", ""]}, {"lines": ["        result = serialize_settings(self.node_settings, self.user, client=mock_client)"]}, {"lines": ["        assert_equal(urls['settings'], web_url_for('user_addons'))"]}, {"lines": ["        result = serialize_settings(self.node_settings, self.user, client=mock_client)"]}, {"lines": ["        result = serialize_settings(self.node_settings, no_addon_user, client=mock_client)"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_serialize_settings_valid_credentials(self, mock_account_info):", "        mock_account_info.return_value = {'display_name': 'Mr. Drop Box'}", "        result = serialize_settings(self.node_settings, self.user, client=mock_client)"]}, {"lines": ["        assert_true(result['validCredentials'])", ""]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_serialize_settings_invalid_credentials(self, mock_account_info):"]}, {"lines": ["        mock_response = mock.Mock()", "        mock_response.status = 401"]}, {"lines": ["        mock_account_info.side_effect = ErrorResponse(mock_response, \"The given OAuth 2 access token doesn't exist or has expired.\")"]}, {"lines": ["        result = serialize_settings(self.node_settings, self.user)", "        assert_false(result['validCredentials'])", ""]}, {"lines": ["        result = serialize_settings(self.node_settings, self.user, client=mock_client)"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_dropbox_import_user_auth_returns_serialized_settings(self, mock_account_info):", "        mock_account_info.return_value = {'display_name': 'Mr. Drop Box'}"]}, {"lines": [""]}, {"lines": ["                                             client=mock_client)"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.metadata')", "    def test_dropbox_hgrid_data_contents_handles_max_retry_error(self, mock_metadata):", "        mock_response = mock.Mock()", "        url = self.project.api_url_for('dropbox_hgrid_data_contents')", "        mock_metadata.side_effect = MaxRetryError(mock_response, url)", "        res = self.app.get(url, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, httplib.REQUEST_TIMEOUT)", ""]}, {"lines": ["    def account_info(self):", "        return {'display_name': 'Mr. Drop Box'}"]}, {"lines": ["from dropbox.rest import ErrorResponse"]}, {"lines": ["    nid = kwargs.get('nid') or kwargs.get('pid')"]}, {"lines": ["    try:", "        client = get_client_from_user_settings(user_addon)", "        client.disable_access_token()"]}, {"lines": ["    except ErrorResponse as error:", "        if error.status == 401:"]}, {"lines": ["            pass"]}, {"lines": ["        else:", "            raise HTTPError(http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["    valid_credentials = True", "", "    if user_addon.has_auth:", "        try:", "            client = get_client_from_user_settings(user_addon)", "            client.account_info()", "        except ErrorResponse as error:", "            if error.status == 401:", "                valid_credentials = False"]}, {"lines": ["            else:", "                HTTPError(http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["            'validCredentials': valid_credentials,"]}, {"lines": ["            'nNodesAuthorized': len(user_addon.nodes_authorized),"]}, {"lines": ["            'urls': urls"]}, {"lines": ["from urllib3.exceptions import MaxRetryError"]}, {"lines": ["", "    max_retry_error = HTTPError(http.REQUEST_TIMEOUT, data=dict(message_short='Request Timeout',", "                                                   message_long='Dropbox could not be reached '", "                                                   'at this time.'))", ""]}, {"lines": ["    except MaxRetryError:", "        raise max_retry_error", ""]}, {"lines": ["        // Files can be deleted if private or if it is in a dataset that contains more than one file"]}, {"lines": ["            (!item.parent().data.isAddonRoot && item.parent().children.length > 1);"]}, {"lines": ["", "var url = window.contextVars.node.urls.api + 'figshare/config/';"]}, {"lines": ["'use strict';"]}, {"lines": ["var ko = require('knockout');"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["ko.punches.enableAll();"]}, {"lines": ["/**", " * Knockout view model for the Forward node settings widget.", " */", "var ViewModel = function(url) {"]}, {"lines": ["    var self = this;"]}, {"lines": ["    self.url = ko.observable();", "    self.label = ko.observable();", "    self.linkDisplay = ko.computed(function() {", "        if (self.label()) {", "            return self.label();", "        } else {", "            return self.url();", "        }", "    });", "    self.redirectBool = ko.observable();", "    self.redirectSecs = ko.observable();"]}, {"lines": ["    self.interval = null;", "    self.redirecting = ko.observable();", "    self.timeLeft = ko.observable();"]}, {"lines": ["    self.doRedirect = function() {", "        window.location.href = self.url();", "    };"]}, {"lines": ["    self.tryRedirect = function() {", "        if (self.timeLeft() > 0) {", "            self.timeLeft(self.timeLeft() - 1);", "        } else {", "            self.doRedirect();", "        }", "    };"]}, {"lines": ["    self.queueRedirect = function() {", "        self.redirecting(true);", "        $.blockUI({message: $('#forwardModal')});", "        self.timeLeft(self.redirectSecs());", "        self.interval = setInterval(", "            self.tryRedirect,", "            1000", "        );", "    };"]}, {"lines": ["    self.cancelRedirect = function() {", "        self.redirecting(false);", "        $.unblockUI();", "        clearInterval(self.interval);", "    };"]}, {"lines": ["    self.execute = function() {", "        if (self.redirectBool()) {", "            self.queueRedirect();", "        }", "    };"]}, {"lines": ["    self.init = function() {", "        $.ajax({", "            type: 'GET',", "            url: url,", "            dataType: 'json',", "            success: function(response) {", "                self.url(response.url);", "        self.label(response.label);", "                self.redirectBool(response.redirectBool);", "                self.redirectSecs(response.redirectSecs);", "                self.execute();", "            }", "        });"]}, {"lines": ["};"]}, {"lines": ["// Public API", "function ForwardWidget(selector, url) {", "    var self = this;", "    self.viewModel = new ViewModel(url);", "    $osf.applyBindings(self.viewModel, selector);", "    self.viewModel.init();", "}"]}, {"lines": ["module.exports = ForwardWidget;"]}, {"lines": ["var ForwardWidget = require('./forwardWidget.js');", "", "var url = window.contextVars.node.urls.api + 'forward/config/';"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    Fangorn.Utils.setCurrentFileID.call(tb, tree, window.contextVars.node.id, window.contextVars.file);"]}, {"lines": ["    var selectClass = '';", "    var node = item.parent().parent();"]}, {"lines": ["    }", ""]}, {"lines": ["var bootbox = require('bootbox');"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["", "$(document).ready(function() {", "", "    $('#githubAddKey').on('click', function() {", "        window.location.href = '/api/v1/settings/github/oauth/';", "    });", "", "    $('#githubDelKey').on('click', function() {", "        bootbox.confirm({", "            title: 'Remove access key?',", "            message: 'Are you sure you want to remove your GitHub access key? This will ' +", "                'revoke access to GitHub for all projects you have authorized ' +", "                'and delete your access token from GitHub. Your OSF collaborators ' +", "                'will not be able to write to GitHub repos or view private repos ' +", "                'that you have authorized.',", "            callback: function(result) {", "                if(result) {", "                    $.ajax({", "                        url: '/api/v1/settings/github/oauth/',", "                        type: 'DELETE',", "                        success: function() {", "                            window.location.reload();", "                        }", "                    });", "                }", "            }", "        });", "    });", "});"]}, {"lines": ["        repo = connection.create_repo(repo_name, auto_init=True)"]}, {"lines": ["    'files': [],"]}, {"lines": ["    var Rubeus = require('rubeus');"]}, {"lines": ["var $ = require('jquery');", "var bootbox = require('bootbox');"]}, {"lines": [""]}, {"lines": ["$('#s3RemoveAccess').on('click', function() {"]}, {"lines": ["    bootbox.confirm({", "        title: 'Remove access key?',", "        message: 'Are you sure you want to remove your Amazon Simple Storage Service access key? ' +", "                'This will revoke access to Amazon S3 for all projects you have authorized and ' +", "                'delete your access token from Amazon S3. Your OSF collaborators will not be able ' +", "                'to write to Amazon S3 buckets or view private buckets that you have authorized.',", "        callback: function(result) {", "            if(result) {", "                deleteToken();", "            }", "        }", "    });", "});"]}, {"lines": [""]}, {"lines": ["function deleteToken() {", "    var $this = $(this),", "    addon = $this.attr('data-addon'),", "    msgElm = $this.find('.addon-settings-message');", "    $.ajax({", "        type: 'DELETE',", "        url: '/api/v1/settings/s3/',", "        contentType: 'application/json',", "        dataType: 'json',", "        success: function(response) {", "            msgElm.text('Keys removed')", "                .removeClass('text-danger').addClass('text-success')", "                .fadeOut(100).fadeIn();", "            window.location.reload();", "        },", "        error: function(xhr) {", "            var response = JSON.parse(xhr.responseText);", "            if (response && response.message) {", "                if(response.message === 'reload')"]}, {"lines": ["                    window.location.reload();"]}, {"lines": ["                else", "                    message = response.message;", "            } else {", "                message = 'Error: Keys not removed';", "            }", "            msgElm.text(message)", "                .removeClass('text-success').addClass('text-danger')", "                .fadeOut(100).fadeIn();"]}, {"lines": ["        }"]}, {"lines": ["    });", "    return false;", "}"]}, {"lines": [""]}, {"lines": ["$(document).ready(function() {", "    $(window.contextVars.addonSettingsSelector).on('submit', AddonHelper.onSubmitSettings);", "});"]}, {"lines": ["        window.contextVars = $.extend({}, window.contextVars, {'addonSettingsSelector': '#addonSettings${addon_short_name.capitalize()}'});"]}, {"lines": ["        <div class=\"osf-panel hidden-xs ${'' if 'menu' in panels_used else 'hidden' | n}\" data-bind=\"css: {  'osf-panel-flex': !$root.singleVis(), reset-height : $root.singleVis() }\">", "            <div class=\"osf-panel-header\" data-bind=\"css: {  'osf-panel-header-flex': !$root.singleVis()}\"> <i class=\"fa fa-list\"> </i>  Menu"]}, {"lines": ["            <div class=\"osf-panel-body\" data-bind=\"css: {  'osf-panel-body-flex': !$root.singleVis()}\">"]}, {"lines": ["        <div class=\"osf-panel panel-collapsed hidden-xs text-center ${'hidden' if 'menu' in panels_used else '' | n}\" >", "          <div class=\"osf-panel-header pointer\">"]}, {"lines": ["          <div class=\"osf-panel-body\">"]}, {"lines": ["        <div class=\"osf-panel visible-xs\">", "            <div class=\"osf-panel-header\"> <i class=\"fa fa-list\"> </i>  Menu </div>", "            <div class=\"osf-panel-body \">"]}, {"lines": ["                <div class=\"osf-panel\" data-bind=\"css: { 'no-border': $root.singleVis() === 'edit' }\">", "                  <div class=\"osf-panel-header\" data-bind=\"css : { 'bordered': $root.singleVis() === 'edit' }\">"]}, {"lines": ["                  <div class=\"osf-panel-body\">"]}, {"lines": ["                  <div class=\"osf-panel-footer\">"]}, {"lines": ["              <div class=\"osf-panel no-border\" data-bind=\"css: { 'no-border reset-height': $root.singleVis() === 'view', 'osf-panel-flex': $root.singleVis() !== 'view' }\">", "                <div class=\"osf-panel-header bordered\" data-bind=\"css: { 'osf-panel-header-flex': $root.singleVis() !== 'view', 'bordered': $root.singleVis() === 'view' }\">"]}, {"lines": ["                <div id=\"wikiViewPanel\"  class=\"osf-panel-body\" data-bind=\"css: { 'osf-panel-body-flex': $root.singleVis() !== 'view' }\">"]}, {"lines": ["            <div class=\"osf-panel osf-panel-flex\" data-bind=\"css: { 'no-border reset-height': $root.singleVis() === 'compare', 'osf-panel-flex': $root.singleVis() !== 'compare' }\">", "              <div class=\"osf-panel-header osf-panel-header-flex\" data-bind=\"css: {  'osf-panel-header-flex': $root.singleVis() !== 'compare', 'bordered': $root.singleVis() === 'compare'}\">"]}, {"lines": ["              <div data-bind=\"html: renderedCompare, css: { 'osf-panel-body-flex': $root.singleVis() !== 'compare' }\" class=\"osf-panel-body wiki-compare-view\">"]}, {"lines": ["    params['d'] = 'identicon'"]}, {"lines": ["from babel import dates, core, Locale"]}, {"lines": ["from website import mails"]}, {"lines": ["from website.notifications import utils"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    node_subscribers = []"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": ["    \"\"\" Check subscription object for the event on the parent project", "        and send transactional email to indirect subscribers.", "    \"\"\""]}, {"lines": ["    target_user = context.get('target_user', None)", ""]}, {"lines": ["                        event = 'comment_replies' if target_user == u else event"]}, {"lines": ["", "    return node_subscribers"]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    \"\"\""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "def get_settings_url(uid, user):", "    if uid == user._id:", "        return web_url_for('user_notifications', _absolute=True)"]}, {"lines": ["", "", "def localize_timestamp(timestamp, user):"]}, {"lines": ["        user_timezone = dates.get_timezone(user.timezone)", "    except LookupError:", "        user_timezone = dates.get_timezone('Etc/UTC')", "", "    try:", "        user_locale = Locale(user.locale)", "    except core.UnknownLocaleError:", "        user_locale = 'en'", ""]}, {"lines": ["    formatted_date = dates.format_date(timestamp, format='full', locale=user_locale)"]}, {"lines": ["    formatted_time = dates.format_time(timestamp, format='short', tzinfo=user_timezone, locale=user_locale)", ""]}, {"lines": ["import collections"]}, {"lines": ["from modularodm import Q"]}, {"lines": ["from modularodm.exceptions import NoResultsFound"]}, {"lines": [""]}, {"lines": ["", "class NotificationsDict(dict):", "    def __init__(self):"]}, {"lines": ["        super(NotificationsDict, self).__init__()"]}, {"lines": ["        self.update(messages=[], children=collections.defaultdict(NotificationsDict))", "", "    def add_message(self, keys, messages):"]}, {"lines": ["        \"\"\"", "        :param keys: ordered list of project ids from parent to node (e.g. ['parent._id', 'node._id'])", "        :param messages: built email message for an event that occurred on the node", "        :return: nested dict with project/component ids as the keys with the message at the appropriate level", "        \"\"\""]}, {"lines": ["        d_to_use = self"]}, {"lines": ["        for key in keys:", "            d_to_use = d_to_use['children'][key]"]}, {"lines": ["        if not isinstance(messages, list):", "            messages = [messages]"]}, {"lines": ["        d_to_use['messages'].extend(messages)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def to_subscription_key(uid, event):"]}, {"lines": ["    return str(uid + '_' + event)", "", "", "def from_subscription_key(key):", "    parsed_key = key.split(\"_\", 1)", "    return {", "        'uid': parsed_key[0],", "        'event': parsed_key[1]", "    }", "", ""]}, {"lines": ["def remove_contributor_from_subscriptions(contributor, node):"]}, {"lines": ["    \"\"\" Remove contributor from node subscriptions unless the user is an", "        admin on any of node's parent projects.", "    \"\"\""]}, {"lines": ["        node_subscriptions = get_all_node_subscriptions(contributor, node)", "        for subscription in node_subscriptions:", "            subscription.remove_user_from_subscription(contributor)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def remove_subscription(node):"]}, {"lines": ["    parent = node.parent_node", ""]}, {"lines": ["    if parent and parent.child_node_subscriptions:"]}, {"lines": ["        parent.save()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def get_configured_projects(user):"]}, {"lines": ["    \"\"\" Filter all user subscriptions for ones that are on parent projects and return the project ids", "    :param user: modular odm User object", "    :return: list of project ids for projects with no parent", "    \"\"\""]}, {"lines": ["    user_subscriptions = get_all_user_subscriptions(user)"]}, {"lines": ["    for subscription in user_subscriptions:"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def check_project_subscriptions_are_all_none(user, node):", "    node_subscriptions = get_all_node_subscriptions(user, node)", "    for s in node_subscriptions:", "        if user not in s.none:", "            return False", "    return True"]}, {"lines": [""]}, {"lines": ["", "def get_all_user_subscriptions(user):"]}, {"lines": ["    \"\"\" Get all Subscription objects that the user is subscribed to\"\"\""]}, {"lines": ["    user_subscriptions = []"]}, {"lines": ["        if getattr(user, notification_type, []):", "            for subscription in getattr(user, notification_type, []):", "                if subscription:", "                    user_subscriptions.append(subscription)", "", "    return user_subscriptions", "", ""]}, {"lines": ["def get_all_node_subscriptions(user, node, user_subscriptions=None):"]}, {"lines": ["    \"\"\" Get all Subscription objects for a node that the user is subscribed to", "", "    :param user: modular odm User object", "    :param node: modular odm Node object", "    :param user_subscriptions: all Subscription objects that the user is subscribed to", "    :return: list of Subscription objects for a node that the user is subscribed to", "    \"\"\""]}, {"lines": ["    if not user_subscriptions:", "        user_subscriptions = get_all_user_subscriptions(user)", "    node_subscriptions = []", "    for s in user_subscriptions:"]}, {"lines": ["            node_subscriptions.append(s)", "", "    return node_subscriptions", "", ""]}, {"lines": ["    \"\"\" Format subscriptions data for project settings page", "    :param user: modular odm User object", "    :param node_ids: list of parent project ids", "    :param data: the formatted data"]}, {"lines": ["    :return: treebeard-formatted data", "    \"\"\""]}, {"lines": ["    user_subscriptions = get_all_user_subscriptions(user)"]}, {"lines": ["        node = Node.load(node_id)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        # List project/node if user has at least 'read' permissions (contributor or admin viewer) or if", "        # user is contributor on a component of the project/node"]}, {"lines": ["            node_subscriptions = get_all_node_subscriptions(user, node, user_subscriptions=user_subscriptions)"]}, {"lines": ["", ""]}, {"lines": ["def format_user_subscriptions(user, data):"]}, {"lines": ["    \"\"\" Format user-level subscriptions (e.g. comment replies across the OSF) for user settings page\"\"\""]}, {"lines": ["        data.append(event)", "", "    return data", "", "", "def serialize_event(user, subscription, subscriptions_available, user_subscriptions, node=None):"]}, {"lines": ["    \"\"\"", "    :param user: modular odm User object", "    :param subscription: modular odm Subscription object", "    :param subscriptions_available: dict of available notification events for a project or user", "    :param user_subscriptions: all user subscriptions", "    :param node: modular odm Node object", "    :return: treebeard-formatted subscription events", "    \"\"\""]}, {"lines": ["    event = {"]}, {"lines": ["        'event': {", "            'title': subscription,", "            'description': subscriptions_available[subscription],", "            'notificationType': 'adopt_parent' if node and node.node__parent else 'none',", "        },"]}, {"lines": ["        'kind': 'event',"]}, {"lines": ["        'children': []", "    }", "    for s in user_subscriptions:", "        if s.event_name == subscription:"]}, {"lines": ["                if user in getattr(s, notification_type):"]}, {"lines": ["                    event['event']['notificationType'] = notification_type"]}, {"lines": [""]}, {"lines": ["    if node and node.parent_node and node.parent_node.has_permission(user, 'read'):", "        parent_nt = get_parent_notification_type(node._id, subscription, user)", "        event['event']['parent_notification_type'] = parent_nt if parent_nt else 'none'", "    else:", "        event['event']['parent_notification_type'] = None"]}, {"lines": ["", "    return event", "", ""]}, {"lines": ["def get_parent_notification_type(uid, event, user):"]}, {"lines": ["    \"\"\"", "    Given an event on a node (e.g. comment on node 'xyz'), find the user's notification", "    type on the parent project for the same event.", "    :param str uid: id of event owner (Node or User object)", "    :param str event: notification event (e.g. 'comment_replies')", "    :param obj user: modular odm User object", "    :return: str notification type (e.g. 'email_transactional')", "    \"\"\""]}, {"lines": ["    node = Node.load(uid)", "    if node and node.node__parent:", "        for p in node.node__parent:"]}, {"lines": ["            key = to_subscription_key(p._id, event)"]}, {"lines": ["            try:"]}, {"lines": ["            except NoResultsFound:"]}, {"lines": ["                return get_parent_notification_type(p._id, event, user)"]}, {"lines": [""]}, {"lines": ["                if user in getattr(subscription, notification_type):", "                    return notification_type"]}, {"lines": ["            else:", "                return get_parent_notification_type(p._id, event, user)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def format_user_and_project_subscriptions(user):"]}, {"lines": ["    \"\"\" Format subscriptions data for user settings page. \"\"\""]}, {"lines": ["    return [", "        {"]}, {"lines": ["            'node': {", "                'id': user._id,"]}, {"lines": ["                'title': 'User Notifications',"]}, {"lines": ["            },"]}, {"lines": ["            'kind': 'heading',", "            'children': format_user_subscriptions(user, [])", "        },", "        {"]}, {"lines": ["            'node': {", "                'id': '',", "                'title': 'Project Notifications',", "            },"]}, {"lines": ["            'kind': 'heading',"]}, {"lines": ["        }]"]}, {"lines": ["def add_contributor_json(user, current_user=None):", ""]}, {"lines": ["    # get shared projects"]}, {"lines": ["    if current_user:"]}, {"lines": ["        n_projects_in_common = current_user.n_projects_in_common(user)"]}, {"lines": ["    else:"]}, {"lines": ["        n_projects_in_common = 0"]}, {"lines": [""]}, {"lines": ["    current_employment = None", "    education = None", "", "    if user.jobs:", "        current_employment = user.jobs[0]['institution']", "", "    if user.schools:", "        education = user.schools[0]['institution']", ""]}, {"lines": ["        'employment': current_employment,", "        'education': education,"]}, {"lines": ["        'n_projects_in_common': n_projects_in_common,"]}, {"lines": ["        'profile_url': user.profile_url"]}, {"lines": ["from modularodm.exceptions import ModularOdmException, ValidationValueError"]}, {"lines": ["    must_be_contributor,"]}, {"lines": ["    prompts = []", "", "    for addon in node.get_addons():", "        if 'node' in addon.config.configs:"]}, {"lines": ["            if addon.to_json(auth.user)['addon_full_name']:", "                prompts.append(addon.to_json(auth.user)['addon_full_name'])"]}, {"lines": ["", "    return {'prompts': prompts}", "", "", "@must_be_logged_in"]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["@must_be_contributor"]}, {"lines": ["    addon_enabled_settings = sorted(addon_enabled_settings, key=lambda addon: addon['addon_full_name'].lower())"]}, {"lines": ["    ], key=lambda addon: addon.full_name.lower())"]}, {"lines": [""]}, {"lines": ["def _render_addon(node):"]}, {"lines": ["    return widgets, configs, js, css", ""]}, {"lines": ["    if not node.has_permission(user, 'write'):"]}, {"lines": ["    else:"]}, {"lines": ["    widgets, configs, js, css = _render_addon(node)"]}, {"lines": ["                status.push_status_message(message, dismissible=False)"]}, {"lines": ["            'registration_count': len(node.node__registrations),"]}, {"lines": ["            'is_admin_parent': parent.is_admin_parent(user) if parent else False,"]}, {"lines": ["            'has_read_permissions': node.has_permission(user, 'read'),"]}, {"lines": ["        'addons_enabled': node.get_addon_names(),"]}, {"lines": ["        'is_registration': node.is_registration,", "        'is_fork': node.is_fork,"]}, {"lines": [""]}, {"lines": ["        'etal': len(node.visible_contributors) > 1,"]}, {"lines": ["# Mailchimp"]}, {"lines": ["MAILCHIMP_API_KEY = None"]}, {"lines": ["MAILCHIMP_WEBHOOK_SECRET_KEY = 'CHANGEME'  # OSF secret key to ensure webhook is secure"]}, {"lines": ["MAILCHIMP_GENERAL_LIST = 'Open Science Framework General'"]}, {"lines": [""]}, {"lines": ["    'scripts.send_digest'"]}, {"lines": ["    $osf.growl('Email will arrive shortly', ['Please check <em>', email, '</em>'].join(''), 'success');"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": [""]}, {"lines": ["        $osf.postJSON("]}, {"lines": ["/**", " * Module for listing all projects/components authorized for a given addon", " * on the user settings page. Also handles revoking addon access from these", " * projects/components.", " */"]}, {"lines": [""]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var bootbox = require('bootbox');", ""]}, {"lines": ["var AddonPermissionsTable = {", "    init: function(addonShortName, addonFullname) {", "        $('.' + addonShortName + '-remove-token').on('click', function (event) {"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                }"]}, {"lines": ["    });", "", "    $('#' + addonShortName + '-more').on('click', function (event) {", "        $('#' + addonShortName + '-header').removeClass('table-less');", "        $('#' + addonShortName + '-more').hide();", "        $('#' + addonShortName + '-less').show();", "    });", "    $('#' + addonShortName + '-less').on('click', function (event) {", "        $('#' + addonShortName + '-header').addClass('table-less');", "        $('#' + addonShortName + '-less').hide();", "        $('#' + addonShortName + '-more').show();", "    });", "    }", "};", ""]}, {"lines": ["module.exports = AddonPermissionsTable;"]}, {"lines": ["/**", " * @param tree A Treebeard _item object for the row", " * @param nodeID Current node._id", " * @param file window.contextVars.file object", " */"]}, {"lines": ["function setCurrentFileID(tree, nodeID, file) {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    if (file.provider === 'figshare') {"]}, {"lines": ["            if (nodeID === child.data.nodeId && child.data.provider === file.provider && child.data.path === file.path) {", "                tb.currentFileID = child.id;", "            }", "        }"]}, {"lines": ["    } else if (tb.fangornFolderIndex !== undefined && tb.fangornFolderArray !== undefined && tb.fangornFolderIndex < tb.fangornFolderArray.length) {"]}, {"lines": ["        for (var j = 0; j < tree.children.length; j++) {"]}, {"lines": ["            if (nodeID === child.data.nodeId && child.data.provider === file.provider && child.data.name === tb.fangornFolderArray[tb.fangornFolderIndex]) {", "                tb.fangornFolderIndex++;"]}, {"lines": ["                if (child.data.kind === 'folder') {", "                    tb.updateFolder(null, child);", "                    tree = child;", "                }", "                else {", "                    tb.currentFileID = child.id;", "                }", "            }", "        }", "    }", "}", "", "/**", " * Scroll to the Treebeard item corresponding to the given ID", " * @param fileID id of a Treebeard _item object", " */", "function scrollToFile(fileID) {", "    var tb = this;", "    if (fileID !== undefined) {", "        var index = tb.returnIndex(fileID);", "        var visibleIndex = tb.visibleIndexes.indexOf(index);"]}, {"lines": ["    }", "}"]}, {"lines": ["    reapplyTooltips : reapplyTooltips,"]}, {"lines": ["    setCurrentFileID: setCurrentFileID,"]}, {"lines": ["Fangorn.DefaultOptions = tbOptions;", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["'use strict';"]}, {"lines": [""]}, {"lines": ["var ko = require('knockout');"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["ko.punches.enableAll();"]}, {"lines": [""]}, {"lines": ["var ViewModel = function(list) {", "    var self = this;", "    self.list = list;", "    self.subscribed = ko.observable();", "    // Flashed messages", "    self.message = ko.observable('');", "    self.messageClass = ko.observable('text-success');"]}, {"lines": [""]}, {"lines": ["    self.getListInfo = function() {", "        $.ajax({", "            url: '/api/v1/settings/notifications',", "            type: 'GET',", "            dataType: 'json',", "            success: function(response) {", "                var isSubscribed = response.mailing_lists ? response.mailing_lists[self.list] : false;", "                self.subscribed(isSubscribed);", "            },", "            error: function() {", "                var message = 'Could not retrieve settings information.';", "                self.changeMessage(message, 'text-danger', 5000);", "            }});", "    };"]}, {"lines": [""]}, {"lines": ["    self.getListInfo();"]}, {"lines": [""]}, {"lines": ["    /** Change the flashed status message */", "    self.changeMessage = function(text, css, timeout) {", "        self.message(text);", "        var cssClass = css || 'text-info';", "        self.messageClass(cssClass);", "        if (timeout) {", "            // Reset message after timeout period", "            setTimeout(function() {", "                self.message('');", "                self.messageClass('text-info');", "            }, timeout);", "        }"]}, {"lines": ["    };", ""]}, {"lines": ["    self.submit = function () {", "        var payload = {};", "        payload[self.list] = self.subscribed();", "        var request = $osf.postJSON('/api/v1/settings/notifications/', payload);", "        request.done(function () {", "            self.changeMessage('Settings updated.', 'text-success', 5000);", "        });", "        request.fail(function (xhr) {", "            if (xhr.responseJSON.error_type !== 'not_subscribed') {", "                var message = 'Could not update email preferences at this time. If this issue persists, ' +", "                    'please report it to <a href=\"mailto:support@osf.io\">support@osf.io</a>.';", "                self.changeMessage(message, 'text-danger', 5000);", "            }", "        });", "    };", "};"]}, {"lines": [""]}, {"lines": ["// API", "function NotificationsViewModel(selector, list) {", "    var self = this;", "    self.viewModel = new ViewModel(list);", "    $osf.applyBindings(self.viewModel, selector);", "}"]}, {"lines": [""]}, {"lines": ["                    data: JSON.stringify(dataToSend)"]}, {"lines": ["                    $osf.growl('Error:','Failed to delete the private link.');"]}, {"lines": ["                }"]}, {"lines": [""]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": ["    var clientLocale = window.navigator.userLanguage || window.navigator.language;"]}, {"lines": ["    if (savedTimezone !== clientTimezone || savedLocale !== clientLocale) {"]}, {"lines": ["            {", "                'timezone': clientTimezone,"]}, {"lines": ["            }"]}, {"lines": ["            Raven.captureMessage('Could not set user timezone or locale', {"]}, {"lines": [""]}, {"lines": ["        });", "    });", ""]}, {"lines": ["var $ = require('jquery');", ""]}, {"lines": ["// initialize view model for configuring mailchimp subscriptions", "var NotificationsConfig =  require('../notificationsConfig.js');", "new NotificationsConfig('#selectLists', window.contextVars.mailingList);", "", "//initialize treebeard for notification subscriptions"]}, {"lines": ["var $notificationsMsg = $('#configureNotificationsMessage');"]}, {"lines": ["", "$.ajax({"]}, {"lines": ["require('jquery-tagsinput');"]}, {"lines": [""]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": [""]}, {"lines": ["    // Tooltips"]}, {"lines": ["", "    // Tag input", "    $('#node-tags').tagsInput({"]}, {"lines": ["        interactive: window.contextVars.currentUser.canEdit,", "        maxChars: 128,", "        onAddTag: function(tag){"]}, {"lines": ["            var request = $.ajax({", "                url: url,"]}, {"lines": ["            });", "            request.fail(function(xhr, textStatus, error) {", "                Raven.captureMessage('Failed to add tag', {", "                    tag: tag, url: url, textStatus: textStatus, error: error"]}, {"lines": ["                });"]}, {"lines": ["        },", "        onRemoveTag: function(tag){"]}, {"lines": ["            var request = $.ajax({", "                url: url,"]}, {"lines": ["            });", "            request.fail(function(xhr, textStatus, error) {", "                Raven.captureMessage('Failed to remove tag', {", "                    tag: tag, url: url, textStatus: textStatus, error: error"]}, {"lines": ["                });"]}, {"lines": ["        }", "    });"]}, {"lines": [""]}, {"lines": ["    // Limit the maximum length that you can type when adding a tag"]}, {"lines": [""]}, {"lines": ["    // Remove delete UI if not contributor", "    if (!window.contextVars.currentUser.canEdit || window.contextVars.node.isRegistration) {", "        $('a[title=\"Removing tag\"]').remove();", "        $('span.tag span').each(function(idx, elm) {"]}, {"lines": ["        });", "    }"]}, {"lines": [""]}, {"lines": ["    if (window.contextVars.node.isRegistration && window.contextVars.node.tags.length === 0) {", "        $('div.tags').remove();", "    }"]}, {"lines": ["        el.children('.osf-panel.hidden-xs').addClass('hidden');"]}, {"lines": ["    $('.panel-collapsed .osf-panel-header').on('click', function () {"]}, {"lines": ["        toggle.children('.osf-panel').removeClass('hidden');"]}, {"lines": ["", "${'\\t'}To view this on the Open Science Framework, please visit: ${url}."]}, {"lines": [""]}, {"lines": ["${'\\t'}To view this on the Open Science Framework, please visit: ${url}."]}, {"lines": ["        <table class=\"block\" width=\"100%\" border=\"0\" cellpadding=\"15\" cellspacing=\"0\" align=\"center\">"]}, {"lines": ["            <th colspan=\"2\" style=\"padding: 0px 15px 0px 15px;\">", "                <h3 style=\"padding: 0 15px 5px 15px; margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300; border-bottom: 1px solid #eee; text-align: left;\">"]}, {"lines": ["                    <small style=\"font-size: 14px;color: #999;\"> in ${Node.load(parent).title}</small>"]}, {"lines": ["                <td style=\"border-collapse: collapse;\">"]}, {"lines": [""]}, {"lines": ["                                ${node_title}"]}, {"lines": ["                                %if Node.load(node_id).parent_node:"]}, {"lines": ["                                    <small style=\"font-size: 14px;color: #999;\"> in ${Node.load(node_id).parent_node.title} </small>"]}, {"lines": ["                                %endif", "                            </h3>"]}, {"lines": ["    <div class=\"cp-handle\" data-bind=\"click:removeCount\">"]}, {"lines": ["        <p data-bind=\"text: displayCount\" class=\"unread-comments-count\"></p>"]}, {"lines": ["    </div>"]}, {"lines": [""]}, {"lines": ["        <form role=\"form\" data-bind=\"submit: submit, validationOptions: {insertMessages: false, messagesOnModified: false}\">"]}, {"lines": ["                        <div data-bind=\"visible: $parent.showMessages, css:'text-danger'\">", "                            <p data-bind=\"validationMessage: institution\"></p>", "                        </div>"]}, {"lines": ["                    <div class=\"form-group\">"]}, {"lines": ["                        <div class=\"row\">"]}, {"lines": ["                            <div class =\"col-md-3\">"]}, {"lines": ["                                <select class=\"form-control\" data-bind=\"options: months,"]}, {"lines": ["                                         value: startMonth\">", "                                </select>", "                            </div>"]}, {"lines": ["                            <div class=\"col-md-3\">"]}, {"lines": ["                                <input class=\"form-control\" placeholder=\"Year\" data-bind=\"value: startYear\" />"]}, {"lines": ["                            </div>", "                        </div>"]}, {"lines": ["                    </div>"]}, {"lines": ["                            <div class=\"row\">"]}, {"lines": ["                                <div class =\"col-md-3\">"]}, {"lines": ["                                    <select class=\"form-control\" data-bind=\"options: months,"]}, {"lines": ["                                         value: endMonth\">", "                                    </select>", "                                </div>"]}, {"lines": ["                                <div class=\"col-md-3\">"]}, {"lines": ["                                    <input class=\"form-control\" placeholder=\"Year\" data-bind=\"value: endYear\" />", "                                </div>", "                            </div>"]}, {"lines": [""]}, {"lines": ["                    <div data-bind=\"visible: $parent.showMessages, css:'text-danger'\">", "                        <p data-bind=\"validationMessage: start\"></p>", "                        <p data-bind=\"validationMessage: end\"></p>", "                        <p data-bind=\"validationMessage: startYear\"></p>", "                        <p data-bind=\"validationMessage: endYear\"></p>"]}, {"lines": ["                    </div>"]}, {"lines": [""]}, {"lines": ["                        <td>{{ startMonth }} {{ startYear }}</td>", "                        <td>{{ endView }}</td>"]}, {"lines": ["        <form role=\"form\" data-bind=\"submit: submit, validationOptions: {insertMessages: false, messagesOnModified: false}\">"]}, {"lines": ["                        <div data-bind=\"visible: $parent.showMessages, css:'text-danger'\">", "                            <p data-bind=\"validationMessage: institution\"></p>", "                        </div>"]}, {"lines": ["                        <div class=\"row\">", "                            <div class =\"col-md-3\">"]}, {"lines": ["                                <select class=\"form-control\" data-bind=\"options: months,"]}, {"lines": ["                                         value: startMonth\">", "                                </select>", "                            </div>"]}, {"lines": ["                            <div class=\"col-md-3\">"]}, {"lines": ["                                <input class=\"form-control\" placeholder=\"Year\" data-bind=\"value: startYear\" />", "                            </div>", "                        </div>"]}, {"lines": ["                            <div class=\"row\">", "                                <div class =\"col-md-3\">"]}, {"lines": ["                                    <select class=\"form-control\" data-bind=\"options: months,"]}, {"lines": ["                                         value: endMonth\">", "                                    </select>", "                                </div>"]}, {"lines": ["                                <div class=\"col-md-3\">"]}, {"lines": ["                                    <input class=\"form-control\" placeholder=\"Year\" data-bind=\"value: endYear\" />", "                                </div>", "                            </div>"]}, {"lines": [""]}, {"lines": ["                    <div data-bind=\"visible: $parent.showMessages, css:'text-danger'\">", "                        <p data-bind=\"validationMessage: start\"></p>", "                        <p data-bind=\"validationMessage: end\"></p>", "                        <p data-bind=\"validationMessage: startYear\"></p>", "                        <p data-bind=\"validationMessage: endYear\"></p>", "                    </div>"]}, {"lines": [""]}, {"lines": ["                        <td>{{ startMonth }} {{ startYear }}</td>"]}, {"lines": [""]}, {"lines": ["    <% from website import settings %>"]}, {"lines": ["<% from website import settings %>"]}, {"lines": ["                <li><a href=\"${ web_url_for('user_notifications') }\">Notifications</a></li>"]}, {"lines": ["                                            class=\"addon-select\""]}, {"lines": ["", "% for name, capabilities in addon_capabilities.iteritems():", "    <script id=\"capabilities-${name}\" type=\"text/html\">${capabilities}</script>", "% endfor", ""]}, {"lines": [""]}, {"lines": ["    <% import json %>"]}, {"lines": [""]}, {"lines": ["   <script type=\"text/javascript\">"]}, {"lines": ["        window.contextVars = $.extend({}, window.contextVars, {'addonEnabledSettings': ${json.dumps(addon_enabled_settings)}});"]}, {"lines": ["    </script>"]}, {"lines": [""]}, {"lines": ["<% from website import settings %>"]}, {"lines": ["                <li><a href=\"${ web_url_for('user_notifications') }\">Notifications</a></li>"]}, {"lines": [""]}, {"lines": ["                                        <td >"]}, {"lines": ["                                            <a data-bind = \"attr: {href: contributor.profile_url}\" target=\"_blank\">"]}, {"lines": ["                                                <span data-bind= \"text:contributor.fullname\"></span>", "                                            </a><br>", "", "", "                                                <span data-bind=\"if: contributor.employment\">", "                                                    <span", "                                                        class = 'small'", "                                                        data-bind=\"text: contributor.employment\">", "                                                    </span><br>", "                                                </span>", "", "", "                                                <span data-bind=\"if: contributor.education\">", "                                                    <span", "                                                        class = 'small'", "                                                        data-bind= \"text: contributor.education\">", "                                                    </span><br>", "                                                </span>", ""]}, {"lines": ["                                                <span class= 'small'", "                                                      data-bind= \"text: contributor.displayProjectsInCommon\">"]}, {"lines": ["                                                </span>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["                                            <span   data-bind=\"text: contributor.fullname\"></span>", "", "                                            <span", "                                                    class='text-muted'", "                                                    data-bind=\"visible: !contributor.registered\">(unregistered)</span>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    window.contextVars = $.extend(true, {}, window.contextVars, {"]}, {"lines": ["    });"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    <% import json %>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "## Use full page width", "<%def name=\"container_class()\">container-xxl</%def>", ""]}, {"lines": ["    % for script in tree_js:", "        <script type=\"text/javascript\" src=\"${script | webpack_asset}\"></script>", "    % endfor", ""]}, {"lines": ["            %if summary['is_registration']:", "                Private Registration"]}, {"lines": ["            %elif summary['is_fork']:", "                Private Fork"]}, {"lines": ["            %else:", "                Private Component", "            %endif"]}], "name": "Saman Ehsan"}, {"commits": [{"lines": ["    'registration-retraction-page': staticPath('js/pages/registration-retraction-page.js'),"]}, {"lines": ["    'twofactor-page': staticPath('js/pages/twofactor-page.js'),"]}, {"lines": ["    'forgotpassword-page': staticPath('js/pages/forgotpassword-page.js'),"]}, {"lines": ["        'pikaday-css': nodePath('pikaday/css/pikaday.css'),"]}, {"lines": ["        return models.User.find(query).count() == 0"]}, {"lines": ["    if not dry_run:", "        logger.info('Emailing {0} users regarding upcoming registration changes'.format(len(contributors)))"]}, {"lines": ["    if not dry_run:", "        script_utils.add_file_logger(logger, __file__)"]}, {"lines": ["from framework.transactions.context import TokuTransaction"]}, {"lines": ["                with TokuTransaction():", "                    retraction.state = models.Retraction.RETRACTED"]}, {"lines": ["    def test_embargo_approval_adds_to_parent_projects_log(self):", "        initial_project_logs = len(self.registration.registered_from.logs)"]}, {"lines": ["        # Logs: Created, made public, registered, embargo initiated, embargo approved", "        assert_equal(len(self.registration.registered_from.logs), initial_project_logs + 1)"]}, {"lines": ["    def test_embargo_completion_adds_to_parent_projects_log(self):", "        initial_project_logs = len(self.registration.registered_from.logs)"]}, {"lines": ["        # Logs: Created, made public, registered, embargo initiated, embargo approved, embargo completed", "        assert_equal(len(self.registration.registered_from.logs), initial_project_logs + 2)"]}, {"lines": ["    UnregUserFactory, UnconfirmedUserFactory,", "    RegistrationFactory"]}, {"lines": ["    RegistrationFactory, UserFactory, UnconfirmedUserFactory,"]}, {"lines": ["    def test__initiate_retraction_does_not_create_tokens_for_unregistered_admin(self):", "        unconfirmed_user = UnconfirmedUserFactory()", "        self.registration.contributors.append(unconfirmed_user)", "        self.registration.add_permission(unconfirmed_user, 'admin', save=True)", "        assert_true(self.registration.has_permission(unconfirmed_user, 'admin'))", "", "        retraction = self.registration._initiate_retraction(self.user, save=True)", "        assert_true(self.user._id in retraction.approval_state)", "        assert_false(unconfirmed_user._id in retraction.approval_state)", ""]}, {"lines": ["    def test_retract_component_raises_NodeStateError(self):", "        project = ProjectFactory(is_public=True, creator=self.user)", "        component = NodeFactory(is_public=True, creator=self.user, parent=project)", "        registration = RegistrationFactory(is_public=True, project=project)", "", "        with assert_raises(NodeStateError):", "            registration.nodes[0].retract_registration(self.user, self.valid_justification)", ""]}, {"lines": ["    def test_approval_adds_to_parent_projects_log(self):", "        initial_project_logs = len(self.registration.registered_from.logs)"]}, {"lines": ["        # Logs: Created, registered, retraction initiated, retraction approved", "        assert_equal(len(self.registration.registered_from.logs), initial_project_logs + 2)"]}, {"lines": ["    def test_approval_of_registration_with_embargo_adds_to_parent_projects_log(self):", "        initial_project_logs = len(self.registration.registered_from.logs)"]}, {"lines": ["        # Logs: Created, registered, embargo initiated, retraction initiated, retraction approved, embargo cancelled", "        assert_equal(len(self.registration.registered_from.logs), initial_project_logs + 4)"]}, {"lines": ["    def test_disapproval_adds_to_parent_projects_log(self):", "        initial_project_logs = len(self.registration.registered_from.logs)"]}, {"lines": ["        # Logs: Created, registered, retraction initiated, retraction cancelled", "        assert_equal(len(self.registration.registered_from.logs), initial_project_logs + 2)"]}, {"lines": ["        # Ensure descendant nodes are pending embargo"]}, {"lines": ["class ComponentRegistrationRetractionViewsTestCase(OsfTestCase):", "    def setUp(self):", "        super(ComponentRegistrationRetractionViewsTestCase, self).setUp()", "        self.user = AuthUserFactory()", "        self.auth = self.user.auth", "        self.project = ProjectFactory(is_public=True, creator=self.user)", "        self.component = NodeFactory(", "            is_public=True,", "            creator=self.user,", "            parent=self.project,", "            title='Component'", "        )", "        self.subproject = ProjectFactory(", "            is_public=True,", "            creator=self.user,", "            parent=self.project,", "            title='Subproject'", "        )", "        self.subproject_component = NodeFactory(", "            is_public=True,", "            creator=self.user,", "            parent=self.subproject,", "            title='Subcomponent'", "        )", "        self.registration = RegistrationFactory(is_public=True, project=self.project)", "        self.component_registration = self.registration.nodes[0]", "        self.subproject_registration = self.registration.nodes[1]", "        self.subproject_component_registration = self.subproject_registration.nodes[0]", "", "    def test_POST_retraction_to_component_returns_HTTPBad_request(self):", "        res = self.app.post_json(", "            self.component_registration.api_url_for('node_registration_retraction_post'),", "            auth=self.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)", "", "    def test_POST_retraction_to_subproject_returns_HTTPBad_request(self):", "        res = self.app.post_json(", "            self.subproject_registration.api_url_for('node_registration_retraction_post'),", "            auth=self.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)", "", "    def test_POST_retraction_to_subproject_component_returns_HTTPBad_request(self):", "        res = self.app.post_json(", "            self.subproject_component_registration.api_url_for('node_registration_retraction_post'),", "            auth=self.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)"]}, {"lines": ["    def test_POST_pending_embargo_returns_HTTPBad_request(self):", "        self.registration.embargo_registration(", "            self.user,", "            (datetime.datetime.utcnow() + datetime.timedelta(days=10)),", "            for_existing_registration=True", "        )", "        self.registration.save()", "        assert_true(self.registration.pending_embargo)", "", "        res = self.app.post_json(", "            self.retraction_post_url,", "            auth=self.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)", "        self.registration.reload()", "        assert_is_none(self.registration.retraction)", ""]}, {"lines": ["    def test_valid_POST_retraction_adds_to_parent_projects_log(self):", "        initial_project_logs = len(self.registration.registered_from.logs)", "        self.app.post_json("]}, {"lines": ["        self.registration.registered_from.reload()", "        # Logs: Created, registered, retraction initiated", "        assert_equal(len(self.registration.registered_from.logs), initial_project_logs + 1)"]}, {"lines": ["        self.app.post_json(url, {'registrationChoice': 'immediate'}, auth=self.auth)"]}, {"lines": ["                'registrationChoice': 'embargo',"]}, {"lines": ["    message_long = \"This retraction approval link is invalid. Are you logged into the correct account?\""]}, {"lines": ["    message_long = \"This retraction disapproval link is invalid. Are you logged into the correct account?\""]}, {"lines": ["    message_long = \"This embargo approval link is invalid. Are you logged into the correct account?\""]}, {"lines": ["    message_long = \"This embargo disapproval link is invalid. Are you logged into the correct account?\""]}, {"lines": ["<p>Registration creates a frozen version of the project that can never be"]}, {"lines": ["selecting a registration form, entering information about your project, and", "then confirming. You will be able to continue editing the original project,"]}, {"lines": ["the original. Retracting a registration will leave behind metadata about"]}, {"lines": ["of the registration.</p>"]}, {"lines": ["<ul>", "    <li>A registration can be made public immediately or entered into"]}, {"lines": ["    the registration will automatically become public.</li>"]}, {"lines": ["    <li>Before initiating a registration, make sure that the project is", "    in the state that you wish to freeze. Consider turning links into", "    forks.</li>"]}, {"lines": ["    <li>Start by selecting a registration form from the list below. You can hit", "    your browser's back button if the selected form is not appropriate for", "    your use.</li>"]}, {"lines": [""]}, {"lines": ["embargo it for up to four years. At the end of the embargo period the registration"]}, {"lines": ["             OsfWebRenderer('public/forgot_password.mako')),"]}, {"lines": ["        Rule(["]}, {"lines": ["", "        Rule(["]}, {"lines": ["    ret = serialize_node(node, auth, primary=True)"]}, {"lines": ["    ret.update({"]}, {"lines": ["    return ret"]}, {"lines": ["    ret = {"]}, {"lines": ["    ret.update(node_addon.config.to_json())"]}, {"lines": ["    return ret, http.OK"]}, {"lines": ["        ret = super(AddonFigShareUserSettings, self).to_json(user)", "        ret.update({"]}, {"lines": ["        return ret"]}, {"lines": ["        ret = super(AddonFigShareNodeSettings, self).to_json(user)"]}, {"lines": ["        ret.update({"]}, {"lines": ["            ret.update({"]}, {"lines": ["        return ret"]}, {"lines": ["from framework.status import push_status_message"]}, {"lines": ["    # Handle request cancellations from FigShare's API"]}, {"lines": ["        if node:", "            return redirect(node.web_url_for('node_setting'))", "        return redirect(web_url_for('user_addons'))"]}, {"lines": ["    # Handle request cancellations from Google's API", "    if request.args.get('error'):", "        flash('Google Drive authorization request cancelled.')", "        if node:", "            return redirect(node.web_url_for('node_setting'))", "        return redirect(web_url_for('user_addons'))", ""]}, {"lines": ["            {'code': '0000000'},"]}, {"lines": ["            'embargo_end_date': node.embargo_end_date.strftime(\"%A, %b. %d, %Y\") if node.embargo_end_date else False,"]}, {"lines": ["            'root_id': node.root._id,"]}, {"lines": ["        'embargo_end_date': node.embargo_end_date.strftime(\"%A, %b. %d, %Y\") if node.embargo_end_date else False,"]}, {"lines": ["EMBARGO_END_DATE_MAX = datetime.timedelta(days=1460)  # Four years"]}, {"lines": ["/*", " * forgot password view model", " */"]}, {"lines": ["", "var ko = require('knockout');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["};", ""]}, {"lines": ["                'registrationChoice': self.embargoAddon.registrationChoice(),"]}, {"lines": ["    // signIn viewmodel component"]}, {"lines": ["            self.searchCSS('');"]}, {"lines": ["            '</b> including all components and data within it. This will <b>not</b> register' +"]}, {"lines": ["            parentUrl + '\">here.</a> After selecting OK, you will next select a registration form.';"]}, {"lines": ["        return 'You are about to register <b>' + title + '</b> ' +", "            'including all components and data within it. ' +", "            'Registration creates a permanent, time-stamped, uneditable version ' +", "            'of the project. If you would prefer to register only one particular ' +"]}, {"lines": ["            'component, please navigate to that component and then initiate registration. ' +", "            'After selecting OK, you will next select a registration form.';"]}, {"lines": ["/**"]}, {"lines": ["**/", "'use strict';", ""]}, {"lines": ["var $ = require('jquery');", "var $osf = require('js/osfHelpers');", ""]}, {"lines": ["var ko = require('knockout');"]}, {"lines": ["var koHelpers = require('js/koHelpers');"]}, {"lines": ["", "var ChangeMessageMixin = require('js/changeMessage');", "var oop = require('js/oop');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["var RegistrationRetractionViewModel = oop.extend(", "    ChangeMessageMixin,", "    {", "        constructor: function(submitUrl, registrationTitle) {", "            this.super.constructor.call(this);"]}, {"lines": [""]}, {"lines": ["            var self = this;"]}, {"lines": [""]}, {"lines": ["            self.submitUrl = submitUrl;"]}, {"lines": ["            self.justification = ko.observable('').extend({", "                maxLength: 2048", "            });", "            self.confirmationText = ko.observable().extend({", "                required: true,"]}, {"lines": ["            });", "        },"]}, {"lines": ["        SUBMIT_ERROR_MESSAGE: 'Error submitting your retraction request, please try again. If the problem ' +", "                'persists, email <a href=\"mailto:support@osf.iop\">support@osf.io</a>',", "        CONFIRMATION_ERROR_MESSAGE: 'Please enter the registration title before clicking Retract Registration',", "        JUSTIFICATON_ERROR_MESSAGE: 'Your justification is too long, please enter a justification with no more ' +", "            'than 2048 characters long.',", "        MESSAGE_ERROR_CLASS: 'text-danger',"]}, {"lines": ["        onSubmitSuccess: function(response) {", "            window.location = response.redirectUrl;", "        },", "        onSubmitError: function(xhr, status, errorThrown) {", "            var self = this;", "            self.changeMessage(self.SUBMIT_ERROR_MESSAGE, self.MESSAGE_ERROR_CLASS);", "            Raven.captureMessage('Could not submit registration retraction.', {", "                xhr: xhr,", "                status: status,", "                error: errorThrown", "            });", "        },", "        submit: function() {", "            var self = this;", "            // Show errors if invalid", "            if (!self.confirmationText.isValid()) {", "                self.changeMessage(self.CONFIRMATION_ERROR_MESSAGE, self.MESSAGE_ERROR_CLASS);", "                return false;", "            } else if (!self.justification.isValid()) {", "                self.changeMessage(self.JUSTIFICATON_ERROR_MESSAGE, self.MESSAGE_ERROR_CLASS);", "                return false;", "            } else {", "                // Else Submit", "                return $osf.postJSON(self.submitUrl, ko.toJS(self))", "                    .done(self.onSubmitSuccess.bind(self))", "                    .fail(self.onSubmitError.bind(self));", "            }"]}, {"lines": ["        }"]}, {"lines": ["});"]}, {"lines": [""]}, {"lines": ["    $osf.applyBindings(this.viewModel, selector);", "};", ""]}, {"lines": ["/**"]}, {"lines": [" * Sign in view model used for login components"]}, {"lines": [" */", "'use strict';", "", "var ko = require('knockout');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["};", ""]}, {"lines": ["        self.trackClick('Dismiss');", "    };", "    // Google Analytics click event tracking", "    self.trackClick = function(source) {"]}, {"lines": ["    if (!data.node.is_retracted) {", "        // Initialize controller for \"Add Links\" modal", "        new pointers.PointerManager('#addPointer', window.contextVars.node.title);", "        new LogFeed('#logScope', nodeApiUrl + 'log/');", "    }"]}, {"lines": ["if (!ctx.node.anonymous && !ctx.node.isRetracted) {"]}, {"lines": ["", "    if (!ctx.node.isRetracted) {", "        // Treebeard Files view", "        $.ajax({", "            url:  nodeApiUrl + 'files/grid/'", "        }).done(function (data) {", "            var fangornOpts = {", "                divID: 'treeGrid',", "                filesData: data.data,", "                uploads : true,", "                showFilter : true,", "                placement: 'dashboard',", "                title : undefined,", "                filterFullWidth : true, // Make the filter span the entire row for this view"]}, {"lines": ["                xhrconfig: $osf.setXHRAuthorization,"]}, {"lines": ["                columnTitles : function () {", "                    return ["]}, {"lines": ["                            title: 'Name',", "                            width : '90%',", "                            sort : true,", "                            sortType : 'text'", "                        }", "                    ];", "                },", "                resolveRows : function (item) {", "                    var tb = this;"]}, {"lines": ["                    item.css = '';", "                    if(tb.isMultiselected(item.id)){"]}, {"lines": ["                        item.css = 'fangorn-selected';", "                    }", "                    var defaultColumns = ["]}, {"lines": ["                                {"]}, {"lines": ["                                data: 'name',", "                                folderIcons: true,", "                                filter: true,", "                                custom: Fangorn.DefaultColumns._fangornTitleColumn", "                            }];", "                    if (item.parentID) {", "                        item.data.permissions = item.data.permissions || item.parent().data.permissions;", "                        if (item.data.kind === 'folder') {", "                            item.data.accept = item.data.accept || item.parent().data.accept;", "                        }", "                    }", "                    if(item.data.uploadState && (item.data.uploadState() === 'pending' || item.data.uploadState() === 'uploading')){", "                        return Fangorn.Utils.uploadRowTemplate.call(tb, item);"]}, {"lines": ["                    var configOption = Fangorn.Utils.resolveconfigOption.call(this, item, 'resolveRows', [item]);", "                    return configOption || defaultColumns;", "                }", "            };", "            var filebrowser = new Fangorn(fangornOpts);", "        });", "    }"]}, {"lines": ["require('pikaday-css');"]}, {"lines": ["/**", " * On page load focus on two factor input element", " */"]}, {"lines": [""]}, {"lines": ["", "var assert = require('chai').assert;"]}, {"lines": ["var utils = require('./utils');"]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": ["                var changeMessageSpy;"]}, {"lines": ["                    changeMessageSpy = new sinon.spy(vm, 'changeMessage');"]}, {"lines": ["                    changeMessageSpy.restore();"]}, {"lines": ["                it('calls changeMessage if invalid confirmation text submitted', () => {"]}, {"lines": ["                    assert.calledOnce(changeMessageSpy);"]}, {"lines": ["                it('calls changeMessage if justification is too long', () => {"]}, {"lines": ["                    assert.calledOnce(changeMessageSpy);"]}, {"lines": ["                        assert.notCalled(changeMessageSpy);"]}, {"lines": ["<script type=\"text/html\" id=\"embargo_approved\">", "approved embargo of", "<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>", "</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"embargo_cancelled\">", "cancelled embargo of", "<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>", "</script>", "", "<script type=\"text/html\" id=\"embargo_completed\">"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>", "</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"embargo_initiated\">", "initiated embargo of", "<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>", "</script>", "", "<script type=\"text/html\" id=\"retraction_approved\">", "approved retraction of", "<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>", "</script>", "", "<script type=\"text/html\" id=\"retraction_cancelled\">", "cancelled retraction of", "<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>", "</script>", "", "<script type=\"text/html\" id=\"retraction_initiated\">", "initiated retraction of", "<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>", "</script>", ""]}, {"lines": ["Center for Open Science"]}, {"lines": ["We just wanted to let you know that ${initiated_by} has requested an embargoed registration for a project you contribute to."]}, {"lines": ["We just wanted to let you know that ${initiated_by} has requested a retraction for the following registration: ${registration_link}."]}, {"lines": ["                    <select class=\"form-control\" data-bind=\"options: registrationOptions,", "                                                            value: registrationChoice,", "                                                            optionsText: 'message',", "                                                            optionsValue: 'value',", "                                                            event: {change: checkShowEmbargoDatePicker}\"></select>"]}, {"lines": ["            isRetracted: ${json.dumps(node.get('is_retracted', False))},"]}, {"lines": ["<%inherit file=\"project/project_base.mako\"/>", "<%def name=\"title()\">Retract Registration of Component</%def>", "", "<legend class=\"text-center\">Retract Registration</legend>", ""]}, {"lines": ["    <div id=\"registrationRetraction\" class=\"col-md-6 col-md-offset-3\">"]}, {"lines": ["        <form id=\"registrationRetractionForm\" role=\"form\">"]}, {"lines": ["", "            <div class=\"form-group\">", "                <label class=\"control-label\">Please provide your justification for retracting this registration.</label>", "                <textarea", "                        class=\"form-control\"", "                        data-bind=\"textInput: justification\"", "                        id=\"justificationInput\""]}, {"lines": ["                        >"]}, {"lines": ["                </textarea>", "            </div>", "", "            <hr />", "", "            <div class=\"form-group\">"]}, {"lines": ["                <label style=\"font-weight:normal\" class=\"control-label\">"]}, {"lines": ["                </label>", "                <input  type=\"text\""]}, {"lines": ["                        class=\"form-control\"", "                        data-bind=\"textInput: confirmationText\""]}, {"lines": ["                />", ""]}, {"lines": ["            </div>"]}, {"lines": ["            <div class=\"m-t-md\" data-bind=\"css: messageClass, html: message\"></div>"]}, {"lines": ["        </form>", "    </div>"]}, {"lines": ["", "<%def name=\"javascript_bottom()\">", "    ${parent.javascript_bottom()}", "    <script src=\"${'/static/public/js/registration-retraction-page.js' | webpack_asset}\"></script>"]}, {"lines": ["", "    <!-- Begin left column -->"]}, {"lines": ["", "        % if 'write' in user['permissions']:", "", "            <div class=\"panel panel-default\" data-spy=\"affix\" data-offset-top=\"60\" data-offset-bottom=\"268\"><!-- Begin sidebar -->"]}, {"lines": ["                    % if not node['is_registration']:", "                        <li><a href=\"#configureNodeAnchor\">Configure ${node['node_type'].capitalize()}</a></li>", "", "                        % if 'admin' in user['permissions']:", "                            <li><a href=\"#configureCommentingAnchor\">Configure Commenting</a></li>", "                        % endif", "", "                        % if 'write' in user['permissions']:", "                            <li><a href=\"#selectAddonsAnchor\">Select Add-ons</a></li>", "", "                            % if addon_enabled_settings:", "                                <li><a href=\"#configureAddonsAnchor\">Configure Add-ons</a></li>", "                            % endif", "", "                            <li><a href=\"#configureNotificationsAnchor\">Configure Notifications</a></li>", "                        %endif", ""]}, {"lines": ["                    % if node['is_registration']:"]}, {"lines": ["                        % if (node['is_public'] or node['embargo_end_date']) and 'admin' in user['permissions']:", "                            <li><a href=\"#retractRegistrationAnchor\">Retract Public Registration</a></li>"]}, {"lines": [""]}, {"lines": ["            </div><!-- End sidebar -->"]}, {"lines": [""]}, {"lines": ["    <!-- End left column -->"]}, {"lines": ["    <!-- Begin right column -->"]}, {"lines": ["        % if 'write' in user['permissions']:  ## Begin Configure Project"]}, {"lines": ["            % if not node['is_registration']:"]}, {"lines": ["                <div class=\"panel panel-default\">", "                    <span id=\"configureNodeAnchor\" class=\"anchor\"></span>"]}, {"lines": ["                    <div class=\"panel-heading\">", "                        <h3 id=\"configureNode\" class=\"panel-title\">Configure ${node['node_type'].capitalize()}</h3>", "                    </div>", "                    <div id=\"nodeCategorySettings\" class=\"panel-body\">", "                      <h5>", "                        Category: <select data-bind=\"attr.disabled: disabled,", "                                                     options: categories,", "                                                     optionsValue: 'value',", "                                                     optionsText: 'label',", "                                                     value: selectedCategory\"></select>", "                      </h5>", "                      <p data-bind=\"if: !disabled\">", "                        <button data-bind=\"css: {disabled: !dirty()},", "                                           click: updateCategory\"", "                                class=\"btn btn-primary\">Change</button>", "                        <button data-bind=\"css: {disabled: !dirty()},", "                                           click: cancelUpdateCategory\"", "                                class=\"btn btn-default\">Cancel</button>", "                      </p>", "                      <span data-bind=\"css: messageClass, html: message\"></span>", "                      <span data-bind=\"if: disabled\" class=\"help-block\">", "                        A top-level project's category cannot be changed", "                      </span>"]}, {"lines": ["                    % if 'admin' in user['permissions']:", "                        <hr />", "                        <div class=\"panel-body\">", "                            <div class=\"help-block\">", "                                A project cannot be deleted if it has any components within it.", "                                To delete a parent project, you must first delete all child components", "                                by visiting their settings pages.", "                            </div>", "                            <button id=\"deleteNode\" class=\"btn btn-danger btn-delete-node\">Delete ${node['node_type']}</button>", "                        </div>", "                    % endif"]}, {"lines": ["            % endif"]}, {"lines": ["        % endif  ## End Configure Project"]}, {"lines": ["        % if 'admin' in user['permissions']:  ## Begin Configure Commenting"]}, {"lines": ["            % if not node['is_registration']:"]}, {"lines": ["                <div class=\"panel panel-default\">", "                    <span id=\"configureCommentingAnchor\" class=\"anchor\"></span>", "", "                    <div class=\"panel-heading\">", "                        <h3 class=\"panel-title\">Configure Commenting</h3>", "                    </div>", "", "                    <div class=\"panel-body\">", "", "                        <form class=\"form\" id=\"commentSettings\">", "", "                            <div class=\"radio\">", "                                <label>", "                                    <input type=\"radio\" name=\"commentLevel\" value=\"private\" ${'checked' if comments['level'] == 'private' else ''}>", "                                    Only contributors can post comments", "                                </label>", "                            </div>", "                            <div class=\"radio\">", "                                <label>", "                                    <input type=\"radio\" name=\"commentLevel\" value=\"public\" ${'checked' if comments['level'] == 'public' else ''}>", "                                    When the ${node['node_type']} is public, any OSF user can post comments", "                                </label>", "                            </div>", "", "                            <button class=\"btn btn-success\">Submit</button>", "", "                            <!-- Flashed Messages -->", "                            <div class=\"help-block\">", "                                <p id=\"configureCommentingMessage\"></p>", "                            </div>", "                        </form>", "", "                    </div>"]}, {"lines": ["            % endif"]}, {"lines": ["        % endif  ## End Configure Commenting"]}, {"lines": ["        % if 'write' in user['permissions']:  ## Begin Select Addons"]}, {"lines": ["            % if not node['is_registration']:"]}, {"lines": ["                <div class=\"panel panel-default\">", "                    <span id=\"selectAddonsAnchor\" class=\"anchor\"></span>", "                    <div class=\"panel-heading\">", "                        <h3 class=\"panel-title\">Select Add-ons</h3>", "                    </div>", "                    <div class=\"panel-body\">", "                        <form id=\"selectAddonsForm\">"]}, {"lines": ["                            % for category in addon_categories:"]}, {"lines": ["                                <%", "                                    addons = [", "                                        addon", "                                        for addon in addons_available", "                                        if category in addon.categories", "                                    ]", "                                %>"]}, {"lines": ["                                % if addons:", "                                    <h3>${category.capitalize()}</h3>"]}, {"lines": ["                                    % for addon in addons:", "                                        <div>", "                                            <label>", "                                                <input", "                                                    type=\"checkbox\"", "                                                    name=\"${addon.short_name}\"", "                                                    class=\"addon-select\"", "                                                    ${'checked' if addon.short_name in addons_enabled else ''}", "                                                    ${'disabled' if (node['is_registration'] or bool(addon.added_mandatory)) else ''}", "                                                />", "                                                ${addon.full_name}", "                                            </label>", "                                        </div>", "                                    % endfor"]}, {"lines": ["                                % endif"]}, {"lines": ["                            % endfor", "", "                            <br />", "", "                            <button id=\"settings-submit\" class=\"btn btn-success\">", "                                Submit", "                            </button>", "                            <div class=\"addon-settings-message text-success\" style=\"padding-top: 10px;\"></div>", "", "                     </form>"]}, {"lines": ["                </div>"]}, {"lines": ["                % if addon_enabled_settings:", "                    <span id=\"configureAddonsAnchor\" class=\"anchor\"></span>"]}, {"lines": ["                    <div id=\"configureAddons\" class=\"panel panel-default\">"]}, {"lines": ["                        <div class=\"panel-heading\">", "                            <h3 class=\"panel-title\">Configure Add-ons</h3>", "                        </div>", "", "                        <div class=\"panel-body\">", "", "                        % for node_settings_dict in addon_enabled_settings or []:", "                            ${render_node_settings(node_settings_dict)}", "", "                                % if not loop.last:", "                                    <hr />", "                                % endif"]}, {"lines": ["", "                        </div>"]}, {"lines": ["", "                % endif"]}, {"lines": ["        % endif  ## End Select Addons"]}, {"lines": ["        % if user['has_read_permissions']:  ## Begin Configure Notifications"]}, {"lines": ["            % if not node['is_registration']:", "", "                <div class=\"panel panel-default\">", "                    <span id=\"configureNotificationsAnchor\" class=\"anchor\"></span>", "", "                    <div class=\"panel-heading\">", "                        <h3 class=\"panel-title\">Configure Notifications</h3>"]}, {"lines": ["                        <p>These notification settings only apply to you. They do NOT affect any other contributor on this project.</p>"]}, {"lines": ["                    <form id=\"notificationSettings\" class=\"osf-treebeard-minimal\">", "                        <div id=\"grid\">", "                            <div class=\"notifications-loading\"> <i class=\"fa fa-spinner notifications-spin\"></i> <p class=\"m-t-sm fg-load-message\"> Loading notification settings...  </p> </div>", "                        </div>", "                        <div class=\"help-block\" style=\"padding-left: 15px\">", "                            <p id=\"configureNotificationsMessage\"></p>", "                        </div>", "                    </form>", "                </div>"]}, {"lines": ["            %endif"]}, {"lines": ["        % endif  ## End Configure Addons", "", "        % if 'admin' in user['permissions']:  ## Begin Retract Registration", "", "            % if node['is_registration']:", "", "                % if node['is_public'] or node['embargo_end_date']:"]}, {"lines": ["                    <div class=\"panel panel-default\">", "                        <span id=\"retractRegistrationAnchor\" class=\"anchor\"></span>", "", "                        <div class=\"panel-heading\">"]}, {"lines": ["                        </div>", "", "                        <div class=\"panel-body\">"]}, {"lines": [""]}, {"lines": ["                            % if parent_node['exists']:", "", "                                <div class=\"help-block\">", "                                  Retracting children components of a registration is not allowed. Should you wish to"]}, {"lines": ["                                  retract this component, please retract its parent registration <a href=\"${web_url_for('node_setting', pid=node['root_id'])}\">here</a>."]}, {"lines": ["                                </div>", ""]}, {"lines": ["                            % else:"]}, {"lines": ["", "                                <div class=\"help-block\">", "                                    Retracting a registration will remove its content from the OSF, but leave basic metadata", "                                    behind. The title of a retracted registration and its contributor list will remain, as will", "                                    justification or explanation of the retraction, should you wish to provide it. Retracted", "                                    registrations will be marked with a <strong>retracted</strong> tag.", "                                </div>", "", "                                %if not node['pending_retraction']:", "                                    <a class=\"btn btn-danger\" href=\"${web_url_for('node_registration_retraction_get', pid=node['id'])}\">Retract Registration</a>", "                                % else:", "                                    <p><strong>This registration is already pending a retraction.</strong></p>", "                                %endif", "", "                            % endif", ""]}, {"lines": ["", "                        </div>"]}, {"lines": ["                % endif"]}, {"lines": ["            % endif", "", "        % endif  ## End Retract Registration"]}, {"lines": ["    <!-- End right column -->"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "", "<%def name=\"title()\">Forgot Password</%def>", "", "<%def name=\"content()\">"]}, {"lines": [""]}, {"lines": ["", "</%def>", "", "<%def name=\"javascript_bottom()\">", "    <script src=${\"/static/public/js/forgotpassword-page.js\" | webpack_asset}></script>", "</%def>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            <!-- Show/Hide recent activity log -->"]}], "name": "Harry Rybacki"}, {"commits": [{"lines": ["    'share-search-page': staticPath('js/pages/share-search-page.js'),"]}, {"lines": ["from website import settings"]}, {"lines": ["from website.search import elastic_search"]}, {"lines": ["from website.search.util import build_query"]}, {"lines": ["from website.search_migration.migrate import migrate"]}, {"lines": ["        search.delete_index(elastic_search.INDEX)", "        search.create_index(elastic_search.INDEX)"]}, {"lines": ["    def setUp(self):", "        super(SearchTestCase, self).setUp()"]}, {"lines": ["        search.create_index(elastic_search.INDEX)"]}, {"lines": ["    results = search.search(build_query(term), index=elastic_search.INDEX)"]}, {"lines": ["    return results"]}, {"lines": ["    term = 'category:user AND \"{}\"'.format(name)"]}, {"lines": ["        search.delete_index(elastic_search.INDEX)", "        search.create_index(elastic_search.INDEX)"]}, {"lines": ["        docs = query_user(self.user.fullname)['results']"]}, {"lines": ["        docs = query_user(user.fullname)['results']"]}, {"lines": ["        docs = query_user(user.fullname)['results']"]}, {"lines": ["        docs_original = query_user(fullname_original)['results']"]}, {"lines": ["        docs_current = query_user(user.fullname)['results']"]}, {"lines": ["        assert_equal(len(query_user(user.fullname)['results']), 1)", "        assert_equal(len(query_user(merged_user.fullname)['results']), 1)"]}, {"lines": ["        assert_equal(len(query_user(user.fullname)['results']), 1)", "        assert_equal(len(query_user(merged_user.fullname)['results']), 0)"]}, {"lines": ["        docs = query_user(institution)['results']"]}, {"lines": ["        docs = query_user(institution)['results']"]}, {"lines": ["        docs = query_user(institution)['results']"]}, {"lines": ["        docs = query_user(institution)['results']"]}, {"lines": ["    def test_name_fields(self):", "        names = ['Bill Nye', 'William', 'the science guy', 'Sanford', 'the Great']", "        user = UserFactory(fullname=names[0])", "        user.given_name = names[1]", "        user.middle_names = names[2]", "        user.family_name = names[3]", "        user.suffix = names[4]", "        user.save()"]}, {"lines": ["        docs = [query_user(name)['results'] for name in names]"]}, {"lines": ["        assert_equal(sum(map(len, docs)), len(docs))  # 1 result each", "        assert_true(all([user._id == doc[0]['id'] for doc in docs]))"]}, {"lines": ["", ""]}, {"lines": ["        search.delete_index(elastic_search.INDEX)", "        search.create_index(elastic_search.INDEX)"]}, {"lines": ["        docs = query(self.project.title)['results']"]}, {"lines": ["        docs = query(self.project.title)['results']"]}, {"lines": ["            is_public=True,"]}, {"lines": ["        docs = query('category:project AND ' + self.title)['results']"]}, {"lines": ["        docs = query('category:component AND ' + self.title)['results']"]}, {"lines": ["        docs = query('category:component AND ' + self.title)['results']"]}, {"lines": ["        docs = query('category:component AND ' + self.title)['results']"]}, {"lines": ["        docs = query('category:project AND ' + self.title)['results']"]}, {"lines": ["        docs = query('category:project AND ' + title_original)['results']"]}, {"lines": ["        docs = query('category:project AND ' + self.project.title)['results']"]}, {"lines": ["            docs = query('tags:\"{}\"'.format(tag))['results']"]}, {"lines": ["            docs = query('tags:\"{}\"'.format(tag))['results']"]}, {"lines": ["            docs = query('tags:\"{}\"'.format(tag))['results']"]}, {"lines": ["        wiki_content = {", "            'home': 'Hammer to fall',", "            'swag': '#YOLO'", "        }"]}, {"lines": ["        for key, value in wiki_content.items():", "            docs = query(value)['results']"]}, {"lines": ["            assert_equal(len(docs), 0)", "            self.project.update_node_wiki("]}, {"lines": ["                key, value, self.consolidate_auth,"]}, {"lines": ["            )"]}, {"lines": ["            docs = query(value)['results']"]}, {"lines": ["            assert_equal(len(docs), 1)"]}, {"lines": ["        docs = query(wiki_content)['results']"]}, {"lines": ["        docs = query('category:project AND \"{}\"'.format(user2.fullname))['results']"]}, {"lines": ["        docs = query('category:project AND \"{}\"'.format(user2.fullname))['results']"]}, {"lines": ["        docs = query('category:project AND \"{}\"'.format(user2.fullname))['results']"]}, {"lines": ["        docs = query('category:project AND \"{}\"'.format(user2.fullname))['results']"]}, {"lines": ["        docs = query('category:project AND \"{}\"'.format(user2.fullname))['results']"]}, {"lines": ["        docs = query(title_search)['results']"]}, {"lines": ["    def test_tag_aggregation(self):", "        tags = ['stonecoldcrazy', 'just a poor boy', 'from-a-poor-family']", "", "        for tag in tags:", "            self.project.add_tag(tag, self.consolidate_auth, save=True)", "", "        docs = query(self.title)['tags']", "        assert len(docs) == 3", "        for doc in docs:", "            assert doc['key'] in tags", ""]}, {"lines": ["    def test_unreg_users_do_show_on_projects(self):", "        unreg = UnregUserFactory(fullname='Robert Paulson')", "        self.project = ProjectFactory(", "            title='Glamour Rock',", "            creator=unreg,", "            is_public=True,", "        )", "        results = query(unreg.fullname)['results']", "        assert_equal(len(results), 1)", ""]}, {"lines": [""]}, {"lines": ["class TestSearchExceptions(OsfTestCase):"]}, {"lines": ["", "    @classmethod", "    def setUpClass(cls):"]}, {"lines": ["        super(TestSearchExceptions, cls).setUpClass()"]}, {"lines": ["        if settings.SEARCH_ENGINE == 'elastic':"]}, {"lines": ["            cls._es = search.search_engine.es"]}, {"lines": ["            search.search_engine.es = None", ""]}, {"lines": ["    @classmethod", "    def tearDownClass(cls):", "        super(TestSearchExceptions, cls).tearDownClass()"]}, {"lines": ["        if settings.SEARCH_ENGINE == 'elastic':"]}, {"lines": ["            search.search_engine.es = cls._es"]}, {"lines": [""]}, {"lines": ["    def test_connection_error(self):"]}, {"lines": ["        self.user = UserFactory(usename='Doug Bogie')", "        self.project = ProjectFactory(", "            title=\"Tom Sawyer\",", "            creator=self.user,", "            is_public=True,", "        )", "        self.user.save()", "        self.project.save()"]}, {"lines": ["", "", "class TestSearchMigration(SearchTestCase):"]}, {"lines": [""]}, {"lines": ["    @classmethod", "    def tearDownClass(cls):", "        super(TestSearchMigration, cls).tearDownClass()", "        search.create_index(settings.ELASTIC_INDEX)", ""]}, {"lines": ["    def setUp(self):", "        super(TestSearchMigration, self).setUp()", "        self.es = search.search_engine.es"]}, {"lines": ["        search.delete_index(settings.ELASTIC_INDEX)", "        search.create_index(settings.ELASTIC_INDEX)"]}, {"lines": ["        self.user = UserFactory(fullname='David Bowie')", "        self.project = ProjectFactory("]}, {"lines": ["            title=settings.ELASTIC_INDEX,"]}, {"lines": ["            creator=self.user,", "            is_public=True", "        )", "", "    def test_first_migration_no_delete(self):"]}, {"lines": ["        var = self.es.indices.get_aliases()"]}, {"lines": ["        assert_equal(var[settings.ELASTIC_INDEX + '_v1']['aliases'].keys()[0], settings.ELASTIC_INDEX)"]}, {"lines": ["", "    def test_multiple_migrations_no_delete(self):"]}, {"lines": ["        for n in xrange(1, 21):"]}, {"lines": ["            var = self.es.indices.get_aliases()", "            assert_equal(var[settings.ELASTIC_INDEX + '_v{}'.format(n)]['aliases'].keys()[0], settings.ELASTIC_INDEX)"]}, {"lines": ["", "    def test_first_migration_with_delete(self):"]}, {"lines": ["        var = self.es.indices.get_aliases()"]}, {"lines": ["        assert_equal(var[settings.ELASTIC_INDEX + '_v1']['aliases'].keys()[0], settings.ELASTIC_INDEX)"]}, {"lines": ["", "    def test_multiple_migrations_with_delete(self):"]}, {"lines": ["        for n in xrange(1, 21, 2):"]}, {"lines": ["            var = self.es.indices.get_aliases()", "            assert_equal(var[settings.ELASTIC_INDEX + '_v{}'.format(n)]['aliases'].keys()[0], settings.ELASTIC_INDEX)", ""]}, {"lines": ["            var = self.es.indices.get_aliases()", "            assert_equal(var[settings.ELASTIC_INDEX + '_v{}'.format(n + 1)]['aliases'].keys()[0], settings.ELASTIC_INDEX)", "            assert not var.get(settings.ELASTIC_INDEX + '_v{}'.format(n))"]}, {"lines": ["        res = self.app.get(url, {'query': 'fr'})"]}, {"lines": ["        res = self.app.get(url, {'query': 'fr', 'page': 1})"]}, {"lines": ["        res = self.app.get(url, {'query': 'fr', 'size': 5})"]}, {"lines": ["        res = self.app.get(url, {'query': 'fr', 'page': 2, 'size': 5, })"]}, {"lines": ["                '/project/<pid>/citation/',", "                '/project/<pid>/node/<nid>/citation/',"]}, {"lines": ["        Rule('/share/', 'get', {}, OsfWebRenderer('share_search.mako')),"]}, {"lines": ["        Rule('/share_dashboard/', 'get', {}, OsfWebRenderer('share_dashboard.mako')),"]}, {"lines": ["        Rule('/share/search/', ['get', 'post'], search_views.search_share, json_renderer),"]}, {"lines": ["        Rule('/share/stats/', 'get', search_views.search_share_stats, json_renderer),"]}, {"lines": ["        Rule('/share/providers/', 'get', search_views.search_share_providers, json_renderer),"]}, {"lines": ["# custom exceptions for ElasticSearch", "", "class SearchException(Exception):", "    pass"]}, {"lines": ["", "class SearchUnavailableError(SearchException):", "    pass"]}, {"lines": ["from elasticsearch import Elasticsearch", "", "from website import settings"]}, {"lines": ["from website.search.elastic_search import requires_search"]}, {"lines": [""]}, {"lines": ["share_es = Elasticsearch(", "    settings.SHARE_ELASTIC_URI,", "    request_timeout=settings.ELASTIC_TIMEOUT", ")", ""]}, {"lines": ["@requires_search"]}, {"lines": ["def search(query, raw=False, index='share'):"]}, {"lines": ["    # Run the real query and get the results"]}, {"lines": ["    results = share_es.search(index=index, doc_type=None, body=query)"]}, {"lines": [""]}, {"lines": ["    return results if raw else {"]}, {"lines": ["        'results': [remove_key(hit['_source'], 'raw') for hit in results['hits']['hits']],"]}, {"lines": ["        'count': results['hits']['total'],"]}, {"lines": ["    }", ""]}, {"lines": ["def remove_key(d, k):", "    d.pop(k, None)", "    return d"]}, {"lines": ["", "def clean_count_query(query):"]}, {"lines": ["    # Get rid of fields not allowed in count queries", "    for field in ['from', 'size', 'aggs', 'aggregations']:"]}, {"lines": ["        if query.get(field) is not None:"]}, {"lines": ["            del query[field]"]}, {"lines": ["    return query"]}, {"lines": [""]}, {"lines": ["", "@requires_search", "def count(query, index='share'):", "    query = clean_count_query(query)"]}, {"lines": ["    count = share_es.count(index=index, body=query)"]}, {"lines": ["", "    return {", "        'results': [],", "        'count': count['count']", "    }", ""]}, {"lines": ["@requires_search"]}, {"lines": ["def providers():", "", "    provider_map = share_es.search(index='share_providers', doc_type=None, body={", "        'query': {", "            'match_all': {}", "        },", "        'size': 10000", "    })", "", "    return {", "        'providerMap': {", "            hit['_source']['short_name']: hit['_source'] for hit in provider_map['hits']['hits']", "        }", "    }", ""]}, {"lines": ["@requires_search"]}, {"lines": ["def stats(query=None):", "    query = query or {\"query\": {\"match_all\": {}}}"]}, {"lines": ["    query['aggs'] = {", "        \"sources\": {", "            \"terms\": {", "                \"field\": \"_type\",", "                \"size\": 0,"]}, {"lines": ["                \"min_doc_count\": 0,"]}, {"lines": ["            }", "        },", "        \"doisMissing\": {", "            \"filter\": {", "                \"missing\": {", "                    \"field\": \"id.doi\""]}, {"lines": ["                }", "            },"]}, {"lines": ["            \"aggs\": {", "                \"sources\": {", "                    \"terms\": {", "                        \"field\": \"_type\",", "                        \"size\": 0"]}, {"lines": ["                    }", "                }"]}, {"lines": ["            }", "        },", "        \"dois\": {", "            \"filter\": {", "                \"exists\": {", "                    \"field\": \"id.doi\"", "                }"]}, {"lines": ["            },"]}, {"lines": ["            \"aggs\": {", "                \"sources\": {", "                    \"terms\": {", "                        \"field\": \"_type\",", "                        \"size\": 0"]}, {"lines": ["                    }", "                }"]}, {"lines": ["            }", "        },"]}, {"lines": ["        \"earlier_documents\": {", "            \"filter\": {", "                \"range\": {", "                    \"dateUpdated\": {", "                        \"lt\": three_months_ago", "                    }", "                }", "            },", "            \"aggs\": {", "                \"sources\": {", "                    \"terms\": {", "                        \"field\": \"_type\",", "                        \"size\": 0,", "                        \"min_doc_count\": 0", "                    }", "                }", "            }", "        }"]}, {"lines": ["    }", "    date_histogram_query = {", "        'query': {", "            'filtered': {", "                'query': query['query'],", "                'filter': {", "                    'range': {", "                        'dateUpdated': {", "                            'gt': three_months_ago", "                        }", "                    }", "                }", "            }", "        }", "    }", "    date_histogram_query['aggs'] = {"]}, {"lines": ["        \"date_chunks\": {", "            \"terms\": {", "                \"field\": \"_type\",", "                \"size\": 0,", "                \"exclude\": \"of|and|or\""]}, {"lines": ["            },"]}, {"lines": ["            \"aggs\": {", "                \"articles_over_time\": {", "                    \"date_histogram\": {", "                        \"field\": \"dateUpdated\","]}, {"lines": ["                    }", "                }", "            }", "        }", "    }"]}, {"lines": [""]}, {"lines": ["    results = share_es.search(index='share_v1', body=query)", "    date_results = share_es.search(index='share_v1', body=date_histogram_query)"]}, {"lines": ["    results['aggregations']['date_chunks'] = date_results['aggregations']['date_chunks']"]}, {"lines": ["    default_buckets = []"]}, {"lines": ["        default_buckets = bucket['articles_over_time']['buckets']"]}, {"lines": ["    max_len = 0"]}, {"lines": ["    for key, value in stats.iteritems():", "        if not stats[key].get('earlier_documents'):", "            stats[key]['earlier_documents'] = 0", "        if not stats[key].get('articles_over_time'):", "            stats[key]['articles_over_time'] = [", "                {", "                    'key_as_string': item['key_as_string'],", "                    'key': item['key'],", "                    'doc_count': 0", "                }", "                for item in default_buckets", "            ]"]}, {"lines": ["        if len(stats[key]['articles_over_time']) > max_len:", "                max_len = len(stats[key]['articles_over_time'])"]}, {"lines": [""]}, {"lines": ["        try:", "            names.append(key)", "            x = [item['doc_count'] for item in value['articles_over_time']]"]}, {"lines": ["            if len(x) < max_len:", "                x += [0] * (max_len - len(x))"]}, {"lines": ["            x[0] += stats[key].get('earlier_documents', 0)"]}, {"lines": ["        except IndexError:", "            pass"]}, {"lines": ["from website.search.util import build_query"]}, {"lines": ["    def wrapped(*args, **kwargs):"]}, {"lines": ["        try:", "            return func(*args, **kwargs)"]}, {"lines": [""]}, {"lines": ["    _type = kwargs.get('type', None)"]}, {"lines": ["        results = search.search(request.get_json(), doc_type=_type)"]}, {"lines": ["    elif request.method == 'GET':", "        q = request.args.get('q', '*')"]}, {"lines": ["        start = request.args.get('from', '0')", "        size = request.args.get('size', '10')"]}, {"lines": ["        results = search.search(build_query(q, start, size), doc_type=_type)"]}, {"lines": ["    results['time'] = round(time.time() - tick, 2)"]}, {"lines": ["    return results"]}, {"lines": ["    ret = process_project_search_results(results, **kwargs)", "    return ret"]}, {"lines": ["    ret = []"]}, {"lines": ["        ret.append({"]}, {"lines": ["    return ret"]}, {"lines": [""]}, {"lines": ["@handle_search_errors"]}, {"lines": ["def search_share():", "    tick = time.time()", "    results = {}", ""]}, {"lines": ["    count = request.args.get('count') is not None"]}, {"lines": ["    raw = request.args.get('raw') is not None"]}, {"lines": ["    version = request.args.get('v')", "    index = 'share_v{}'.format(version) if version else 'share'"]}, {"lines": ["", "    if request.method == 'POST':"]}, {"lines": ["        query = request.get_json()"]}, {"lines": ["    elif request.method == 'GET':"]}, {"lines": ["        query = build_query(", "            request.args.get('q', '*'),"]}, {"lines": ["            request.args.get('from', 0),", "            request.args.get('size', 10),"]}, {"lines": ["            sort=request.args.get('sort')", "        )", "", "    if count:"]}, {"lines": ["        results = search.count_share(query, index=index)"]}, {"lines": ["    else:"]}, {"lines": ["        results = search.search_share(query, raw, index=index)"]}, {"lines": ["", "    results['time'] = round(time.time() - tick, 2)", "    return results", ""]}, {"lines": ["@handle_search_errors"]}, {"lines": ["def search_share_stats():"]}, {"lines": ["    q = request.args.get('q')", "    query = build_query(q, 0, 0) if q else {}", "", "    return search.share_stats(query=query)"]}, {"lines": ["@handle_search_errors"]}, {"lines": ["        search_results = search.search_share(query, index='share_v1')"]}, {"lines": ["def search_share_providers():", "    return search.share_providers()"]}, {"lines": [""]}, {"lines": ["import logging", ""]}, {"lines": ["from elasticsearch import helpers"]}, {"lines": [""]}, {"lines": ["from website import settings"]}, {"lines": ["from website.models import Node", "from website.app import init_app"]}, {"lines": ["from scripts import utils as script_utils"]}, {"lines": ["from website.search.elastic_search import es"]}, {"lines": ["logger = logging.getLogger(__name__)", ""]}, {"lines": ["def migrate_nodes(index):"]}, {"lines": ["    logger.info(\"Migrating nodes to index: {}\".format(index))"]}, {"lines": ["    n_iter = 0"]}, {"lines": ["    nodes = Node.find(Q('is_public', 'eq', True) & Q('is_deleted', 'eq', False))"]}, {"lines": ["    for node in nodes:"]}, {"lines": ["        search.update_node(node, index=index)"]}, {"lines": ["        n_iter += 1"]}, {"lines": [""]}, {"lines": ["    logger.info('Nodes migrated: {}'.format(n_iter))"]}, {"lines": ["def migrate_users(index):"]}, {"lines": ["    logger.info(\"Migrating users to index: {}\".format(index))"]}, {"lines": ["    n_migr = 0"]}, {"lines": ["    n_iter = 0"]}, {"lines": ["    for user in User.find():"]}, {"lines": ["        if user.is_active:"]}, {"lines": ["            search.update_user(user, index=index)"]}, {"lines": ["            n_migr += 1", "        n_iter += 1"]}, {"lines": [""]}, {"lines": ["    logger.info('Users iterated: {0}\\nUsers migrated: {1}'.format(n_iter, n_migr))"]}, {"lines": ["    script_utils.add_file_logger(logger, __file__)"]}, {"lines": ["    new_index = set_up_index(index)"]}, {"lines": [""]}, {"lines": ["    migrate_nodes(new_index)", "    migrate_users(new_index)"]}, {"lines": [""]}, {"lines": ["    set_up_alias(index, new_index)"]}, {"lines": ["    if delete:"]}, {"lines": ["        delete_old(new_index)"]}, {"lines": [""]}, {"lines": ["def set_up_index(idx):", "    alias = es.indices.get_aliases(index=idx)"]}, {"lines": [""]}, {"lines": ["    if not alias or not alias.keys() or idx in alias.keys():"]}, {"lines": ["        # Deal with empty indices or the first migration"]}, {"lines": ["        index = '{}_v1'.format(idx)"]}, {"lines": ["        search.create_index(index=index)"]}, {"lines": ["        logger.info(\"Reindexing {0} to {1}_v1\".format(idx, idx))", "        helpers.reindex(es, idx, index)", "        logger.info(\"Deleting {} index\".format(idx))", "        es.indices.delete(index=idx)", "        es.indices.put_alias(idx, index)"]}, {"lines": ["    else:"]}, {"lines": ["        # Increment version"]}, {"lines": ["        version = int(alias.keys()[0].split('_v')[1]) + 1"]}, {"lines": ["        logger.info(\"Incrementing index version to {}\".format(version))"]}, {"lines": ["        index = '{0}_v{1}'.format(idx, version)"]}, {"lines": ["        search.create_index(index=index)"]}, {"lines": ["        logger.info(\"{} index created\".format(index))"]}, {"lines": ["    return index", "", ""]}, {"lines": ["def set_up_alias(old_index, index):", "    alias = es.indices.get_aliases(index=old_index)"]}, {"lines": ["    if alias:"]}, {"lines": ["        logger.info(\"Removing old aliases to {}\".format(old_index))"]}, {"lines": ["        es.indices.delete_alias(index=old_index, name='_all', ignore=404)"]}, {"lines": ["    logger.info(\"Creating new alias from {0} to {1}\".format(old_index, index))"]}, {"lines": ["    es.indices.put_alias(old_index, index)"]}, {"lines": ["", ""]}, {"lines": ["def delete_old(index):"]}, {"lines": ["    old_version = int(index.split('_v')[1]) - 1"]}, {"lines": ["    if old_version < 1:", "        logger.info(\"No index before {} to delete\".format(index))", "        pass", "    else:"]}, {"lines": ["        old_index = index.split('_v')[0] + '_v' + str(old_version)"]}, {"lines": ["        logger.info(\"Deleting {}\".format(old_index))", "        es.indices.delete(index=old_index, ignore=404)", "", ""]}, {"lines": ["    migrate(False)"]}, {"lines": ["ELASTIC_URI = 'localhost:9200'"]}, {"lines": ["ELASTIC_INDEX = 'website'"]}, {"lines": ["SHARE_ELASTIC_URI = ELASTIC_URI"]}, {"lines": [""]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var m = require('mithril');"]}, {"lines": ["var Stats = require('./stats');", "var utils = require('./utils');", "var SideBar = require('./sideBar');", "var Results = require('./results');"]}, {"lines": ["var Footer = require('./footer');"]}, {"lines": ["var SearchBar = require('./searchBar');"]}, {"lines": ["var ShareApp = {};", "", "ShareApp.ViewModel = function() {", "    var self = this;", "", "    self.time = 0;", "    self.page = 0;", "    self.count = 0;"]}, {"lines": ["    self.results = null;", "    self.query = m.prop($osf.urlParams().q || '');"]}, {"lines": ["    self.sort = m.prop($osf.urlParams().sort || 'Relevance');"]}, {"lines": ["    self.showStats = false;", "    self.showFooter = (self.query() === '');"]}, {"lines": ["    self.requiredFilters = $osf.urlParams().required ? $osf.urlParams().required.split('|') : [];", "    self.optionalFilters = $osf.urlParams().optional ? $osf.urlParams().optional.split('|') : [];"]}, {"lines": ["", "    self.sortProviders = function() {"]}, {"lines": ["        return $.map(Object.keys(self.ProviderMap), function(result, index){", "            return self.ProviderMap[result];"]}, {"lines": ["        }).sort(function(a,b){", "                return a.long_name.toUpperCase() > b.long_name.toUpperCase() ? 1: -1;", "        });", "    };"]}, {"lines": ["};", "", "", "ShareApp.view = function(ctrl) {"]}, {"lines": ["    return m('', [", "        m('.col-xs-12', ["]}, {"lines": ["            SearchBar.view(ctrl.searchBarController),", "            Stats.view(ctrl.statsController),"]}, {"lines": ["            ctrl.vm.results !== null ? renderSort(ctrl) : [],"]}, {"lines": ["            m('.row.search-content', ["]}, {"lines": ["               m('.col-md-2.col-lg-3', ["]}, {"lines": ["                    SideBar.view(ctrl.sideBarController)", "                ]),"]}, {"lines": ["                m('.col-md-10.col-lg-9', ["]}, {"lines": ["                    Results.view(ctrl.resultsController)", "                ])", "            ]),"]}, {"lines": ["            Footer.view(ctrl.footerController),"]}, {"lines": ["        ])"]}, {"lines": ["    ]);", "};", "", "ShareApp.controller = function() {", "    var self = this;", "", "    self.vm = new ShareApp.ViewModel(self.vm);"]}, {"lines": [""]}, {"lines": ["    History.replaceState({", "        query: self.vm.query(),", "        sort: self.vm.sort(),", "        optionalFilters: self.vm.optionalFilters,", "        requiredFilters: self.vm.requiredFilters", "    }, 'OSF | SHARE', '?' + utils.buildURLParams(self.vm));", "", ""]}, {"lines": ["    m.request({", "        method: 'get',", "        background: false,", "        url: '/api/v1/share/providers/'", "    }).then(function(data) {", "        self.vm.ProviderMap = data.providerMap;", "", "        self.sideBarController = new SideBar.controller(self.vm);", "        self.statsController = new Stats.controller(self.vm);", "        self.resultsController = new Results.controller(self.vm);", "        self.searchBarController = new SearchBar.controller(self.vm);"]}, {"lines": ["        self.footerController = new Footer.controller(self.vm);"]}, {"lines": ["    });"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        if (!utils.stateChanged(self.vm)){"]}, {"lines": ["            return;", "        }"]}, {"lines": [""]}, {"lines": ["        self.vm.optionalFilters = state.optionalFilters;", "        self.vm.requiredFilters = state.requiredFilters;"]}, {"lines": ["        self.vm.query(state.query);"]}, {"lines": ["        self.vm.sort(state.sort);"]}, {"lines": ["};", ""]}, {"lines": ["var renderSort = function(ctrl){"]}, {"lines": ["        return m('.btn-group.pull-right', ["]}, {"lines": ["            m('button.btn.btn-default.dropdown-toggle', {"]}, {"lines": ["                    'data-toggle': 'dropdown',", "                    'aria-expanded': 'false'", "                }, ['Sort by: ' + ctrl.vm.sort() + ' ', m('span.caret')]", "            ),"]}, {"lines": ["                m('ul.dropdown-menu', {'role': 'menu'}, ctrl.sideBarController.renderSort())]);"]}, {"lines": ["    };", "", ""]}, {"lines": ["module.exports = ShareApp;"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var m = require('mithril');"]}, {"lines": ["var utils = require('./utils');"]}, {"lines": ["", "var SearchBar = {};", ""]}, {"lines": ["SearchBar.view = function(ctrl) {", "    return [", "        m('.row', ["]}, {"lines": ["            m('.col-xs-12', {"]}, {"lines": ["                    style: {"]}, {"lines": ["                        margin: '30px auto',"]}, {"lines": ["                        display: 'block',"]}, {"lines": ["                        '-webkit-animation-duration': '3s'", "                    },"]}, {"lines": ["                }),"]}, {"lines": ["                m('div', {style: {color: 'darkgrey'}}, m('p.readable', ["]}, {"lines": ["            ])", "        ]),", "        m('.row', ["]}, {"lines": ["            m('.col-xs-12.col-lg-8.col-lg-offset-2', ["]}, {"lines": ["                m('form.input-group', {", "                    onsubmit: ctrl.search,", "                },["]}, {"lines": ["                        value: ctrl.vm.query(),", "                        onchange: m.withAttr('value', ctrl.vm.query),"]}, {"lines": ["                    }),"]}, {"lines": ["                    m('span.input-group-btn', ["]}, {"lines": ["                        m('button.btn.osf-search-btn', {", "                            'data-toggle': 'tooltip',", "                            'title': 'View search as ATOM feed',", "                            'data-placement': 'bottom',", "                            onclick: function(){"]}, {"lines": ["                                location.href = '/share/atom/?' + ctrl.atomParams();"]}, {"lines": ["                            }", "                        }, m('i.fa.fa-rss.fa-lg'))"]}, {"lines": ["                    ])", "                ])", "            ])", "        ])", "    ];", "};", "", "", "SearchBar.controller = function(vm) {", "    var self = this;", "", "    self.vm = vm;", "", "    self.vm.totalCount = 0;"]}, {"lines": ["    self.vm.providers = Object.keys(self.vm.ProviderMap).length;"]}, {"lines": ["    self.vm.latestDate = undefined;", "    self.vm.showStats = true;", ""]}, {"lines": ["    self.atomParams = function(){", "        var d = {};", "        d.q = utils.buildQuery(self.vm);", "        d.sort = self.vm.sortMap[self.vm.sort()] || null;", "        return $.param(d);", "    };", ""]}, {"lines": ["    self.search = function(e) {"]}, {"lines": ["    };", ""]}, {"lines": ["};", "", "", "module.exports = SearchBar;"]}, {"lines": ["var c3 = require('c3');", "var m = require('mithril');"]}, {"lines": ["var utils = require('./utils');"]}, {"lines": ["", "var Stats = {};", ""]}, {"lines": ["        utils.updateFilter(vm, 'source:' + d.name, true);"]}, {"lines": [""]}, {"lines": ["}", "", "Stats.view = function(ctrl) {", "    return ["]}, {"lines": ["        m('.row.search-helper', {style: {color: 'darkgrey'}},"]}, {"lines": ["            m('.col-xs-12.col-lg-8.col-lg-offset-2', [", "                m('.col-md-4', m('p.text-center', ctrl.vm.latestDate ? utils.formatNumber(ctrl.vm.totalCount) + ' events as of ' + new Date().toDateString() : '')),"]}, {"lines": ["                m('.col-md-4', m('p.text-center', ctrl.vm.providers + ' content providers'))", "            ])", "        ),"]}, {"lines": ["        m('.row', ctrl.vm.showStats ? ["]}, {"lines": ["                m('.row', m('.col-md-12', ["]}, {"lines": ["                    m('.row', (ctrl.vm.statsData && ctrl.vm.count > 0) ? ["]}, {"lines": ["                        m('.col-sm-3', ctrl.drawGraph('shareDonutGraph', donutGraph)),", "                        m('.col-sm-9', ctrl.drawGraph('shareTimeGraph', timeGraph))"]}, {"lines": ["                    ] : [])"]}, {"lines": ["                ]))", "            ]),", "        ] : []),", "        m('.row', [", "            m('col-md-12', m('a.stats-expand', {", "                onclick: function() {ctrl.vm.showStats = !ctrl.vm.showStats;}", "            },"]}, {"lines": ["            ))", "        ])", "    ];", "};", "", "Stats.controller = function(vm) {", "    var self = this;", "", "    self.vm = vm;"]}, {"lines": [""]}, {"lines": ["    self.vm.graphs = {};"]}, {"lines": ["    self.vm.totalCount = 0;"]}, {"lines": ["    self.vm.latestDate = undefined;"]}, {"lines": ["            if (i) {", "                return;", "            }"]}, {"lines": ["            self.vm.graphs[divId] = graphFunction(self.vm.statsData, self.vm);"]}, {"lines": [""]}, {"lines": ["    self.loadStats = function(){"]}, {"lines": ["        return utils.loadStats(self.vm);"]}, {"lines": ["    };", ""]}, {"lines": ["    m.request({", "        method: 'GET',"]}, {"lines": ["        url: '/api/v1/share/search/?size=1&v=1',"]}, {"lines": ["    }).then(function(data) {", "        self.vm.totalCount = data.count;", "        self.vm.latestDate = new $osf.FormattableDate(data.results[0].dateUpdated).local;"]}, {"lines": [""]}, {"lines": ["};", "", "module.exports = Stats;"]}, {"lines": ["        it('should parse date and datetime strings', () => {", "            var year = 2014;", "            var month = 11;", "            var day = 15;", "            var hour = 10;", "            var minute = 33;", "            var second = 17;", "            var millisecond = 123;", "", "            var dateString = [year, month, day].join('-');", "            var dateTimeString = dateString + 'T' + [hour, minute, second].join(':') + '.' + millisecond.toString();", "", "            var parsedDate = new $osf.FormattableDate(dateString).date;", "            var parsedDateTime = new $osf.FormattableDate(dateTimeString).date;", "", "            assert.equal(parsedDate.getUTCFullYear(), year);", "            assert.equal(parsedDate.getUTCMonth(), month - 1); // Javascript months count from 0", "            assert.equal(parsedDate.getUTCDate(), day);", "            assert.equal(parsedDate.getUTCHours(), 0);", "            assert.equal(parsedDate.getUTCMinutes(), 0);", "            assert.equal(parsedDate.getUTCSeconds(), 0);", "            assert.equal(parsedDate.getUTCMinutes(), 0);", "", "            assert.equal(parsedDateTime.getUTCFullYear(), year);", "            assert.equal(parsedDateTime.getUTCMonth(), month - 1); // Javascript months count from 0", "            assert.equal(parsedDateTime.getUTCDate(), day);", "            assert.equal(parsedDateTime.getUTCHours(), hour);", "            assert.equal(parsedDateTime.getUTCMinutes(), minute);", "            assert.equal(parsedDateTime.getUTCSeconds(), second);", "            assert.equal(parsedDateTime.getUTCMilliseconds(), millisecond);", "        });"]}, {"lines": ["var testUtils = require('tests/utils');"]}, {"lines": ["    var query = '';", "    var sort = 'sort';", ""]}, {"lines": ["            return sort;"]}, {"lines": ["        resultsLoading: resultsLoadingSpy,", "        query: function(){return query;},", "        optionalFilters: [],", "        requiredFilters: []"]}, {"lines": ["        var server;"]}, {"lines": ["", "        var emptyResponse = {", "            count: 0,", "            time: 0,", "            results: []", "        };", "", "        var endpoints = [{", "            method: 'GET',", "            url: /\\/api\\/v1\\/share\\/.*/,", "            response: emptyResponse", "        }];", ""]}, {"lines": ["            query = '';", "", "            server = testUtils.createServer(sinon, endpoints);"]}, {"lines": ["                return query;"]}, {"lines": ["            server.restore();"]}, {"lines": ["        it('returns a promise that resolves to null when buildQuery returns an empty query', (done) => {"]}, {"lines": ["", "        it('returns a promise that resolves to new data when called with a query', (done) => {", "            query = 'q=toast';", "            utils.loadMore(vm)", "                .then(function(data){", "                    assert.deepEqual(data, emptyResponse);", "                    done();", "                });", "        });", "    });", "", "    describe('#buildURLParams', () => {", "", "        afterEach(() => {", "            vm.optionalFilters = [];", "            vm.requiredFilters = [];", "            query = '';", "            sort = 'sort';", "        });", ""]}, {"lines": ["        it('builds url parameters of the form ?q=&required=&optional&sort=', () => {"]}, {"lines": ["            query = '1';", "            vm.requiredFilters.push('2');", "            vm.optionalFilters.push('3');", "            sort = '4';"]}, {"lines": ["            assert.equal('q=1&required=2&optional=3&sort=4', utils.buildURLParams(vm));"]}, {"lines": ["        });", "", "        it('doesn\\'t display parameters unless they have meaningful values', () => {", "            query = '1';", "            vm.requiredFilters.push('2');", "            sort = '4';"]}, {"lines": ["            assert.equal('q=1&required=2&sort=4', utils.buildURLParams(vm));"]}, {"lines": ["", "            vm.optionalFilters.push('3');", "            vm.requiredFilters = [];"]}, {"lines": ["            assert.equal('q=1&optional=3&sort=4', utils.buildURLParams(vm));"]}, {"lines": ["", "            vm.requiredFilters.push('2');", "            sort = null;"]}, {"lines": ["            assert.equal('q=1&required=2&optional=3', utils.buildURLParams(vm));"]}, {"lines": ["", "            sort = '4';", "            query = null;"]}, {"lines": ["            assert.equal('required=2&optional=3&sort=4', utils.buildURLParams(vm));"]}, {"lines": ["", "        });"]}, {"lines": ["    });", "", "    describe('#buildQuery', () => {", "        before(() => {", "            query = 'toast';", "        });", "        after(() => {", "            query = '';", "        });", "        afterEach(() => {", "            vm.optionalFilters = [];", "            vm.requiredFilters = [];", "        });", "", "", "        it('makes a query like query AND (optional) AND (required)', () => {", "            vm.optionalFilters.push('1');", "            vm.requiredFilters.push('2');", ""]}, {"lines": ["            assert.equal('toast AND (1) AND (2)', utils.buildQuery(vm));"]}, {"lines": ["        });", "", "        it('doesn\\'t create invalid queries with empty filters', () => {", "            vm.optionalFilters.push('1');"]}, {"lines": ["            assert.equal('toast AND (1)', utils.buildQuery(vm));"]}, {"lines": [""]}, {"lines": ["            vm.optionalFilters = [];", "            vm.requiredFilters.push('2');"]}, {"lines": ["            assert.equal('toast AND (2)', utils.buildQuery(vm));"]}, {"lines": ["        });"]}, {"lines": ["", "", "    describe('#updateFilter', () => {", "        var stub;", "", "        before(() => {", "            stub = sinon.stub(utils, 'search', function(){});", "        });", "", "        after(() => {", "            utils.search.restore();", "            vm.requiredFilters = [];", "            vm.optionalFilters = [];", "        });", "", "        it('adds filters to the optionalFilters unless it is already there or it is required', () => {", "            utils.updateFilter(vm, 'test');", "            assert.deepEqual(['test'], vm.optionalFilters);", "", "            utils.updateFilter(vm, 'test');", "            assert.deepEqual(['test'], vm.optionalFilters);", "", "            utils.updateFilter(vm, 'test', true);", "            assert.deepEqual(['test'], vm.optionalFilters);", "        });", "", "        it('adds filters to the required filters only if required is true and the filter is not already there', () => {", "            utils.updateFilter(vm, 'test', true);", "            assert.deepEqual(['test'], vm.requiredFilters);", "", "            utils.updateFilter(vm, 'test', true);", "            assert.deepEqual(['test'], vm.requiredFilters);", "", "            utils.updateFilter(vm, 'toast');", "            assert.deepEqual(['test'], vm.requiredFilters);", "        });", "", "    });", "", "    describe('#removeFilter', () => {", "        var stub;", "", "        before(() => {", "            stub = sinon.stub(utils, 'search', function(){});", "        });", "", "        after(() => {", "            utils.search.restore();", "        });", "", "        it('removes filters from optional and required', () => {", "            utils.updateFilter(vm, 'test');", "            utils.updateFilter(vm, 'test', true);", "            assert.deepEqual(['test'], vm.optionalFilters);", "            assert.deepEqual(['test'], vm.requiredFilters);", "", "            utils.removeFilter(vm, 'test');", "            assert.deepEqual([], vm.optionalFilters);", "            assert.deepEqual([], vm.requiredFilters);", "            utils.removeFilter(vm, 'test');", "            assert.deepEqual([], vm.optionalFilters);", "            assert.deepEqual([], vm.requiredFilters);", "        });", "", "    });"]}], "name": "Fabian von Feilitzsch"}, {"commits": [{"lines": ["    'login-page': staticPath('js/pages/login-page.js'),"]}, {"lines": ["    retractions = ensure_item(cron, 'bash {}'.format(app_prefix('scripts/retract_registrations.sh')))"]}, {"lines": [""]}, {"lines": ["    embargoes = ensure_item(cron, 'bash {}'.format(app_prefix('scripts/embargo_registrations.sh')))"]}, {"lines": [""]}, {"lines": ["\"\"\"Script for sending OSF emails to all users who contribute to registrations.\"\"\"", ""]}, {"lines": ["import datetime", "import logging", ""]}, {"lines": ["from modularodm import Q", "", "from website import models", "from website.app import init_app", "from website.mails import Mail, send_mail", ""]}, {"lines": ["from scripts import utils as script_utils", "", "", "logger = logging.getLogger(__name__)", "logging.basicConfig(level=logging.INFO)", "", "MESSAGE_NAME = 'retraction_and_embargo_addition'", "MAILER = Mail(", "    'email_contributors_of_registrations',", "    'Important Update to Registrations on OSF'", ")", "", "", "def send_retraction_and_embargo_addition_message(contrib, label, mail, dry_run=True):", "    if label in contrib.security_messages:", "        return"]}, {"lines": ["    if not dry_run:"]}, {"lines": ["        send_mail(contrib.username, mail, user=contrib)"]}, {"lines": ["        contrib.security_messages[MESSAGE_NAME] = datetime.datetime.utcnow()", "        contrib.save()"]}, {"lines": [""]}, {"lines": ["", "def get_registration_contributors():", "    \"\"\"Returns set of users that contribute to registrations.\"\"\""]}, {"lines": ["    registrations = models.Node.find(Q('is_registration', 'eq', True))", "    contributors = []"]}, {"lines": ["", "    def has_received_message(contrib):", "        query = (Q('_id', 'eq', contrib._id) & Q('security_messages.{0}'.format(MESSAGE_NAME), 'exists', False))"]}, {"lines": [""]}, {"lines": ["    for node in registrations:"]}, {"lines": ["        contributors.extend([contrib for contrib in node.contributors if contrib not in contributors and not has_received_message(contrib)])"]}, {"lines": [""]}, {"lines": ["    return contributors", "", "", "def main(dry_run):", "    contributors = get_registration_contributors()"]}, {"lines": [""]}, {"lines": ["    for contrib in contributors:"]}, {"lines": ["        send_retraction_and_embargo_addition_message(contrib, MESSAGE_NAME, MAILER, dry_run=dry_run)", ""]}, {"lines": ["", "if __name__ == '__main__':"]}, {"lines": ["    import sys"]}, {"lines": ["    dry_run = 'dry' in sys.argv"]}, {"lines": ["    init_app(routes=False, mfr=False)"]}, {"lines": ["    main(dry_run)"]}, {"lines": ["\"\"\"Script for retracting pending retractions that are more than 48 hours old.\"\"\"", "", "import datetime", "import logging", "import sys", "", "from modularodm import Q", ""]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["from website import models, settings", "from website.app import init_app"]}, {"lines": ["from website.project.model import NodeLog"]}, {"lines": ["from scripts import utils as scripts_utils", "", "", "logger = logging.getLogger(__name__)", "logging.basicConfig(level=logging.INFO)", "", "", "def main(dry_run=True):"]}, {"lines": ["    pending_retractions = models.Retraction.find(Q('state', 'eq', models.Retraction.PENDING))"]}, {"lines": ["    for retraction in pending_retractions:", "        if should_be_retracted(retraction):"]}, {"lines": ["            if dry_run:", "                logger.warn('Dry run mode')"]}, {"lines": ["            logger.warn(", "                'Retraction {0} approved. Retracting registration {1}'", "                .format(retraction._id, parent_registration._id)", "            )"]}, {"lines": ["            if not dry_run:"]}, {"lines": ["", "", "def should_be_retracted(retraction):", "    \"\"\"Returns true if retraction was initiated more than 48 hours prior\"\"\""]}, {"lines": ["    return (datetime.datetime.utcnow() - retraction.initiation_date) >= settings.RETRACTION_PENDING_TIME"]}, {"lines": ["", "", "if __name__ == '__main__':", "    dry_run = 'dry' in sys.argv"]}, {"lines": ["    if not dry_run:", "        scripts_utils.add_file_logger(logger, __file__)"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from datetime import date, datetime, timedelta", "from nose.tools import *  # noqa", "", "from tests.base import OsfTestCase", "from tests.factories import RegistrationFactory", "from tests.factories import UserFactory", "", "from scripts.embargo_registrations import main", "", "", "class TestRetractRegistrations(OsfTestCase):", "", "    def setUp(self):", "        super(TestRetractRegistrations, self).setUp()", "        self.user = UserFactory()", "        self.registration = RegistrationFactory(creator=self.user)"]}, {"lines": ["        self.registration.embargo_registration(", "            self.user,"]}, {"lines": ["            datetime.utcnow() + timedelta(days=10)"]}, {"lines": ["        )", "        self.registration.save()", "", "    def test_new_embargo_should_be_unapproved(self):", "        assert_true(self.registration.pending_embargo)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["", "        main(dry_run=False)", "        assert_true(self.registration.pending_embargo)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["", "    def test_should_not_activate_pending_embargo_less_than_48_hours_old(self):", "        # Embargo#iniation_date is read only", "        self.registration.embargo._fields['initiation_date'].__set__(", "            self.registration.embargo,", "            (datetime.utcnow() - timedelta(hours=47)),", "            safe=True", "        )", "        self.registration.embargo.save()"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["", "        main(dry_run=False)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["", "    def test_should_activate_pending_embargo_that_is_48_hours_old(self):", "        # Embargo#iniation_date is read only", "        self.registration.embargo._fields['initiation_date'].__set__(", "            self.registration.embargo,", "            (datetime.utcnow() - timedelta(hours=48)),", "            safe=True", "        )", "        self.registration.embargo.save()", "        assert_true(self.registration.pending_embargo)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["", "        main(dry_run=False)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_true(self.registration.embargo_end_date)"]}, {"lines": ["", "    def test_should_activate_pending_embargo_more_than_48_hours_old(self):", "        # Embargo#iniation_date is read only", "        self.registration.embargo._fields['initiation_date'].__set__(", "            self.registration.embargo,", "            (datetime.utcnow() - timedelta(days=365)),", "            safe=True", "        )", "        self.registration.embargo.save()", "        assert_true(self.registration.pending_embargo)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["", "        main(dry_run=False)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_true(self.registration.embargo_end_date)"]}, {"lines": ["", "    def test_embargo_past_end_date_should_be_completed(self):", "        approval_token = self.registration.embargo.approval_state[self.user._id]['approval_token']", "        self.registration.embargo.approve_embargo(self.user, approval_token)", "        self.registration.save()"]}, {"lines": ["        assert_true(self.registration.embargo_end_date)"]}, {"lines": ["        assert_false(self.registration.pending_embargo)", "", "        # Embargo#iniation_date is read only", "        self.registration.embargo._fields['end_date'].__set__(", "            self.registration.embargo,", "            (datetime.utcnow() - timedelta(days=1)),", "            safe=True", "        )", "        self.registration.embargo.save()", "", "        assert_false(self.registration.is_public)", "        main(dry_run=False)", "        assert_true(self.registration.is_public)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["        assert_false(self.registration.pending_embargo)", "        assert_equal(self.registration.embargo.state, 'completed')", "", "    def test_embargo_before_end_date_should_not_be_completed(self):", "        approval_token = self.registration.embargo.approval_state[self.user._id]['approval_token']", "        self.registration.embargo.approve_embargo(self.user, approval_token)", "        self.registration.save()"]}, {"lines": ["        assert_true(self.registration.embargo_end_date)"]}, {"lines": ["        assert_false(self.registration.pending_embargo)", "", "        # Embargo#iniation_date is read only", "        self.registration.embargo._fields['end_date'].__set__(", "            self.registration.embargo,", "            (datetime.utcnow() + timedelta(days=1)),", "            safe=True", "        )", "        self.registration.embargo.save()", "", "        assert_false(self.registration.is_public)", "        main(dry_run=False)", "        assert_false(self.registration.is_public)"]}, {"lines": ["        assert_true(self.registration.embargo_end_date)"]}, {"lines": ["        assert_false(self.registration.pending_embargo)"]}, {"lines": [""]}, {"lines": ["        # Embargo#iniation_date is read only", "        self.registration.embargo._fields['initiation_date'].__set__(", "            self.registration.embargo,", "            (datetime.utcnow() - timedelta(days=365)),", "            safe=True", "        )", "        self.registration.embargo.save()", "", "        main(dry_run=False)"]}, {"lines": [""]}, {"lines": ["        approval_token = self.registration.embargo.approval_state[self.user._id]['approval_token']", "        self.registration.embargo.approve_embargo(self.user, approval_token)", "        self.registration.save()", "", "        # Embargo#iniation_date is read only", "        self.registration.embargo._fields['end_date'].__set__(", "            self.registration.embargo,", "            (datetime.utcnow() - timedelta(days=1)),", "            safe=True", "        )", "        self.registration.embargo.save()", "", "        main(dry_run=False)"]}, {"lines": ["class TestRegistrationRetractions(SearchTestCase):"]}, {"lines": [""]}, {"lines": ["    def setUp(self):", "        super(TestRegistrationRetractions, self).setUp()", "        self.user = UserFactory(usename='Doug Bogie')", "        self.title = 'Red Special'", "        self.consolidate_auth = Auth(user=self.user)", "        self.project = ProjectFactory(", "            title=self.title,", "            creator=self.user,", "            is_public=True,", "        )", "        self.registration = RegistrationFactory(", "            project=self.project,", "            title=self.title,", "            creator=self.user,", "            is_public=True,", "            is_registration=True", "        )", "", "    def test_retraction_is_searchable(self):", "", "        self.registration.retract_registration(self.user)", "        docs = query('category:registration AND ' + self.title)['results']", "        assert_equal(len(docs), 1)", ""]}, {"lines": ["    def test_pending_retraction_wiki_content_is_searchable(self):", "        # Add unique string to wiki", "        wiki_content = {'home': 'public retraction test'}", "        for key, value in wiki_content.items():", "            docs = query(value)['results']", "            assert_equal(len(docs), 0)", "            self.registration.update_node_wiki(", "                key, value, self.consolidate_auth,", "            )", "            # Query and ensure unique string shows up", "            docs = query(value)['results']", "            assert_equal(len(docs), 1)", "", "        # Query and ensure registration does show up", "        docs = query('category:registration AND ' + self.title)['results']", "        assert_equal(len(docs), 1)", "", "        # Retract registration", "        self.registration.retract_registration(self.user, '')", "        self.registration.save()", "        self.registration.reload()", "", "        # Query and ensure unique string in wiki doesn't show up", "        docs = query('category:registration AND \"{}\"'.format(wiki_content['home']))['results']", "        assert_equal(len(docs), 1)", "", "        # Query and ensure registration does show up", "        docs = query('category:registration AND ' + self.title)['results']", "        assert_equal(len(docs), 1)", ""]}, {"lines": ["    def test_retraction_wiki_content_is_not_searchable(self):", "        # Add unique string to wiki", "        wiki_content = {'home': 'public retraction test'}", "        for key, value in wiki_content.items():", "            docs = query(value)['results']", "            assert_equal(len(docs), 0)", "            self.registration.update_node_wiki(", "                key, value, self.consolidate_auth,", "            )", "            # Query and ensure unique string shows up", "            docs = query(value)['results']", "            assert_equal(len(docs), 1)", "", "        # Query and ensure registration does show up", "        docs = query('category:registration AND ' + self.title)['results']", "        assert_equal(len(docs), 1)", "", "        # Retract registration", "        self.registration.retract_registration(self.user, '')"]}, {"lines": ["        self.registration.retraction.state = 'retracted'", "        self.registration.retraction.save()"]}, {"lines": ["        self.registration.save()"]}, {"lines": ["", "        # Query and ensure unique string in wiki doesn't show up", "        docs = query('category:registration AND \"{}\"'.format(wiki_content['home']))['results']", "        assert_equal(len(docs), 0)", "", "        # Query and ensure registration does show up", "        docs = query('category:registration AND ' + self.title)['results']", "        assert_equal(len(docs), 1)", "", "", "@requires_search"]}, {"lines": ["\"\"\"Tests related to project decorators\"\"\"", "", "from nose.tools import *  # noqa", "", "from website.project.decorators import must_be_valid_project", "", "from tests.base import OsfTestCase"]}, {"lines": ["from tests.factories import ProjectFactory, NodeFactory, RetractionFactory"]}, {"lines": ["", "from framework.exceptions import HTTPError", "", "", "@must_be_valid_project", "def valid_project_helper(**kwargs):", "    return kwargs", ""]}, {"lines": ["@must_be_valid_project(retractions_valid=True)"]}, {"lines": ["def as_factory_allow_retractions(**kwargs):", "    return kwargs", "", "", "class TestValidProject(OsfTestCase):", "", "    def setUp(self):", "        super(TestValidProject, self).setUp()", "        self.project = ProjectFactory()", "        self.node = NodeFactory(project=self.project)"]}, {"lines": ["        self.retraction = RetractionFactory()"]}, {"lines": [""]}, {"lines": ["    def test_populates_kwargs_node(self):"]}, {"lines": ["        res = valid_project_helper(pid=self.project._id)"]}, {"lines": ["        assert_equal(res['node'], self.project)", "        assert_is_none(res['parent'])"]}, {"lines": [""]}, {"lines": ["    def test_populates_kwargs_node_and_parent(self):"]}, {"lines": ["        res = valid_project_helper(pid=self.project._id, nid=self.node._id)"]}, {"lines": ["        assert_equal(res['parent'], self.project)"]}, {"lines": ["        assert_equal(res['node'], self.node)", "", "    def test_project_not_found(self):", "        with assert_raises(HTTPError) as exc_info:", "            valid_project_helper(pid='fakepid')", "        assert_equal(exc_info.exception.code, 404)", ""]}, {"lines": ["    def test_project_deleted(self):", "        self.project.is_deleted = True", "        self.project.save()", "        with assert_raises(HTTPError) as exc_info:", "            valid_project_helper(pid=self.project._id)", "        assert_equal(exc_info.exception.code, 410)", "", "    def test_node_not_found(self):", "        with assert_raises(HTTPError) as exc_info:", "            valid_project_helper(pid=self.project._id, nid='fakenid')", "        assert_equal(exc_info.exception.code, 404)", "", "    def test_node_deleted(self):", "        self.node.is_deleted = True", "        self.node.save()", "        with assert_raises(HTTPError) as exc_info:", "            valid_project_helper(pid=self.project._id, nid=self.node._id)", "        assert_equal(exc_info.exception.code, 410)", "", "    def test_valid_project_as_factory_allow_retractions_is_retracted(self):", "        self.project.is_registration = True"]}, {"lines": ["        self.project.retraction = self.retraction", "        self.retraction.state = 'retracted'", "        self.retraction.save()"]}, {"lines": ["        res = as_factory_allow_retractions(pid=self.project._id)"]}, {"lines": ["        assert_equal(res['node'], self.project)"]}, {"lines": ["\"\"\"Tests related to retraction of public registrations\"\"\"", ""]}, {"lines": ["import datetime"]}, {"lines": [""]}, {"lines": ["from nose.tools import *  # noqa"]}, {"lines": ["from tests.base import fake, OsfTestCase"]}, {"lines": ["from tests.factories import (", "    AuthUserFactory, NodeFactory, ProjectFactory,"]}, {"lines": [")"]}, {"lines": [""]}, {"lines": ["from modularodm.exceptions import ValidationValueError"]}, {"lines": ["from framework.exceptions import PermissionsError", "from website.exceptions import (", "    InvalidRetractionApprovalToken, InvalidRetractionDisapprovalToken,", "    NodeStateError,", ")"]}, {"lines": ["from website.models import Retraction"]}, {"lines": ["", "", "class RegistrationRetractionModelsTestCase(OsfTestCase):", "    def setUp(self):", "        super(RegistrationRetractionModelsTestCase, self).setUp()", "        self.user = UserFactory()"]}, {"lines": ["        self.registration = RegistrationFactory(creator=self.user, is_public=True)"]}, {"lines": ["        self.valid_justification = fake.sentence()", "        self.invalid_justification = fake.text(max_nb_chars=3000)"]}, {"lines": [""]}, {"lines": ["    # Validator tests"]}, {"lines": ["    def test_invalid_state_raises_ValidationValueError(self):"]}, {"lines": ["        self.registration.retract_registration(self.user)", "        with assert_raises(ValidationValueError):", "            self.registration.retraction.state = 'invalid_state'", "            self.registration.retraction.save()", ""]}, {"lines": ["    def test_set_public_registration_to_private_raises_NodeStateException(self):"]}, {"lines": ["        self.registration.save()"]}, {"lines": ["        with assert_raises(NodeStateError):", "            self.registration.set_privacy('private')", "        self.registration.reload()", "", "        assert_true(self.registration.is_public)"]}, {"lines": [""]}, {"lines": ["    # Node#_initiate_retraction tests"]}, {"lines": ["    def test_initiate_retraction_does_not_save_retraction(self):"]}, {"lines": ["        initial_count = Retraction.find().count()", "        self.registration._initiate_retraction(self.user)", "        self.assertEqual(Retraction.find().count(), initial_count)", ""]}, {"lines": ["    def test_initiate_retraction_with_save_does_save_retraction(self):"]}, {"lines": ["        initial_count = Retraction.find().count()", "        self.registration._initiate_retraction(self.user, save=True)", "        self.assertEqual(Retraction.find().count(), initial_count + 1)", ""]}, {"lines": ["    # Backref tests", "    def test_retraction_initiator_has_backref(self):", "        self.registration.retract_registration(self.user, self.valid_justification)", "        self.registration.save()", "        self.registration.reload()", "        assert_equal(len(self.user.retraction__retracted), 1)", ""]}, {"lines": ["    # Node#retract_registration tests", "    def test_pending_retract(self):", "        self.registration.retract_registration(self.user, self.valid_justification)", "        self.registration.save()"]}, {"lines": ["        self.registration.reload()"]}, {"lines": ["", "        assert_false(self.registration.retraction.is_retracted)"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.PENDING)"]}, {"lines": ["        assert_equal(self.registration.retraction.justification, self.valid_justification)", "        assert_equal(self.registration.retraction.initiated_by, self.user)", "        assert_equal(", "            self.registration.retraction.initiation_date.date(),", "            datetime.datetime.utcnow().date()", "        )", ""]}, {"lines": ["    def test_long_justification_raises_ValidationValueError(self):", "        with assert_raises(ValidationValueError):", "            self.registration.retract_registration(self.user, self.invalid_justification)", "            self.registration.save()", "        self.registration.reload()", "        assert_is_none(self.registration.retraction)", "", "    def test_retract_private_registration_raises_NodeStateError(self):", "        self.registration.is_public = False", "        with assert_raises(NodeStateError):", "            self.registration.retract_registration(self.user, self.valid_justification)", "            self.registration.save()", "        self.registration.reload()", "        assert_is_none(self.registration.retraction)", ""]}, {"lines": ["    def test_retract_public_non_registration_raises_NodeStateError(self):"]}, {"lines": ["        project = ProjectFactory(is_public=True, creator=self.user)", "        project.save()", "        with assert_raises(NodeStateError):", "            project.retract_registration(self.user, self.valid_justification)", "", "        project.reload()", "        assert_is_none(project.retraction)", ""]}, {"lines": ["    def test_retraction_of_registration_pending_embargo_cancels_embargo(self):", "        self.registration.embargo_registration(", "            self.user,", "            (datetime.date.today() + datetime.timedelta(days=10)),", "            for_existing_registration=True", "        )", "        self.registration.save()", "        assert_true(self.registration.pending_embargo)", "", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, approval_token)", "        assert_false(self.registration.pending_retraction)", "        assert_true(self.registration.is_retracted)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["        assert_equal(self.registration.embargo.state, Retraction.CANCELLED)"]}, {"lines": ["", "    def test_retraction_of_registration_in_active_embargo_cancels_embargo(self):", "        self.registration.embargo_registration(", "            self.user,", "            (datetime.date.today() + datetime.timedelta(days=10)),", "            for_existing_registration=True", "        )", "        self.registration.save()", "        assert_true(self.registration.pending_embargo)", "", "        embargo_approval_token = self.registration.embargo.approval_state[self.user._id]['approval_token']", "        self.registration.embargo.approve_embargo(self.user, embargo_approval_token)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_true(self.registration.embargo_end_date)"]}, {"lines": ["", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        retraction_approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, retraction_approval_token)", "        assert_false(self.registration.pending_retraction)", "        assert_true(self.registration.is_retracted)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["        assert_equal(self.registration.embargo.state, Retraction.CANCELLED)"]}, {"lines": [""]}, {"lines": ["    # Retraction#approve_retraction_tests", "    def test_invalid_approval_token_raises_InvalidRetractionApprovalToken(self):", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        with assert_raises(InvalidRetractionApprovalToken):", "            self.registration.retraction.approve_retraction(self.user, fake.sentence())", "        assert_true(self.registration.pending_retraction)", "        assert_false(self.registration.is_retracted)", "", "    def test_non_admin_approval_token_raises_PermissionsError(self):", "        non_admin = UserFactory()", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        with assert_raises(PermissionsError):", "            self.registration.retraction.approve_retraction(non_admin, approval_token)", "        assert_true(self.registration.pending_retraction)", "        assert_false(self.registration.is_retracted)"]}, {"lines": [""]}, {"lines": ["    def test_one_approval_with_one_admin_retracts(self):"]}, {"lines": ["        self.registration.retract_registration(self.user)", "        self.registration.save()", ""]}, {"lines": ["        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.PENDING)"]}, {"lines": ["        self.registration.retraction.approve_retraction(self.user, approval_token)", "        assert_true(self.registration.retraction.is_retracted)"]}, {"lines": ["        num_of_approvals = sum([val['has_approved'] for val in self.registration.retraction.approval_state.values()])", "        assert_equal(num_of_approvals, 1)"]}, {"lines": [""]}, {"lines": ["        self.registration.retract_registration(self.user)", "        self.registration.save()", "", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, approval_token)"]}, {"lines": [""]}, {"lines": ["    def test_retraction_of_registration_pending_embargo_cancels_embargo(self):", "        self.registration.is_public = True", "        self.registration.embargo_registration(", "            self.user,"]}, {"lines": ["            datetime.datetime.utcnow() + datetime.timedelta(days=10),"]}, {"lines": ["            for_existing_registration=True", "        )", "        self.registration.save()", "        assert_true(self.registration.pending_embargo)", "", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, approval_token)", "        assert_false(self.registration.pending_retraction)", "        assert_true(self.registration.is_retracted)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["        assert_equal(self.registration.embargo.state, Retraction.CANCELLED)"]}, {"lines": [""]}, {"lines": ["        self.registration.is_public = True", "        self.registration.embargo_registration(", "            self.user,", "            datetime.datetime.utcnow() + datetime.timedelta(days=10),", "            for_existing_registration=True", "        )", "        self.registration.save()", "", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, approval_token)"]}, {"lines": [""]}, {"lines": ["    def test_retraction_of_registration_in_active_embargo_cancels_embargo(self):", "        self.registration.is_public = True", "        self.registration.embargo_registration(", "            self.user,"]}, {"lines": ["            datetime.datetime.utcnow() + datetime.timedelta(days=10),"]}, {"lines": ["            for_existing_registration=True", "        )", "        self.registration.save()", "        assert_true(self.registration.pending_embargo)", "", "        embargo_approval_token = self.registration.embargo.approval_state[self.user._id]['approval_token']", "        self.registration.embargo.approve_embargo(self.user, embargo_approval_token)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_true(self.registration.embargo_end_date)"]}, {"lines": ["", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        retraction_approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, retraction_approval_token)", "        assert_false(self.registration.pending_retraction)", "        assert_true(self.registration.is_retracted)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["        assert_equal(self.registration.embargo.state, Retraction.CANCELLED)"]}, {"lines": [""]}, {"lines": ["    def test_two_approvals_with_two_admins_retracts(self):", "        self.admin2 = UserFactory()", "        self.registration.contributors.append(self.admin2)", "        self.registration.add_permission(self.admin2, 'admin', save=True)"]}, {"lines": ["        self.registration.retract_registration(self.user)", "        self.registration.save()"]}, {"lines": ["        self.registration.reload()"]}, {"lines": [""]}, {"lines": ["        # First admin approves", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, approval_token)"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.PENDING)"]}, {"lines": ["        num_of_approvals = sum([val['has_approved'] for val in self.registration.retraction.approval_state.values()])", "        assert_equal(num_of_approvals, 1)"]}, {"lines": ["", "        # Second admin approves", "        approval_token = self.registration.retraction.approval_state[self.admin2._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.admin2, approval_token)"]}, {"lines": ["        num_of_approvals = sum([val['has_approved'] for val in self.registration.retraction.approval_state.values()])", "        assert_equal(num_of_approvals, 2)"]}, {"lines": ["        assert_true(self.registration.retraction.is_retracted)", "", "    def test_one_approval_with_two_admins_stays_pending(self):"]}, {"lines": ["        self.admin2 = UserFactory()", "        self.registration.contributors.append(self.admin2)", "        self.registration.add_permission(self.admin2, 'admin', save=True)"]}, {"lines": ["", "        self.registration.retract_registration(self.user)", "        self.registration.save()"]}, {"lines": ["        self.registration.reload()"]}, {"lines": [""]}, {"lines": ["        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.PENDING)"]}, {"lines": ["        self.registration.retraction.approve_retraction(self.user, approval_token)"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.PENDING)"]}, {"lines": ["        num_of_approvals = sum([val['has_approved'] for val in self.registration.retraction.approval_state.values()])"]}, {"lines": ["        assert_equal(num_of_approvals, 1)"]}, {"lines": [""]}, {"lines": ["    # Retraction#disapprove_retraction tests", "    def test_invalid_disapproval_token_raises_InvalidRetractionDisapprovalToken(self):", "        self.registration.retract_registration(self.user)"]}, {"lines": ["        self.registration.save()"]}, {"lines": ["        assert_true(self.registration.pending_retraction)"]}, {"lines": [""]}, {"lines": ["        with assert_raises(InvalidRetractionDisapprovalToken):", "            self.registration.retraction.disapprove_retraction(self.user, fake.sentence())", "        assert_true(self.registration.pending_retraction)", "        assert_false(self.registration.is_retracted)", "", "    def test_non_admin_disapproval_token_raises_PermissionsError(self):", "        non_admin = UserFactory()", "        self.registration.retract_registration(self.user)"]}, {"lines": ["        self.registration.save()"]}, {"lines": ["        assert_true(self.registration.pending_retraction)"]}, {"lines": [""]}, {"lines": ["        disapproval_token = self.registration.retraction.approval_state[self.user._id]['disapproval_token']", "        with assert_raises(PermissionsError):", "            self.registration.retraction.disapprove_retraction(non_admin, disapproval_token)", "        assert_true(self.registration.pending_retraction)", "        assert_false(self.registration.is_retracted)", "", "    def test_one_disapproval_cancels_retraction(self):", "        self.registration.retract_registration(self.user)", "        self.registration.save()"]}, {"lines": ["        self.registration.reload()"]}, {"lines": ["", "        disapproval_token = self.registration.retraction.approval_state[self.user._id]['disapproval_token']"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.PENDING)"]}, {"lines": ["        self.registration.retraction.disapprove_retraction(self.user, disapproval_token)"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.CANCELLED)"]}, {"lines": [""]}, {"lines": ["        self.registration.retract_registration(self.user)", "        self.registration.save()", "        self.registration.reload()", "", "        disapproval_token = self.registration.retraction.approval_state[self.user._id]['disapproval_token']", "        self.registration.retraction.disapprove_retraction(self.user, disapproval_token)"]}, {"lines": [""]}, {"lines": ["    # Retraction property tests", "    def test_new_retraction_is_pending_retraction(self):", "        self.registration.retract_registration(self.user)", "        assert_true(self.registration.pending_retraction)", "        assert_false(self.registration.is_retracted)", "", ""]}, {"lines": ["class RegistrationWithChildNodesRetractionModelTestCase(OsfTestCase):", "    def setUp(self):", "        super(RegistrationWithChildNodesRetractionModelTestCase, self).setUp()", "        self.user = AuthUserFactory()", "        self.auth = self.user.auth", "        self.project = ProjectFactory(is_public=True, creator=self.user)", "        self.component = NodeFactory(", "            creator=self.user,", "            parent=self.project,", "            title='Component'", "        )", "        self.subproject = ProjectFactory(", "            creator=self.user,", "            parent=self.project,", "            title='Subproject'", "        )", "        self.subproject_component = NodeFactory(", "            creator=self.user,", "            parent=self.subproject,", "            title='Subcomponent'", "        )", "        self.registration = RegistrationFactory(project=self.project)", "        # Reload the registration; else tests won't catch failures to svae", "        self.registration.reload()", "", "    def test_approval_retracts_descendant_nodes(self):", "        # Initiate retraction for parent registration", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        # Ensure descendant nodes are pending registration", "        descendants = self.registration.get_descendants_recursive()", "        for node in descendants:", "            node.save()", "            assert_true(node.pending_retraction)", "", "        # Approve parent registration's retraction", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, approval_token)", "        assert_true(self.registration.is_retracted)", "", "        # Ensure descendant nodes are retracted", "        descendants = self.registration.get_descendants_recursive()", "        for node in descendants:", "            assert_true(node.is_retracted)", "", "    def test_disapproval_cancels_retraction_on_descendant_nodes(self):", "        # Initiate retraction for parent registration", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        # Ensure descendant nodes are pending registration", "        descendants = self.registration.get_descendants_recursive()", "        for node in descendants:", "            node.save()", "            assert_true(node.pending_retraction)", "", "        # Disapprove parent registration's retraction", "        disapproval_token = self.registration.retraction.approval_state[self.user._id]['disapproval_token']", "        self.registration.retraction.disapprove_retraction(self.user, disapproval_token)", "        assert_false(self.registration.pending_retraction)", "        assert_false(self.registration.is_retracted)", "        assert_equal(self.registration.retraction.state, Retraction.CANCELLED)", "", "        # Ensure descendant nodes' retractions are cancelled", "        descendants = self.registration.get_descendants_recursive()", "        for node in descendants:", "            assert_false(node.pending_retraction)", "            assert_false(node.is_retracted)", "", "    def test_approval_cancels_pending_embargoes_on_descendant_nodes(self):", "        # Initiate embargo for registration", "        self.registration.embargo_registration(", "            self.user,"]}, {"lines": ["            datetime.datetime.utcnow() + datetime.timedelta(days=10),"]}, {"lines": ["            for_existing_registration=True", "        )", "        self.registration.save()", "        assert_true(self.registration.pending_embargo)", "", "        # Initiate retraction for parent registration", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", ""]}, {"lines": ["        descendants = self.registration.get_descendants_recursive()", "        for node in descendants:", "            assert_true(node.pending_retraction)", "            assert_true(node.pending_embargo)", "", "        # Approve parent registration's retraction", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, approval_token)", "        assert_true(self.registration.is_retracted)", "        assert_false(self.registration.pending_embargo)", "", "        # Ensure descendant nodes are not pending embargo", "        descendants = self.registration.get_descendants_recursive()", "        for node in descendants:", "            assert_true(node.is_retracted)", "            assert_false(node.pending_embargo)", "", "    def test_approval_cancels_active_embargoes_on_descendant_nodes(self):", "        # Initiate embargo for registration", "        self.registration.embargo_registration(", "            self.user,"]}, {"lines": ["            datetime.datetime.utcnow() + datetime.timedelta(days=10),"]}, {"lines": ["            for_existing_registration=True", "        )", "        self.registration.save()", "        assert_true(self.registration.pending_embargo)", "", "        # Approve embargo for registration", "        embargo_approval_token = self.registration.embargo.approval_state[self.user._id]['approval_token']", "        self.registration.embargo.approve_embargo(self.user, embargo_approval_token)", "        assert_false(self.registration.pending_embargo)"]}, {"lines": ["        assert_true(self.registration.embargo_end_date)"]}, {"lines": ["", "        # Initiate retraction for parent registration", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        # Ensure descendant nodes are not pending embargo", "        descendants = self.registration.get_descendants_recursive()", "        for node in descendants:", "            assert_true(node.pending_retraction)"]}, {"lines": ["            assert_true(node.embargo_end_date)"]}, {"lines": ["", "        # Approve parent registration's retraction", "        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        self.registration.retraction.approve_retraction(self.user, approval_token)", "        assert_true(self.registration.is_retracted)"]}, {"lines": ["        assert_false(self.registration.embargo_end_date)"]}, {"lines": ["", "        # Ensure descendant nodes are not pending embargo", "        descendants = self.registration.get_descendants_recursive()", "        for node in descendants:", "            assert_true(node.is_retracted)"]}, {"lines": ["            assert_false(node.embargo_end_date)"]}, {"lines": ["", ""]}, {"lines": ["class RegistrationRetractionApprovalDisapprovalViewsTestCase(OsfTestCase):", "    def setUp(self):", "        super(RegistrationRetractionApprovalDisapprovalViewsTestCase, self).setUp()", "        self.user = AuthUserFactory()", "        self.auth = self.user.auth", "        self.registration = RegistrationFactory(is_public=True, creator=self.user)", "", "    # node_registration_retraction_approve_tests", "    def test_GET_approve_from_unauthorized_user_raises_HTTPForbidden(self):", "        unauthorized_user = AuthUserFactory()", "", "        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_approve', token=fake.sentence()),", "            auth=unauthorized_user.auth,", "            expect_errors=True"]}, {"lines": ["        )"]}, {"lines": ["        assert_equal(res.status_code, 403)"]}, {"lines": [""]}, {"lines": ["    def test_GET_approve_registration_without_retraction_returns_HTTPBad_Request(self):", "        assert_false(self.registration.pending_retraction)"]}, {"lines": [""]}, {"lines": ["        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_approve', token=fake.sentence()),", "            auth=self.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)", "", "    def test_GET_approve_with_invalid_token_returns_HTTPBad_Request(self):", "        self.registration.retract_registration(self.user)"]}, {"lines": ["        self.registration.save()"]}, {"lines": ["        assert_true(self.registration.pending_retraction)"]}, {"lines": [""]}, {"lines": ["        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_approve', token=fake.sentence()),", "            auth=self.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)"]}, {"lines": [""]}, {"lines": ["    def test_GET_approve_with_valid_token_returns_redirect(self):", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)"]}, {"lines": [""]}, {"lines": ["        approval_token = self.registration.retraction.approval_state[self.user._id]['approval_token']", "        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_approve', token=approval_token),", "            auth=self.auth", "        )", "        self.registration.retraction.reload()", "        assert_true(self.registration.is_retracted)", "        assert_false(self.registration.pending_retraction)", "        assert_equal(res.status_code, 302)"]}, {"lines": [""]}, {"lines": ["    def test_GET_approve_with_wrong_admins_token_returns_HTTPBad_Request(self):", "        user2 = AuthUserFactory()", "        self.registration.contributors.append(user2)", "        self.registration.add_permission(user2, 'admin', save=True)", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "        assert_equal(len(self.registration.retraction.approval_state), 2)"]}, {"lines": [""]}, {"lines": ["        wrong_approval_token = self.registration.retraction.approval_state[user2._id]['approval_token']", "        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_approve', token=wrong_approval_token),", "            auth=self.auth,", "            expect_errors=True", "        )", "        assert_true(self.registration.pending_retraction)", "        assert_equal(res.status_code, 400)", "", "    # node_registration_retraction_disapprove_tests", "    def test_GET_disapprove_from_unauthorized_user_raises_HTTPForbidden(self):", "        unauthorized_user = AuthUserFactory()", "", "        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_disapprove', token=fake.sentence()),", "            auth=unauthorized_user.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 403)", "", "    def test_GET_disapprove_registration_without_retraction_returns_HTTPBad_Request(self):", "        assert_false(self.registration.pending_retraction)"]}, {"lines": [""]}, {"lines": ["        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_disapprove', token=fake.sentence()),", "            auth=self.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)", "", "    def test_GET_disapprove_with_invalid_token_returns_HTTPBad_Request(self):", "        self.registration.retract_registration(self.user)"]}, {"lines": ["        self.registration.save()"]}, {"lines": ["        assert_true(self.registration.pending_retraction)"]}, {"lines": [""]}, {"lines": ["        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_disapprove', token=fake.sentence()),", "            auth=self.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)", "", "    def test_GET_disapprove_with_wrong_admins_token_returns_HTTPBad_Request(self):", "        user2 = AuthUserFactory()", "        self.registration.contributors.append(user2)", "        self.registration.add_permission(user2, 'admin', save=True)", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "        assert_equal(len(self.registration.retraction.approval_state), 2)", "", "        wrong_disapproval_token = self.registration.retraction.approval_state[user2._id]['disapproval_token']", "        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_disapprove', token=wrong_disapproval_token),", "            auth=self.auth,", "            expect_errors=True", "        )", "        assert_true(self.registration.pending_retraction)", "        assert_equal(res.status_code, 400)", "", "    def test_GET_disapprove_with_valid_token_returns_redirect(self):", "        self.registration.retract_registration(self.user)", "        self.registration.save()", "        assert_true(self.registration.pending_retraction)", "", "        disapproval_token = self.registration.retraction.approval_state[self.user._id]['disapproval_token']", "        res = self.app.get(", "            self.registration.web_url_for('node_registration_retraction_disapprove', token=disapproval_token),", "            auth=self.auth,", "        )", "        self.registration.retraction.reload()", "        assert_false(self.registration.is_retracted)", "        assert_false(self.registration.pending_retraction)"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.CANCELLED)"]}, {"lines": ["        assert_equal(res.status_code, 302)"]}, {"lines": [""]}, {"lines": ["", "class RegistrationRetractionViewsTestCase(OsfTestCase):", "    def setUp(self):", "        super(RegistrationRetractionViewsTestCase, self).setUp()"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.auth = self.user.auth", "        self.registration = RegistrationFactory(creator=self.user, is_public=True)"]}, {"lines": [""]}, {"lines": ["        self.retraction_post_url = self.registration.api_url_for('node_registration_retraction_post')"]}, {"lines": ["        self.retraction_get_url = self.registration.web_url_for('node_registration_retraction_get')"]}, {"lines": ["        self.justification = fake.sentence()"]}, {"lines": [""]}, {"lines": ["    def test_GET_retraction_page_when_pending_retraction_returns_HTTPBad_Request(self):", "        self.registration.retract_registration(self.user)"]}, {"lines": ["        self.registration.save()", "", "        res = self.app.get(", "            self.retraction_get_url,", "            auth=self.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)", ""]}, {"lines": ["    def test_POST_retraction_to_private_registration_returns_HTTPBad_request(self):"]}, {"lines": ["        self.registration.is_public = False", "        self.registration.save()", "", "        res = self.app.post_json("]}, {"lines": ["            self.retraction_post_url,"]}, {"lines": ["            auth=self.auth,", "            expect_errors=True,"]}, {"lines": ["        )"]}, {"lines": ["        assert_equal(res.status_code, 400)", "        self.registration.reload()"]}, {"lines": ["        assert_is_none(self.registration.retraction)"]}, {"lines": [""]}, {"lines": ["    def test_POST_retraction_by_non_admin_retract_HTTPUnauthorized(self):"]}, {"lines": ["        res = self.app.post_json(self.retraction_post_url, expect_errors=True)"]}, {"lines": ["        assert_equals(res.status_code, 401)", "        self.registration.reload()"]}, {"lines": ["        assert_is_none(self.registration.retraction)"]}, {"lines": [""]}, {"lines": ["    def test_POST_retraction_without_justification_returns_HTTPOK(self):"]}, {"lines": ["        res = self.app.post_json("]}, {"lines": ["            self.retraction_post_url,"]}, {"lines": ["            {'justification': ''},", "            auth=self.auth,"]}, {"lines": ["        )"]}, {"lines": ["        assert_equal(res.status_code, 200)"]}, {"lines": ["        self.registration.reload()"]}, {"lines": ["        assert_false(self.registration.retraction.is_retracted)"]}, {"lines": ["        assert_equal(self.registration.retraction.state, Retraction.PENDING)"]}, {"lines": ["        assert_is_none(self.registration.retraction.justification)"]}, {"lines": [""]}, {"lines": ["            self.retraction_post_url,", "            {'justification': ''},", "            auth=self.auth,", "        )"]}, {"lines": ["        self.app.post_json(url, {'registrationChoice': 'Make registration public immediately'}, auth=self.auth)"]}, {"lines": ["        url = \"/api/v1/project/{0}/register/Replication_Recipe_(Brandt_et_al.,_2013):_Post-Completion/\".format(", "            self.project._primary_key)"]}, {"lines": ["        self.project.reload()", "        # Most recent node is a registration", "        reg = Node.load(self.project.node__registrations[-1])", "        assert_true(reg.is_registration)", "        # The registration created is public", "        assert_true(reg.is_public)", ""]}, {"lines": ["        url = \"/api/v1/project/{0}/register/Replication_Recipe_(Brandt_et_al.,_2013):_Post-Completion/\".format(", "            self.project._primary_key)"]}, {"lines": ["        self.app.post_json(", "            url,", "            {"]}, {"lines": ["                'embargoEndDate': \"Fri, 01 Jan {year} 05:00:00 GMT\".format(year=str(dt.date.today().year + 1))"]}, {"lines": ["            },", "            auth=self.auth)", "", "        self.project.reload()", "        # Most recent node is a registration", "        reg = Node.load(self.project.node__registrations[-1])", "        assert_true(reg.is_registration)", "        # The registration created is not public", "        assert_false(reg.is_public)", "        # The registration is pending an embargo that has not been approved", "        assert_true(reg.pending_embargo)"]}, {"lines": ["        assert_false(reg.embargo_end_date)"]}, {"lines": [""]}, {"lines": ["    def test_forgot_password_get(self):"]}, {"lines": ["        assert_equal(res.status_code, 200)"]}, {"lines": [""]}, {"lines": ["", "", "class RetractionTokenError(NodeError):", "    \"\"\"Base class for errors arising from the user of a retraction token.\"\"\"", "    pass", "", "", "class InvalidRetractionApprovalToken(RetractionTokenError):", "    \"\"\"Raised if a retraction approval token is not found.\"\"\"", "    message_short = \"Invalid Token\""]}, {"lines": ["", "", "class InvalidRetractionDisapprovalToken(RetractionTokenError):", "    \"\"\"Raised if a retraction disapproval token is not found.\"\"\"", "    message_short = \"Invalid Token\""]}, {"lines": ["", "", "class EmbargoTokenError(NodeError):", "    \"\"\"Base class for errors arising from the user of a embargo token.\"\"\"", "    pass", "", "", "class InvalidEmbargoApprovalToken(EmbargoTokenError):", "    \"\"\"Raised if a embargo approval token is not found.\"\"\"", "    message_short = \"Invalid Token\""]}, {"lines": ["", "", "class InvalidEmbargoDisapprovalToken(EmbargoTokenError):", "    \"\"\"Raised if a embargo disapproval token is not found.\"\"\"", "    message_short = \"Invalid Token\""]}, {"lines": ["REGISTRATION_EMBARGO_INFO = '''"]}, {"lines": ["<p>You can choose whether to make your registration public immediately or"]}, {"lines": ["is automatically made public. After becoming public, the only way to remove a", "registration is to retract it. Retractions show only the registration title,", "contributors, and description to indicate that a registration was made and", "later retracted.</p>", "", "<p>When you register, a notification will be sent to all other project", "contributors. Other administrators will have 48 hours to approve or reject", "creating the registration. If any other administrator rejects the", "registration, it will be canceled. If all other administrators approve or do", "nothing, the registration will be confirmed and released or enter its embargo", "period.</p>"]}, {"lines": ["'''"]}, {"lines": ["PENDING_RETRACTION_ADMIN = Mail(", "    'pending_retraction_admin',"]}, {"lines": ["    subject='Retraction pending for one of your projects.'"]}, {"lines": [")", "PENDING_RETRACTION_NON_ADMIN = Mail(", "    'pending_retraction_non_admin',"]}, {"lines": ["    subject='Retraction pending for one of your projects.'", ")"]}, {"lines": ["PENDING_EMBARGO_ADMIN = Mail(", "    'pending_embargo_admin',", "    subject='Registration pending for one of your projects.'"]}, {"lines": [")"]}, {"lines": ["PENDING_EMBARGO_NON_ADMIN = Mail(", "    'pending_embargo_non_admin',", "    subject='Registration pending for one of your projects.'"]}, {"lines": ["            '/project/<pid>/retraction/',", "            '/project/<pid>/node/<nid>/retraction/',", "        ], 'get', project_views.register.node_registration_retraction_get,"]}, {"lines": ["            OsfWebRenderer('project/retract_registration.mako')),"]}, {"lines": ["        Rule([", "            '/project/<pid>/retraction/approve/<token>/',"]}, {"lines": ["            '/project/<pid>/node/<nid>/retraction/approve/<token>/',"]}, {"lines": ["        ], 'get', project_views.register.node_registration_retraction_approve,", "            OsfWebRenderer('error.mako', render_mako_string)),", "        Rule([", "            '/project/<pid>/retraction/disapprove/<token>/',"]}, {"lines": ["            '/project/<pid>/node/<nid>/retraction/disapprove/<token>/',"]}, {"lines": ["        ], 'get', project_views.register.node_registration_retraction_disapprove,", "            OsfWebRenderer('error.mako', render_mako_string)),"]}, {"lines": ["        Rule([", "            '/project/<pid>/embargo/approve/<token>/',", "            '/project/<pid>/node/<nid>/embargo/approve/<token>/',", "        ], 'get', project_views.register.node_registration_embargo_approve,", "            OsfWebRenderer('error.mako', render_mako_string)),", "        Rule([", "            '/project/<pid>/embargo/disapprove/<token>/',", "            '/project/<pid>/node/<nid>/embargo/disapprove/<token>/',", "        ], 'get', project_views.register.node_registration_embargo_disapprove,", "            OsfWebRenderer('error.mako', render_mako_string)),", ""]}, {"lines": ["            '/project/<pid>/retraction/',", "            '/project/<pid>/node/<nid>/retraction/'", "        ], 'post', project_views.register.node_registration_retraction_post, json_renderer),"]}, {"lines": ["@must_be_valid_project(retractions_valid=True)"]}, {"lines": ["@must_be_valid_project(retractions_valid=True)"]}, {"lines": ["@must_be_valid_project(retractions_valid=True)"]}, {"lines": ["            'is_retracted': node.is_retracted,", "            'pending_retraction': node.pending_retraction,"]}, {"lines": ["            'retracted_justification': getattr(node.retraction, 'justification', None),"]}, {"lines": ["            'pending_embargo': node.pending_embargo,"]}, {"lines": ["        'is_retracted': node.is_retracted,", "        'pending_retraction': node.pending_retraction,"]}, {"lines": ["        'pending_embargo': node.pending_embargo,"]}, {"lines": ["@must_be_valid_project(retractions_valid=True)"]}, {"lines": ["import datetime"]}, {"lines": ["# Hours before pending embargo/retraction automatically becomes active"]}, {"lines": ["RETRACTION_PENDING_TIME = datetime.timedelta(days=2)"]}, {"lines": ["EMBARGO_PENDING_TIME = datetime.timedelta(days=2)"]}, {"lines": ["# Date range for embargo periods", "EMBARGO_END_DATE_MIN = datetime.timedelta(days=2)"]}, {"lines": [""]}, {"lines": ["'use strict';"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["var oop = require('js/oop');"]}, {"lines": ["var formViewModel = require('js/formViewModel');"]}, {"lines": ["var ForgotPasswordViewModel = oop.extend(formViewModel.FormViewModel, {", "    constructor: function() {", "        var self = this;"]}, {"lines": ["        self.super.constructor.call(self);"]}, {"lines": ["        self.username = ko.observable('').extend({", "            required: true,", "            email: true", "        });", "    },", "    isValid: function() {"]}, {"lines": ["        var validationError = new formViewModel.ValidationError();"]}, {"lines": ["        if (!this.username.isValid()) {"]}, {"lines": ["            validationError.messages.push('Please enter a valid email address.');", "            throw validationError;"]}, {"lines": ["        } else {", "            return true;", "        }", "    }", "});", ""]}, {"lines": ["var ForgotPassword = function(selector) {"]}, {"lines": ["    this.viewModel = new ForgotPasswordViewModel();"]}, {"lines": ["    $osf.applyBindings(this.viewModel, selector);"]}, {"lines": ["module.exports = {", "    ForgotPassword: ForgotPassword,", "    ViewModel: ForgotPasswordViewModel", "};"]}, {"lines": ["ko.validation.rules.mustEqual = {", "    validator: function (val, otherVal) {", "        return val === otherVal;", "    },", "    message: 'The field does not match the required input.'", "};", ""]}, {"lines": ["var registrationEmbargo = require('./registrationEmbargo');"]}, {"lines": ["        // embargoAddon viewmodel component"]}, {"lines": ["        self.embargoAddon = new registrationEmbargo.ViewModel();"]}, {"lines": [""]}, {"lines": ["            // Add embargoAddon relevant fields", "            $.extend(data, {"]}, {"lines": ["                'embargoEndDate': self.embargoAddon.embargoEndDate().toUTCString()"]}, {"lines": ["            });"]}, {"lines": ["var signIn = require('js/signIn');"]}, {"lines": ["    self.signIn = new signIn.ViewModel();"]}, {"lines": ["    // TODO(hrybacki): Remove warning once Retraction/Embargoes goes is merged into production"]}, {"lines": [" * On page load, maintains knockout ViewModel"]}, {"lines": ["require('knockout.validation');"]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": ["var RegistrationRetraction = function(selector, submitUrl, registrationTitle) {", "    this.viewModel = new RegistrationRetractionViewModel(submitUrl, registrationTitle);"]}, {"lines": ["module.exports = {", "    RegistrationRetraction: RegistrationRetraction,", "    ViewModel: RegistrationRetractionViewModel"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["var oop = require('js/oop');", "var formViewModel = require('js/formViewModel');", "", "", "var SignInViewModel = oop.extend(formViewModel.FormViewModel, {", "    constructor: function () {", "        var self = this;"]}, {"lines": ["        self.super.constructor.call(self);"]}, {"lines": ["        self.username = ko.observable('').extend({", "            required: true,", "            email: true", "        });"]}, {"lines": ["    },", "    isValid: function() {"]}, {"lines": ["        var validationError = new formViewModel.ValidationError();"]}, {"lines": ["        if (!this.username.isValid()) {"]}, {"lines": ["            validationError.messages.push('Please enter a valid email address.');"]}, {"lines": ["        }"]}, {"lines": ["        if (validationError.messages.length > 0) {", "            throw validationError;"]}, {"lines": ["        }"]}, {"lines": ["    }"]}, {"lines": ["});", ""]}, {"lines": ["var SignIn = function(selector) {"]}, {"lines": ["    this.viewModel = new SignInViewModel();"]}, {"lines": ["    $osf.applyBindings(this.viewModel, selector);"]}, {"lines": ["module.exports = {", "    SignIn: SignIn,", "    ViewModel: SignInViewModel", "};"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        // If embargo is requested, verify its end date, and inform user if date is out of range", "        if (registrationViewModel.embargoAddon.requestingEmbargo()) {", "            if (!registrationViewModel.embargoAddon.isEmbargoEndDateValid()) {", "                registrationViewModel.continueText('');", "                $osf.growl("]}, {"lines": ["                    'warning'", "                );"]}, {"lines": ["                $('#endDatePicker').focus();"]}, {"lines": ["                return false;", "            }", "        }"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';", "var assert = require('chai').assert;", "var $osf = require('js/osfHelpers');", "", "var formViewModel = require('js/formViewModel');", "", "// Add sinon asserts to chai.assert, so we can do assert.calledWith instead of sinon.assert.calledWith", "sinon.assert.expose(assert, {prefix: ''});", "", "describe('formModelView', () => {", "", "    describe('ValidationError', () => {"]}, {"lines": ["        it('inherits from Error', () => {"]}, {"lines": ["            var validationError = new formViewModel.ValidationError();", "            assert.instanceOf(validationError, Error);", "        });", "", "        it('sets defaults properly', () => {", "            var validationError = new formViewModel.ValidationError();", "            assert.equal(validationError.message, []);", "            assert.equal(validationError.header, 'Error');", "            assert.equal(validationError.level, 'warning');", "        });", "    });", ""]}, {"lines": ["    describe('ViewModel', () => {"]}, {"lines": ["        var vm;", "", "        beforeEach(() => {", "            vm = new formViewModel.FormViewModel();", "        });", "", "        it('throws Error for unimplemented isValid', () => {", "             assert.throw(vm.isValid, Error, 'FormViewModel subclass must implement isValid');", "        });", "", "        describe('submit', () => {", "            var isValidStub;", "", "            beforeEach(() => {", "                isValidStub = sinon.stub(vm, 'isValid');", "            });", "", "            afterEach(() => {", "                isValidStub.restore();", "            });", "", "            it('returns true if isValid', () => {", "                isValidStub.returns(true);", "                var result = vm.submit();", "                assert.isTrue(result);", "            });", ""]}, {"lines": ["            it('calls growl if not isValid', () => {"]}, {"lines": ["                var growlSpy = new sinon.stub($osf, 'growl');", "                isValidStub.throws(new formViewModel.ValidationError(['pewpewpew']));", "                vm.submit();", "                assert.isTrue(growlSpy.called);", "                growlSpy.restore();", "            });", "        });", "    });", "});"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["var faker = require('faker');"]}, {"lines": [""]}, {"lines": ["var registrationRetraction = require('js/registrationRetraction');", "", "// Add sinon asserts to chai.assert, so we can do assert.calledWith instead of sinon.assert.calledWith", "sinon.assert.expose(assert, {prefix: ''});", "", "describe('registrationRetraction', () => {", "    describe('ViewModels', () => {", "", "        describe('RegistrationRetractionViewModel', () => {", "            var vm;", "            var registrationTitle = 'This is a fake registration';"]}, {"lines": ["            var invalidJustification = faker.lorem.paragraphs(50);"]}, {"lines": ["            var invalidConfirmationText = 'abcd';"]}, {"lines": ["            var submitUrl = '/project/abcdef/retraction/';"]}, {"lines": ["            var invalidSubmitUrl = '/notAnEndpoint/';"]}, {"lines": ["            var redirectUrl = '/project/abdef/';", "            var response = {redirectUrl: redirectUrl};", "            var endpoints = [", "                {", "                    method: 'POST',", "                    url: submitUrl,", "                    response: response"]}, {"lines": ["                },", "                {", "                    method: 'POST',"]}, {"lines": ["                    url: invalidSubmitUrl,", "                    response: {},", "                    status: 500"]}, {"lines": ["                }", "            ];", "            var server;", ""]}, {"lines": ["            before(() => {", "                server = utils.createServer(sinon, endpoints);", "            });", "", "            after(() => {", "                server.restore();", "            });"]}, {"lines": ["", "            beforeEach(() => {", "                vm = new registrationRetraction.ViewModel(submitUrl, registrationTitle);", "            });", "", "            it('non-matching registration title is invalid', () => {", "                vm.confirmationText(invalidConfirmationText);", "                assert.isFalse(vm.confirmationText.isValid());", "            });", "", "            it('matching registration title is valid', () => {"]}, {"lines": ["                assert.isTrue(vm.confirmationText.isValid());", "            });", ""]}, {"lines": ["            describe('submit', () => {"]}, {"lines": ["                var postSpy;"]}, {"lines": ["", "                beforeEach(() => {"]}, {"lines": ["                    postSpy = new sinon.spy($osf, 'postJSON');"]}, {"lines": ["                });", "", "                afterEach(() => {"]}, {"lines": ["                    postSpy.restore();"]}, {"lines": ["                });", ""]}, {"lines": ["                    vm.confirmationText(invalidConfirmationText);", "                    vm.submit();"]}, {"lines": ["                    assert.notCalled(postSpy);"]}, {"lines": ["                });"]}, {"lines": ["                    vm.confirmationText(registrationTitle);", "                    vm.justification(invalidJustification);", "                    vm.submit();"]}, {"lines": ["                    assert.notCalled(postSpy);", "                });"]}, {"lines": ["                it('submits successfully with valid confirmation text', (done) => {", "                    var onSubmitSuccessStub = new sinon.stub(vm, 'onSubmitSuccess');", ""]}, {"lines": ["                    vm.submit().always(() => {"]}, {"lines": ["                        assert.equal(response.redirectUrl, redirectUrl);"]}, {"lines": ["                        assert.called(onSubmitSuccessStub);", "                        assert.called(postSpy);"]}, {"lines": ["                        onSubmitSuccessStub.restore();", "                        done();"]}, {"lines": ["                    });"]}, {"lines": ["                });"]}, {"lines": [""]}, {"lines": ["                it('logs error with Raven if submit fails', (done) => {", "                    vm = new registrationRetraction.ViewModel(invalidSubmitUrl, registrationTitle);", "                    var onSubmitErrorSpy = new sinon.spy(vm, 'onSubmitError');", "                    var ravenStub = new sinon.stub(Raven, 'captureMessage');", ""]}, {"lines": ["                    vm.submit().always((xhr) => {", "                        assert.equal(xhr.status, 500);"]}, {"lines": ["                        assert.equal(response.redirectUrl, redirectUrl);"]}, {"lines": ["                        assert.called(onSubmitErrorSpy);", "                        assert.called(postSpy);"]}, {"lines": ["                        onSubmitErrorSpy.restore();", "                        ravenStub.restore();", "                        done();"]}, {"lines": ["                    });"]}, {"lines": ["                });"]}, {"lines": [""]}, {"lines": ["            });", "        });", "    });", "});", ""]}, {"lines": ["        % else:", "            <script>", "                window.ga = function(source) {", "                        console.error('=== Mock ga event called: ===');", "                        console.log('event: ga(' +", "                                    arguments[0] + ', ' +", "                                    arguments[1] + ', ' +", "                                    arguments[2] + ', ' +", "                                    arguments[3] + ')'", "                        );", "                };", "          </script>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "For example, Sam initiates a registration of the private project \"Destroy One Ring\" and does not set an embargo period.  Frodo, another administrator on the project, receives a notification but worries that making the registration details public too soon would undermine the project.  He cancels the registration within 48 hours, but does wish to pre-register the project aims and preserve the content for posterity.  Frodo then initiates a new registration with a 12-month embargo period.  Frodo and Sam work diligently to complete the project during the embargo period.", ""]}, {"lines": ["", "Please let us know if you have any questions or would like help addressing your current public registrations: support@osf.io", "", "Regards,", "", "The OSF Team"]}, {"lines": ["Hello ${user.fullname},", ""]}, {"lines": ["", "If approved, a registration will be created for the project, viewable here: ${registration_link}, and it will remain", "private until it is retracted, manually made public, or the embargo end date has passed on ${embargo_end_date.date()}.", "", "Sincerely yours,", "", "The OSF Robots"]}, {"lines": ["Hello ${user.fullname},", ""]}, {"lines": ["", "Sincerely yours,", "", "The OSF Robots"]}, {"lines": ["            <div id=\"embargo-addon\" data-bind=\"with: $root.embargoAddon, \">", "                <hr />", "", "                <p class=\"help-block\">${language.REGISTRATION_EMBARGO_INFO}</p>"]}, {"lines": ["                <div class=\"form-group\">", "                    <label class=\"control-label\">Registration Choice</label>"]}, {"lines": ["                </div>", "                <span data-bind=\"visible: showEmbargoDatePicker\">"]}, {"lines": ["                    <div class=\"form-group\">", "                        <label class=\"control-label\">Embargo End Date</label>", "                        <input type=\"text\" id=\"endDatePicker\" class=\"form-control\">"]}, {"lines": ["                    </div>", "                </span>"]}, {"lines": ["            </div>", ""]}, {"lines": ["% if node['is_retracted'] == True:", "    <%include file=\"retracted_registration.mako\" args=\"node='${node}'\"/>", "% else:", "    ${next.body()}"]}, {"lines": ["##  % if node['node_type'] == 'project':"]}, {"lines": ["        <%include file=\"modal_duplicate.mako\"/>"]}, {"lines": ["##  % endif"]}, {"lines": ["        <div class=\"panel panel-default\">", "            <div class=\"panel-body\">"]}, {"lines": ["                The title of a retracted registration and its contributor list will remain, as will justification or", "                explanation of the retraction, should you wish to provide it. Retracted registrations will be marked", "                with a \"retracted\" tag. <strong>This action is irreversible.</strong>", "            </div>", "        </div>"]}, {"lines": ["                        autofocus"]}, {"lines": ["                    % endif"]}, {"lines": [""]}, {"lines": ["                        % endif"]}, {"lines": ["                    % endif"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                    </div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    <div class=\"row\">", "        <form class=\"form col-md-4 col-md-offset-4 m-t-xl\"", "                id=\"forgotPasswordForm\"", "                class=\"form\"", "                % if next_url:", "                    action=\"/forgotpassword/?next=${next_url}\"", "                % else:", "                    action=\"/forgotpassword/\"", "                % endif", "                method=\"POST\"", "                data-bind=\"submit: submit\"", "            >", "            <div class=\"panel panel-osf\">", "                <div class=\"panel-heading\">Password Reset Request</div>", "                    <div class=\"panel-body\">", "                        <input type=\"email\" class=\"form-control\" data-bind=\"value: username\" name=\"forgot_password-email\" placeholder=\"Enter your email address\" autofocus/>", "                        <button type=\"submit\" class=\"btn btn-success pull-right m-t-md\">Reset Password</button>", "                    </div>", "            </div>", "            <hr class=\"m-t-lg m-b-sm\"/>"]}, {"lines": ["        </form>", "    </div>"]}], "name": "harryrybacki"}, {"commits": [{"lines": ["    'share-embed-page': staticPath('js/pages/share-embed-page.js'),"]}, {"lines": ["from framework.routing import xml_renderer"]}, {"lines": ["        Rule('/share/registration/', 'get', {'register': settings.SHARE_REGISTRATION_URL}, OsfWebRenderer('share_registration.mako')),"]}, {"lines": ["        Rule('/share/help/', 'get', {'help': settings.SHARE_API_DOCS_URL}, OsfWebRenderer('share_api_docs.mako')),"]}, {"lines": ["        Rule('/share/atom/', 'get', search_views.search_share_atom, xml_renderer),"]}, {"lines": ["from __future__ import unicode_literals", ""]}, {"lines": ["from time import gmtime", "from calendar import timegm", "from datetime import datetime", ""]}, {"lines": ["import pytz", ""]}, {"lines": ["from dateutil.parser import parse"]}, {"lines": ["from dateutil.relativedelta import relativedelta", ""]}, {"lines": ["from util import generate_color, html_and_illegal_unicode_replace"]}, {"lines": [""]}, {"lines": ["import logging", "", "logger = logging.getLogger(__name__)", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    three_months_ago = timegm((datetime.now() + relativedelta(months=-3)).timetuple()) * 1000"]}, {"lines": ["                        \"interval\": \"week\","]}, {"lines": ["                        \"min_doc_count\": 0,", "                        \"extended_bounds\": {"]}, {"lines": ["                            \"min\": three_months_ago,"]}, {"lines": ["                            \"max\": timegm(gmtime()) * 1000"]}, {"lines": ["                        }"]}, {"lines": ["", "    chart_results = data_for_charts(results)"]}, {"lines": ["    return chart_results", "", "", "def data_for_charts(elastic_results):", "    source_data = elastic_results['aggregations']['sources']['buckets']", "    for_charts = {}", "", "    ## for the donut graph list of many lists, source and count", "    source_and_counts = [[item['key'], item['doc_count']] for item in source_data]"]}, {"lines": [""]}, {"lines": ["    r = generate_color()"]}, {"lines": ["    stats = {}"]}, {"lines": ["    colors = {}"]}, {"lines": ["    for bucket in elastic_results['aggregations']['sources']['buckets']:", "        stats[bucket['key']] = {", "            'doc_count': bucket['doc_count'],", "        }"]}, {"lines": ["        colors[bucket['key']] = r.next()"]}, {"lines": ["", "    for bucket in elastic_results['aggregations']['earlier_documents']['sources']['buckets']:", "        stats[bucket['key']]['earlier_documents'] = bucket['doc_count']", ""]}, {"lines": ["    for bucket in elastic_results['aggregations']['date_chunks']['buckets']:"]}, {"lines": ["        stats[bucket['key']]['articles_over_time'] = bucket['articles_over_time']['buckets']", ""]}, {"lines": ["    names = ['x']", "    numbers = [['x']]", "    for date in stats[stats.keys()[0]]['articles_over_time']:"]}, {"lines": ["        numbers[0].append(' ')"]}, {"lines": ["", "    for key, value in stats.iteritems():"]}, {"lines": ["", "    date_totals = {", "        'date_numbers': numbers,", "        'group_names': names", "    }", ""]}, {"lines": ["    if date_totals.get('date_numbers') == [[u'x']]:", "        for name in date_totals.get('group_names'):", "            date_totals.get('date_numbers').append([name, 0])", ""]}, {"lines": ["    for_charts['date_totals'] = date_totals"]}, {"lines": ["", "    all_data = {}", "    all_data['raw_aggregations'] = elastic_results['aggregations']"]}, {"lines": ["            'columns': for_charts['shareDonutGraph'],", "            'colors': colors"]}, {"lines": ["            'groups': [for_charts['date_totals']['group_names']],"]}, {"lines": ["            'colors': colors"]}, {"lines": ["", "    return all_data"]}, {"lines": ["", ""]}, {"lines": ["def to_atom(result):"]}, {"lines": ["    if not result['id']['url']:", "        logger.error('ATOM error for {}: Missing id'.format(result['source']))"]}, {"lines": ["    return {"]}, {"lines": ["        'title': html_and_illegal_unicode_replace(result.get('title')) or 'No title provided.',", "        'summary': html_and_illegal_unicode_replace(result.get('description')) or 'No summary provided.',"]}, {"lines": ["        'id': result['id']['url'],"]}, {"lines": ["        'updated': get_date_updated(result),"]}, {"lines": ["        'links': [", "            {'href': result['id']['url'], 'rel': 'alternate'}", "        ],"]}, {"lines": ["        'author': format_contributors_for_atom(result['contributors']),"]}, {"lines": ["        'categories': [{\"term\": html_and_illegal_unicode_replace(tag)} for tag in result.get('tags')],"]}, {"lines": ["        'published': parse(result.get('dateUpdated'))", "    }", ""]}, {"lines": [""]}, {"lines": ["def format_contributors_for_atom(contributors_list):"]}, {"lines": ["    return [", "        {"]}, {"lines": ["            'name': '{} {}'.format("]}, {"lines": ["                html_and_illegal_unicode_replace(entry['given']),", "                html_and_illegal_unicode_replace(entry['family'])"]}, {"lines": ["            )"]}, {"lines": ["        }", "        for entry in contributors_list", "    ]"]}, {"lines": ["", ""]}, {"lines": ["def get_date_updated(result):", "    try:", "        updated = pytz.utc.localize(parse(result.get('dateUpdated')))", "    except ValueError:", "        updated = parse(result.get('dateUpdated'))", "", "    return updated"]}, {"lines": ["from website.search import util"]}, {"lines": ["from website.util import api_url_for"]}, {"lines": ["from website.search import share_search"]}, {"lines": ["from website.search.exceptions import IndexNotFoundError", "from website.search.exceptions import MalformedQueryError"]}, {"lines": [""]}, {"lines": ["RESULTS_PER_PAGE = 250", ""]}, {"lines": ["", ""]}, {"lines": ["def search_share_atom(**kwargs):"]}, {"lines": ["    q = request.args.get('q', '*')"]}, {"lines": ["    sort = request.args.get('sort', 'dateUpdated')"]}, {"lines": [""]}, {"lines": ["    # we want the results per page to be constant between pages"]}, {"lines": ["    # TODO -  move this functionality into build_query in util"]}, {"lines": ["    start = util.compute_start(request.args.get('page', 1), RESULTS_PER_PAGE)"]}, {"lines": [""]}, {"lines": ["    query = build_query(q, size=RESULTS_PER_PAGE, start=start, sort=sort)"]}, {"lines": ["", "    try:"]}, {"lines": ["    except MalformedQueryError:", "        raise HTTPError(http.BAD_REQUEST)", "    except IndexNotFoundError:"]}, {"lines": ["        search_results = {"]}, {"lines": ["            'count': 0,", "            'results': []", "        }", ""]}, {"lines": ["    atom_url = api_url_for('search_share_atom', _xml=True, _absolute=True)"]}, {"lines": [""]}, {"lines": ["    return util.create_atom_feed("]}, {"lines": ["        name='SHARE',"]}, {"lines": ["        data=search_results['results'],", "        query=q,"]}, {"lines": ["        size=RESULTS_PER_PAGE,"]}, {"lines": ["        start=start,"]}, {"lines": ["        url=atom_url,", "        to_atom=share_search.to_atom", "    )"]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["SHARE_REGISTRATION_URL = ''"]}, {"lines": ["SHARE_API_DOCS_URL = ''"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var pym = require('pym.js');", ""]}, {"lines": ["var register = window.contextVars.share.urls.register;"]}, {"lines": [""]}, {"lines": ["var pymParent = new pym.Parent("]}, {"lines": ["    'share_registration_iframe',"]}, {"lines": ["    register,"]}, {"lines": ["    {}", ");"]}, {"lines": ["", "function scrollToTop(data) {", "    window.scrollTo(0, 0);", "}", ""]}, {"lines": ["                    'Notice: this is a public beta release'"]}, {"lines": ["        utils.maybeQuashEvent(e);", "        utils.search(self.vm);"]}, {"lines": ["    self.search();"]}, {"lines": ["function get_source_length(elastic_data) {", ""]}, {"lines": ["        source_names.push(sources[i]);", "    }", "", "    return source_names.length;", "}", ""]}, {"lines": ["function donutGraph (data, vm) {", "    data.charts.shareDonutGraph.onclick = function (d, element) {"]}, {"lines": ["    };"]}, {"lines": ["        size: {"]}, {"lines": ["        },"]}, {"lines": ["        donut: {"]}, {"lines": ["            title: get_source_length(data) + ' Providers',", "            label: {", "                format: function (value, ratio, id) {", "                    return Math.round(ratio*100) + '%';", "                }", "            }"]}, {"lines": ["        },", "        legend: {", "            show: false"]}, {"lines": ["        },", "        tooltip: {"]}, {"lines": ["            format: {", "                name: function (name, ratio, id, index) {"]}, {"lines": ["                    }", "                    return name;"]}, {"lines": ["                }"]}, {"lines": ["            }"]}, {"lines": ["        }"]}, {"lines": ["    });", "}"]}, {"lines": ["        bindto: '#shareTimeGraph',"]}, {"lines": ["        size: {"]}, {"lines": ["        },"]}, {"lines": ["        axis: {", "            x: {"]}, {"lines": ["                type: 'category',"]}, {"lines": ["                label: {", "                   text: 'Last Three Months',", "                   position: 'outer-center',", "                }", "            },", "            y: {", "                label: {"]}, {"lines": ["                   position: 'outer-middle'", "                }"]}, {"lines": ["            }", "        },", "        legend: {", "            show: false"]}, {"lines": ["        },", "        tooltip: {"]}, {"lines": ["            grouped: false,", "            format: {", "              name: function (name, ratio, id, index) {"]}, {"lines": ["                  }", "                  return name;", "              }", "            }"]}, {"lines": ["        }"]}, {"lines": ["    });"]}, {"lines": ["                m('.col-md-4', m('p.text-center.font-thick', (ctrl.vm.query() && ctrl.vm.query().length > 0) ? 'Found ' + utils.formatNumber(ctrl.vm.count) + ' events in ' + ctrl.vm.time + ' seconds' : '')),"]}, {"lines": ["            m('.col-md-12', ["]}, {"lines": ["    self.vm.statsLoaded = m.prop(false);", "", "    self.drawGraph = function(divId, graphFunction) {", "        return m('div', {id: divId, config: function(e, i) {"]}, {"lines": ["        }});", "    };"]}, {"lines": ["    utils.onSearch(self.loadStats);", ""]}, {"lines": ["        background: true,"]}, {"lines": ["    }).then(m.redraw);"]}, {"lines": ["    self.loadStats();"]}, {"lines": ["<%inherit file=\"base.mako\"/>", "<%def name=\"title()\">SHARE</%def>", "<%def name=\"content()\">"]}, {"lines": ["    <div id=\"share_registration_iframe\"></div>"]}, {"lines": ["</%def>"]}, {"lines": ["", "<%def name=\"javascript_bottom()\">"]}, {"lines": ["    <script>", "        // Mako variables accessible globally", "        window.contextVars = $.extend(true, {}, window.contextVars, {", "            share: {"]}, {"lines": ["                urls: {"]}, {"lines": ["                    register: '${register | js_str}'"]}, {"lines": ["                }"]}, {"lines": ["            }", "        });", "    </script>"]}, {"lines": ["    <script src=${\"/static/public/js/share-embed-page.js\" | webpack_asset}></script>", "</%def>"]}, {"lines": ["<h3>How does OSF store and back up files that I upload to the site?</h3>", "    <p>The OSF stores files with <a href=\"http://www.rackspace.com/\">Rackspace</a>"]}, {"lines": ["    automated backups performed by our host every day, week, and fortnight.</p>"]}, {"lines": ["    \"\"\"Reverse URL lookup for API routes (that use the JSONRenderer or XMLRenderer)."]}, {"lines": ["    based on whether the app is in debug mode. The _xml flag sets the renderer to use."]}, {"lines": ["    renderer = 'XMLRenderer' if _xml else 'JSONRenderer'", ""]}, {"lines": ["    url = url_for('{0}__{1}'.format(renderer, view_name), *args, **kwargs)", "", "    if _absolute:"]}, {"lines": ["        # We do NOT use the url_for's _external kwarg because app.config['SERVER_NAME'] alters", "        # behavior in an unknown way (currently breaks tests). /sloria /jspies"]}, {"lines": [""]}], "name": "erinspace"}, {"commits": [{"lines": ["    'render-nodes': staticPath('js/pages/render-nodes.js'),"]}, {"lines": ["                'nodeType': 'project',", "                'category': 'project',"]}, {"lines": ["                'permissions': {"]}, {"lines": ["                    'view': True,"]}, {"lines": ["                },"]}, {"lines": ["                        'nodeType': 'component',", "                        'category': 'hypothesis',"]}, {"lines": ["                        'permissions': {"]}, {"lines": ["                            'view': True,"]}, {"lines": ["                        },"]}, {"lines": ["            'nodeType': 'component',", "            'category': 'hypothesis',"]}, {"lines": ["            'permissions': {"]}, {"lines": ["                'view': True,"]}, {"lines": ["            },"]}, {"lines": ["                'nodeType': 'project',", "                'category': 'project',"]}, {"lines": ["                'permissions': {"]}, {"lines": ["                    'view': True,"]}, {"lines": ["                },"]}, {"lines": ["                        'nodeType': 'component',", "                        'category': 'hypothesis',"]}, {"lines": ["                        'permissions': {"]}, {"lines": ["                            'view': True,"]}, {"lines": ["                        },"]}, {"lines": ["                        'nodeType': 'component',", "                        'category': 'hypothesis',"]}, {"lines": ["                        'permissions': {"]}, {"lines": ["                            'view': True,"]}, {"lines": ["                        },"]}, {"lines": ["            'nodeType': 'project',", "            'category': 'project',"]}, {"lines": ["            'permissions': {"]}, {"lines": ["                'view': True,"]}, {"lines": ["            },"]}, {"lines": ["                'nodeType': 'project',", "                'category': 'project',"]}, {"lines": ["                'permissions': {"]}, {"lines": ["                    'view': False,"]}, {"lines": ["                },"]}, {"lines": ["                        'nodeType': 'component',", "                        'category': 'hypothesis',"]}, {"lines": ["                        'permissions': {"]}, {"lines": ["                            'view': True,"]}, {"lines": ["                        },"]}, {"lines": ["            'nodeType': node.project_or_component,", "            'category': node.category,", "            'permissions': {", "                'view': can_read,", "            },"]}, {"lines": ["var iconmap = require('js/iconmap');", ""]}, {"lines": [" * Returns custom icons for OSF depending on the type of item. Used for non-file icons."]}, {"lines": ["    var componentIcons = iconmap.componentIcons;", "    var projectIcons = iconmap.projectIcons;"]}, {"lines": ["    function returnView(type, category) {"]}, {"lines": ["        var iconType = projectIcons[type];"]}, {"lines": ["        if (type === 'component' || type === 'registeredComponent') {"]}, {"lines": ["            if (!item.data.permissions.view) {", "                return null;", "            } else {", "                iconType = componentIcons[category];", "            }"]}, {"lines": ["        } else if (type === 'project' || type === 'registeredProject') {", "            iconType = projectIcons[category];", "        }", "        if (type === 'registeredComponent' || type === 'registeredProject') {", "            iconType += ' po-icon-registered';", "        } else {", "            iconType += ' po-icon';", "        }", "        var template = m('span', { 'class' : iconType});", "        return template;", "    }"]}, {"lines": ["    if (item.data.isDashboard) {", "        return returnView('collection');", "    }"]}, {"lines": ["    if (item.data.isSmartFolder) {"]}, {"lines": ["        return returnView('smartCollection');", "    }"]}, {"lines": ["    if ((item.data.nodeType === 'pointer' && item.parent().data.nodeType !== 'folder') || (item.data.isPointer && !item.parent().data.isFolder)) {"]}, {"lines": ["        return returnView('link');"]}, {"lines": ["    }"]}, {"lines": ["    if (item.data.nodeType === 'project') {"]}, {"lines": ["        if (item.data.parentIsFolder && item.data.isFolder) {"]}, {"lines": ["            return returnView('collection');"]}, {"lines": ["        }"]}, {"lines": ["        if (item.data.isRegistration) {", "            return returnView('registeredProject', item.data.category);", "        } else {", "            return returnView('project', item.data.category);", "        }", "    }"]}, {"lines": ["    if (item.data.nodeType === 'component') {"]}, {"lines": ["        if (item.data.isRegistration) {", "            return returnView('registeredComponent', item.data.category);"]}, {"lines": ["        return returnView('component', item.data.category);"]}, {"lines": ["    if (item.data.nodeType === 'pointer') {"]}, {"lines": ["        return returnView('link');"]}, {"lines": ["    return null;", "}", "", "/**"]}, {"lines": ["    if ( newIcon === null) {"]}, {"lines": ["        if (item.kind === 'folder') {", "            if (item.data.iconUrl) {", "                return m('span', {style: {width:'16px', height:'16px', background:'url(' + item.data.iconUrl+ ')', display:'block'}}, '');", "            }", "            if (!item.data.permissions.view) {", "                return privateFolder;", "            }", "            if (item.data.isPointer) {", "                return pointerFolder;", "            }", "            if (item.open) {", "                return configOption || openFolder;", "            }", "            return configOption || closedFolder;"]}, {"lines": ["        if (item.data.icon) {", "            return m('i.fa.' + item.data.icon, ' ');"]}, {"lines": ["        icon = getExtensionIconClass(item.data.name);", "        if (icon) {", "            return m('div.file-extension', { 'class': icon });", "        }", "        return m('i.fa.fa-file-text-o');"]}, {"lines": ["    return newIcon;"]}, {"lines": ["function inheritFromParent(item, parent, fields) {"]}, {"lines": ["function _fangornResolveRows(item) {"]}, {"lines": ["}"]}, {"lines": ["    uploadRowTemplate : uploadRowTemplate,"]}, {"lines": ["    resolveIcon : Fangorn.Utils.resolveIconView,"]}, {"lines": ["'use strict';", "", "var $osf = require('js/osfHelpers');"]}, {"lines": ["", "// model for components, due to simplicity did not create a new file", "var ComponentControl = {};", "", "// binds to component scope in render_nodes.mako"]}, {"lines": ["            helper: \"clone\""]}, {"lines": ["                        containment: '#containDrag',", "                        tolerance: 'pointer'"]}, {"lines": ["                        containment: '#containDrag',", "                        tolerance: 'pointer'"]}, {"lines": ["            <span data-bind=\"getIcon: '${summary['category']}'\"></span>"]}, {"lines": ["            <!-- ko stopBinding: true -->"]}, {"lines": ["            <!-- /ko -->"]}], "name": "Lauren Barker"}, {"commits": [{"lines": ["        'knockout.validation',", "        'knockout.punches',"]}, {"lines": ["        'jquery.cookie',"]}, {"lines": ["        'js/fangorn',", "        'js/citations',"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8", "", "import logging", "import datetime", "", "from modularodm import Q", "", "from framework.email.tasks import send_email", "", "from website import mails", "from website import models"]}, {"lines": ["from website.app import init_app", "", "from scripts import utils as script_utils", "", "", "logger = logging.getLogger(__name__)"]}, {"lines": ["logging.basicConfig(level=logging.INFO)", "", ""]}, {"lines": ["MESSAGE_NAME = 'permissions_change'", "SECURITY_MESSAGE = mails.Mail(", "    'security_permissions_change',"]}, {"lines": [")", "", "", "def send_security_message(user, label, mail):", "    if label in user.security_messages:", "        return"]}, {"lines": ["    mails.send_mail(", "        user.username,", "        mail,", "        from_addr=FROM_ADDR,", "        mailer=send_email,", "        user=user,"]}, {"lines": ["    )", "    user.security_messages[label] = datetime.datetime.utcnow()", "    user.save()", "", "", "def get_targets():"]}, {"lines": ["    return models.User.find(query)", "", "", "def main(dry_run):", "    users = get_targets()", "    for user in users:", "        logger.info('Sending message to user {0!r}'.format(user))", "        if not dry_run:", "            send_security_message(user, MESSAGE_NAME, SECURITY_MESSAGE)", "", "", "if __name__ == '__main__':", "    import sys"]}, {"lines": ["    dry_run = 'dry' in sys.argv", "    init_app(set_backends=True, routes=False)", "    main(dry_run=dry_run)", "", "", "import mock", "from nose.tools import *  # noqa", "", "from tests.base import OsfTestCase", "from tests.factories import UserFactory", "", "", "class TestSendSecurityMessage(OsfTestCase):", "", "    def tearDown(self):", "        super(TestSendSecurityMessage, self).tearDown()", "        models.User.remove()", "", "    def test_get_targets(self):", "        users = [UserFactory() for _ in range(3)]", "        users[0].security_messages[MESSAGE_NAME] = datetime.datetime.utcnow()", "        users[0].save()", "        targets = get_targets()", "        assert_equal(set(targets), set(users[1:]))", "", "    @mock.patch('scripts.admin_permission_email.send_email')", "    def test_send_mail(self, mock_send_mail):", "        user = UserFactory()", "        send_security_message(user, MESSAGE_NAME, SECURITY_MESSAGE)", "        user.reload()", "        assert_in(MESSAGE_NAME, user.security_messages)", "", "    @mock.patch('scripts.admin_permission_email.send_email')", "    def test_main(self, mock_send_mail):", "        [UserFactory() for _ in range(3)]", "        assert_equal(len(get_targets()), 3)", "        main(dry_run=False)", "        assert_true(mock_send_mail.called)", "        assert_equal(len(get_targets()), 0)", "", "    @mock.patch('scripts.admin_permission_email.send_email')", "    def test_main_dry(self, mock_send_mail):", "        [UserFactory() for _ in range(3)]", "        assert_equal(len(get_targets()), 3)", "        main(dry_run=True)", "        assert_false(mock_send_mail.called)", "        assert_equal(len(get_targets()), 3)"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import os", "import sys", "import logging", "", "import crontab", "", "from website import settings", "", "", "logger = logging.getLogger(__name__)", "logging.basicConfig(level=logging.INFO)", "", "", "def app_prefix(path):", "    return os.path.join(settings.APP_PATH, path)", "", "", "def ensure_item(cron, command):", "    items = list(cron.find_command(command))", "    return items[0] if items else cron.new(command)", ""]}, {"lines": ["def main(dry_run=True):"]}, {"lines": [""]}, {"lines": ["    cron = crontab.CronTab(user=settings.CRON_USER)", "", "    analytics = ensure_item(cron, 'bash {}'.format(app_prefix('scripts/analytics.sh')))"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "    logger.info('Updating crontab file:')", "    logger.info(cron.render())", "", "    if not dry_run:", "        cron.write_to_user(settings.CRON_USER)", "", "", "if __name__ == '__main__':", "    dry_run = 'dry' in sys.argv", "    main(dry_run=dry_run)"]}, {"lines": ["\"\"\"", "Enable the wiki and files add-ons for all existing nodes.", "\"\"\"", "", "from website.app import init_app", "from website import models", "", "app = init_app('website.settings', set_backends=True, routes=True)", "", "", "def impute_addons():", "    for node in models.Node.find():"]}, {"lines": ["        node.add_addon('wiki')", "        node.add_addon('files')"]}, {"lines": ["", "if __name__ == '__main__':", "    impute_addons()"]}, {"lines": ["\"\"\""]}, {"lines": ["Impute name parts for all existing users."]}, {"lines": ["\"\"\"", ""]}, {"lines": ["from framework.auth.utils import impute_names"]}, {"lines": ["", "from website.app import init_app", "from website import models", "", "app = init_app('website.settings', set_backends=True, routes=True)", "", "def impute_names():", "", "    for user in models.User.find():", ""]}, {"lines": ["        parsed = impute_names(user.fullname)"]}, {"lines": ["        for field, value in parsed.items():"]}, {"lines": ["            if getattr(user, field, None) is None:", "                setattr(user, field, value)"]}, {"lines": ["        user.save()", "", "if __name__ == '__main__':", "    impute_names()"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8", "\"\"\"Migrate files to correct container.", "Note: Must use Rackspace credentials with access to both test and production", "containers.", "Note: Must have pyrax installed to run.", "", "Run dry run: python -m scripts.migrate_cloudfiles_container dry", "Run migration: python -m scripts.migrate_cloudfiles_container"]}, {"lines": ["\"\"\""]}, {"lines": ["import logging", "", "import pyrax", "from modularodm import Q", "", "from website.app import init_app", "from website.addons.osfstorage import model", "", "from scripts import utils as script_utils", "from scripts.osfstorage import settings as storage_settings", "", "", "TEST_CONTAINER_NAME = 'osf_uploads_test'", "PROD_CONTAINER_NAME = 'osf_storage_prod'", "", "test_container = None", "prod_container = None", "", "logger = logging.getLogger(__name__)", "logging.basicConfig(level=logging.INFO)", "", "", "def migrate_version(version):", "    if version.location['container'] != TEST_CONTAINER_NAME:", "        raise ValueError('Version is already in correct container')", "    key = test_container.get_object(version.location['object'])", "    key.copy(prod_container)"]}, {"lines": ["    version.location['container'] = PROD_CONTAINER_NAME", "    version.save()", "", "", "def get_targets():", "    query = Q('location.container', 'eq', TEST_CONTAINER_NAME)", "    return model.OsfStorageFileVersion.find(query)", "", "", "def main(dry_run):", "    versions = get_targets()", "    for version in versions:"]}, {"lines": ["        if not dry_run:", "            migrate_version(version)", "", "", "if __name__ == '__main__':"]}, {"lines": ["    dry_run = 'dry' in sys.argv", "", "    # Log to file"]}, {"lines": ["", "    # Authenticate to Rackspace", "    pyrax.settings.set('identity_type', 'rackspace')"]}, {"lines": ["", "    # Look up containers", "    test_container = pyrax.cloudfiles.get_container(TEST_CONTAINER_NAME)", "    prod_container = pyrax.cloudfiles.get_container(PROD_CONTAINER_NAME)", "", "    main(dry_run=dry_run)", "", "", "import mock", "from nose.tools import *  # noqa", "", "from tests.base import OsfTestCase", "from website.addons.osfstorage.tests.factories import FileVersionFactory", "", "", "class TestMigrateContainer(OsfTestCase):", "", "    def tearDown(self):", "        super(TestMigrateContainer, self).tearDown()", "        model.OsfStorageFileVersion.remove()", "", "    def test_get_targets(self):", "        versions = [FileVersionFactory() for _ in range(5)]", "        versions[0].location['container'] = TEST_CONTAINER_NAME", "        versions[0].save()", "        targets = get_targets()", "        assert_equal(len(targets), 1)", "        assert_equal(targets[0], versions[0])", "", "    @mock.patch('scripts.migrate_cloudfiles_container.prod_container')", "    @mock.patch('scripts.migrate_cloudfiles_container.test_container')", "    def test_migrate_version(self, mock_test_container, mock_prod_container):", "        mock_test_object = mock.Mock()", "        mock_test_container.get_object.return_value = mock_test_object", "        version = FileVersionFactory()", "        version.location['container'] = TEST_CONTAINER_NAME", "        version.save()", "        migrate_version(version)", "        mock_test_container.get_object.assert_called_with(version.location['object'])", "        mock_test_object.copy.assert_called_with(mock_prod_container)", "        version.reload()", "        assert_equal(version.location['container'], PROD_CONTAINER_NAME)", "        assert_equal(len(get_targets()), 0)", "", "    def test_dry_run(self):", "        versions = [FileVersionFactory() for _ in range(5)]", "        versions[0].location['container'] = TEST_CONTAINER_NAME", "        versions[0].save()", "        main(dry_run=True)", "        assert_equal(len(get_targets()), 1)"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["\"\"\"Remove conference administrators from COS staff using personal email", "addresses and replace with staff email account.", "\"\"\""]}, {"lines": ["", "import sys", "import logging", "", "from modularodm import Q", "", "from website import models"]}, {"lines": ["", "from scripts import utils as scripts_utils", "", "", "STAFF_EMAIL = 'presentations@cos.io'"]}, {"lines": ["PERSONAL_ACCOUNTS = [", "    'andrew@cos.io',", "    'sara.d.bowman@gmail.com',", "    'KatyCain526@gmail.com',", "]"]}, {"lines": ["", "logger = logging.getLogger(__name__)", "logging.basicConfig(level=logging.INFO)", "", ""]}, {"lines": ["def migrate_conference(conference, staff_user, personal_accounts, dry_run=True):"]}, {"lines": ["    nodes = models.Node.find(", "        Q('system_tags', 'eq', conference.endpoint) |", "        Q('tags', 'eq', conference.endpoint)", "    )", "    for node in nodes:"]}, {"lines": ["        migrate_node(node, conference, staff_user, personal_accounts, dry_run=dry_run)"]}, {"lines": ["", ""]}, {"lines": ["def migrate_node(node, conference, staff_user, personal_accounts, dry_run=True):"]}, {"lines": ["    for admin in conference.admins:"]}, {"lines": ["        if admin.username in personal_accounts and admin in node.contributors:"]}, {"lines": ["            logger.info("]}, {"lines": ["                    admin.fullname,", "                    node.title,", "                )", "            )", "            if not dry_run:", "                node.remove_contributor(admin, log=False, auth=None)", "    if staff_user not in node.contributors:", "        logger.info("]}, {"lines": ["                staff_user.fullname,", "                node.title,", "            )", "        )", "        if not dry_run:", "            node.add_contributor(staff_user, log=False)", "    node.save()", "", "", "def main(dry_run=True):"]}, {"lines": ["    staff_user = models.User.find_one(Q('username', 'eq', STAFF_EMAIL))", "    for conference in models.Conference.find():"]}, {"lines": ["        migrate_conference(conference, staff_user, PERSONAL_ACCOUNTS, dry_run=dry_run)"]}, {"lines": ["", "", "if __name__ == '__main__':", "    dry_run = 'dry' in sys.argv", "    if not dry_run:", "        scripts_utils.add_file_logger(logger, __file__)", "    main(dry_run=dry_run)"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8", "", "import sys", "import logging", "", "from modularodm import Q", "", "from website import models"]}, {"lines": ["from scripts import utils as scripts_utils", "", "", "logger = logging.getLogger(__name__)", "logging.basicConfig(level=logging.INFO)", "", "", "def is_invited(user):", "    query = (", "        Q('action', 'eq', 'contributor_added') &", "        Q('params.contributors', 'eq', user._id)", "    )", "    if user.date_confirmed:", "        query = (", "            query &", "            Q('date', 'ne', None) &", "            Q('date', 'lt', user.date_confirmed)", "        )", "    logs = models.NodeLog.find(query)", "    return bool(logs)", "", "", "def main(dry_run=True):", "    users = models.User.find(Q('is_invited', 'eq', None))", "    for user in users:", "        invited = is_invited(user)", "        logger.info('Setting `is_invited` field of user {0} to {1}'.format(user._id, invited))", "        if not dry_run:", "            user.is_invited = invited", "            user.save()", "", "", "if __name__ == '__main__':", "    dry_run = 'dry' in sys.argv"]}, {"lines": ["    if not dry_run:", "        scripts_utils.add_file_logger(logger, __file__)", "    main(dry_run=dry_run)"]}, {"lines": ["\"\"\"", "", "\"\"\"", "", "from website.app import init_app", "from website import models", "", "app = init_app('website.settings', set_backends=True, routes=True)", "", "node_mongo = models.Node._storage[0].store", "", "def nodes_to_abstract():", "", "    for node in node_mongo.find():", "        if node['nodes']:", "            if isinstance(node['nodes'][0], basestring):", "                abstract = [", "                    [each, 'node']", "                    for each in node['nodes']", "                ]", "                node_mongo.update(", "                    {'_id': node['_id']},", "                    {'$set':", "                         {", "                            'nodes': abstract", "                         }", "                    }", "                )", "", "if __name__ == '__main__':", "    nodes_to_abstract()"]}, {"lines": ["def add_file_logger(logger, script_name, suffix=None):"]}, {"lines": ["    if suffix is not None:"]}, {"lines": ["        name = '{0}-{1}'.format(name, suffix)"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import os", "import re"]}, {"lines": ["import matplotlib.pyplot as plt", ""]}, {"lines": ["from website import settings", "from website.app import init_app", ""]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["ADDONS = [", "    'github',", "    's3',", "    'figshare',", "    'dropbox',", "    'dataverse',", "]", "", ""]}, {"lines": ["def get_collection_datetimes(collection, _id='_id', query=None):", "    query = query or {}", "    return [", "        oid_to_datetime(record[_id])", "        for record in collection.find({}, {_id: True})", "    ]", "", "", "def analyze_model(model):"]}, {"lines": ["    dates = get_collection_datetimes(model._storage[0].store)", "    return {", "        'dates': dates,", "        'count': len(dates),", "    }", "", "", "def analyze_addon_installs(name):"]}, {"lines": ["    config = settings.ADDONS_AVAILABLE_DICT[name]", "", "    results = {", "        key: analyze_model(model)", "        for key, model in config.settings_models.iteritems()", "    }"]}, {"lines": ["    return results", "", "", "def analyze_addon_logs(name):"]}, {"lines": ["    pattern = re.compile('^{0}'.format(name), re.I)", "    logs = log_collection.find({'action': {'$regex': pattern}}, {'date': True})", "    return [", "        record['date']", "        for record in logs", "    ]", "", "", "def analyze_addon(name):"]}, {"lines": ["    installs = analyze_addon_installs(name)", "    for model, result in installs.iteritems():"]}, {"lines": ["        fig = plot_dates(result['dates'])"]}, {"lines": ["        plt.close()", "", "    log_dates = analyze_addon_logs(name)"]}, {"lines": ["    fig = plot_dates(log_dates)"]}, {"lines": ["    plt.close()", "", ""]}, {"lines": ["    for addon in ADDONS:", "        if addon in settings.ADDONS_AVAILABLE_DICT:", "            analyze_addon(addon)", ""]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import os", "import matplotlib.pyplot as plt", ""]}, {"lines": ["from website import settings", ""]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": ["    dates = [", "        record['date_created']", "        for record in comment_collection.find({}, {'date_created': True})", "    ]"]}, {"lines": ["    plot_dates(dates)"]}, {"lines": ["    plt.title('comments ({0} total)'.format(len(dates)))", "    plt.savefig(os.path.join(FIG_PATH, 'comment-actions.png'))", "    plt.close()", "", "", "if __name__ == '__main__':"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import os", "import matplotlib.pyplot as plt", ""]}, {"lines": ["from website import settings", ""]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": ["    dates = [", "        record['date_created']", "        for record in link_collection.find({}, {'date_created': True})", "    ]"]}, {"lines": ["    fig = plot_dates(dates)"]}, {"lines": ["    plt.close()", "", ""]}, {"lines": ["if __name__ == '__main__':"]}, {"lines": [""]}, {"lines": ["from cStringIO import StringIO"]}, {"lines": ["        'is_registered': True,", "        'password': {'$ne': None},", "        'is_merged': {'$ne': True},", "        'date_confirmed': {'$gte': datetime.datetime.utcnow() - delta},"]}, {"lines": ["    sio = StringIO()", "    utils.make_csv(sio, emails, ['affiliation', 'count'])"]}, {"lines": ["from cStringIO import StringIO"]}, {"lines": ["    sio = StringIO()", "    utils.make_csv(", "        sio,"]}, {"lines": ["    init_app()"]}, {"lines": ["\"\"\"", "", "\"\"\"", "", "from website.app import init_app", "from website import models", "from framework import Q", "", "app = init_app()", "", "known_schemas = [", "    'Open-Ended_Registration',", "    'OSF-Standard_Pre-Data_Collection_Registration',", "    'Replication_Recipe_(Brandt_et_al__!dot!__,_2013):_Pre-Registration',", "    'Replication_Recipe_(Brandt_et_al__!dot!__,_2013):_Post-Completion',", "]", "", "def find_bad_registrations():", "    \"\"\"Find registrations with unexpected numbers of template keys or", "    outdated templates.", "", "    \"\"\"", "    registrations = models.Node.find(", "        Q('is_registration', 'eq', True)", "    )", "    for registration in registrations:", "        meta = registration.registered_meta or {}", "        keys = meta.keys()", "        if len(keys) != 1:", "            print 'Inconsistency: Number of keys on project {} ({}) != 1'.format(", "                registration.title,", "                registration._primary_key,", "            )", "            continue", "        if keys[0] not in known_schemas:", "            print 'Inconsistency: Registration schema {} on project {} ({}) not in known schemas'.format(", "                keys[0],", "                registration.title,", "                registration._primary_key,", "            )", "", "if __name__ == '__main__':", "    find_bad_registrations()"]}, {"lines": ["\"\"\"Due to a bug in Node::fork_node, the user creating a fork was not saved", "as the creator of the forked node. This script identifies forks without a", "creator and imputes the 0th contributor as the creator.", "", "Dry run: python -m scripts/consistency/impute_creator", "Real: python -m scripts/consistency/impute_creator false", "", "\"\"\"", "", "from website.app import init_app", "from website import models", "from framework import Q", "", "app = init_app()", "", "def impute_creator(dry_run=True):", "    no_creator = models.Node.find(", "        Q('creator', 'eq', None) &", "        Q('contributors', 'ne', [])", "    )", "    for node in no_creator:"]}, {"lines": ["        print u'Imputing creator {} for node title {}'.format("]}, {"lines": ["            node.contributors[0].fullname,", "            node.title,", "        )", "        if not dry_run:", "            node.creator = node.contributors[0]", "            node.save()", "", "if __name__ == '__main__':", "    import sys", "    dry_run = len(sys.argv) == 1 or sys.argv[1].lower() not in ['f', 'false']", "    impute_creator(dry_run=dry_run)"]}, {"lines": ["\"\"\"Due to an unknown bug, wiki pages were saved without dates between", "September 4 and 6. This script identifies wiki pages without dates and", "imputes dates using ObjectIds.", "", "Dry run: python -m scripts/consistency/impute_wiki_date", "Real: python -m scripts/consistency/impute_wiki_date false", "", "\"\"\"", "", "from bson import ObjectId", "", "from website.app import init_app", "from website import models", "from framework import Q", "", "app = init_app()", "", "def impute_wiki_date(dry_run=True):", "    no_date = models.NodeWikiPage.find(", "        Q('date', 'eq', None)", "    )", "    for wiki in no_date:", "        oid = ObjectId(wiki._primary_key)", "        imputed_date = oid.generation_time"]}, {"lines": ["        print u'Imputing date {} for wiki ID {}'.format("]}, {"lines": ["            imputed_date.strftime('%c'),", "            wiki._primary_key,", "        )", "        if not dry_run:", "            wiki._fields['date'].__set__(wiki, imputed_date, safe=True)", "            wiki.save()", "", "if __name__ == '__main__':", "    import sys", "    dry_run = len(sys.argv) == 1 or sys.argv[1].lower() not in ['f', 'false']", "    impute_wiki_date(dry_run=dry_run)"]}, {"lines": ["\"\"\""]}, {"lines": ["Ensure that all GitHub web hooks have a secret key for verification."]}, {"lines": ["\"\"\"", "", "import logging", "from github3.models import GitHubError"]}, {"lines": [""]}, {"lines": ["", "from website.app import init_app", "from website.models import Node", "", "from website.addons.github.api import GitHub", "from website.addons.github import utils", "from website.addons.github import settings as github_settings"]}, {"lines": ["", ""]}, {"lines": ["logging.basicConfig(level=logging.WARN)", "", "", "def update_hook(node_settings):"]}, {"lines": [""]}, {"lines": ["        'Updating GitHub hook on node {0}'.format(", "            node_settings.owner._id", "        )", "    )", ""]}, {"lines": ["    connection = GitHub.from_settings(node_settings.user_settings)", "    repo = connection.repo(node_settings.user, node_settings.repo)", "    hook = repo.hook(node_settings.hook_id)", ""]}, {"lines": ["    secret = utils.make_hook_secret()", "", "    config = hook.config", "    config['content_type'] = github_settings.HOOK_CONTENT_TYPE", "    config['secret'] = secret", "", "    hook.edit(config=config)", "", "    node_settings.hook_secret = secret", "    node_settings.save()", "", ""]}, {"lines": ["", "", "if __name__ == '__main__':"]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8", "", "\"\"\"Verify that all OSF Storage files have Glacier backups and parity files,", "creating any missing backups.", "", "TODO: Add check against Glacier inventory", "Note: Must have par2 installed to run", "\"\"\"", ""]}, {"lines": ["from __future__ import division", ""]}, {"lines": ["import os"]}, {"lines": ["import math"]}, {"lines": ["import logging", "", "import pyrax"]}, {"lines": ["import progressbar", "from modularodm import Q"]}, {"lines": ["from boto.glacier.layer2 import Layer2"]}, {"lines": [""]}, {"lines": ["from website.app import init_app"]}, {"lines": ["from website.addons.osfstorage import model", ""]}, {"lines": ["from scripts import utils as scripts_utils", "from scripts.osfstorage import utils as storage_utils"]}, {"lines": ["from scripts.osfstorage import settings as storage_settings", "", "", "container_primary = None", "container_parity = None", "vault = None"]}, {"lines": ["", "logger = logging.getLogger(__name__)", "logging.basicConfig(level=logging.INFO)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def download_from_cloudfiles(version):"]}, {"lines": ["    if os.path.exists(path):"]}, {"lines": ["        return path"]}, {"lines": ["", "", "def delete_temp_file(version):"]}, {"lines": ["    try:", "        os.remove(path)", "    except OSError:", "        pass", "", "", "def ensure_glacier(version, dry_run):", "    if version.metadata.get('archive'):", "        return"]}, {"lines": ["    logger.warn('Glacier archive for version {0} not found'.format(version._id))"]}, {"lines": ["    if dry_run:", "        return"]}, {"lines": ["", "", "def check_parity_files(version):"]}, {"lines": ["    index = list(container_parity.list_all(prefix='{0}.par2'.format(version.location['object'])))", "    vols = list(container_parity.list_all(prefix='{0}.vol'.format(version.location['object'])))", "    return len(index) == 1 and len(vols) >= 1"]}, {"lines": ["", "", "def ensure_parity(version, dry_run):", "    if check_parity_files(version):", "        return"]}, {"lines": ["    logger.warn('Parity files for version {0} not found'.format(version._id))"]}, {"lines": ["    if dry_run:", "        return", "    file_path = download_from_cloudfiles(version)"]}, {"lines": ["", "", "def ensure_backups(version, dry_run):"]}, {"lines": ["    if version.size == 0:"]}, {"lines": ["        return"]}, {"lines": ["    ensure_glacier(version, dry_run)", "    ensure_parity(version, dry_run)", "    delete_temp_file(version)", "", "", "def get_targets():"]}, {"lines": ["", ""]}, {"lines": ["def main(nworkers, worker_id, dry_run):"]}, {"lines": ["    targets = get_targets()"]}, {"lines": ["    idx = 0"]}, {"lines": ["        if hash(version._id) % nworkers == worker_id:", "            ensure_backups(version, dry_run)"]}, {"lines": ["            idx += 1"]}, {"lines": ["    progress_bar.finish()"]}, {"lines": ["", "", "if __name__ == '__main__':", "    import sys"]}, {"lines": ["    nworkers = int(sys.argv[1])", "    worker_id = int(sys.argv[2])"]}, {"lines": ["    dry_run = 'dry' in sys.argv", ""]}, {"lines": ["    # Set up storage backends"]}, {"lines": ["    init_app(set_backends=True, routes=False)"]}, {"lines": [""]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8", "\"\"\"Begin retrieve inventory job on Glacier vault. Should be run in conjunction", "with `glacier_audit.py`.", "\"\"\"", "", "import logging", "import datetime", "", "from boto.glacier.layer2 import Layer2", "", "from scripts import utils as scripts_utils", "from scripts.osfstorage import settings as storage_settings", "", "", "logger = logging.getLogger(__name__)", "logging.basicConfig(level=logging.INFO)", "scripts_utils.add_file_logger(logger, __file__)", "", "", "def get_vault():", "    layer2 = Layer2(", "        aws_access_key_id=storage_settings.AWS_ACCESS_KEY,", "        aws_secret_access_key=storage_settings.AWS_SECRET_KEY,", "    )", "    return layer2.get_vault(storage_settings.GLACIER_VAULT)", "", "", "def main():", "    vault = get_vault()", "    job = vault.retrieve_inventory_job(", "        description='glacier-audit-{}'.format(datetime.datetime.utcnow().strftime('%c')),", "        sns_topic=storage_settings.AWS_SNS_ARN,", "    )", "    logger.info('Started retrieve inventory job with id {}'.format(job.id))", "", "", "if __name__ == '__main__':", "    main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from nose.tools import *  # noqa", "", "from tests.base import OsfTestCase", "from tests.factories import UserFactory", "from tests.factories import NodeFactory", "from tests.test_conferences import ConferenceFactory", "", "from scripts.migrate_conference_admins import migrate_node", "", "", "class TestMigrateAdmins(OsfTestCase):", "", "    def test_migrate_node(self):"]}, {"lines": ["        external_admin = UserFactory()", "        personal_admin = UserFactory()"]}, {"lines": ["        staff_user = UserFactory()"]}, {"lines": ["        personal_accounts = [personal_admin.username]", "        conference = ConferenceFactory(admins=[external_admin, personal_admin])", "        node = NodeFactory()", "        node.add_contributor(staff_user)", "        node.add_contributor(external_admin)", "        node.add_contributor(personal_admin)", "        migrate_node(node, conference, staff_user, personal_accounts, dry_run=False)"]}, {"lines": ["        node.reload()", "        assert_in(staff_user, node.contributors)"]}, {"lines": ["        assert_in(external_admin, node.contributors)", "        assert_not_in(personal_admin, node.contributors)"]}, {"lines": ["        # Verify that migration is idempotent"]}, {"lines": ["        migrate_node(node, conference, staff_user, personal_accounts, dry_run=False)"]}, {"lines": ["        node.reload()", "        assert_in(staff_user, node.contributors)"]}, {"lines": ["        assert_in(external_admin, node.contributors)", "        assert_not_in(personal_admin, node.contributors)"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from nose.tools import *  # noqa", "", "from tests.base import fake", "from tests.base import OsfTestCase", "from tests.factories import UserFactory", "from tests.factories import NodeFactory", "from tests.factories import UnconfirmedUserFactory", "", "from framework.auth.core import Auth", "", "from scripts.migrate_was_invited import main", "from scripts.migrate_was_invited import is_invited", "", "", "class TestWasInvited(OsfTestCase):", "", "    def test_was_invited(self):", "        referrer = UserFactory()", "        node = NodeFactory(creator=referrer)", "        name = fake.name()", "        email = fake.email()", "        user = node.add_unregistered_contributor(", "            fullname=name,", "            email=email,", "            auth=Auth(user=referrer),", "        )", "        user.register(email, 'secret')", "        assert_true(is_invited(user))", "        user.is_invited = None", "        user.save()", "        main(dry_run=False)", "        user.reload()", "        assert_true(user.is_invited)", "", "    def test_was_not_invited(self):", "        referrer = UserFactory()", "        node = NodeFactory(creator=referrer)", "        user = UserFactory()", "        node.add_contributor(user, auth=Auth(referrer))", "        assert_false(is_invited(user))", "        user.is_invited = None", "        user.save()", "        main(dry_run=False)", "        user.reload()", "        assert_false(user.is_invited)", "", "    def test_was_not_invited_unconfirmed(self):", "        user = UnconfirmedUserFactory()", "        assert_false(is_invited(user))", "        user.is_invited = None", "        user.save()", "        main(dry_run=False)", "        user.reload()", "        assert_false(user.is_invited)"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import mock", "from nose.tools import *  # noqa", "", "from tests.base import OsfTestCase", "", "from website.addons.box.tests import factories", "", "import datetime", "", "from dateutil.relativedelta import relativedelta", "", "from website.addons.box import model", "", "from scripts.refresh_box_tokens import get_targets, main", "", "", "class TestRefreshTokens(OsfTestCase):", "", "    def tearDown(self):", "        super(TestRefreshTokens, self).tearDown()", "        model.BoxOAuthSettings.remove()", "", "    def test_get_targets(self):", "        now = datetime.datetime.utcnow()", "        records = [", "            factories.BoxOAuthSettingsFactory(expires_at=now + datetime.timedelta(days=8)),", "            factories.BoxOAuthSettingsFactory(expires_at=now + datetime.timedelta(days=6)),", "        ]", "        targets = list(get_targets(delta=relativedelta(days=7)))", "        assert_in(records[1], targets)", "        assert_not_in(records[0], targets)", "", "    @mock.patch('website.addons.box.model.BoxOAuthSettings.refresh_access_token')", "    def test_refresh(self, mock_refresh):", "        factories.BoxOAuthSettingsFactory(expires_at=datetime.datetime.utcnow())", "        main(delta=relativedelta(days=7), dry_run=False)", "        mock_refresh.assert_called_once_with(force=True)"]}, {"lines": [""]}, {"lines": ["import unittest"]}, {"lines": [""]}, {"lines": ["from framework.auth import signing"]}, {"lines": ["", "", "class TestAddonConfig(unittest.TestCase):", "", "    def setUp(self):", "        self.addon_config = AddonConfig("]}, {"lines": ["            short_name='test', full_name='test', owners=['node'],", "            added_to={'node': False}, categories=[],"]}, {"lines": ["            settings_model=AddonNodeSettingsBase,"]}, {"lines": ["        )", "", "    def test_static_url_relative(self):", "        url = self.addon_config._static_url('foo')", "        assert_equal(", "            url,"]}, {"lines": ["        )", ""]}, {"lines": ["    def test_static_url_absolute(self):", "        url = self.addon_config._static_url('/foo')", "        assert_equal(", "            url,", "            '/foo'", "        )"]}, {"lines": ["class TestAddonLogs(OsfTestCase):", "", "    def setUp(self):", "        super(TestAddonLogs, self).setUp()", "        self.flask_app = SetEnvironMiddleware(self.app.app, REMOTE_ADDR='127.0.0.1')", "        self.test_app = webtest.TestApp(self.flask_app)", "        self.user = AuthUserFactory()", "        self.auth_obj = Auth(user=self.user)", "        self.node = ProjectFactory(creator=self.user)", "        self.session = Session(data={'auth_user_id': self.user._id})", "        self.session.save()", "        self.cookie = itsdangerous.Signer(settings.SECRET_KEY).sign(self.session._id)", "        self.configure_addon()", "", "    def configure_addon(self):", "        self.user.add_addon('github')", "        self.user_addon = self.user.get_addon('github')", "        self.oauth_settings = AddonGitHubOauthSettings(github_user_id='john')", "        self.oauth_settings.save()", "        self.user_addon.oauth_settings = self.oauth_settings", "        self.user_addon.oauth_access_token = 'secret'", "        self.user_addon.save()", "        self.node.add_addon('github', self.auth_obj)", "        self.node_addon = self.node.get_addon('github')", "        self.node_addon.user = 'john'", "        self.node_addon.repo = 'youre-my-best-friend'", "        self.node_addon.user_settings = self.user_addon", "        self.node_addon.save()", "", "    def build_payload(self, metadata, **kwargs):", "        options = dict(", "            auth={'id': self.user._id},", "            action='create',", "            provider=self.node_addon.config.short_name,", "            metadata=metadata,", "            time=time.time() + 1000,", "        )", "        options.update(kwargs)", "        options = {", "            key: value", "            for key, value in options.iteritems()", "            if value is not None", "        }", "        message, signature = signing.default_signer.sign_payload(options)", "        return {", "            'payload': message,", "            'signature': signature,", "        }", "", "    def test_add_log(self):", "        path = 'pizza'", "        url = self.node.api_url_for('create_waterbutler_log')", "        payload = self.build_payload(metadata={'path': path})", "        nlogs = len(self.node.logs)", "        self.test_app.put_json(url, payload, headers={'Content-Type': 'application/json'})", "        self.node.reload()", "        assert_equal(len(self.node.logs), nlogs + 1)", "", "    def test_add_log_missing_args(self):", "        path = 'pizza'", "        url = self.node.api_url_for('create_waterbutler_log')", "        payload = self.build_payload(metadata={'path': path}, auth=None)", "        nlogs = len(self.node.logs)", "        res = self.test_app.put_json(", "            url,", "            payload,", "            headers={'Content-Type': 'application/json'},", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)", "        self.node.reload()", "        assert_equal(len(self.node.logs), nlogs)", "", "    def test_add_log_no_user(self):", "        path = 'pizza'", "        url = self.node.api_url_for('create_waterbutler_log')", "        payload = self.build_payload(metadata={'path': path}, auth={'id': None})", "        nlogs = len(self.node.logs)", "        res = self.test_app.put_json(", "            url,", "            payload,", "            headers={'Content-Type': 'application/json'},", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)", "        self.node.reload()", "        assert_equal(len(self.node.logs), nlogs)", "", "    def test_add_log_no_addon(self):", "        path = 'pizza'", "        node = ProjectFactory(creator=self.user)", "        url = node.api_url_for('create_waterbutler_log')", "        payload = self.build_payload(metadata={'path': path})", "        nlogs = len(node.logs)", "        res = self.test_app.put_json(", "            url,", "            payload,", "            headers={'Content-Type': 'application/json'},", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)", "        self.node.reload()", "        assert_equal(len(node.logs), nlogs)", "", "    def test_add_log_bad_action(self):", "        path = 'pizza'", "        url = self.node.api_url_for('create_waterbutler_log')", "        payload = self.build_payload(metadata={'path': path}, action='dance')", "        nlogs = len(self.node.logs)", "        res = self.test_app.put_json(", "            url,", "            payload,", "            headers={'Content-Type': 'application/json'},", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 400)", "        self.node.reload()", "        assert_equal(len(self.node.logs), nlogs)", "", ""]}, {"lines": ["    def test_nonexistent_addons_raise(self):"]}, {"lines": ["from nose.tools import *  # noqa; PEP8 asserts"]}, {"lines": ["from webtest_plus import TestApp"]}, {"lines": ["from framework import auth"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from tests.base import OsfTestCase, assert_is_redirect", "from tests.factories import (", "    UserFactory, UnregUserFactory, AuthFactory,"]}, {"lines": ["    ProjectFactory, NodeFactory, AuthUserFactory, PrivateLinkFactory"]}, {"lines": ["from framework.auth import User, Auth", "from framework.auth.decorators import must_be_logged_in"]}, {"lines": ["from website.project.decorators import (", "    must_have_permission, must_be_contributor,", "    must_have_addon, must_be_addon_authorizer,", ")"]}, {"lines": ["class TestAuthUtils(OsfTestCase):"]}, {"lines": ["        auth.register_unconfirmed(", "            username=user.username,", "            password='gattaca',", "            fullname='Rosie',", "        )"]}, {"lines": ["        assert_false("]}, {"lines": ["        )"]}, {"lines": ["class TestAuthObject(OsfTestCase):"]}, {"lines": ["        assert_true(isinstance(auth_obj.user, auth.User))"]}, {"lines": [""]}, {"lines": ["class TestPrivateLink(OsfTestCase):"]}, {"lines": ["        super(TestPrivateLink, self).setUp()"]}, {"lines": ["class AuthAppTestCase(OsfTestCase):"]}, {"lines": [""]}, {"lines": ["    def test_must_be_contributor_parent_admin(self):", "        user = UserFactory()"]}, {"lines": ["        res = view_that_needs_contributor(", "            pid=self.project._id,", "            nid=node._id,", "            user=self.project.creator,", "        )"]}, {"lines": ["", "    def test_must_be_contributor_parent_write(self):", "        user = UserFactory()"]}, {"lines": ["        self.project.set_permissions(self.project.creator, ['read', 'write'])", "        self.project.save()", "        with assert_raises(HTTPError) as exc_info:", "            view_that_needs_contributor(", "                pid=self.project._id,", "                nid=node._id,", "                user=self.project.creator,", "            )", "        assert_equal(exc_info.exception.code, 403)", ""]}, {"lines": ["@must_have_permission('dance')", "def thriller(**kwargs):", "    return 'chiller'", ""]}, {"lines": ["    @mock.patch('framework.auth.decorators.Auth.from_kwargs')", "    def test_must_be_logged_in_decorator_with_user(self, mock_from_kwargs):"]}, {"lines": ["        mock_from_kwargs.return_value = Auth(user=user)", "        protected()", "", "    @mock.patch('framework.auth.decorators.Auth.from_kwargs')", "    def test_must_be_logged_in_decorator_with_no_user(self, mock_from_kwargs):", "        mock_from_kwargs.return_value = Auth()", "        resp = protected()", "        assert_true(isinstance(resp, BaseResponse))"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.project.decorators._kwargs_to_nodes')"]}, {"lines": ["    @mock.patch('framework.auth.decorators.Auth.from_kwargs')"]}, {"lines": ["    def test_must_have_permission_true(self, mock_from_kwargs, mock_to_nodes):"]}, {"lines": ["        project = ProjectFactory()", "        project.add_permission(project.creator, 'dance')", "        mock_from_kwargs.return_value = Auth(user=project.creator)"]}, {"lines": ["        thriller(node=project)", ""]}, {"lines": ["    @mock.patch('website.project.decorators._kwargs_to_nodes')"]}, {"lines": ["    @mock.patch('framework.auth.decorators.Auth.from_kwargs')"]}, {"lines": ["    def test_must_have_permission_false(self, mock_from_kwargs, mock_to_nodes):"]}, {"lines": ["        project = ProjectFactory()", "        mock_from_kwargs.return_value = Auth(user=project.creator)"]}, {"lines": ["        with assert_raises(HTTPError) as ctx:", "            thriller(node=project)", "        assert_equal(ctx.exception.code, http.FORBIDDEN)", ""]}, {"lines": ["    @mock.patch('website.project.decorators._kwargs_to_nodes')"]}, {"lines": ["    @mock.patch('framework.auth.decorators.Auth.from_kwargs')"]}, {"lines": ["    def test_must_have_permission_not_logged_in(self, mock_from_kwargs, mock_to_nodes):"]}, {"lines": ["        project = ProjectFactory()", "        mock_from_kwargs.return_value = Auth()"]}, {"lines": ["        with assert_raises(HTTPError) as ctx:", "            thriller(node=project)", "        assert_equal(ctx.exception.code, http.UNAUTHORIZED)"]}, {"lines": ["def needs_addon_view(**kwargs):", "    return 'openaddon'", "", "", "class TestMustHaveAddonDecorator(AuthAppTestCase):", "", "    def setUp(self):", "        super(TestMustHaveAddonDecorator, self).setUp()", "        self.project = ProjectFactory()", "", "    @mock.patch('website.project.decorators._kwargs_to_nodes')", "    def test_must_have_addon_node_true(self, mock_kwargs_to_nodes):"]}, {"lines": ["        self.project.add_addon('github', auth=None)", "        decorated = must_have_addon('github', 'node')(needs_addon_view)", "        res = decorated()", "        assert_equal(res, 'openaddon')", "", "    @mock.patch('website.project.decorators._kwargs_to_nodes')", "    def test_must_have_addon_node_false(self, mock_kwargs_to_nodes):"]}, {"lines": ["        decorated = must_have_addon('github', 'node')(needs_addon_view)", "        with assert_raises(HTTPError):", "            decorated()", ""]}, {"lines": ["    def test_must_have_addon_user_true(self, mock_current_user):"]}, {"lines": ["        self.project.creator.add_addon('github')", "        decorated = must_have_addon('github', 'user')(needs_addon_view)", "        res = decorated()", "        assert_equal(res, 'openaddon')", ""]}, {"lines": ["    def test_must_have_addon_user_false(self, mock_current_user):"]}, {"lines": ["        decorated = must_have_addon('github', 'user')(needs_addon_view)", "        with assert_raises(HTTPError):", "            decorated()", "", "", "class TestMustBeAddonAuthorizerDecorator(AuthAppTestCase):", "", "    def setUp(self):", "        super(TestMustBeAddonAuthorizerDecorator, self).setUp()", "        self.project = ProjectFactory()", "        self.decorated = must_be_addon_authorizer('github')(needs_addon_view)", "", "    @mock.patch('website.project.decorators._kwargs_to_nodes')"]}, {"lines": ["    def test_must_be_authorizer_true(self, mock_get_current_user, mock_kwargs_to_nodes):", "", "        # Mock"]}, {"lines": ["", "        # Setup", "        self.project.add_addon('github', auth=None)", "        node_settings = self.project.get_addon('github')", "        self.project.creator.add_addon('github')", "        user_settings = self.project.creator.get_addon('github')", "        node_settings.user_settings = user_settings", "", "        # Test", "        res = self.decorated()", "        assert_equal(res, 'openaddon')", "", "    def test_must_be_authorizer_false(self):", "", "        # Setup", "        self.project.add_addon('github', auth=None)", "        node_settings = self.project.get_addon('github')", "        user2 = UserFactory()", "        user2.add_addon('github')", "        user_settings = user2.get_addon('github')", "        node_settings.user_settings = user_settings", "", "        # Test", "        with assert_raises(HTTPError):", "            self.decorated()", "", "    def test_must_be_authorizer_no_user_settings(self):", "        self.project.add_addon('github', auth=None)", "        with assert_raises(HTTPError):", "            self.decorated()", "", "    def test_must_be_authorizer_no_node_settings(self):", "        with assert_raises(HTTPError):", "            self.decorated()", ""]}, {"lines": [""]}, {"lines": ["from website.conferences import views"]}, {"lines": ["def assert_equal_urls(first, second):", "    parsed_first = furl.furl(first)", "    parsed_first.port = None", "    parsed_second = furl.furl(second)", "    parsed_second.port = None", "    assert_equal(parsed_first, parsed_second)", "", ""]}, {"lines": ["        create_fake_conference_nodes("]}, {"lines": ["        assert_equal(len(res.json), n_conference_nodes)", "", "    def test_conference_data_url_upper(self):", "        conference = ConferenceFactory()", "", "        # Create conference nodes", "        n_conference_nodes = 3", "        create_fake_conference_nodes(", "            n_conference_nodes,", "            conference.endpoint,", "        )", "        # Create a non-conference node", "        ProjectFactory()", "", "        url = api_url_for('conference_data', meeting=conference.endpoint.upper())", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), n_conference_nodes)", "", "    def test_conference_data_tag_upper(self):", "        conference = ConferenceFactory()", "", "        # Create conference nodes", "        n_conference_nodes = 3", "        create_fake_conference_nodes(", "            n_conference_nodes,", "            conference.endpoint.upper(),", "        )", "        # Create a non-conference node", "        ProjectFactory()", "", "        url = api_url_for('conference_data', meeting=conference.endpoint)", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "        assert_equal(len(res.json), n_conference_nodes)"]}, {"lines": ["        self.app.post("]}, {"lines": ["", "    @mock.patch('website.conferences.views.send_mail')", "    def test_integration_inactive(self, mock_send_mail):", "        conference = ConferenceFactory(active=False)", "        fullname = 'John Deacon'", "        username = 'deacon@queen.com'", "        title = 'good songs'", "        body = 'dragon on my back'"]}, {"lines": ["        recipient = '{0}{1}-poster@osf.io'.format(", "            'test-' if settings.DEV_MODE else '',", "            conference.endpoint,", "        )", "        res = self.app.post(", "            api_url_for('meeting_hook'),", "            {", "                'X-Mailgun-Sscore': 0,", "                'timestamp': '123',", "                'token': 'secret',", "                'signature': hmac.new(", "                    key=settings.MAILGUN_API_KEY,", "                    msg='{}{}'.format('123', 'secret'),", "                    digestmod=hashlib.sha256,", "                ).hexdigest(),", "                'attachment-count': '1',", "                'X-Mailgun-Sscore': 0,", "                'from': '{0} <{1}>'.format(fullname, username),", "                'recipient': recipient,", "                'subject': title,", "                'stripped-text': body,", "            },", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 406)", "        call_args, call_kwargs = mock_send_mail.call_args", "        assert_equal(call_args, (username, views.CONFERENCE_INACTIVE))", "        assert_equal(call_kwargs['fullname'], fullname)", "        assert_equal_urls(", "            call_kwargs['presentations_url'],", "            web_url_for('conference_view', _absolute=True),", "        )"]}, {"lines": ["from framework.auth.core import Auth"]}, {"lines": ["@requires_search"]}, {"lines": ["        super(SearchTestCase, self).tearDown()"]}, {"lines": ["", "@requires_search"]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        super(TestUserUpdate, self).setUp()"]}, {"lines": ["        self.user = UserFactory(fullname='David Bowie')"]}, {"lines": ["    def test_new_user(self):"]}, {"lines": ["        assert_equal(len(docs), 1)", "", "    def test_new_user_unconfirmed(self):", "        user = UnconfirmedUserFactory()"]}, {"lines": ["        assert_equal(len(docs), 0)", "        token = user.get_confirmation_token(user.username)", "        user.confirm_email(token)", "        user.save()"]}, {"lines": [""]}, {"lines": ["@requires_search"]}, {"lines": ["        super(TestProject, self).setUp()"]}, {"lines": [""]}, {"lines": ["@requires_search"]}, {"lines": ["        super(TestPublicNodes, self).setUp()"]}, {"lines": ["            'home', wiki_content, self.consolidate_auth,", "        )"]}, {"lines": ["    def test_hide_contributor(self):", "        user2 = UserFactory(fullname='Brian May')", "        self.project.add_contributor(user2)", "        self.project.set_visible(user2, False, save=True)"]}, {"lines": ["        assert_equal(len(docs), 0)", "        self.project.set_visible(user2, True, save=True)"]}, {"lines": ["        assert_equal(len(docs), 1)", ""]}, {"lines": [""]}, {"lines": ["@requires_search"]}, {"lines": ["        super(TestAddContributor, self).setUp()"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import mock", "from nose.tools import *  # noqa", "", "from tests.base import OsfTestCase", "from tests.factories import NodeFactory", "", "from modularodm import Q", "from modularodm import fields", "from modularodm.storage.mongostorage import MongoStorage", "", "from framework.mongo import database", "from framework.guid.model import GuidStoredObject", "", "from website import models", "", "", "class TestGuidStoredObject(OsfTestCase):", "", "    def test_guid_stored_object(self):", "        class FakeSchema(GuidStoredObject):", "            _id = fields.StringField()", "            @property", "            def deep_url(self):", "                return 'http://dinosaurs.sexy'", "        FakeSchema.set_storage(MongoStorage(database, 'fakeschema'))", "        fake_guid = FakeSchema(_id='fake')", "        fake_guid.save()", "        guids = models.Guid.find(Q('_id', 'eq', 'fake'))", "        assert_equal(guids.count(), 1)", "        assert_equal(guids[0].referent, fake_guid)", "        assert_equal(guids[0]._id, fake_guid._id)", "", "", "class TestResolveGuid(OsfTestCase):", "", "    def setUp(self):", "        super(TestResolveGuid, self).setUp()", "        self.node = NodeFactory()", "", "    def test_resolve_guid(self):", "        res_guid = self.app.get(self.node.web_url_for('node_setting', _guid=True), auth=self.node.creator.auth)", "        res_full = self.app.get(self.node.web_url_for('node_setting'), auth=self.node.creator.auth)", "        assert_equal(res_guid.text, res_full.text)", "", "    def test_resolve_guid_no_referent(self):", "        guid = models.Guid.load(self.node._id)", "        guid.referent = None", "        guid.save()", "        res = self.app.get(", "            self.node.web_url_for('node_setting', _guid=True),", "            auth=self.node.creator.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 404)", "", "    @mock.patch('website.project.model.Node.deep_url', None)", "    def test_resolve_guid_no_url(self):", "        res = self.app.get(", "            self.node.web_url_for('node_setting', _guid=True),", "            auth=self.node.creator.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, 404)"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from nose.tools import *  # noqa; PEP8 asserts"]}, {"lines": ["        mock_client.lists.subscribe.assert_called_with(", "            id=list_id,", "            email={'email': user.username},", "            merge_vars={", "                'fname': user.given_name,", "                'lname': user.family_name,", "            },", "            double_optin=False,", "            update_existing=True,", "        )"]}, {"lines": ["        mock_client.lists.unsubscribe.assert_called_with(id=list_id, email={'email': user.username})"]}, {"lines": ["# -*- coding: utf-8 -*-", "'''Unit tests for models and their factories.'''", "import unittest", "from nose.tools import *  # PEP8 asserts", ""]}, {"lines": ["from framework.forms.utils import process_payload"]}, {"lines": ["", "from website.project.model import MetaSchema", "from website.project.model import ensure_schemas", "from website.project.metadata.schemas import OSF_META_SCHEMAS", ""]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["", ""]}, {"lines": ["class TestMetaData(OsfTestCase):"]}, {"lines": ["", "    def test_ensure_schemas(self):", "", "        # Should be zero MetaSchema records to begin with", "        assert_equal(", "            MetaSchema.find().count(),", "            0", "        )", "", "        ensure_schemas()", "", "        assert_equal(", "            MetaSchema.find().count(),", "            len(OSF_META_SCHEMAS)", "        )", ""]}, {"lines": ["    def test_process(self):"]}, {"lines": ["        processed = process_payload({'foo': 'bar&baz'})", "        assert_equal(processed['foo'], 'bar%26baz')"]}, {"lines": [""]}, {"lines": ["    def test_process_list(self):"]}, {"lines": ["        processed = process_payload({'foo': ['bar', 'baz&bob']})", "        assert_equal(processed['foo'][1], 'baz%26bob')"]}, {"lines": [""]}, {"lines": ["    def test_process_whitespace(self):", "        processed = process_payload({'foo': 'bar baz'})", "        assert_equal(processed['foo'], 'bar baz')", ""]}, {"lines": [""]}, {"lines": ["if __name__ == '__main__':", "    unittest.main()"]}, {"lines": ["            url=self.project.absolute_url,"]}, {"lines": ["            url=self.project.absolute_url,", "        )"]}, {"lines": ["            localized_timestamp=emails.localize_timestamp(timestamp, self.user),", "        )"]}, {"lines": ["            url=self.project.absolute_url + 'settings/',"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestSanitize(unittest.TestCase):"]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": [""]}, {"lines": ["class TestNodeSerializers(OsfTestCase):"]}, {"lines": ["        super(TestAddContributorJson, self).setUp()"]}, {"lines": ["        }]"]}, {"lines": ["        }]"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["import unittest"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "", "TEST_COLLECTION_NAME = 'transactions'"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "    @classmethod", "    def setUpClass(cls):", "        super(TestTransactionContext, cls).setUpClass()", "        try:"]}, {"lines": ["        except CollectionInvalid:", "            pass"]}, {"lines": ["", "    def tearDown(self):"]}, {"lines": ["        super(TestTransactionContext, self).tearDown()"]}, {"lines": ["        self.collection.remove()", "", "    def test_commit(self):"]}, {"lines": ["            self.collection.insert({'hammer': 'to fall'})", "            assert_true(txn.pending)", "        assert_equal(self.collection.count(), 1)", "", "    def test_exception_triggers_rollback(self):", "        with assert_raises(Exception):"]}, {"lines": ["                self.collection.insert({'hammer': 'to fall'})", "                raise Exception", "        assert_equal(self.collection.count(), 0)", "", "    def test_nested_contexts(self):"]}, {"lines": ["            self.collection.insert({'stone': 'cold'})"]}, {"lines": ["                self.collection.insert({'crazy': 'yeah'})", "                assert_true(txn1.pending)", "                assert_false(txn2.pending)", "        assert_equal(self.collection.count(), 2)", "", "    def test_nested_exception_triggers_rollback(self):", "        with assert_raises(Exception):"]}, {"lines": ["                self.collection.insert({'stone': 'cold'})"]}, {"lines": ["                    self.collection.insert({'crazy': 'yeah'})", "                    raise Exception", "        assert_equal(self.collection.count(), 0)", "", ""]}, {"lines": ["if __name__ == '__main__':", "    unittest.run()"]}, {"lines": ["import json"]}, {"lines": ["import httplib as http"]}, {"lines": ["from modularodm import Q"]}, {"lines": [""]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from framework.auth import User, Auth"]}, {"lines": ["from framework.auth.utils import impute_names_model"]}, {"lines": ["from tests.factories import (", "    UserFactory, ApiKeyFactory, ProjectFactory, WatchConfigFactory,"]}, {"lines": ["    NodeFactory, NodeLogFactory, AuthUserFactory, UnregUserFactory,"]}, {"lines": [")"]}, {"lines": [""]}, {"lines": ["class TestViewingProjectWithPrivateLink(OsfTestCase):"]}, {"lines": ["        super(TestViewingProjectWithPrivateLink, self).setUp()"]}, {"lines": ["        self.project_url = self.project.web_url_for('view_project')"]}, {"lines": ["        assert_equal(", "            res.request.path,"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["class TestProjectViews(OsfTestCase):"]}, {"lines": ["        super(TestProjectViews, self).setUp()"]}, {"lines": ["        ensure_schemas()"]}, {"lines": ["        self.project = ProjectFactory(", "            title=\"Ham\",", "            description='Honey-baked',", "            creator=self.user1", "        )"]}, {"lines": [""]}, {"lines": ["        dict2.update({", "            'permission': 'admin',", "            'visible': True,", "        })", "        dict3.update({", "            'permission': 'write',", "            'visible': False,", "        })"]}, {"lines": [""]}, {"lines": ["        self.app.post_json(", "            url,", "            {"]}, {"lines": ["                'users': [dict2, dict3],"]}, {"lines": ["                'node_ids': [project._id],", "            },", "            content_type=\"application/json\",", "            auth=self.auth,", "        ).maybe_follow()"]}, {"lines": ["        assert_in(user2._id, project.permissions)", "        assert_in(user3._id, project.permissions)", "        assert_equal(project.permissions[user2._id], ['read', 'write', 'admin'])", "        assert_equal(project.permissions[user3._id], ['read', 'write'])", "", "    def test_manage_permissions(self):", "", "        url = self.project.api_url + 'contributors/manage/'", "        self.app.post_json(", "            url,", "            {", "                'contributors': ["]}, {"lines": ["                ]", "            },", "            auth=self.auth,", "        )", "", "        self.project.reload()", "", "        assert_equal(self.project.get_permissions(self.user1), ['read'])", "        assert_equal(self.project.get_permissions(self.user2), ['read', 'write', 'admin'])", ""]}, {"lines": ["    def test_contributor_manage_reorder(self):", "", "        # Two users are added as a contributor via a POST request", "        project = ProjectFactory(creator=self.user1, is_public=True)", "        reg_user1, reg_user2 = UserFactory(), UserFactory()"]}, {"lines": ["        project.add_contributors(", "            ["]}, {"lines": ["            ]", "        )"]}, {"lines": ["        # Add a non-registered user"]}, {"lines": ["        unregistered_user = project.add_unregistered_contributor(", "            fullname=fake.name(), email=fake.email(),", "            auth=self.consolidate_auth1,"]}, {"lines": ["            save=True,"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["        url = project.api_url + 'contributors/manage/'"]}, {"lines": ["        self.app.post_json(", "            url,", "            {", "                'contributors': ["]}, {"lines": ["                ]", "            },", "            auth=self.auth,", "        )", "", "        project.reload()", ""]}, {"lines": ["        assert_equal(", "            # Note: Cast ForeignList to list for comparison", "            list(project.contributors),"]}, {"lines": ["        )"]}, {"lines": ["        project.add_unregistered_contributor("]}, {"lines": ["    def test_cant_make_public_if_not_admin(self):", "        non_admin = AuthUserFactory()", "        self.project.add_contributor(non_admin, permissions=['read', 'write'])", "        self.project.is_public = False", "        self.project.save()", "        url = \"/api/v1/project/{0}/permissions/public/\".format(self.project._id)", "        res = self.app.post_json(", "            url, {}, auth=non_admin.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, http.FORBIDDEN)", "        assert_false(self.project.is_public)", "", "    def test_cant_make_private_if_not_admin(self):", "        non_admin = AuthUserFactory()", "        self.project.add_contributor(non_admin, permissions=['read', 'write'])", "        self.project.is_public = True", "        self.project.save()", "        url = \"/api/v1/project/{0}/permissions/private/\".format(self.project._id)", "        res = self.app.post_json(", "            url, {}, auth=non_admin.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, http.FORBIDDEN)", "        assert_true(self.project.is_public)", ""]}, {"lines": ["        url = \"/api/v1/project/{0}/addtag/{tag}/\".format(", "            self.project._primary_key,", "            tag=\"footag\",", "        )"]}, {"lines": ["        self.project.add_tag(\"footag\", auth=self.consolidate_auth1, save=True)"]}, {"lines": ["        url = \"/api/v1/project/{0}/removetag/{tag}/\".format(", "            self.project._primary_key,", "            tag=\"footag\",", "        )"]}, {"lines": ["            self.project.logs.append(", "                NodeLogFactory(", "                    user=self.user1,", "                    action='file_added',"]}, {"lines": ["                )", "            )"]}, {"lines": ["        assert_equal(most_recent['action'], 'file_added')"]}, {"lines": ["            self.project.logs.append(", "                NodeLogFactory(", "                    user=self.user1,", "                    action='file_added',"]}, {"lines": ["                )", "            )"]}, {"lines": ["        res = self.app.get(url, {'count': 3}, auth=self.auth)"]}, {"lines": ["            self.project.logs.append(", "                NodeLogFactory(", "                    user=self.user1,", "                    action='file_added',"]}, {"lines": ["                )", "            )"]}, {"lines": ["            self.project.logs.append(", "                NodeLogFactory(", "                    user=self.user1,", "                    action=\"file_added\","]}, {"lines": ["                )", "            )"]}, {"lines": ["    def test_logs_private(self):", "        \"\"\"Add logs to a public project, then to its private component. Get", "        the ten most recent logs; assert that ten logs are returned and that", "        all belong to the project and not its component.", "", "        \"\"\"", "        # Add some logs"]}, {"lines": ["            self.project.add_log("]}, {"lines": ["                auth=self.consolidate_auth1,"]}, {"lines": ["                action='file_added',"]}, {"lines": ["            )", "        self.project.is_public = True", "        self.project.save()"]}, {"lines": ["            child.add_log("]}, {"lines": ["                auth=self.consolidate_auth1,"]}, {"lines": ["                action='file_added',"]}, {"lines": ["            )"]}, {"lines": ["        res = self.app.get(url).maybe_follow()", "        assert_equal(len(res.json['logs']), 10)"]}, {"lines": ["        assert_equal(", "            [self.project._id] * 10,", "            ["]}, {"lines": ["                for log in res.json['logs']", "            ]", "        )", ""]}, {"lines": ["    def test_remove_project(self):"]}, {"lines": ["        url = self.project.api_url"]}, {"lines": ["        res = self.app.delete_json(url, {}, auth=self.auth).maybe_follow()", "        self.project.reload()", "        assert_equal(self.project.is_deleted, True)", "        assert_in('url', res.json)", "        assert_equal(res.json['url'], '/dashboard/')", ""]}, {"lines": ["        self.app.put_json(", "            url,", "            {'pk': link._id, \"value\": \"new name\"},", "            auth=self.auth,", "        ).maybe_follow()"]}, {"lines": ["        url = self.project.api_url_for('remove_private_link')"]}, {"lines": ["        self.app.delete_json(", "            url,", "            {'private_link_id': link._id},", "            auth=self.auth,", "        ).maybe_follow()"]}, {"lines": ["    def test_remove_component(self):"]}, {"lines": ["        url = node.api_url"]}, {"lines": ["        res = self.app.delete_json(url, {}, auth=self.auth).maybe_follow()", "        node.reload()", "        assert_equal(node.is_deleted, True)", "        assert_in('url', res.json)", "        assert_equal(res.json['url'], self.project.url)"]}, {"lines": ["    def test_cant_remove_component_if_not_admin(self):"]}, {"lines": ["        non_admin = AuthUserFactory()", "        node.add_contributor(", "            non_admin,", "            permissions=['read', 'write'],", "            save=True,", "        )", "", "        url = node.api_url", "        res = self.app.delete_json(", "            url, {}, auth=non_admin.auth,", "            expect_errors=True,", "        ).maybe_follow()", "", "        assert_equal(res.status_code, http.FORBIDDEN)", "        assert_false(node.is_deleted)"]}, {"lines": ["class TestUserProfile(OsfTestCase):", "", "    def setUp(self):", "        super(TestUserProfile, self).setUp()"]}, {"lines": ["        self.user = AuthUserFactory()", ""]}, {"lines": ["    def test_unserialize_social(self):", "        url = api_url_for('unserialize_social')", "        payload = {", "            'personal': 'http://frozen.pizza.com/reviews',", "            'twitter': 'howtopizza',", "            'github': 'frozenpizzacode',", "        }", "        self.app.put_json(", "            url,", "            payload,", "            auth=self.user.auth,", "        )", "        self.user.reload()", "        for key, value in payload.iteritems():", "            assert_equal(self.user.social[key], value)", "        assert_true(self.user.social['researcherId'] is None)", ""]}, {"lines": ["    def test_serialize_social_editable(self):", "        self.user.social['twitter'] = 'howtopizza'", "        self.user.save()", "        url = api_url_for('serialize_social')", "        res = self.app.get(", "            url,", "            auth=self.user.auth,", "        )", "        assert_equal(res.json.get('twitter'), 'howtopizza')", "        assert_true(res.json.get('github') is None)", "        assert_true(res.json['editable'])", "", "    def test_serialize_social_not_editable(self):", "        user2 = AuthUserFactory()", "        self.user.social['twitter'] = 'howtopizza'", "        self.user.save()", "        url = api_url_for('serialize_social', uid=self.user._id)", "        res = self.app.get(", "            url,", "            auth=user2.auth,", "        )", "        assert_equal(res.json.get('twitter'), 'howtopizza')", "        assert_true(res.json.get('github') is None)", "        assert_false(res.json['editable'])", "", "    def test_serialize_social_addons_editable(self):", "        self.user.add_addon('github')", "        user_github = self.user.get_addon('github')"]}, {"lines": ["        user_github.save()"]}, {"lines": ["        url = api_url_for('serialize_social')", "        res = self.app.get(", "            url,", "            auth=self.user.auth,", "        )", "        assert_equal(", "            res.json['addons']['github'],", "            'howtogithub'", "        )", "", "    def test_serialize_social_addons_not_editable(self):", "        user2 = AuthUserFactory()", "        self.user.add_addon('github')", "        user_github = self.user.get_addon('github')"]}, {"lines": ["        user_github.save()"]}, {"lines": ["        url = api_url_for('serialize_social', uid=self.user._id)", "        res = self.app.get(", "            url,", "            auth=user2.auth,", "        )", "        assert_not_in('addons', res.json)", ""]}, {"lines": [""]}, {"lines": ["class TestAddingContributorViews(OsfTestCase):"]}, {"lines": ["        super(TestAddingContributorViews, self).setUp()"]}, {"lines": ["        contrib_data[0]['permission'] = 'admin'", "        contrib_data[1]['permission'] = 'write'", "        contrib_data[2]['permission'] = 'read'"]}, {"lines": ["        contrib_data[0]['visible'] = True", "        contrib_data[1]['visible'] = True", "        contrib_data[2]['visible'] = True"]}, {"lines": ["        assert_true(res[0]['user'].is_registered)"]}, {"lines": ["        assert_false(res[1]['user'].is_registered)", "        assert_true(res[1]['user']._id)"]}, {"lines": ["        assert_false(res[2]['user'].is_registered)", "        assert_true(res[2]['user']._id)"]}, {"lines": ["        serialized[0]['visible'] = True"]}, {"lines": ["        assert_true(res['gravatar_url'])"]}, {"lines": ["        pseudouser = {", "            'id': None,", "            'registered': False,", "            'fullname': name,", "            'email': email,", "            'permission': 'admin',"]}, {"lines": ["            'visible': True,"]}, {"lines": ["        }"]}, {"lines": ["        reg_dict['permission'] = 'admin'"]}, {"lines": ["        reg_dict['visible'] = True"]}, {"lines": ["            'users': [reg_dict, pseudouser],"]}, {"lines": ["        url = self.project.api_url_for('project_contributors_post')"]}, {"lines": ["            'visible': True,"]}, {"lines": ["        url = self.project.api_url_for('project_contributors_post')"]}, {"lines": ["        pseudouser = {", "            'id': None,", "            'registered': False,", "            'fullname': name,", "            'email': email,", "            'permission': 'admin',"]}, {"lines": ["            'visible': True,"]}, {"lines": ["        }"]}, {"lines": ["        url = self.project.api_url_for('project_contributors_post')"]}, {"lines": ["        pseudouser = {", "            'id': None,", "            'registered': False,", "            'fullname': name,", "            'email': fake.email(),", "            'permission': 'write',"]}, {"lines": ["            'visible': True,"]}, {"lines": ["        }"]}, {"lines": ["        reg_dict['permission'] = 'admin'"]}, {"lines": ["        reg_dict['visible'] = True"]}, {"lines": ["            'users': [reg_dict, pseudouser],"]}, {"lines": ["        url = self.project.api_url_for('project_contributors_post')"]}, {"lines": ["        pseudouser = {", "            'id': None,", "            'registered': False,", "            'fullname': name,", "            'email': email,", "            'permission': 'admin',"]}, {"lines": ["            'visible': True,"]}, {"lines": ["        }"]}, {"lines": ["        reg_dict['permission'] = 'admin'"]}, {"lines": ["        reg_dict['visible'] = True"]}, {"lines": ["            'users': [reg_dict, pseudouser],"]}, {"lines": ["class TestUserInviteViews(OsfTestCase):"]}, {"lines": ["        super(TestUserInviteViews, self).setUp()"]}, {"lines": ["        res = self.app.post_json(", "            self.invite_url,", "            {'fullname': name, 'email': email},", "            auth=self.user.auth,", "        )"]}, {"lines": ["        assert_equal(res.status_code, http.BAD_REQUEST)"]}, {"lines": ["        assert_equal(res.status_code, http.BAD_REQUEST)"]}, {"lines": ["        assert_equal(res.status_code, http.OK)"]}, {"lines": ["        assert_equal(res.status_code, http.BAD_REQUEST)"]}, {"lines": ["        unreg_user = project.add_unregistered_contributor(", "            fullname=fake.name(),", "            email=given_email,", "            auth=Auth(project.creator),", "        )"]}, {"lines": ["class TestClaimViews(OsfTestCase):"]}, {"lines": ["        super(TestClaimViews, self).setUp()"]}, {"lines": ["        res = self.app.post_json(url, payload)"]}, {"lines": ["        url = self.project.api_url_for('claim_user_post', uid=self.user._id)"]}, {"lines": ["        res = res.follow(auth=reg_user.auth)", "        token = self.user.get_unclaimed_record(self.project._primary_key)['token']", "        expected = self.project.web_url_for(", "            'claim_user_registered',", "            uid=self.user._id,", "            token=token,", "        )", "        assert_equal(res.request.path, expected)"]}, {"lines": ["        different_name = fake.name()"]}, {"lines": ["        new_user = self.project.add_unregistered_contributor("]}, {"lines": ["            email=unreg.username,"]}, {"lines": ["            auth=Auth(self.project.creator),"]}, {"lines": ["        )"]}, {"lines": ["        claim_url = new_user.get_claim_url(self.project._id)"]}, {"lines": ["        parsed_name = impute_names_model(different_name)"]}, {"lines": ["        url = self.project.web_url_for(", "            'claim_user_registered',", "            uid=self.user._id,", "            token='badtoken',", "        )"]}, {"lines": ["        res = self.app.get(", "            url,", "            auth=contrib.auth,", "        ).follow(", "            auth=contrib.auth,", "            expect_errors=True,", "        )"]}, {"lines": [""]}, {"lines": ["class TestWatchViews(OsfTestCase):"]}, {"lines": ["        super(TestWatchViews, self).setUp()"]}, {"lines": ["        self.user = UserFactory.build()"]}, {"lines": ["        self.consolidate_auth = Auth(user=self.user, api_key=api_key)"]}, {"lines": ["        assert_equal(res2.status_code, http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": ["class TestPointerViews(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        super(TestPointerViews, self).setUp()"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.consolidate_auth = Auth(user=self.user)", "        self.project = ProjectFactory(creator=self.user)", ""]}, {"lines": ["    def test_add_pointers(self):", "", "        url = self.project.api_url + 'pointer/'", "        node_ids = [", "            NodeFactory()._id", "            for _ in range(5)", "        ]", "        self.app.post_json(", "            url,", "            {'nodeIds': node_ids},", "            auth=self.user.auth,", "        ).maybe_follow()", "", "        self.project.reload()", "        assert_equal(", "            len(self.project.nodes),", "            5", "        )", ""]}, {"lines": ["    def test_add_pointers_not_provided(self):", "        url = self.project.api_url + 'pointer/'"]}, {"lines": [""]}, {"lines": ["    def test_remove_pointer(self):", "        url = self.project.api_url + 'pointer/'", "        node = NodeFactory()", "        pointer = self.project.add_pointer(node, auth=self.consolidate_auth)", "        self.app.delete_json(", "            url,", "            {'pointerId': pointer._id},", "            auth=self.user.auth,", "        )", "        self.project.reload()", "        assert_equal(", "            len(self.project.nodes),", "            0", "        )", "", "    def test_remove_pointer_not_provided(self):", "        url = self.project.api_url + 'pointer/'"]}, {"lines": ["", "    def test_remove_pointer_not_found(self):", "        url = self.project.api_url + 'pointer/'"]}, {"lines": ["", "    def test_remove_pointer_not_in_nodes(self):", "        url = self.project.api_url + 'pointer/'", "        node = NodeFactory()", "        pointer = Pointer(node=node)"]}, {"lines": ["", "    def test_fork_pointer(self):", "        url = self.project.api_url + 'pointer/fork/'", "        node = NodeFactory(creator=self.user)", "        pointer = self.project.add_pointer(node, auth=self.consolidate_auth)", "        self.app.post_json(", "            url,", "            {'pointerId': pointer._id},", "            auth=self.user.auth", "        )", "", "    def test_fork_pointer_not_provided(self):", "        url = self.project.api_url + 'pointer/fork/'"]}, {"lines": ["", "    def test_fork_pointer_not_found(self):", "        url = self.project.api_url + 'pointer/fork/'"]}, {"lines": ["", "    def test_fork_pointer_not_in_nodes(self):", "        url = self.project.api_url + 'pointer/fork/'", "        node = NodeFactory()", "        pointer = Pointer(node=node)"]}, {"lines": [""]}, {"lines": ["    def test_before_register_with_pointer(self):", "        \"Assert that link warning appears in before register callback.\"", "        node = NodeFactory()", "        self.project.add_pointer(node, auth=self.consolidate_auth)", "        url = self.project.api_url + 'fork/before/'", "        res = self.app.get(url, auth=self.user.auth).maybe_follow()", "        prompts = [", "            prompt", "            for prompt in res.json['prompts']", "            if 'Links will be copied into your fork' in prompt", "        ]", "        assert_equal(len(prompts), 1)", "", "    def test_before_fork_with_pointer(self):", "        \"Assert that link warning appears in before fork callback.\"", "        node = NodeFactory()", "        self.project.add_pointer(node, auth=self.consolidate_auth)", "        url = self.project.api_url + 'beforeregister/'", "        res = self.app.get(url, auth=self.user.auth).maybe_follow()", "        prompts = [", "            prompt", "            for prompt in res.json['prompts']", "            if 'Links will be copied into your registration' in prompt", "        ]", "        assert_equal(len(prompts), 1)", "", "    def test_before_register_no_pointer(self):", "        \"Assert that link warning does not appear in before register callback.\"", "        url = self.project.api_url + 'fork/before/'", "        res = self.app.get(url, auth=self.user.auth).maybe_follow()", "        prompts = [", "            prompt", "            for prompt in res.json['prompts']", "            if 'Links will be copied into your fork' in prompt", "        ]", "        assert_equal(len(prompts), 0)", "", "    def test_before_fork_no_pointer(self):"]}, {"lines": ["        \"\"\"Assert that link warning does not appear in before fork callback.", "", "        \"\"\""]}, {"lines": ["        url = self.project.api_url + 'beforeregister/'", "        res = self.app.get(url, auth=self.user.auth).maybe_follow()", "        prompts = [", "            prompt", "            for prompt in res.json['prompts']", "            if 'Links will be copied into your registration' in prompt", "        ]", "        assert_equal(len(prompts), 0)", ""]}, {"lines": [""]}, {"lines": ["class TestPublicViews(OsfTestCase):"]}, {"lines": [""]}, {"lines": ["class TestAuthViews(OsfTestCase):"]}, {"lines": ["        super(TestAuthViews, self).setUp()"]}, {"lines": ["        dupe = UserFactory(", "            username=\"copy@cat.com\",", "            emails=['copy@cat.com']", "        )"]}, {"lines": ["        self.app.post_json("]}, {"lines": ["            url,", "            {", "                \"merged_username\": \"copy@cat.com\",", "                \"merged_password\": \"copycat\"", "            },", "            auth=self.auth,", "        )"]}, {"lines": ["    def test_register_ok(self):"]}, {"lines": ["        url = api_url_for('register_user')"]}, {"lines": ["        name, email, password = fake.name(), fake.email(), 'underpressure'", "        self.app.post_json(", "            url,", "            {", "                'fullName': name,", "                'email1': email,", "                'email2': email,", "                'password': password,", "            }", "        )", "        user = User.find_one(Q('username', 'eq', email))", "        assert_equal(user.fullname, name)", ""]}, {"lines": ["    def test_register_email_mismatch(self):"]}, {"lines": ["        url = api_url_for('register_user')"]}, {"lines": ["        name, email, password = fake.name(), fake.email(), 'underpressure'", "        res = self.app.post_json(", "            url,", "            {", "                'fullName': name,", "                'email1': email,", "                'email2': email + 'lol',", "                'password': password,", "            },"]}, {"lines": ["            expect_errors=True,"]}, {"lines": ["        )", "        assert_equal(res.status_code, http.BAD_REQUEST)", "        users = User.find(Q('username', 'eq', email))", "        assert_equal(users.count(), 0)", ""]}, {"lines": ["    def test_register_sends_user_registered_signal(self):"]}, {"lines": ["        url = api_url_for('register_user')"]}, {"lines": ["        name, email, password = fake.name(), fake.email(), 'underpressure'", "        with capture_signals() as mock_signals:", "            self.app.post_json(", "                url,", "                {", "                    'fullName': name,", "                    'email1': email,", "                    'email2': email,", "                    'password': password,", "                }", "            )", "        assert_equal(mock_signals.signals_sent(), set([auth.signals.user_registered]))", ""]}, {"lines": ["        url = web_url_for('auth_register_post')"]}, {"lines": ["", "# TODO: Use mock add-on"]}, {"lines": ["class TestAddonUserViews(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        super(TestAddonUserViews, self).setUp()"]}, {"lines": ["        self.user = AuthUserFactory()"]}, {"lines": [""]}, {"lines": ["    def test_choose_addons_add(self):", "        \"\"\"Add add-ons; assert that add-ons are attached to project.", "", "        \"\"\"", "        url = '/api/v1/settings/addons/'", "        self.app.post_json(", "            url,", "            {'github': True},", "            auth=self.user.auth,", "        ).maybe_follow()", "        self.user.reload()", "        assert_true(self.user.get_addon('github'))", "", "    def test_choose_addons_remove(self):"]}, {"lines": ["        url = '/api/v1/settings/addons/'", "        self.app.post_json(", "            url,", "            {'github': True},", "            auth=self.user.auth,", "        ).maybe_follow()", "        self.app.post_json(", "            url,", "            {'github': False},", "            auth=self.user.auth", "        ).maybe_follow()", "        self.user.reload()", "        assert_false(self.user.get_addon('github'))", "", ""]}, {"lines": ["        res = self.app.post_json(url, payload, auth=user.auth, expect_errors=True)"]}, {"lines": ["# TODO: Move to OSF Storage"]}, {"lines": ["class TestFileViews(OsfTestCase):"]}, {"lines": ["        super(TestFileViews, self).setUp()"]}, {"lines": ["        url = self.project.api_url_for('collect_file_trees')", "        res = self.app.get(url, auth=self.user.auth)"]}, {"lines": ["        expected = _view_project(self.project, auth=Auth(user=self.user))"]}, {"lines": ["        assert_equal(res.status_code, http.OK)"]}, {"lines": ["        url = self.project.api_url_for('grid_data')"]}, {"lines": ["        assert_equal(res.status_code, http.OK)"]}, {"lines": [""]}, {"lines": ["class TestComments(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        super(TestComments, self).setUp()"]}, {"lines": ["        self.project = ProjectFactory(is_public=True)", "        self.consolidated_auth = Auth(user=self.project.creator)", "        self.non_contributor = AuthUserFactory()"]}, {"lines": [""]}, {"lines": ["    def _configure_project(self, project, comment_level):"]}, {"lines": ["", "        project.comment_level = comment_level", "        project.save()", ""]}, {"lines": ["    def _add_comment(self, project, content=None, **kwargs):"]}, {"lines": [""]}, {"lines": ["        content = content if content is not None else 'hammer to fall'"]}, {"lines": ["        url = project.api_url + 'comment/'", "        return self.app.post_json(", "            url,", "            {"]}, {"lines": ["                'content': content,"]}, {"lines": ["                'isPublic': 'public',"]}, {"lines": ["            },", "            **kwargs", "        )", "", "    def test_add_comment_public_contributor(self):", ""]}, {"lines": ["        self._configure_project(self.project, 'public')"]}, {"lines": ["        res = self._add_comment("]}, {"lines": ["            self.project, auth=self.project.creator.auth,"]}, {"lines": ["        )", "", "        self.project.reload()", ""]}, {"lines": ["        assert_equal(len(self.project.commented), 1)"]}, {"lines": ["", "    def test_add_comment_public_non_contributor(self):", ""]}, {"lines": ["        self._configure_project(self.project, 'public')"]}, {"lines": ["        res = self._add_comment("]}, {"lines": ["            self.project, auth=self.non_contributor.auth,"]}, {"lines": ["        )", "", "        self.project.reload()", ""]}, {"lines": ["        assert_equal(len(self.project.commented), 1)"]}, {"lines": ["", "    def test_add_comment_private_contributor(self):", ""]}, {"lines": ["        self._configure_project(self.project, 'private')"]}, {"lines": ["        res = self._add_comment("]}, {"lines": ["            self.project, auth=self.project.creator.auth,"]}, {"lines": ["        )", "", "        self.project.reload()", ""]}, {"lines": ["        assert_equal(len(self.project.commented), 1)"]}, {"lines": ["    def test_add_comment_private_non_contributor(self):", ""]}, {"lines": ["        self._configure_project(self.project, 'private')"]}, {"lines": ["        res = self._add_comment("]}, {"lines": ["            self.project, auth=self.non_contributor.auth, expect_errors=True,"]}, {"lines": ["        )", "", "        assert_equal(res.status_code, http.FORBIDDEN)", "", "    def test_add_comment_logged_out(self):"]}, {"lines": ["        self._configure_project(self.project, 'public')", "        res = self._add_comment(self.project)"]}, {"lines": ["", "        assert_equal(res.status_code, 302)"]}, {"lines": ["", "    def test_add_comment_off(self):", ""]}, {"lines": ["        self._configure_project(self.project, None)"]}, {"lines": ["        res = self._add_comment("]}, {"lines": ["            self.project, auth=self.project.creator.auth, expect_errors=True,"]}, {"lines": ["        )", ""]}, {"lines": ["        assert_equal(res.status_code, http.BAD_REQUEST)", "", "    def test_add_comment_empty(self):", "        self._configure_project(self.project, 'public')", "        res = self._add_comment(", "            self.project, content='',", "            auth=self.project.creator.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, http.BAD_REQUEST)", "        assert_false(getattr(self.project, 'commented', []))", ""]}, {"lines": ["    def test_add_comment_toolong(self):", "        self._configure_project(self.project, 'public')", "        res = self._add_comment(", "            self.project, content='toolong' * 500,", "            auth=self.project.creator.auth,", "            expect_errors=True,", "        )", "        assert_equal(res.status_code, http.BAD_REQUEST)", "        assert_false(getattr(self.project, 'commented', []))", ""]}, {"lines": ["    def test_add_comment_whitespace(self):", "        self._configure_project(self.project, 'public')", "        res = self._add_comment(", "            self.project, content='  ',", "            auth=self.project.creator.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, http.BAD_REQUEST)", "        assert_false(getattr(self.project, 'commented', []))"]}, {"lines": ["", "    def test_edit_comment(self):"]}, {"lines": ["", "        self._configure_project(self.project, 'public')"]}, {"lines": ["        comment = CommentFactory(node=self.project)"]}, {"lines": ["", "        url = self.project.api_url + 'comment/{0}/'.format(comment._id)"]}, {"lines": ["        res = self.app.put_json("]}, {"lines": ["            url,", "            {", "                'content': 'edited',", "                'isPublic': 'private',", "            },", "            auth=self.project.creator.auth,", "        )", "", "        comment.reload()", "", "        assert_equal(res.json['content'], 'edited')"]}, {"lines": ["", "        assert_equal(comment.content, 'edited')"]}, {"lines": [""]}, {"lines": ["    def test_edit_comment_short(self):", "        self._configure_project(self.project, 'public')", "        comment = CommentFactory(node=self.project, content='short')", "        url = self.project.api_url + 'comment/{0}/'.format(comment._id)", "        res = self.app.put_json(", "            url,", "            {", "                'content': '',", "                'isPublic': 'private',", "            },", "            auth=self.project.creator.auth,", "            expect_errors=True,", "        )", "        comment.reload()", "        assert_equal(res.status_code, http.BAD_REQUEST)", "        assert_equal(comment.content, 'short')", ""]}, {"lines": ["    def test_edit_comment_toolong(self):", "        self._configure_project(self.project, 'public')", "        comment = CommentFactory(node=self.project, content='short')", "        url = self.project.api_url + 'comment/{0}/'.format(comment._id)", "        res = self.app.put_json(", "            url,", "            {", "                'content': 'toolong' * 500,", "                'isPublic': 'private',", "            },", "            auth=self.project.creator.auth,", "            expect_errors=True,", "        )", "        comment.reload()", "        assert_equal(res.status_code, http.BAD_REQUEST)", "        assert_equal(comment.content, 'short')", ""]}, {"lines": ["    def test_edit_comment_non_author(self):"]}, {"lines": ["        \"Contributors who are not the comment author cannot edit.\"", "        self._configure_project(self.project, 'public')", "        comment = CommentFactory(node=self.project)", "        non_author = AuthUserFactory()", "        self.project.add_contributor(non_author, auth=self.consolidated_auth)", "", "        url = self.project.api_url + 'comment/{0}/'.format(comment._id)"]}, {"lines": ["        res = self.app.put_json("]}, {"lines": ["            url,", "            {", "                'content': 'edited',", "                'isPublic': 'private',", "            },", "            auth=non_author.auth,", "            expect_errors=True,", "        )", "", "        assert_equal(res.status_code, http.FORBIDDEN)"]}, {"lines": [""]}, {"lines": ["    def test_edit_comment_non_contributor(self):", "        \"Non-contributors who are not the comment author cannot edit.\""]}, {"lines": ["        self._configure_project(self.project, 'public')"]}, {"lines": ["        comment = CommentFactory(node=self.project)"]}, {"lines": ["", "        url = self.project.api_url + 'comment/{0}/'.format(comment._id)"]}, {"lines": ["        res = self.app.put_json("]}, {"lines": ["            url,", "            {", "                'content': 'edited',", "                'isPublic': 'private',", "            },", "            auth=self.non_contributor.auth,", "            expect_errors=True,", "        )", "", "        assert_equal(res.status_code, http.FORBIDDEN)"]}, {"lines": ["", "    def test_delete_comment_author(self):"]}, {"lines": [""]}, {"lines": ["        self._configure_project(self.project, 'public')"]}, {"lines": ["        comment = CommentFactory(node=self.project)"]}, {"lines": ["", "        url = self.project.api_url + 'comment/{0}/'.format(comment._id)", "        self.app.delete_json(", "            url,", "            auth=self.project.creator.auth,", "        )", "", "        comment.reload()", "", "        assert_true(comment.is_deleted)", ""]}, {"lines": ["    def test_delete_comment_non_author(self):"]}, {"lines": ["", "        self._configure_project(self.project, 'public')"]}, {"lines": ["        comment = CommentFactory(node=self.project)"]}, {"lines": ["", "        url = self.project.api_url + 'comment/{0}/'.format(comment._id)", "        res = self.app.delete_json(", "            url,", "            auth=self.non_contributor.auth,", "            expect_errors=True,", "        )", ""]}, {"lines": ["        assert_equal(res.status_code, http.FORBIDDEN)"]}, {"lines": ["", "        comment.reload()", "", "        assert_false(comment.is_deleted)"]}, {"lines": [""]}, {"lines": ["    def test_report_abuse(self):"]}, {"lines": ["", "        self._configure_project(self.project, 'public')"]}, {"lines": ["        comment = CommentFactory(node=self.project)"]}, {"lines": ["        reporter = AuthUserFactory()"]}, {"lines": [""]}, {"lines": ["        url = self.project.api_url + 'comment/{0}/report/'.format(comment._id)"]}, {"lines": [""]}, {"lines": ["        self.app.post_json(", "            url,", "            {", "                'category': 'spam',", "                'text': 'ads',", "            },"]}, {"lines": ["            auth=reporter.auth,"]}, {"lines": ["        )"]}, {"lines": ["", "        comment.reload()"]}, {"lines": ["        assert_in(reporter._id, comment.reports)"]}, {"lines": ["        assert_equal("]}, {"lines": ["            comment.reports[reporter._id],"]}, {"lines": ["            {'category': 'spam', 'text': 'ads'}"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["    def test_can_view_private_comments_if_contributor(self):", "", "        self._configure_project(self.project, 'public')"]}, {"lines": ["", "        url = self.project.api_url + 'comments/'", "        res = self.app.get(url, auth=self.project.creator.auth)", "", "        assert_equal(len(res.json['comments']), 1)", ""]}, {"lines": ["    def test_discussion_recursive(self):", "", "        self._configure_project(self.project, 'public')", "        comment_l0 = CommentFactory(node=self.project)", "", "        user_l1 = UserFactory()", "        user_l2 = UserFactory()", "        comment_l1 = CommentFactory(node=self.project, target=comment_l0, user=user_l1)"]}, {"lines": ["", "        url = self.project.api_url + 'comments/discussion/'", "        res = self.app.get(url)", "", "        assert_equal(len(res.json['discussion']), 3)", "", "    def test_discussion_no_repeats(self):", "", "        self._configure_project(self.project, 'public')", "        comment_l0 = CommentFactory(node=self.project)", "", "        comment_l1 = CommentFactory(node=self.project, target=comment_l0)"]}, {"lines": ["", "        url = self.project.api_url + 'comments/discussion/'", "        res = self.app.get(url)", "", "        assert_equal(len(res.json['discussion']), 1)", ""]}, {"lines": ["    def test_discussion_sort(self):", "", "        self._configure_project(self.project, 'public')", "", "        user1 = UserFactory()", "        user2 = UserFactory()", "", "        CommentFactory(node=self.project)", "        for _ in range(3):", "            CommentFactory(node=self.project, user=user1)", "        for _ in range(2):", "            CommentFactory(node=self.project, user=user2)", "", "        url = self.project.api_url + 'comments/discussion/'", "        res = self.app.get(url)", "", "        assert_equal(len(res.json['discussion']), 3)", "        observed = [user['id'] for user in res.json['discussion']]", "        expected = [user1._id, user2._id, self.project.creator._id]", "        assert_equal(observed, expected)", ""]}, {"lines": ["class TestTagViews(OsfTestCase):"]}, {"lines": ["        super(TestTagViews, self).setUp()"]}, {"lines": ["        url = web_url_for('project_tag', tag='foo')"]}, {"lines": ["class TestSearchViews(OsfTestCase):"]}, {"lines": ["        super(TestSearchViews, self).setUp()"]}, {"lines": [""]}, {"lines": ["    def tearDown(self):", "        super(TestSearchViews, self).tearDown()", "        import website.search.search as search", "        search.delete_all()", ""]}, {"lines": ["        url = api_url_for('search_contributor')"]}, {"lines": [""]}, {"lines": ["class TestReorderComponents(OsfTestCase):"]}, {"lines": ["        super(TestReorderComponents, self).setUp()"]}, {"lines": ["        url = self.project.api_url_for('project_reorder_components')"]}, {"lines": ["        super(TestDashboardViews, self).setUp()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from nose import SkipTest", "from functools import wraps", ""]}, {"lines": [""]}, {"lines": ["def requires_module(module):", "    def decorator(fn):", "        @wraps(fn)", "        def wrapper(*args, **kwargs):", "            try:", "                __import__(module)", "            except ImportError:", "                raise SkipTest()", "            return fn(*args, **kwargs)", "        return wrapper", "    return decorator"]}, {"lines": [""]}, {"lines": ["# Node Actions", ""]}, {"lines": ["BEFORE_REGISTER_HAS_POINTERS = ("]}, {"lines": ["    'This {category} contains links to other projects. Links will be copied '", "    'into your registration, but the projects that they link to will not be '"]}, {"lines": [")", ""]}, {"lines": ["BEFORE_FORK_HAS_POINTERS = ("]}, {"lines": ["    'This {category} contains links to other projects. Links will be copied '", "    'into your fork, but the projects that they link to will not be forked. '", "    'If you wish to fork the linked projects, they need to be forked from the '"]}, {"lines": [")", ""]}, {"lines": ["REGISTRATION_INFO = '''"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["</ul>", "'''"]}, {"lines": [""]}, {"lines": ["BEFORE_REGISTRATION_INFO = '''"]}, {"lines": ["Registration cannot be undone, and the archived content and files cannot be", "deleted after registration. Please be sure the project is complete and", "comprehensive for what you wish to register.", "'''"]}, {"lines": ["    from_addr = from_addr or settings.FROM_EMAIL"]}, {"lines": ["    # Don't use ttls and login in DEBUG_MODE", "    ttls = login = not settings.DEBUG_MODE"]}, {"lines": ["    logger.debug(u'To: {to_addr}\\nFrom: {from_addr}\\nSubject: {subject}\\nMessage: {message}'.format(**locals()))"]}, {"lines": ["        from_addr=from_addr,"]}, {"lines": ["        ttls=ttls,", "        login=login,"]}, {"lines": [""]}, {"lines": ["CONFERENCE_SUBMITTED = Mail(", "    'conference_submitted',"]}, {"lines": ["    subject='Project created on Open Science Framework',", ")", "CONFERENCE_INACTIVE = Mail(", "    'conference_inactive',", "    subject='Open Science Framework Error: Conference inactive',"]}, {"lines": [")", "CONFERENCE_FAILED = Mail(", "    'conference_failed',"]}, {"lines": ["    subject='Open Science Framework Error: No files attached',"]}, {"lines": [")"]}, {"lines": [""]}, {"lines": ["from website import views as website_views"]}, {"lines": ["        'user_url': user.url if user else '',"]}, {"lines": ["        'user_api_url': user.api_url if user else '',"]}, {"lines": ["        'domain': settings.DOMAIN,"]}, {"lines": ["        'language': language,"]}, {"lines": ["        'api_url_for': util.api_url_for,"]}, {"lines": ["        'waterbutler_url': settings.WATERBUTLER_URL,"]}, {"lines": ["    # Redirect to dashboard if logged in"]}, {"lines": ["        return redirect(util.web_url_for('dashboard'))"]}, {"lines": ["    return {}", "", ""]}, {"lines": ["    ### GUID ###", "    process_rules(app, ["]}, {"lines": ["", "        Rule(", "            [", "                '/<guid>/',", "                '/<guid>/<path:suffix>',"]}, {"lines": ["            ],", "            ['get', 'post', 'put', 'patch', 'delete'],"]}, {"lines": ["            website_views.resolve_guid,"]}, {"lines": ["            notemplate,"]}, {"lines": ["        ),", "", "        Rule(", "            ["]}, {"lines": ["                '/api/v1/<guid>/',", "                '/api/v1/<guid>/<path:suffix>',", "            ],", "            ['get', 'post', 'put', 'patch', 'delete'],"]}, {"lines": ["            website_views.resolve_guid,"]}, {"lines": ["            json_renderer,"]}, {"lines": ["        ),", ""]}, {"lines": ["    ])", ""]}, {"lines": ["        Rule('/dashboard/', 'get', website_views.dashboard, OsfWebRenderer('dashboard.mako')),"]}, {"lines": ["        Rule("]}, {"lines": ["            '/view/<meeting>/',", "            'get',"]}, {"lines": ["            OsfWebRenderer('public/pages/meeting.mako'),"]}, {"lines": ["        ),", "", "        Rule("]}, {"lines": ["            '/view/<meeting>/plain/',", "            'get',"]}, {"lines": ["            OsfWebRenderer('public/pages/meeting_plain.mako'),", "            endpoint_suffix='__plain',"]}, {"lines": ["        ),"]}, {"lines": [""]}, {"lines": ["        Rule("]}, {"lines": ["            'get',"]}, {"lines": ["            OsfWebRenderer('public/pages/meeting_landing.mako'),", "        ),", ""]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/<addon>/settings/disable/',", "                '/project/<pid>/node/<nid>/<addon>/settings/disable/',"]}, {"lines": ["            ],", "            'post',", "            addon_views.disable_addon,", "            json_renderer,"]}, {"lines": ["        ),"]}, {"lines": ["        Rule(", "            '/profile/<uid>/<addon>/settings/',", "            'get',", "            addon_views.get_addon_user_config,", "            json_renderer,", "        ),"]}, {"lines": ["    ], prefix='/api/v1')", ""]}, {"lines": ["    process_rules(app, ["]}, {"lines": ["    process_rules(app, ["]}, {"lines": ["        Rule('/dashboard/get_nodes/', 'get', website_views.get_dashboard_nodes, json_renderer),"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/comments/',", "                '/project/<pid>/node/<nid>/comments/',", "            ],", "            'get',", "            project_views.comment.list_comments,", "            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/comments/discussion/',", "                '/project/<pid>/node/<nid>/comments/discussion/',", "            ],", "            'get',", "            project_views.comment.comment_discussion,", "            json_renderer,", "        ),", "", "        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/comment/',", "                '/project/<pid>/node/<nid>/comment/',", "            ],", "            'post',", "            project_views.comment.add_comment,", "            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/comment/<cid>/',", "                '/project/<pid>/node/<nid>/comment/<cid>/',", "            ],"]}, {"lines": ["            'put',"]}, {"lines": ["            project_views.comment.edit_comment,", "            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/comment/<cid>/',", "                '/project/<pid>/node/<nid>/comment/<cid>/',", "            ],", "            'delete',", "            project_views.comment.delete_comment,", "            json_renderer,", "        ),", "", "        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/comment/<cid>/undelete/',", "                '/project/<pid>/node/<nid>/comment/<cid>/undelete/',", "            ],", "            'put',", "            project_views.comment.undelete_comment,", "            json_renderer,", "        ),", "", "        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/comment/<cid>/report/',", "                '/project/<pid>/node/<nid>/comment/<cid>/report/',"]}, {"lines": ["            ],", "            'post',"]}, {"lines": ["            project_views.comment.report_abuse,"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/comment/<cid>/unreport/',", "                '/project/<pid>/node/<nid>/comment/<cid>/unreport/',", "            ],", "            'post',", "            project_views.comment.unreport_abuse,", "            json_renderer,", "        ),", ""]}, {"lines": ["        Rule('/forms/registration/', 'get', website_views.registration_form, json_renderer),", "        Rule('/forms/signin/', 'get', website_views.signin_form, json_renderer),", "        Rule('/forms/forgot_password/', 'get', website_views.forgot_password_form, json_renderer),", "        Rule('/forms/reset_password/', 'get', website_views.reset_password_form, json_renderer),"]}, {"lines": ["        # TODO: Remove `auth_register_post`"]}, {"lines": ["        Rule('/api/v1/register/', 'post', auth_views.register_user, json_renderer),"]}, {"lines": ["", "", "        Rule(", "            '/settings/',", "            'get',", "            profile_views.user_profile,"]}, {"lines": ["            OsfWebRenderer('profile/settings.mako'),"]}, {"lines": ["        ),", "", "        Rule("]}, {"lines": ["            '/settings/addons/',", "            'get',", "            profile_views.user_addons,"]}, {"lines": ["            OsfWebRenderer('profile/addons.mako'),"]}, {"lines": ["        ),", ""]}, {"lines": ["        # Rules for user profile configuration", "        Rule('/settings/names/', 'get', profile_views.serialize_names, json_renderer),", "        Rule('/settings/names/', 'put', profile_views.unserialize_names, json_renderer),", "        Rule('/settings/names/impute/', 'get', profile_views.impute_names, json_renderer),", ""]}, {"lines": ["        Rule(", "            [", "                '/settings/social/',", "                '/settings/social/<uid>/',", "            ],", "            'get',", "            profile_views.serialize_social,", "            json_renderer,", "        ),"]}, {"lines": [""]}, {"lines": ["        Rule(", "            [", "                '/settings/jobs/',", "                '/settings/jobs/<uid>/',", "            ],", "            'get',", "            profile_views.serialize_jobs,", "            json_renderer,", "        ),"]}, {"lines": [""]}, {"lines": ["        Rule(", "            [", "                '/settings/schools/',", "                '/settings/schools/<uid>/',", "            ],", "            'get',", "            profile_views.serialize_schools,", "            json_renderer,", "        ),", ""]}, {"lines": ["        Rule(", "            [", "                '/settings/social/',", "                '/settings/social/<uid>/',", "            ],", "            'put',", "            profile_views.unserialize_social,", "            json_renderer", "        ),", "", "        Rule(", "            [", "                '/settings/jobs/',", "                '/settings/jobs/<uid>/',", "            ],", "            'put',", "            profile_views.unserialize_jobs,", "            json_renderer", "        ),", "", "        Rule(", "            [", "                '/settings/schools/',", "                '/settings/schools/<uid>/',", "            ],", "            'put',", "            profile_views.unserialize_schools,", "            json_renderer", "        ),"]}, {"lines": [""]}, {"lines": ["        Rule(", "            '/api/v1/search/node/',", "            'post',", "            project_views.node.search_node,", "            json_renderer,", "        ),", ""]}, {"lines": ["        Rule('/', 'get', website_views.index, OsfWebRenderer('index.mako')),"]}, {"lines": ["        Rule('/goodbye/', 'get', goodbye, OsfWebRenderer('index.mako')),"]}, {"lines": [""]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/contributors/',", "                '/project/<pid>/node/<nid>/contributors/',", "            ],", "            'get',", "            project_views.node.node_contributors,", "            OsfWebRenderer('project/contributors.mako'),", "        ),", ""]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/settings/',", "                '/project/<pid>/node/<nid>/settings/',", "            ],", "            'get',", "            project_views.node.node_setting,", "            OsfWebRenderer('project/settings.mako')", "        ),"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/permissions/<permissions>/',", "                '/project/<pid>/node/<nid>/permissions/<permissions>/',", "            ],", "            'post',", "            project_views.node.project_set_privacy,", "            OsfWebRenderer('project/project.mako')", "        ),"]}, {"lines": ["        Rule(", "            '/ids/<category>/<path:value>/',", "            'get',", "            project_views.register.get_referent_by_identifier,", "            notemplate,", "        ),", ""]}, {"lines": ["        ### Files ###", ""]}, {"lines": ["        # Note: Web endpoint for files view must pass `mode` = `page` to", "        # include project view data and JS includes"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/files/',", "                '/project/<pid>/node/<nid>/files/',", "            ],", "            'get',"]}, {"lines": ["            project_views.file.collect_file_trees,"]}, {"lines": ["            OsfWebRenderer('project/files.mako'),"]}, {"lines": ["        ),"]}, {"lines": [""]}, {"lines": ["        Rule("]}, {"lines": ["            '/email/meeting/',"]}, {"lines": ["            'post',"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": [""]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/pointer/',", "                '/project/<pid>/node/<nid>/pointer/',", "            ],", "            'get',", "            project_views.node.get_pointed,", "            json_renderer,", "        ),", "        Rule(", "            [", "                '/project/<pid>/pointer/',", "                '/project/<pid>/node/<nid>/pointer/',", "            ],", "            'post',", "            project_views.node.add_pointers,", "            json_renderer,", "        ),", "        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/pointer/',", "                '/project/<pid>/node/<nid>pointer/',", "            ],", "            'delete',", "            project_views.node.remove_pointer,", "            json_renderer,", "        ),"]}, {"lines": ["        # Reorder contributors", "        Rule(", "            [", "                '/project/<pid>/contributors/manage/',", "                '/project/<pid>/node/<nid>/contributors/manage/',", "            ],", "            'POST',", "            project_views.contributor.project_manage_contributors,", "            json_renderer,", "        ),", ""]}, {"lines": ["        # Private Link"]}, {"lines": ["        ], 'put', project_views.node.project_private_link_edit, json_renderer),"]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/',", "                '/project/<pid>/node/<nid>/',"]}, {"lines": ["            ],", "            'delete',", "            project_views.node.component_remove,", "            json_renderer,", "        ),"]}, {"lines": ["            '/project/<pid>/beforeremovecontributors/',", "            '/project/<pid>/node/<nid>/beforeremovecontributors/',", "        ], 'post', project_views.contributor.project_before_remove_contributor, json_renderer),"]}, {"lines": ["        Rule(["]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/fork/before/',", "                '/project/<pid>/node/<nid>/fork/before/',", "            ], 'get', project_views.node.project_before_fork, json_renderer,", "        ),", "        Rule(", "            [", "                '/project/<pid>/fork/',", "                '/project/<pid>/node/<nid>/fork/',", "            ], 'post', project_views.node.node_fork_page, json_renderer,", "        ),", "        Rule(", "            [", "                '/project/<pid>/pointer/fork/',", "                '/project/<pid>/node/<nid>/pointer/fork/',", "            ], 'post', project_views.node.fork_pointer, json_renderer,", "        ),"]}, {"lines": ["            '/project/<pid>/beforeregister/',", "            '/project/<pid>/node/<nid>/beforeregister',", "        ], 'get', project_views.register.project_before_register, json_renderer),", "        Rule(["]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/identifiers/',", "                '/project/<pid>/node/<nid>/identifiers/',", "            ],"]}, {"lines": ["            'get',", "            project_views.register.node_identifiers_get,", "            json_renderer,", "        ),", "", "        Rule(", "            [", "                '/project/<pid>/identifiers/',", "                '/project/<pid>/node/<nid>/identifiers/',", "            ],", "            'post',", "            project_views.register.node_identifiers_post,"]}, {"lines": ["            json_renderer,", "        ),", ""]}, {"lines": ["        ], 'post', project_views.node.project_set_privacy, json_renderer),"]}, {"lines": ["        ], 'get', website_views.watched_logs_get, json_renderer),"]}, {"lines": ["        # Combined files", "        Rule(", "            [", "                '/project/<pid>/files/',", "                '/project/<pid>/node/<nid>/files/'", "            ],", "            'get',", "            project_views.file.collect_file_trees,", "            json_renderer,", "        ),", ""]}, {"lines": ["        # Settings", "", "        Rule("]}, {"lines": ["            '/settings/addons/',", "            'post',", "            profile_views.user_choose_addons,", "            json_renderer,", "        ),", "", "        Rule("]}, {"lines": ["            [", "                '/project/<pid>/settings/addons/',", "                '/project/<pid>/node/<nid>/settings/addons/',", "            ],", "            'post',", "            project_views.node.node_choose_addons,", "            json_renderer,", "        ),", "", "        Rule(", "            [", "                '/project/<pid>/settings/comments/',", "                '/project/<pid>/node/<nid>/settings/comments/',", "            ],", "            'post',", "            project_views.node.configure_comments,", "            json_renderer,"]}, {"lines": ["        ),"]}, {"lines": [""]}, {"lines": ["class Addon(object):", "", "    registry = {}", ""]}, {"lines": ["    def __init__(self, fullname, shortname, provider, user_settings_model=None, node_model=None):"]}, {"lines": ["        self.fullname = fullname", "        self.shortname = shortname", "        self.provider = provider"]}, {"lines": ["        self.user_settings_model = user_settings_model"]}, {"lines": ["        self.node_model = node_model", "", "    def __repr__(self):"]}, {"lines": ["        return 'AddonConfig({fullname}, {shortname}, {provider}, {user_settings_model}, {node_model})'.format("]}, {"lines": ["            fullname=self.fullname,", "            shortname=self.shortname,", "            provider=self.provider,"]}, {"lines": ["            user_settings_model=self.user_settings_model,"]}, {"lines": ["            node_model=self.node_model,", "        )", "", "    def register(self):", "        self.registry[self.shortname.lower()] = self", "", "    @classmethod", "    def get(cls, shortname):"]}, {"lines": ["        return cls.registry[shortname.lower()]"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import os", "import glob", "import importlib", "import mimetypes", "from bson import ObjectId"]}, {"lines": ["from modularodm import Q", "from modularodm.storage.base import KeyExistsException"]}, {"lines": [""]}, {"lines": ["from framework.routing import process_rules"]}, {"lines": ["from framework.guid.model import GuidStoredObject"]}, {"lines": [""]}, {"lines": ["from website import settings"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["lookup = TemplateLookup(", "    directories=[", "        settings.TEMPLATES_PATH", "    ]", ")"]}, {"lines": [""]}, {"lines": ["def _is_image(filename):", "    mtype, _ = mimetypes.guess_type(filename)", "    return mtype and mtype.startswith('image')", "", "", "class AddonConfig(object):", ""]}, {"lines": ["    def __init__(self, short_name, full_name, owners, categories,", "                 added_default=None, added_mandatory=None,"]}, {"lines": ["                 node_settings_model=None, user_settings_model=None, include_js=None, include_css=None,"]}, {"lines": ["                 widget_help=None, views=None, configs=None, models=None,"]}, {"lines": ["                 accept_extensions=True,"]}, {"lines": ["                 **kwargs):"]}, {"lines": [""]}, {"lines": ["        self.models = models", "        self.settings_models = {}"]}, {"lines": [""]}, {"lines": ["        if node_settings_model:", "            node_settings_model.config = self"]}, {"lines": ["            self.settings_models['node'] = node_settings_model"]}, {"lines": [""]}, {"lines": ["        if user_settings_model:", "            user_settings_model.config = self"]}, {"lines": ["            self.settings_models['user'] = user_settings_model"]}, {"lines": [""]}, {"lines": ["        self.short_name = short_name", "        self.full_name = full_name"]}, {"lines": ["        self.owners = owners"]}, {"lines": ["        self.categories = categories"]}, {"lines": [""]}, {"lines": ["        self.added_default = added_default or []", "        self.added_mandatory = added_mandatory or []", "        if set(self.added_mandatory).difference(self.added_default):", "            raise ValueError('All mandatory targets must also be defaults.')", ""]}, {"lines": ["        self.include_js = self._include_to_static(include_js or {})", "        self.include_css = self._include_to_static(include_css or {})", "", "        self.widget_help = widget_help", ""]}, {"lines": ["        self.views = views or []"]}, {"lines": ["        self.configs = configs or []"]}, {"lines": [""]}, {"lines": ["        self.has_hgrid_files = has_hgrid_files"]}, {"lines": ["        self.max_file_size = max_file_size"]}, {"lines": ["        self.accept_extensions = accept_extensions"]}, {"lines": [""]}, {"lines": ["        # Build template lookup"]}, {"lines": ["                ]", "            )"]}, {"lines": ["    def _static_url(self, filename):", "        \"\"\"Build static URL for file; use the current addon if relative path,", "        else the global static directory.", "", "        :param str filename: Local path to file", "        :return str: Static URL for file", "", "        \"\"\"", "        if filename.startswith('/'):", "            return filename"]}, {"lines": ["            addon=self.short_name,", "            filename=filename,", "        )", "", "    def _include_to_static(self, include):", "        \"\"\"", "", "        \"\"\""]}, {"lines": ["        # TODO: minify static assets"]}, {"lines": ["        return {", "            key: [", "                self._static_url(item)", "                for item in value", "            ]", "            for key, value in include.iteritems()", "        }", ""]}, {"lines": ["    # TODO: Make INCLUDE_JS and INCLUDE_CSS one option", ""]}, {"lines": ["    @property", "    def icon(self):", "", "        try:", "            return self._icon", "        except:", "            static_path = os.path.join('website', 'addons', self.short_name, 'static')", "            static_files = glob.glob(os.path.join(static_path, 'comicon.*'))", "            image_files = [", "                os.path.split(filename)[1]", "                for filename in static_files", "                if _is_image(filename)", "            ]", "            if len(image_files) == 1:", "                self._icon = image_files[0]", "            else:", "                self._icon = None", "            return self._icon", "", "    @property", "    def icon_url(self):"]}, {"lines": ["        return self._static_url(self.icon) if self.icon else None"]}, {"lines": [""]}, {"lines": ["    def to_json(self):"]}, {"lines": ["        return {", "            'short_name': self.short_name,", "            'full_name': self.full_name,"]}, {"lines": ["            'capabilities': self.short_name in settings.ADDON_CAPABILITIES,"]}, {"lines": ["            'addon_capabilities': settings.ADDON_CAPABILITIES.get(self.short_name),"]}, {"lines": ["            'icon': self.icon_url,"]}, {"lines": ["            'has_page': 'page' in self.views,", "            'has_widget': 'widget' in self.views,"]}, {"lines": ["        }"]}, {"lines": [""]}, {"lines": ["    @property", "    def path(self):", "        return os.path.join(settings.BASE_PATH, self.short_name)", ""]}, {"lines": [""]}, {"lines": ["class GuidFile(GuidStoredObject):", ""]}, {"lines": ["    _id = fields.StringField(primary=True)"]}, {"lines": ["", "    _meta = {", "        'abstract': True,", "    }", ""]}, {"lines": ["    @classmethod", "    def get_or_create(cls, **kwargs):", "        try:", "            obj = cls(**kwargs)", "            obj.save()", "            return obj, True", "        except KeyExistsException:", "            obj = cls.find_one(", "                reduce(", "                    lambda acc, query: acc & query,", "                    (Q(key, 'eq', value) for key, value in kwargs.iteritems())", "                )", "            )", "            return obj, False", ""]}, {"lines": ["    @property"]}, {"lines": ["        raise NotImplementedError", "", "    @property"]}, {"lines": ["    def deep_url(self):", "        if self.node is None:", "            raise ValueError('Node field must be defined.')"]}, {"lines": ["        )", ""]}, {"lines": [""]}, {"lines": ["class AddonSettingsBase(StoredObject):"]}, {"lines": ["", "    _id = fields.StringField(default=lambda: str(ObjectId()))"]}, {"lines": ["", "    _meta = {", "        'abstract': True,", "    }", ""]}, {"lines": ["    def delete(self, save=True):"]}, {"lines": ["        self.deleted = True"]}, {"lines": ["        if save:", "            self.save()"]}, {"lines": [""]}, {"lines": ["    def undelete(self, save=True):"]}, {"lines": ["        self.deleted = False"]}, {"lines": ["        if save:", "            self.save()"]}, {"lines": [""]}, {"lines": ["    def to_json(self, user):", "        return {", "            'addon_short_name': self.config.short_name,", "            'addon_full_name': self.config.full_name,", "        }", ""]}, {"lines": [""]}, {"lines": ["", "class AddonUserSettingsBase(AddonSettingsBase):", ""]}, {"lines": ["    owner = fields.ForeignField('user', backref='addons')"]}, {"lines": ["", "    _meta = {", "        'abstract': True,", "    }", ""]}, {"lines": ["    @property", "    def public_id(self):", "        return None", ""]}, {"lines": ["    def get_backref_key(self, schema, backref_name):", "        return schema._name + '__' + backref_name"]}, {"lines": ["    # TODO: Test me @asmacdo"]}, {"lines": ["    def nodes_authorized(self):"]}, {"lines": ["        \"\"\"Get authorized, non-deleted nodes. Returns an empty list if the", "        attached add-on does not include a node model.", "", "        \"\"\"", "        try:", "            schema = self.config.settings_models['node']", "        except KeyError:", "            return []"]}, {"lines": ["        nodes_backref = self.get_backref_key(schema, 'authorized')"]}, {"lines": ["        return ["]}, {"lines": ["            node_addon.owner", "            for node_addon in getattr(self, nodes_backref)"]}, {"lines": ["        ]"]}, {"lines": ["            'nodes': ["]}, {"lines": ["                {", "                    '_id': node._id,", "                    'url': node.url,", "                    'title': node.title,", "                    'registered': node.is_registration,"]}, {"lines": ["                }", "                for node in self.nodes_authorized"]}, {"lines": ["            ]"]}, {"lines": [""]}, {"lines": ["class AddonNodeSettingsBase(AddonSettingsBase):"]}, {"lines": ["    owner = fields.ForeignField('node', backref='addons')"]}, {"lines": [""]}, {"lines": ["    _meta = {", "        'abstract': True,", "    }", ""]}, {"lines": ["                'id': self.owner._id,"]}, {"lines": ["    def render_config_error(self, data):"]}, {"lines": ["        \"\"\""]}, {"lines": [""]}, {"lines": ["        \"\"\""]}, {"lines": ["        # Note: `config` is added to `self` in `AddonConfig::__init__`."]}, {"lines": ["        template = lookup.get_template('project/addon/config_error.mako')", "        return template.get_def('config_error').render("]}, {"lines": ["            title=self.config.full_name,"]}, {"lines": ["            name=self.config.short_name,", "            **data"]}, {"lines": ["        )", ""]}, {"lines": ["    #############", "    # Callbacks #", "    #############", ""]}, {"lines": ["    def before_page_load(self, node, user):"]}, {"lines": ["        \"\"\"", ""]}, {"lines": ["        :param User user:"]}, {"lines": ["        :param Node node:"]}, {"lines": ["", "        \"\"\"", "        pass", ""]}, {"lines": ["    def before_remove_contributor(self, node, removed):", "        \"\"\""]}, {"lines": ["        :param Node node:", "        :param User removed:"]}, {"lines": ["        \"\"\"", "        pass", ""]}, {"lines": ["        \"\"\""]}, {"lines": ["        :param Node node:", "        :param User removed:"]}, {"lines": ["        \"\"\""]}, {"lines": ["        pass", ""]}, {"lines": ["    def before_make_public(self, node):"]}, {"lines": ["        \"\"\"", "", "        :param Node node:", "        :returns: Alert message or None", "", "        \"\"\"", "        pass", "", "    def before_make_private(self, node):", "        \"\"\"", "", "        :param Node node:", "        :returns: Alert message or None", "", "        \"\"\"", "        pass", ""]}, {"lines": ["    def after_set_privacy(self, node, permissions):"]}, {"lines": ["        \"\"\"", "", "        :param Node node:", "        :param str permissions:", "", "        \"\"\"", "        pass", ""]}, {"lines": ["    def before_fork(self, node, user):", "        \"\"\"", "", "        :param Node node:", "        :param User user:"]}, {"lines": ["        :returns: Alert message"]}, {"lines": ["", "        \"\"\"", "        pass", ""]}, {"lines": ["    def after_fork(self, node, fork, user, save=True):"]}, {"lines": ["        \"\"\"", "", "        :param Node node:", "        :param Node fork:", "        :param User user:"]}, {"lines": ["        :param bool save:"]}, {"lines": ["        :returns: Tuple of cloned settings and alert message"]}, {"lines": [""]}, {"lines": ["        \"\"\""]}, {"lines": ["        clone = self.clone()"]}, {"lines": ["        clone.owner = fork"]}, {"lines": ["", "        if save:", "            clone.save()", ""]}, {"lines": ["        return clone, None"]}, {"lines": [""]}, {"lines": ["    def before_register(self, node, user):", "        \"\"\"", "", "        :param Node node:", "        :param User user:"]}, {"lines": ["        :returns: Alert message"]}, {"lines": ["", "        \"\"\"", "        pass", ""]}, {"lines": ["    def after_register(self, node, registration, user, save=True):"]}, {"lines": ["        \"\"\""]}, {"lines": ["", "        :param Node node:", "        :param Node registration:", "        :param User user:"]}, {"lines": ["        :param bool save:"]}, {"lines": ["        :returns: Tuple of cloned settings and alert message"]}, {"lines": ["", "        \"\"\""]}, {"lines": [""]}, {"lines": ["    def after_delete(self, node, user):", "        \"\"\"", "", "        :param Node node:", "        :param User user:", "", "        \"\"\"", "        pass", ""]}, {"lines": [""]}, {"lines": ["    def before_remove_contributor_message(self, node, removed):"]}, {"lines": ["        \"\"\"If contributor to be removed authorized this addon, warn that removing", "        will remove addon authorization.", "        \"\"\"", "        if self.has_auth and self.user_settings.owner == removed:", "            return (", "                u'The {addon} add-on for this {category} is authenticated by {name}. '"]}, {"lines": ["                u'Removing this user will also remove write access to {addon} '"]}, {"lines": ["                u'unless another contributor re-authenticates the add-on.'", "            ).format(", "                addon=self.config.full_name,", "                category=node.project_or_component,", "                name=removed.fullname,", "            )", ""]}, {"lines": ["    # backwards compatibility", "    before_remove_contributor = before_remove_contributor_message", ""]}, {"lines": ["        \"\"\"If removed contributor authorized this addon, remove addon authorization", "        from owner.", "        \"\"\"", "        if self.has_auth and self.user_settings.owner == removed:"]}, {"lines": ["            self.user_settings.oauth_grants[self.owner._id].pop(self.external_account._id)", "            self.clear_auth()"]}, {"lines": ["            ).format(", "                addon=self.config.full_name,"]}, {"lines": ["            )", ""]}, {"lines": ["    def before_fork_message(self, node, user):", "        \"\"\"Return warning text to display if user auth will be copied to a", "        fork.", "        \"\"\"", "        if self.user_settings and self.user_settings.owner == user:", "            return (", "                u'Because you have authorized the {addon} add-on for this '", "                u'{category}, forking it will also transfer your authentication token to '", "                u'the forked {category}.'", "            ).format(", "                addon=self.config.full_name,", "                category=node.project_or_component,", "            )", "        return (", "            u'Because the {addon} add-on has been authorized by a different '", "            u'user, forking it will not transfer authentication token to the forked '", "            u'{category}.'", "        ).format(", "            addon=self.config.full_name,", "            category=node.project_or_component,", "        )", "", "    # backwards compatibility", "    before_fork = before_fork_message", "", "    def after_fork(self, node, fork, user, save=True):", "        \"\"\"After forking, copy user settings if the user is the one who authorized", "        the addon.", "", "        :return: A tuple of the form (cloned_settings, message)", "        \"\"\"", "        clone, _ = super(AddonOAuthNodeSettingsBase, self).after_fork(", "            node=node,", "            fork=fork,", "            user=user,", "            save=False,", "        )", "        if self.has_auth and self.user_settings.owner == user:", "            clone.set_auth(self.external_account, user)"]}, {"lines": ["            message = '{addon} authorization copied to forked {category}.'.format("]}, {"lines": ["                addon=self.config.full_name,"]}, {"lines": ["                category=fork.project_or_component,"]}, {"lines": ["            )", "        else:", "            message = ("]}, {"lines": ["                u'{addon} authorization not copied to forked {category}. You may '"]}, {"lines": ["                u'authorize this fork on the <a href=\"{url}\">Settings</a> '", "                u'page.'", "            ).format(", "                addon=self.config.full_name,", "                url=fork.web_url_for('node_setting'),"]}, {"lines": ["                category=fork.project_or_component,"]}, {"lines": ["            )", "        if save:", "            clone.save()", "        return clone, message", "", "    def before_register_message(self, node, user):", "        \"\"\"Return warning text to display if user auth will be copied to a", "        registration.", "        \"\"\"", "        if self.has_auth:", "            return (", "                u'The contents of {addon} add-ons cannot be registered at this time; '"]}, {"lines": ["                u'as part of this registration.'", "            ).format(", "                addon=self.config.full_name,"]}, {"lines": ["                category=node.project_or_component,"]}, {"lines": ["            )", "", "    # backwards compatibility", "    before_register = before_register_message", ""]}, {"lines": ["# TODO: No more magicks"]}, {"lines": ["", "    :param app: Flask app object", "    :param addon_name: Name of addon directory"]}, {"lines": ["    :param bool routes: Add routes", "    :return AddonConfig: AddonConfig configuration object if module found,", "        else None"]}, {"lines": ["", "    \"\"\""]}, {"lines": ["    import_path = 'website.addons.{0}'.format(addon_name)"]}, {"lines": ["", "    # Import addon module"]}, {"lines": ["    addon_module = importlib.import_module(import_path)"]}, {"lines": [""]}, {"lines": ["    data = vars(addon_module)", ""]}, {"lines": ["    # Add routes"]}, {"lines": ["    if routes:", "        for route_group in getattr(addon_module, 'ROUTES', []):", "            process_rules(app, **route_group)"]}, {"lines": ["", "    # Build AddonConfig object"]}, {"lines": ["    return AddonConfig("]}, {"lines": ["        **{", "            key.lower(): value", "            for key, value in data.iteritems()", "        }", "    )"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from website.project import decorators"]}, {"lines": ["", ""]}, {"lines": ["@decorators.must_have_permission('write')"]}, {"lines": ["@decorators.must_not_be_registration"]}, {"lines": ["def disable_addon(auth, **kwargs):"]}, {"lines": ["    node = kwargs['node'] or kwargs['project']"]}, {"lines": ["", "    addon_name = kwargs.get('addon')", "    if addon_name is None:"]}, {"lines": [""]}, {"lines": ["    deleted = node.delete_addon(addon_name, auth)"]}, {"lines": [""]}, {"lines": ["    return {'deleted': deleted}"]}, {"lines": ["", ""]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["def get_addon_user_config(**kwargs):"]}, {"lines": [""]}, {"lines": ["    user = kwargs['auth'].user"]}, {"lines": ["", "    addon_name = kwargs.get('addon')", "    if addon_name is None:"]}, {"lines": ["", "    addon = user.get_addon(addon_name)", "    if addon is None:"]}, {"lines": [""]}, {"lines": ["    return addon.to_json(user)", ""]}, {"lines": [""]}, {"lines": ["def check_file_guid(guid):", "", "    guid_url = '/{0}/'.format(guid._id)", "    if not request.path.startswith(guid_url):", "        url_split = request.url.split(guid.file_url)", "        try:", "            guid_url += url_split[1].lstrip('/')", "        except IndexError:", "            pass", "        return guid_url", "    return None"]}, {"lines": ["    return {'status': 'success'}", ""]}, {"lines": ["'use strict';"]}, {"lines": ["var m = require('mithril');", "var Fangorn = require('js/fangorn');"]}, {"lines": ["    item.notify.update('Box couldn\\'t load, please try again later.', 'deleting', undefined, 3000);"]}, {"lines": ["require('knockout.punches');"]}, {"lines": ["var language = require('js/osfLanguage').Addons.box;", "var osfHelpers = require('js/osfHelpers');"]}, {"lines": ["            'id': '0',"]}, {"lines": ["    def set_config(self, node_addon, user, external_list_id, external_list_name, auth):"]}, {"lines": ["        node_addon.set_target_folder(external_list_id, external_list_name, auth)"]}, {"lines": ["import pymongo"]}, {"lines": ["from modularodm import fields"]}, {"lines": ["    __indices__ = [", "        {", "            'key_or_list': [", "                ('node', pymongo.ASCENDING),", "                ('file_id', pymongo.ASCENDING),", "            ],", "            'unique': True,", "        }", "    ]", ""]}, {"lines": ["", "    def after_delete(self, node, user):", "        self.deauthorize(Auth(user=user), add_log=True)", "        self.save()"]}, {"lines": ["require('knockout.punches');"]}, {"lines": ["var osfHelpers = require('js/osfHelpers');"]}, {"lines": ["require('knockout.punches');"]}, {"lines": ["", "var $osf = require('js/osfHelpers');", "var language = require('js/osfLanguage').Addons.dataverse;"]}, {"lines": ["    self.messageClass = ko.observable('text-info');"]}, {"lines": ["<%include file=\"profile/addon_permissions.mako\" />"]}, {"lines": ["<script type=\"text/html\" id=\"dataverse_node_authorized\">"]}, {"lines": ["<script type=\"text/html\" id=\"dataverse_node_deauthorized\">"]}, {"lines": ["</script>"]}, {"lines": ["from website.addons.dataverse import settings"]}, {"lines": ["", "        super(TestClient, self).setUp()", ""]}, {"lines": ["from website.addons.dataverse.tests.utils import ("]}, {"lines": [")"]}, {"lines": ["import httplib"]}, {"lines": ["import datetime", ""]}, {"lines": ["from website.addons.base.exceptions import AddonError"]}, {"lines": ["'use strict';"]}, {"lines": ["var m = require('mithril');", "var Fangorn = require('js/fangorn');"]}, {"lines": ["    item.notify.update('Dropbox couldn\\'t load, please try again later.', 'deleting', undefined, 3000);"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["from website.addons.base import exceptions"]}, {"lines": ["class TestUserSettingsModel(OsfTestCase):"]}, {"lines": ["        super(TestUserSettingsModel, self).setUp()"]}, {"lines": ["class TestDropboxNodeSettingsModel(OsfTestCase):"]}, {"lines": ["        super(TestDropboxNodeSettingsModel, self).setUp()"]}, {"lines": ["    def test_serialize_credentials(self):", "        self.user_settings.access_token = 'secret'", "        self.user_settings.save()", "        credentials = self.node_settings.serialize_waterbutler_credentials()", "        expected = {'token': self.node_settings.user_settings.access_token}", "        assert_equal(credentials, expected)", "", "    def test_serialize_credentials_not_authorized(self):", "        self.node_settings.user_settings = None", "        self.node_settings.save()", "        with assert_raises(exceptions.AddonError):", "            self.node_settings.serialize_waterbutler_credentials()", "", "    def test_serialize_settings(self):", "        settings = self.node_settings.serialize_waterbutler_settings()", "        expected = {'folder': self.node_settings.folder}", "        assert_equal(settings, expected)", "", "    def test_serialize_settings_not_configured(self):", "        self.node_settings.folder = None", "        self.node_settings.save()", "        with assert_raises(exceptions.AddonError):", "            self.node_settings.serialize_waterbutler_settings()", "", "    def test_create_log(self):", "        action = 'file_added'", "        path = 'pizza.nii'", "        nlog = len(self.project.logs)", "        self.node_settings.create_waterbutler_log(", "            auth=Auth(user=self.user),", "            action=action,", "            metadata={'path': path},", "        )", "        self.project.reload()", "        assert_equal(len(self.project.logs), nlog + 1)", "        assert_equal(", "            self.project.logs[-1].action,", "            'dropbox_{0}'.format(action),", "        )", "        assert_equal(", "            self.project.logs[-1].params['path'],"]}, {"lines": ["        )", ""]}, {"lines": ["class TestNodeSettingsCallbacks(OsfTestCase):"]}, {"lines": ["        super(TestNodeSettingsCallbacks, self).setUp()"]}, {"lines": ["        self.node_settings = DropboxNodeSettingsFactory(", "            user_settings=self.user_settings,", "            folder='',", "        )"]}, {"lines": ["    def test_after_delete(self):", "        self.project.remove_node(Auth(user=self.project.creator))", "        # Ensure that changes to node settings have been saved", "        self.node_settings.reload()", "        assert_true(self.node_settings.user_settings is None)", "        assert_true(self.node_settings.folder is None)"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["    DropboxAddonTestCase, mock_responses, MockDropbox, patch_client"]}, {"lines": ["class TestAuthViews(OsfTestCase):"]}, {"lines": ["        super(TestAuthViews, self).setUp()"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_dropbox_user_config_get_has_auth_info(self, mock_account_info):", "        mock_account_info.return_value = {'display_name': 'Mr. Drop Box'}"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_dropbox_user_config_get_returns_correct_urls(self, mock_account_info):", "        mock_account_info.return_value = {'display_name': 'Mr. Drop Box'}"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_dropbox_config_get(self, mock_account_info):", "        mock_account_info.return_value = {'display_name': 'Mr. Drop Box'}"]}, {"lines": ["        url = self.project.api_url_for('dropbox_config_get')"]}, {"lines": ["        assert_equal(", "            result['urls']['config'],", "            self.project.api_url_for('dropbox_config_put'),", "        )"]}, {"lines": ["        url = self.project.api_url_for('dropbox_config_put')"]}, {"lines": ["        url = self.project.api_url_for('dropbox_deauthorize')"]}, {"lines": ["        url = self.project.api_url_for('dropbox_import_user_auth')"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.account_info')", "    def test_dropbox_import_user_auth_adds_a_log(self, mock_account_info):", "        mock_account_info.return_value = {'display_name': 'Mr. Drop Box'}"]}, {"lines": ["        url = self.project.api_url_for('dropbox_import_user_auth')"]}, {"lines": ["        url = self.project.api_url_for('dropbox_get_share_emails')"]}, {"lines": ["        url = self.project.api_url_for('dropbox_get_share_emails')"]}, {"lines": ["        url = self.project.api_url_for('dropbox_get_share_emails')"]}, {"lines": ["            url = self.project.api_url_for("]}, {"lines": ["                'dropbox_hgrid_data_contents',"]}, {"lines": ["            )"]}, {"lines": ["            url = self.project.api_url_for('dropbox_hgrid_data_contents', foldersOnly=True)"]}, {"lines": ["            url = self.project.api_url_for('dropbox_hgrid_data_contents', foldersOnly=True)"]}, {"lines": ["            url = self.project.api_url_for('dropbox_hgrid_data_contents', root=1)"]}, {"lines": ["        url = self.project.api_url_for('dropbox_config_put')"]}, {"lines": ["        url = self.project.api_url_for('dropbox_config_put')"]}, {"lines": ["        return redirect(web_url_for('user_addons'))"]}, {"lines": ["        return redirect(web_url_for('user_addons'))"]}, {"lines": ["    return redirect(web_url_for('user_addons'))"]}, {"lines": [""]}, {"lines": ["        project = self._send(os.path.join(node_settings.api_url, 'projects', str(project_id)))"]}, {"lines": ["        if projects is False or articles is False:"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": [""]}, {"lines": ["import pymongo"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    __indices__ = [", "        {", "            'key_or_list': [", "                ('node', pymongo.ASCENDING),", "                ('article_id', pymongo.ASCENDING),", "                ('file_id', pymongo.ASCENDING),", "            ],", "            'unique': True,", "        }", "    ]", ""]}, {"lines": [""]}, {"lines": ["    def remove_auth(self, save=False):", "        self.oauth_access_token = None", "        self.oauth_access_token_secret = None", "        for node_settings in self.addonfigsharenodesettings__authorized:", "            node_settings.deauthorize(auth=Auth(user=self.owner), save=True)", "        if save:", "            self.save()", "", "    def delete(self, save=False):", "        self.remove_auth(save=False)", "        super(AddonFigShareUserSettings, self).delete(save=save)", ""]}, {"lines": [""]}, {"lines": ["    figshare_id = fields.StringField()"]}, {"lines": ["        return FigShareGuidFile.get_or_create("]}, {"lines": ["            article_id=article_id,"]}, {"lines": ["        )", ""]}, {"lines": ["        return {", "            'id': self.figshare_id,", "            'type': self.figshare_type,"]}, {"lines": ["        }"]}, {"lines": ["    def authorize(self, user_settings, save=False):"]}, {"lines": ["        node = self.owner"]}, {"lines": ["                'node': node._id,", "            },", "            auth=Auth(user=user_settings.owner),"]}, {"lines": ["        if save:", "            self.save()"]}, {"lines": ["    def deauthorize(self, auth=None, add_log=True, save=False):"]}, {"lines": ["        self.figshare_title = None"]}, {"lines": ["                action='figshare_node_deauthorized',", "                params={", "                    'project': node.parent_id,", "                    'node': node._id,", "                },", "                auth=auth,", "            )", "", "        if save:", "            self.save()", ""]}, {"lines": ["    def delete(self, save=False):", "        super(AddonFigShareNodeSettings, self).delete(save=False)", "        self.deauthorize(add_log=False, save=save)"]}, {"lines": ["                },"]}, {"lines": ["            )"]}, {"lines": ["    def to_json(self, user):"]}, {"lines": ["            'figshare_id': self.figshare_id or '',"]}, {"lines": ["            'user_has_auth': bool(figshare_user) and figshare_user.has_auth,"]}, {"lines": ["            'figshare_options': [],", "            'is_registration': self.owner.is_registration,"]}, {"lines": ["        })"]}, {"lines": [""]}, {"lines": ["                category=node.project_or_component,", "                node_perm=node_permissions,", "                figshare_perm=article_permissions,", "                figshare_id=self.figshare_id,", "            )"]}, {"lines": ["            )"]}, {"lines": ["            )"]}, {"lines": ["        )"]}, {"lines": ["        )"]}, {"lines": ["            )"]}, {"lines": ["            )"]}, {"lines": ["        if self.has_auth and self.figshare_id:", "            return messages.BEFORE_REGISTER.format(", "                category=node.project_or_component,", "            )"]}, {"lines": [""]}, {"lines": ["        out = []", "        for article in project['articles']:"]}, {"lines": ["            if hgrid:", "                out.append(hgrid)", "        return out"]}, {"lines": [""]}, {"lines": ["    if node.is_public:"]}, {"lines": ["        if not node.is_contributor(user):", "            if article.get('status') in ['Drafts', None]:", "                return None"]}, {"lines": ["        if folders_only:", "            return None"]}, {"lines": ["                # TODO: This endpoint isn't defined"]}, {"lines": ["        if folders_only:", "            return None"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var Fangorn = require('js/fangorn');"]}, {"lines": ["<%include file=\"profile/addon_permissions.mako\" />"]}, {"lines": ["from tests.base import OsfTestCase", "from tests.factories import ProjectFactory, AuthUserFactory"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["class TestCallbacks(OsfTestCase):"]}, {"lines": ["    def test_before_register_linked_content(self):", "        assert_false(", "            self.node_settings.before_register(", "                self.project,", "                self.project.creator", "            ) is None", "        )", "", "    def test_before_register_no_linked_content(self):", "        self.node_settings.figshare_id = None", "        assert_true(", "            self.node_settings.before_register(", "                self.project,", "                self.project.creator", "            ) is None", "        )", ""]}, {"lines": ["    def test_after_delete(self):", "        self.project.remove_node(Auth(user=self.project.creator))", "        # Ensure that changes to node settings have been saved", "        self.node_settings.reload()", "        assert_true(self.node_settings.user_settings is None)", "        assert_true(self.node_settings.figshare_id is None)", "        assert_true(self.node_settings.figshare_type is None)", "        assert_true(self.node_settings.figshare_title is None)"]}, {"lines": ["from website.util import web_url_for"]}, {"lines": [""]}, {"lines": ["@must_have_permission('write')"]}, {"lines": ["def figshare_oauth_delete_node(auth, node_addon, **kwargs):"]}, {"lines": ["    node_addon.user_settings = None", "    node_addon.figshare_id = None", "    node_addon.figshare_type = None", "    node_addon.figshare_title = None", "    node_addon.save()"]}, {"lines": ["                'type': node_addon.figshare_type,", "                'id': node_addon.figshare_id,"]}, {"lines": [""]}, {"lines": ["", "    return redirect(web_url_for('user_addons'))"]}, {"lines": ["@must_have_permission('write')"]}, {"lines": ["def figshare_add_user_auth(auth, **kwargs):"]}, {"lines": ["    user = auth.user"]}, {"lines": ["@must_be_logged_in", "@must_have_addon('figshare', 'user')", "def figshare_oauth_delete_user(user_addon, **kwargs):", "    user_addon.remove_auth(save=True)"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from modularodm.validators import (", "    URLValidator, MinValueValidator, MaxValueValidator", ")"]}, {"lines": ["from modularodm.exceptions import ValidationValueError"]}, {"lines": [""]}, {"lines": ["from framework.mongo.utils import sanitized"]}, {"lines": [""]}, {"lines": ["from website.addons.base import AddonNodeSettingsBase"]}, {"lines": ["", "", "class ForwardNodeSettings(AddonNodeSettingsBase):", ""]}, {"lines": ["    url = fields.StringField(validate=URLValidator())"]}, {"lines": ["    label = fields.StringField(validate=sanitized)"]}, {"lines": ["    redirect_bool = fields.BooleanField(default=True, validate=True)", "    redirect_secs = fields.IntegerField(", "        default=15,"]}, {"lines": ["        validate=[MinValueValidator(5), MaxValueValidator(60)]"]}, {"lines": ["    )"]}, {"lines": [""]}, {"lines": ["        return self.label if self.label else self.url", ""]}, {"lines": ["", "@ForwardNodeSettings.subscribe('before_save')", "def validate_circular_reference(schema, instance):", "    \"\"\"Prevent node from forwarding to itself.\"\"\"", "    if instance.url and instance.owner._id in instance.url:", "        raise ValidationValueError('Circular URL')"]}, {"lines": ["\"\"\"", "Utility functions for Forward add-on.", "\"\"\""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def serialize_settings(node_addon):", "    return {", "        'url': node_addon.url,"]}, {"lines": ["        'label': node_addon.label,"]}, {"lines": ["        'redirectBool': node_addon.redirect_bool,", "        'redirectSecs': node_addon.redirect_secs,", "    }", "", "", "def settings_complete(node_addon):"]}, {"lines": ["    return (", "        node_addon.url is not None", "        and node_addon.redirect_bool is not None", "        and node_addon.redirect_secs is not None"]}, {"lines": ["    )"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": [""]}, {"lines": ["require('knockout.punches');"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    };"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["<%inherit file=\"project/addon/widget.mako\" />", "", "<div id=\"forwardScope\" class=\"scripted\">", "", "    <div id=\"forwardModal\" style=\"display: none; padding: 15px;\">", "", "        <div>", "            This project contains a forward to", "            <a data-bind=\"attr.href: url\">{{ url }}</a>.", "        </div>", "", "        <p>You will be automatically forwarded in {{ timeLeft }} seconds.</p>", ""]}, {"lines": ["        <div class=\"spaced-buttons\" data-bind=\"visible: redirecting\">"]}, {"lines": ["            <a class=\"btn btn-success\" data-bind=\"click: doRedirect\">Redirect</a>"]}, {"lines": ["            <a class=\"btn btn-warning\" data-bind=\"click: cancelRedirect\">Cancel</a>"]}, {"lines": ["        </div>", "", "    </div>", "", "    <div id=\"forwardWidget\" data-bind=\"visible: url() !== null\">", "", "        <div>", "            This project contains a forward to"]}, {"lines": ["        </div>", "", "        <div class=\"spaced-buttons\">", "            <a class=\"btn btn-success\" data-bind=\"click: doRedirect\">Redirect</a>", "        </div>", "", "    </div>", "", "</div>"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from nose.tools import *  # PEP8 asserts", "", "from modularodm.exceptions import ValidationError", ""]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["from website.addons.forward.tests.factories import ForwardSettingsFactory"]}, {"lines": ["", ""]}, {"lines": ["class TestSettingsValidation(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        super(TestSettingsValidation, self).setUp()"]}, {"lines": ["        self.settings = ForwardSettingsFactory()", "", "    def test_validate_url_bad(self):", "        self.settings.url = 'badurl'", "        with assert_raises(ValidationError):", "            self.settings.save()", "", "    def test_validate_url_good(self):", "        self.settings.url = 'http://frozen.pizza.reviews/'", "        try:", "            self.settings.save()", "        except ValidationError:", "            assert 0", "", "    def test_validate_redirect_bool_bad(self):", "        self.settings.redirect_bool = 'notabool'", "        with assert_raises(ValidationError):", "            self.settings.save()", "", "    def test_validate_redirect_bool_good(self):", "        self.settings.redirect_bool = False", "        try:", "            self.settings.save()", "        except ValidationError:", "            assert 0", "", "    def test_validate_redirect_secs_bad(self):", "        self.settings.redirect_secs = -2", "        with assert_raises(ValidationError):", "            self.settings.save()", "", "    def test_validate_redirect_secs_good(self):", "        self.settings.redirect_secs = 20", "        try:", "            self.settings.save()", "        except ValidationError:", "            assert 0"]}, {"lines": ["", "    def test_label_sanitary(self):", "        self.settings.label = 'safe'", "        try:", "            self.settings.save()", "        except ValidationError:", "            assert False", "", "    def test_label_unsanitary(self):", "        self.settings.label = 'un<br />safe'", "        with assert_raises(ValidationError):", "            self.settings.save()"]}, {"lines": ["from nose.tools import *", "", "from website.addons.forward.tests.utils import ForwardAddonTestCase", ""]}, {"lines": [""]}, {"lines": ["class TestForwardLogs(ForwardAddonTestCase):", "", "    def setUp(self):", "        super(TestForwardLogs, self).setUp()", "        self.app.authenticate(*self.user.auth)"]}, {"lines": ["", "    def test_change_url_log_added(self):", "        log_count = len(self.project.logs)", "        self.app.put_json(", "            self.project.api_url_for('forward_config_put'),", "            dict(", "                url='http://how.to.bas/ic',", "                redirectBool=True,", "                redirectSecs=15,", "            ),", "        )", "        self.project.reload()", "        assert_equal(", "            len(self.project.logs),", "            log_count + 1", "        )", "", "    def test_change_timeout_log_not_added(self):", "        log_count = len(self.project.logs)", "        self.app.put_json(", "            self.project.api_url_for('forward_config_put'),", "            dict(", "                url=self.node_settings.url,", "                redirectBool=True,", "                redirectSecs=15,", "            ),", "        )", "        self.project.reload()", "        assert_equal(", "            len(self.project.logs),", "            log_count", "        )"]}, {"lines": ["from website.project.decorators import (", "    must_be_valid_project, must_have_addon, must_be_contributor_or_public", ")", "", "from website.addons.forward.utils import serialize_settings, settings_complete", "", "", "@must_be_valid_project", "@must_have_addon('forward', 'node')", "@must_be_contributor_or_public", "def forward_widget(node_addon, **kwargs):", "", "    out = serialize_settings(node_addon)", "    out['complete'] = settings_complete(node_addon)", "    out.update(node_addon.config.to_json())", "    return out"]}, {"lines": ["import urllib"]}, {"lines": ["import itertools"]}, {"lines": [""]}, {"lines": ["import cachecontrol"]}, {"lines": [""]}, {"lines": ["from website.addons.github import settings as github_settings"]}, {"lines": ["from website.addons.github.exceptions import NotFoundError", ""]}, {"lines": [""]}, {"lines": ["# Initialize caches"]}, {"lines": ["https_cache = cachecontrol.CacheControlAdapter()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class GitHub(object):", ""]}, {"lines": ["    def __init__(self, access_token=None, token_type=None):"]}, {"lines": [""]}, {"lines": ["        self.access_token = access_token"]}, {"lines": ["        if access_token and token_type:"]}, {"lines": ["            self.gh3.set_client_id(", "                github_settings.CLIENT_ID, github_settings.CLIENT_SECRET", "            )"]}, {"lines": ["        else:"]}, {"lines": [""]}, {"lines": ["        # Caching libary"]}, {"lines": ["        if github_settings.CACHE:"]}, {"lines": ["            self.gh3._session.mount('https://', https_cache)"]}, {"lines": ["", "    @classmethod", "    def from_settings(cls, settings):"]}, {"lines": ["        if settings:", "            return cls(", "                access_token=settings.oauth_access_token,", "                token_type=settings.oauth_token_type,", "            )", "        return cls()"]}, {"lines": [""]}, {"lines": ["    def user(self, user=None):", "        \"\"\"Fetch a user or the authenticated user.", "", "        :param user: Optional GitHub user name; will fetch authenticated", "            user if omitted", "        :return dict: GitHub API response"]}, {"lines": ["        \"\"\""]}, {"lines": [""]}, {"lines": ["    def repo(self, user, repo):"]}, {"lines": [""]}, {"lines": ["        :param str user: GitHub user name", "        :param str repo: GitHub repo name", "        :return: Dict of repo information"]}, {"lines": ["        rv = self.gh3.repository(user, repo)", "        if rv:", "            return rv", "        raise NotFoundError"]}, {"lines": [""]}, {"lines": ["    def repos(self):", "        return self.gh3.iter_repos(type='all', sort='full_name')", "", "    def user_repos(self, user):"]}, {"lines": ["        return self.gh3.iter_user_repos(user, type='all', sort='full_name')", ""]}, {"lines": ["    def my_org_repos(self, permissions=None):", "        permissions = permissions or ['push']", "        return itertools.chain.from_iterable(", "            team.iter_repos()", "            for team in self.gh3.iter_user_teams()", "            if team.permission in permissions", "        )", ""]}, {"lines": ["    def create_repo(self, repo, **kwargs):", "        return self.gh3.create_repo(repo, **kwargs)", ""]}, {"lines": ["    def branches(self, user, repo, branch=None):"]}, {"lines": [""]}, {"lines": ["        :param str user: GitHub user name", "        :param str repo: GitHub repo name", "        :param str branch: Branch name if getting a single branch", "        :return: List of branch dicts"]}, {"lines": ["        return self.repo(user, repo).iter_branches() or []"]}, {"lines": [""]}, {"lines": ["        \"\"\"Get link for archive download.", "", "        :param str user: GitHub user name", "        :param str repo: GitHub repo name", "        :param str archive: Archive format [tar|zip]", "        :param str ref: Git reference"]}, {"lines": ["        \"\"\""]}, {"lines": [""]}, {"lines": ["    def set_privacy(self, user, repo, private):", "        \"\"\"Set privacy of GitHub repo.", "", "        :param str user: GitHub user name", "        :param str repo: GitHub repo name"]}, {"lines": ["        :param bool private: Make repo private; see", "            http://developer.github.com/v3/repos/#edit"]}, {"lines": ["        \"\"\""]}, {"lines": ["        return self.repo(user, repo).edit(repo, private=private)"]}, {"lines": [""]}, {"lines": ["    #########", "    # Hooks #", "    #########", "", "    def hooks(self, user, repo):"]}, {"lines": ["        \"\"\"List webhooks", "", "        :param str user: GitHub user name", "        :param str repo: GitHub repo name", "        :return list: List of commit dicts from GitHub; see", "            http://developer.github.com/v3/repos/hooks/#json-http"]}, {"lines": ["        \"\"\""]}, {"lines": ["        return self.repo(user, repo).iter_hooks()"]}, {"lines": ["", "    def add_hook(self, user, repo, name, config, events=None, active=True):"]}, {"lines": ["        \"\"\"Create a webhook.", "", "        :param str user: GitHub user name", "        :param str repo: GitHub repo name", "        :return dict: Hook info from GitHub: see see", "            http://developer.github.com/v3/repos/hooks/#json-http"]}, {"lines": ["        \"\"\""]}, {"lines": ["        return self.repo(user, repo).create_hook(name, config, events, active)"]}, {"lines": ["", "    def delete_hook(self, user, repo, _id):"]}, {"lines": ["        \"\"\"Delete a webhook."]}, {"lines": [""]}, {"lines": ["        :param str user: GitHub user name", "        :param str repo: GitHub repo name"]}, {"lines": ["        :return bool: True if successful, False otherwise"]}, {"lines": ["        :raises: NotFoundError if repo or hook cannot be located"]}, {"lines": ["        \"\"\""]}, {"lines": ["        repo = self.repo(user, repo)", "        hook = repo.hook(_id)", "        if hook is None:", "            raise NotFoundError", "        return repo.hook(_id).delete()"]}, {"lines": [""]}, {"lines": ["    ########"]}, {"lines": ["    # Auth #", "    ########", "", "    def revoke_token(self):", ""]}, {"lines": ["        if self.access_token:", "            return self.gh3.revoke_authorization(self.access_token)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def ref_to_params(branch=None, sha=None):", ""]}, {"lines": ["    params = urllib.urlencode({"]}, {"lines": ["        key: value", "        for key, value in {", "            'branch': branch,", "            'sha': sha,", "        }.iteritems()", "        if value", "    })"]}, {"lines": ["    if params:", "        return '?' + params", "    return ''"]}, {"lines": [""]}, {"lines": ["", "from framework.routing import Rule, json_renderer"]}, {"lines": [""]}, {"lines": ["", "settings_routes = {", "    'rules': ["]}, {"lines": ["", "        # Configuration"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/github/settings/',", "                '/project/<pid>/node/<nid>/github/settings/',", "            ],", "            'post',", "            views.config.github_set_config,", "            json_renderer,", "        ),"]}, {"lines": [""]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/github/tarball/',", "                '/project/<pid>/node/<nid>/github/tarball/',", "            ],", "            'get',", "            views.crud.github_download_starball,", "            json_renderer,", "            {'archive': 'tar'},", "            endpoint_suffix='__tar',", "        ),", "        Rule(", "            [", "                '/project/<pid>/github/zipball/',", "                '/project/<pid>/node/<nid>/github/zipball/',", "            ],", "            'get',", "            views.crud.github_download_starball,", "            json_renderer,", "            {'archive': 'zip'},", "            endpoint_suffix='__zip',", "        ),"]}, {"lines": [""]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/github/hook/',"]}, {"lines": ["                '/project/<pid>/node/<nid>/github/hook/',"]}, {"lines": ["            ],", "            'post',", "            views.hooks.github_hook_callback,", "            json_renderer,", "        ),"]}, {"lines": [""]}, {"lines": ["        # OAuth: User", "        Rule(", "            '/settings/github/oauth/',"]}, {"lines": ["            'get',", "            views.auth.github_oauth_start,", "            json_renderer,", "            endpoint_suffix='__user',", "        ),"]}, {"lines": ["        Rule("]}, {"lines": ["            '/settings/github/oauth/',", "            'delete',", "            views.auth.github_oauth_delete_user,", "            json_renderer,"]}, {"lines": ["        ),", "", "        # OAuth: Node"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/github/oauth/',", "                '/project/<pid>/node/<nid>/github/oauth/',", "            ],", "            'get',", "            views.auth.github_oauth_start,", "            json_renderer,", "        ),", "        Rule(", "            [", "                '/project/<pid>/github/user_auth/',", "                '/project/<pid>/node/<nid>/github/user_auth/',", "            ],", "            'post',", "            views.auth.github_add_user_auth,", "            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/github/oauth/',", "                '/project/<pid>/node/<nid>/github/oauth/',"]}, {"lines": ["            ],", "            'delete',"]}, {"lines": ["            views.auth.github_oauth_deauthorize_node,"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": ["", "        # OAuth: General"]}, {"lines": ["        Rule(", "            [", "                '/addons/github/callback/<uid>/',", "                '/addons/github/callback/<uid>/<nid>/',", "            ],", "            'get',", "            views.auth.github_oauth_callback,", "            json_renderer,", "        ),"]}, {"lines": ["    ],", "    'prefix': '/api/v1',", "}", ""]}, {"lines": ["", "        Rule("]}, {"lines": ["            '/github/repo/create/',", "            'post',", "            views.repos.github_create_repo,", "            json_renderer,", "        ),", ""]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/github/hgrid/root/',", "                '/project/<pid>/node/<nid>/github/hgrid/root/',"]}, {"lines": ["            ],", "            'get',"]}, {"lines": ["            views.hgrid.github_root_folder_public,"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": [""]}, {"lines": ["import logging"]}, {"lines": [""]}, {"lines": ["try:"]}, {"lines": ["except ImportError as error:"]}, {"lines": ["'use strict';"]}, {"lines": ["var Fangorn = require('js/fangorn');", "var waterbutler = require('js/waterbutler');"]}, {"lines": [""]}, {"lines": ["<!-- Authorization -->", "<div>"]}, {"lines": ["</div>", ""]}, {"lines": ["<%def name=\"submit_btn()\"></%def>"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["import mock"]}, {"lines": ["import unittest"]}, {"lines": ["from nose.tools import *  # noqa"]}, {"lines": [""]}, {"lines": ["from github3 import GitHubError"]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["from tests.factories import UserFactory, ProjectFactory", ""]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["", "from website.addons.github.exceptions import NotFoundError"]}, {"lines": ["from website.addons.github import settings as github_settings"]}, {"lines": ["from website.addons.github.model import AddonGitHubUserSettings", "from website.addons.github.model import AddonGitHubNodeSettings", "from website.addons.github.model import AddonGitHubOauthSettings", "from website.addons.github.model import GithubGuidFile"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestCallbacks(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):", "", "        super(TestCallbacks, self).setUp()"]}, {"lines": ["        self.project = ProjectFactory.build()"]}, {"lines": ["        self.consolidated_auth = Auth(self.project.creator)"]}, {"lines": ["        self.non_authenticator = UserFactory()"]}, {"lines": ["        self.project.add_contributor(", "            contributor=self.non_authenticator,"]}, {"lines": ["            auth=self.consolidated_auth,"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["        self.project.add_addon('github', auth=self.consolidated_auth)"]}, {"lines": ["        self.project.creator.add_addon('github')", "        self.node_settings = self.project.get_addon('github')", "        self.user_settings = self.project.creator.get_addon('github')", "        self.node_settings.user_settings = self.user_settings"]}, {"lines": ["        self.node_settings.user = 'Queen'", "        self.node_settings.repo = 'Sheer-Heart-Attack'"]}, {"lines": ["        self.node_settings.save()", ""]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.repo')"]}, {"lines": ["    def test_before_page_load_osf_public_gh_public(self, mock_repo):", "        self.project.is_public = True", "        self.project.save()"]}, {"lines": ["        message = self.node_settings.before_page_load(self.project, self.project.creator)"]}, {"lines": ["        mock_repo.assert_called_with(", "            self.node_settings.user,", "            self.node_settings.repo,", "        )", "        assert_false(message)", "", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_before_page_load_osf_public_gh_private(self, mock_repo):", "        self.project.is_public = True", "        self.project.save()"]}, {"lines": ["        message = self.node_settings.before_page_load(self.project, self.project.creator)"]}, {"lines": ["        mock_repo.assert_called_with(", "            self.node_settings.user,", "            self.node_settings.repo,", "        )", "        assert_true(message)", "", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_before_page_load_osf_private_gh_public(self, mock_repo):"]}, {"lines": ["        message = self.node_settings.before_page_load(self.project, self.project.creator)"]}, {"lines": ["        mock_repo.assert_called_with(", "            self.node_settings.user,", "            self.node_settings.repo,", "        )", "        assert_true(message)", "", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_before_page_load_osf_private_gh_private(self, mock_repo):"]}, {"lines": ["        message = self.node_settings.before_page_load(self.project, self.project.creator)"]}, {"lines": ["        mock_repo.assert_called_with(", "            self.node_settings.user,", "            self.node_settings.repo,", "        )", "        assert_false(message)", ""]}, {"lines": ["    def test_before_page_load_not_contributor(self):", "        message = self.node_settings.before_page_load(self.project, UserFactory())"]}, {"lines": ["        assert_false(message)"]}, {"lines": ["", "    def test_before_page_load_not_logged_in(self):", "        message = self.node_settings.before_page_load(self.project, None)"]}, {"lines": ["        assert_false(message)"]}, {"lines": [""]}, {"lines": ["    def test_before_remove_contributor_authenticator(self):", "        message = self.node_settings.before_remove_contributor(", "            self.project, self.project.creator", "        )", "        assert_true(message)", "", "    def test_before_remove_contributor_not_authenticator(self):", "        message = self.node_settings.before_remove_contributor(", "            self.project, self.non_authenticator", "        )", "        assert_false(message)", ""]}, {"lines": ["        )", "        assert_equal(", "            self.node_settings.user_settings,", "            None", "        )"]}, {"lines": ["", "    def test_after_remove_contributor_not_authenticator(self):", "        self.node_settings.after_remove_contributor("]}, {"lines": ["        )", "        assert_not_equal(", "            self.node_settings.user_settings,", "            None,", "        )", ""]}, {"lines": ["    @unittest.skipIf(not github_settings.SET_PRIVACY, 'Setting privacy is disabled.')"]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.set_privacy')"]}, {"lines": ["    def test_after_set_privacy_private_authenticated(self, mock_set_privacy):"]}, {"lines": ["        mock_set_privacy.return_value = {}"]}, {"lines": ["        message = self.node_settings.after_set_privacy("]}, {"lines": ["            self.project, 'private',", "        )", "        mock_set_privacy.assert_called_with(", "            self.node_settings.user,", "            self.node_settings.repo,", "            True,", "        )", "        assert_true(message)", "        assert_in('made private', message.lower())"]}, {"lines": [""]}, {"lines": ["    @unittest.skipIf(not github_settings.SET_PRIVACY, 'Setting privacy is disabled.')"]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.set_privacy')"]}, {"lines": ["    def test_after_set_privacy_public_authenticated(self, mock_set_privacy):"]}, {"lines": ["        mock_set_privacy.return_value = {}"]}, {"lines": ["        message = self.node_settings.after_set_privacy("]}, {"lines": ["            self.project, 'public'", "        )", "        mock_set_privacy.assert_called_with(", "            self.node_settings.user,", "            self.node_settings.repo,", "            False,", "        )", "        assert_true(message)", "        assert_in('made public', message.lower())", ""]}, {"lines": ["    @unittest.skipIf(not github_settings.SET_PRIVACY, 'Setting privacy is disabled.')"]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.repo')", "    @mock.patch('website.addons.github.api.GitHub.set_privacy')"]}, {"lines": ["    def test_after_set_privacy_not_authenticated(self, mock_set_privacy, mock_repo):"]}, {"lines": ["        mock_set_privacy.return_value = {'errors': ['it broke']}", "        mock_repo.return_value = {'private': True}"]}, {"lines": ["        message = self.node_settings.after_set_privacy("]}, {"lines": ["            self.project, 'private',", "        )", "        mock_set_privacy.assert_called_with(", "            self.node_settings.user,", "            self.node_settings.repo,", "            True,", "        )", "        mock_repo.assert_called_with(", "            self.node_settings.user,", "            self.node_settings.repo,", "        )", "        assert_true(message)", "        assert_in('could not set privacy', message.lower())"]}, {"lines": ["", "    def test_after_fork_authenticator(self):"]}, {"lines": ["        fork = ProjectFactory()", "        clone, message = self.node_settings.after_fork(", "            self.project, fork, self.project.creator,", "        )", "        assert_equal(", "            self.node_settings.user_settings,", "            clone.user_settings,", "        )"]}, {"lines": ["", "    def test_after_fork_not_authenticator(self):"]}, {"lines": ["        fork = ProjectFactory()", "        clone, message = self.node_settings.after_fork(", "            self.project, fork, self.non_authenticator,", "        )", "        assert_equal(", "            clone.user_settings,", "            None,", "        )", ""]}, {"lines": ["    def test_after_delete(self):", "        self.project.remove_node(Auth(user=self.project.creator))", "        # Ensure that changes to node settings have been saved", "        self.node_settings.reload()", "        assert_true(self.node_settings.user_settings is None)"]}, {"lines": ["", "", "class TestAddonGithubNodeSettings(OsfTestCase):", "", "    def setUp(self):", "        OsfTestCase.setUp(self)"]}, {"lines": ["        self.oauth_settings.github_user_id = 'testuser'", "        self.oauth_settings.save()", "        self.user_settings.oauth_settings = self.oauth_settings", "        self.user_settings.save()", "        self.node_settings = AddonGitHubNodeSettings("]}, {"lines": ["            user='chrisseto',", "            repo='openpokemon',", "            user_settings=self.user_settings,", "        )", "        self.node_settings.save()", ""]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.delete_hook')", "    def test_delete_hook(self, mock_delete_hook):", "        self.node_settings.hook_id = 'hook'", "        self.node_settings.save()", "        args = (", "            self.node_settings.user,", "            self.node_settings.repo,", "            self.node_settings.hook_id,", "        )", "        res = self.node_settings.delete_hook()", "        assert_true(res)", "        mock_delete_hook.assert_called_with(*args)", "", "    @mock.patch('website.addons.github.api.GitHub.delete_hook')", "    def test_delete_hook_no_hook(self, mock_delete_hook):", "        res = self.node_settings.delete_hook()", "        assert_false(res)", "        assert_false(mock_delete_hook.called)", "", "    @mock.patch('website.addons.github.api.GitHub.delete_hook')", "    def test_delete_hook_not_found(self, mock_delete_hook):", "        self.node_settings.hook_id = 'hook'", "        self.node_settings.save()", "        mock_delete_hook.side_effect = NotFoundError", "        args = (", "            self.node_settings.user,", "            self.node_settings.repo,", "            self.node_settings.hook_id,", "        )", "        res = self.node_settings.delete_hook()", "        assert_false(res)", "        mock_delete_hook.assert_called_with(*args)", "", "    @mock.patch('website.addons.github.api.GitHub.delete_hook')", "    def test_delete_hook_error(self, mock_delete_hook):", "        self.node_settings.hook_id = 'hook'", "        self.node_settings.save()", "        mock_delete_hook.side_effect = GitHubError(mock.Mock())", "        args = (", "            self.node_settings.user,", "            self.node_settings.repo,", "            self.node_settings.hook_id,", "        )", "        res = self.node_settings.delete_hook()", "        assert_false(res)", "        mock_delete_hook.assert_called_with(*args)"]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["from github3.repos.branch import Branch", ""]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["from website.util import api_url_for"]}, {"lines": [""]}, {"lines": ["class TestGithubViews(OsfTestCase):"]}, {"lines": ["        super(TestGithubViews, self).setUp()"]}, {"lines": ["        self.consolidated_auth = Auth(user=self.user)"]}, {"lines": [""]}, {"lines": ["        self.project = ProjectFactory(creator=self.user)"]}, {"lines": ["        self.non_authenticator = UserFactory()", "        self.project.add_contributor(", "            contributor=self.non_authenticator,"]}, {"lines": ["            auth=self.consolidated_auth,"]}, {"lines": ["        )", "        self.project.save()"]}, {"lines": ["        self.project.add_addon('github', auth=self.consolidated_auth)"]}, {"lines": ["    def _get_sha_for_branch(self, branch=None, mock_branches=None):"]}, {"lines": ["        if mock_branches is None:", "            mock_branches = github_mock.branches", "        if branch is None:  # Get default branch name"]}, {"lines": ["        for each in mock_branches.return_value:"]}, {"lines": ["        return branch_sha", ""]}, {"lines": ["    # Tests for _get_refs", "    @mock.patch('website.addons.github.api.GitHub.branches')", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_get_refs_defaults(self, mock_repo, mock_branches):"]}, {"lines": ["        mock_repo.return_value = github_mock.repo.return_value", "        mock_branches.return_value = github_mock.branches.return_value"]}, {"lines": ["        branch, sha, branches = utils.get_refs(self.node_settings)"]}, {"lines": ["        assert_equal(", "            branch,"]}, {"lines": ["        )"]}, {"lines": ["        assert_equal(", "            branches,", "            github_mock.branches.return_value", "        )", "", "    @mock.patch('website.addons.github.api.GitHub.branches')", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_get_refs_branch(self, mock_repo, mock_branches):"]}, {"lines": ["        mock_repo.return_value = github_mock.repo.return_value", "        mock_branches.return_value = github_mock.branches.return_value"]}, {"lines": ["        branch, sha, branches = utils.get_refs(self.node_settings, 'master')"]}, {"lines": ["        assert_equal(branch, 'master')"]}, {"lines": ["        branch_sha = self._get_sha_for_branch('master')", "        assert_equal(sha, branch_sha)"]}, {"lines": ["        assert_equal(", "            branches,", "            github_mock.branches.return_value", "        )", ""]}, {"lines": ["    def test_before_remove_contributor_authenticator(self):", "        url = self.project.api_url + 'beforeremovecontributors/'", "        res = self.app.post_json(", "            url,", "            {'id': self.project.creator._id},", "            auth=self.user.auth,", "        ).maybe_follow()"]}, {"lines": ["        # One prompt for transferring auth, one for removing self", "        assert_equal(len(res.json['prompts']), 2)"]}, {"lines": ["", "    def test_before_remove_contributor_not_authenticator(self):", "        url = self.project.api_url + 'beforeremovecontributors/'", "        res = self.app.post_json(", "            url,", "            {'id': self.non_authenticator._id},", "            auth=self.user.auth,", "        ).maybe_follow()", "        assert_equal(len(res.json['prompts']), 0)", "", "    def test_before_fork(self):"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth).maybe_follow()", "        assert_equal(len(res.json['prompts']), 1)", ""]}, {"lines": ["    @mock.patch('website.addons.github.model.AddonGitHubUserSettings.has_auth')", "    def test_before_register(self, mock_has_auth):", "        mock_has_auth.return_value = True"]}, {"lines": ["        url = self.project.api_url + 'beforeregister/'", "        res = self.app.get(url, auth=self.user.auth).maybe_follow()"]}, {"lines": ["    def test_get_refs_sha_no_branch(self):", "        with assert_raises(HTTPError):"]}, {"lines": ["            utils.get_refs(self.node_settings, sha='12345')"]}, {"lines": ["", "    def test_get_refs_registered_missing_branch(self):"]}, {"lines": ["        self.node_settings.registration_data = {"]}, {"lines": ["            'branches': [", "                branch.to_json()", "                for branch in github_mock.branches.return_value", "            ]"]}, {"lines": ["        }", "        self.node_settings.owner.is_registration = True", "        with assert_raises(HTTPError):"]}, {"lines": ["            utils.get_refs(self.node_settings, branch='nothere')"]}, {"lines": [""]}, {"lines": ["    # Tests for _check_permissions"]}, {"lines": ["    def test_permissions_no_auth(self):"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.github.views.hooks.utils.verify_hook_signature')", "    def test_hook_callback_add_file_not_thro_osf(self, mock_verify):"]}, {"lines": ["        self.app.post_json("]}, {"lines": ["            {", "                \"test\": True,", "                \"commits\": [{", "                    \"id\": \"b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                    \"distinct\": True,", "                    \"message\": \"foo\",", "                    \"timestamp\": \"2014-01-08T14:15:51-08:00\",", "                    \"url\": \"https://github.com/tester/addontesting/commit/b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\","]}, {"lines": ["                    \"added\": [\"PRJWN3TV\"],", "                    \"removed\": [],", "                    \"modified\": [],", "                }]", "            },", "            content_type=\"application/json\",", "        ).maybe_follow()"]}, {"lines": ["    @mock.patch('website.addons.github.views.hooks.utils.verify_hook_signature')", "    def test_hook_callback_modify_file_not_thro_osf(self, mock_verify):"]}, {"lines": ["        self.app.post_json("]}, {"lines": ["            {\"test\": True,"]}, {"lines": ["    @mock.patch('website.addons.github.views.hooks.utils.verify_hook_signature')", "    def test_hook_callback_remove_file_not_thro_osf(self, mock_verify):"]}, {"lines": ["        self.app.post_json("]}, {"lines": ["            {\"test\": True,"]}, {"lines": ["    @mock.patch('website.addons.github.views.hooks.utils.verify_hook_signature')", "    def test_hook_callback_add_file_thro_osf(self, mock_verify):"]}, {"lines": ["        self.app.post_json("]}, {"lines": ["            {\"test\": True,"]}, {"lines": ["    @mock.patch('website.addons.github.views.hooks.utils.verify_hook_signature')", "    def test_hook_callback_modify_file_thro_osf(self, mock_verify):"]}, {"lines": ["        self.app.post_json("]}, {"lines": ["            {\"test\": True,"]}, {"lines": ["    @mock.patch('website.addons.github.views.hooks.utils.verify_hook_signature')", "    def test_hook_callback_remove_file_thro_osf(self, mock_verify):"]}, {"lines": ["        self.app.post_json("]}, {"lines": ["            {\"test\": True,"]}, {"lines": [""]}, {"lines": ["class TestRegistrationsWithGithub(OsfTestCase):"]}, {"lines": ["        self.consolidated_auth = Auth(user=self.project.creator)"]}, {"lines": ["        self.project.add_addon('github', auth=self.consolidated_auth)"]}, {"lines": ["class TestGithubSettings(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):", "", "        super(TestGithubSettings, self).setUp()"]}, {"lines": ["        self.project = ProjectFactory.build()", "        self.project.save()", "        self.auth = self.project.creator.auth", "        self.consolidated_auth = Auth(user=self.project.creator)", "", "        self.project.add_addon('github', auth=self.consolidated_auth)", "        self.project.creator.add_addon('github')", "        self.node_settings = self.project.get_addon('github')", "        self.user_settings = self.project.creator.get_addon('github')", "        self.node_settings.user_settings = self.user_settings", "        self.node_settings.user = 'Queen'", "        self.node_settings.repo = 'Sheer-Heart-Attack'", "        self.node_settings.save()", "", "    @mock.patch('website.addons.github.model.AddonGitHubNodeSettings.add_hook')", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_link_repo(self, mock_repo, mock_add_hook):"]}, {"lines": ["        mock_repo.return_value = github_mock.repo.return_value", "", "        url = self.project.api_url + 'github/settings/'", "        self.app.post_json(", "            url,", "            {", "                'github_user': 'queen',", "                'github_repo': 'night at the opera',", "            },", "            auth=self.auth", "        ).maybe_follow()", "", "        self.project.reload()", "        self.node_settings.reload()", "", "        assert_equal(self.node_settings.user, 'queen')", "        assert_equal(self.node_settings.repo, 'night at the opera')", "        assert_equal(self.project.logs[-1].action, 'github_repo_linked')", "        mock_add_hook.assert_called_once()", "", "    @mock.patch('website.addons.github.model.AddonGitHubNodeSettings.add_hook')", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_link_repo_no_change(self, mock_repo, mock_add_hook):"]}, {"lines": ["        mock_repo.return_value = github_mock.repo.return_value", "", "        log_count = len(self.project.logs)", "", "        url = self.project.api_url + 'github/settings/'", "        self.app.post_json(", "            url,", "            {", "                'github_user': 'Queen',", "                'github_repo': 'Sheer-Heart-Attack',", "            },", "            auth=self.auth", "        ).maybe_follow()", "", "        self.project.reload()", "        self.node_settings.reload()", "", "        assert_equal(len(self.project.logs), log_count)", "        assert_false(mock_add_hook.called)", "", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_link_repo_non_existent(self, mock_repo):", "", "        mock_repo.return_value = None", "", "        url = self.project.api_url + 'github/settings/'", "        res = self.app.post_json(", "            url,", "            {", "                'github_user': 'queen',", "                'github_repo': 'night at the opera',", "            },", "            auth=self.auth,", "            expect_errors=True", "        ).maybe_follow()", "", "        assert_equal(res.status_code, 400)", "", "    @mock.patch('website.addons.github.api.GitHub.branches')", "    def test_link_repo_registration(self, mock_branches):", "", "        mock_branches.return_value = [", "            Branch.from_json({", "                'name': 'master',", "                'commit': {", "                    'sha': '6dcb09b5b57875f334f61aebed695e2e4193db5e',", "                    'url': 'https://api.github.com/repos/octocat/Hello-World/commits/c5b97d5ae6c19d5c5df71a34c7fbeeda2479ccbc',", "                }", "            }),", "            Branch.from_json({", "                'name': 'develop',", "                'commit': {", "                    'sha': '6dcb09b5b57875asdasedawedawedwedaewdwdass',", "                    'url': 'https://api.github.com/repos/octocat/Hello-World/commits/cdcb09b5b57875asdasedawedawedwedaewdwdass',", "                }", "            })", "        ]", "", "        registration = self.project.register_node(", "            None, self.consolidated_auth, '', ''", "        )", "", "        url = registration.api_url + 'github/settings/'", "        res = self.app.post_json(", "            url,", "            {", "                'github_user': 'queen',", "                'github_repo': 'night at the opera',", "            },", "            auth=self.auth,", "            expect_errors=True", "        ).maybe_follow()", "", "        assert_equal(res.status_code, 400)", "", "    @mock.patch('website.addons.github.model.AddonGitHubNodeSettings.delete_hook')", "    def test_deauthorize(self, mock_delete_hook):", "", "        url = self.project.api_url + 'github/oauth/'", "", "        self.app.delete(url, auth=self.auth).maybe_follow()", "", "        self.project.reload()", "        self.node_settings.reload()"]}, {"lines": ["        assert_equal(self.node_settings.user, None)", "        assert_equal(self.node_settings.repo, None)", "        assert_equal(self.node_settings.user_settings, None)", ""]}, {"lines": ["        assert_equal(self.project.logs[-1].action, 'github_node_deauthorized')"]}, {"lines": ["", ""]}, {"lines": ["import httplib as http", ""]}, {"lines": ["from framework.auth.decorators import must_be_logged_in"]}, {"lines": ["from framework.exceptions import HTTPError", ""]}, {"lines": ["from website.project.decorators import must_have_permission"]}, {"lines": ["from website.project.decorators import must_not_be_registration"]}, {"lines": ["from website.project.decorators import must_have_addon", "", "from ..api import GitHub", "", "", "@must_be_logged_in"]}, {"lines": ["def github_set_user_config(**kwargs):"]}, {"lines": ["    return {}", "", ""]}, {"lines": ["@must_have_permission('write')"]}, {"lines": ["@must_have_addon('github', 'node')"]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["def github_set_config(**kwargs):"]}, {"lines": [""]}, {"lines": ["    auth = kwargs['auth']", "    user = auth.user"]}, {"lines": [""]}, {"lines": ["    node_settings = kwargs['node_addon']", "    node = node_settings.owner", "    user_settings = node_settings.user_settings"]}, {"lines": ["", "    # If authorized, only owner can change settings"]}, {"lines": ["    if user_settings and user_settings.owner != user:"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)", "", "    # Parse request", "    github_user_name = request.json.get('github_user', '')", "    github_repo_name = request.json.get('github_repo', '')", "", "    # Verify that repo exists and that user can access"]}, {"lines": ["    connection = GitHub.from_settings(user_settings)"]}, {"lines": ["    repo = connection.repo(github_user_name, github_repo_name)", "    if repo is None:"]}, {"lines": ["        if user_settings:"]}, {"lines": ["            message = (", "                'Cannot access repo. Either the repo does not exist '", "                'or your account does not have permission to view it.'", "            )", "        else:", "            message = (", "                'Cannot access repo.'", "            )"]}, {"lines": ["        return {'message': message}, http.BAD_REQUEST"]}, {"lines": ["", "    if not github_user_name or not github_repo_name:", "        raise HTTPError(http.BAD_REQUEST)", "", "    changed = ("]}, {"lines": ["        github_user_name != node_settings.user or", "        github_repo_name != node_settings.repo"]}, {"lines": ["    )", "", "    # Update hooks", "    if changed:", "", "        # Delete existing hook, if any"]}, {"lines": ["        node_settings.delete_hook()"]}, {"lines": ["", "        # Update node settings"]}, {"lines": ["        node_settings.user = github_user_name", "        node_settings.repo = github_repo_name", "", "        # Log repo select", "        node.add_log(", "            action='github_repo_linked',", "            params={", "                'project': node.parent_id,", "                'node': node._id,", "                'github': {", "                    'user': github_user_name,", "                    'repo': github_repo_name,", "                }", "            },", "            auth=auth,", "        )"]}, {"lines": ["", "        # Add new hook"]}, {"lines": ["        if node_settings.user and node_settings.repo:", "            node_settings.add_hook(save=False)"]}, {"lines": [""]}, {"lines": ["        node_settings.save()"]}, {"lines": ["", "    return {}", "", ""]}, {"lines": ["@must_have_permission('write')"]}, {"lines": ["@must_have_addon('github', 'node')"]}, {"lines": ["def github_set_privacy(**kwargs):"]}, {"lines": ["", "    github = kwargs['node_addon']", "    private = request.form.get('private')", "", "    if private is None:", "        raise HTTPError(http.BAD_REQUEST)", "", "    connection = GitHub.from_settings(github.user_settings)", "", "    connection.set_privacy(github.user, github.repo, private)"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import logging"]}, {"lines": ["from github3 import GitHubError"]}, {"lines": [""]}, {"lines": ["from website.project.decorators import must_be_contributor_or_public", "from website.project.decorators import must_have_addon"]}, {"lines": ["from website.util import rubeus", ""]}, {"lines": ["from website.addons.github.api import GitHub, ref_to_params"]}, {"lines": ["from website.addons.github.utils import get_refs, check_permissions"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def github_hgrid_data(node_settings, auth, **kwargs):"]}, {"lines": [""]}, {"lines": ["    # Quit if no repo linked"]}, {"lines": ["    if not node_settings.complete:"]}, {"lines": ["        return", ""]}, {"lines": ["    connection = GitHub.from_settings(node_settings.user_settings)", ""]}, {"lines": ["    # Initialize repo here in the event that it is set in the privacy check", "    # below. This potentially saves an API call in _check_permissions, below.", "    repo = None", "", "    # Quit if privacy mismatch and not contributor"]}, {"lines": ["    node = node_settings.owner", "    if node.is_public and not node.is_contributor(auth.user):"]}, {"lines": ["        try:", "            repo = connection.repo(node_settings.user, node_settings.repo)", "        except NotFoundError:", "            # TODO: Test me @jmcarp", "            # TODO: Add warning message"]}, {"lines": ["            return None"]}, {"lines": ["        if repo.private:"]}, {"lines": ["            return None"]}, {"lines": [""]}, {"lines": ["    try:"]}, {"lines": ["        branch, sha, branches = get_refs("]}, {"lines": ["            node_settings,", "            branch=kwargs.get('branch'),", "            sha=kwargs.get('sha'),", "            connection=connection,", "        )"]}, {"lines": ["    except (NotFoundError, GitHubError):"]}, {"lines": ["        # TODO: Show an alert or change GitHub configuration?"]}, {"lines": ["        logger.error('GitHub repo not found')"]}, {"lines": ["        return"]}, {"lines": ["", "    if branch is not None:"]}, {"lines": ["        ref = ref_to_params(branch, sha)"]}, {"lines": ["        can_edit = check_permissions("]}, {"lines": ["            node_settings, auth, connection, branch, sha, repo=repo,"]}, {"lines": ["        )"]}, {"lines": ["    else:"]}, {"lines": ["        ref = None", "        can_edit = False"]}, {"lines": [""]}, {"lines": ["    name_tpl = '{user}/{repo}'.format("]}, {"lines": ["        user=node_settings.user, repo=node_settings.repo", "    )", ""]}, {"lines": ["    permissions = {", "        'edit': can_edit,", "        'view': True", "    }", "    urls = {", "        'upload': node_settings.owner.api_url + 'github/file/' + (ref or ''),", "        'fetch': node_settings.owner.api_url + 'github/hgrid/' + (ref or ''),", "        'branch': node_settings.owner.api_url + 'github/hgrid/root/',"]}, {"lines": ["    }"]}, {"lines": ["    return [rubeus.build_addon_root("]}, {"lines": ["        node_settings,"]}, {"lines": ["        name_tpl,"]}, {"lines": ["        urls=urls,", "        permissions=permissions,"]}, {"lines": ["    )]"]}, {"lines": ["", "", "@must_be_contributor_or_public", "@must_have_addon('github', 'node')"]}, {"lines": ["def github_root_folder_public(*args, **kwargs):", "    \"\"\"View function returning the root container for a GitHub repo. In"]}, {"lines": ["    contrast to other add-ons, this is exposed via the API for GitHub to", "    accommodate switching between branches and commits.", "", "    \"\"\"", "    node_settings = kwargs['node_addon']"]}, {"lines": ["    auth = kwargs['auth']"]}, {"lines": ["    data = request.args.to_dict()"]}, {"lines": [""]}, {"lines": ["    return github_hgrid_data(node_settings, auth=auth, **data)"]}, {"lines": ["import httplib as http"]}, {"lines": ["from github3 import GitHubError", ""]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from framework.auth.decorators import must_be_logged_in"]}, {"lines": ["", "from website.project.decorators import must_have_addon", "", "from ..api import GitHub", "", ""]}, {"lines": ["@must_be_logged_in", "@must_have_addon('github', 'user')"]}, {"lines": ["def github_create_repo(**kwargs):", "", "    repo_name = request.json.get('name')", "    if not repo_name:", "        raise HTTPError(http.BAD_REQUEST)", "", "    user_settings = kwargs['user_addon']", "    connection = GitHub.from_settings(user_settings)", "", "    try:"]}, {"lines": ["    except GitHubError:", "        # TODO: Check status code", "        raise HTTPError(http.BAD_REQUEST)", "", "    return {", "        'user': repo.owner.login,", "        'repo': repo.name,", "    }"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from website.util.client import BaseClient"]}, {"lines": ["    def _default_headers(self):"]}, {"lines": ["import pymongo"]}, {"lines": ["from modularodm import fields, Q"]}, {"lines": [""]}, {"lines": ["from website import settings"]}, {"lines": ["from website.addons.base import AddonUserSettingsBase, AddonNodeSettingsBase, GuidFile"]}, {"lines": [""]}, {"lines": ["from website.addons.googledrive import settings as drive_settings"]}, {"lines": ["    __indices__ = [", "        {", "            'key_or_list': [", "                ('node', pymongo.ASCENDING),", "                ('path', pymongo.ASCENDING),", "            ],", "            'unique': True,", "        }", "    ]", ""]}, {"lines": ["    def mfr_temp_path(self):", "        \"\"\"Files names from Google Docs metadata doesn't necessarily correspond", "        to download file names. Use the `downloadExt` field in the Docs metadata", "        to save the temporary file with the appropriate extension.", "        \"\"\"", "        ext = (", "            self._metadata_cache['extra'].get('downloadExt') or", "            os.path.splitext(self.name)[-1]", "        )", "        return os.path.join(", "            settings.MFR_TEMP_PATH,", "            self.node._id,", "            self.provider,", "            # Attempt to keep the original extension of the file for MFR detection", "            self.file_name + ext,", "        )", "", "    @property"]}, {"lines": ["                'path': metadata['path'],"]}, {"lines": ["        return GoogleDriveGuidFile.get_or_create(node=self.owner, path=path)"]}, {"lines": ["            return (u'Because the Google Drive add-on has been authorized by a different '"]}, {"lines": ["        self.save()"]}, {"lines": ["import os"]}, {"lines": ["import logging"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    return {"]}, {"lines": ["    ret = {"]}, {"lines": ["        ret['ownerName'] = user_settings.owner.fullname"]}, {"lines": ["    return {"]}, {"lines": ["'use strict';"]}, {"lines": ["var m = require('mithril');", "var Fangorn = require('js/fangorn');"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    path = request.args.get('path', '')"]}, {"lines": ["            'kind': rubeus.FOLDER,", "            'id': about['rootFolderId'],", "            'name': '/ (Full Google Drive)',"]}, {"lines": [""]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": [""]}, {"lines": ["    (see serialize_settings/serialize_urls)", "    \"\"\""]}, {"lines": ["", "@must_have_permission('write')", "@must_have_addon('mendeley', 'node')"]}, {"lines": ["    external_list_name = args.get('external_list_name')"]}, {"lines": ["        external_list_name,", "        auth,"]}, {"lines": ["def mendeley_widget(node_addon, **kwargs):"]}, {"lines": ["    \"\"\""]}, {"lines": ["    \"\"\""]}, {"lines": ["    return provider.citation_list(node_addon, auth.user, mendeley_list_id, show)"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var $osf = require('js/osfHelpers');", "var citations = require('js/citations');", "var CitationGrid = require('js/citationGrid');"]}, {"lines": [""]}, {"lines": ["function CitationsWidget(gridSelector, styleSelector) {"]}, {"lines": ["    this.grid = new CitationGrid('Mendeley', gridSelector, styleSelector, apiUrl);"]}, {"lines": ["", "// Skip if widget is not correctly configured", "if ($('#mendeleyWidget').length) {", "    new CitationsWidget('#mendeleyWidget', '#mendeleyStyleSelect');", "}"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from factory import SubFactory, Sequence", "", "from tests.factories import ModularOdmFactory, UserFactory, ProjectFactory, ExternalAccountFactory", "", "import datetime", "", "from dateutil.relativedelta import relativedelta", "", "from website.addons.mendeley import model", "", "", "class MendeleyAccountFactory(ExternalAccountFactory):", "    provider = 'mendeley'", "    provider_id = Sequence(lambda n: 'id-{0}'.format(n))", "    oauth_key = Sequence(lambda n: 'key-{0}'.format(n))", "    oauth_secret = Sequence(lambda n: 'secret-{0}'.format(n))", "    expires_at = datetime.datetime.now() + relativedelta(days=1)", "", "", "class MendeleyUserSettingsFactory(ModularOdmFactory):"]}, {"lines": ["", "    owner = SubFactory(UserFactory)", "", "", "class MendeleyNodeSettingsFactory(ModularOdmFactory):"]}, {"lines": ["", "    owner = SubFactory(ProjectFactory)"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import mock", "from nose.tools import *  # noqa"]}, {"lines": ["from framework.auth.core import Auth"]}, {"lines": ["from tests.factories import UserFactory, ProjectFactory", "from website.addons.mendeley.tests.factories import ("]}, {"lines": ["    MendeleyAccountFactory,", "    MendeleyUserSettingsFactory,"]}, {"lines": [")"]}, {"lines": ["import datetime", "", "from website.addons.mendeley import model"]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):", "        super(MendeleyProviderTestCase, self).setUp()", "        self.provider = model.Mendeley()", "", "    @mock.patch('website.addons.mendeley.model.Mendeley._get_client')", "    def test_handle_callback(self, mock_get_client):"]}, {"lines": ["        mock_client = mock.Mock()", "        mock_client.profiles.me = mock.Mock(id='testid', display_name='testdisplay')", "        mock_get_client.return_value = mock_client", "        res = self.provider.handle_callback('testresponse')", "        mock_get_client.assert_called_with('testresponse')", "        assert_equal(res.get('provider_id'), 'testid')", "        assert_equal(res.get('display_name'), 'testdisplay')"]}, {"lines": ["    @mock.patch('website.addons.mendeley.model.Mendeley._get_client')", "    def test_client_not_cached(self, mock_get_client):"]}, {"lines": ["        mock_account = mock.Mock()", "        mock_account.expires_at = datetime.datetime.now()", "        self.provider.account = mock_account", "        self.provider.client", "        mock_get_client.assert_called", "        assert_true(mock_get_client.called)"]}, {"lines": ["    @mock.patch('website.addons.mendeley.model.Mendeley._get_client')", "    def test_client_cached(self, mock_get_client):"]}, {"lines": ["        self.provider._client = mock.Mock()", "        res = self.provider.client", "        assert_equal(res, self.provider._client)", "        assert_false(mock_get_client.called)"]}, {"lines": ["        mock_client = mock.Mock()"]}, {"lines": ["        mock_list = mock.Mock()", "        mock_list.items = mock_folders", "        mock_client.folders.list.return_value = mock_list", "        self.provider._client = mock_client", "        mock_account = mock.Mock()", "        self.provider.account = mock_account"]}, {"lines": ["", "    def setUp(self):", "        super(MendeleyNodeSettingsTestCase, self).setUp()"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.mendeley.model.Mendeley')", "    def test_api_not_cached(self, mock_mendeley):"]}, {"lines": ["        mock_mendeley.assert_called_once()", "        assert_equal(api, mock_mendeley())"]}, {"lines": ["    @mock.patch('website.addons.mendeley.model.Mendeley')", "    def test_api_cached(self, mock_mendeley):"]}, {"lines": ["        assert_false(mock_mendeley.called)", "        assert_equal(api, 'testapi')"]}, {"lines": ["            )"]}, {"lines": ["        folder_id = 'fake-folder-id'", "        folder_name = 'fake-folder-name'", ""]}, {"lines": ["            user=self.user,"]}, {"lines": ["        self.node_settings.set_target_folder(", "            folder_id,", "            folder_name,", "            auth=Auth(user=self.user),", "        )"]}, {"lines": ["        log = self.node.logs[-1]", "        assert_equal(log.action, 'mendeley_folder_selected')", "        assert_equal(log.params['folder_id'], folder_id)", "        assert_equal(log.params['folder_name'], folder_name)", ""]}, {"lines": ["    # TODO: Make these tests generic and move to core", ""]}, {"lines": ["    @mock.patch('framework.status.push_status_message')", "    def test_remove_contributor_authorizer(self, mock_push_status):", "        external_account = ExternalAccountFactory()", "        self.user.external_accounts.append(external_account)", "        self.node_settings.set_auth(external_account, self.user)", "", "        contributor = UserFactory()", "        self.node.add_contributor(contributor)", "        self.node.remove_contributor(self.node.creator, auth=Auth(user=contributor))", "", "        assert_false(self.node_settings.has_auth)", "        assert_false(self.user_settings.verify_oauth_access(self.node, external_account))", "", "    def test_remove_contributor_not_authorizer(self):", "        external_account = ExternalAccountFactory()", "        self.user.external_accounts.append(external_account)", "        self.node_settings.set_auth(external_account, self.user)", "", "        contributor = UserFactory()", "        self.node.add_contributor(contributor)", "        self.node.remove_contributor(contributor, auth=Auth(user=self.node.creator))", "", "        assert_true(self.node_settings.has_auth)", "        assert_true(self.user_settings.verify_oauth_access(self.node, external_account))", ""]}, {"lines": ["    @mock.patch('framework.status.push_status_message')", "    def test_fork_by_authorizer(self, mock_push_status):", "        external_account = ExternalAccountFactory()", "        self.user.external_accounts.append(external_account)", "        self.node_settings.set_auth(external_account, self.user)", "", "        fork = self.node.fork_node(auth=Auth(user=self.node.creator))", "", "        assert_true(fork.get_addon('mendeley').has_auth)", "        assert_true(self.user_settings.verify_oauth_access(fork, external_account))", "", "    @mock.patch('framework.status.push_status_message')", "    def test_fork_not_by_authorizer(self, mock_push_status):", "        external_account = ExternalAccountFactory()", "        self.user.external_accounts.append(external_account)", "        self.node_settings.set_auth(external_account, self.user)", "", "        contributor = UserFactory()", "        self.node.add_contributor(contributor)", "        fork = self.node.fork_node(auth=Auth(user=contributor))", "", "        assert_false(fork.get_addon('mendeley').has_auth)", "        assert_false(self.user_settings.verify_oauth_access(fork, external_account))", ""]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from nose.tools import *  # noqa", ""]}, {"lines": ["from tests.factories import AuthUserFactory, ProjectFactory", ""]}, {"lines": ["import urlparse", ""]}, {"lines": ["from website.addons.mendeley.tests.factories import ("]}, {"lines": ["    MendeleyAccountFactory,", "    MendeleyUserSettingsFactory,"]}, {"lines": ["    MendeleyNodeSettingsFactory", ")", ""]}, {"lines": [""]}, {"lines": ["API_URL = 'https://api.mendeley.com'", ""]}, {"lines": ["", "    def setUp(self):", "        super(MendeleyViewsTestCase, self).setUp()", "        self.account = MendeleyAccountFactory()", "        self.user = AuthUserFactory(external_accounts=[self.account])"]}, {"lines": ["        self.project = ProjectFactory(creator=self.user)"]}, {"lines": [""]}, {"lines": ["            {", "                'external_account_id': self.account._id,"]}, {"lines": ["            },", "            auth=self.user.auth,", "        )"]}, {"lines": [""]}, {"lines": ["        )"]}, {"lines": ["        self.node_addon.set_target_folder('ROOT-ID', 'ROOT', auth=Auth(user=self.user))"]}, {"lines": ["        assert_equal(res['list_id'], 'ROOT-ID')"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["        return file_record.name"]}, {"lines": ["    return u'{name}-{date}{ext}'.format("]}, {"lines": ["from framework import sessions", "from framework.flask import request"]}, {"lines": ["            factories.FileVersionFactory(creator=self.user)"]}, {"lines": ["        sessions.sessions[request._get_current_object()] = Session()"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["import pymongo"]}, {"lines": [""]}, {"lines": ["from framework.auth.core import Auth"]}, {"lines": [""]}, {"lines": ["from website.addons.base import exceptions"]}, {"lines": ["from website.addons.base import AddonUserSettingsBase, AddonNodeSettingsBase, GuidFile"]}, {"lines": [""]}, {"lines": ["", "class S3GuidFile(GuidFile):"]}, {"lines": ["    __indices__ = [", "        {", "            'key_or_list': [", "                ('node', pymongo.ASCENDING),", "                ('path', pymongo.ASCENDING),", "            ],", "            'unique': True,", "        }", "    ]"]}, {"lines": ["", "    path = fields.StringField(index=True)", "", "    @property"]}, {"lines": [""]}, {"lines": ["", "class AddonS3UserSettings(AddonUserSettingsBase):", "", "    access_key = fields.StringField()", "    secret_key = fields.StringField()", "", "    def to_json(self, user):"]}, {"lines": ["", "    @property", "    def has_auth(self):"]}, {"lines": ["        return bool(self.access_key and self.secret_key)", ""]}, {"lines": [""]}, {"lines": ["    def revoke_auth(self, save=False):", "        for node_settings in self.addons3nodesettings__authorized:"]}, {"lines": ["        self.s3_osf_user, self.access_key, self.secret_key = None, None, None"]}, {"lines": ["        if save:", "            self.save()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    bucket = fields.StringField()", "    user_settings = fields.ForeignField(", "        'addons3usersettings', backref='authorized'", "    )", ""]}, {"lines": ["        return S3GuidFile.get_or_create(node=self.owner, path=path)"]}, {"lines": ["    def authorize(self, user_settings, save=False):", "        self.user_settings = user_settings", "        self.owner.add_log(", "            action='s3_node_authorized',", "            params={", "                'project': self.owner.parent_id,", "                'node': self.owner._id,", "            },", "            auth=Auth(user_settings.owner),", "        )", "        if save:", "            self.save()", "", "    def deauthorize(self, auth=None, log=True, save=False):"]}, {"lines": ["        if log:", "            self.owner.add_log(", "                action='s3_node_deauthorized',", "                params={", "                    'project': self.owner.parent_id,", "                    'node': self.owner._id,", "                },", "                auth=auth,", "            )", "        if save:", "            self.save()", ""]}, {"lines": ["    def delete(self, save=True):"]}, {"lines": ["        self.deauthorize(log=False, save=False)", "        super(AddonS3NodeSettings, self).delete(save=save)"]}, {"lines": [""]}, {"lines": ["            raise exceptions.AddonError('Cannot serialize credentials for S3 addon')"]}, {"lines": ["            raise exceptions.AddonError('Cannot serialize settings for S3 addon')"]}, {"lines": ["    def to_json(self, user):"]}, {"lines": [""]}, {"lines": ["            'user_has_auth': bool(user_settings) and user_settings.has_auth,"]}, {"lines": ["            'bucket_list': None,"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "    @property"]}, {"lines": ["    def has_auth(self):"]}, {"lines": ["        #TODO Update callbacks", ""]}, {"lines": ["    def before_register(self, node, user):", "        \"\"\"", "", "        :param Node node:", "        :param User user:", "        :return str: Alert message", "", "        \"\"\""]}, {"lines": ["        if self.user_settings and self.user_settings.has_auth:"]}, {"lines": ["            return ("]}, {"lines": ["", "    def after_fork(self, node, fork, user, save=True):", "        \"\"\"", "", "        :param Node node: Original node", "        :param Node fork: Forked node", "        :param User user: User creating fork", "        :param bool save: Save settings after callback", "        :return tuple: Tuple of cloned settings and alert message", "", "        \"\"\"", "        clone, _ = super(AddonS3NodeSettings, self).after_fork(", "            node, fork, user, save=False", "        )", "", "        # Copy authentication if authenticated by forking user", "        if self.user_settings and self.user_settings.owner == user:", "            clone.user_settings = self.user_settings", "            clone.bucket = self.bucket", "            message = (", "                'Amazon Simple Storage authorization copied to forked {cat}.'", "            ).format(", "                cat=fork.project_or_component,", "            )", "        else:", "            message = (", "                'Amazon Simple Storage authorization not copied to forked {cat}. You may '", "                'authorize this fork on the <a href={url}>Settings</a> '", "                'page.'", "            ).format(", "                cat=fork.project_or_component,", "                url=fork.url + 'settings/'", "            )", "", "        if save:", "            clone.save()", "", "        return clone, message", "", "    def before_fork(self, node, user):", "        \"\"\"", "", "        :param Node node:", "        :param User user:", "        :return str: Alert message", "", "        \"\"\"", "", "        if self.user_settings and self.user_settings.owner == user:", "            return (", "                'Because you have authenticated the S3 add-on for this '", "                '{cat}, forking it will also transfer your authorization to '", "                'the forked {cat}.'", "            ).format(", "                cat=node.project_or_component,", "            )", "        return (", "            'Because this S3 add-on has been authenticated by a different '", "            'user, forking it will not transfer authentication to the forked '", "            '{cat}.'", "        ).format(", "            cat=node.project_or_component,", "        )", "", "    def before_remove_contributor(self, node, removed):", "        \"\"\"", "", "        :param Node node:", "        :param User removed:", "        :return str: Alert message", "", "        \"\"\"", "        if self.user_settings and self.user_settings.owner == removed:", "            return (", "                'The Amazon Simple Storage add-on for this {category} is authenticated '", "                'by {user}. Removing this user will also remove access '", "                'to {bucket} unless another contributor re-authenticates.'", "            ).format(", "                category=node.project_or_component,", "                user=removed.fullname,", "                bucket=self.bucket", "            )", ""]}, {"lines": ["        \"\"\"", "", "        :param Node node:", "        :param User removed:", "        :return str: Alert message", "", "        \"\"\"", "        if self.user_settings and self.user_settings.owner == removed:", "            self.user_settings = None", "            self.bucket = None", "            self.save()", ""]}, {"lines": ["", "    def after_delete(self, node, user):", "        self.deauthorize(Auth(user=user), log=True, save=True)"]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "MAX_RENDER_SIZE = (1024 ** 2) * 3", ""]}, {"lines": ["ALLOWED_ORIGIN = '*'"]}, {"lines": [""]}, {"lines": [")"]}, {"lines": ["", "    Rubeus.cfg.s3 = {", "", "        uploadMethod: 'PUT',", "        uploadUrl: null,", "        uploadAdded: function(file, item) {", "            var self = this;", "            var parent = self.getByID(item.parentID);", "            var name = file.name;", "            // Make it possible to upload into subfolders", "            while (parent.depth > 1 && !parent.isAddonRoot) {", "                name = parent.name + '/' + name;", "                parent = self.getByID(parent.parentID);", "            }", "            file.destination = name;"]}, {"lines": ["        },", "", "        uploadSending: function(file, formData, xhr) {", "            xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');", "            xhr.setRequestHeader('x-amz-acl', 'private');", "        },"]}, {"lines": [""]}, {"lines": ["                'delete': parent.nodeApiUrl + 's3/' + file.destination + '/',", "                'download': parent.nodeUrl + 's3/' + file.destination + '/download/',", "                'view': parent.nodeUrl + 's3/' + file.destination + '/'"]}, {"lines": ["            };"]}, {"lines": ["        }", "    };", ""]}, {"lines": ["'use strict';", ""]}, {"lines": ["var AddonHelper = require('js/addonHelper');"]}, {"lines": ["<a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect, text: params.path\"></a> to"]}, {"lines": ["", "<script type=\"text/html\" id=\"s3_bucket_linked\">"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>", "", "<script type=\"text/html\" id=\"s3_bucket_unlinked\">", "un-selected bucket", "<span data-bind=\"text: params.bucket\"></span> in"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>"]}, {"lines": ["", "<script type=\"text/html\" id=\"s3_node_authorized\">"]}, {"lines": ["<a class=\"log-node-title-link overflow\"", "    data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", "", "<script type=\"text/html\" id=\"s3_node_deauthorized\">"]}, {"lines": ["<a class=\"log-node-title-link overflow\"", "    data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>"]}, {"lines": ["    </div>"]}, {"lines": [""]}, {"lines": ["        </button>"]}, {"lines": ["<%def name=\"on_submit()\">"]}, {"lines": ["</%def>"]}, {"lines": ["import mock"]}, {"lines": [""]}, {"lines": ["from tests.base import OsfTestCase"]}, {"lines": ["from tests.factories import UserFactory, ProjectFactory", ""]}, {"lines": ["from framework.auth import Auth"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestCallbacks(OsfTestCase):"]}, {"lines": ["", "    def setUp(self):", "", "        super(TestCallbacks, self).setUp()", "", "        self.project = ProjectFactory.build()"]}, {"lines": ["        self.consolidated_auth = Auth(user=self.project.creator)"]}, {"lines": ["        self.non_authenticator = UserFactory()", "        self.project.add_contributor(", "            contributor=self.non_authenticator,", "            auth=Auth(self.project.creator),", "        )", "        self.project.save()", ""]}, {"lines": ["        self.project.add_addon('s3', auth=self.consolidated_auth)"]}, {"lines": ["        self.project.creator.add_addon('s3')", "        self.node_settings = self.project.get_addon('s3')", "        self.user_settings = self.project.creator.get_addon('s3')", "        self.user_settings.access_key = 'We-Will-Rock-You'", "        self.user_settings.secret_key = 'Idontknowanyqueensongs'", "        self.node_settings.bucket = 'Sheer-Heart-Attack'", "        self.node_settings.user_settings = self.user_settings", "        self.node_settings.save()", ""]}, {"lines": ["        s3 = AddonS3NodeSettings(owner=self.project)"]}, {"lines": ["        assert_equals(s3.to_json(self.project.creator)['has_bucket'], 0)", ""]}, {"lines": ["        s3 = AddonS3NodeSettings(owner=self.project)"]}, {"lines": ["        s3.bucket = 'bucket'", "        assert_equals(s3.to_json(self.project.creator)['has_bucket'], 1)", ""]}, {"lines": ["        s3 = AddonS3NodeSettings(owner=self.project)"]}, {"lines": ["        assert_equals(s3.to_json(self.project.creator)['user_has_auth'], 1)", ""]}, {"lines": ["        assert_equals(self.node_settings.to_json(", "            self.project.creator)['user_has_auth'], 1)", ""]}, {"lines": ["        user2 = UserFactory()", "        self.project.add_contributor(user2)", "        assert_false(", "            self.node_settings.to_json(user2)['user_has_auth']", "        )", ""]}, {"lines": ["    def test_user_settings(self):"]}, {"lines": ["        s3 = AddonS3UserSettings(owner=self.project)"]}, {"lines": ["        s3.access_key = \"Sherlock\"", "        s3.secret_key = \"lives\"", "        assert_equals(s3.to_json(self.project.creator)['has_auth'], 1)", ""]}, {"lines": ["    def test_after_fork_authenticator(self):", "        fork = ProjectFactory()", "        clone, message = self.node_settings.after_fork(self.project,", "                                                       fork, self.project.creator)", "        assert_equal(self.node_settings.user_settings, clone.user_settings)", "", "    def test_after_fork_not_authenticator(self):", "        fork = ProjectFactory()", "        clone, message = self.node_settings.after_fork(", "            self.project, fork, self.non_authenticator,", "        )", "        assert_equal(clone.user_settings, None)", ""]}, {"lines": ["        )", "        assert_equal(self.node_settings.user_settings, None)"]}, {"lines": [""]}, {"lines": ["        clone, message = self.node_settings.after_register("]}, {"lines": ["        )"]}, {"lines": ["", "    def test_before_register_no_settings(self):", "        self.node_settings.user_settings = None", "        message = self.node_settings.before_register(self.project, self.project.creator)", "        assert_false(message)", "", "    def test_before_register_no_auth(self):", "        self.node_settings.user_settings.access_key = None", "        message = self.node_settings.before_register(self.project, self.project.creator)", "        assert_false(message)", "", "    def test_before_register_settings_and_auth(self):", "        message = self.node_settings.before_register(self.project, self.project.creator)"]}, {"lines": ["        assert_true(message)", "", "    def test_after_delete(self):", "        self.project.remove_node(Auth(user=self.project.creator))", "        # Ensure that changes to node settings have been saved", "        self.node_settings.reload()", "        assert_true(self.node_settings.user_settings is None)", "        assert_true(self.node_settings.bucket is None)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["\"\"\"", "", "\"\"\"", ""]}, {"lines": ["import os", ""]}, {"lines": ["from framework.routing import Rule, json_renderer", "from website.routes import OsfWebRenderer", "", "from . import views", ""]}, {"lines": ["TEMPLATE_DIR = '../addons/wiki/templates/'"]}, {"lines": [""]}, {"lines": ["settings_routes = {"]}, {"lines": ["    'rules': [],"]}, {"lines": ["    'prefix': '/api/v1',", "}"]}, {"lines": ["", "widget_routes = {", "    'rules': [", "        Rule([", "            '/project/<pid>/wiki/widget/',", "            '/project/<pid>/node/<nid>/wiki/widget/',", "        ], 'get', views.wiki_widget, json_renderer),", "    ],", "    'prefix': '/api/v1',", "}"]}, {"lines": [""]}, {"lines": ["page_routes = {", "", "    'rules': [", ""]}, {"lines": [""]}, {"lines": ["    ]", "", "}", "", "api_routes = {"]}, {"lines": ["    'rules': ["]}, {"lines": ["        # Edit | POST", "        Rule(["]}, {"lines": ["        ], 'post', views.project_wiki_edit_post, json_renderer),", ""]}, {"lines": ["    ],"]}, {"lines": ["    'prefix': '/api/v1',"]}, {"lines": ["var $osf = require('js/osfHelpers');", "var mathrender = require('js/mathrender');", "var md = require('js/markdown').full;", "var mdQuick = require('js/markdown').quick;", "var diffTool = require('js/diffTool');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            </li>"]}, {"lines": ["from tests.factories import ("]}, {"lines": ["    AuthUserFactory, NodeWikiFactory,"]}, {"lines": [")"]}, {"lines": ["class TestWikiViews(OsfTestCase):"]}, {"lines": ["        super(TestWikiViews, self).setUp()"]}, {"lines": ["        res = self.app.get(url)", "        assert_equal(res.status_code, 200)"]}, {"lines": ["        res = self.app.get(url)", "        assert_equal(res.status_code, 200)"]}, {"lines": ["        assert_equal(res.status_code, 200)"]}, {"lines": ["        assert_equal(res.status_code, 200)"]}, {"lines": [""]}, {"lines": ["        assert_equal(len(serialized), 2)", "        no_wiki.delete_addon('wiki', auth=auth)"]}, {"lines": ["        assert_equal(len(serialized), 1)"]}, {"lines": ["", "    def test_get_wiki_url_pointer_component(self):"]}, {"lines": ["", "        \"\"\"", "        user = UserFactory()", "        pointed_node = NodeFactory(creator=user)", "        project = ProjectFactory(creator=user)", "        auth = Auth(user=user)", "        project.add_pointer(pointed_node, auth=auth, save=True)", ""]}, {"lines": [""]}, {"lines": ["        super(TestWikiRename, self).setUp()", ""]}, {"lines": ["        self.url = self.project.api_url_for(", "            'project_wiki_rename',"]}, {"lines": ["        )"]}, {"lines": ["        self.app.put_json(", "            self.url,"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["", "class TestWikiLinks(OsfTestCase):", "", "    def test_links(self):", "        user = AuthUserFactory()", "        project = ProjectFactory(creator=user)", "        wiki = NodeWikiFactory(", "            content='[[wiki2]]',", "            user=user,", "            node=project,", "        )", "        assert_in("]}, {"lines": ["            wiki.html(project),", "        )"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        all_documents = serialize_folder(", "            'All Documents',"]}, {"lines": ["        )"]}, {"lines": ["        serialized_folders = ["]}, {"lines": ["            for each in collections"]}, {"lines": ["        return [all_documents] + serialized_folders"]}, {"lines": ["        return collection"]}, {"lines": ["    def set_target_folder(self, zotero_list_id, zotero_list_name, auth):"]}, {"lines": ["", "        self.owner.add_log(", "            'zotero_folder_selected',", "            params={", "                'project': self.owner.parent_id,", "                'node': self.owner._id,", "                'folder_id': zotero_list_id,", "                'folder_name': zotero_list_name,", "            },", "            auth=auth,", "        )"]}, {"lines": ["    external_list_name = args.get('external_list_name')"]}, {"lines": ["        external_list_name,", "        auth,"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var $osf = require('js/osfHelpers');", "var citations = require('js/citations');", "var CitationGrid = require('js/citationGrid');"]}, {"lines": [""]}, {"lines": ["import hashlib", "import urllib", "", "# Adapted from https://github.com/zzzsochi/Flask-Gravatar/blob/master/flaskext/gravatar.py", "def gravatar(user, use_ssl=False, d=None, r=None, size=None):", "", "    if use_ssl:", "        base_url = 'https://secure.gravatar.com/avatar/'", "    else:", "        base_url = 'http://www.gravatar.com/avatar/'", "", "    # user can be a User instance or a username string", "    username = user.username if hasattr(user, 'username') else user"]}, {"lines": ["    hash_code = hashlib.md5(unicode(username).encode('utf-8')).hexdigest()"]}, {"lines": ["", "    url = base_url + '?'", "", "    _locals = locals()"]}, {"lines": ["    url = base_url + hash_code + '?' + urllib.urlencode(params)", "", "    return url"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "import furl"]}, {"lines": [""]}, {"lines": ["from website.util.client import BaseClient"]}, {"lines": [""]}, {"lines": ["from . import utils"]}, {"lines": ["", ""]}, {"lines": ["class EzidClient(BaseClient):"]}, {"lines": ["", "    BASE_URL = 'https://ezid.cdlib.org'", "", "    def __init__(self, username, password):", "        self.username = username", "        self.password = password", "", "    def _build_url(self, *segments, **query):", "        url = furl.furl(self.BASE_URL)", "        url.path.segments.extend(segments)", "        url.args.update(query)", "        return url.url", "", "    @property", "    def _auth(self):", "        return (self.username, self.password)", "", "    @property", "    def _default_headers(self):", "        return {'Content-Type': 'text/plain; charset=UTF-8'}", ""]}, {"lines": ["    def get_identifier(self, identifier):", "        resp = self._make_request(", "            'GET',", "            self._build_url('id', identifier),", "            expects=(200, ),", "        )", "        return utils.from_anvl(resp.content.strip('\\n'))", "", "    def create_identifier(self, identifier, metadata=None):", "        resp = self._make_request(", "            'PUT',", "            self._build_url('id', identifier),", "            data=utils.to_anvl(metadata or {}),", "            expects=(201, ),", "        )", "        return utils.from_anvl(resp.content)", "", "    def mint_identifier(self, shoulder, metadata=None):", "        resp = self._make_request(", "            'POST',", "            self._build_url('shoulder', shoulder),", "            data=utils.to_anvl(metadata or {}),", "            expects=(201, ),", "        )", "        return utils.from_anvl(resp.content)"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from bson import ObjectId", "", "from modularodm import Q", "from modularodm import fields", "from modularodm.storage.base import KeyExistsException", "", "from framework.mongo import StoredObject", "from framework.mongo.utils import unique_on", "", "", "@unique_on(['referent.0', 'referent.1', 'category'])", "class Identifier(StoredObject):"]}, {"lines": ["    _id = fields.StringField(default=lambda: str(ObjectId()))"]}, {"lines": ["    referent = fields.AbstractForeignField(required=True)"]}, {"lines": ["    category = fields.StringField(required=True)"]}, {"lines": ["    value = fields.StringField(required=True)"]}, {"lines": ["", "", "class IdentifierMixin(object):"]}, {"lines": ["", "    def get_identifier(self, category):", "        identifiers = Identifier.find(", "            Q('referent', 'eq', self) &", "            Q('category', 'eq', category)", "        )", "        return identifiers[0] if identifiers else None", "", "    def get_identifier_value(self, category):", "        identifier = self.get_identifier(category)", "        return identifier.value if identifier else None", ""]}, {"lines": ["    def set_identifier_value(self, category, value):"]}, {"lines": ["        try:", "            identifier = Identifier(referent=self, category=category, value=value)", "            identifier.save()", "        except KeyExistsException:", "            identifier = self.get_identifier(category)", "            assert identifier is not None"]}, {"lines": ["            identifier.value = value"]}, {"lines": ["            identifier.save()"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["import datetime"]}, {"lines": ["from modularodm import fields", "from modularodm.storage.base import KeyExistsException"]}, {"lines": ["from framework.mongo.utils import unique_on"]}, {"lines": [""]}, {"lines": ["from website.oauth.utils import PROVIDER_LOOKUP"]}, {"lines": ["@unique_on(['provider', 'provider_id'])"]}, {"lines": ["            self.account = ExternalAccount(", "                provider=self.short_name,", "                provider_id=info['provider_id'],"]}, {"lines": ["            )", "            self.account.save()", "        except KeyExistsException:"]}, {"lines": ["            assert self.account is not None"]}, {"lines": ["from website.util.permissions import reduce_permissions"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def serialize_user(user, node=None, admin=False, full=False):"]}, {"lines": ["    \"\"\"Return a dictionary representation of a registered user."]}, {"lines": ["    :param User user: A User object", "    :param bool full: Include complete user properties"]}, {"lines": ["    \"\"\""]}, {"lines": ["    ret = {"]}, {"lines": ["        'surname': user.family_name,"]}, {"lines": ["    if node is not None:"]}, {"lines": ["        if admin:", "            flags = {", "                'visible': False,", "                'permission': 'read',", "            }", "        else:", "            flags = {", "                'visible': user._id in node.visible_contributor_ids,", "                'permission': reduce_permissions(node.get_permissions(user)),", "            }"]}, {"lines": ["        ret.update(flags)"]}, {"lines": ["        ret.update({"]}, {"lines": ["    if full:"]}, {"lines": ["        if user.is_merged:", "            merger = user.merged_by", "            merged_by = {", "                'id': str(merger._primary_key),", "                'url': merger.url,", "                'absolute_url': merger.absolute_url", "            }", "        else:", "            merged_by = None"]}, {"lines": ["        ret.update({"]}, {"lines": ["            'number_projects': len(get_projects(user)),", "            'number_public_projects': len(get_public_projects(user)),"]}, {"lines": ["            'is_merged': user.is_merged,", "            'merged_by': merged_by,", "        })", ""]}, {"lines": ["    return ret"]}, {"lines": [""]}, {"lines": ["def serialize_contributors(contribs, node, **kwargs):"]}, {"lines": ["    return ["]}, {"lines": ["        serialize_user(contrib, node, **kwargs)"]}, {"lines": ["        for contrib in contribs", "    ]"]}, {"lines": ["from framework.mongo.utils import from_mongo"]}, {"lines": ["    \"\"\"Create a new project or component.", "", "    :param str category: Node category", "    :param str title: Node title", "    :param User user: User object", "    :param str description: Node description", "    :param Node project: Optional parent object", "    :return Node: Created node", "", "    \"\"\""]}, {"lines": ["    node = Node("]}, {"lines": ["    node.save()"]}, {"lines": ["    return node"]}, {"lines": ["template_name_replacements = {", "    ('.txt', ''),"]}, {"lines": ["}"]}, {"lines": ["def clean_template_name(template_name):"]}, {"lines": ["    template_name = from_mongo(template_name)"]}, {"lines": ["    for replacement in template_name_replacements:", "        template_name = template_name.replace(*replacement)", "    return template_name"]}, {"lines": ["from modularodm.exceptions import ValidationValueError"]}, {"lines": [""]}, {"lines": ["@collect_auth"]}, {"lines": ["    max_count = kwargs.get('max_count', 3)", "    if 'user_ids' in kwargs:"]}, {"lines": ["        users = [", "            User.load(user_id) for user_id in kwargs['user_ids']"]}, {"lines": ["            if user_id in node.visible_contributor_ids"]}, {"lines": ["        ]", "    else:"]}, {"lines": ["        users = node.visible_contributors"]}, {"lines": [""]}, {"lines": ["        raise HTTPError(http.FORBIDDEN)", "", "    contributors = []", ""]}, {"lines": ["    n_contributors = len(users)"]}, {"lines": [""]}, {"lines": ["    for index, user in enumerate(users[:max_count]):"]}, {"lines": [""]}, {"lines": ["        if index == max_count - 1 and len(users) > max_count:"]}, {"lines": ["            others_count = str(n_contributors - 3)"]}, {"lines": ["        elif index == len(users) - 1:"]}, {"lines": ["            separator = ''"]}, {"lines": ["        elif index == len(users) - 2:"]}, {"lines": ["        else:", "            separator = ','", "", "        contributors.append({"]}, {"lines": ["            'user_id': user._primary_key,"]}, {"lines": ["            'separator': separator,", "        })", "", "    return {", "        'contributors': contributors,", "        'others_count': others_count,"]}, {"lines": ["    }", ""]}, {"lines": [""]}, {"lines": ["@collect_auth"]}, {"lines": [""]}, {"lines": ["        raise HTTPError(http.FORBIDDEN)", ""]}, {"lines": ["    contribs = utils.serialize_contributors("]}, {"lines": ["        node=node,", "    )"]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["@must_be_valid_project"]}, {"lines": [""]}, {"lines": ["    parent = node.parent_node"]}, {"lines": [""]}, {"lines": ["    if not parent:", "        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": ["    if not node.can_view(auth):"]}, {"lines": ["        raise HTTPError(http.FORBIDDEN)", ""]}, {"lines": ["    contribs = ["]}, {"lines": ["        for contrib in parent.visible_contributors", "        if contrib._id not in node.visible_contributor_ids"]}, {"lines": ["    ]"]}, {"lines": ["", "    return {'contributors': contribs}"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    contribs = ["]}, {"lines": ["    ]"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_contributor"]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["", "    contributor = User.load(request.json.get('id'))"]}, {"lines": ["", "    # Forbidden unless user is removing herself", "    if not node.has_permission(auth.user, 'admin'):", "        if auth.user != contributor:", "            raise HTTPError(http.FORBIDDEN)", "", "    prompts = node.callback("]}, {"lines": ["        'before_remove_contributor', removed=contributor,", "    )"]}, {"lines": [""]}, {"lines": ["    if auth.user == contributor:", "        prompts.insert(", "            0,", "            'Are you sure you want to remove yourself from this project?'", "        )", ""]}, {"lines": ["    return {'prompts': prompts}", "", ""]}, {"lines": ["@must_be_valid_project  # returns project"]}, {"lines": ["@must_be_contributor"]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["", "    contributor = User.load(request.json['id'])", "    if contributor is None:", "        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": ["    # Forbidden unless user is removing herself", "    if not node.has_permission(auth.user, 'admin'):", "        if auth.user != contributor:", "            raise HTTPError(http.FORBIDDEN)", ""]}, {"lines": ["    outcome = node.remove_contributor(", "        contributor=contributor, auth=auth,", "    )"]}, {"lines": [""]}, {"lines": ["    if outcome:"]}, {"lines": ["        if auth.user == contributor:"]}, {"lines": ["        return {}", "", "    raise HTTPError(", "        http.BAD_REQUEST,", "        data={", "            'message_long': (", "                '{0} must have at least one contributor with admin '", "                'rights'.format(", "                    node.project_or_component.capitalize()", "                )", "            )", "        }", "    )"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        visible = contrib_dict['visible']", "        email = contrib_dict.get('email')"]}, {"lines": ["            except ValidationValueError:"]}, {"lines": ["        contribs.append({", "            'user': contributor,"]}, {"lines": ["            'visible': visible,"]}, {"lines": ["        })"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\" Add contributors to a node. \"\"\""]}, {"lines": [""]}, {"lines": ["    user_dicts = request.json.get('users')"]}, {"lines": ["    node_ids = request.json.get('node_ids')", ""]}, {"lines": ["    if user_dicts is None or node_ids is None:"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)", "", "    # Prepare input data for `Node::add_contributors`"]}, {"lines": ["    node.add_contributors(contributors=contribs, auth=auth)"]}, {"lines": ["    node.save()", ""]}, {"lines": ["    for child_id in node_ids:", "        child = Node.load(child_id)", "        # Only email unreg users once", "        child_contribs = deserialize_contributors("]}, {"lines": ["        )", "        child.add_contributors(contributors=child_contribs, auth=auth)"]}, {"lines": ["    return {'status': 'success'}, 201"]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"Reorder and remove contributors."]}, {"lines": [""]}, {"lines": ["    :param Auth auth: Consolidated authorization", "    :param-json list contributors: Ordered list of contributors represented as", "        dictionaries of the form:", "        {'id': <id>, 'permission': <One of 'read', 'write', 'admin'>}", "    :raises: HTTPError(400) if contributors to be removed are not in list", "        or if no admin users would remain after changes were applied", "", "    \"\"\""]}, {"lines": ["    contributors = request.json.get('contributors')"]}, {"lines": [""]}, {"lines": ["    # Update permissions and order"]}, {"lines": ["    try:", "        node.manage_contributors(contributors, auth=auth, save=True)", "    except ValueError as error:", "        raise HTTPError(http.BAD_REQUEST, data={'message_long': error.message})"]}, {"lines": [""]}, {"lines": ["    # If user has removed herself from project, alert; redirect to user", "    # dashboard if node is private, else node dashboard", "    if not node.is_contributor(auth.user):"]}, {"lines": ["            'You have removed yourself as a contributor from this project',", "            'info'", "        )", "        if node.is_public:", "            return {'redirectUrl': node.url}", "        return {'redirectUrl': web_url_for('dashboard')}", "    # Else if user has revoked her admin permissions, alert and stay on", "    # current page"]}, {"lines": ["            'You have removed your administrative privileges for this project',", "            'info'", "        )", "    # Else stay on current page"]}, {"lines": ["    return {}", ""]}, {"lines": [""]}, {"lines": ["    claim_url = web_url_for(", "        'claim_user_registered',", "        uid=unreg_user._primary_key,", "        pid=node._primary_key,", "        token=unclaimed_record['token'],", "        _external=True,", "    )"]}, {"lines": ["    mails.send_mail(", "        claimer.username,", "        mails.PENDING_VERIFICATION_REGISTERED,"]}, {"lines": ["        node=node,"]}, {"lines": [""]}, {"lines": ["            mails.send_mail("]}, {"lines": ["                pending_mail,"]}, {"lines": ["                node=node", "            )"]}, {"lines": ["    mails.send_mail(", "        to_addr,", "        mail_tpl,"]}, {"lines": [""]}, {"lines": ["import httplib as http", ""]}, {"lines": ["from website.project.decorators import (", "    must_be_valid_project, must_have_permission", ")"]}, {"lines": ["from ..model import ApiKey", "from .node import _view_project", "", ""]}, {"lines": ["    return {"]}, {"lines": ["            {"]}, {"lines": ["                'key': key._id,", "                'label': key.label,"]}, {"lines": ["            }"]}, {"lines": ["        ]", "    }", ""]}, {"lines": ["", "    # Generate key", "    api_key = ApiKey(label=request.form['label'])", "    api_key.save()", "", "    # Append to node"]}, {"lines": ["", "    # Return response"]}, {"lines": ["    return {'response': 'success'}, http.CREATED"]}, {"lines": [""]}, {"lines": ["", "    # Load key", "    api_key = ApiKey.load(request.form['key'])", "", "    # Remove from user"]}, {"lines": ["", "    # Send response"]}, {"lines": ["    return {'response': 'success'}"]}, {"lines": [""]}, {"lines": ["", "    api_key = ApiKey.load(kwargs['kid'])"]}, {"lines": ["", "    rv = {"]}, {"lines": ["        'key': api_key._id,", "        'label': api_key.label,", "        'route': '/settings',", "        'logs': ["]}, {"lines": ["            {"]}, {"lines": ["                'lid': log._id,", "                'nid': log.node__logged[0]._id,", "                'route': log.node__logged[0].url,"]}, {"lines": ["            }", "            for log in api_key.nodelog__created", "        ]", "    }", ""]}, {"lines": ["    return rv"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from framework.auth.decorators import must_be_logged_in, collect_auth"]}, {"lines": [""]}, {"lines": ["from website import language"]}, {"lines": ["from website.project.decorators import ("]}, {"lines": [")"]}, {"lines": ["from website import settings"]}, {"lines": ["from website.profile import utils"]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    if edited_field == 'title':"]}, {"lines": ["    elif edited_field == 'description':", "        node.set_description(value, auth=auth)", "    node.save()"]}, {"lines": ["    return {'status': 'success'}"]}, {"lines": [""]}, {"lines": ["", "##############################################################################", "# New Project", "##############################################################################", ""]}, {"lines": [""]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["def project_new(**kwargs):"]}, {"lines": ["    return {}", "", "@must_be_logged_in"]}, {"lines": ["    else:"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["##############################################################################", "# New Node", "##############################################################################", ""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    form = NewNodeForm(request.form)"]}, {"lines": ["    if form.validate():"]}, {"lines": ["        return {"]}, {"lines": ["            'status': 'success',"]}, {"lines": ["        }, 201, None, node.url"]}, {"lines": ["    else:"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_logged_in"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    if node.has_pointers_recursive:"]}, {"lines": ["        prompts.append("]}, {"lines": ["            language.BEFORE_FORK_HAS_POINTERS.format("]}, {"lines": ["                category=node.project_or_component", "            )", "        )", ""]}, {"lines": ["    return {'prompts': prompts}", "", ""]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["    return fork.url"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project"]}, {"lines": [""]}, {"lines": ["", "@must_be_valid_project"]}, {"lines": [""]}, {"lines": ["", "@must_be_valid_project"]}, {"lines": [""]}, {"lines": ["    ret = _view_project(node, auth, primary=True)"]}, {"lines": [""]}, {"lines": ["    addons_enabled = []"]}, {"lines": ["    addon_enabled_settings = []", ""]}, {"lines": ["    for addon in node.get_addons():"]}, {"lines": ["        addons_enabled.append(addon.config.short_name)"]}, {"lines": ["        if 'node' in addon.config.configs:"]}, {"lines": [""]}, {"lines": ["    ret['addon_categories'] = settings.ADDON_CATEGORIES"]}, {"lines": ["        addon", "        for addon in settings.ADDONS_AVAILABLE", "        if 'node' in addon.owners"]}, {"lines": ["    ret['addons_enabled'] = addons_enabled", "    ret['addon_enabled_settings'] = addon_enabled_settings", "    ret['addon_capabilities'] = settings.ADDON_CAPABILITIES"]}, {"lines": [""]}, {"lines": ["    ret['addon_js'] = collect_node_config_js(node.get_addons())"]}, {"lines": ["    ret['comments'] = {"]}, {"lines": ["        'level': node.comment_level,", "    }", ""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    node.config_addons(request.json, auth)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["    ret = _view_project(node, auth, primary=True)", "    ret['contributors'] = utils.serialize_contributors(node.contributors, node)", "    ret['adminContributors'] = utils.serialize_contributors(node.admin_contributors, node, admin=True)", "    return ret"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    comment_level = request.json.get('commentLevel')"]}, {"lines": ["    if not comment_level:", "        node.comment_level = None", "    elif comment_level in ['public', 'private']:", "        node.comment_level = comment_level", "    else:", "        raise HTTPError(http.BAD_REQUEST)", "    node.save()", "", ""]}, {"lines": ["##############################################################################", "# View Project", "##############################################################################", ""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project", "@must_not_be_registration"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    new_list = ["]}, {"lines": ["    ]", "    nodes_new = [", "        StoredObject.get_collection(schema).load(key)", "        for key, schema in new_list", "    ]"]}, {"lines": [""]}, {"lines": ["    ]", "    deleted_nodes = ["]}, {"lines": ["    ]"]}, {"lines": ["        return {}"]}, {"lines": [""]}, {"lines": ["    logger.error('Got invalid node list in reorder components')"]}, {"lines": ["    raise HTTPError(http.BAD_REQUEST)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["##############################################################################", ""]}, {"lines": [""]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["    return _view_project(node, auth, primary=True)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["###############################################################################"]}, {"lines": ["###############################################################################", "", ""]}, {"lines": ["@must_be_valid_project"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    return {", "        'status': 'success',", "        'permissions': permissions,"]}, {"lines": [""]}, {"lines": ["    watch_config = WatchConfig(node=node,"]}, {"lines": ["                               digest=request.json.get('digest', False),"]}, {"lines": ["                               immediate=request.json.get('immediate', False))"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    return {", "        'status': 'success',"]}, {"lines": ["        'watchCount': len(node.watchconfig__watched)"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    watch_config = WatchConfig(node=node,", "                               digest=request.json.get('digest', False),", "                               immediate=request.json.get('immediate', False))"]}, {"lines": ["        user.unwatch(watch_config)"]}, {"lines": ["    return {", "        'status': 'success',"]}, {"lines": ["        'watchCount': len(node.watchconfig__watched)"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["    watch_config = WatchConfig(", "        node=node,", "        digest=request.json.get('digest', False),", "        immediate=request.json.get('immediate', False)", "    )"]}, {"lines": ["    return {", "        'status': 'success',", "        'watchCount': len(node.watchconfig__watched),", "        'watched': user.is_watching(node)", "    }"]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"Remove component, and recursively remove its children. If node has a", "    parent, add log and redirect to parent; else redirect to user dashboard."]}, {"lines": [""]}, {"lines": ["    \"\"\""]}, {"lines": ["        )"]}, {"lines": ["    )"]}, {"lines": ["# TODO: Split into separate functions"]}, {"lines": ["", "    widgets = {}"]}, {"lines": ["    configs = {}"]}, {"lines": ["    js = []", "    css = []", ""]}, {"lines": ["    for addon in node.get_addons():"]}, {"lines": ["        configs[addon.config.short_name] = addon.config.to_json()"]}, {"lines": ["        js.extend(addon.config.include_js.get('widget', []))", "        css.extend(addon.config.include_css.get('widget', []))"]}, {"lines": [""]}, {"lines": ["        js.extend(addon.config.include_js.get('files', []))", "        css.extend(addon.config.include_css.get('files', []))"]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": ["def _view_project(node, auth, primary=False):"]}, {"lines": ["    \"\"\"Build a JSON object containing everything needed to render"]}, {"lines": ["    project.view.mako."]}, {"lines": ["    \"\"\""]}, {"lines": ["    user = auth.user", ""]}, {"lines": ["    parent = node.parent_node"]}, {"lines": ["    # Before page load callback; skip if not primary call", "    if primary:"]}, {"lines": ["        for addon in node.get_addons():"]}, {"lines": ["            messages = addon.before_page_load(node, user) or []", "            for message in messages:"]}, {"lines": ["        'node': {"]}, {"lines": ["            'id': node._primary_key,", "            'title': node.title,"]}, {"lines": ["            'url': node.url,", "            'api_url': node.api_url,", "            'absolute_url': node.absolute_url,"]}, {"lines": ["            'display_absolute_url': node.display_absolute_url,"]}, {"lines": ["            'is_public': node.is_public,"]}, {"lines": ["            'tags': [tag._primary_key for tag in node.tags],", "            'children': bool(node.nodes),"]}, {"lines": ["            'is_registration': node.is_registration,"]}, {"lines": ["            'registered_from_url': node.registered_from.url if node.is_registration else '',"]}, {"lines": ["                    'name_no_ext': from_mongo(meta),"]}, {"lines": ["                for meta in node.registered_meta or []"]}, {"lines": ["            'is_fork': node.is_fork,", "            'forked_from_id': node.forked_from._primary_key if node.is_fork else '',", "            'forked_from_display_absolute_url': node.forked_from.display_absolute_url if node.is_fork else '',"]}, {"lines": ["            'watched_count': len(node.watchconfig__watched),"]}, {"lines": ["            'piwik_site_id': node.piwik_site_id,"]}, {"lines": ["            'comment_level': node.comment_level,"]}, {"lines": ["            'has_comments': bool(getattr(node, 'commented', [])),"]}, {"lines": ["            'has_children': bool(getattr(node, 'commented', False)),"]}, {"lines": ["            'identifiers': {", "                'doi': node.get_identifier_value('doi'),", "                'ark': node.get_identifier_value('ark'),", "            },"]}, {"lines": ["        'user': {"]}, {"lines": ["            'is_contributor': node.is_contributor(user),"]}, {"lines": ["            'can_edit': (node.can_edit(auth)"]}, {"lines": ["            'permissions': node.get_permissions(user) if user else [],"]}, {"lines": ["            'is_watching': user.is_watching(node) if user else False,"]}, {"lines": ["            'piwik_token': user.piwik_token if user else '',"]}, {"lines": ["            'id': user._id if user else None,"]}, {"lines": ["            'can_comment': node.can_comment(auth),"]}, {"lines": ["        },"]}, {"lines": ["        # TODO: Namespace with nested dicts"]}, {"lines": ["        'addons': configs,"]}, {"lines": ["        'addon_widgets': widgets,"]}, {"lines": ["        'addon_widget_js': js,", "        'addon_widget_css': css,"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def _get_children(node, auth, indent=0):"]}, {"lines": ["", "    children = []", ""]}, {"lines": ["    for child in node.nodes_primary:", "        if not child.is_deleted and child.can_edit(auth):"]}, {"lines": ["            children.append({", "                'id': child._primary_key,", "                'title': child.title,", "                'indent': indent,"]}, {"lines": ["            })"]}, {"lines": ["", "    return children", ""]}, {"lines": [""]}, {"lines": ["@collect_auth"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["        return"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    }"]}, {"lines": ["", ""]}, {"lines": ["def _get_user_activity(node, auth, rescale_ratio):"]}, {"lines": ["", "    # Counters", "    total_count = len(node.logs)", "", "    # Note: It's typically much faster to find logs of a given node", "    # attached to a given user using node.logs.find(...) than by", "    # loading the logs into Python and checking each one. However,", "    # using deep caching might be even faster down the road.", ""]}, {"lines": ["    if auth.user:", "        ua_count = node.logs.find(Q('user', 'eq', auth.user)).count()"]}, {"lines": ["    else:", "        ua_count = 0", ""]}, {"lines": ["", "    # Normalize over all nodes"]}, {"lines": ["    return ua_count, ua, non_ua"]}, {"lines": [""]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["    return {'logs': logs}"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    if node.can_view(auth):", "        summary.update({"]}, {"lines": ["            'can_view': True,"]}, {"lines": ["            'can_edit': node.can_edit(auth),"]}, {"lines": ["            'primary_id': node._id,", "            'url': node.url,", "            'primary': primary,", "            'api_url': node.api_url,", "            'title': node.title,"]}, {"lines": ["            'is_registration': node.is_registration,"]}, {"lines": ["            'nlogs': None,", "            'ua_count': None,", "            'ua': None,", "            'non_ua': None,"]}, {"lines": ["            'addons_enabled': node.get_addon_names(),"]}, {"lines": ["        })"]}, {"lines": ["        if rescale_ratio:"]}, {"lines": ["            ua_count, ua, non_ua = _get_user_activity(node, auth, rescale_ratio)"]}, {"lines": ["            summary.update({"]}, {"lines": ["                'nlogs': len(node.logs),"]}, {"lines": ["                'ua_count': ua_count,", "                'ua': ua,", "                'non_ua': non_ua,", "            })", "    else:"]}, {"lines": ["        summary['can_view'] = False", ""]}, {"lines": ["    return {"]}, {"lines": ["        'summary': summary,"]}, {"lines": ["    }", ""]}, {"lines": ["", "@collect_auth"]}, {"lines": ["    rescale_ratio = kwargs.get('rescale_ratio')"]}, {"lines": ["    primary = kwargs.get('primary')", "    link_id = kwargs.get('link_id')"]}, {"lines": ["", "    return _get_summary("]}, {"lines": ["    )", "", ""]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["", ""]}, {"lines": ["def _serialize_node_search(node):", "    \"\"\"Serialize a node for use in pointer search.", "", "    :param Node node: Node to serialize", "    :return: Dictionary of node data", "", "    \"\"\""]}, {"lines": ["    title = node.title", "    if node.is_registration:", "        title += ' (registration)'"]}, {"lines": ["    return {", "        'id': node._id,"]}, {"lines": ["        'title': title,"]}, {"lines": ["    }", "", "", "@must_be_logged_in"]}, {"lines": ["    \"\"\"", "", "    \"\"\"", "    # Get arguments"]}, {"lines": ["    node = Node.load(request.json.get('nodeId'))", "    include_public = request.json.get('includePublic')"]}, {"lines": ["    query = request.json.get('query', '').strip()"]}, {"lines": ["    if not query:", "        return {'nodes': []}", "", "    # Build ODM query", "    title_query = Q('title', 'icontains', query)"]}, {"lines": ["    not_deleted_query = Q('is_deleted', 'eq', False)"]}, {"lines": ["    visibility_query = Q('contributors', 'eq', auth.user)"]}, {"lines": ["    if include_public:", "        visibility_query = visibility_query | Q('is_public', 'eq', True)"]}, {"lines": ["", "    # Exclude current node from query if provided", "    if node:", "        nin = [node._id] + node.node_ids", "        odm_query = (", "            odm_query &", "            Q('_id', 'nin', nin)", "        )", ""]}, {"lines": ["", "    return {", "        'nodes': [", "            _serialize_node_search(each)"]}, {"lines": ["            if each.contributors"]}, {"lines": ["    }", "", "", "def _add_pointers(node, pointers, auth):", "    \"\"\"", "", "    :param Node node: Node to which pointers will be added", "    :param list pointers: Nodes to add as pointers", "", "    \"\"\"", "    added = False", "    for pointer in pointers:", "        node.add_pointer(pointer, auth, save=False)", "        added = True", "", "    if added:", "        node.save()", ""]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"Add pointers to a node.", "", "    \"\"\""]}, {"lines": ["    node_ids = request.json.get('nodeIds')", "", "    if not node_ids:", "        raise HTTPError(http.BAD_REQUEST)", "", "    nodes = [", "        Node.load(node_id)", "        for node_id in node_ids", "    ]", ""]}, {"lines": ["", "    return {}", "", ""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"Remove a pointer from a node, raising a 400 if the pointer is not", "    in `node.nodes`.", "", "    \"\"\""]}, {"lines": ["    pointer_id = request.json.get('pointerId')", "    if pointer_id is None:", "        raise HTTPError(http.BAD_REQUEST)", "", "    pointer = Pointer.load(pointer_id)", "    if pointer is None:", "        raise HTTPError(http.BAD_REQUEST)", "", "    try:"]}, {"lines": ["    except ValueError:", "        raise HTTPError(http.BAD_REQUEST)", "", "    node.save()", ""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["    \"\"\"Fork a pointer. Raises BAD_REQUEST if pointer not provided, not found,", "    or not present in `nodes`.", "", "    \"\"\""]}, {"lines": ["    pointer_id = request.json.get('pointerId')", "    pointer = Pointer.load(pointer_id)", "", "    if pointer is None:"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)", "", "    try:", "        node.fork_pointer(pointer, auth=auth, save=True)", "    except ValueError:", "        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": [""]}, {"lines": ["def abbrev_authors(node):"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    return {'pointed': ["]}, {"lines": ["        for each in node.pointed"]}, {"lines": ["    ]}"]}, {"lines": ["import httplib as http", ""]}, {"lines": ["from modularodm.exceptions import ValidationError", ""]}, {"lines": ["from website.project.model import Tag", "from website.project.decorators import (", "    must_be_valid_project, must_have_permission, must_not_be_registration", ")"]}, {"lines": ["", ""]}, {"lines": ["def project_tag(tag, auth, **kwargs):"]}, {"lines": ["    return {"]}, {"lines": ["            {"]}, {"lines": ["                'title': node.title,", "                'url': node.url,"]}, {"lines": ["            }"]}, {"lines": ["        'tag': tag,"]}, {"lines": ["    }", "", ""]}, {"lines": ["@must_have_permission('write')"]}, {"lines": ["@must_not_be_registration"]}, {"lines": [""]}, {"lines": ["    if tag:", "        try:", "            node.add_tag(tag=tag, auth=auth)", "            return {'status': 'success'}, http.CREATED", "        except ValidationError:", "            return {'status': 'error'}, http.BAD_REQUEST"]}, {"lines": ["", ""]}, {"lines": ["@must_have_permission('write')"]}, {"lines": ["@must_not_be_registration"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        node.remove_tag(tag=tag, auth=auth)"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": [""]}, {"lines": ["def search_projects_by_title(**kwargs):"]}, {"lines": [""]}, {"lines": ["        authors_html = ''"]}, {"lines": ["            authors_html += '<a href=\"%s\">%s</a>' % (a.url, a.fullname)", "            authors_html += author['separator'] + ' '", "        authors_html += ' ' + authors['others_count']"]}, {"lines": ["            'authors': authors_html,"]}, {"lines": ["    query = bleach.clean(request.args.get('query', ''), tags=[], strip=True)"]}, {"lines": [""]}, {"lines": ["    ctx = app.test_request_context()", "    ctx.push()"]}, {"lines": [""]}, {"lines": ["\"\"\"", "Base settings file, common to all environments."]}, {"lines": ["\"\"\"", ""]}, {"lines": [""]}, {"lines": ["ADDON_PATH = os.path.join(BASE_PATH, 'addons')"]}, {"lines": ["CITATION_STYLES_PATH = os.path.join(BASE_PATH, 'static', 'vendor', 'bower_components', 'styles')"]}, {"lines": ["TEMPLATES_PATH = os.path.join(BASE_PATH, 'templates')"]}, {"lines": ["DOMAIN = 'http://localhost:5000/'"]}, {"lines": ["ELASTIC_TIMEOUT = 10"]}, {"lines": ["# TODO: Override SECRET_KEY in local.py in production"]}, {"lines": ["SECRET_KEY = 'CHANGEME'"]}, {"lines": ["# Change if using `scripts/cron.py` to manage crontab", "CRON_USER = None", ""]}, {"lines": ["USE_EMAIL = True"]}, {"lines": [""]}, {"lines": ["# TODO: Override in local.py", "MAILGUN_API_KEY = None", ""]}, {"lines": ["# TODO: Override in local.py in production"]}, {"lines": ["UPLOADS_PATH = os.path.join(BASE_PATH, 'uploads')"]}, {"lines": ["MFR_CACHE_PATH = os.path.join(BASE_PATH, 'mfrcache')"]}, {"lines": ["# Use Celery for file rendering"]}, {"lines": [""]}, {"lines": ["# File rendering timeout (in ms)", "MFR_TIMEOUT = 30000"]}, {"lines": ["# TODO: Override in local.py in production"]}, {"lines": ["DB_NAME = 'osf20130903'", "DB_USER = None", "DB_PASS = None"]}, {"lines": ["# Cache settings", "SESSION_HISTORY_LENGTH = 5", "SESSION_HISTORY_IGNORE_RULES = [", "    lambda url: '/static/' in url,", "    lambda url: 'favicon' in url,"]}, {"lines": ["]", ""]}, {"lines": ["# TODO: Configuration should not change between deploys - this should be dynamic."]}, {"lines": ["# TODO: Combine Python and JavaScript config", "COMMENT_MAXLENGTH = 500", ""]}, {"lines": ["GRAVATAR_SIZE_ADD_CONTRIBUTOR = 40"]}, {"lines": ["GRAVATAR_SIZE_DISCUSSION = 20"]}, {"lines": [""]}, {"lines": ["# Conference options", "CONFERNCE_MIN_COUNT = 5", ""]}, {"lines": ["        'salign', 'align', 'wmode', 'target',"]}, {"lines": ["    ],", "    # Styles currently used in Reproducibility Project wiki pages"]}, {"lines": ["    'styles' : ["]}, {"lines": ["        'top', 'left', 'width', 'height', 'position',", "        'background', 'font-size', 'text-align', 'z-index',", "        'list-style',"]}, {"lines": [""]}, {"lines": ["# Add-ons"]}, {"lines": [""]}, {"lines": ["ADDON_CATEGORIES = ["]}, {"lines": ["]"]}, {"lines": [""]}, {"lines": ["    # 'user': ['badges'],"]}, {"lines": ["    'user': [],"]}, {"lines": ["    'node': [],"]}, {"lines": ["# Piwik", ""]}, {"lines": ["", "", "# TODO: Delete me after merging GitLab", "MISSING_FILE_NAME = 'untitled'"]}, {"lines": ["# Test identifier namespaces", "DOI_NAMESPACE = 'doi:10.5072/FK2'"]}, {"lines": ["ARK_NAMESPACE = 'ark:99999/fk4'"]}, {"lines": ["", "EZID_USERNAME = 'changeme'", "EZID_PASSWORD = 'changeme'"]}, {"lines": ["# -*- coding: utf-8 -*-", "'''Example settings/local.py file.", "These settings override what's in website/settings/defaults.py", "", "NOTE: local.py will not be added to source control.", "'''", "", "from . import defaults", ""]}, {"lines": ["DB_PORT = 27017", ""]}, {"lines": ["DEV_MODE = True", "DEBUG_MODE = True  # Sets app to debug mode, turns off template caching, etc.", ""]}, {"lines": ["USE_EMAIL = False"]}, {"lines": ["USE_CELERY = False"]}, {"lines": [""]}, {"lines": ["# Email", "MAIL_SERVER = 'localhost:1025'  # For local testing", "MAIL_USERNAME = 'osf-smtp'", "MAIL_PASSWORD = 'CHANGEME'", "", "# Session", "COOKIE_NAME = 'osf'", "SECRET_KEY = \"CHANGEME\"", "", "##### Celery #####", "## Default RabbitMQ broker", "BROKER_URL = 'amqp://'", "", "# Default RabbitMQ backend", "CELERY_RESULT_BACKEND = 'amqp://'", "", "USE_CDN_FOR_CLIENT_LIBS = False"]}, {"lines": ["var $osf = require('js/osfHelpers');", ""]}, {"lines": ["var $osf = require('./osfHelpers');"]}, {"lines": ["var AddonHelper = (function() {", "", "    /**", "     * Convert an HTML form to a JS object.", "     *", "     * @param {jQuery} form", "     * @return {Object} The parsed data", "     */", "    function formToObj(form) {", "        var rv = {};", "        $.each($(form).serializeArray(), function(_, value) {", "            rv[value.name] = value.value;", "        });", "        return rv;", "    }", "", "    /**", "     * Submit add-on settings.", "     */", "    function onSubmitSettings() {"]}, {"lines": ["        var $this = $(this);", "        var addon = $this.attr('data-addon');", "        var owner = $this.find('span[data-owner]').attr('data-owner');", "        var msgElm = $this.find('.addon-settings-message');", ""]}, {"lines": [""]}, {"lines": ["            msgElm.text('Settings updated')", "                .removeClass('text-danger').addClass('text-success')", "                .fadeOut(100).fadeIn();"]}, {"lines": ["            }"]}, {"lines": ["        });", "", "        return false;", "", "    }", "", "    // Expose public methods"]}, {"lines": ["        formToObj: formToObj,", "        onSubmitSettings: onSubmitSettings,"]}, {"lines": [""]}, {"lines": ["})();"]}, {"lines": ["'use strict';", "", "var $ = require('jquery');", "var ko = require('knockout');"]}, {"lines": ["var $osf = require('./osfHelpers');", "var citations = require('./citations');"]}, {"lines": ["", "var BASE_URL = '/static/vendor/bower_components/styles/';", "var STYLES = {", "    apa: 'apa.csl',", "    mla: 'modern-language-association.csl',", "    chicago: 'chicago-author-date.csl'", "};", "", "var ctx = window.contextVars;", "", "var formatCitation = function(style, data, format) {", "    var citeproc = citations.makeCiteproc(style, data, format);", "    return citeproc.makeBibliography()[1];", "};", "", "var ViewModel = function() {", "    this.apa = ko.observable();", "    this.mla = ko.observable();", "    this.chicago = ko.observable();", "};", "", "ViewModel.prototype.fetch = function() {", "    var self = this;", "    var citationRequest = $.ajax(ctx.node.urls.api + 'citation/');", "    var styleRequests = [", "        $.ajax(BASE_URL + STYLES.apa),", "        $.ajax(BASE_URL + STYLES.mla),", "        $.ajax(BASE_URL + STYLES.chicago)", "    ];", "    var requests = [citationRequest].concat(styleRequests);", "    $.when.apply(self, requests).done(function(data, apa, mla, chicago) {", "        self.apa(formatCitation(apa[0], data[0], 'text'));", "        self.mla(formatCitation(mla[0], data[0], 'text'));", "        self.chicago(formatCitation(chicago[0], data[0], 'text'));", "    }).fail(function() {", "        console.log('Could not load citations');", "    });", "};", "", "var CitationList = function(selector) {", "    this.viewModel = new ViewModel();", "    $osf.applyBindings(this.viewModel, selector);", "    this.viewModel.fetch();", "};", "", "module.exports = CitationList;"]}, {"lines": ["'use strict';", ""]}, {"lines": ["'use strict';", "", "var $ = require('jquery');", "var ZeroClipboard = require('zeroclipboard');", "", "ZeroClipboard.config({", "    swfPath: '/static/vendor/bower_components/zeroclipboard/dist/ZeroClipboard.swf'", "});", "", "var makeClient = function(elm) {", "    var $elm = $(elm);", "    var client = new ZeroClipboard(elm);", "", "    $elm.on('mouseover', function() {", "        $elm.addClass('active');", "    });", "    $elm.on('mouseout', function() {", "        $elm.removeClass('active');", "    });", "", "    client.on('aftercopy', function() {", "        $elm.blur();", "        $elm.tooltip('hide');", "    });", "", "    return client;", "};", "", "module.exports = makeClient;"]}, {"lines": ["(function(window, document, $) {", "", "    'use strict';", "", "    var defaults = {", "        animateTime: 100,", "        minViewWidth: 150,", "        toggleWidth: 1/3,"]}, {"lines": ["    };", "", "    var CommentPane = CommentPane || function(selector, options) {"]}, {"lines": ["", "        var $pane = $(selector);", "        var $handle = $pane.find('.cp-handle');", "        var $sidebar = $pane.find('.cp-sidebar');", "        var $bar = $pane.find('.cp-bar');", "        var $toggleElm = $.merge($pane, $sidebar);", "", "        options = $.extend({}, defaults, options);", "        if (options.maxWidthProp < options.toggleWidth) {", "            throw(", "                'Option `toggleWidth` must be greater than or equal to ' +", "                'option `maxWidthProp`.'", "            );", "        }", "", "        var makeAllElementsUnselectable = function(){", "            $(document).children().each(function (index, elm) {", "                $(elm).addClass('unselectable');", "            });", "        };", "", "        var makeAllElementsSelectable = function(){", "            $(document).children().each(function (index, elm) {", "                $(elm).removeClass('unselectable');", "            });", "        };", ""]}, {"lines": ["        var getMaxWidth = function() {", "            return $(document.body).width() * options.maxWidthProp;"]}, {"lines": ["        };", "", "        var toggle = function() {", "            var width;", "            if ($pane.width()) {", "                width = 0;"]}, {"lines": ["            } else {", "                var bodyWidth = $(document.body).width();", "                width = options.toggleWidth * bodyWidth;"]}, {"lines": ["            }", "            $toggleElm.animate(", "                {width: width},", "                options.animateTime", "            );", "        };", "", "        var init = function(){"]}, {"lines": ["            // Bind drag & drop handlers"]}, {"lines": ["            $bar.on('mousedown', function() {", "                makeAllElementsUnselectable();", "                $(document).on('mousemove', function(event) {", "                    var bodyWidth = $(document.body).width();", "                    var dragWidth = document.body.clientWidth - event.pageX;"]}, {"lines": ["                    var width = Math.min(dragWidth, getMaxWidth()) + 'px';"]}, {"lines": ["                    $pane.css('width', width);", "                    $('.cp-sidebar').css('width', width);", "                });", "                $(document).on('mouseup', function(){", "                    $(document).off('mousemove');", "                    $(document).off('mouseup');", "                    makeAllElementsSelectable();", "                    if ($pane.width() < options.minViewWidth) {", "                        $pane.animate(", "                            {width: '0'}, options.animateTime", "                        );", "                    }"]}, {"lines": ["            });", ""]}, {"lines": ["            // Bind toggle handler", "            $handle.on('click', toggle);"]}, {"lines": [""]}, {"lines": ["            // Prevent comment pane from getting too big on resize", "            $(window).on('resize', function() {", "                var maxWidth = getMaxWidth();", "                if ($pane.width() > maxWidth) {", "                    $toggleElm.width(maxWidth.toString() + 'px');", "                }"]}, {"lines": ["            });", ""]}, {"lines": ["        };"]}, {"lines": ["        init();"]}, {"lines": ["    };", "", "    if ((typeof module !== 'undefined') && module.exports) {"]}, {"lines": ["        module.exports = CommentPane;", "    }", "    if (typeof ender === 'undefined') {", "        this.CommentPane = CommentPane;", "    }"]}, {"lines": ["            return CommentPane;", "        });", "    }", "", "}).call(this, window, document, $);"]}, {"lines": ["'use strict';", ""]}, {"lines": ["", "var oop = require('./oop');", "var $osf = require('./osfHelpers');", "var Paginator = require('./paginator');"]}, {"lines": [""]}, {"lines": ["                }"]}, {"lines": ["            });"]}, {"lines": ["            $('.modal').modal('hide');"]}, {"lines": ["", "// Hack: Disable xhook if not using MSIE"]}, {"lines": ["    xhook.disable();", "}"]}, {"lines": ["'use strict';"]}, {"lines": ["var Treebeard = require('treebeard');"]}, {"lines": ["var EXTENSIONS = ['3gp', '7z', 'ace', 'ai', 'aif', 'aiff', 'amr', 'asf', 'asx', 'bat', 'bin', 'bmp', 'bup',", "    'cab', 'cbr', 'cda', 'cdl', 'cdr', 'chm', 'dat', 'divx', 'dll', 'dmg', 'doc', 'docx', 'dss', 'dvf', 'dwg',", "    'eml', 'eps', 'exe', 'fla', 'flv', 'gif', 'gz', 'hqx', 'htm', 'html', 'ifo', 'indd', 'iso', 'jar',"]}, {"lines": ["    'mpeg', 'mpg', 'msi', 'mswmm', 'ogg', 'pdf', 'png', 'pps', 'ps', 'psd', 'pst', 'ptb', 'pub', 'qbb',", "    'qbw', 'qxd', 'ram', 'rar', 'rm', 'rmvb', 'rtf', 'sea', 'ses', 'sit', 'sitx', 'ss', 'swf', 'tgz', 'thm',", "    'tif', 'tmp', 'torrent', 'ttf', 'txt', 'vcd', 'vob', 'wav', 'wma', 'wmv', 'wps', 'xls', 'xpi', 'zip',", "    'xlsx', 'py'];", "", "var EXTENSION_MAP = {};", "EXTENSIONS.forEach(function(extension) {", "    EXTENSION_MAP[extension] = extension;", "});", "$.extend(EXTENSION_MAP, {", "    gdoc: 'docx',", "    gsheet: 'xlsx'", "});"]}, {"lines": ["var ICON_PATH = '/static/img/hgrid/fatcowicons/';", ""]}, {"lines": ["    var extension = name.split('.').pop().toLowerCase();", "    var icon = EXTENSION_MAP[extension];", "    if (icon) {"]}, {"lines": ["    }"]}, {"lines": ["};", ""]}, {"lines": ["        configOption = item.data.provider ? resolveconfigOption.call(this, item, 'folderIcon', [item]) : undefined,  // jshint ignore:line"]}, {"lines": ["        icon;"]}, {"lines": ["    var self = this,  // jshint ignore:line"]}, {"lines": ["    var configOption = resolveconfigOption.call(this, item, 'uploadUrl', [item, file]); // jshint ignore:line"]}, {"lines": ["    if (!_fangornCanDrop(treebeard, item)) {"]}, {"lines": ["        return;", "    }"]}, {"lines": ["    var blankItem = {       // create a blank item that will refill when upload is finished."]}, {"lines": ["function _fangornCanDrop(treebeard, item) {", "    var canDrop = resolveconfigOption.call(treebeard, item, 'canDrop', [item]);", "    if (canDrop === null) {", "        canDrop = item.data.provider && item.kind === 'folder' && item.data.permissions.edit;", "    }", "    return canDrop;", "}", ""]}, {"lines": ["        if (_fangornCanDrop(treebeard, item)) {"]}, {"lines": ["    for (var i = 0; i < parent.children.length; i++) {"]}, {"lines": ["        if (!child.data.tmpID){"]}, {"lines": ["        if (child.data.tmpID === file.tmpID) {"]}, {"lines": ["    if (item.data.tmpID) {"]}, {"lines": ["    // Remove duplicates if file was updated", "    var status = file.xhr.status;", "    if (status === 200) {", "        parent.children.forEach(function(child) {", "            if (child.data.name === item.data.name && child.id !== item.id) {", "                child.removeSelf();"]}, {"lines": ["        });"]}, {"lines": ["    for (var i = 0; i < parent.children.length; i++) {"]}, {"lines": ["        if (!child.data.tmpID) {"]}, {"lines": ["        if (child.data.tmpID === file.tmpID) {"]}, {"lines": ["    var self = this;  // jshint ignore:line"]}, {"lines": ["    self.dropzoneItemCache = item;", "    self.dropzone.hiddenFileInput.click();", "    if (!item.open) {", "        self.updateFolder(null, item);"]}, {"lines": ["    function cancelDelete() {"]}, {"lines": ["        var url = resolveconfigOption.call(this, item, 'resolveDeleteUrl', [item]);"]}, {"lines": ["        url = url || waterbutler.buildTreeBeardDelete(item);"]}, {"lines": ["            url: url,"]}, {"lines": ["/**"]}, {"lines": ["    var default_columns = [];", "    var configOption;", "    item.css = '';"]}, {"lines": ["    if (item.parentID) {", "        item.data.permissions = item.data.permissions || item.parent().data.permissions;", "        if (item.data.kind === 'folder') {", "            item.data.accept = item.data.accept || item.parent().data.accept;", "        }"]}, {"lines": ["        var size;", "        var maxSize;", "        var displaySize;", "        var msgText;"]}, {"lines": ["        if (_fangornCanDrop(treebeard, item)) {"]}, {"lines": ["            if (item.data.accept && item.data.accept.maxSize) {", "                size = file.size / 1000000;", "                maxSize = item.data.accept.maxSize;", "                if (size > maxSize) {", "                    displaySize = Math.round(file.size / 10000) / 100;", "                    msgText = 'One of the files is too large (' + displaySize + ' MB). Max file size is ' + item.data.accept.maxSize + ' MB.';", "                    item.notify.update(msgText, 'warning', undefined, 3000);", "                    return false;"]}, {"lines": ["            return true;"]}, {"lines": ["'use strict';"]}, {"lines": ["var m = require('mithril');", "var Treebeard = require('treebeard');"]}, {"lines": [""]}, {"lines": ["}"]}, {"lines": ["}"]}, {"lines": ["// Returns custom icons for OSF"]}, {"lines": ["}"]}, {"lines": ["var INPUT_NAME = '-folder-select';"]}, {"lines": ["}"]}, {"lines": ["/**"]}, {"lines": ["    };", "    var templateChecked = m('input', {"]}, {"lines": ["        name: '#' + tb.options.divID + INPUT_NAME,"]}, {"lines": ["        type: 'radio',"]}, {"lines": [""]}, {"lines": ["        return templateChecked;"]}, {"lines": ["    return templateUnchecked;", "}", ""]}, {"lines": ["}", ""]}, {"lines": ["    // this = treebeard;", "    item.css = '';"]}, {"lines": ["}", ""]}, {"lines": ["    tb.options.folderPickerOnload();", "}"]}, {"lines": ["    for (var i = 0; i < item.children.length; i++) {"]}, {"lines": ["            return;", "        }", "        if (item.children[i].data.name === tb.options.folderArray[tb.options.folderIndex]) {", "            tb.updateFolder(null, item.children[i]);", "            tb.options.folderIndex++;", "            return;"]}, {"lines": ["}", ""]}, {"lines": ["// Default Treebeard options", "var defaults = {"]}, {"lines": ["    // Disable uploads", "    uploads: false,", "    showFilter : false,", "    resizeColumns : false,"]}, {"lines": ["};", "", "function FolderPicker(selector, opts) {", "    var self = this;", "    self.selector = selector;", "    self.checkedRowId = null;", "    // Custom Treebeard action to select a folder that uses the passed in", "    // \"onChooseFolder\" callback", "    if (!opts.onPickFolder) {"]}, {"lines": ["    }", "    self.options = $.extend({}, defaults, opts);", "    self.options.divID = selector.substring(1);", "    self.options.initialFolderName = opts.initialFolderName;"]}, {"lines": ["", "    // Start up the grid", "    self.grid = new Treebeard(self.options).tbController;"]}, {"lines": ["}", ""]}, {"lines": ["// Augment jQuery", "$.fn.folderpicker = function(options) {"]}, {"lines": ["    this.each(function() {", "        // Treebeard must take an ID as a selector if using as a jQuery plugin"]}, {"lines": ["        var selector = '#' + this.id;"]}, {"lines": ["    });", "};"]}, {"lines": ["require('knockout.validation');"]}, {"lines": ["require('knockout.validation');"]}, {"lines": ["                    }", "                }"]}, {"lines": ["        });"]}, {"lines": ["    };"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                return true;", "            }"]}, {"lines": ["        },"]}, {"lines": ["    };"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["/**"]}, {"lines": [" * website/templates/metadata/metadata_*.mako", " */"]}, {"lines": [""]}, {"lines": ["var MetaData = (function() {", "", "    var SEPARATOR = '-';", "    var IDX_SEPARATOR = ':';", "    var TPL_REGEX = /{{(.*?)}}/;", "", "    ko.bindingHandlers.item = {"]}, {"lines": ["            var model = ko.utils.unwrapObservable(valueAccessor());", "            ko.renderTemplate(model.type, model, {}, element, 'replaceNode');", "        }", "    };", "", "    // Initialize unique index for Content objects"]}, {"lines": ["    var uid = 1;"]}, {"lines": ["", "    function Content(content, $parent, $root, $ctx, refresh) {", ""]}, {"lines": ["        if (!content) {", "            return;", "        }", ""]}, {"lines": ["        var self = this;", "", "        self.$parent = $parent;", "        self.$root = $root;", "        self.$ctx = $ctx;", "", "        // Give each Content a unique index for tracking"]}, {"lines": ["        self.uid = uid;", "        self.uidFmt = 'metadata-' + self.uid;", "        uid++;"]}, {"lines": [""]}, {"lines": ["        // Copy content to self"]}, {"lines": ["        $.extend(self, content);", ""]}, {"lines": ["        // Set up each"]}, {"lines": ["                self._contentsObservable = null;", "                self._contentsData = {};", "                self.contents = ko.computed(function() {", "                    if (!self._contentsObservable) {", "                        self.$root._refresh();", "                        var eachSplit = self.each.split('.');", "                        var eachContent = self.getKey(eachSplit[1]);", "                        if (eachContent) {", "                            self._contentsObservable = eachContent.contents;", "                        }", "                    }", "                    if (self._contentsObservable) {", "                        var contents = $.map(self._contentsObservable(), function(data) {"]}, {"lines": ["                            if (!(data.uid in self._contentsData)) {", "                                var newContent = delegateContent(self._template, self, self.$root, data, false);"]}, {"lines": ["                                newContent.updateIdx('add', false);"]}, {"lines": ["                                self._contentsData[data.uid] = newContent;"]}, {"lines": ["                            }"]}, {"lines": ["                            return self._contentsData[data.uid];"]}, {"lines": ["                        });", "                        self.updateIdx('add', true);", "                        return contents;", "                    }", "                    return [];", "                });", "            } else {", "                $.each(self.each, function(idx, data) {", "                    self.addRepeat(data, false);", "                });", "                if (self.$root.pages) {", "                    self.updateIdx('add');", "                }", "            }"]}, {"lines": ["        }", "", "        // Impute defaults", "        self.displayRules = self.displayRules || {};"]}, {"lines": ["        self.canRepeat = self.canRepeat || false;"]}, {"lines": ["        self.maxRepeat = self.maxRepeat || null;", "", "        $.each(['id', 'title', 'label', 'caption', 'value'], function(idx, field) {", "            // todo: recurse over iterables"]}, {"lines": ["                self.contextComputed(field);", "            }", "        });", ""]}, {"lines": ["        // Process display rules"]}, {"lines": ["        self.visible = ko.computed(function() {", "            self.$root._refresh();", "            var _visible = true;", "            $.each(self.displayRules, function(key, value) {", "                var model = self.getKey(key);", "                var modelValue = model ? model.value() : null;"]}, {"lines": ["                    _visible = false;", "                    return false;", "                }", "            });", "            return _visible;", "        });", ""]}, {"lines": ["        // Optionally refresh"]}, {"lines": ["        if (refresh) {", "            $root.refresh();", "        }", "", "    }", "", "    Content.prototype = {", ""]}, {"lines": ["        // todo: review & test"]}, {"lines": ["        contextComputed: function(field) {", "            var self = this;", "            var _original = self[field];", "            self[field] = ko.computed(function() {", "                value = _original;", "                while (match = value.match(TPL_REGEX)) {", "                    ctxSplit = match[1].split('.');"]}, {"lines": ["                        cntValue = self;", "                        ctxValue = self.$ctx;", "                        $.each(ctxSplit.slice(1), function(idx, key) {"]}, {"lines": ["                                cntValue = cntValue.$parent;", "                                ctxValue = cntValue.$ctx;", "                            } else {", "                                ctxValue = ctxValue[key];", "                            }"]}, {"lines": ["                        model = self.getKey(ctxSplit[1]);", "                        ctxValue = model ? model.value() : '';", "                    }", "                    value = value.replace(TPL_REGEX, ko.utils.unwrapObservable(ctxValue));", "                }", "                return value;", "            });", "        },", ""]}, {"lines": ["        scrollToTop: function() {", "            $('html, body').animate({", "                scrollTop: $('#' + this.uidFmt).offset().top", "            });", "        },", "", "        /*", "         * Get index of current page or null if not found.", "         */", "        getPage: function() {", "            var self = this;", "            var cursor = self;", "            while (cursor) {", "                if (!cursor.type) {", "                    return self.$root.pages.indexOf(cursor);", "                }", "                cursor = cursor.$parent;", "            }", "            return null;", "        },", "", "        /*", "         * Determine whether content is displayed; content whose visible", "         * computed is true will not be displayed if contained by a parent", "         * content whose visible is false.", "         */", "        isDisplayed: function() {", "            var cursor = this;", "            while (cursor) {", "                if (cursor.visible && !cursor.visible()) {", "                    return false;", "                }", "                cursor = cursor.$parent;", "            }", "            return true;", "        },", "", "        /*", "         *", "         */"]}, {"lines": ["        getKey: function(key) {", "            var child = this;", "            while (child.$parent) {", "                child = child.$parent;", "                if (child.observedData && key in child.observedData) {", "                    return child.observedData[key];", "                }", "            }", "            return this.$root.observedData[key];", "        },", "", "        getIdx: function() {", "            return this.$parent.contents().indexOf(this);", "        },", "", "        updateIdx: function(action, refresh) {", "", "            var idx = [],", "                child = this,", "                key;", "", "            if (this.contents) {", "                $.each(this.contents(), function(idx, content) {", "                    content.updateIdx(action, false);", "                });", "            }"]}, {"lines": ["", "            while (child) {", "                if (child.$parent && child.$parent.repeatSection) {", "                    idx.unshift(ko.utils.unwrapObservable(child.id) + IDX_SEPARATOR + child.getIdx());", "                    var _idx = child.getIdx();", "                } else if (!child.type) {"]}, {"lines": ["//                        idx.unshift('page:' + this.$root.pages.indexOf(child));", "//                        var _idx = this.$root.pages.indexOf(child);", "//                        if (_idx != -1) {", "//                            idx.unshift('page:' + _idx);", "//                        }"]}, {"lines": ["                    idx.unshift(ko.utils.unwrapObservable(child.id));"]}, {"lines": ["                }"]}, {"lines": ["                if (child.$parent && child.$parent.observedData) {", "                    key = idx.join(SEPARATOR);"]}, {"lines": ["                    }"]}, {"lines": ["                }"]}, {"lines": ["                child = child.$parent;", "            }", "", "            key = idx.join(SEPARATOR);"]}, {"lines": ["            }", "", "            if (refresh) {"]}, {"lines": ["                this.$root.refresh();", "            }", "", "        },", "", "        addRepeat: function(data, update) {"]}, {"lines": ["            var content = delegateContent(this._template, this, this.$root, data);"]}, {"lines": ["            this.contents.push(content);", "            if (update) {", "                content.updateIdx('add');", "            }", "        },", "", "        removeRepeat: function() {", "            this.$parent.updateIdx('remove');", "            var parentIdx = this.getIdx();", "            this.$parent.contents.splice(parentIdx, 1);", "            this.$parent.updateIdx('add');", "        },", "", "        repeatCount: function() {", "            return this.contents ? this.contents().length : 0;", "        }", "", "    };", ""]}, {"lines": ["", "    function Section() {", "", "        var self = this;", "        Content.apply(this, arguments);", "", "        var tmpContents = self.contents;", "        self.contents = ko.observableArray();", "        $.each(tmpContents, function(idx, content) {", "            self.contents.push(", "                delegateContent(content, self, self.$root, null, false)", "            );", "        });", ""]}, {"lines": ["            self.initRepeat = self.initRepeat || 1;", "            for (var i=0; i<self.initRepeat; i++) {", "                self.addRepeat(null, false);", "            }", "        }", "", "        self.observedData = {};", "", "    }", "", "    Section.prototype = Object.create(Content.prototype);", "", "    function Item() {", "", "        var self = this;", "        Content.apply(this, arguments);", ""]}, {"lines": ["            var eachSplit = self.options.split('.');", "            self._optionsOriginal = self.options;", "            self._optionsObservable = null;", "            self.options = ko.computed(function() {", "                if (!self._optionsObservable) {", "                    self.$root._refresh();", "                    var optSplit = self._optionsOriginal.split('.');", "                    var optContent = self.getKey(optSplit[1]);", "                    if (optContent) {", "                        if (optContent.contents) {", "                            self._optionsObservable = optContent.contents;", "                        } else if (optContent.value) {", "                            self._optionsObservable = optContent.value;", "                        }", "                    }", "                }", "                if (self._optionsObservable) {", "                    return $.map(self._optionsObservable(), function(option) {"]}, {"lines": ["                        }", "                        return option;", "                    });", "                }", "                return [];", "            });", "        }", "", "        // Set up observable on value"]}, {"lines": ["            self.value = ko.observableArray(self.value || []);", "        } else {", "            self.value = ko.observable(ko.utils.unwrapObservable(self.value) || '');", "        }", "", "        // Impute item-level defaults", "        self.required = self.required || false;", "        self.validation = self.validation || [];", "        self.disable = self.disable || false;", "        self.helpText = self.helpText || '';", "        self.multiple = self.multiple || false;", "", "        self.isValid = ko.computed(function() {", "            return true;", "        });", "        self.validateText = ko.computed(function() {", "            var value = self.value();", "            if (!value) {", "                return '';", "            }", "            var message = '';", "            $.each(self.validation, function(idx, rule) {", "                switch (rule.type) {", "                    case 'regex':", "                        if (!value.match(new RegExp(rule.value))) {", "                            message = rule.message;", "                            return false;", "                        }", "                }", "            });", "            return message;", "        });", "", "    }", "    Item.prototype = Object.create(Content.prototype);", "    $.extend(Item.prototype, {", "        serialize: function() {", "            return this.value();", "        },", "        unserialize: function(value) {", "            this.value(value);"]}, {"lines": ["        }", "    });", "", "    function FileItem() {", "", "        var self = this;", "        Item.apply(this, arguments);", "", "        self.node = ko.observable();", "        self.nodes = self.$root.nodes;", "        self.files = ko.computed(function() {", "            var selectedNode = self.node();", "            if (!selectedNode) {", "                return [];", "            }", "            if (!self.$root.fileDict[selectedNode]) {", "                self.$root.fileDict[selectedNode] = ko.observableArray();", "                self.$root.fileDict[selectedNode]();", "                $.getJSON("]}, {"lines": ["                    nodeApiUrl + 'file_paths/',"]}, {"lines": ["                    function(response) {", "                        self.$root.fileDict[selectedNode](response.files);", "                    }"]}, {"lines": ["            } else {", "                return self.$root.fileDict[selectedNode]();", "            }", "        });", "", "    }", "    FileItem.prototype = Object.create(Item.prototype);", "    $.extend(FileItem.prototype, {", "        serialize: function() {", "            return [this.node(), this.value()];", "        },", "        unserialize: function(value) {", "            // Ensure that stored node is included in view model's", "            // node list"]}, {"lines": ["                this.$root.nodes.unshift(value[0]);", "            }", "            this.node(value[0]);", "            this.value(value[1]);"]}, {"lines": ["        }", "    });", "", "    var contentDelegator = {", "        section: Section,", "        item: Item,", "        file: FileItem", "    };", "    function delegateContent(content) {", "        var type = contentDelegator[content.type] ?", "            content.type :", "            'item';", "        var klass = contentDelegator[type];", "        var args = Array.prototype.concat.apply([null], arguments);"]}, {"lines": ["    }", ""]}, {"lines": ["    function Page(id, title, contents, $root) {", "", "        var self = this;", "", "        self.id = id;", "        self.title = title;", "        self.contents = ko.observableArray();", "        $.each(contents, function(idx, content) {"]}, {"lines": ["            self.contents.push(", "                delegateContent(content, self, $root)", "            );"]}, {"lines": ["        });", ""]}, {"lines": ["        self.uidFmt = 'metadata-0';"]}, {"lines": ["        self.observedData = {};", "", "    }", "", "    Page.prototype = {", "", "        updateIdx: function(action, refresh) {", "            $.each(this.contents(), function(cidx, content) {", "                content.updateIdx(action, refresh);", "            });", "        }", "", "    };", "", "    /*", "     * Prepare input schema, recursively wrapping all repeatable content in", "     * shell sections. This gives each repeatable content its own DOM node.", "     * Also check for forbidden IDs and count frequency of each ID; no ID", "     * should occur more than once.", "     */", "    function preprocess(content, ids) {", "", "        // Crash if no ID", "        if (!content.id) {", "            throw 'ID undefined.';", "        }", "        // Crash if forbidden characters in IDs", "        $.each([SEPARATOR, IDX_SEPARATOR], function(idx, char) {"]}, {"lines": ["                throw 'Forbidden character \"' + char + '\" in id ' + content.id + '.';", "            }", "        });", "", "        // Update ID dictionary", "        ids = ids || {};", "        if (ids[content.id]) {", "            ids[content.id]++;", "        } else {", "            ids[content.id] = 1;", "        }", "", "        $.each(content.contents || [], function(idx, _content) {", "", "            preprocess(_content, ids);", ""]}, {"lines": ["            var contentCopy = $.extend(true, {}, _content);", "            contentCopy.title = null;", ""]}, {"lines": ["            if (_content.canRepeat) {", "                content.contents[idx] = {", "                    type: 'section',"]}, {"lines": ["                    title: _content.title,"]}, {"lines": ["                    id: _content.id,", "                    minRepeat: _content.minRepeat,", "                    maxRepeat: _content.maxRepeat,", "                    initRepeat: _content.initRepeat,", "                    repeatType: 'repeat',", "                    repeatSection: true,", "                    contents: [],"]}, {"lines": ["                    _template: contentCopy"]}, {"lines": ["                };", "            } else if (_content.each) {", "                content.contents[idx] = {", "                    type: 'section',", "                    each: _content.each,"]}, {"lines": ["                    title: _content.title,"]}, {"lines": ["                    id: _content.id,", "                    repeatType: 'each',", "                    repeatSection: true,", "                    contents: [],"]}, {"lines": ["                    _template: contentCopy"]}, {"lines": ["                };", "            }", "", "        });", "", "    }", "", "    function ViewModel(schema, disable, nodes) {", "", "        var self = this;", "        self.nodes = nodes;", "        self.fileDict = {};", "", "        self._refresh = ko.observable();", "", "        self.disable = disable || false;", "", "        self.observedData = {};", "", "        self.continueText = ko.observable('');", "        self.continueFlag = ko.computed(function() {"]}, {"lines": ["            return self.continueText().toLowerCase() === 'register';"]}, {"lines": ["        });", "", "        var ids = {};", "        self.pages = $.map(schema.pages, function(page) {", "            preprocess(page, ids);", "            return new Page(page.id, page.title, page.contents, self);", "        });", "        self.npages = self.pages.length;", ""]}, {"lines": ["        // Check uniqueness of IDs", "        $.each(ids, function(id, count) {", "            if (count > 1) {", "                throw 'Id \"' + id + '\" appeared ' + count.toString() + 'times.';", "            }", "        });", "", "        self.currentIndex = ko.observable(0);", "", "        self.currentPage = ko.computed(function(){", "           return self.pages[self.currentIndex()];", "        });", "", "        self.isFirst = ko.computed(function() {", "            return self.currentIndex() === 0;", "        });", "", "        self.isLast = ko.computed(function() {", "            return self.currentIndex() === self.npages - 1;", "        });", "", "    }", "", "    ViewModel.prototype = {", "", "        getTemplate: function(data) {"]}, {"lines": ["        },", "", "        refresh: function() {", "            this._refresh(Math.random());", "        },", "", "        updateIdx: function(action) {", "            $.each(this.pages, function(pidx, page) {", "                page.updateIdx(action, false);", "            });", "            this.refresh();", "        },", "", "        scrollToTop: function() {", "            $('html, body').animate({"]}, {"lines": ["            });", "        },", "", "        previous: function() {", "            this.currentIndex(this.currentIndex() - 1);", "            this.scrollToTop();", "        },", "", "        next: function() {", "            this.currentIndex(this.currentIndex() + 1);", "            this.scrollToTop();", "        },", "", "        canRemove: function(data) {"]}, {"lines": ["                return false;", "            }", "            var count = data.$parent.repeatCount ? data.$parent.repeatCount() : null;", "            return data.$parent.repeatSection &&", "                    count > data.minRepeat;", "        },", "", "        canAdd: function(data) {"]}, {"lines": ["                return false;", "            }", "            var count = data.repeatCount ? data.repeatCount() : null;", "            var show = data.repeatSection && (", "                    data.maxRepeat == null ||", "                    count < data.maxRepeat", "                );", "            return !!show;", "        },", "", "        /*", "         * Serialize form data to Object, ignoring hidden fields", "         */", "        serialize: function() {"]}, {"lines": ["            var self = this,", "                data = {},"]}, {"lines": ["                complete = true,", "                value;", "            $.each(this.observedData, function(name, model) {"]}, {"lines": ["                    return true;", "                }", "                value = model.serialize();", "                data[name] = value;", "                if (complete && model.required && model.isDisplayed() && !value) {", "                    self.currentIndex(model.getPage());"]}, {"lines": ["                    try {", "                        model.scrollToTop();", "                    } catch(e) {}"]}, {"lines": ["                    complete = false;"]}, {"lines": ["                }", "            });"]}, {"lines": ["            return {", "                data: data,", "                complete: complete", "            };", "        },", "", "        /*", "         * Unserialize stored data to survey", "         */", "        unserialize: function(data) {", "            var self = this;", "            var nextData = {};", "            $.each(data, function(key, value) {"]}, {"lines": ["                var keyParts = key.split(SEPARATOR);", "                var current = self;", "                var subIdx;", "                $.each(keyParts, function(idx, keyPart) {", "                    subParts = keyPart.split(IDX_SEPARATOR);"]}, {"lines": ["                    current = current.observedData[subParts[0]];", "                    if (subParts.length > 1) {"]}, {"lines": ["                            subIdx = parseInt(subParts[1]);", "                            while (current.contents().length < (subIdx + 1)) {", "                                current.addRepeat(null, true);", "                            }"]}, {"lines": ["                            current = current.contents()[subIdx];", "                        }", "                    }", "                });", "                if (self.observedData[key]) {"]}, {"lines": ["                    var success = self.observedData[key].unserialize(value);", "                    if (!success) {", "                        nextData[key] = value;"]}, {"lines": ["                    }", "                } else {", "                    nextData[key] = value;", "                }", "            });"]}, {"lines": ["            if (Object.keys(nextData).length) {", "                // Length of data to be unserialized hasn't changed;", "                // we're stuck!"]}, {"lines": ["                }", "                // Unserialize remaining data", "                self.unserialize(nextData);", "            }"]}, {"lines": ["        }", "", "    };", "", "    return {", "        ViewModel: ViewModel,", "        Content: Content"]}, {"lines": [""]}, {"lines": ["require('knockout.punches');"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["module.exports = NotificationsViewModel;"]}, {"lines": ["var osfHelpers = require('js/osfHelpers');"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var $osf = require('./osfHelpers');"]}, {"lines": ["var clipboard = require('./clipboard');"]}, {"lines": ["require('bootstrap-editable');"]}, {"lines": ["var ctx = window.contextVars;"]}, {"lines": [""]}, {"lines": ["        url: ctx.node.urls.api + 'private_link/edit/',"]}, {"lines": ["    self.selectText = 'this.setSelectionRange(0, this.value.length);';"]}, {"lines": ["    self.removeLink = 'Remove this link';"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                    url: ctx.node.urls.api + 'private_link/',"]}, {"lines": ["        clipboard(target[0]);"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": ["var ctx = window.contextVars;"]}, {"lines": ["    NodeActions.beforeForkNode(ctx.node.urls.api + 'fork/before/', function() {"]}, {"lines": ["            ctx.node.urls.api + 'fork/',"]}, {"lines": ["                    ctx.node.urls.api + 'pointer/fork/',"]}, {"lines": ["    NodeActions.beforeTemplate('/project/new/' + ctx.node.id + '/beforeTemplate/', function () {"]}, {"lines": ["            '/api/v1/project/new/' + ctx.node.id + '/',"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        ctx.node.urls.api + 'reorder_components/',"]}, {"lines": ["        url: ctx.node.urls.api + 'pointer/',"]}, {"lines": ["        }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        var panel = $('#citationStylePanel');"]}, {"lines": ["            if (panel.is(':visible')) {", "                $('#citationStyleInput').select2('open');"]}, {"lines": ["    });"]}, {"lines": [""]}, {"lines": ["    // Portlet feature for the dashboard, to be implemented in later versions."]}, {"lines": ["    // Adds active class to current menu item"]}, {"lines": ["        $('.project-nav a').each(function () {"]}, {"lines": ["require('knockout.validation').init({insertMessages: false});  // override default DOM insertions"]}, {"lines": ["'use strict';"]}, {"lines": ["var $ = require('jquery');", "var $osf = require('./osfHelpers');"]}, {"lines": ["require('js/crossOrigin.js');", "var $osf = require('js/osfHelpers');", "var NavbarControl = require('js/navbarControl');"]}, {"lines": ["$.ajaxSetup({cache: false});"]}, {"lines": [" */", "", "'use strict';", ""]}, {"lines": ["'use strict';", "", "var $ = require('jquery');"]}, {"lines": ["var Fangorn = require('js/fangorn');"]}, {"lines": ["    $.ajax({", "      url: nodeApiUrl + 'files/grid/'", "    }).done(function(data) {", "        new Fangorn({", "            placement: 'project-files',", "            divID: 'treeGrid',"]}, {"lines": ["    });", "});"]}, {"lines": ["require('bootstrap-editable');"]}, {"lines": ["var Fangorn = require('js/fangorn');"]}, {"lines": ["    new CitationList('#citationList');"]}, {"lines": ["    $('[data-toggle=\"tooltip\"]').tooltip({container: 'body'});"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["var $osf = require('js/osfHelpers');", ""]}, {"lines": ["'use strict';", ""]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var $ = require('jquery');", "var $osf = require('js/osfHelpers');"]}, {"lines": ["    var sources = elastic_data.raw_aggregations.sources.buckets;", "    var source_names = [];", "    for (var i=0; i<sources.length; i++) {"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';", "var assert = require('chai').assert;"]}, {"lines": ["var $ = require('jquery');", "", "var utils = require('./utils');", "var nodeControl = require('../nodeControl');", "", "var nodeData = {", "    node: {", "        id: '24601',", "        api_url: '/api/v1/project/24601/',", "        watched_count: 0,", "        identifiers: {doi: null, ark: null}", "    },", "    parent_node: {id: ''},"]}, {"lines": ["    user: {permissions: ['read', 'write', 'admin']}"]}, {"lines": ["};", "", "describe('nodeControl', () => {", "    describe('ViewModels', () => {"]}, {"lines": ["            var server;", "            var vm = new nodeControl._ProjectViewModel(nodeData);", "            var endpoints = [", "                {method: 'POST', url: vm.apiUrl + 'identifiers/', response: {doi: '24601', ark: '24601'}}", "            ];", "            before(() => {", "                server = utils.createServer(sinon, endpoints);", "            });", "            after(() => {", "                server.restore();", "            });", "            it('has no identifiers when identifiers are null', () => {", "                var vm = new nodeControl._ProjectViewModel(nodeData);", "                assert.equal(vm.doi(), null);", "                assert.equal(vm.ark(), null);", "                assert.isFalse(vm.hasIdentifiers());", "            });", "            it('has identifiers when identifiers are not null', () => {", "                var vm = new nodeControl._ProjectViewModel(nodeData);", "                vm.doi('24601');", "                vm.ark('24601');", "                assert.isTrue(vm.hasIdentifiers());", "            });"]}, {"lines": ["            it('can have identifiers when public, registered, and admin', () => {"]}, {"lines": ["                var data = $.extend({}, nodeData);", "                data.node = $.extend(data.node, {is_registration: true, is_public: true});"]}, {"lines": ["                var vm = new nodeControl._ProjectViewModel(data);"]}, {"lines": ["                assert.isTrue(vm.canCreateIdentifiers());"]}, {"lines": ["            });"]}, {"lines": ["            it('cannot have identifiers when private, not registered, or not admin', () => {"]}, {"lines": ["                var vm;"]}, {"lines": ["                var data = $.extend({}, nodeData);", "                data.node = $.extend(data.node, {is_registration: true, is_public: false});"]}, {"lines": ["                vm = new nodeControl._ProjectViewModel(data);"]}, {"lines": ["                assert.isFalse(vm.canCreateIdentifiers());"]}, {"lines": ["                data.node = $.extend(data.node, {is_registration: false, is_public: true});"]}, {"lines": ["                vm = new nodeControl._ProjectViewModel(data);"]}, {"lines": ["                assert.isFalse(vm.canCreateIdentifiers());", "                data = $.extend(data, {user: {permissions: ['read', 'write']}});"]}, {"lines": ["                data.node = $.extend(data.node, {is_registration: true, is_public: true});"]}, {"lines": ["                vm = new nodeControl._ProjectViewModel(data);"]}, {"lines": ["                assert.isFalse(vm.canCreateIdentifiers());"]}, {"lines": ["            });", "            it('builds the correct absolute urls', () => {", "                var vm = new nodeControl._ProjectViewModel(nodeData);", "                vm.doi('24601');", "                vm.ark('24601');", "                assert.equal(vm.doiUrl(), 'http://ezid.cdlib.org/id/doi:24601');"]}, {"lines": ["                assert.equal(vm.arkUrl(), 'http://ezid.cdlib.org/id/ark:/24601');"]}, {"lines": ["            });", "            it('creates new identifiers', (done) => {"]}, {"lines": ["                    assert.equal(vm.doi(), '24601');", "                    assert.equal(vm.ark(), '24601');", "                    done();", "                });", "            });", "        });", "    });", "});"]}, {"lines": ["/**", " * Functions for parsing an XML object using E4X.", " */", "", "// Don't clobber an existing value if this has already been declared.", "if (\"undefined\" === typeof CSL_IS_IE) {", "    var CSL_IS_IE;", "};", "", "var CSL_CHROME = function () {", "    if (\"undefined\" == typeof DOMParser || CSL_IS_IE) {", "        CSL_IS_IE = true;", "        DOMParser = function() {};", "        DOMParser.prototype.parseFromString = function(str, contentType) {", "            if (\"undefined\" != typeof ActiveXObject) {", "                var xmldata = new ActiveXObject('MSXML.DomDocument');", "                xmldata.async = false;", "                xmldata.loadXML(str);", "                return xmldata;", "            } else if (\"undefined\" != typeof XMLHttpRequest) {", "                var xmldata = new XMLHttpRequest;", "                if (!contentType) {", "                    contentType = 'text/xml';", "                }", "                xmldata.open('GET', 'data:' + contentType + ';charset=utf-8,' + encodeURIComponent(str), false);", "                if(xmldata.overrideMimeType) {", "                    xmldata.overrideMimeType(contentType);", "                }", "                xmldata.send(null);", "                return xmldata.responseXML;", "            }", "        };", "        this.hasAttributes = function (node) {", "            var ret;", "            if (node.attributes && node.attributes.length) {", "                ret = true;", "            } else {", "                ret = false;", "            }", "            return ret;", "        };", "    } else {", "        /*", "        this.hasAttributes = function (node) {", "            return node[\"hasAttributes\"]();", "        };", "        */", "        this.hasAttributes = function (node) {", "            var ret;", "            if (node.attributes && node.attributes.length) {", "                ret = true;", "            } else {", "                ret = false;", "            }", "            return ret;", "        };", "    }", "    this.importNode = function (doc, srcElement) {", "        if (\"undefined\" == typeof doc.importNode) {", "            var ret = this._importNode(doc, srcElement, true);", "        } else {", "            var ret = doc.importNode(srcElement, true);", "        }", "        return ret;", "    };", "    // In case importNode is not available.", "    // Thx + hat tip to Anthony T. Holdener III", "    // http://www.alistapart.com/articles/crossbrowserscripting", "    // cases 3, 4, 8 = text, cdata, comment", "    this._importNode = function(doc, node, allChildren) {", "        switch (node.nodeType) {", "            // element node", "            case 1:", "                var newNode = doc.createElement(node.nodeName);", "                if (node.attributes && node.attributes.length > 0)", "                    for (var i = 0, il = node.attributes.length; i < il;)", "                        newNode.setAttribute(node.attributes[i].nodeName, node.getAttribute(node.attributes[i++].nodeName));", "                    if (allChildren && node.childNodes && node.childNodes.length > 0)", "                        for (var i = 0, il = node.childNodes.length; i < il;)", "                            newNode.appendChild(this._importNode(doc, node.childNodes[i++], allChildren));", "                return newNode;", "                break;", "            case 3:", "            case 4:", "            case 8:", "                // Drop comments on the floor as well.", "                //return doc.createTextNode(node.nodeValue);", "                //break;", "        }", "    };", "    this.parser = new DOMParser();", "", "    // This seems horribly tormented, but there might be a reason for it.", "    // Perhaps this was the only way I found to get namespacing to work ... ?", "    var str = \"<docco><institution institution-parts=\\\"long\\\" delimiter=\\\", \\\" substitute-use-first=\\\"1\\\" use-last=\\\"1\\\"><institution-part name=\\\"long\\\"/></institution></docco>\";", "    var inst_doc = this.parser.parseFromString(str, \"text/xml\");", "    var inst_node = inst_doc.getElementsByTagName(\"institution\");", "    this.institution = inst_node.item(0);", "    var inst_part_node = inst_doc.getElementsByTagName(\"institution-part\");", "    this.institutionpart = inst_part_node.item(0);", "    this.ns = \"http://purl.org/net/xbiblio/csl\";", "};", "", "/**", " * No need for cleaning with the DOM, I think.  This will probably just be a noop.", " * But first, let's get XML mode switching up and running.", " */", "CSL_CHROME.prototype.clean = function (xml) {", "    xml = xml.replace(/<\\?[^?]+\\?>/g, \"\");", "    xml = xml.replace(/<![^>]+>/g, \"\");", "    xml = xml.replace(/^\\s+/, \"\");", "    xml = xml.replace(/\\s+$/, \"\");", "    xml = xml.replace(/^\\n*/, \"\");", "    return xml;", "};", "", "", "/**", " * Methods to call on a node.", " */", "CSL_CHROME.prototype.getStyleId = function (myxml, styleName) {", "    var text = \"\";", "    var tagName = \"id\";", "    if (styleName) {", "        tagName = \"title\";", "    }", "    var node = myxml.getElementsByTagName(tagName);", "    if (node && node.length) {", "        node = node.item(0);", "    }", "    if (node) {", "        // W3C conformant browsers", "        text = node.textContent;", "    }", "    if (!text) {", "        // Opera, IE 6 & 7", "        text = node.innerText;", "    }", "    if (!text) {", "        // Safari", "        text = node.innerHTML;", "    }", "    return text;", "};", "", "CSL_CHROME.prototype.children = function (myxml) {", "    var children, pos, len, ret;", "    if (myxml) {", "        ret = [];", "        children = myxml.childNodes;", "        for (pos = 0, len = children.length; pos < len; pos += 1) {", "            if (children[pos].nodeName != \"#text\") {", "                ret.push(children[pos]);", "            }", "        }", "        return ret;", "    } else {", "        return [];", "    }", "};", "", "CSL_CHROME.prototype.nodename = function (myxml) {", "    var ret = myxml.nodeName;", "    return ret;", "};", "", "CSL_CHROME.prototype.attributes = function (myxml) {", "    var ret, attrs, attr, key, xml, pos, len;", "    ret = new Object();", "    if (myxml && this.hasAttributes(myxml)) {", "        attrs = myxml.attributes;", "        for (pos = 0, len=attrs.length; pos < len; pos += 1) {", "            attr = attrs[pos];", "            ret[\"@\" + attr.name] = attr.value;", "        }", "    }", "    return ret;", "};", "", "", "CSL_CHROME.prototype.content = function (myxml) {", "    var ret;", "    if (\"undefined\" != typeof myxml.textContent) {", "        ret = myxml.textContent;", "    } else if (\"undefined\" != typeof myxml.innerText) {", "        ret = myxml.innerText;", "    } else {", "        ret = myxml.txt;", "    }", "    return ret;", "};", "", "", "CSL_CHROME.prototype.namespace = {", "    \"xml\":\"http://www.w3.org/XML/1998/namespace\"", "}", "", "CSL_CHROME.prototype.numberofnodes = function (myxml) {", "    if (myxml) {", "        return myxml.length;", "    } else {", "        return 0;", "    }", "};", "", "CSL_CHROME.prototype.getAttributeName = function (attr) {", "    var ret = attr.name;", "    return ret;", "}", "", "CSL_CHROME.prototype.getAttributeValue = function (myxml,name,namespace) {", "    var ret = \"\";", "    if (namespace) {", "        name = namespace+\":\"+name;", "    }", "    if (myxml && this.hasAttributes(myxml) && myxml.getAttribute(name)) {", "        ret = myxml.getAttribute(name);", "    }", "    return ret;", "}", "", "//", "// Can't this be, you know ... simplified?", "//", "CSL_CHROME.prototype.getNodeValue = function (myxml,name) {", "    var ret = null;", "    if (name){", "        var vals = myxml.getElementsByTagName(name);", "        if (vals.length > 0) {", "            if (\"undefined\" != typeof vals[0].textContent) {", "                ret = vals[0].textContent;", "            } else if (\"undefined\" != typeof vals[0].innerText) {", "                ret = vals[0].innerText;", "            } else {", "                ret = vals[0].text;", "            }", "        }", "    }", "    if (ret === null && myxml && myxml.childNodes && (myxml.childNodes.length == 0 || (myxml.childNodes.length == 1 && myxml.firstChild.nodeName == \"#text\"))) {", "        if (\"undefined\" != typeof myxml.textContent) {", "            ret = myxml.textContent;", "        } else if (\"undefined\" != typeof myxml.innerText) {", "            ret = myxml.innerText;", "        } else {", "            ret = myxml.text;", "        }", "    }", "    if (ret === null) {", "        ret = myxml;", "    }", "    return ret;", "}", "", "CSL_CHROME.prototype.setAttributeOnNodeIdentifiedByNameAttribute = function (myxml,nodename,partname,attrname,val) {", "    var pos, len, xml, nodes, node;", "    if (attrname.slice(0,1) === '@'){", "        attrname = attrname.slice(1);", "    }", "    nodes = myxml.getElementsByTagName(nodename);", "    for (pos = 0, len = nodes.length; pos < len; pos += 1) {", "        node = nodes[pos];", "        if (node.getAttribute(\"name\") != partname) {", "            continue;", "        }", "        node.setAttribute(attrname, val);", "    }", "}", "", "CSL_CHROME.prototype.deleteNodeByNameAttribute = function (myxml,val) {", "    var pos, len, node, nodes;", "    nodes = myxml.childNodes;", "    for (pos = 0, len = nodes.length; pos < len; pos += 1) {", "        node = nodes[pos];", "        if (!node || node.nodeType == node.TEXT_NODE) {", "            continue;", "        }", "        if (this.hasAttributes(node) && node.getAttribute(\"name\") == val) {", "            myxml.removeChild(nodes[pos]);", "        }", "    }", "}", "", "CSL_CHROME.prototype.deleteAttribute = function (myxml,attr) {", "    myxml.removeAttribute(attr);", "}", "", "CSL_CHROME.prototype.setAttribute = function (myxml,attr,val) {", "    if (!myxml.ownerDocument) {", "        myxml = myxml.firstChild;", "    }", "    // \"unknown\" to satisfy IE8, which crashes when setAttribute", "    // is checked directly as a property, and report its type as", "    // \"unknown\".", "    // Many thanks to Phil Lord for tracing the cause of the fault.", "    if ([\"function\", \"unknown\"].indexOf(typeof myxml.setAttribute) > -1) {", "        myxml.setAttribute(attr, val);", "    }", "    return false;", "}", "", "CSL_CHROME.prototype.nodeCopy = function (myxml) {", "    var cloned_node = myxml.cloneNode(true);", "    return cloned_node;", "}", "", "CSL_CHROME.prototype.getNodesByName = function (myxml,name,nameattrval) {", "    var ret, nodes, node, pos, len;", "    ret = [];", "    nodes = myxml.getElementsByTagName(name);", "    for (pos = 0, len = nodes.length; pos < len; pos += 1) {", "        node = nodes.item(pos);", "        if (nameattrval && !(this.hasAttributes(node) && node.getAttribute(\"name\") == nameattrval)) {", "//        if (nameattrval && !(this.attributes && node.attributes.name && node.attributes.name.value == nameattrval)) {", "            continue;", "        }", "        ret.push(node);", "    }", "    return ret;", "}", "", "CSL_CHROME.prototype.nodeNameIs = function (myxml,name) {", "    if (name == myxml.nodeName) {", "        return true;", "    }", "    return false;", "}", "", "CSL_CHROME.prototype.makeXml = function (myxml) {", "    var ret, topnode;", "    if (!myxml) {", "        myxml = \"<docco><bogus/></docco>\";", "    }", "    myxml = myxml.replace(/\\s*<\\?[^>]*\\?>\\s*\\n*/g, \"\");", "    var nodetree = this.parser.parseFromString(myxml, \"application/xml\");", "    return nodetree.firstChild;", "};", "", "CSL_CHROME.prototype.insertChildNodeAfter = function (parent,node,pos,datexml) {", "    var myxml, xml;", "    myxml = this.importNode(node.ownerDocument, datexml);", "    parent.replaceChild(myxml, node);", "     return parent;", "};", "", "CSL_CHROME.prototype.insertPublisherAndPlace = function(myxml) {", "    var group = myxml.getElementsByTagName(\"group\");", "    for (var i = 0, ilen = group.length; i < ilen; i += 1) {", "        var node = group.item(i);", "        var skippers = [];", "        for (var j = 0, jlen = node.childNodes.length; j < jlen; j += 1) {", "            if (node.childNodes.item(j).nodeType !== 1) {", "                skippers.push(j);", "            }", "        }", "        if (node.childNodes.length - skippers.length === 2) {", "            var twovars = [];", "            for (var j = 0, jlen = 2; j < jlen; j += 1) {", "                if (skippers.indexOf(j) > -1) {", "                    continue;", "                }", "                var child = node.childNodes.item(j);", "                var subskippers = [];", "                for (var k = 0, klen = child.childNodes.length; k < klen; k += 1) {", "                    if (child.childNodes.item(k).nodeType !== 1) {", "                        subskippers.push(k);", "                    }", "                }", "                if (child.childNodes.length - subskippers.length === 0) {", "                    twovars.push(child.getAttribute('variable'));", "                    if (child.getAttribute('suffix')", "                        || child.getAttribute('prefix')) {", "                        twovars = [];", "                        break;", "                    }", "                }", "            }", "            if (twovars.indexOf(\"publisher\") > -1 && twovars.indexOf(\"publisher-place\") > -1) {", "                node.setAttribute('has-publisher-and-publisher-place', true);", "            }", "        }", "    }", "};", "", "CSL_CHROME.prototype.addMissingNameNodes = function(myxml) {", "    var nameslist = myxml.getElementsByTagName(\"names\");", "    for (var i = 0, ilen = nameslist.length; i < ilen; i += 1) {", "        var names = nameslist.item(i);", "        var namelist = names.getElementsByTagName(\"name\");", "        if ((!namelist || namelist.length === 0)", "            && names.parentNode.tagName.toLowerCase() !== \"substitute\") {", "", "            var doc = names.ownerDocument;", "            var name = doc.createElement(\"name\");", "            names.appendChild(name);", "        }", "    }", "};", "", "", "CSL_CHROME.prototype.addInstitutionNodes = function(myxml) {", "    var names, thenames, institution, theinstitution, name, thename, xml, pos, len;", "    names = myxml.getElementsByTagName(\"names\");", "    for (pos = 0, len = names.length; pos < len; pos += 1) {", "        thenames = names.item(pos);", "        name = thenames.getElementsByTagName(\"name\");", "        if (name.length == 0) {", "            continue;", "        }", "        institution = thenames.getElementsByTagName(\"institution\");", "        if (institution.length == 0) {", "            theinstitution = this.importNode(myxml.ownerDocument, this.institution);", "            theinstitutionpart = theinstitution.getElementsByTagName(\"institution-part\").item(0);", "            thename = name.item(0);", "            thenames.insertBefore(theinstitution, thename.nextSibling);", "            for (var j = 0, jlen = CSL.INSTITUTION_KEYS.length; j < jlen; j += 1) {", "                var attrname = CSL.INSTITUTION_KEYS[j];", "                var attrval = thename.getAttribute(attrname);", "                if (attrval) {", "                    theinstitutionpart.setAttribute(attrname, attrval);", "                }", "            }", "            var nameparts = thename.getElementsByTagName(\"name-part\");", "            for (var j = 0, jlen = nameparts.length; j < jlen; j += 1) {", "                if ('family' === nameparts[j].getAttribute('name')) {", "                    for (var k = 0, klen = CSL.INSTITUTION_KEYS.length; k < klen; k += 1) {", "                        var attrname = CSL.INSTITUTION_KEYS[k];", "                        var attrval = nameparts[j].getAttribute(attrname);", "                        if (attrval) {", "                            theinstitutionpart.setAttribute(attrname, attrval);", "                        }", "                    }", "                }", "            }", "        }", "    }", "};", "", "", "CSL_CHROME.prototype.flagDateMacros = function(myxml) {", "    var pos, len, thenode, thedate;", "    nodes = myxml.getElementsByTagName(\"macro\");", "    for (pos = 0, len = nodes.length; pos < len; pos += 1) {", "        thenode = nodes.item(pos);", "        thedate = thenode.getElementsByTagName(\"date\");", "        if (thedate.length) {", "            thenode.setAttribute('macro-has-date', 'true');", "        }", "    }", "};"]}, {"lines": ["/*!", " * jQuery blockUI plugin", " * Version 2.66.0-2013.10.09", " * Requires jQuery v1.7 or later", " *", " * Examples at: http://malsup.com/jquery/block/", " * Copyright (c) 2007-2013 M. Alsup", " * Dual licensed under the MIT and GPL licenses:", " * http://www.opensource.org/licenses/mit-license.php", " * http://www.gnu.org/licenses/gpl.html", " *", " * Thanks to Amir-Hossein Sobhi for some excellent contributions!", " */", "", ";(function() {", "/*jshint eqeqeq:false curly:false latedef:false */", "\"use strict\";", "", "\tfunction setup($) {", "\t\t$.fn._fadeIn = $.fn.fadeIn;", "", "\t\tvar noOp = $.noop || function() {};", "", "\t\t// this bit is to ensure we don't call setExpression when we shouldn't (with extra muscle to handle", "\t\t// confusing userAgent strings on Vista)", "\t\tvar msie = /MSIE/.test(navigator.userAgent);", "\t\tvar ie6  = /MSIE 6.0/.test(navigator.userAgent) && ! /MSIE 8.0/.test(navigator.userAgent);", "\t\tvar mode = document.documentMode || 0;", "\t\tvar setExpr = $.isFunction( document.createElement('div').style.setExpression );", "", "\t\t// global $ methods for blocking/unblocking the entire page", "\t\t$.blockUI   = function(opts) { install(window, opts); };", "\t\t$.unblockUI = function(opts) { remove(window, opts); };", "", "\t\t// convenience method for quick growl-like notifications  (http://www.google.com/search?q=growl)", "\t\t$.growlUI = function(title, message, timeout, onClose) {", "\t\t\tvar $m = $('<div class=\"growlUI\"></div>');", "\t\t\tif (title) $m.append('<h1>'+title+'</h1>');", "\t\t\tif (message) $m.append('<h2>'+message+'</h2>');", "\t\t\tif (timeout === undefined) timeout = 3000;", "", "\t\t\t// Added by konapun: Set timeout to 30 seconds if this growl is moused over, like normal toast notifications", "\t\t\tvar callBlock = function(opts) {", "\t\t\t\topts = opts || {};", "", "\t\t\t\t$.blockUI({", "\t\t\t\t\tmessage: $m,", "\t\t\t\t\tfadeIn : typeof opts.fadeIn  !== 'undefined' ? opts.fadeIn  : 700,", "\t\t\t\t\tfadeOut: typeof opts.fadeOut !== 'undefined' ? opts.fadeOut : 1000,", "\t\t\t\t\ttimeout: typeof opts.timeout !== 'undefined' ? opts.timeout : timeout,", "\t\t\t\t\tcenterY: false,", "\t\t\t\t\tshowOverlay: false,", "\t\t\t\t\tonUnblock: onClose,", "\t\t\t\t\tcss: $.blockUI.defaults.growlCSS", "\t\t\t\t});", "\t\t\t};", "", "\t\t\tcallBlock();", "\t\t\tvar nonmousedOpacity = $m.css('opacity');", "\t\t\t$m.mouseover(function() {", "\t\t\t\tcallBlock({", "\t\t\t\t\tfadeIn: 0,", "\t\t\t\t\ttimeout: 30000", "\t\t\t\t});", "", "\t\t\t\tvar displayBlock = $('.blockMsg');", "\t\t\t\tdisplayBlock.stop(); // cancel fadeout if it has started", "\t\t\t\tdisplayBlock.fadeTo(300, 1); // make it easier to read the message by removing transparency", "\t\t\t}).mouseout(function() {", "\t\t\t\t$('.blockMsg').fadeOut(1000);", "\t\t\t});", "\t\t\t// End konapun additions", "\t\t};", "", "\t\t// plugin method for blocking element content", "\t\t$.fn.block = function(opts) {", "\t\t\tif ( this[0] === window ) {", "\t\t\t\t$.blockUI( opts );", "\t\t\t\treturn this;", "\t\t\t}", "\t\t\tvar fullOpts = $.extend({}, $.blockUI.defaults, opts || {});", "\t\t\tthis.each(function() {", "\t\t\t\tvar $el = $(this);", "\t\t\t\tif (fullOpts.ignoreIfBlocked && $el.data('blockUI.isBlocked'))", "\t\t\t\t\treturn;", "\t\t\t\t$el.unblock({ fadeOut: 0 });", "\t\t\t});", "", "\t\t\treturn this.each(function() {", "\t\t\t\tif ($.css(this,'position') == 'static') {", "\t\t\t\t\tthis.style.position = 'relative';", "\t\t\t\t\t$(this).data('blockUI.static', true);", "\t\t\t\t}", "\t\t\t\tthis.style.zoom = 1; // force 'hasLayout' in ie", "\t\t\t\tinstall(this, opts);", "\t\t\t});", "\t\t};", "", "\t\t// plugin method for unblocking element content", "\t\t$.fn.unblock = function(opts) {", "\t\t\tif ( this[0] === window ) {", "\t\t\t\t$.unblockUI( opts );", "\t\t\t\treturn this;", "\t\t\t}", "\t\t\treturn this.each(function() {", "\t\t\t\tremove(this, opts);", "\t\t\t});", "\t\t};", "", "\t\t$.blockUI.version = 2.66; // 2nd generation blocking at no extra cost!", "", "\t\t// override these in your code to change the default behavior and style", "\t\t$.blockUI.defaults = {", "\t\t\t// message displayed when blocking (use null for no message)", "\t\t\tmessage:  '<h1>Please wait...</h1>',", "", "\t\t\ttitle: null,\t\t// title string; only used when theme == true", "\t\t\tdraggable: true,\t// only used when theme == true (requires jquery-ui.js to be loaded)", "", "\t\t\ttheme: false, // set to true to use with jQuery UI themes", "", "\t\t\t// styles for the message when blocking; if you wish to disable", "\t\t\t// these and use an external stylesheet then do this in your code:", "\t\t\t// $.blockUI.defaults.css = {};", "\t\t\tcss: {", "\t\t\t\tpadding:\t0,", "\t\t\t\tmargin:\t\t0,", "\t\t\t\twidth:\t\t'30%',", "\t\t\t\ttop:\t\t'40%',", "\t\t\t\tleft:\t\t'35%',", "\t\t\t\ttextAlign:\t'center',", "\t\t\t\tcolor:\t\t'#000',", "\t\t\t\tborder:\t\t'3px solid #aaa',", "\t\t\t\tbackgroundColor:'#fff',", "\t\t\t\tcursor:\t\t'wait'", "\t\t\t},", "", "\t\t\t// minimal style set used when themes are used", "\t\t\tthemedCSS: {", "\t\t\t\twidth:\t'30%',", "\t\t\t\ttop:\t'40%',", "\t\t\t\tleft:\t'35%'", "\t\t\t},", "", "\t\t\t// styles for the overlay", "\t\t\toverlayCSS:  {", "\t\t\t\tbackgroundColor:\t'#000',", "\t\t\t\topacity:\t\t\t0.6,", "\t\t\t\tcursor:\t\t\t\t'wait'", "\t\t\t},", "", "\t\t\t// style to replace wait cursor before unblocking to correct issue", "\t\t\t// of lingering wait cursor", "\t\t\tcursorReset: 'default',", "", "\t\t\t// styles applied when using $.growlUI", "\t\t\tgrowlCSS: {", "\t\t\t\twidth:\t\t'350px',", "\t\t\t\ttop:\t\t'10px',", "\t\t\t\tleft:\t\t'',", "\t\t\t\tright:\t\t'10px',", "\t\t\t\tborder:\t\t'none',", "\t\t\t\tpadding:\t'5px',", "\t\t\t\topacity:\t0.6,", "\t\t\t\tcursor:\t\t'default',", "\t\t\t\tcolor:\t\t'#fff',", "\t\t\t\tbackgroundColor: '#000',", "\t\t\t\t'-webkit-border-radius':'10px',", "\t\t\t\t'-moz-border-radius':\t'10px',", "\t\t\t\t'border-radius':\t\t'10px'", "\t\t\t},", "", "\t\t\t// IE issues: 'about:blank' fails on HTTPS and javascript:false is s-l-o-w", "\t\t\t// (hat tip to Jorge H. N. de Vasconcelos)", "\t\t\t/*jshint scripturl:true */", "\t\t\tiframeSrc: /^https/i.test(window.location.href || '') ? 'javascript:false' : 'about:blank',", "", "\t\t\t// force usage of iframe in non-IE browsers (handy for blocking applets)", "\t\t\tforceIframe: false,", "", "\t\t\t// z-index for the blocking overlay", "\t\t\tbaseZ: 1000,", "", "\t\t\t// set these to true to have the message automatically centered", "\t\t\tcenterX: true, // <-- only effects element blocking (page block controlled via css above)", "\t\t\tcenterY: true,", "", "\t\t\t// allow body element to be stetched in ie6; this makes blocking look better", "\t\t\t// on \"short\" pages.  disable if you wish to prevent changes to the body height", "\t\t\tallowBodyStretch: true,", "", "\t\t\t// enable if you want key and mouse events to be disabled for content that is blocked", "\t\t\tbindEvents: true,", "", "\t\t\t// be default blockUI will supress tab navigation from leaving blocking content", "\t\t\t// (if bindEvents is true)", "\t\t\tconstrainTabKey: true,", "", "\t\t\t// fadeIn time in millis; set to 0 to disable fadeIn on block", "\t\t\tfadeIn:  200,", "", "\t\t\t// fadeOut time in millis; set to 0 to disable fadeOut on unblock", "\t\t\tfadeOut:  400,", "", "\t\t\t// time in millis to wait before auto-unblocking; set to 0 to disable auto-unblock", "\t\t\ttimeout: 0,", "", "\t\t\t// disable if you don't want to show the overlay", "\t\t\tshowOverlay: true,", "", "\t\t\t// if true, focus will be placed in the first available input field when", "\t\t\t// page blocking", "\t\t\tfocusInput: true,", "", "            // elements that can receive focus", "            focusableElements: ':input:enabled:visible',", "", "\t\t\t// suppresses the use of overlay styles on FF/Linux (due to performance issues with opacity)", "\t\t\t// no longer needed in 2012", "\t\t\t// applyPlatformOpacityRules: true,", "", "\t\t\t// callback method invoked when fadeIn has completed and blocking message is visible", "\t\t\tonBlock: null,", "", "\t\t\t// callback method invoked when unblocking has completed; the callback is", "\t\t\t// passed the element that has been unblocked (which is the window object for page", "\t\t\t// blocks) and the options that were passed to the unblock call:", "\t\t\t//\tonUnblock(element, options)", "\t\t\tonUnblock: null,", "", "\t\t\t// callback method invoked when the overlay area is clicked.", "\t\t\t// setting this will turn the cursor to a pointer, otherwise cursor defined in overlayCss will be used.", "\t\t\tonOverlayClick: null,", "", "\t\t\t// don't ask; if you really must know: http://groups.google.com/group/jquery-en/browse_thread/thread/36640a8730503595/2f6a79a77a78e493#2f6a79a77a78e493", "\t\t\tquirksmodeOffsetHack: 4,", "", "\t\t\t// class name of the message block", "\t\t\tblockMsgClass: 'blockMsg',", "", "\t\t\t// if it is already blocked, then ignore it (don't unblock and reblock)", "\t\t\tignoreIfBlocked: false", "\t\t};", "", "\t\t// private data and functions follow...", "", "\t\tvar pageBlock = null;", "\t\tvar pageBlockEls = [];", "", "\t\tfunction install(el, opts) {", "\t\t\tvar css, themedCSS;", "\t\t\tvar full = (el == window);", "\t\t\tvar msg = (opts && opts.message !== undefined ? opts.message : undefined);", "\t\t\topts = $.extend({}, $.blockUI.defaults, opts || {});", "", "\t\t\tif (opts.ignoreIfBlocked && $(el).data('blockUI.isBlocked'))", "\t\t\t\treturn;", "", "\t\t\topts.overlayCSS = $.extend({}, $.blockUI.defaults.overlayCSS, opts.overlayCSS || {});", "\t\t\tcss = $.extend({}, $.blockUI.defaults.css, opts.css || {});", "\t\t\tif (opts.onOverlayClick)", "\t\t\t\topts.overlayCSS.cursor = 'pointer';", "", "\t\t\tthemedCSS = $.extend({}, $.blockUI.defaults.themedCSS, opts.themedCSS || {});", "\t\t\tmsg = msg === undefined ? opts.message : msg;", "", "\t\t\t// remove the current block (if there is one)", "\t\t\tif (full && pageBlock)", "\t\t\t\tremove(window, {fadeOut:0});", "", "\t\t\t// if an existing element is being used as the blocking content then we capture", "\t\t\t// its current place in the DOM (and current display style) so we can restore", "\t\t\t// it when we unblock", "\t\t\tif (msg && typeof msg != 'string' && (msg.parentNode || msg.jquery)) {", "\t\t\t\tvar node = msg.jquery ? msg[0] : msg;", "\t\t\t\tvar data = {};", "\t\t\t\t$(el).data('blockUI.history', data);", "\t\t\t\tdata.el = node;", "\t\t\t\tdata.parent = node.parentNode;", "\t\t\t\tdata.display = node.style.display;", "\t\t\t\tdata.position = node.style.position;", "\t\t\t\tif (data.parent)", "\t\t\t\t\tdata.parent.removeChild(node);", "\t\t\t}", "", "\t\t\t$(el).data('blockUI.onUnblock', opts.onUnblock);", "\t\t\tvar z = opts.baseZ;", "", "\t\t\t// blockUI uses 3 layers for blocking, for simplicity they are all used on every platform;", "\t\t\t// layer1 is the iframe layer which is used to supress bleed through of underlying content", "\t\t\t// layer2 is the overlay layer which has opacity and a wait cursor (by default)", "\t\t\t// layer3 is the message content that is displayed while blocking", "\t\t\tvar lyr1, lyr2, lyr3, s;", "\t\t\tif (msie || opts.forceIframe)", "\t\t\t\tlyr1 = $('<iframe class=\"blockUI\" style=\"z-index:'+ (z++) +';display:none;border:none;margin:0;padding:0;position:absolute;width:100%;height:100%;top:0;left:0\" src=\"'+opts.iframeSrc+'\"></iframe>');", "\t\t\telse", "\t\t\t\tlyr1 = $('<div class=\"blockUI\" style=\"display:none\"></div>');", "", "\t\t\tif (opts.theme)", "\t\t\t\tlyr2 = $('<div class=\"blockUI blockOverlay ui-widget-overlay\" style=\"z-index:'+ (z++) +';display:none\"></div>');", "\t\t\telse", "\t\t\t\tlyr2 = $('<div class=\"blockUI blockOverlay\" style=\"z-index:'+ (z++) +';display:none;border:none;margin:0;padding:0;width:100%;height:100%;top:0;left:0\"></div>');", "", "\t\t\tif (opts.theme && full) {", "\t\t\t\ts = '<div class=\"blockUI ' + opts.blockMsgClass + ' blockPage ui-dialog ui-widget ui-corner-all\" style=\"z-index:'+(z+10)+';display:none;position:fixed\">';", "\t\t\t\tif ( opts.title ) {", "\t\t\t\t\ts += '<div class=\"ui-widget-header ui-dialog-titlebar ui-corner-all blockTitle\">'+(opts.title || '&nbsp;')+'</div>';", "\t\t\t\t}", "\t\t\t\ts += '<div class=\"ui-widget-content ui-dialog-content\"></div>';", "\t\t\t\ts += '</div>';", "\t\t\t}", "\t\t\telse if (opts.theme) {", "\t\t\t\ts = '<div class=\"blockUI ' + opts.blockMsgClass + ' blockElement ui-dialog ui-widget ui-corner-all\" style=\"z-index:'+(z+10)+';display:none;position:absolute\">';", "\t\t\t\tif ( opts.title ) {", "\t\t\t\t\ts += '<div class=\"ui-widget-header ui-dialog-titlebar ui-corner-all blockTitle\">'+(opts.title || '&nbsp;')+'</div>';", "\t\t\t\t}", "\t\t\t\ts += '<div class=\"ui-widget-content ui-dialog-content\"></div>';", "\t\t\t\ts += '</div>';", "\t\t\t}", "\t\t\telse if (full) {", "\t\t\t\ts = '<div class=\"blockUI ' + opts.blockMsgClass + ' blockPage\" style=\"z-index:'+(z+10)+';display:none;position:fixed\"></div>';", "\t\t\t}", "\t\t\telse {", "\t\t\t\ts = '<div class=\"blockUI ' + opts.blockMsgClass + ' blockElement\" style=\"z-index:'+(z+10)+';display:none;position:absolute\"></div>';", "\t\t\t}", "\t\t\tlyr3 = $(s);", "", "\t\t\t// if we have a message, style it", "\t\t\tif (msg) {", "\t\t\t\tif (opts.theme) {", "\t\t\t\t\tlyr3.css(themedCSS);", "\t\t\t\t\tlyr3.addClass('ui-widget-content');", "\t\t\t\t}", "\t\t\t\telse", "\t\t\t\t\tlyr3.css(css);", "\t\t\t}", "", "\t\t\t// style the overlay", "\t\t\tif (!opts.theme /*&& (!opts.applyPlatformOpacityRules)*/)", "\t\t\t\tlyr2.css(opts.overlayCSS);", "\t\t\tlyr2.css('position', full ? 'fixed' : 'absolute');", "", "\t\t\t// make iframe layer transparent in IE", "\t\t\tif (msie || opts.forceIframe)", "\t\t\t\tlyr1.css('opacity',0.0);", "", "\t\t\t//$([lyr1[0],lyr2[0],lyr3[0]]).appendTo(full ? 'body' : el);", "\t\t\tvar layers = [lyr1,lyr2,lyr3], $par = full ? $('body') : $(el);", "\t\t\t$.each(layers, function() {", "\t\t\t\tthis.appendTo($par);", "\t\t\t});", "", "\t\t\tif (opts.theme && opts.draggable && $.fn.draggable) {", "\t\t\t\tlyr3.draggable({", "\t\t\t\t\thandle: '.ui-dialog-titlebar',", "\t\t\t\t\tcancel: 'li'", "\t\t\t\t});", "\t\t\t}", "", "\t\t\t// ie7 must use absolute positioning in quirks mode and to account for activex issues (when scrolling)", "\t\t\tvar expr = setExpr && (!$.support.boxModel || $('object,embed', full ? null : el).length > 0);", "\t\t\tif (ie6 || expr) {", "\t\t\t\t// give body 100% height", "\t\t\t\tif (full && opts.allowBodyStretch && $.support.boxModel)", "\t\t\t\t\t$('html,body').css('height','100%');", "", "\t\t\t\t// fix ie6 issue when blocked element has a border width", "\t\t\t\tif ((ie6 || !$.support.boxModel) && !full) {", "\t\t\t\t\tvar t = sz(el,'borderTopWidth'), l = sz(el,'borderLeftWidth');", "\t\t\t\t\tvar fixT = t ? '(0 - '+t+')' : 0;", "\t\t\t\t\tvar fixL = l ? '(0 - '+l+')' : 0;", "\t\t\t\t}", "", "\t\t\t\t// simulate fixed position", "\t\t\t\t$.each(layers, function(i,o) {", "\t\t\t\t\tvar s = o[0].style;", "\t\t\t\t\ts.position = 'absolute';", "\t\t\t\t\tif (i < 2) {", "\t\t\t\t\t\tif (full)", "\t\t\t\t\t\t\ts.setExpression('height','Math.max(document.body.scrollHeight, document.body.offsetHeight) - (jQuery.support.boxModel?0:'+opts.quirksmodeOffsetHack+') + \"px\"');", "\t\t\t\t\t\telse", "\t\t\t\t\t\t\ts.setExpression('height','this.parentNode.offsetHeight + \"px\"');", "\t\t\t\t\t\tif (full)", "\t\t\t\t\t\t\ts.setExpression('width','jQuery.support.boxModel && document.documentElement.clientWidth || document.body.clientWidth + \"px\"');", "\t\t\t\t\t\telse", "\t\t\t\t\t\t\ts.setExpression('width','this.parentNode.offsetWidth + \"px\"');", "\t\t\t\t\t\tif (fixL) s.setExpression('left', fixL);", "\t\t\t\t\t\tif (fixT) s.setExpression('top', fixT);", "\t\t\t\t\t}", "\t\t\t\t\telse if (opts.centerY) {", "\t\t\t\t\t\tif (full) s.setExpression('top','(document.documentElement.clientHeight || document.body.clientHeight) / 2 - (this.offsetHeight / 2) + (blah = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + \"px\"');", "\t\t\t\t\t\ts.marginTop = 0;", "\t\t\t\t\t}", "\t\t\t\t\telse if (!opts.centerY && full) {", "\t\t\t\t\t\tvar top = (opts.css && opts.css.top) ? parseInt(opts.css.top, 10) : 0;", "\t\t\t\t\t\tvar expression = '((document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + '+top+') + \"px\"';", "\t\t\t\t\t\ts.setExpression('top',expression);", "\t\t\t\t\t}", "\t\t\t\t});", "\t\t\t}", "", "\t\t\t// show the message", "\t\t\tif (msg) {", "\t\t\t\tif (opts.theme)", "\t\t\t\t\tlyr3.find('.ui-widget-content').append(msg);", "\t\t\t\telse", "\t\t\t\t\tlyr3.append(msg);", "\t\t\t\tif (msg.jquery || msg.nodeType)", "\t\t\t\t\t$(msg).show();", "\t\t\t}", "", "\t\t\tif ((msie || opts.forceIframe) && opts.showOverlay)", "\t\t\t\tlyr1.show(); // opacity is zero", "\t\t\tif (opts.fadeIn) {", "\t\t\t\tvar cb = opts.onBlock ? opts.onBlock : noOp;", "\t\t\t\tvar cb1 = (opts.showOverlay && !msg) ? cb : noOp;", "\t\t\t\tvar cb2 = msg ? cb : noOp;", "\t\t\t\tif (opts.showOverlay)", "\t\t\t\t\tlyr2._fadeIn(opts.fadeIn, cb1);", "\t\t\t\tif (msg)", "\t\t\t\t\tlyr3._fadeIn(opts.fadeIn, cb2);", "\t\t\t}", "\t\t\telse {", "\t\t\t\tif (opts.showOverlay)", "\t\t\t\t\tlyr2.show();", "\t\t\t\tif (msg)", "\t\t\t\t\tlyr3.show();", "\t\t\t\tif (opts.onBlock)", "\t\t\t\t\topts.onBlock();", "\t\t\t}", "", "\t\t\t// bind key and mouse events", "\t\t\tbind(1, el, opts);", "", "\t\t\tif (full) {", "\t\t\t\tpageBlock = lyr3[0];", "\t\t\t\tpageBlockEls = $(opts.focusableElements,pageBlock);", "\t\t\t\tif (opts.focusInput)", "\t\t\t\t\tsetTimeout(focus, 20);", "\t\t\t}", "\t\t\telse", "\t\t\t\tcenter(lyr3[0], opts.centerX, opts.centerY);", "", "\t\t\tif (opts.timeout) {", "\t\t\t\t// auto-unblock", "\t\t\t\tvar to = setTimeout(function() {", "\t\t\t\t\tif (full)", "\t\t\t\t\t\t$.unblockUI(opts);", "\t\t\t\t\telse", "\t\t\t\t\t\t$(el).unblock(opts);", "\t\t\t\t}, opts.timeout);", "\t\t\t\t$(el).data('blockUI.timeout', to);", "\t\t\t}", "\t\t}", "", "\t\t// remove the block", "\t\tfunction remove(el, opts) {", "\t\t\tvar count;", "\t\t\tvar full = (el == window);", "\t\t\tvar $el = $(el);", "\t\t\tvar data = $el.data('blockUI.history');", "\t\t\tvar to = $el.data('blockUI.timeout');", "\t\t\tif (to) {", "\t\t\t\tclearTimeout(to);", "\t\t\t\t$el.removeData('blockUI.timeout');", "\t\t\t}", "\t\t\topts = $.extend({}, $.blockUI.defaults, opts || {});", "\t\t\tbind(0, el, opts); // unbind events", "", "\t\t\tif (opts.onUnblock === null) {", "\t\t\t\topts.onUnblock = $el.data('blockUI.onUnblock');", "\t\t\t\t$el.removeData('blockUI.onUnblock');", "\t\t\t}", "", "\t\t\tvar els;", "\t\t\tif (full) // crazy selector to handle odd field errors in ie6/7", "\t\t\t\tels = $('body').children().filter('.blockUI').add('body > .blockUI');", "\t\t\telse", "\t\t\t\tels = $el.find('>.blockUI');", "", "\t\t\t// fix cursor issue", "\t\t\tif ( opts.cursorReset ) {", "\t\t\t\tif ( els.length > 1 )", "\t\t\t\t\tels[1].style.cursor = opts.cursorReset;", "\t\t\t\tif ( els.length > 2 )", "\t\t\t\t\tels[2].style.cursor = opts.cursorReset;", "\t\t\t}", "", "\t\t\tif (full)", "\t\t\t\tpageBlock = pageBlockEls = null;", "", "\t\t\tif (opts.fadeOut) {", "\t\t\t\tcount = els.length;", "\t\t\t\tels.stop().fadeOut(opts.fadeOut, function() {", "\t\t\t\t\tif ( --count === 0)", "\t\t\t\t\t\treset(els,data,opts,el);", "\t\t\t\t});", "\t\t\t}", "\t\t\telse", "\t\t\t\treset(els, data, opts, el);", "\t\t}", "", "\t\t// move blocking element back into the DOM where it started", "\t\tfunction reset(els,data,opts,el) {", "\t\t\tvar $el = $(el);", "\t\t\tif ( $el.data('blockUI.isBlocked') )", "\t\t\t\treturn;", "", "\t\t\tels.each(function(i,o) {", "\t\t\t\t// remove via DOM calls so we don't lose event handlers", "\t\t\t\tif (this.parentNode)", "\t\t\t\t\tthis.parentNode.removeChild(this);", "\t\t\t});", "", "\t\t\tif (data && data.el) {", "\t\t\t\tdata.el.style.display = data.display;", "\t\t\t\tdata.el.style.position = data.position;", "\t\t\t\tif (data.parent)", "\t\t\t\t\tdata.parent.appendChild(data.el);", "\t\t\t\t$el.removeData('blockUI.history');", "\t\t\t}", "", "\t\t\tif ($el.data('blockUI.static')) {", "\t\t\t\t$el.css('position', 'static'); // #22", "\t\t\t}", "", "\t\t\tif (typeof opts.onUnblock == 'function')", "\t\t\t\topts.onUnblock(el,opts);", "", "\t\t\t// fix issue in Safari 6 where block artifacts remain until reflow", "\t\t\tvar body = $(document.body), w = body.width(), cssW = body[0].style.width;", "\t\t\tbody.width(w-1).width(w);", "\t\t\tbody[0].style.width = cssW;", "\t\t}", "", "\t\t// bind/unbind the handler", "\t\tfunction bind(b, el, opts) {", "\t\t\tvar full = el == window, $el = $(el);", "", "\t\t\t// don't bother unbinding if there is nothing to unbind", "\t\t\tif (!b && (full && !pageBlock || !full && !$el.data('blockUI.isBlocked')))", "\t\t\t\treturn;", "", "\t\t\t$el.data('blockUI.isBlocked', b);", "", "\t\t\t// don't bind events when overlay is not in use or if bindEvents is false", "\t\t\tif (!full || !opts.bindEvents || (b && !opts.showOverlay))", "\t\t\t\treturn;", "", "\t\t\t// bind anchors and inputs for mouse and key events", "\t\t\tvar events = 'mousedown mouseup keydown keypress keyup touchstart touchend touchmove';", "\t\t\tif (b)", "\t\t\t\t$(document).bind(events, opts, handler);", "\t\t\telse", "\t\t\t\t$(document).unbind(events, handler);", "", "\t\t// former impl...", "\t\t//\t\tvar $e = $('a,:input');", "\t\t//\t\tb ? $e.bind(events, opts, handler) : $e.unbind(events, handler);", "\t\t}", "", "\t\t// event handler to suppress keyboard/mouse events when blocking", "\t\tfunction handler(e) {", "\t\t\t// allow tab navigation (conditionally)", "\t\t\tif (e.type === 'keydown' && e.keyCode && e.keyCode == 9) {", "\t\t\t\tif (pageBlock && e.data.constrainTabKey) {", "\t\t\t\t\tvar els = pageBlockEls;", "\t\t\t\t\tvar fwd = !e.shiftKey && e.target === els[els.length-1];", "\t\t\t\t\tvar back = e.shiftKey && e.target === els[0];", "\t\t\t\t\tif (fwd || back) {", "\t\t\t\t\t\tsetTimeout(function(){focus(back);},10);", "\t\t\t\t\t\treturn false;", "\t\t\t\t\t}", "\t\t\t\t}", "\t\t\t}", "\t\t\tvar opts = e.data;", "\t\t\tvar target = $(e.target);", "\t\t\tif (target.hasClass('blockOverlay') && opts.onOverlayClick)", "\t\t\t\topts.onOverlayClick(e);", "", "\t\t\t// allow events within the message content", "\t\t\tif (target.parents('div.' + opts.blockMsgClass).length > 0)", "\t\t\t\treturn true;", "", "\t\t\t// allow events for content that is not being blocked", "\t\t\treturn target.parents().children().filter('div.blockUI').length === 0;", "\t\t}", "", "\t\tfunction focus(back) {", "\t\t\tif (!pageBlockEls)", "\t\t\t\treturn;", "\t\t\tvar e = pageBlockEls[back===true ? pageBlockEls.length-1 : 0];", "\t\t\tif (e)", "\t\t\t\te.focus();", "\t\t}", "", "\t\tfunction center(el, x, y) {", "\t\t\tvar p = el.parentNode, s = el.style;", "\t\t\tvar l = ((p.offsetWidth - el.offsetWidth)/2) - sz(p,'borderLeftWidth');", "\t\t\tvar t = ((p.offsetHeight - el.offsetHeight)/2) - sz(p,'borderTopWidth');", "\t\t\tif (x) s.left = l > 0 ? (l+'px') : '0';", "\t\t\tif (y) s.top  = t > 0 ? (t+'px') : '0';", "\t\t}", "", "\t\tfunction sz(el, p) {", "\t\t\treturn parseInt($.css(el,p),10)||0;", "\t\t}", "", "\t}", "", "", "\t/*global define:true */", "\tif (typeof define === 'function' && define.amd && define.amd.jQuery) {", "\t\tdefine(['jquery'], setup);", "\t} else {", "\t\tsetup(jQuery);", "\t}", "", "})();"]}, {"lines": [";(function(factory) {", "    if (typeof define === \"function\" && define.amd) {", "        // AMD anonymous module", "        define([\"knockout\", \"jquery\", \"jquery.ui.sortable\"], factory);"]}, {"lines": ["    } else {", "        // No module loader (plain <script> tag) - put directly in global namespace", "        factory(window.ko, jQuery);", "    }", "})(function(ko, $) {", "    var ITEMKEY = \"ko_sortItem\",", "        INDEXKEY = \"ko_sourceIndex\",", "        LISTKEY = \"ko_sortList\",", "        PARENTKEY = \"ko_parentList\",", "        DRAGKEY = \"ko_dragItem\",", "        unwrap = ko.utils.unwrapObservable,", "        dataGet = ko.utils.domData.get,"]}, {"lines": [""]}, {"lines": ["    var addMetaDataAfterRender = function(elements, data) {", "        ko.utils.arrayForEach(elements, function(element) {", "            if (element.nodeType === 1) {", "                dataSet(element, ITEMKEY, data);", "                dataSet(element, PARENTKEY, dataGet(element.parentNode, LISTKEY));", "            }", "        });", "    };", "", "    //prepare the proper options for the template binding", "    var prepareTemplateOptions = function(valueAccessor, dataName) {", "        var result = {},", "            options = unwrap(valueAccessor()) || {},", "            actualAfterRender;", "", "        //build our options to pass to the template engine", "        if (options.data) {", "            result[dataName] = options.data;", "            result.name = options.template;", "        } else {", "            result[dataName] = valueAccessor();", "        }", "", "        ko.utils.arrayForEach([\"afterAdd\", \"afterRender\", \"as\", \"beforeRemove\", \"includeDestroyed\", \"templateEngine\", \"templateOptions\"], function (option) {", "            result[option] = options[option] || ko.bindingHandlers.sortable[option];", "        });", ""]}, {"lines": ["        if (dataName === \"foreach\") {", "            if (result.afterRender) {", "                //wrap the existing function, if it was passed", "                actualAfterRender = result.afterRender;", "                result.afterRender = function(element, data) {", "                    addMetaDataAfterRender.call(data, element, data);", "                    actualAfterRender.call(data, element, data);", "                };", "            } else {", "                result.afterRender = addMetaDataAfterRender;", "            }", "        }", "", "        //return options to pass to the template binding", "        return result;", "    };", "", "    var updateIndexFromDestroyedItems = function(index, items) {", "        var unwrapped = unwrap(items);", "", "        if (unwrapped) {", "            for (var i = 0; i < index; i++) {", "                //add one for every destroyed item we find before the targetIndex in the target array", "                if (unwrapped[i] && unwrap(unwrapped[i]._destroy)) {", "                    index++;", "                }", "            }", "        }", "", "        return index;", "    };", ""]}, {"lines": ["    //connect items with observableArrays", "    ko.bindingHandlers.sortable = {", "        init: function(element, valueAccessor, allBindingsAccessor, data, context) {", "            var $element = $(element),", "                value = unwrap(valueAccessor()) || {},", "                templateOptions = prepareTemplateOptions(valueAccessor, \"foreach\"),", "                sortable = {},", "                startActual, updateActual;", ""]}, {"lines": ["", "            //build a new object that has the global options with overrides from the binding", "            $.extend(true, sortable, ko.bindingHandlers.sortable);", "            if (value.options && sortable.options) {", "                ko.utils.extend(sortable.options, value.options);", "                delete value.options;", "            }", "            ko.utils.extend(sortable, value);", "", "            //if allowDrop is an observable or a function, then execute it in a computed observable", "            if (sortable.connectClass && (ko.isObservable(sortable.allowDrop) || typeof sortable.allowDrop == \"function\")) {", "                ko.computed({", "                    read: function() {", "                        var value = unwrap(sortable.allowDrop),", "                            shouldAdd = typeof value == \"function\" ? value.call(this, templateOptions.foreach) : value;", "                        ko.utils.toggleDomNodeCssClass(element, sortable.connectClass, shouldAdd);", "                    },", "                    disposeWhenNodeIsRemoved: element", "                }, this);", "            } else {", "                ko.utils.toggleDomNodeCssClass(element, sortable.connectClass, sortable.allowDrop);", "            }", "", "            //wrap the template binding", "            ko.bindingHandlers.template.init(element, function() { return templateOptions; }, allBindingsAccessor, data, context);", "", "            //keep a reference to start/update functions that might have been passed in", "            startActual = sortable.options.start;", "            updateActual = sortable.options.update;", "", "            //initialize sortable binding after template binding has rendered in update function", "            var createTimeout = setTimeout(function() {", "                var dragItem;", "                $element.sortable(ko.utils.extend(sortable.options, {", "                    start: function(event, ui) {", "                        //track original index", "                        var el = ui.item[0];", "                        dataSet(el, INDEXKEY, ko.utils.arrayIndexOf(ui.item.parent().children(), el));", "", "                        //make sure that fields have a chance to update model", "                        ui.item.find(\"input:focus\").change();", "                        if (startActual) {", "                            startActual.apply(this, arguments);", "                        }", "                    },", "                    receive: function(event, ui) {", "                        dragItem = dataGet(ui.item[0], DRAGKEY);", "                        if (dragItem) {", "                            //copy the model item, if a clone option is provided", "                            if (dragItem.clone) {", "                                dragItem = dragItem.clone();", "                            }", "", "                            //configure a handler to potentially manipulate item before drop", "                            if (sortable.dragged) {", "                                dragItem = sortable.dragged.call(this, dragItem, event, ui) || dragItem;", "                            }", "                        }", "                    },", "                    update: function(event, ui) {", "                        var sourceParent, targetParent, sourceIndex, targetIndex, arg,", "                            el = ui.item[0],", "                            parentEl = ui.item.parent()[0],", "                            item = dataGet(el, ITEMKEY) || dragItem;", "", "                        dragItem = null;", "", "                        //make sure that moves only run once, as update fires on multiple containers"]}, {"lines": ["                            //identify parents", "                            sourceParent = dataGet(el, PARENTKEY);", "                            sourceIndex = dataGet(el, INDEXKEY);", "                            targetParent = dataGet(el.parentNode, LISTKEY);", "                            targetIndex = ko.utils.arrayIndexOf(ui.item.parent().children(), el);", "", "                            //take destroyed items into consideration", "                            if (!templateOptions.includeDestroyed) {", "                                sourceIndex = updateIndexFromDestroyedItems(sourceIndex, sourceParent);", "                                targetIndex = updateIndexFromDestroyedItems(targetIndex, targetParent);", "                            }", ""]}, {"lines": ["                            if (sortable.beforeMove || sortable.afterMove) {", "                                arg = {", "                                    item: item,", "                                    sourceParent: sourceParent,", "                                    sourceParentNode: sourceParent && ui.sender || el.parentNode,", "                                    sourceIndex: sourceIndex,", "                                    targetParent: targetParent,", "                                    targetIndex: targetIndex,", "                                    cancelDrop: false", "                                };"]}, {"lines": ["                            }", ""]}, {"lines": [""]}, {"lines": ["                            }", ""]}, {"lines": ["                            if (targetIndex >= 0) {", "                                if (sourceParent) {", "                                    sourceParent.splice(sourceIndex, 1);", "", "                                    //if using deferred updates plugin, force updates", "                                    if (ko.processAllDeferredBindingUpdates) {", "                                        ko.processAllDeferredBindingUpdates();", "                                    }", "                                }", "", "                                targetParent.splice(targetIndex, 0, item);", "                            }", "", "                            //rendering is handled by manipulating the observableArray; ignore dropped element", "                            dataSet(el, ITEMKEY, null);"]}, {"lines": ["", "                            //if using deferred updates plugin, force updates", "                            if (ko.processAllDeferredBindingUpdates) {", "                                ko.processAllDeferredBindingUpdates();", "                            }", "", "                            //allow binding to accept a function to execute after moving the item", "                            if (sortable.afterMove) {", "                                sortable.afterMove.call(this, arg, event, ui);", "                            }", "                        }", "", "                        if (updateActual) {", "                            updateActual.apply(this, arguments);", "                        }", "                    },", "                    connectWith: sortable.connectClass ? \".\" + sortable.connectClass : false", "                }));", "", "                //handle enabling/disabling sorting", "                if (sortable.isEnabled !== undefined) {", "                    ko.computed({", "                        read: function() {", "                            $element.sortable(unwrap(sortable.isEnabled) ? \"enable\" : \"disable\");", "                        },", "                        disposeWhenNodeIsRemoved: element", "                    });", "                }", "            }, 0);", "", "            //handle disposal", "            ko.utils.domNodeDisposal.addDisposeCallback(element, function() {", "                //only call destroy if sortable has been created", "                if ($element.data(\"ui-sortable\") || $element.data(\"sortable\")) {", "                    $element.sortable(\"destroy\");", "                }", "", "                //do not create the sortable if the element has been removed from DOM", "                clearTimeout(createTimeout);", "            });", "", "            return { 'controlsDescendantBindings': true };", "        },", "        update: function(element, valueAccessor, allBindingsAccessor, data, context) {", "            var templateOptions = prepareTemplateOptions(valueAccessor, \"foreach\");", "", "            //attach meta-data", "            dataSet(element, LISTKEY, templateOptions.foreach);", "", "            //call template binding's update with correct options", "            ko.bindingHandlers.template.update(element, function() { return templateOptions; }, allBindingsAccessor, data, context);", "        },", "        connectClass: 'ko_container',", "        allowDrop: true,", "        afterMove: null,", "        beforeMove: null,", "        options: {}", "    };", "", "    //create a draggable that is appropriate for dropping into a sortable", "    ko.bindingHandlers.draggable = {", "        init: function(element, valueAccessor, allBindingsAccessor, data, context) {", "            var value = unwrap(valueAccessor()) || {},", "                options = value.options || {},", "                draggableOptions = ko.utils.extend({}, ko.bindingHandlers.draggable.options),", "                templateOptions = prepareTemplateOptions(valueAccessor, \"data\"),", "                connectClass = value.connectClass || ko.bindingHandlers.draggable.connectClass,", "                isEnabled = value.isEnabled !== undefined ? value.isEnabled : ko.bindingHandlers.draggable.isEnabled;", ""]}, {"lines": ["", "            //set meta-data", "            dataSet(element, DRAGKEY, value);", "", "            //override global options with override options passed in", "            ko.utils.extend(draggableOptions, options);", "", "            //setup connection to a sortable", "            draggableOptions.connectToSortable = connectClass ? \".\" + connectClass : false;", "", "            //initialize draggable", "            $(element).draggable(draggableOptions);", "", "            //handle enabling/disabling sorting", "            if (isEnabled !== undefined) {", "                ko.computed({", "                    read: function() {", "                        $(element).draggable(unwrap(isEnabled) ? \"enable\" : \"disable\");", "                    },", "                    disposeWhenNodeIsRemoved: element", "                });", "            }", "", "            return ko.bindingHandlers.template.init(element, function() { return templateOptions; }, allBindingsAccessor, data, context);", "        },", "        update: function(element, valueAccessor, allBindingsAccessor, data, context) {", "            var templateOptions = prepareTemplateOptions(valueAccessor, \"data\");", "", "            return ko.bindingHandlers.template.update(element, function() { return templateOptions; }, allBindingsAccessor, data, context);", "        },", "        connectClass: ko.bindingHandlers.sortable.connectClass,", "        options: {"]}, {"lines": ["        }", "    };", ""]}, {"lines": ["/*============================================================================="]}, {"lines": ["===============================================================================", "*/"]}, {"lines": ["<% import json %>"]}, {"lines": [""]}, {"lines": ["    ${includes_top()}"]}, {"lines": ["    <link href='//fonts.googleapis.com/css?family=Carrois+Gothic|Inika|Patua+One' rel='stylesheet' type='text/css'>", ""]}, {"lines": ["            <script>"]}, {"lines": ["            (function() {", "                var s = document.getElementsByTagName('script')[0]"]}, {"lines": ["                p.async = 'async';", "                p.src = '//rum-static.pingdom.net/prum.min.js';", "                s.parentNode.insertBefore(p, s);", "            })();", "            </script>"]}, {"lines": [""]}, {"lines": ["                    % if user_id:"]}, {"lines": ["                    % endif", "                    % if node:"]}, {"lines": ["                        cvars.push([4, \"Tags\", ${ json.dumps(','.join(node.get('tags', []))) }, \"page\"]);"]}, {"lines": ["                    % endif", "                    // Note: Use cookies for global site ID; only one cookie", "                    // will be used, so this won't overflow uwsgi header", "                    // buffer."]}, {"lines": [""]}, {"lines": ["<%def name=\"includes_top()\">", ""]}, {"lines": ["    <!--[if lt IE 9]>"]}, {"lines": ["    <![endif]-->", "", "    <!-- Le styles -->"]}, {"lines": [""]}, {"lines": ["</%def>"]}, {"lines": ["    <div class='row'>"]}, {"lines": ["            <p>${message_long}</p>"]}, {"lines": ["        </div>", "    </div>", "</div>"]}, {"lines": ["", "<%def name=\"javascript_bottom()\">"]}, {"lines": ["    ${parent.javascript_bottom()}"]}, {"lines": ["added", "<span data-bind=\"html: displayContributors\"></span>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: $parent.nodeUrl}, text: $parent.nodeTitle\"></a>"]}, {"lines": ["removed"]}, {"lines": ["<span data-bind=\"html: displayContributors\"></span>", "as contributor(s) from"]}, {"lines": ["<script type=\"text/html\" id=\"contributors_reordered\">", "reordered contributors for"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>", "", "<script type=\"text/html\" id=\"permissions_updated\">", "changed permissions for"]}, {"lines": ["<script type=\"text/html\" id=\"node_forked\">"]}, {"lines": ["<script type=\"text/html\" id=\"edit_description\">"]}, {"lines": ["<script type=\"text/html\" id=\"pointer_created\">", "created a link to <span data-bind=\"text: params.pointer.category\"></span>", "<a class=\"log-node-title-link overflow\" data-bind=\"text: params.pointer.title, attr: {href: params.pointer.url}\"></a>"]}, {"lines": ["<script type=\"text/html\" id=\"pointer_removed\">", "removed a link to <span data-bind=\"text: params.pointer.category\"></span>", "<a class=\"log-node-title-link overflow\" data-bind=\"text: params.pointer.title, attr: {href: params.pointer.url}\"></a>"]}, {"lines": ["<script type=\"text/html\" id=\"pointer_forked\">", "forked a link to <span data-bind=\"text: params.pointer.category\"></span>", "<a class=\"log-node-title-link overflow\" data-bind=\"text: params.pointer.title, attr: {href: params.pointer.url}\"></a>"]}, {"lines": [""]}, {"lines": ["<script type=\"text/html\" id=\"addon_added\">", "added addon <span data-bind=\"text: params.addon\"></span>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["</script>", ""]}, {"lines": ["<script type=\"text/html\" id=\"addon_removed\">", "removed addon <span data-bind=\"text: params.addon\"></span>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["</script>"]}, {"lines": ["", "<script type=\"text/html\" id=\"comment_added\">", "added a comment"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>", "", "<script type=\"text/html\" id=\"comment_updated\">", "updated a comment"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>", "", "<script type=\"text/html\" id=\"comment_removed\">", "deleted a comment"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>", "</script>"]}, {"lines": ["", "<script type=\"text/html\" id=\"made_contributor_visible\">", "made contributor", "<span data-bind=\"html: displayContributors\"></span>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: $parent.nodeUrl}, text: $parent.nodeTitle\"></a>", "</script>", "", "<script type=\"text/html\" id=\"made_contributor_invisible\">", "made contributor", "<span data-bind=\"html: displayContributors\"></span>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: $parent.nodeUrl}, text: $parent.nodeTitle\"></a>", "</script>"]}, {"lines": ["<script type=\"text/html\" id=\"external_ids_added\">", "created external identifiers", "<a data-bind=\"attr.href: 'http://ezid.cdlib.org/id/doi:' + params.identifiers.doi, text: 'doi:' + params.identifiers.doi\"></a> and"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: $parent.nodeUrl}, text: $parent.nodeTitle\"></a>", "</script>"]}, {"lines": ["<h1>Nodes</h1>", "% if nodes:"]}, {"lines": ["% else:"]}, {"lines": ["% endif"]}, {"lines": [""]}, {"lines": ["Hello ${fullname},", "", "You recently tried to create a project on the Open Science Framework via email, but the conference you attempted to submit to is not currently accepting new submissions. For a list of conferences, see [ ${presentations_url} ].", "", "Sincerely yours,", "", "The OSF Robot"]}, {"lines": ["Dear ${user.given_name},", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "Overall, we expect this to provide a more intuitive experience when thinking about permissions within the OSF. Administrators can view the contents of their projects, even if they are not directly contributing to all components. Also, this is an important change because administrators can register projects (i.e., create permanent, uneditable versions). It is important that administrators know what they are registering.", "", "How will this affect you? If you are a contributor on a component of a project and do not want the administrator of that project to see the content, then you may wish to delete the component and move the content to a new project in which you are the administrator.", ""]}, {"lines": ["", "Regards,", "", "The OSF Team", "Center for Open Science"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    <div class=\"cp-bar\"></div>", "", "    <div id=\"comments\" class=\"cp-sidebar\">"]}, {"lines": [""]}, {"lines": ["            <form class=\"form\">", "                <div class=\"form-group\">"]}, {"lines": ["                    <textarea class=\"form-control\" placeholder=\"Add a comment\" data-bind=\"value: replyContent, valueUpdate: 'input', attr: {maxlength: $root.MAXLENGTH}\"></textarea>"]}, {"lines": ["                </div>"]}, {"lines": ["                    <span data-bind=\"text: replyErrorMessage\" class=\"comment-error\"></span>"]}, {"lines": ["                </div>"]}, {"lines": ["                <div class=\"comment-error\">{{errorMessage}}</div>"]}, {"lines": ["            </form>", "        </div>"]}, {"lines": ["    </div>", "", "</div>", "", "<script type=\"text/html\" id=\"commentTemplate\">"]}, {"lines": ["", "        <div class=\"comment-body\">", ""]}, {"lines": ["            <div data-bind=\"if: isDeleted\">", "                <div>", "                    <span data-bind=\"if: hasChildren\">", "                        <i data-bind=\"css: toggleIcon, click: toggle\"></i>"]}, {"lines": ["                    </span>"]}, {"lines": ["                    Comment deleted", "                </div>", "                <div data-bind=\"if: canEdit\">", "                    <a data-bind=\"click: startUndelete\">Restore</a>", "                    <div data-bind=\"if: undeleting\">", "                        <a class=\"btn btn-default btn-sm\" data-bind=\"click: submitUndelete\">Submit</a>", "                        <a class=\"btn btn-default btn-sm\" data-bind=\"click: cancelUndelete\">Cancel</a>", "                    </div>", "                </div>"]}, {"lines": ["            </div>", ""]}, {"lines": ["            <div data-bind=\"if: isAbuse\">", "                <div>", "                    <span data-bind=\"if: hasChildren\">", "                        <i data-bind=\"css: toggleIcon, click: toggle\"></i>", "                    </span>", "                    Comment reported", "                </div>", "                <a data-bind=\"click: startUnreportAbuse\">Not abuse</a>", "                <div data-bind=\"if: unreporting\">"]}, {"lines": ["                    <a class=\"btn btn-default btn-sm\" data-bind=\"click: cancelUnreportAbuse\">Cancel</a>", "                </div>", "            </div>"]}, {"lines": [""]}, {"lines": ["            <div data-bind=\"if: isVisible\">"]}, {"lines": [""]}, {"lines": ["                <div class=\"comment-info\">", "                    <form class=\"form-inline\">"]}, {"lines": ["                        <span class=\"comment-date pull-right\">", "                            <span data-bind=\"template: {if: modified, afterRender: setupToolTips}\">", "                                <a data-toggle=\"tooltip\" data-bind=\"attr: {title: prettyDateModified()}\">*</a>", "                            </span>", "                            <span data-bind=\"text: prettyDateCreated\"></span>", "                        </span>", "                    </form>", "                </div>", "", "                <div>"]}, {"lines": [""]}, {"lines": ["                    <div class=\"comment-content\">", "", "                        <div data-bind=\"ifnot: editing\">", "                            <span data-bind=\"if: hasChildren\">", "                                <i data-bind=\"css: toggleIcon, click: toggle\"></i>", "                            </span>"]}, {"lines": ["                        </div>"]}, {"lines": ["", "                        <!--", "                            Hack: Use template binding with if rather than vanilla if", "                            binding to get access to afterRender", "                        -->", "                        <div data-bind=\"template {if: editing, afterRender: autosizeText}\">"]}, {"lines": ["                                <textarea class=\"form-control\" data-bind=\"value: content, valueUpdate: 'input', attr: {maxlength: $root.MAXLENGTH}\"></textarea>"]}, {"lines": ["                            </div>"]}, {"lines": ["                                <span data-bind=\"text: editErrorMessage\" class=\"comment-error\"></span>", "                            </div>"]}, {"lines": ["                        </div>"]}, {"lines": [""]}, {"lines": ["                    </div>"]}, {"lines": [""]}, {"lines": ["                    <div>", "", "                        <span class=\"comment-error\">{{errorMessage}}</span>", ""]}, {"lines": [""]}, {"lines": ["                        <!-- Action bar -->"]}, {"lines": ["                            <span data-bind=\"if: $root.canComment, click: showReply\">"]}, {"lines": ["                            </span>", "                            <span data-bind=\"if: canReport, click: reportAbuse\">"]}, {"lines": ["                            </span>", "                            <span data-bind=\"if: canEdit, click: startDelete\">"]}, {"lines": ["                            </span>"]}, {"lines": ["                        </div>"]}, {"lines": [""]}, {"lines": ["                    </div>", ""]}, {"lines": ["                    <div class=\"comment-report\" data-bind=\"if: reporting\">", "                        <form class=\"form-inline\">", "                            <select class=\"form-control\" data-bind=\"options: abuseOptions, optionsText: abuseLabel, value: abuseCategory\"></select>", "                            <input class=\"form-control\" data-bind=\"value: abuseText\" placeholder=\"Describe abuse\" />", "                        </form>"]}, {"lines": ["                    </div>"]}, {"lines": [""]}, {"lines": ["                    <div class=\"comment-delete\" data-bind=\"if: deleting\">"]}, {"lines": ["                    </div>"]}, {"lines": [""]}, {"lines": ["                </div>", "", "            </div>", ""]}, {"lines": [""]}, {"lines": ["        </div>", "", "        <ul class=\"comment-list\">", ""]}, {"lines": ["            <!-- ko if: replying -->"]}, {"lines": ["                <div>"]}, {"lines": ["                        <textarea class=\"form-control\" placeholder=\"Add a comment\" data-bind=\"value: replyContent, valueUpdate: 'input', attr: {maxlength: $root.MAXLENGTH}\"></textarea>"]}, {"lines": ["                    </div>"]}, {"lines": ["                        <span data-bind=\"text: replyErrorMessage\" class=\"comment-error\"></span>", "                    </div>", "                </div>"]}, {"lines": ["            <!-- /ko -->", ""]}, {"lines": ["        </ul>", "", "    </div>", "", "</script>"]}, {"lines": ["<script id=\"profileJobs\" type=\"text/html\">", "", "    <div data-bind=\"if: mode() === 'edit'\">", ""]}, {"lines": [""]}, {"lines": ["            <div data-bind=\"sortable: {", "                    data: contents,", "                    options: {"]}, {"lines": ["                    }", "                }\">", "", "                <div>", "", "                    <div class=\"well well-sm sort-handle\">", "                        <span>Position {{ $index() + 1 }}</span>", "                        <span data-bind=\"visible: $parent.hasMultiple()\">", "                            [ drag to reorder ]", "                        </span>", "                        <a", "                                class=\"text-danger pull-right\"", "                                data-bind=\"click: $parent.removeContent,", "                                           visible: $parent.canRemove\"", "                            >Remove</a>", "                    </div>", "", "                    <div class=\"form-group\">", "                        <label>Institution / Employer</label>"]}, {"lines": ["                    </div>", "", "                    <div class=\"form-group\">", "                        <label>Department</label>", "                        <input class=\"form-control\" data-bind=\"value: department\" />", "                    </div>", "", "                    <div class=\"form-group\">", "                        <label>Job Title</label>", "                        <input class=\"form-control\" data-bind=\"value: title\" />", "                    </div>", ""]}, {"lines": ["                        <label>Start Date</label>"]}, {"lines": [""]}, {"lines": ["                        <label>End Date</label>"]}, {"lines": ["                    </div>", ""]}, {"lines": ["                    <hr data-bind=\"visible: $index() != ($parent.contents().length - 1)\" />"]}, {"lines": [""]}, {"lines": ["                </div>", ""]}, {"lines": ["            </div>", "", "            <div>", "                <a class=\"btn btn-default\" data-bind=\"click: addContent\">", "                    Add another", "                </a>", "            </div>", "", "            <div class=\"padded\">"]}, {"lines": [""]}, {"lines": ["                <button"]}, {"lines": ["            </div>", "", "            <!-- Flashed Messages -->", "            <div class=\"help-block\">", "                <p data-bind=\"html: message, attr.class: messageClass\"></p>", "            </div>", "", "        </form>", "", "    </div>", "", "    <div data-bind=\"if: mode() === 'view'\">", "", "        <div data-bind=\"ifnot: contents().length\">", "            <div class=\"well well-sm\">Not provided</div>", "        </div>", "", "        <div data-bind=\"if: contents().length\">", "", "            <table class=\"table\">", "", "                <thead>", "                    <tr>", "                        <th>Institution</th>", "                        <th>Department</th>", "                        <th>Title</th>"]}, {"lines": ["                    </tr>", "                </thead>", "", "                <tbody data-bind=\"foreach: contents\">", "", "                    <tr>", "", "                        <td>{{ institution }}</td>", "                        <td>{{ department }}</td>", "                        <td>{{ title }}</td>"]}, {"lines": ["", "                    </tr>", "", "                </tbody>", "", "            </table>", "", "        </div>", "", "        <div data-bind=\"if: editable\">"]}, {"lines": ["            <a class=\"btn btn-default\" data-bind=\"click: edit\">Edit</a>"]}, {"lines": ["        </div>", "", "    </div>", "", "</script>"]}, {"lines": ["<script id=\"profileSchools\" type=\"text/html\">", "", "    <div data-bind=\"if: mode() === 'edit'\">", ""]}, {"lines": [""]}, {"lines": ["            <div data-bind=\"sortable: {", "                    data: contents,", "                    options: {"]}, {"lines": ["                    }", "                }\">", "", "                <div>", "", "                    <div class=\"well well-sm sort-handle\">", "                        <span>Position {{ $index() + 1 }}</span>", "                        <span data-bind=\"visible: $parent.hasMultiple()\">", "                            [ drag to reorder ]", "                        </span>", "                        <a", "                                class=\"text-danger pull-right\"", "                                data-bind=\"click: $parent.removeContent,", "                                           visible: $parent.canRemove\"", "                            >Remove</a>", "                    </div>", "", "                    <div class=\"form-group\">", "                        <label>Institution</label>"]}, {"lines": ["                    </div>", "", "                    <div class=\"form-group\">", "                        <label>Department</label>", "                        <input class=\"form-control\" data-bind=\"value: department\" />", "                    </div>", "", "                    <div class=\"form-group\">", "                        <label>Degree</label>", "                        <input class=\"form-control\" data-bind=\"value: degree\" />", "                    </div>", "", "                    <div class=\"form-group\">", "                        <label>Start Date</label>"]}, {"lines": ["                    </div>", ""]}, {"lines": ["                        <label>End Date</label>"]}, {"lines": ["                    </div>", ""]}, {"lines": ["                    <hr data-bind=\"visible: $index() != ($parent.contents().length - 1)\" />"]}, {"lines": [""]}, {"lines": ["                </div>", ""]}, {"lines": ["            </div>", "", "            <div>", "                <a class=\"btn btn-default\" data-bind=\"click: addContent\">", "                    Add another", "                </a>", "            </div>", "", "            <div class=\"padded\">"]}, {"lines": [""]}, {"lines": ["                <button"]}, {"lines": ["            </div>", "", "            <!-- Flashed Messages -->", "            <div class=\"help-block\">", "                <p data-bind=\"html: message, attr.class: messageClass\"></p>", "            </div>", "", "        </form>", "", "    </div>", "", "    <div data-bind=\"if: mode() === 'view'\">", "", "        <div data-bind=\"ifnot: contents().length\">", "            <div class=\"well well-sm\">Not provided</div>", "        </div>", "", "        <div data-bind=\"if: contents().length\">", "", "            <table class=\"table\">", "", "                <thead>", "                    <tr>", "                        <th>Institution</th>", "                        <th>Department</th>", "                        <th>Degree</th>"]}, {"lines": ["                    </tr>", "                </thead>", "", "                <tbody data-bind=\"foreach: contents\">", "", "                    <tr>", "", "                        <td>{{ institution }}</td>", "                        <td>{{ department }}</td>", "                        <td>{{ degree }}</td>"]}, {"lines": ["", "                    </tr>", "", "                </tbody>", "", "            </table>", "", "        </div>", "", "", "        <div data-bind=\"if: editable\">"]}, {"lines": ["            <a class=\"btn btn-default\" data-bind=\"click: edit\">Edit</a>"]}, {"lines": ["        </div>", "", "    </div>", "", "</script>"]}, {"lines": ["<div class=\"comment-container\">", ""]}, {"lines": ["    <a class=\"btn comment-reply\">", "        % if top:", "            Comment", "        % else:", "            Reply", "        % endif", "    </a>"]}, {"lines": ["", "    <!-- Build comment form -->", "    <form id=\"comment-${guid}\" method=\"POST\" action=\"/api/v1/guid/${guid}/comment/\" class=\"comment-form form-horizontal\" style=\"display: none;\">"]}, {"lines": ["", "        <div data-bind=\"with:currentPage\">", "            <div data-bind=\"foreach:questions\">", "                <div class=\"control-group\">", "                    <label class=\"control-label\" data-bind=\"text:$data.label, attr:{for:$data.id}\"></label>", "                    <div class=\"controls\">", "                        <div data-bind='item:$data, attr:{id:$data.id}'></div>", "                    </div>"]}, {"lines": ["                </div>", "            </div>", "        </div>"]}, {"lines": ["", "        <div class=\"control-group\">", "            <div class=\"controls\">", "                <input type=\"submit\" value=\"Submit\" class=\"btn\" />", "                <a class=\"btn comment-cancel\">Cancel</a>", "            </div>", "        </div>", ""]}, {"lines": ["    </form>", "", "</div>", "", "<!-- Apply view model -->", "<script type=\"text/javascript\">", "    view_model = new ViewModel(${schema});", "    ko.applyBindings(view_model, $('#comment-${guid}')[0]);", "</script>"]}, {"lines": ["<script type=\"text/javascript\">", "", "    // Asynchronous comment submission", "    $('.comment-form').on('submit', function() {", "        var $this = $(this);", "        $.post(", "            $this.attr('action'),", "            $this.serialize(),", "            function(response) {", "                window.location.reload();", "            }", "        );", "        return false;", "    });", "", "    $('.comment-reply').on('click', function() {", "        var $this = $(this);", "        $this.toggle();", "        $(this).closest('.comment-container').find('form').toggle();", "    });", "", "    $('.comment-cancel').on('click', function() {", "        var $this = $(this);", "        $this.closest('form').toggle();", "        $(this).closest('.comment-container').find('.comment-reply').toggle();", "    });", "", "</script>"]}, {"lines": ["<div class=\"col-md-6 col-md-offset-3\" id=\"registration_template\">", ""]}, {"lines": ["    <%include file=\"metadata_1.html\" />"]}, {"lines": ["", "    <form class=\"form\">", "", "        % if not registered:", ""]}, {"lines": ["            <div id=\"register-show-submit\" data-bind=\"visible:$root.isLast()\">", "", "                <hr />", ""]}, {"lines": ["                <p class=\"help-block\">${language.BEFORE_REGISTRATION_INFO}</p>"]}, {"lines": ["", "                <div class=\"form-group\">", "                    <label>"]}, {"lines": ["                        Type \"register\" if you are sure you want to continue"]}, {"lines": ["                    </label>", "                    <div class=\"controls\">", "                        <input class=\"form-control\" data-bind=\"value:$root.continueText, valueUpdate: 'afterkeydown'\" />", "                    </div>", "                </div>"]}, {"lines": ["            </div>", "", "        % endif", "", "        % if not registered:", "            <button id=\"register-submit\" class=\"btn btn-success\" data-bind=\"visible:$root.continueFlag, focus:$root.continueFlag\">"]}, {"lines": ["                Register Now"]}, {"lines": ["            </button>", "        % endif", "", "    </form>", "", "</div><!-- end #registration_template -->", ""]}, {"lines": ["<script type=\"text/javascript\">"]}, {"lines": ["</script>"]}, {"lines": ["<%def name=\"title()\">Configure Add-ons</%def>"]}, {"lines": ["<h2 class=\"page-header\">Configure Add-ons</h2>"]}, {"lines": [""]}, {"lines": ["<div class=\"row\">"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        <div class=\"panel panel-default\">", "            <ul class=\"nav nav-stacked nav-pills\">", "                <li><a href=\"${ web_url_for('user_profile') }\">Profile Information</a></li>"]}, {"lines": ["                <li><a href=\"#\">Configure Add-ons</a></li>"]}, {"lines": ["            </ul>", "        </div><!-- end sidebar -->"]}, {"lines": [""]}, {"lines": ["    </div>"]}, {"lines": [""]}, {"lines": ["", "        <div id=\"selectAddons\" class=\"panel panel-default\">", "            <div class=\"panel-heading\"><h3 class=\"panel-title\">Select Add-ons</h3></div>", "            <div class=\"panel-body\">", "", "                <form id=\"selectAddonsForm\">", "", "                    % for category in addon_categories:", "", "                        <%", "                            addons = [", "                                addon", "                                for addon in addons_available", "                                if category in addon.categories", "                            ]", "                        %>"]}, {"lines": ["                        % if addons:", "                            <h3>${category.capitalize()}</h3>", "                            % for addon in addons:", "                                <div>", "                                    <label>", "                                        <input", "                                            type=\"checkbox\"", "                                            name=\"${addon.short_name}\""]}, {"lines": ["                                        />", "                                        ${addon.full_name}", "                                    </label>", "                                </div>", "                            % endfor", "                        % endif", "", "                    % endfor", ""]}, {"lines": ["                    <button id=\"settings-submit\" class=\"btn btn-success\">", "                        Submit", "                    </button>", "", "                </form>", "", "            </div>", "        </div>"]}, {"lines": ["        % if addon_enabled_settings:"]}, {"lines": ["            <div id=\"configureAddons\" class=\"panel panel-default\">", "                <div class=\"panel-heading\"><h3 class=\"panel-title\">Configure Add-ons</h3></div>", "                <div class=\"panel-body\">", "", "                    % for name in addon_enabled_settings:"]}, {"lines": ["                        % if not loop.last:", "                            <hr />", "                        % endif", "", "                    % endfor"]}, {"lines": ["            </div>"]}, {"lines": ["    </div>", "", "</div>"]}, {"lines": [""]}, {"lines": ["## TODO: Review and un-comment", "##<div class=\"row\">"]}, {"lines": ["##        <div class=\"panel panel-default\">", "##            <div class=\"panel-heading\"><h3 class=\"panel-title\">Merge Accounts</h3></div>", "##            <div class=\"panel-body\">", "##                <a href=\"/user/merge/\">Merge with duplicate account</a>", "##            </div>", "##        </div>", "##    </div>", "##</div>"]}, {"lines": [""]}, {"lines": ["            <ul class=\"nav nav-stacked nav-pills\">"]}, {"lines": ["                <li><a href=\"#\">Profile Information</a></li>"]}, {"lines": ["                <li><a href=\"${ web_url_for('user_addons') }\">Configure Add-ons</a></li>"]}, {"lines": ["            </ul>", "        </div><!-- end sidebar -->"]}, {"lines": ["    </div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        <div id=\"userProfile\">", "", "            <ul class=\"nav nav-tabs\">", "                <li class=\"active\"><a href=\"#names\" data-toggle=\"tab\">Name</a></li>", "                <li><a href=\"#social\" data-toggle=\"tab\">Social</a></li>", "                <li><a href=\"#jobs\" data-toggle=\"tab\">Employment</a></li>", "                <li><a href=\"#schools\" data-toggle=\"tab\">Education</a></li>", "            </ul>", ""]}, {"lines": ["", "                <div class=\"tab-pane active\" id=\"names\">"]}, {"lines": ["                    <div data-bind=\"template: {name: 'profileName'}\"></div>"]}, {"lines": ["                </div>", "", "                <div class=\"tab-pane\" id=\"social\">"]}, {"lines": ["                    <div data-bind=\"template: {name: 'profileSocial'}\"></div>"]}, {"lines": ["                </div>", "", "                <div class=\"tab-pane\" id=\"jobs\">"]}, {"lines": ["                    <div data-bind=\"template: {name: 'profileJobs'}\"></div>"]}, {"lines": ["                </div>", "", "                <div class=\"tab-pane\" id=\"schools\">"]}, {"lines": ["                    <div data-bind=\"template: {name: 'profileSchools'}\"></div>"]}, {"lines": ["                </div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        </div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["## TODO: Review and un-comment"]}, {"lines": ["##<div mod-meta='{", "##        \"tpl\": \"util/render_keys.mako\",", "##        \"uri\": \"/api/v1/settings/keys/\",", "##        \"replace\": true,", "##        \"kwargs\" : {", "##            \"route\": \"/settings/\"}", "##        }'></div>"]}, {"lines": [""]}, {"lines": ["<%include file=\"include/profile/names.mako\" />", "<%include file=\"include/profile/social.mako\" />", "<%include file=\"include/profile/jobs.mako\" />", "<%include file=\"include/profile/schools.mako\" />"]}, {"lines": [""]}, {"lines": ["<script type=\"text/javascript\">"]}, {"lines": ["</script>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["<%def name=\"stylesheets()\">"]}, {"lines": ["% for stylesheet in tree_css:", "<link rel='stylesheet' href='${stylesheet}' type='text/css' />", "% endfor"]}, {"lines": ["<%def name=\"javascript_bottom()\">"]}, {"lines": ["% for script in tree_js:"]}, {"lines": ["% endfor"]}, {"lines": [""]}, {"lines": ["<div mod-meta='{", "        \"tpl\": \"util/render_key_history.html\","]}, {"lines": ["        \"kwargs\": {"]}, {"lines": ["        },", "        \"replace\": true", "    }'></div>"]}, {"lines": ["                            <div class=\"col-md-6\">"]}, {"lines": ["                                <thead data-bind=\"visible: foundResults\">"]}, {"lines": ["                                </thead>"]}, {"lines": ["                                                    class=\"btn btn-default contrib-button btn-mini\""]}, {"lines": ["                                            <span", "                                                    class='text-muted'", "                                                    data-bind=\"visible: !contributor.registered\">(unregistered)</span>"]}, {"lines": ["                                        </td>"]}, {"lines": ["                                <thead data-bind=\"visible: selection().length\">"]}, {"lines": ["                                        Permissions"]}, {"lines": ["                                                data-toggle=\"popover\"", "                                                data-title=\"Permission Information\"", "                                                data-container=\"#addContributors\"", "                                                data-html=\"true\"", "                                            ></i>", "                                    </th>", "                                </thead>"]}, {"lines": ["                                                    class=\"btn btn-default contrib-button btn-mini\""]}, {"lines": ["                                            <img data-bind=\"attr: {src: contributor.gravatar_url}\" />"]}, {"lines": ["                                        <td>"]}, {"lines": ["                                        </td>"]}, {"lines": ["</div><!-- /.modal -->"]}, {"lines": ["<div class=\"modal fade\" id=\"showLinks\">", "    <div class=\"modal-dialog\">", "        <div class=\"modal-content\">", "            <div class=\"modal-header\">", "                <h3>Links to this project</h3>", "            </div>", "", "            <div class=\"modal-body\">", "                <table class=\"table table-striped\">", "                    <thead>", "                        <th>Title</th>", "                        <th>Authors</th>", "                    </thead>"]}, {"lines": ["                </table>", "            </div><!-- end modal-body -->", "", "            <div class=\"modal-footer\">", "                <a href=\"#\" class=\"btn btn-default\" data-dismiss=\"modal\">Done</a>", "            </div><!-- end modal-footer -->", "        </div><!-- end modal-content -->", "    </div><!-- end modal-dialog -->", "</div><!-- end modal -->"]}, {"lines": ["<script src=\"/static/vendor/citeproc-js/xmldom.js\"></script>", "<script src=\"/static/vendor/citeproc-js/citeproc.js\"></script>", ""]}, {"lines": ["", "    <% import json %>"]}, {"lines": ["    ## TODO: Move this logic into badges add-on"]}, {"lines": ["    % if 'badges' in addons_enabled and badges and badges['can_award']:"]}, {"lines": ["    % endif"]}, {"lines": ["            ## TODO: Abstract me", "            username: ${json.dumps(user['username']) | n},"]}, {"lines": ["            ## TODO: Abstract me"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["% if schema:"]}, {"lines": ["    <%include file=\"metadata/register_${str(metadata_version)}.mako\" />"]}, {"lines": ["% else:", ""]}, {"lines": [""]}, {"lines": ["        <div class=\"help-block\">${language.REGISTRATION_INFO}</div>"]}, {"lines": [""]}, {"lines": ["            % for option in options:", "                <option value=\"${option['template_name']}\">${option['template_name_clean']}</option>", "            % endfor", "        </select>"]}, {"lines": ["", "    <script type=\"text/javascript\">", "        $('#select-registration-template').on('change', function() {"]}, {"lines": ["        });", "    </script>", "", "% endif"]}, {"lines": [""]}, {"lines": ["    </div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    </div>"]}, {"lines": ["", "</div>", ""]}, {"lines": ["% for name, capabilities in addon_capabilities.iteritems():", "    <script id=\"capabilities-${name}\" type=\"text/html\">${capabilities}</script>", "% endfor", ""]}, {"lines": ["    ${full_name} add-on is not configured properly."]}, {"lines": ["    % if user['is_contributor']:"]}, {"lines": ["      Configure this add-on on the <a href=\"${node['url']}settings/\">settings</a> page."]}, {"lines": ["    % endif"]}, {"lines": [""]}, {"lines": ["    <!-- Title -->"]}, {"lines": [""]}, {"lines": ["    ${next.body()}"]}, {"lines": [""]}, {"lines": ["    <!-- Form feedback -->", "    <div class=\"addon-settings-message\" style=\"display: none; padding-top: 10px;\"></div>"]}, {"lines": [""]}, {"lines": ["</form>"]}, {"lines": ["<p>This page is under development</p>"]}, {"lines": [""]}, {"lines": ["</p>"]}, {"lines": ["            href=\"/getting-started\">Getting"]}, {"lines": ["            href=\"/4znZP/wiki/home\">OSF"]}, {"lines": ["<h3>How secure is my information?</h3><p>Security is extremely important for"]}, {"lines": ["</p>"]}, {"lines": [""]}, {"lines": ["<h2 style=\"padding-bottom: 30px;\">${ meeting['name'] } Posters & Talks</h2>", "", "% if meeting['logo_url']:"]}, {"lines": ["    <br /><br />", "  % endif", "", "% if meeting['active']:", "    <div>", "        <a id=\"addLink\" onclick=\"\" href=\"#\">Add your poster or talk</a>", "        % if meeting['info_url']:"]}, {"lines": ["        % endif", "    </div>", "", "    <div style=\"display: none\" id=\"submit\">", "        <h3>Add your poster or talk</h3>", "        <p>", "            Send an email to one of the following addresses from the email", "            account you would like used on the OSF:", "        </p>", "        <ul>", "            <li>For posters, email <a href=\"mailto:${ label }-poster@osf.io\">${ label }-poster@osf.io</a></li>", "            <li>For talks, email <a href=\"mailto:${ label }-talk@osf.io\">${ label }-talk@osf.io</a></li>", "        </ul>", "        <p>The format of the email should be as follows:</p>", "        <div>", "            <dl style=\"padding-left: 25px\">", "                <dt>Subject</dt>", "                <dd>Presentation title</dd>", "                <dt>Message body</dt>", "                <dd>Presentation abstract (if any)</dd>", "                <dt>Attachment</dt>", "                <dd>Your presentation file (e.g., PowerPoint, PDF, etc.)</dd>", "            </dl>", "        </div>", "        <p>", "            Once sent, we will follow-up by sending you the permanent identifier", "            that others can use to cite your work; you can also login and make changes,", "            such as uploading additional files, to your project at that URL. If you", "            didn't have an OSF account, one will be created automatically and a link", "            to set your password will be emailed to you; if you do, we will simply create", "            a new project in your account.", "        </p>", "    </div>", "% endif", "", "<div id=\"grid\" style=\"width: 100%;\"></div>"]}, {"lines": ["<html>", "", "<head>", "", "    <title>${ meeting['name'] } Presentations</title>", "", "    <%namespace name=\"globals\" file=\"base.mako\" />"]}, {"lines": [""]}, {"lines": ["    % if sentry_dsn_js:", "    <script src=\"/static/vendor/bower_components/raven-js/dist/raven.min.js\"></script>", "    <script src=\"/static/vendor/bower_components/raven-js/plugins/jquery.js\"></script>", "    <script>", "        Raven.config('${ sentry_dsn_js }', {}).install();", "    </script>", "    % else:", "    <script>", "        window.Raven = {};", "        Raven.captureMessage = function(msg, context) {", "            console.error('=== Mock Raven.captureMessage called with: ===');", "            console.log('Message: ' + msg);", "            console.log(context);", "        };", "        Raven.captureException = function(err, context) {", "            console.error('=== Mock Raven.captureException called with: ===');", "            console.log('Error: ' + err);", "            console.log(context);", "        };", "    </script>", "    % endif", ""]}, {"lines": ["    <script src=\"${\"/static/public/js/vendor.js\" | webpack_asset}\"></script>", "", "    % for url in globals.javascript_bottom():"]}, {"lines": ["        <script src=\"${url}\"></script>", "    % endfor", "", "</head>", "", "<body>", "", "    <div class=\"container\">"]}, {"lines": ["        <%include file=\"public/pages/meeting_body.mako\" />"]}, {"lines": ["    </div>", "", "    <script type=\"text/javascript\">"]}, {"lines": ["    </script>"]}, {"lines": ["</body>", "", "</html>"]}, {"lines": ["</ol>"]}, {"lines": ["<h2>Key: ${key} | ${label}</h2>", "", "<h3>Revision history</h3>", "", "% for log in logs:"]}, {"lines": ["    <div mod-meta='{", "            \"tpl\": \"util/render_log.mako\",", "            \"uri\": \"/api/v1/log/${log[\"lid\"]}/\",", "            \"replace\": true", "        }'></div>"]}, {"lines": ["% endfor", "", "<div>", "    <a id=\"revoke_key\" data-key=\"${key}\">Revoke key</a>", "</div>", "", "<script type=\"text/javascript\">", "    $('#revoke_key').on('click', function() {", "        $.post(", "            '${route}/revoke_key/',", "            {key : $(this).attr('data-key')},", "            function() {", "                window.location = '${route}';", "            }", "        );", "    });", "</script>"]}, {"lines": ["% if summary['can_view']:", ""]}, {"lines": ["    <li", "            node_id=\"${summary['id']}\"", "            node_reference=\"${summary['id']}:${'node' if summary['primary'] else 'pointer'}\"", "            class=\"", "                project list-group-item list-group-item-node cite-container", "                ${'pointer' if not summary['primary'] else ''}", "        \">"]}, {"lines": ["", "        <h4 class=\"list-group-item-heading\">"]}, {"lines": ["            % if not summary['primary']:"]}, {"lines": ["            % endif"]}, {"lines": ["            % if summary['is_registration']:", "                | Registered: ${summary['registered_date']}", "            % endif", "            </span>"]}, {"lines": ["            <div class=\"pull-right\">"]}, {"lines": ["                % if not summary['primary'] and 'admin' in user['permissions']:"]}, {"lines": ["                % endif"]}, {"lines": ["            </div>"]}, {"lines": ["        </h4>"]}, {"lines": ["        <div class=\"list-group-item-text\"></div>"]}, {"lines": [""]}, {"lines": ["        <!-- Show abbreviated contributors list -->"]}, {"lines": ["        <div mod-meta='{", "                \"tpl\": \"util/render_users_abbrev.mako\",", "                \"uri\": \"${summary['api_url']}contributors_abbrev/\",", "                \"kwargs\": {", "                    \"node_url\": \"${summary['url']}\"", "                },", "                \"replace\": true"]}, {"lines": ["            }'></div>"]}, {"lines": ["        <!--Stacked bar to visualize user activity level against total activity level of a project -->", "        <!--Length of the stacked bar is normalized over all projects -->"]}, {"lines": ["        <div class=\"body hide\" id=\"body-${summary['id']}\" style=\"overflow:hidden;\">"]}, {"lines": ["            <hr />"]}, {"lines": ["            Recent Activity"]}, {"lines": ["    </li>", "", "% else:"]}, {"lines": ["        <h4 class=\"list-group-item-heading\">"]}, {"lines": ["            %elif not summary['primary']:", "                Private Link"]}, {"lines": ["        </h4>", "    </li>"]}, {"lines": [""]}, {"lines": ["        rel=\"tooltip\"", "        href=\"${user_profile_url}\"", "        data-original-title=\"${user_fullname}\""]}, {"lines": ["", "def expand_permissions(permission):"]}, {"lines": ["", "", "def reduce_permissions(permissions):"]}, {"lines": ["        if permission in permissions:", "            return permission", "    raise ValueError('Permissions not in permissions list')"]}], "name": "Joshua Carp"}, {"commits": [{"lines": ["        'js/osfHelpers',", "        'mithril'"]}, {"lines": ["    extensions: ['', '.es6.js', '.js', '.min.js'],"]}, {"lines": ["        'tests': staticPath('js/tests'),", "        // GASP Items not defined as main in its package.json"]}, {"lines": ["        'TweenLite' : nodePath('gsap/src/minified/TweenLite.min.js'),"]}, {"lines": ["        'EasePack' : nodePath('gsap/src/minified/easing/EasePack.min.js')"]}, {"lines": ["        'user_gravatar': profile_views.current_user_gravatar(size=25)['gravatar_url'] if user else '',"]}, {"lines": [""]}, {"lines": ["function _fangornLazyLoadError (item) {"]}, {"lines": ["    return true;", "}"]}, {"lines": [""]}, {"lines": ["Fangorn.config.dropbox = {"]}, {"lines": ["    lazyLoadError : _fangornLazyLoadError", "};"]}, {"lines": ["require('./dropboxFangornConfig.js');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["// Define Fangorn Button Actions"]}, {"lines": ["var _figshareItemButtons = {", "    view: function (ctrl, args, children) {", "        var buttons = [];", "        var tb = args.treebeard;", "        var item = args.item;", "        // If File and FileRead are not defined dropzone is not supported and neither is uploads", "        if (window.File && window.FileReader && item.data.permissions && item.data.permissions.edit && item.kind === 'folder') {", "            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function (event) {", "                        Fangorn.ButtonEvents._uploadEvent.call(tb, event, item);", "                    },"]}, {"lines": ["                    icon: 'fa fa-upload',", "                    className: 'text-success'", "                }, 'Upload')", "            );", "        }", "        if (item.kind === 'file' && item.data.extra && item.data.extra.status === 'public') {", "            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function (event) {", "                        Fangorn.ButtonEvents._downloadEvent.call(tb, event, item);", "                    },"]}, {"lines": ["                    icon: 'fa fa-download',", "                    className: 'text-info'", "                }, 'Download')"]}, {"lines": ["            );"]}, {"lines": ["        }"]}, {"lines": ["        var privateOrSiblings = (item.data.extra && item.data.extra.status !== 'public') ||"]}, {"lines": ["            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function (event) {", "                        Fangorn.ButtonEvents._removeEvent.call(tb, event, tb.multiselected());", "                    },"]}, {"lines": ["                    icon: 'fa fa-trash',", "                    className: 'text-danger'", "                }, 'Delete')", "            );", "        }"]}, {"lines": ["        if (item.data.permissions && item.data.permissions.view) {", "            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function(event) {", "                        Fangorn.ButtonEvents._gotoFileEvent.call(tb, item);", "                    },", "                    icon: 'fa fa-external-link',", "                    className : 'text-info'", "                }, 'View'));", "        }"]}, {"lines": ["        return m('span', buttons); // Tell fangorn this function is used."]}, {"lines": ["    }"]}, {"lines": ["};"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    // Fangorn options are called if functions, so return a thunk that returns the column builder"]}, {"lines": ["    itemButtons: _figshareItemButtons"]}, {"lines": ["require('./githubFangornConfig.js');"]}, {"lines": [""]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["// Cross browser key codes for the Command key", "var commandKeys = [224, 17, 91, 93];"]}, {"lines": ["                // delete view", "                tb.deleteNode(item.parentID, item.id);"]}, {"lines": ["                Fangorn.Utils.dismissToolbar.call(tb);"]}, {"lines": ["                tb.modal.dismiss();"]}, {"lines": ["                tb.clearMultiselect();", ""]}, {"lines": ["                tb.modal.dismiss();"]}, {"lines": ["                Fangorn.Utils.dismissToolbar.call(tb);"]}, {"lines": ["                item.notify.update('Delete failed.', 'danger', undefined, 3000);"]}, {"lines": ["                tb.clearMultiselect();"]}, {"lines": [""]}, {"lines": ["", "", "// Define Fangorn Button Actions"]}, {"lines": ["var _githubItemButtons = {", "    view: function (ctrl, args, children) {", "        var tb = args.treebeard;", "        var item = args.item;", "        var buttons = [];"]}, {"lines": ["        function _downloadEvent(event, item, col) {", "            event.stopPropagation();", "            window.location = waterbutler.buildTreeBeardDownload(item, {fileSha: item.data.extra.fileSha});"]}, {"lines": ["        }"]}, {"lines": ["        // Download Zip File", "        if (item.kind === 'folder') {", "            var branchArray = [];", "            if (item.data.branches) {", "                item.data.branch = item.data.branch || item.data.defaultBranch;", "                for (var i = 0; i < item.data.branches.length; i++) {", "                    var selected = item.data.branches[i] === item.data.branch ? 'selected' : '';", "                    branchArray.push(m('option', {", "                        selected: selected,", "                        value: item.data.branches[i]", "                    }, item.data.branches[i]));", "                }", "            }", "            // If File and FileRead are not defined dropzone is not supported and neither is uploads", "            if (window.File && window.FileReader && item.data.permissions && item.data.permissions.edit) {", "                buttons.push(", "                    m.component(Fangorn.Components.button, {", "                        onclick: function (event) {", "                            Fangorn.ButtonEvents._uploadEvent.call(tb, event, item);", "                        },"]}, {"lines": ["                        icon: 'fa fa-upload',", "                        className: 'text-success'", "                    }, 'Upload'),", "                    m.component(Fangorn.Components.button, {", "                        onclick: function (event) {"]}, {"lines": ["                            tb.toolbarMode(Fangorn.Components.toolbarModes.ADDFOLDER);"]}, {"lines": ["                        },"]}, {"lines": ["                        icon: 'fa fa-plus',", "                        className: 'text-primary'", "                    }, 'Create Folder')", "                );", "            }", "            if (item.data.addonFullname) {", "                buttons.push(", "                    m.component(Fangorn.Components.button, {", "                        onclick: function (event) {", "                            window.location = item.data.urls.zip;", "                        },"]}, {"lines": ["                        icon: 'fa fa-download',", "                        className: 'text-success'", "                    }, 'Download'),", "                    m.component(Fangorn.Components.button, {", "                        onclick: function (event) {", "                            window.open(item.data.urls.repo, '_blank');", "                        },"]}, {"lines": ["                        icon: 'fa fa-external-link',", "                        className: 'text-info'", "                    }, 'Open'),", "                    m.component(Fangorn.Components.dropdown, {", "                        'label': 'Branch: ',", "                        onchange: function (event) {", "                            changeBranch.call(tb, item, event.target.value);", "                        },"]}, {"lines": ["                        icon: 'fa fa-external-link',", "                        className: 'text-info'", "                    }, branchArray)", "                );", "            }", "        } else if (item.kind === 'file') {"]}, {"lines": ["                m.component(Fangorn.Components.button, {"]}, {"lines": ["                    onclick: function (event) {", "                        _downloadEvent.call(tb, event, item);", "                    },"]}, {"lines": ["                    icon: 'fa fa-download',"]}, {"lines": ["                    className: 'text-info'", "                }, 'Download')"]}, {"lines": ["            );"]}, {"lines": ["            if (item.data.permissions && item.data.permissions.edit) {", "                buttons.push(", "                    m.component(Fangorn.Components.button, {", "                        onclick: function (event) {", "                            _removeEvent.call(tb, event, [item]);", "                        },"]}, {"lines": ["                        icon: 'fa fa-trash',", "                        className: 'text-danger'", "                    }, 'Delete')", "                );", "            }"]}, {"lines": ["            if (item.data.permissions && item.data.permissions.view) {", "                buttons.push(", "                    m.component(Fangorn.Components.button, {", "                        onclick: function(event) {", "                            gotoFile.call(tb, item);", "                        },", "                        icon: 'fa fa-external-link',", "                        className : 'text-info'", "                    }, 'View'));", "", "            }"]}, {"lines": [""]}, {"lines": ["        return m('span', buttons); // Tell fangorn this function is used.", "    }"]}, {"lines": ["};"]}, {"lines": ["function _fangornLazyLoadOnLoad (tree, event) {"]}, {"lines": ["    if(!event){", "        Fangorn.Utils.scrollToFile.call(tb, tb.currentFileID);", "    }"]}, {"lines": ["function gotoFile (item) {", "    var tb = this;", "    var fileurl = new URI(item.data.nodeUrl)", "        .segment('files')", "        .segment(item.data.provider)", "        .segment(item.data.path.substring(1))", "        .search({branch: item.data.branch})", "        .toString();", "    if(commandKeys.indexOf(tb.pressedKey) !== -1) {", "        window.open(fileurl, '_blank');", "    } else {", "        window.open(fileurl, '_self');", "    }", "}"]}, {"lines": ["        var branch = item.data.branch || item.data.defaultBranch;"]}, {"lines": ["            m('github-name', item.data.name + ' (' + branch + ')')"]}, {"lines": ["        if (item.kind === 'file' && item.data.permissions.view) {", "            return m('span',["]}, {"lines": ["                m('github-name.fg-file-links', {"]}, {"lines": ["                    onclick: function() {"]}, {"lines": ["                        gotoFile.call(tb, item);"]}, {"lines": ["                    }"]}, {"lines": ["        } else {", "            return m('span', item.data.name);", "        }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    var tb = this;"]}, {"lines": ["    if (item.data.kind === 'file' && tb.currentFileID === item.id) {"]}, {"lines": ["        item.css = 'fangorn-selected';", "        tb.multiselected([item]);"]}, {"lines": [""]}, {"lines": ["    columns.push({"]}, {"lines": ["    if(tb.options.placement === 'project-files') {"]}, {"lines": ["        columns.push("]}, {"lines": ["    }"]}, {"lines": ["    uploadSuccess: _fangornUploadSuccess,"]}, {"lines": ["    itemButtons: _githubItemButtons,"]}, {"lines": ["    removeEvent : _removeEvent"]}, {"lines": ["    // singleVis : checks if the item visible is the only visible column"]}, {"lines": ["    self.singleVis = ko.pureComputed(function(){"]}, {"lines": ["        var visible = 0;"]}, {"lines": ["        var single;"]}, {"lines": ["        if(self.editVis()){", "            visible++;", "            single = 'edit';", "        }", "        if(self.viewVis()){", "            visible++;", "            single = 'view';", "        }", "        if(self.compareVis()){", "            visible++;"]}, {"lines": ["            single = 'compare';"]}, {"lines": ["        }", "        if(visible === 1){", "            return single;", "        }"]}, {"lines": ["        return false;", "    });"]}, {"lines": ["<div class=\"row\" style=\"margin-bottom: 5px;\">", "    <div class=\"col-sm-6\">"]}, {"lines": ["        <%include file=\"wiki/templates/status.mako\"/>", "    </div>"]}, {"lines": ["    <div class=\"col-sm-6\">"]}, {"lines": ["        <div class=\"pull-right\">", "          <div class=\"switch\"></div>", "          </div>", "    </div>"]}, {"lines": ["</div>", ""]}, {"lines": ["  <div class=\"row wiki-wrapper\">"]}, {"lines": ["                <div class=\"pull-right\"> <div class=\"panel-collapse\"> <i class=\"fa fa-angle-left pointer\"> </i> </div></div>"]}, {"lines": ["            </div>"]}, {"lines": ["                <%include file=\"wiki/templates/toc.mako\"/>"]}, {"lines": ["            </div>"]}, {"lines": [""]}, {"lines": ["          </div>"]}, {"lines": ["              <%include file=\"wiki/templates/nav.mako\"/>", "           </div>"]}, {"lines": ["    </div>"]}, {"lines": ["      <div class=\"row\">"]}, {"lines": ["                           <span class=\"wiki-panel-title\" > <i class=\"fa fa-pencil-square-o\"> </i>   Edit </span>"]}, {"lines": ["                          <div class=\"pull-right\">", "                            <div class=\"progress progress-no-margin pointer \" data-toggle=\"modal\" data-bind=\"attr: {data-target: modalTarget}\" >", "                                <div role=\"progressbar\"data-bind=\"attr: progressBar\">", "                                    <span class=\"progress-bar-content\">", "                                        <span data-bind=\"text: statusDisplay\"></span>", "                                        <span class=\"sharejs-info-btn\">", "                                            <i class=\"fa fa-question-circle fa-large\"></i>", "                                        </span>", "                                    </span>", "                                </div>", "                            </div>"]}, {"lines": ["                  <form id=\"wiki-form\" action=\"${urls['web']['edit']}\" method=\"POST\">"]}, {"lines": ["                        <div class=\"row\">", "                        <div class=\"col-xs-12\">", "                          <div class=\"form-group wmd-panel\">"]}, {"lines": ["                              <div id=\"wmd-button-bar\"></div>"]}, {"lines": ["                              <div id=\"editor\" class=\"wmd-input wiki-editor\"", "                                   data-bind=\"ace: currentText\">Loading. . .</div>", "                          </div>"]}, {"lines": ["                        </div>"]}, {"lines": ["                      </div>", "                  </div>"]}, {"lines": ["                      <div class=\"row\">", "                        <div class=\"col-xs-12\">", "                           <div class=\"pull-right\">", "                              <button id=\"revert-button\""]}, {"lines": ["                                      class=\"btn btn-danger\""]}, {"lines": ["                                      >Revert</button>", "                              <input type=\"submit\""]}, {"lines": ["                                     class=\"btn btn-success\""]}, {"lines": ["                                     value=\"Save\"", "                                     onclick=$(window).off('beforeunload')>", "                          </div>"]}, {"lines": ["                        </div>"]}, {"lines": ["                      </div>"]}, {"lines": ["                        <!-- Invisible textarea for form submission -->"]}, {"lines": ["                                  data-bind=\"value: currentText\"></textarea>"]}, {"lines": ["                  </div>"]}, {"lines": ["                </form>"]}, {"lines": ["                            <span class=\"wiki-panel-title\" > <i class=\"fa fa-eye\"> </i>  View</span>"]}, {"lines": ["", "                            <div class=\"pull-right\">"]}, {"lines": ["                                <!-- Version Picker -->", "                                <select data-bind=\"value:viewVersion\" id=\"viewVersionSelect\">", "                                    % if user['can_edit']:", "                                        <option value=\"preview\" ${'selected' if version_settings['view'] == 'preview' else ''}>Preview</option>", "                                    % endif", "                                    <option value=\"current\" ${'selected' if version_settings['view'] == 'current' else ''}>Current</option>", "                                    % if len(versions) > 1:", "                                        <option value=\"previous\" ${'selected' if version_settings['view'] == 'previous' else ''}>Previous</option>", "                                    % endif", "                                    % for version in versions[2:]:", "                                        <option value=\"${version['version']}\" ${'selected' if version_settings['view'] == version['version'] else ''}>Version ${version['version']}</option>", "                                    % endfor", "                                </select>", "", "                            </div>", ""]}, {"lines": [""]}, {"lines": ["                  <div id=\"wikiViewRender\" data-bind=\"html: renderedView, mathjaxify: renderedView, anchorScroll : { buffer: 50, elem : '#wikiViewPanel'}\" class=\" markdown-it-view\">"]}, {"lines": ["                      % if wiki_content:", "                          ${wiki_content | n}", "                      % else:", "                          <p><em>No wiki content</em></p>", "                      % endif", "                  </div>"]}, {"lines": ["              </div>"]}, {"lines": ["          </div>"]}, {"lines": ["                      <div class=\"col-xs-12\">"]}, {"lines": ["                          <span class=\"wiki-panel-title\"> <i class=\"fa fa-exchange\"> </i>   Compare </span>"]}, {"lines": ["                          <div class=\"inline\" data-bind=\"css: { 'pull-right' :  $root.singleVis() === 'compare' }\">"]}, {"lines": ["                            <span class=\"compare-version-text\"><i> <span data-bind=\"text: viewVersionDisplay\"></span></i> to"]}, {"lines": ["                              <select data-bind=\"value: compareVersion\" id=\"compareVersionSelect\">", "                                  <option value=\"current\" ${'selected' if version_settings['compare'] == 'current' else ''}>Current</option>", "                                  % if len(versions) > 1:", "                                      <option value=\"previous\" ${'selected' if version_settings['compare'] == 'previous' else ''}>Previous</option>", "                                  % endif", "                                  % for version in versions[2:]:", "                                      <option value=\"${version['version']}\" ${'selected' if version_settings['compare'] == version['version'] else ''}>Version ${version['version']}</option>", "                                  % endfor", "                              </select></span>", "", "                          </div>", ""]}, {"lines": ["              </div>"]}, {"lines": ["              </div>"]}, {"lines": ["          </div>"]}, {"lines": ["      </div><!-- end row -->", "    </div>"]}, {"lines": [""]}, {"lines": ["  </div>"]}, {"lines": ["</div><!-- end wiki -->"]}, {"lines": [""]}, {"lines": ["<!-- Wiki modals should also be placed here! -->", "  <%include file=\"wiki/templates/add_wiki_page.mako\"/>", "% if wiki_id and wiki_name != 'home':", "  <%include file=\"wiki/templates/delete_wiki_page.mako\"/>", "% endif", ""]}, {"lines": ["<nav class=\"wiki-nav\">"]}, {"lines": ["    <div class=\"navbar-collapse text-center\">"]}, {"lines": ["        <ul class=\"superlist nav navbar-nav\" style=\"float: none\">"]}, {"lines": ["            % if user['can_edit']:"]}, {"lines": ["                    <span class=\"wiki-nav-closed\">"]}, {"lines": ["                    </span>"]}, {"lines": ["                % if wiki_id and wiki_name != 'home':"]}, {"lines": ["                % endif"]}, {"lines": ["            % endif"]}, {"lines": ["<div class=\"osf-sidenav hidden-print wiki-sidenav\" role=\"complementary\">"]}, {"lines": [""]}, {"lines": ["        <ul class=\"nav bs-sidenav\" style=\"margin: 0;\">", "            <li", "                %if wiki_name == 'home':", "                    class=\"active\"", "                %endif", "            >", "                <div class=\"row\">"]}, {"lines": ["                </div>"]}, {"lines": ["                            </div>"]}, {"lines": ["                    </li>"]}, {"lines": [""]}, {"lines": ["        </ul>"]}, {"lines": ["        <h4>Component Wiki Pages</h4>", "            <ul class=\"nav bs-sidenav\" style=\"margin: 0;\">"]}, {"lines": ["                    <div class=\"row\">", "                        <div class=\"col-xs-10\">", "                            <a href=\"${child['url']}\">", "                                % if child['is_pointer']:"]}, {"lines": ["                                % endif", "                                ${child['title'] | n}", "                                    % if child['category']:", "                                        (${child['category']})", "                                    % endif", "                            </a>", "                        </div>", "                    </div>"]}, {"lines": ["            </ul>", "        %endif"]}, {"lines": ["/**"]}, {"lines": [" * Fangorn: Defining Treebeard options for OSF.", " * For Treebeard and _item API's check: https://github.com/caneruguz/treebeard/wiki"]}, {"lines": [" */", ""]}, {"lines": ["var m = require('mithril');"]}, {"lines": [""]}, {"lines": ["var tbOptions;", ""]}, {"lines": ["var noop = function () { };", ""]}, {"lines": ["var tempCounter = 1;"]}, {"lines": ["    'jpeg', 'jpg', 'lnk', 'log', 'm4a', 'm4b', 'm4p', 'm4v', 'mcd', 'md', 'mdb', 'mid', 'mov', 'mp2', 'mp3', 'mp4',"]}, {"lines": ["// Cross browser key codes for the Command key"]}, {"lines": ["var COMMAND_KEYS = [224, 17, 91, 93];", "var ESCAPE_KEY = 27;", "var ENTER_KEY = 13;"]}, {"lines": [""]}, {"lines": ["var getExtensionIconClass = function (name) {"]}, {"lines": ["        return '_' + icon;"]}, {"lines": ["    return null;"]}, {"lines": ["function findByTempID(parent, tmpID) {"]}, {"lines": ["    var child;", "    var item;", "    for (var i = 0; i < parent.children.length; i++) {", "        child = parent.children[i];", "        if (!child.data.tmpID) {", "            continue;", "        }", "        if (child.data.tmpID === tmpID) {", "            item = child;", "        }", "    }", "    return item;", "}", ""]}, {"lines": ["function cancelUploads (row) {"]}, {"lines": ["    var tb = this;", "    var filesArr = tb.dropzone.getQueuedFiles();"]}, {"lines": ["    for (var i = 0; i < filesArr.length; i++) {"]}, {"lines": ["        var j = filesArr[i];"]}, {"lines": ["        if(!row){"]}, {"lines": ["            var parent = j.treebeardParent || tb.dropzoneItemCache;"]}, {"lines": ["            var item = findByTempID(parent, j.tmpID);"]}, {"lines": ["            tb.dropzone.removeFile(j);", "            tb.deleteNode(parent.id,item.id);"]}, {"lines": ["        } else {"]}, {"lines": ["            tb.deleteNode(row.parentID,row.id);"]}, {"lines": ["            if(row.data.tmpID === j.tmpID){"]}, {"lines": ["                tb.dropzone.removeFile(j);"]}, {"lines": ["            }", "        }"]}, {"lines": ["    }"]}, {"lines": ["    tb.isUploading(false);"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["var uploadRowTemplate = function(item){", "    var tb = this;"]}, {"lines": ["    var padding;"]}, {"lines": ["    var progress = item.data.uploadState() === 'pending' ? 0 : Math.floor(item.data.progress);"]}, {"lines": ["    if (tb.filterOn) {", "        padding = 20;", "    } else {", "        padding = (item.depth - 1) * 20;", "    }"]}, {"lines": ["    var columns = [{", "        data : '',  // Data field name", "        css : '',", "        custom : function(){ return m('row.text-muted', ["]}, {"lines": ["            m('.col-xs-7', {style: 'overflow: hidden;text-overflow: ellipsis;'}, [", "                m('span', { style : 'padding-left:' + padding + 'px;'}, tb.options.resolveIcon.call(tb, item)),", "                m('span',{ style : 'margin-left: 9px;'}, item.data.name)", "            ]),"]}, {"lines": ["            m('.col-xs-3',", "                m('.progress', [", "                    m('.progress-bar.progress-bar-info.progress-bar-striped', {", "                        role : 'progressbar',", "                        'aria-valuenow' : progress,", "                        'aria-valuemin' : '0',", "                        'aria-valuemax': '100',", "                        'style':'width: ' + progress + '%' }, m('span.sr-only', progress + '% Complete'))", "                ])", "            ),", "            m('.col-xs-2', [", "                m('span', m('.fangorn-toolbar-icon.m-l-sm', {", "                        style : 'padding: 0px 6px 2px 2px;font-size: 16px;display: inline;',", "                        config : function() {", "                            reapplyTooltips();", "                        },", "                        'onclick' : function (e) {", "                            e.stopImmediatePropagation();", "                            cancelUploads.call(tb, item);", "                        }},"]}, {"lines": ["                     m('span.text-muted','\u00d7')"]}, {"lines": ["                )),", "            ]),", "", "        ]); }", "    }];", "    if(tb.options.placement === 'files'){", "        columns.push({", "            data : '',  // Data field name", "            custom : function(){ return '';}", "        });", "    }", "    return columns;"]}, {"lines": ["};", ""]}, {"lines": ["/**"]}, {"lines": [" * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {Object}  Returns a mithril template with the m() function."]}, {"lines": [" */"]}, {"lines": ["        }"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["    }"]}, {"lines": [" * Returns custom icons for OSF depending on the type of item", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {Object}  Returns a mithril template with the m() function.", " * @private", " */", "function _fangornResolveIcon(item) {"]}, {"lines": ["    var privateFolder =  m('div.file-extension._folder_delete', ' '),"]}, {"lines": ["        pointerFolder = m('i.fa.fa-link', ' '),", "        openFolder  = m('i.fa.fa-folder-open', ' '),"]}, {"lines": ["        closedFolder = m('i.fa.fa-folder', ' '),"]}, {"lines": [""]}, {"lines": ["        }"]}, {"lines": ["        }"]}, {"lines": [""]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": ["// Addon config registry. this will be populated with add on specific items if any.", "Fangorn.config = {};"]}, {"lines": ["/**", " * Returns add on specific configurations", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @param {String} key What the option is called in the add on object", " * @this Treebeard.controller", " * @returns {*} Returns the configuration, can be string, number, array, or function;", " */", "function getconfig(item, key) {"]}, {"lines": ["    return undefined;", "}"]}, {"lines": ["/**", " * Gets a Fangorn config option if it is defined by an addon dev.", " * Calls it with `args` if it's a function otherwise returns the value.", " * If the config option is not defined, returns null", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @param {String} option What the option is called in the add on object", " * @param {Array} args An Array of whatever arguments will be sent with the .apply()", " * @this Treebeard.controller", " * @returns {*} Returns if its a property, runs the function if function, returns null if no option is defined.", " */", "function resolveconfigOption(item, option, args) {"]}, {"lines": ["        prop = getconfig(item, option);", "    if (prop) {", "        return typeof prop === 'function' ? prop.apply(self, args) : prop;"]}, {"lines": ["    }"]}, {"lines": ["    return null;", "}"]}, {"lines": [""]}, {"lines": ["/**"]}, {"lines": [" * Returns custom folder toggle icons for OSF", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {string} Returns a mithril template with m() function, or empty string.", " * @private", " */", "function _fangornResolveToggle(item) {"]}, {"lines": ["    var toggleMinus = m('i.fa.fa-minus', ' '),", "        togglePlus = m('i.fa.fa-plus', ' ');"]}, {"lines": ["    // check if folder has children whether it's lazyloaded or not."]}, {"lines": ["    if (item.kind === 'folder' && item.depth > 1) {"]}, {"lines": ["        if(!item.data.permissions.view){", "            return '';", "        }"]}, {"lines": ["        if (item.open) {", "            return toggleMinus;"]}, {"lines": ["        }"]}, {"lines": ["        return togglePlus;"]}, {"lines": ["    }"]}, {"lines": ["    return '';", "}", "", "/**", " * Checks if folder toggle is permitted (i.e. contents are private)", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {boolean}", " * @private", " */", "function _fangornToggleCheck(item) {"]}, {"lines": ["    if (item.data.permissions.view) {", "        return true;"]}, {"lines": ["    }"]}, {"lines": ["    item.notify.update('Not allowed: Private folder', 'warning', 1, undefined);", "    return false;", "}"]}, {"lines": [""]}, {"lines": ["    _fangornOrderFolder.call(tb, from.parent());", ""]}, {"lines": ["        // no need to redraw because fangornOrderFolder does it"]}, {"lines": ["        _fangornOrderFolder.call(tb, from.parent());"]}, {"lines": ["/**", " * Find out what the upload URL is for each item", " * Because we use add ons each item will have something different. This needs to be in the json data.", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {String} Returns the url string from data or resolved through add on settings.", " * @private", " */"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**", " * Event to fire when mouse is hovering over row. Currently used for hover effect.", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @param event The mouseover event from the browser", " * @this Treebeard.controller", " * @private", " */", "function _fangornMouseOverRow(item, event) {", "    $('.fg-hover-hide').hide();", "    $(event.target).closest('.tb-row').find('.fg-hover-hide').show();", "}", "", "/**", " * Runs when dropzone uploadprogress is running, used for updating upload progress in view and models.", " * @param {Object} treebeard The treebeard instance currently being run, check Treebeard API", " * @param {Object} file File object that dropzone passes", " * @param {Number} progress Progress number between 0 and 100", " * @this Dropzone", " * @private", " */", "function _fangornUploadProgress(treebeard, file, progress) {"]}, {"lines": ["        child,"]}, {"lines": ["        templateWithCancel,", "        templateWithoutCancel;"]}, {"lines": ["    for(var i = 0; i < parent.children.length; i++) {", "        child = parent.children[i];", "        if(!child.data.tmpID){", "            continue;", "        }", "        if(child.data.tmpID === file.tmpID) {", "            item = child;"]}, {"lines": ["            item.data.progress = progress;", "            item.data.uploadState('uploading');"]}, {"lines": ["        }", "    }"]}, {"lines": ["    m.redraw();"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**", " * Runs when dropzone sending method is running, used for updating the view while file is being sent.", " * @param {Object} treebeard The treebeard instance currently being run, check Treebeard API", " * @param {Object} file File object that dropzone passes", " * @param xhr xhr information being sent", " * @param formData Dropzone's formdata information", " * @this Dropzone", " * @returns {*|null} Return isn't really used here by anything else.", " * @private", " */", "function _fangornSending(treebeard, file, xhr, formData) {"]}, {"lines": ["    treebeard.options.uploadInProgress = true;"]}, {"lines": ["    return configOption || null;", "}"]}, {"lines": ["/**", " * Runs when Dropzone's addedfile hook is run.", " * @param {Object} treebeard The treebeard instance currently being run, check Treebeard API", " * @param {Object} file File object that dropzone passes", " * @this Dropzone", " * @returns {*|null}", " * @private", " */", "function _fangornAddedFile(treebeard, file) {"]}, {"lines": ["    var tmpID = tempCounter++;", "", "    file.tmpID = tmpID;"]}, {"lines": ["        name: file.name,", "        kind: 'file',", "        provider: item.data.provider,", "        children: [],", "        permissions: {", "            view: false,", "            edit: false", "        },"]}, {"lines": ["        tmpID: tmpID,"]}, {"lines": ["        uploadState : m.prop('pending')"]}, {"lines": ["    };"]}, {"lines": ["    var newitem = treebeard.createItem(blankItem, item.id);"]}, {"lines": ["    return configOption || null;", "}"]}, {"lines": ["/**", " * Runs when Dropzone's dragover event hook is run.", " * @param {Object} treebeard The treebeard instance currently being run, check Treebeard API", " * @param event DOM event object", " * @this Dropzone", " * @private", " */", "function _fangornDragOver(treebeard, event) {"]}, {"lines": ["        closestTarget = $(event.target).closest('.tb-row'),"]}, {"lines": ["        item = treebeard.find(itemID);"]}, {"lines": ["    treebeard.select('.tb-row').removeClass(dropzoneHoverClass).removeClass(treebeard.options.hoverClass);"]}, {"lines": ["    if (item !== undefined) {"]}, {"lines": ["            closestTarget.addClass(dropzoneHoverClass);"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**"]}, {"lines": [" * Runs when Dropzone's drop event hook is run.", " * @param {Object} treebeard The treebeard instance currently being run, check Treebeard API", " * @param event DOM event object", " * @this Dropzone", " * @private", " */", "function _fangornDropzoneDrop(treebeard, event) {", "    var dropzoneHoverClass = 'fangorn-dz-hover';", "    treebeard.select('.tb-row').removeClass(dropzoneHoverClass);", "}", "/**"]}, {"lines": [" * Runs when Dropzone's complete hook is run after upload is completed.", " * @param {Object} treebeard The treebeard instance currently being run, check Treebeard API", " * @param {Object} file File object that dropzone passes", " * @this Dropzone", " * @private", " */", "function _fangornComplete(treebeard, file) {"]}, {"lines": ["    resolveconfigOption.call(treebeard, item, 'onUploadComplete', [item]);"]}, {"lines": ["    _fangornOrderFolder.call(treebeard, item);"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**", " * Runs when Dropzone's success hook is run.", " * @param {Object} treebeard The treebeard instance currently being run, check Treebeard API", " * @param {Object} file File object that dropzone passes", " * @param {Object} response JSON response from the server", " * @this Dropzone", " * @private", " */", "function _fangornDropzoneSuccess(treebeard, file, response) {"]}, {"lines": ["        revisedItem,"]}, {"lines": ["        child = parent.children[i];"]}, {"lines": ["            continue;", "        }"]}, {"lines": ["            item = child;", "        }", "    }"]}, {"lines": ["    // RESPONSES", "    // OSF : Object with actionTake : \"file_added\"", "    // DROPBOX : Object; addon : 'dropbox'", "    // S3 : Nothing", "    // GITHUB : Object; addon : 'github'", "    // Dataverse : Object, actionTaken : file_uploaded", "    revisedItem = resolveconfigOption.call(treebeard, item.parent(), 'uploadSuccess', [file, item, response]);", "    if (!revisedItem && response) {"]}, {"lines": ["    }"]}, {"lines": ["        item.data.uploadState('completed');"]}, {"lines": ["            }"]}, {"lines": ["    }"]}, {"lines": ["    treebeard.redraw();", "}"]}, {"lines": [""]}, {"lines": ["/**", " * runs when Dropzone's error hook runs. Notifies user with error.", " * @param {Object} treebeard The treebeard instance currently being run, check Treebeard API", " * @param {Object} file File object that dropzone passes", " * @param message Error message returned", " * @private", " */"]}, {"lines": ["    var tb = treebeard;"]}, {"lines": ["        child = parent.children[i];"]}, {"lines": ["            continue;", "        }"]}, {"lines": ["        }", "    }"]}, {"lines": ["    $osf.growl('Error', msgText);"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**", " * Click event for when upload buttonin Action Column, it essentially runs the hiddenFileInput.click", " * @param event DOM event object for click", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @param {Object} col Information pertinent to that column where this upload event is run from", " * @private", " */", "function _uploadEvent(event, item, col) {"]}, {"lines": ["    try {", "        event.stopPropagation();", "    } catch (e) {", "        window.event.cancelBubble = true;"]}, {"lines": ["    }"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**", " * Download button in Action Column", " * @param event DOM event object for click", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @param {Object} col Information pertinent to that column where this upload event is run from", " * @private", " */", "function _downloadEvent (event, item, col) {", "    try {", "        event.stopPropagation();", "    } catch (e) {", "        window.event.cancelBubble = true;"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["function _createFolder(event, dismissCallback, helpText) {"]}, {"lines": ["    var tb = this;", "    var val = $.trim(tb.select('#createFolderInput').val());"]}, {"lines": ["    var parent = tb.multiselected()[0];"]}, {"lines": ["    if (!parent.open) {", "         tb.updateFolder(null, parent);", "    }"]}, {"lines": ["    if (val.length < 1) {"]}, {"lines": ["        helpText('Please enter a folder name.');"]}, {"lines": ["        return;"]}, {"lines": ["    if (val.indexOf('/') !== -1) {"]}, {"lines": ["        helpText('Folder name contains illegal characters.');"]}, {"lines": ["        return;"]}, {"lines": ["    var path = (parent.data.path || '/') + val + '/';", ""]}, {"lines": ["    m.request({", "        method: 'POST',", "        background: true,"]}, {"lines": ["        url: waterbutler.buildCreateFolderUrl(path, parent.data.provider, parent.data.nodeId)"]}, {"lines": ["    }).then(function(item) {"]}, {"lines": ["        item = tb.createItem(item, parent.id);", "        _fangornOrderFolder.call(tb, parent);", "        item.notify.update('New folder created!', 'success', undefined, 1000);"]}, {"lines": ["        if(dismissCallback) {", "            dismissCallback();", "        }"]}, {"lines": ["    }, function(data) {", "        if (data && data.code === 409) {"]}, {"lines": ["            helpText(data.message);"]}, {"lines": ["        } else {"]}, {"lines": ["            helpText('Folder creation failed.');"]}, {"lines": ["        }", "    });"]}, {"lines": ["/**", " * Deletes the item, only appears for items", " * @param event DOM event object for click", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @param {Object} col Information pertinent to that column where this upload event is run from", " * @private", " */"]}, {"lines": [""]}, {"lines": ["function _removeEvent (event, items, col) {", "    var tb = this;"]}, {"lines": ["        tb.modal.dismiss();"]}, {"lines": ["    }"]}, {"lines": ["    function runDelete(item) {"]}, {"lines": ["        tb.select('.tb-modal-footer .text-danger').html('<i> Deleting...</i>').css('color', 'grey');"]}, {"lines": ["        // delete from server, if successful delete from view"]}, {"lines": ["        $.ajax({"]}, {"lines": ["            // delete view", "            tb.deleteNode(item.parentID, item.id);"]}, {"lines": ["            tb.modal.dismiss();"]}, {"lines": ["            tb.clearMultiselect();"]}, {"lines": ["            tb.modal.dismiss();"]}, {"lines": ["            tb.clearMultiselect();"]}, {"lines": ["            item.notify.update('Delete failed.', 'danger', undefined, 3000);", "        });"]}, {"lines": ["    }"]}, {"lines": ["    function runDeleteMultiple(items){", "        items.forEach(function(item){", "            runDelete(item);", "        });", "    }"]}, {"lines": [""]}, {"lines": ["        var folder = items[0];", "        if (folder.data.permissions.edit) {"]}, {"lines": ["                        m('h3.break-word', 'Delete \"' + folder.data.name+ '\"?'),"]}, {"lines": ["                        m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function() { cancelDelete.call(tb); } }, 'Cancel'),"]}, {"lines": ["                        m('span.tb-modal-btn', { 'class' : 'text-danger', onclick : function() { runDelete(folder); }  }, 'Delete')"]}, {"lines": ["            folder.notify.update('You don\\'t have permission to delete this file.', 'info', undefined, 3000);"]}, {"lines": ["    // If there is only one item being deleted, don't complicate the issue:", "    if(items.length === 1) {"]}, {"lines": ["        if(items[0].kind !== 'folder'){", "            var mithrilContentSingle = m('div', [", "                m('h3.break-word', 'Delete \"' + items[0].data.name + '\"'),", "                m('p', 'This action is irreversible.')", "            ]);", "            var mithrilButtonsSingle = m('div', [", "                m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function() { cancelDelete(); } }, 'Cancel'),"]}, {"lines": ["                m('span.tb-modal-btn', { 'class' : 'text-danger', onclick : function() { runDelete(items[0]); }  }, 'Delete')"]}, {"lines": ["            ]);", "            // This is already being checked before this step but will keep this edit permission check", "            if(items[0].data.permissions.edit){", "                tb.modal.update(mithrilContentSingle, mithrilButtonsSingle);"]}, {"lines": ["            }"]}, {"lines": ["        }"]}, {"lines": ["        if(items[0].kind === 'folder') {", "            if (!items[0].open) {", "                tb.updateFolder(null, items[0], doDelete);", "            } else {"]}, {"lines": ["                doDelete();"]}, {"lines": ["            }"]}, {"lines": ["        }"]}, {"lines": ["    } else {"]}, {"lines": ["        // Check if all items can be deleted", "        var canDelete = true;", "        var deleteList = [];", "        var noDeleteList = [];"]}, {"lines": ["        var deleteMessage = [m('p', 'This action is irreversible.')];"]}, {"lines": ["        var mithrilContentMultiple;", "        var mithrilButtonsMultiple;", "        items.forEach(function(item, index, arr){", "            if(!item.data.permissions.edit){", "                canDelete = false;", "                noDeleteList.push(item);", "            } else {", "                deleteList.push(item);", "            }"]}, {"lines": ["            if(item.kind === 'folder' && deleteMessage.length === 1) {"]}, {"lines": ["            }"]}, {"lines": ["        });"]}, {"lines": ["        // If all items can be deleted"]}, {"lines": ["        if(canDelete){", "            mithrilContentMultiple = m('div', [", "                    m('h3.break-word', 'Delete multiple files?'),"]}, {"lines": ["                    deleteMessage,", "                    deleteList.map(function(n){", "                        if(n.kind === 'folder'){"]}, {"lines": ["                            return m('.fangorn-canDelete.text-success.break-word', ["]}, {"lines": ["                                m('i.fa.fa-folder'),m('b', ' ' + n.data.name)", "                                ]);", "                        }"]}, {"lines": ["                        return m('.fangorn-canDelete.text-success.break-word', n.data.name);"]}, {"lines": ["                    })", "                ]);", "            mithrilButtonsMultiple =  m('div', ["]}, {"lines": ["                    m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function() { tb.modal.dismiss(); } }, 'Cancel'),"]}, {"lines": ["                    m('span.tb-modal-btn', { 'class' : 'text-danger', onclick : function() { runDeleteMultiple.call(tb, deleteList); }  }, 'Delete All')"]}, {"lines": ["                ]);"]}, {"lines": ["        } else {", "            mithrilContentMultiple = m('div', [", "                    m('h3.break-word', 'Delete multiple files?'),", "                    m('p', 'Some of these files can\\'t be deleted but you can delete the ones highlighted with green. This action is irreversible.'),", "                    deleteList.map(function(n){"]}, {"lines": ["                        if(n.kind === 'folder'){"]}, {"lines": ["                            return m('.fangorn-canDelete.text-success.break-word', ["]}, {"lines": ["                                m('i.fa.fa-folder'),m('b', ' ' + n.data.name)", "                                ]);", "                        }"]}, {"lines": ["                        return m('.fangorn-canDelete.text-success.break-word', n.data.name);"]}, {"lines": ["                    }),", "                    noDeleteList.map(function(n){"]}, {"lines": ["                        return m('.fangorn-noDelete.text-warning.break-word', n.data.name);"]}, {"lines": ["                    })"]}, {"lines": ["                ]);"]}, {"lines": ["            mithrilButtonsMultiple =  m('div', ["]}, {"lines": ["                    m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function() {  tb.modal.dismiss(); } }, 'Cancel'),"]}, {"lines": ["                    m('span.tb-modal-btn', { 'class' : 'text-danger', onclick : function() { runDeleteMultiple.call(tb, deleteList); }  }, 'Delete Some')"]}, {"lines": ["                ]);"]}, {"lines": ["        }"]}, {"lines": ["        tb.modal.update(mithrilContentMultiple, mithrilButtonsMultiple);"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**", " * Resolves lazy load url for fetching children", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {String|Boolean} Returns the fetch URL in string or false if there is no url.", " * @private", " */", "function _fangornResolveLazyLoad(item) {", "    var configOption = resolveconfigOption.call(this, item, 'lazyload', [item]);", "    if (configOption) {", "        return configOption;"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": [" * Handles errors in lazyload fetching of items, usually link is wrong", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller", " * @private", " */", "function _fangornLazyLoadError (item) {", "    var configOption = resolveconfigOption.call(this, item, 'lazyLoadError', [item]);", "    if (!configOption) {"]}, {"lines": ["}"]}, {"lines": ["/**"]}, {"lines": [" * Applies the positionining and initialization of tooltips for file names", " * @private", " */"]}, {"lines": ["function reapplyTooltips () {"]}, {"lines": ["    $('[data-toggle=\"tooltip\"]').tooltip({container: 'body', 'animation' : false});"]}, {"lines": ["}"]}, {"lines": ["/**"]}, {"lines": [" * @param {Object} tree A Treebeard _item object for the row involved. Node information is inside item.data"]}, {"lines": ["function _fangornLazyLoadOnLoad (tree, event) {"]}, {"lines": ["    resolveconfigOption.call(this, tree, 'lazyLoadOnLoad', [tree, event]);"]}, {"lines": ["    reapplyTooltips();"]}, {"lines": ["", "    if (tree.depth > 1) {", "        _fangornOrderFolder.call(this, tree);", "    }"]}, {"lines": ["}", "", "/**", " * Order contents of a folder without an entire sorting of all the table", " * @param {Object} tree A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller", " * @private", " */", "function _fangornOrderFolder(tree) {"]}, {"lines": ["    // Checking if this column does in fact have sorting", "    if (this.isSorted[0]) {", "        var sortDirection = this.isSorted[0].desc ? 'desc' : 'asc';"]}, {"lines": ["        tree.sortChildren(this, sortDirection, 'text', 0, 1);"]}, {"lines": ["        this.redraw();"]}, {"lines": ["    }"]}, {"lines": [" * Changes the upload method based on what the add ons need. Default is POST, S3 needs PUT", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {string} Must return string that is a legitimate method like POST, PUT", " * @private", " */", "function _fangornUploadMethod(item) {", "    var configOption = resolveconfigOption.call(this, item, 'uploadMethod', [item]);"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["", "function gotoFileEvent (item) {", "    var tb = this;", "    var redir = new URI(item.data.nodeUrl);", "    redir.segment('files').segment(item.data.provider).segmentCoded(item.data.path.substring(1));", "    var fileurl  = redir.toString() + '/';", "    if(COMMAND_KEYS.indexOf(tb.pressedKey) !== -1) {", "        window.open(fileurl, '_blank');", "    } else {", "        window.open(fileurl, '_self');", "    }", "}"]}, {"lines": ["/**", " * Defines the contents of the title column (does not include the toggle and folder sections", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @param {Object} col Options for this particulat column", " * @this Treebeard.controller", " * @returns {Array} Returns an array of mithril template objects using m()", " * @private", " */", "function _fangornTitleColumn(item, col) {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    if (item.kind === 'file' && item.data.permissions.view) {"]}, {"lines": ["        return m('span.fg-file-links',{"]}, {"lines": ["            onclick: function(event) {", "                event.stopImmediatePropagation();"]}, {"lines": ["                gotoFileEvent.call(tb, item);"]}, {"lines": ["            }"]}, {"lines": ["        }, item.data.name);", "    }", "    return m('span', item.data.name);"]}, {"lines": ["}", "", "/**", " * Parent function for resolving rows, all columns are sub methods within this function", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {Array} An array of columns that get iterated through in Treebeard", " * @private", " */"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    if(tb.isMultiselected(item.id)){"]}, {"lines": ["        item.css = 'fangorn-selected';", "    }"]}, {"lines": [""]}, {"lines": ["    if(item.data.uploadState && (item.data.uploadState() === 'pending' || item.data.uploadState() === 'uploading')){", "        return uploadRowTemplate.call(tb, item);"]}, {"lines": ["    }"]}, {"lines": ["    if (item.data.status) {"]}, {"lines": ["    }"]}, {"lines": ["    }"]}, {"lines": ["    default_columns.push(", "    {"]}, {"lines": ["        data : 'name',  // Data field name", "        folderIcons : true,", "        filter : true,", "        custom : _fangornTitleColumn", "    });"]}, {"lines": ["        });"]}, {"lines": ["    return configOption || default_columns;"]}, {"lines": [""]}, {"lines": ["/**", " * Defines Column Titles separately since content and css may be different, allows more flexibility", " * @returns {Array} an Array of column information that gets templated inside Treebeard", " * @this Treebeard.controller", " * @private", " */", "function _fangornColumnTitles () {", "    var columns = [];"]}, {"lines": ["    columns.push("]}, {"lines": ["    {"]}, {"lines": ["        title: 'Name',"]}, {"lines": ["        sort : true,", "        sortType : 'text'", "    }, {"]}, {"lines": ["        title : 'Downloads',"]}, {"lines": ["        width : '10%',"]}, {"lines": ["        sort : false", "    });", "    return columns;", "}", "", "/**", " * When fangorn loads the top level needs to be open so we load the children on load", " * @this Treebeard.controller", " * @private", " */", "function _loadTopLevelChildren() {", "    var i;", "    for (i = 0; i < this.treeData.children.length; i++) {", "        this.updateFolder(null, this.treeData.children[i]);"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**"]}, {"lines": [" * Expand major addons on load", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller", " * @private", " */", "function expandStateLoad(item) {", "    var tb = this,", "        i;"]}, {"lines": ["    if (item.children.length > 0 && item.depth === 1) {", "        for (i = 0; i < item.children.length; i++) {"]}, {"lines": ["            // if (item.children[i].data.isAddonRoot || item.children[i].data.addonFullName === 'OSF Storage' ) {", "                tb.updateFolder(null, item.children[i]);", "            // }", "        }", "    }", "    if (item.children.length > 0 && item.depth === 2) {", "        for (i = 0; i < item.children.length; i++) {"]}, {"lines": ["            if (item.children[i].data.isAddonRoot || item.children[i].data.addonFullName === 'OSF Storage' ) {", "                tb.updateFolder(null, item.children[i]);", "            }", "        }", "    }"]}, {"lines": ["        $('.fangorn-toolbar-icon').tooltip();"]}, {"lines": ["}", ""]}, {"lines": ["    if(!file){", "        return;", "    }"]}, {"lines": ["        var scrollTo = visibleIndex * tb.options.rowHeight;", "        this.select('#tb-tbody').scrollTop(scrollTo);"]}, {"lines": [""]}, {"lines": ["function _renameEvent () {", "    var tb = this;", "    var item = tb.multiselected()[0];", "    var val = $.trim($('#renameInput').val());", "    var folder = item.parent();"]}, {"lines": ["    tb.toolbarMode(toolbarModes.DEFAULT);", "}"]}, {"lines": ["var toolbarModes = {", "    'DEFAULT' : 'bar',", "    'SEARCH' : 'search',", "    'ADDFOLDER' : 'addFolder',", "    'RENAME' : 'rename',", "    'ADDPROJECT' : 'addProject'", "};", "", ""]}, {"lines": ["// A fangorn-styled button; addons can reuse this", "var FGButton = {"]}, {"lines": ["    view: function(ctrl, args, children) {", "        var extraCSS = args.className || '';"]}, {"lines": ["        var tooltipText = args.tooltip || '';", "        var iconCSS = args.icon || '';"]}, {"lines": ["        var onclick = args.onclick || noop;"]}, {"lines": ["            className: 'fangorn-toolbar-icon ' + extraCSS,"]}, {"lines": ["            m('i', {className: iconCSS}),"]}, {"lines": ["            m('span', children)"]}, {"lines": ["        ]);"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["var FGInput = {"]}, {"lines": ["    view : function(ctrl, args, helpText) {"]}, {"lines": ["        var extraCSS = args.className || '';", "        var tooltipText = args.tooltip || '';", "        var placeholder = args.placeholder || '';", "        var id = args.id || '';", "        var helpTextId = args.helpTextId || '';"]}, {"lines": ["        var onclick = args.onclick || noop;"]}, {"lines": ["        var onkeypress = args.onkeypress || noop;"]}, {"lines": ["        var value = args.value ? '[value=\"' + args.value + '\"]' : '';"]}, {"lines": ["        return m('span', ["]}, {"lines": ["            m('input' + value, {"]}, {"lines": ["                'id' : id,", "                className: 'tb-header-input' + extraCSS,"]}, {"lines": ["                onclick: onclick,"]}, {"lines": ["                onkeypress: onkeypress,"]}, {"lines": ["                'data-toggle':  tooltipText ? 'tooltip' : '',"]}, {"lines": ["                'title':  tooltipText,"]}, {"lines": ["                'data-placement' : 'bottom',"]}, {"lines": ["                'placeholder' : placeholder"]}, {"lines": ["                }),", "            m('.text-danger', {"]}, {"lines": ["                'id' : helpTextId"]}, {"lines": ["            }, helpText)"]}, {"lines": ["        ]);", "    }"]}, {"lines": [""]}, {"lines": ["var FGDropdown = {"]}, {"lines": ["    view : function(ctrl, args, children) {", "        var extraCSS = args.className || '';", "        var tooltipText = args.tooltip || '';", "        var id = args.id || '';", "        var name = args.name || '';", "        var label = args.label || '';"]}, {"lines": ["        var onchange = args.onchange || noop;"]}, {"lines": ["            },[", "                m('span.hidden-xs',label),", "                m('select.no-border', {", "                    'name' : name,", "                    'id' : id,"]}, {"lines": ["                    onchange: onchange,"]}, {"lines": ["                    'data-toggle':  tooltipText ? 'tooltip' : '',"]}, {"lines": ["                    'title':  tooltipText,", "                    'data-placement' : 'bottom'"]}, {"lines": ["                }, children)"]}, {"lines": ["        ]);"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["var FGItemButtons = {"]}, {"lines": ["    view : function(ctrl, args, children) {"]}, {"lines": ["        var tb = args.treebeard;"]}, {"lines": ["        var item = args.item;", "        var rowButtons = [];"]}, {"lines": ["        var mode = args.mode;"]}, {"lines": ["        if (window.File && window.FileReader && item.kind === 'folder' && item.data.provider && item.data.permissions && item.data.permissions.edit) {", "            rowButtons.push(", "                m.component(FGButton, {"]}, {"lines": ["                    icon: 'fa fa-upload',", "                    className : 'text-primary'", "                }, 'Upload'),", "                m.component(FGButton, {"]}, {"lines": ["                    onclick: function() {", "                        mode(toolbarModes.ADDFOLDER);", "                    },"]}, {"lines": ["                    icon: 'fa fa-plus',", "                    className : 'text-primary'", "                }, 'Create Folder'));", "            if(item.data.path){", "                rowButtons.push(", "                    m.component(FGButton, {"]}, {"lines": ["                        icon: 'fa fa-trash',", "                        className : 'text-danger'", "                    }, 'Delete Folder'));", "            }", "        }", "        if (item.kind === 'file'){"]}, {"lines": ["            rowButtons.push(", "                m.component(FGButton, {"]}, {"lines": ["                    icon: 'fa fa-download',", "                    className : 'text-success'", "                }, 'Download')", "            );", "            if (item.data.permissions && item.data.permissions.edit) {", "                rowButtons.push(", "                    m.component(FGButton, {"]}, {"lines": ["                        icon: 'fa fa-trash',", "                        className : 'text-danger'", "                    }, 'Delete'));", "", "            }"]}, {"lines": ["        }"]}, {"lines": ["        if(item.data.provider && !item.data.isAddonRoot && item.data.permissions && item.data.permissions.edit) {", "            rowButtons.push(", "                m.component(FGButton, {", "                    onclick: function() {", "                        mode(toolbarModes.RENAME);", "                    },"]}, {"lines": ["                    icon: 'fa fa-font',", "                    className : 'text-info'", "                }, 'Rename')", "            );", "        }"]}, {"lines": ["        return m('span', rowButtons);", "    }"]}, {"lines": [""]}, {"lines": ["var _dismissToolbar = function(){"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    if (tb.toolbarMode() === toolbarModes.SEARCH){"]}, {"lines": ["        tb.resetFilter();", "    }"]}, {"lines": ["    tb.toolbarMode(toolbarModes.DEFAULT);"]}, {"lines": ["    tb.filterText('');"]}, {"lines": ["    m.redraw();"]}, {"lines": ["};", ""]}, {"lines": ["var FGToolbar = {", "    controller : function(args) {"]}, {"lines": ["        var self = this;", "        self.tb = args.treebeard;"]}, {"lines": ["        self.tb.toolbarMode = m.prop(toolbarModes.DEFAULT);"]}, {"lines": ["        self.items = args.treebeard.multiselected;"]}, {"lines": ["        self.mode = self.tb.toolbarMode;"]}, {"lines": ["        self.isUploading = args.treebeard.isUploading;"]}, {"lines": ["        self.helpText = m.prop('');"]}, {"lines": ["        self.dismissToolbar = _dismissToolbar.bind(self.tb);"]}, {"lines": ["        self.createFolder = function(event){", "            _createFolder.call(self.tb, event, self.dismissToolbar, self.helpText );", "        };"]}, {"lines": ["    },", "    view : function(ctrl) {", "        var templates = {};"]}, {"lines": ["        var generalButtons = [];"]}, {"lines": ["        var finalRowButtons = [];"]}, {"lines": ["        var items = ctrl.items();", "        var item = items[0];"]}, {"lines": ["        var dismissIcon = m.component(FGButton, {", "                onclick: ctrl.dismissToolbar,"]}, {"lines": ["                icon : 'fa fa-times'"]}, {"lines": ["            }, '');"]}, {"lines": ["        templates[toolbarModes.SEARCH] =  ["]}, {"lines": ["            m('.col-xs-10', ["]}, {"lines": ["                ctrl.tb.options.filterTemplate.call(ctrl.tb)"]}, {"lines": ["                ]),"]}, {"lines": ["                m('.col-xs-2.tb-buttons-col',"]}, {"lines": ["                    m('.fangorn-toolbar.pull-right', [dismissIcon])"]}, {"lines": ["                )", "            ];"]}, {"lines": ["        templates[toolbarModes.ADDFOLDER] = ["]}, {"lines": ["            m('.col-xs-9', [", "                m.component(FGInput, {"]}, {"lines": ["                    onkeypress: function(event){", "                        if (ctrl.tb.pressedKey === ENTER_KEY) {", "                            _createFolder.call(ctrl.tb, event, ctrl.dismissToolbar);", "                        }", "                    },"]}, {"lines": ["                    id : 'createFolderInput',", "                    helpTextId : 'createFolderHelp',", "                    placeholder : 'New folder name',"]}, {"lines": ["                }, ctrl.helpText())"]}, {"lines": ["            ]),", "            m('.col-xs-3.tb-buttons-col',", "                m('.fangorn-toolbar.pull-right',", "                    [", "                        m.component(FGButton, {"]}, {"lines": ["                            onclick: ctrl.createFolder,"]}, {"lines": ["                            icon : 'fa fa-plus',", "                            className : 'text-success'"]}, {"lines": ["                        }, 'Create'),"]}, {"lines": ["                        dismissIcon"]}, {"lines": ["                    ]", "                )", "            )"]}, {"lines": ["        templates[toolbarModes.RENAME] = [", "            m('.col-xs-9',", "                m.component(FGInput, {", "                    onkeypress: function (event) {"]}, {"lines": ["                        if (ctrl.tb.pressedKey === ENTER_KEY) {", "                            _renameEvent.call(ctrl.tb);", "                        }", "                    },", "                    id : 'renameInput',", "                    helpTextId : 'renameHelpText',", "                    placeholder : null,"]}, {"lines": ["                }, ctrl.helpText())", "            ),", "            m('.col-xs-3.tb-buttons-col',", "                m('.fangorn-toolbar.pull-right',", "                    [", "                        m.component(FGButton, {", "                            onclick: function () {", "                                _renameEvent.call(ctrl.tb);", "                            },"]}, {"lines": ["                            icon : 'fa fa-pencil',", "                            className : 'text-info'", "                        }, 'Rename'),", "                        dismissIcon", "                    ]", "                )", "            )", "        ];"]}, {"lines": ["        // Bar mode"]}, {"lines": ["        // Which buttons should show?"]}, {"lines": ["        if(items.length === 1){"]}, {"lines": ["            var addonButtons = resolveconfigOption.call(ctrl.tb, item, 'itemButtons', [item]);", "            if (addonButtons) {", "                finalRowButtons = m.component(addonButtons, { treebeard : ctrl.tb, item : item }); // jshint ignore:line", "            } else {"]}, {"lines": ["                finalRowButtons = m.component(FGItemButtons, {treebeard : ctrl.tb, mode : ctrl.mode, item : item }); // jshint ignore:line"]}, {"lines": ["            }"]}, {"lines": ["        }"]}, {"lines": ["        if(ctrl.isUploading()){"]}, {"lines": ["            generalButtons.push(", "                m.component(FGButton, {", "                    onclick: function() {", "                        cancelUploads.call(ctrl.tb);", "                    },"]}, {"lines": ["                    icon: 'fa fa-time-circle',"]}, {"lines": ["                }, 'Cancel Pending Uploads')"]}, {"lines": ["            );"]}, {"lines": ["        }"]}, {"lines": ["        //multiple selection icons"]}, {"lines": ["        if(items.length > 1 && ctrl.tb.multiselected()[0].data.provider !== 'github') {"]}, {"lines": ["                if (each.data.permissions.edit && !each.data.isAddonRoot && !each.data.nodeType) {"]}, {"lines": ["                }"]}, {"lines": ["                generalButtons.push(", "                    m.component(FGButton, {"]}, {"lines": ["                            var configOption = resolveconfigOption.call(ctrl.tb, item, 'removeEvent', [event, items]); // jshint ignore:line", "                            if(!configOption){ _removeEvent.call(ctrl.tb, null, items); }", "                        },"]}, {"lines": ["                        icon: 'fa fa-trash',", "                        className : 'text-danger'", "                    }, 'Delete Multiple')", "                );", "            }"]}, {"lines": ["        }"]}, {"lines": ["        generalButtons.push("]}, {"lines": ["            m.component(FGButton, {"]}, {"lines": ["                onclick: function(event){"]}, {"lines": ["                    ctrl.mode(toolbarModes.SEARCH);"]}, {"lines": ["                },"]}, {"lines": ["                icon: 'fa fa-search',", "                className : 'text-primary'", "            }, 'Search'),", "            m.component(FGButton, {", "                onclick: function(event){", "                    var mithrilContent = m('div', ["]}, {"lines": ["                        m('h3.break-word.m-b-lg', 'How to Use the File Browser'),"]}, {"lines": ["                        m('p', [ m('b', 'Open Files:'), m('span', ' Click a file name to go to the file.')]),"]}, {"lines": ["                    ]);"]}, {"lines": ["                    var mithrilButtons = m('div', ["]}, {"lines": ["                    ]);"]}, {"lines": ["                    ctrl.tb.modal.update(mithrilContent, mithrilButtons);", "                },"]}, {"lines": ["                icon: 'fa fa-info',", "                className : 'text-info'", "            }, '')", "        );"]}, {"lines": [""]}, {"lines": ["        return m('.row.tb-header-row', [", "            m('#folderRow', { config : function () {", "                $('#folderRow input').focus();", "            }}, [", "                templates[ctrl.mode()]", "            ])", "        ]);", "    }"]}, {"lines": [""]}, {"lines": ["/**", " * When multiple rows are selected remove those that are not in the parent", " * @param {Array} rows List of item objects", " * @returns {Array} newRows Returns the revised list of rows", " */", "function filterRowsNotInParent(rows) {"]}, {"lines": ["    var tb = this;", "    if (tb.multiselected().length < 2) {", "        return tb.multiselected();"]}, {"lines": ["    }", "    var i, newRows = [],"]}, {"lines": ["        originalRow = tb.find(tb.multiselected()[0].id),"]}, {"lines": ["        originalParent,", "        currentItem;"]}, {"lines": ["        originalParent = originalRow.parentID;", "        for (i = 0; i < rows.length; i++) {", "            currentItem = rows[i];", "            if (currentItem.parentID === originalParent && currentItem.id !== -1) {", "                newRows.push(rows[i]);"]}, {"lines": ["            } else {"]}, {"lines": ["            }", "        }", "    }"]}, {"lines": ["    tb.multiselected(newRows);", "    tb.highlightMultiselect();"]}, {"lines": ["    return newRows;", "}", ""]}, {"lines": ["/**", " * Helper function that turns parent open values to true to respective redraws can open the folder", " * @this Treebeard.controller", " * @param {Object} item A Treebeard _item object.", " * @private", " */", "function _openParentFolders (item) {", "    var tb = this;", "    // does it have a parent? If so change open", "    var parent = item.parent();"]}, {"lines": ["    if(parent ){", "        if(!parent.open) {", "            var index = tb.returnIndex(parent.id);", "            parent.load = true;", "            tb.toggleFolder(index);", "        }"]}, {"lines": ["        _openParentFolders.call(tb, parent);", "    }", "    return;", "}"]}, {"lines": ["", "/**", " * Handles multiselect conditions and actions", " * @this Treebeard.controller"]}, {"lines": [" * @param {Object} event jQuery click event.", " * @param {Object} row A Treebeard _item object."]}, {"lines": [" * @private", " */"]}, {"lines": [" function _fangornMultiselect (event, row) {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    var scrollToItem = false;"]}, {"lines": ["    filterRowsNotInParent.call(tb, tb.multiselected());"]}, {"lines": ["    if (tb.toolbarMode() === 'search') {"]}, {"lines": ["        _dismissToolbar.call(tb);"]}, {"lines": ["        scrollToItem = true;"]}, {"lines": ["        // recursively open parents of the selected item but do not lazyload;"]}, {"lines": ["        _openParentFolders.call(tb, row);"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["    if (tb.multiselected().length === 1){"]}, {"lines": ["        tb.select('#tb-tbody').removeClass('unselectable');"]}, {"lines": ["        if(scrollToItem) {"]}, {"lines": ["             scrollToFile.call(tb, tb.multiselected()[0].id);"]}, {"lines": ["        }"]}, {"lines": ["    } else if (tb.multiselected().length > 1) {"]}, {"lines": ["        tb.select('#tb-tbody').addClass('unselectable');"]}, {"lines": ["    }"]}, {"lines": ["    m.redraw();"]}, {"lines": ["    reapplyTooltips();"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/* BEGIN MOVE */"]}, {"lines": ["// copyMode can be 'copy', 'move', 'forbidden', or null.", "// This is set at draglogic and is used as global within this module", "var copyMode = null;", "", "// Set altkey global to fangorn", "    var altKey = false;", "    $(document).keydown(function (e) {", "        if (e.altKey) {", "            altKey = true;", "        }", "    });", "    $(document).keyup(function (e) {", "        if (!e.altKey) {", "            altKey = false;", "        }", "    });", ""]}, {"lines": ["/**", " * Hook for the drag start event on jquery", " * @param event jQuery UI drggable event object", " * @param ui jQuery UI draggable ui object", " * @private", " */", "function _fangornDragStart(event, ui) {", "    var itemID = $(event.target).attr('data-id'),", "        item = this.find(itemID);"]}, {"lines": ["    if (this.multiselected().length < 2) {", "        this.multiselected([item]);"]}, {"lines": ["    }", "}", "", "/**", " * Hook for the drop event of jQuery UI droppable", " * @param event jQuery UI droppable event object", " * @param ui jQuery UI droppable ui object", " * @private", " */", "function _fangornDrop(event, ui) {", "    var tb = this;"]}, {"lines": ["    var items = tb.multiselected().length === 0 ? [tb.find(tb.selected)] : tb.multiselected(),"]}, {"lines": ["        folder = tb.find($(event.target).attr('data-id'));", "", "    // Run drop logic here", "        _dropLogic.call(tb, event, items, folder);", "", "}", "", "/**", " * Hook for the over event of jQuery UI droppable", " * @param event jQuery UI droppable event object", " * @param ui jQuery UI droppable ui object", " * @private", " */", "function _fangornOver(event, ui) {", "    var tb = this;"]}, {"lines": ["    var items = tb.multiselected().length === 0 ? [tb.find(tb.selected)] : tb.multiselected(),"]}, {"lines": ["        folder = tb.find($(event.target).attr('data-id')),", "        dragState = _dragLogic.call(tb, event, items, ui);"]}, {"lines": ["    $('.tb-row').removeClass('tb-h-success fangorn-hover');", "    if (dragState !== 'forbidden') {", "        $('.tb-row[data-id=\"' + folder.id + '\"]').addClass('tb-h-success');", "    } else {", "        $('.tb-row[data-id=\"' + folder.id + '\"]').addClass('fangorn-hover');", "    }"]}, {"lines": ["}", ""]}, {"lines": ["/**", " * Where the drop actions happen", " * @param event jQuery UI drop event", " * @param {Array} items List of items being dragged at the time. Each item is a _item object", " * @param {Object} folder Folder information as _item object", " */", "function _dropLogic(event, items, folder) {", "    var tb = this;"]}, {"lines": ["}", "", "/**", " * Sets the copy state based on which item is being dragged on which other item", " * @param {Object} event Browser drag event", " * @param {Array} items List of items being dragged at the time. Each item is a _item object", " * @param {Object} ui jQuery UI draggable drag ui object", " * @returns {String} copyMode One of the copy states, from 'copy', 'move', 'forbidden'", " */", "function _dragLogic(event, items, ui) {", "    var tb = this;"]}, {"lines": ["    // Set the cursor to match the appropriate copy mode"]}, {"lines": ["    switch (copyMode) {", "        case 'forbidden':", "            dragGhost.css('cursor', 'not-allowed');", "            break;", "        case 'copy':", "            dragGhost.css('cursor', 'copy');", "            break;", "        case 'move':", "            dragGhost.css('cursor', 'move');", "            break;", "        default:", "            dragGhost.css('cursor', 'default');", "    }"]}, {"lines": ["    return copyMode;", ""]}, {"lines": ["}"]}, {"lines": ["/* END MOVE */"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["function _resizeHeight () {"]}, {"lines": ["    var tb = this;", "    var tbody = tb.select('#tb-tbody');", "    var windowHeight = $(window).height();", "    var topBuffer = tbody.offset().top + 50;", "    var availableSpace = windowHeight - topBuffer;"]}, {"lines": ["    if(availableSpace > 0) {"]}, {"lines": ["        tbody.height(availableSpace);"]}, {"lines": ["    }"]}, {"lines": ["}", ""]}, {"lines": ["/**"]}, {"lines": [" * OSF-specific Treebeard options common to all addons.", " * Check Treebeard API for more information", " */", "tbOptions = {"]}, {"lines": ["    rowHeight : 35,         // user can override or get from .tb-row height"]}, {"lines": ["    showTotal : 15,         // Actually this is calculated with div height, not needed. NEEDS CHECKING", "    paginate : false,       // Whether the applet starts with pagination or not.", "    paginateToggle : false, // Show the buttons that allow users to switch between scroll and paginate.", "    uploads : true,         // Turns dropzone on/off.", "    columnTitles : _fangornColumnTitles,", "    resolveRows : _fangornResolveRows,"]}, {"lines": ["    hoverClassMultiselect : 'fangorn-selected',", "    multiselect : true,"]}, {"lines": ["    placement : 'files',"]}, {"lines": ["    title : function() {"]}, {"lines": ["        //TODO Add disk saving mode message"]}, {"lines": ["        // if(window.contextVars.diskSavingMode) {", "        //     // If File and FileRead are not defined dropzone is not supported and neither is uploads", "        //     if (window.File && window.FileReader) {", "        //         return m('p', {", "        //         }, [", "        //             m('span', 'To Upload: Drag files into a folder OR click the '),", "        //             m('i.btn.btn-default.btn-xs', { disabled : 'disabled'}, [ m('i.fa.fa-upload')]),", "        //             m('span', ' below.')", "        //         ]);", "        //     }", "        //     return m('p', {", "        //         class: 'text-danger'", "        //     }, [", "        //         m('span', 'Your browser does not support file uploads, ', [", "        //             m('a', { href: 'http://browsehappy.com' }, 'learn more'),", "        //             '.'", "        //         ])", "        //     ]);", "        // }"]}, {"lines": ["        return undefined;", "    },"]}, {"lines": ["    showFilter : true,     // Gives the option to filter by showing the filter box."]}, {"lines": ["    hoverClass : 'fangorn-hover',", "    togglecheck : _fangornToggleCheck,", "    sortButtonSelector : {"]}, {"lines": ["        up : 'i.fa.fa-chevron-up',", "        down : 'i.fa.fa-chevron-down'"]}, {"lines": ["    },", "    onload : function () {", "        var tb = this;", "        _loadTopLevelChildren.call(tb);"]}, {"lines": ["        tb.select('#tb-tbody').on('click', function(event){", "            if(event.target !== this) {", "                return;", "            }", "            tb.clearMultiselect();"]}, {"lines": ["            _dismissToolbar.call(tb);"]}, {"lines": [""]}, {"lines": ["            }"]}, {"lines": ["        if(tb.options.placement === 'project-files') {", "            _resizeHeight.call(tb);", "            $(window).resize(function(){", "                _resizeHeight.call(tb);"]}, {"lines": ["        }"]}, {"lines": ["        $(window).on('keydown', function(event){"]}, {"lines": ["            if (event.keyCode === ESCAPE_KEY) {"]}, {"lines": ["                _dismissToolbar.call(tb);"]}, {"lines": ["            }"]}, {"lines": ["        });"]}, {"lines": ["    },"]}, {"lines": ["    movecheck : function (to, from) { //This method gives the users an option to do checks and define their return"]}, {"lines": ["        return true;", "    },", "    movefail : function (to, from) { //This method gives the users an option to do checks and define their return"]}, {"lines": ["        return true;", "    },", "    addcheck : function (treebeard, item, file) {"]}, {"lines": ["                }"]}, {"lines": ["            }"]}, {"lines": ["        }"]}, {"lines": ["        return false;", "    },"]}, {"lines": ["    onscrollcomplete : function(){"]}, {"lines": ["        reapplyTooltips();"]}, {"lines": ["    },"]}, {"lines": ["    onmultiselect : _fangornMultiselect,"]}, {"lines": ["    onmouseoverrow : _fangornMouseOverRow,"]}, {"lines": ["    sortDepth : 2,"]}, {"lines": ["    dropzone : {                                           // All dropzone options."]}, {"lines": ["        clickable : '#treeGrid',", "        addRemoveLinks: false,", "        previewTemplate: '<div></div>',"]}, {"lines": ["    },", "    resolveIcon : _fangornResolveIcon,", "    resolveToggle : _fangornResolveToggle,"]}, {"lines": ["    resolveLazyloadUrl : _fangornResolveLazyLoad,"]}, {"lines": ["    lazyLoadError : _fangornLazyLoadError,"]}, {"lines": ["    ontogglefolder : expandStateLoad,"]}, {"lines": ["    dropzoneEvents : {", "        uploadprogress : _fangornUploadProgress,", "        sending : _fangornSending,", "        complete : _fangornComplete,", "        success : _fangornDropzoneSuccess,", "        error : _fangornDropzoneError,", "        dragover : _fangornDragOver,"]}, {"lines": ["        addedfile : _fangornAddedFile,", "        drop : _fangornDropzoneDrop"]}, {"lines": ["    },"]}, {"lines": ["    resolveRefreshIcon : function() {", "        return m('i.fa.fa-refresh.fa-spin');", "    },"]}, {"lines": ["    removeIcon : function(){"]}, {"lines": ["        return m.trust('&times;');"]}, {"lines": ["    },"]}, {"lines": ["    toolbarComponent : FGToolbar,"]}, {"lines": ["    // DRAG AND DROP RELATED OPTIONS", "    dragOptions : {},", "    dropOptions : {},", "    dragEvents : {", "        start : _fangornDragStart", "    },", "    dropEvents : {", "        drop : _fangornDrop,", "        over : _fangornOver", "    },"]}, {"lines": ["    onafterselectwitharrow : function(row, direction) {", "        var tb = this;", "        var item = tb.find(row.id);", "        _fangornMultiselect.call(tb,null,item);"]}, {"lines": ["    },"]}, {"lines": ["    hScroll : 400,", "    naturalScrollLimit : 0"]}, {"lines": ["};"]}, {"lines": [""]}, {"lines": ["/**", " * Loads Fangorn with options", " * @param {Object} options The options to be extended with Treebeard options", " * @constructor", " */", "function Fangorn(options) {", "    this.options = $.extend({}, tbOptions, options);", "    this.grid = null;       // Set by _initGrid", "    this.init();", "}", "", "/**", " * Initialize Fangorn methods that connect it to Treebeard", " * @type {{constructor: Fangorn, init: Function, _initGrid: Function}}", " */", "Fangorn.prototype = {", "    constructor: Fangorn,", "    init: function () {", "        this._initGrid();", "    },", "    // Create the Treebeard once all addons have been configured", "    _initGrid: function () {", "        this.grid = new Treebeard(this.options);", "        return this.grid;"]}, {"lines": ["    },"]}, {"lines": ["};"]}, {"lines": [""]}, {"lines": ["Fangorn.Components = {", "    button : FGButton,", "    input : FGInput,"]}, {"lines": ["    toolbar : FGToolbar,"]}, {"lines": ["    dropdown : FGDropdown,", "    toolbarModes : toolbarModes"]}, {"lines": [""]}, {"lines": ["    createFolder: _createFolder,", "    _gotoFileEvent : gotoFileEvent"]}, {"lines": ["    resolveconfigOption: resolveconfigOption,"]}, {"lines": ["    scrollToFile: scrollToFile,"]}, {"lines": ["    openParentFolders : _openParentFolders,"]}, {"lines": ["    dismissToolbar : _dismissToolbar,"]}, {"lines": [""]}, {"lines": ["        return '';", "    }", ""]}, {"lines": ["        m('i.fa.fa-minus', ' '):", "        m('i.fa.fa-plus', ' ');"]}, {"lines": [""]}, {"lines": ["        m('i.fa.fa-folder-open-o', ' '):", "        m('i.fa.fa-folder-o', ' ');"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        this._tempPicked = item.id;"]}, {"lines": ["    if (tb._tempPicked) {", "        if (tb._tempPicked === item.id) {"]}, {"lines": ["            return templateChecked;"]}, {"lines": ["        }"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["    rowHeight : 35,", "    resolveRefreshIcon : function() {", "        return m('i.fa.fa-refresh.fa-spin');"]}, {"lines": ["", "var $ = require('jquery');", "var ko = require('knockout');"]}, {"lines": ["", "/**", "    * The NavbarViewModel, for OSF wide navigation.", "    * @param {Object} ...", "    */"]}, {"lines": ["    var self = this;", ""]}, {"lines": ["    self.showClose = true;"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        if(self.showSearch()){", "            self.showSearch(false);"]}, {"lines": ["        } else {", "            self.showSearch(true);"]}, {"lines": ["    };", "", "};", "", "function NavbarControl (selector, data, options) {", "    var self = this;", "    self.selector = selector;", "    self.$element = $(self.selector);", "    self.data = data;", "    self.viewModel = new NavbarViewModel(self.data);", "    self.options = $.extend({}, {}, options);", "    self.init();", "}", ""]}, {"lines": ["NavbarControl.prototype.init = function() {", "    var self = this;", "    ko.applyBindings(self.viewModel, self.$element[0]);"]}, {"lines": ["};", ""]}, {"lines": ["module.exports = NavbarControl;"]}, {"lines": [""]}, {"lines": ["    // $( \".osf-dash-col\" ).sortable({", "    //   connectWith: \".osf-dash-col\",", "    //   handle: \".addon-widget-header\",", "    //   cancel: \".pull-right\",", "    //   placeholder: \"osf-dash-portlet ui-corner-all\"", "    // });"]}, {"lines": [""]}, {"lines": ["    $(function () {", "        var path = window.location.pathname;"]}, {"lines": ["            var href = $(this).attr('href');", "            if (path === href ||", "               (path.indexOf('files') > -1 && href.indexOf('files') > -1) ||", "               (path.indexOf('wiki') > -1 && href.indexOf('wiki') > -1)) {", "                $(this).closest('li').addClass('active');", "            }", "        });", "    });"]}, {"lines": ["/**", " * Handles Project Organizer on dashboard page of OSF.", " * For Treebeard and _item API's check: https://github.com/caneruguz/treebeard/wiki", " */"]}, {"lines": ["var m = require('mithril');"]}, {"lines": ["var Fangorn = require('js/fangorn');"]}, {"lines": ["var Fangorn = require('js/fangorn');"]}, {"lines": ["", "// copyMode can be 'copy', 'move', 'forbidden', or null.", "// This is set at draglogic and is used as global within this module", "var copyMode = null;"]}, {"lines": ["// Initialize projectOrganizer object (separate from the ProjectOrganizer constructor at the end)", "var projectOrganizer = {};", ""]}, {"lines": ["// Link ID's used to add existing project to folder"]}, {"lines": ["var linkName;", "var linkID;"]}, {"lines": [""]}, {"lines": ["// Cross browser key codes for the Command key"]}, {"lines": ["var COMMAND_KEYS = [224, 17, 91, 93];", "var ESCAPE_KEY = 27;", "var ENTER_KEY = 13;"]}, {"lines": ["    collection: 'Collections',", "    smartCollection: 'Smart Collections',"]}, {"lines": ["/**"]}, {"lines": [" * Bloodhound is a typeahead suggestion engine. Searches here for public projects"]}, {"lines": [" * @type {Bloodhound}", " */", "projectOrganizer.publicProjects = new Bloodhound({", "    datumTokenizer: function (d) {", "        return Bloodhound.tokenizers.whitespace(d.name);", "    },", "    queryTokenizer: Bloodhound.tokenizers.whitespace,", "    remote: {"]}, {"lines": ["        filter: function (projects) {", "            return $.map(projects, function (project) {", "                return {", "                    name: project.value,", "                    node_id: project.id,", "                    category: project.category", "                };", "            });"]}, {"lines": ["        },"]}, {"lines": ["        limit: 10"]}, {"lines": ["});", "", "/**"]}, {"lines": [" * Bloodhound is a typeahead suggestion engine. Searches here for users projects"]}, {"lines": [" * @type {Bloodhound}", " */", "projectOrganizer.myProjects = new Bloodhound({", "    datumTokenizer: function (d) {", "        return Bloodhound.tokenizers.whitespace(d.name);", "    },", "    queryTokenizer: Bloodhound.tokenizers.whitespace,", "    remote: {"]}, {"lines": ["        filter: function (projects) {", "            return $.map(projects, function (project) {", "                return {", "                    name: project.value,", "                    node_id: project.id,", "                    category: project.category", "                };", "            });", "        },", "        limit: 10"]}, {"lines": ["});", "", "/**", " * Edits the template for the column titles.", " * Used here to make smart folder italicized", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller Check Treebeard API for methods available", " * @private", " */", "function _poTitleColumn(item) {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    var css = item.data.isSmartFolder ? 'project-smart-folder smart-folder' : '';"]}, {"lines": ["        return m('a.fg-file-links', { 'class' : css, href : item.data.urls.fetch}, item.data.name);", "    } else {", "        return  m('span', { 'class' : css}, item.data.name);"]}, {"lines": ["    }"]}, {"lines": ["}", "", "/**"]}, {"lines": [" * Links for going to project pages on the action column"]}, {"lines": [" * @param event Click event", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @param {Object} col Column options", " * @this Treebeard.controller Check Treebeard API for methods available", " * @private", " */"]}, {"lines": ["function _gotoEvent(event, item) {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    if (COMMAND_KEYS.indexOf(tb.pressedKey) !== -1) {"]}, {"lines": ["        window.open(item.data.urls.fetch, '_blank');", "    } else {", "        window.open(item.data.urls.fetch, '_self');", "    }"]}, {"lines": ["}", ""]}, {"lines": [""]}, {"lines": ["/**"]}, {"lines": [" * Watching for escape key press"]}, {"lines": [" * @param {String} nodeID Unique ID of the node", " */", "function addFormKeyBindings(nodeID) {", "    $('#ptd-' + nodeID).keyup(function (e) {", "        if (e.which === 27) {", "            $('#ptd-' + nodeID).find('.cancel-button-' + nodeID).filter(':visible').click();", "            return false;", "        }", "    });", "}", ""]}, {"lines": [""]}, {"lines": ["function triggerClickOnItem(item, force) {"]}, {"lines": ["    var row = $('.tb-row[data-id=\"' + item.id + '\"]');", "    if (force) {"]}, {"lines": ["    }", ""]}, {"lines": ["    if (row.hasClass(this.options.hoverClassMultiselect)) {"]}, {"lines": ["        row.trigger('click');", "    }", "}", ""]}, {"lines": ["/**", " * Saves the expand state of a folder so that it can be loaded based on that state", " * @param {Object} item Node data", " * @param {Function} callback", " */", "function saveExpandState(item, callback) {", "    var collapseUrl,", "        postAction,", "        expandUrl;", "    if (!item.apiURL) {", "        return;", "    }", "    if (item.expand) {", "        // turn to false", "        collapseUrl = item.apiURL + 'collapse/';", "        postAction = $osf.postJSON(collapseUrl, {});", "        postAction.done(function () {"]}, {"lines": ["            item.expand = false;"]}, {"lines": ["            if (callback !== undefined) {"]}, {"lines": ["                callback();"]}, {"lines": ["        }).fail($osf.handleJSONError);", "    } else {", "        // turn to true", "        expandUrl = item.apiURL + 'expand/';"]}, {"lines": ["        postAction = $osf.postJSON(expandUrl, {});"]}, {"lines": ["        postAction.done(function () {"]}, {"lines": ["            item.expand = false;"]}, {"lines": ["            if (callback !== undefined) {"]}, {"lines": ["                callback();", "            }", "        }).fail($osf.handleJSONError);"]}, {"lines": ["}"]}, {"lines": ["/**"]}, {"lines": [" * Contributors have first person's name and then number of contributors. This functio nreturns the proper html", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @returns {Object} A Mithril virtual DOM template object", " * @private", " */", "function _poContributors(item) {"]}, {"lines": ["    if (!item.data.contributors) {"]}, {"lines": ["        return '';"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["    return item.data.contributors.map(function (person, index, arr) {"]}, {"lines": ["        var comma;"]}, {"lines": ["        if (index === 0) {"]}, {"lines": ["            comma = '';", "        } else {", "            comma = ', ';", "        }"]}, {"lines": ["        if (index > 2) {", "            return;", "        }", "        if (index === 2) {"]}, {"lines": ["            return m('span', ' + ' + (arr.length - 2));"]}, {"lines": ["        }"]}, {"lines": ["        return m('span', comma + person.name);"]}, {"lines": ["    });", "}"]}, {"lines": [""]}, {"lines": ["/**", " * Displays who modified the data and when. i.e. \"6 days ago, by Uguz\"", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @private", " */", "function _poModified(item) {"]}, {"lines": ["    if (item.data.modifiedDelta === 0) {", "        return m('span');"]}, {"lines": ["    }"]}, {"lines": ["    dateString = moment.utc(item.data.dateModified).fromNow();"]}, {"lines": ["    if (item.data.modifiedBy !== '') {"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": ["/**", " * Organizes all the row displays based on what that item requires.", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @returns {Array} An array of columns as col objects", " * @this Treebeard.controller Check Treebeard API For available methods", " * @private", " */"]}, {"lines": ["function _poResolveRows(item) {"]}, {"lines": ["    var css = '',"]}, {"lines": ["        draggable = false,", "        default_columns;"]}, {"lines": ["    if (item.data.permissions) {", "        draggable = item.data.permissions.movable || item.data.permissions.copyable;", "    }"]}, {"lines": ["    if(this.isMultiselected(item.id)){", "        item.css = 'fangorn-selected';", "    }"]}, {"lines": ["    if (draggable) {", "        css = 'po-draggable';", "    }", "    item.css = '';"]}, {"lines": ["    default_columns = [{"]}, {"lines": ["        data : 'name',  // Data field name", "        folderIcons : true,", "        filter : true,", "        css : css,", "        custom : _poTitleColumn"]}, {"lines": ["    }, {"]}, {"lines": ["        data : 'contributors',"]}, {"lines": ["        filter : false,"]}, {"lines": ["        custom : _poContributors"]}, {"lines": ["    }, {"]}, {"lines": ["        data : 'dateModified',"]}, {"lines": ["        filter : false,", "        custom : _poModified", "    }];", "    return default_columns;", "}"]}, {"lines": [""]}, {"lines": ["/**", " * Organizes the information for Column title row.", " * @returns {Array} An array of columns with pertinent column information", " * @private", " */"]}, {"lines": ["function _poColumnTitles() {"]}, {"lines": ["    var columns = [];", "    columns.push({"]}, {"lines": ["        title: 'Name',"]}, {"lines": ["        width : '50%',"]}, {"lines": ["        sort : true,", "        sortType : 'text'"]}, {"lines": ["    }, {", "        title : 'Contributors',"]}, {"lines": ["        width : '25%',"]}, {"lines": ["        sort : false", "    }, {", "        title : 'Modified',", "        width : '25%',", "        sort : false", "    });"]}, {"lines": ["    return columns;", "}"]}, {"lines": ["/**", " * Checks if folder toggle is permitted (i.e. contents are private)", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {boolean}", " * @private", " */"]}, {"lines": ["function _poToggleCheck(item) {"]}, {"lines": ["    if (item.data.permissions.view) {", "        return true;"]}, {"lines": ["    }"]}, {"lines": ["    item.notify.update('Not allowed: Private folder', 'warning', 1, undefined);", "    return false;", "}"]}, {"lines": ["/**"]}, {"lines": [" * Returns custom folder toggle icons for OSF", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {string} Returns a mithril template with m() function, or empty string.", " * @private", " */"]}, {"lines": ["function _poResolveToggle(item) {"]}, {"lines": ["    var toggleMinus = m('i.fa.fa-minus'),", "        togglePlus = m('i.fa.fa-plus'),"]}, {"lines": ["        childrenCount = item.data.childrenCount || item.children.length;"]}, {"lines": ["    if (item.kind === 'folder' && childrenCount > 0 && item.depth > 1) {"]}, {"lines": ["        if (item.open) {"]}, {"lines": ["            return toggleMinus;"]}, {"lines": ["        }"]}, {"lines": ["        return togglePlus;"]}, {"lines": ["    }"]}, {"lines": ["    return '';", "}"]}, {"lines": ["/**", " * Resolves lazy load url for fetching children", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller", " * @returns {String|Boolean} Returns the fetch URL in string or false if there is no url.", " * @private", " */"]}, {"lines": ["function _poResolveLazyLoad(item) {"]}, {"lines": [""]}, {"lines": ["    return '/api/v1/dashboard/' + item.data.node_id;", "}", "", "/**", " * Hook to run after lazyloading has successfully loaded", " * @param {Object} item A Treebeard _item object for the row involved. Node information is inside item.data", " * @this Treebeard.controller", " * @private", " */"]}, {"lines": ["function expandStateLoad(item) {", "    var tb = this,", "        i;"]}, {"lines": ["    if (item.children.length === 0 && item.data.childrenCount > 0){"]}, {"lines": ["        tb.updateFolder(null, item);", "    }"]}, {"lines": ["    if (item.children.length > 0 && item.depth > 0) {", "        for (i = 0; i < item.children.length; i++) {"]}, {"lines": ["            if (item.children[i].data.expand) {"]}, {"lines": ["                tb.updateFolder(null, item.children[i]);"]}, {"lines": ["            }"]}, {"lines": ["            if (tb.multiselected()[0] && item.children[i].data.node_id === tb.multiselected()[0].data.node_id) {"]}, {"lines": ["            }"]}, {"lines": ["        }"]}, {"lines": ["    }"]}, {"lines": ["    _cleanupMithril();"]}, {"lines": ["}"]}, {"lines": ["/**", " * Loads the children of an item that need to be expanded. Unique to Projectorganizer", " * @private", " */"]}, {"lines": ["function _poLoadOpenChildren() {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    tb.treeData.children.map(function (item) {"]}, {"lines": ["        if (item.data.expand) {", "            tb.updateFolder(null, item);", "        }", "    });", "}"]}, {"lines": [""]}, {"lines": ["/**", " * Hook to run after multiselect is run when an item is selected.", " * @param event Browser click event object", " * @param {Object} tree A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " * @private", " */"]}, {"lines": ["function _poMultiselect(event, tree) {"]}, {"lines": ["    var tb = this;", "    filterRowsNotInParent.call(tb, tb.multiselected());"]}, {"lines": ["    var scrollToItem = false;"]}, {"lines": ["    if (tb.toolbarMode() === 'search') {", "        _dismissToolbar.call(tb);"]}, {"lines": ["        scrollToItem = true;", "        // recursively open parents of the selected item but do not lazyload;", "        Fangorn.Utils.openParentFolders.call(tb, tree);"]}, {"lines": ["    }"]}, {"lines": ["    if (tb.multiselected().length === 1) {"]}, {"lines": ["        // temporarily remove classes until mithril redraws raws with another hover."]}, {"lines": ["        tb.inputValue(tb.multiselected()[0].data.name);"]}, {"lines": ["        tb.select('#tb-tbody').removeClass('unselectable');"]}, {"lines": ["        if (scrollToItem) {"]}, {"lines": ["            Fangorn.Utils.scrollToFile.call(tb, tb.multiselected()[0].id);"]}, {"lines": ["        }"]}, {"lines": ["    } else if (tb.multiselected().length > 1) {"]}, {"lines": ["        tb.select('#tb-tbody').addClass('unselectable');"]}, {"lines": ["    }"]}, {"lines": ["    m.redraw();"]}, {"lines": ["}"]}, {"lines": ["/**", " * Deletes pointers based on their ids from the folder specified", " * @param {String} pointerIds Unique node ids", " * @param folderToDeleteFrom  What it says", " */", "function deleteMultiplePointersFromFolder(pointerIds, folderToDeleteFrom) {"]}, {"lines": ["    var tb = this,", "        folderNodeId,", "        url,", "        postData,", "        deleteAction;"]}, {"lines": ["    if (pointerIds.length > 0) {"]}, {"lines": ["        folderNodeId = folderToDeleteFrom.data.node_id;", "        url = '/api/v1/folder/' + folderNodeId + '/pointers/';", "        postData = JSON.stringify({pointerIds: pointerIds});", "        deleteAction = $.ajax({"]}, {"lines": ["            type: 'DELETE',", "            url: url,", "            data: postData,", "            contentType: 'application/json',", "            dataType: 'json'", "        });"]}, {"lines": ["        deleteAction.done(function () {"]}, {"lines": ["            tb.updateFolder(null, folderToDeleteFrom);"]}, {"lines": ["            tb.clearMultiselect();"]}, {"lines": ["        });", "        deleteAction.fail(function (jqxhr, textStatus, errorThrown) {"]}, {"lines": ["            $osf.growl('Error:', textStatus + '. ' + errorThrown);", "        });", "    }", "}"]}, {"lines": [""]}, {"lines": ["/**", " * When multiple rows are selected remove those that are not in the parent", " * @param {Array} rows List of item objects", " * @returns {Array} newRows Returns the revised list of rows", " */", "function filterRowsNotInParent(rows) {"]}, {"lines": ["    var tb = this;", "    if (tb.multiselected().length < 2) {", "        return tb.multiselected();"]}, {"lines": ["    }"]}, {"lines": ["    var i, newRows = [],"]}, {"lines": ["        originalRow = tb.find(tb.multiselected()[0].id),"]}, {"lines": ["        originalParent,", "        currentItem;"]}, {"lines": ["    var changeColor = function() { $(this).css('background-color', ''); };"]}, {"lines": ["        originalParent = originalRow.parentID;"]}, {"lines": ["        for (i = 0; i < rows.length; i++) {"]}, {"lines": ["            currentItem = rows[i];", "            if (currentItem.parentID === originalParent && currentItem.id !== -1) {"]}, {"lines": ["                newRows.push(rows[i]);"]}, {"lines": ["            } else {"]}, {"lines": ["                $('.tb-row[data-id=\"' + rows[i].id + '\"]').stop().css('background-color', '#D18C93').animate({ backgroundColor: '#fff'}, 500, changeColor);"]}, {"lines": ["        }"]}, {"lines": ["    }"]}, {"lines": ["    tb.multiselected(newRows);", "    tb.highlightMultiselect();"]}, {"lines": ["    return newRows;", "}"]}, {"lines": ["/**", " * Hook for the drag start event on jquery", " * @param event jQuery UI drggable event object", " * @param ui jQuery UI draggable ui object", " * @private", " */"]}, {"lines": ["function _poDragStart(event, ui) {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    var itemID = $(event.target).attr('data-id'),"]}, {"lines": ["        item = tb.find(itemID);", "    if (tb.multiselected().length < 2) {", "        tb.multiselected([item]);"]}, {"lines": ["    }"]}, {"lines": ["}"]}, {"lines": ["/**", " * Hook for the drop event of jQuery UI droppable", " * @param event jQuery UI droppable event object", " * @param ui jQuery UI droppable ui object", " * @private", " */"]}, {"lines": ["function _poDrop(event, ui) {"]}, {"lines": ["    var tb = this;", "    var items = tb.multiselected().length === 0 ? [tb.find(tb.selected)] : tb.multiselected(),", "        folder = tb.find($(event.target).attr('data-id'));", "    dropLogic.call(tb, event, items, folder);"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["/**", " * Hook for the over event of jQuery UI droppable", " * @param event jQuery UI droppable event object", " * @param ui jQuery UI droppable ui object", " * @private", " */"]}, {"lines": ["function _poOver(event, ui) {"]}, {"lines": ["    var tb = this;", "    var items = tb.multiselected().length === 0 ? [tb.find(tb.selected)] : tb.multiselected(),", "        folder = tb.find($(event.target).attr('data-id')),", "        dragState = dragLogic.call(tb, event, items, ui);"]}, {"lines": ["    $('.tb-row').removeClass('tb-h-success po-hover');"]}, {"lines": ["    if (dragState !== 'forbidden') {", "        $('.tb-row[data-id=\"' + folder.id + '\"]').addClass('tb-h-success');"]}, {"lines": ["    } else {"]}, {"lines": ["        $('.tb-row[data-id=\"' + folder.id + '\"]').addClass('po-hover');", "    }", "}"]}, {"lines": ["// Sets the state of the alt key by listening for key presses in the document.", "var altKey = false;", "$(document).keydown(function (e) {", "    if (e.altKey) {", "        altKey = true;", "    }", "});", "$(document).keyup(function (e) {", "    if (!e.altKey) {", "        altKey = false;", "    }", "});"]}, {"lines": ["/**"]}, {"lines": [" * Sets the copy state based on which item is being dragged on which other item"]}, {"lines": [" * @param {Object} event Browser drag event", " * @param {Array} items List of items being dragged at the time. Each item is a _item object", " * @param {Object} ui jQuery UI draggable drag ui object", " * @returns {String} copyMode One of the copy states, from 'copy', 'move', 'forbidden'", " */"]}, {"lines": ["function dragLogic(event, items, ui) {", "    var canCopy = true,", "        canMove = true,", "        folder = this.find($(event.target).attr('data-id')),"]}, {"lines": ["        isSelf = false,", "        dragGhost = $('.tb-drag-ghost');"]}, {"lines": ["    items.forEach(function (item) {", "        if (!isSelf) {", "            isSelf = item.id === folder.id;"]}, {"lines": ["        }"]}, {"lines": ["        canCopy = canCopy && item.data.permissions.copyable;", "        canMove = canMove && item.data.permissions.movable;"]}, {"lines": ["    if (canAcceptDrop(items, folder) && (canMove || canCopy)) {"]}, {"lines": ["        if (canMove && canCopy) {"]}, {"lines": ["            if (altKey) {"]}, {"lines": ["                copyMode = 'copy';"]}, {"lines": ["            } else {", "                copyMode = 'move';"]}, {"lines": ["            }"]}, {"lines": ["        }"]}, {"lines": ["        if (canMove && !canCopy) {", "            copyMode = 'move';"]}, {"lines": ["        }"]}, {"lines": ["        if (canCopy && !canMove) {", "            copyMode = 'copy';"]}, {"lines": ["        }"]}, {"lines": ["    } else {", "        copyMode = 'forbidden';"]}, {"lines": ["    }"]}, {"lines": ["    if (isSelf) {", "        copyMode = 'forbidden';", "    }", "    // Set the cursor to match the appropriate copy mode", "    // Remember that Treebeard is using tb-drag-ghost instead of ui.helper"]}, {"lines": ["    switch (copyMode) {"]}, {"lines": ["    case 'forbidden':"]}, {"lines": ["        dragGhost.css('cursor', 'not-allowed');"]}, {"lines": ["        break;", "    case 'copy':"]}, {"lines": ["        dragGhost.css('cursor', 'copy');"]}, {"lines": ["        break;", "    case 'move':"]}, {"lines": ["        dragGhost.css('cursor', 'move');"]}, {"lines": ["        break;", "    default:"]}, {"lines": ["        dragGhost.css('cursor', 'default');"]}, {"lines": ["    }"]}, {"lines": ["    return copyMode;", "}"]}, {"lines": [""]}, {"lines": ["/**", " * Checks if the folder can accept the items dropped on it", " * @param {Array} items List of items being dragged at the time. Each item is a _item object"]}, {"lines": [" * @param {Object} folder Folder information as _item object, the drop target"]}, {"lines": [" * @returns {boolean} canDrop Whether drop can happen", " */"]}, {"lines": ["    if (typeof theCopyMode === 'undefined') {"]}, {"lines": ["    var representativeItem,", "        itemParentNodeId,", "        hasComponents,", "        hasFolders,", "        copyable,", "        movable,", "        canDrop;"]}, {"lines": ["    if (folder.data.isSmartFolder || !folder.data.isFolder) {"]}, {"lines": ["        return false;", "    }", "    // if the folder is contained by the item, return false"]}, {"lines": ["    representativeItem = items[0];", "    if (representativeItem.isAncestor(folder) || representativeItem.id === folder.id) {"]}, {"lines": ["        return false;", "    }", "    // If trying to drop on the folder it came from originally, return false"]}, {"lines": ["    itemParentNodeId = representativeItem.parent().data.node_id;", "    if (itemParentNodeId === folder.data.node_id) {"]}, {"lines": ["        return false;", "    }"]}, {"lines": ["    hasComponents = false;", "    hasFolders = false;", "    copyable = true;", "    movable = true;", "    canDrop = true;", "    items.forEach(function (item) {"]}, {"lines": ["        hasComponents = hasComponents || item.data.isComponent;", "        hasFolders = hasFolders || item.data.isFolder;", "        copyable = copyable && item.data.permissions.copyable;", "        movable = movable && item.data.permissions.movable;", "    });"]}, {"lines": ["    if (hasComponents) {"]}, {"lines": ["        canDrop = canDrop && folder.data.permissions.acceptsComponents;", "    }"]}, {"lines": ["    if (hasFolders) {"]}, {"lines": ["        canDrop = canDrop && folder.data.permissions.acceptsFolders;", "    }"]}, {"lines": ["        canDrop = canDrop && folder.data.permissions.acceptsMoves && movable;", "    }"]}, {"lines": ["        canDrop = canDrop && folder.data.permissions.acceptsCopies && copyable;", "    }", "    return canDrop;", "}"]}, {"lines": [""]}, {"lines": ["/**", " * Where the drop actions happen", " * @param event jQuery UI drop event", " * @param {Array} items List of items being dragged at the time. Each item is a _item object", " * @param {Object} folder Folder information as _item object", " */", "function dropLogic(event, items, folder) {"]}, {"lines": ["    var tb = this,", "        theFolderNodeID,", "        getChildrenURL,", "        folderChildren,", "        sampleItem,"]}, {"lines": ["        itemParent,", "        itemParentNodeID,", "        getAction;"]}, {"lines": ["    if (typeof folder !== 'undefined' && !folder.data.isSmartFolder && folder !== null && folder.data.isFolder) {"]}, {"lines": ["        theFolderNodeID = folder.data.node_id;", "        getChildrenURL = folder.data.apiURL + 'get_folder_pointers/';", "        sampleItem = items[0];"]}, {"lines": ["        itemParent = sampleItem.parent();", "        itemParentNodeID = itemParent.data.node_id;"]}, {"lines": ["        if (itemParentNodeID !== theFolderNodeID) { // This shouldn't happen, but if it does, it's bad"]}, {"lines": ["            getAction = $.getJSON(getChildrenURL, function (data) {"]}, {"lines": ["                folderChildren = data;"]}, {"lines": ["                var itemsToMove = [],", "                    itemsNotToMove = [],", "                    postInfo;"]}, {"lines": ["                items.forEach(function (item) {", "                    if ($.inArray(item.data.node_id, folderChildren) === -1) { // pointer not in folder to be moved to", "                        itemsToMove.push(item.data.node_id);", "                    } else if (copyMode === 'move') { // Pointer is already in the folder and it's a move", "                                // We  need to make sure not to delete the folder if the item is moved to the same folder.", "                                // When we add the ability to reorganize within a folder, this will have to change.", "                        itemsNotToMove.push(item.data.node_id);", "                    }", "                });"]}, {"lines": ["                postInfo = {"]}, {"lines": ["                    'copy': {", "                        'url': '/api/v1/project/' + theFolderNodeID + '/pointer/',", "                        'json': {", "                            nodeIds: itemsToMove"]}, {"lines": ["                    },", "                    'move': {", "                        'url': '/api/v1/pointers/move/',", "                        'json': {", "                            pointerIds: itemsToMove,", "                            toNodeId: theFolderNodeID,", "                            fromNodeId: itemParentNodeID"]}, {"lines": ["                        }"]}, {"lines": ["                    }", "                };", "                if (copyMode === 'copy' || copyMode === 'move') {", "                    deleteMultiplePointersFromFolder.call(tb, itemsNotToMove, itemParent);", "                    if (itemsToMove.length > 0) {"]}, {"lines": ["                            outerFolder = whichIsContainer.call(tb, itemParent, folder),", "                            postAction = $.ajax({", "                                type: 'POST',", "                                url: url,", "                                data: postData,", "                                contentType: 'application/json',", "                                dataType: 'json'", "                            });"]}, {"lines": ["                        postAction.always(function (result) {", "                            if (copyMode === 'move') {", "                                if (!outerFolder) {", "                                    tb.updateFolder(null, itemParent);"]}, {"lines": ["                                    tb.updateFolder(null, folder);"]}, {"lines": ["                                } else {"]}, {"lines": ["                                    // if item is closed folder save expand state to be open", "                                    if(!folder.data.expand){", "                                        saveExpandState(folder.data, function(){", "                                            tb.updateFolder(null, outerFolder);", "                                        });", "                                    } else {", "                                        tb.updateFolder(null, outerFolder);", "                                    }"]}, {"lines": ["                                }"]}, {"lines": ["                            } else {", "                                tb.updateFolder(null, folder);"]}, {"lines": ["                            }"]}, {"lines": ["                        });"]}, {"lines": ["                        postAction.fail(function (jqxhr, textStatus, errorThrown) {"]}, {"lines": ["                            $osf.growl('Error:', textStatus + '. ' + errorThrown);", "                        });"]}, {"lines": ["                }", "            });"]}, {"lines": ["            getAction.fail(function (jqxhr, textStatus, errorThrown) {"]}, {"lines": ["                $osf.growl('Error:', textStatus + '. ' + errorThrown);", "            });"]}, {"lines": ["        } else {"]}, {"lines": ["            Raven.captureMessage('Project dashboard: Parent node (' + itemParentNodeID + ') == Folder Node (' + theFolderNodeID + ')');", "        }", "    } else {", "        if (typeof folder === 'undefined') {", "            Raven.captureMessage('onDrop folder is undefined.');"]}, {"lines": ["        }"]}, {"lines": ["    }"]}, {"lines": ["    $('.project-organizer-dand').css('cursor', 'default');", "}"]}, {"lines": ["/**", " * Checks if one of the items being moved contains the other. To check for adding parents to children", " * @param {Object} itemOne Treebeard _item object, has the _item API", " * @param {Object} itemTwo Treebeard _item object, has the _item API", " * @returns {null|Object} Returns object if one is containing the other. Null if neither or both", " */"]}, {"lines": ["function whichIsContainer(itemOne, itemTwo) {", "    var isOneAncestor = itemOne.isAncestor(itemTwo),", "        isTwoAncestor = itemTwo.isAncestor(itemOne);"]}, {"lines": ["    if (isOneAncestor && isTwoAncestor) {", "        return null;"]}, {"lines": ["    }"]}, {"lines": ["    if (isOneAncestor) {", "        return itemOne;", "    }", "    if (isTwoAncestor) {", "        return itemTwo;", "    }", "    return null;", "}"]}, {"lines": ["function _cleanupMithril() {", "    // Clean up Mithril related redraw issues", "    $('.tb-toggle-icon').each(function(){"]}, {"lines": ["        if (children.length > 1) {", "            children.last().remove();", "        }", "    });", "}"]}, {"lines": [""]}, {"lines": ["function _addFolderEvent() {"]}, {"lines": ["    var tb = this;", "    var val = $.trim($('#addNewFolder').val());"]}, {"lines": ["    if (tb.multiselected().length !== 1 || val.length < 1) {"]}, {"lines": ["        tb.toolbarMode(Fangorn.Components.toolbarModes.DEFAULT);"]}, {"lines": ["        return;"]}, {"lines": ["    }"]}, {"lines": ["    var item = tb.multiselected()[0];"]}, {"lines": ["    var theItem = item.data;"]}, {"lines": ["    var url = '/api/v1/folder/';", "    var postData = {", "            node_id: theItem.node_id,", "            title: val", "        };"]}, {"lines": ["    theItem.expand = false;", "    saveExpandState(theItem, function () {", "        var putAction = $osf.putJSON(url, postData);", "        putAction.done(function () {", "            tb.updateFolder(null, item);", "            triggerClickOnItem.call(tb, item);", "        }).fail($osf.handleJSONError);", "", "    });"]}, {"lines": ["    tb.toolbarMode(Fangorn.Components.toolbarModes.DEFAULT);"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["function _renameEvent() {"]}, {"lines": ["    var tb = this;", "    var val = $.trim($('#renameInput').val());"]}, {"lines": ["    if (tb.multiselected().length !== 1 || val.length < 1) {"]}, {"lines": ["        tb.toolbarMode(Fangorn.Components.toolbarModes.DEFAULT);"]}, {"lines": ["        return;"]}, {"lines": ["    }"]}, {"lines": ["    var item = tb.multiselected()[0];"]}, {"lines": ["    var theItem = item.data;"]}, {"lines": ["    var url = theItem.apiURL + 'edit/';", "    var postAction;", "    var postData = {"]}, {"lines": ["            name: 'title',", "            value: val", "        };", "    postAction = $osf.postJSON(url, postData);", "    postAction.done(function () {", "        tb.updateFolder(null, tb.find(1));", "        // Also update every", "    }).fail($osf.handleJSONError);"]}, {"lines": ["    tb.toolbarMode(Fangorn.Components.toolbarModes.DEFAULT);"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["function applyTypeahead() {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    var item = tb.multiselected()[0];"]}, {"lines": ["    var theItem = item.data;"]}, {"lines": ["    projectOrganizer.myProjects.initialize();", "    projectOrganizer.publicProjects.initialize();", "    // injecting error into search results from https://github.com/twitter/typeahead.js/issues/747", "    var mySourceWithEmptySelectable = function (q, cb) {", "        var emptyMyProjects = [{ error: 'There are no matching projects to which you contribute.' }];", "        projectOrganizer.myProjects.get(q, injectEmptySelectable);", "        function injectEmptySelectable(suggestions) {", "            if (suggestions.length === 0) {", "                cb(emptyMyProjects);", "            } else {", "                cb(suggestions);", "            }", "        }", "    };", "    var publicSourceWithEmptySelectable = function (q, cb) {", "        var emptyPublicProjects = { error: 'There are no matching public projects.' };", "        projectOrganizer.publicProjects.get(q, injectEmptySelectable);", "        function injectEmptySelectable(suggestions) {", "            if (suggestions.length === 0) {", "                cb([emptyPublicProjects]);", "            } else {", "                cb(suggestions);", "            }", "        }", "    };", ""]}, {"lines": ["    if (!theItem.isSmartFolder) {"]}, {"lines": ["        $('#addprojectInput').typeahead('destroy');"]}, {"lines": ["        $('#addprojectInput').typeahead({", "            highlight: true", "        }, {", "            name: 'my-projects',", "            displayKey: function (data) {", "                return data.name;", "            },", "            source: mySourceWithEmptySelectable,", "            templates: {", "                header: function () {", "                    return '<h3 class=\"category\">My Projects</h3>';", "                },", "                suggestion: function (data) {", "                    if (typeof data.name !== 'undefined') {", "                        return '<p>' + data.name + '</p>';", "                    }", "                    return '<p>' + data.error + '</p>';", "                }", "            }", "        }, {", "            name: 'public-projects',", "            displayKey: function (data) {", "                return data.name;", "            },", "            source: publicSourceWithEmptySelectable,", "            templates: {", "                header: function () {", "                    return '<h3 class=\"category\">Public Projects</h3>';", "                },", "                suggestion: function (data) {", "                    if (typeof data.name !== 'undefined') {", "                        return '<p>' + data.name + '</p>';", "                    }", "                    return '<p>' + data.error + '</p>';", "                }", "            }", "        });"]}, {"lines": ["        $('#addprojectInput').bind('keyup', function (event) {", "            var key = event.keyCode || event.which,", "                buttonEnabled = $('#add-link-button').hasClass('tb-disabled');", "", "            if (key === 13) {", "                if (buttonEnabled) {", "                    $('#add-link-button').click(); //submits if the control is active", "                }", "            } else {", "                $('#add-link-warning').text('');", "                $('#add-link-button').addClass('tb-disabled');", "                linkName = '';", "                linkID = '';", "            }", "        });", "        $('#addprojectInput').bind('typeahead:selected', function (obj, datum, name) {", "            var getChildrenURL = theItem.apiURL + 'get_folder_pointers/',", "                children;", "            $.getJSON(getChildrenURL, function (data) {", "                children = data;", "                if (children.indexOf(datum.node_id) === -1) {"]}, {"lines": ["                    $('#add-link-button').removeClass('tb-disabled');"]}, {"lines": ["                    linkName = datum.name;", "                    linkID = datum.node_id;", "                } else {", "                    $('#add-link-warning').text('This project is already in the folder');", "                }", "            }).fail($osf.handleJSONError);", "        });"]}, {"lines": ["    }", ""]}, {"lines": ["}", ""]}, {"lines": ["function addProjectEvent() {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    var item = tb.multiselected()[0];"]}, {"lines": ["    var theItem = item.data;"]}, {"lines": ["    var url = '/api/v1/pointer/',", "        postData = JSON.stringify({", "            pointerID: linkID,", "            toNodeID: theItem.node_id", "        });", "    theItem.expand = false;", "    saveExpandState(theItem, function () {", "        var postAction = $.ajax({", "            type: 'POST',", "            url: url,", "            data: postData,", "            contentType: 'application/json',", "            dataType: 'json'", "        });", "        postAction.done(function () {", "            tb.updateFolder(null, item);", "        });", "    });", "    triggerClickOnItem.call(tb, item);"]}, {"lines": ["    tb.toolbarMode(Fangorn.Components.toolbarModes.DEFAULT);"]}, {"lines": ["    tb.select('.tb-header-row .twitter-typeahead').remove();"]}, {"lines": ["}"]}, {"lines": [""]}, {"lines": ["function showLegend() {", "    var tb = this;", "    var keys = Object.keys(projectOrganizerCategories);", "    var data = keys.map(function (key) {", "        return {", "            icon: iconmap.componentIcons[key] || iconmap.projectIcons[key],", "            label: nodeCategories[key] || projectOrganizerCategories[key]", "        };", "    });", "    var repr = function (item) {", "        return [", "            m('span', {", "                className: item.icon", "            }),", "            '  ',", "            item.label", "        ];", "    };", "    var opts = {", "        footer: m('span', ['*lighter color denotes a registration (e.g. ',", "            m('span', {", "                className: iconmap.componentIcons.data + ' po-icon'", "            }),", "            ' becomes  ',", "            m('span', {", "                className: iconmap.componentIcons.data + ' po-icon-registered'", "            }),", "            ' )'", "            ])", "    };", "    tb.modal.update(legendView(data, repr, opts));", "    tb.modal.show();", "}", ""]}, {"lines": ["var POItemButtons = {", "    view : function (ctrl, args, children) {", "        var tb = args.treebeard;", "        var item = args.item;", "        var buttons = [];", "        if (!item.data.urls) {", "            return m('div');"]}, {"lines": ["        }"]}, {"lines": ["        var url = item.data.urls.fetch;", "        var theItem = item.data;", "        var theParentNode = item.parent();", "        var theParentNodeID = theParentNode.data.node_id;", "        $('.fangorn-toolbar-icon').tooltip('destroy');", "        if (!item.data.isSmartFolder) {", "            if (url !== null) {", "                buttons.push(", "                    m.component(Fangorn.Components.button, {", "                        onclick: function (event) {", "                            _gotoEvent.call(tb, event, item);", "                        },"]}, {"lines": ["                        icon: 'fa fa-external-link',", "                        className: 'text-primary'", "                    }, 'Open')", "                );", "            }", "        }", "        if (!item.data.isSmartFolder && (item.data.isDashboard || item.data.isFolder)) {", "            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function (event) {"]}, {"lines": ["                        tb.toolbarMode(Fangorn.Components.toolbarModes.ADDFOLDER);"]}, {"lines": ["                    },"]}, {"lines": ["                    icon: 'fa fa-cubes',", "                    className: 'text-primary'", "                }, 'Add Collection'),", "                m.component(Fangorn.Components.button, {", "                    onclick: function (event) {"]}, {"lines": ["                        tb.toolbarMode(Fangorn.Components.toolbarModes.ADDPROJECT);"]}, {"lines": ["                    },"]}, {"lines": ["                    icon: 'fa fa-cube',", "                    className: 'text-primary'", "                }, 'Add Existing Project')", "            );", "        }", "        if (!item.data.isFolder && item.data.parentIsFolder && !item.parent().data.isSmartFolder) {", "            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function (event) {", "                        url = '/api/v1/folder/' + theParentNodeID + '/pointer/' + theItem.node_id;", "                        var deleteAction = $.ajax({", "                            type: 'DELETE',", "                            url: url,", "                            contentType: 'application/json',", "                            dataType: 'json'", "                        });", "                        deleteAction.done(function () {", "                            tb.updateFolder(null, theParentNode);", "                            tb.clearMultiselect();", "                        });", "                        deleteAction.fail(function (xhr, status, error) {", "                            Raven.captureMessage('Remove from collection in PO failed.', {", "                                url: url,", "                                textStatus: status,", "                                error: error", "                            });", "                        });", "                    },"]}, {"lines": ["                    icon: 'fa fa-minus',", "                    className: 'text-primary'", "                }, 'Remove from Collection')", "            );", "        }", "        if (!item.data.isDashboard && !item.data.isRegistration && item.data.permissions && item.data.permissions.edit) {", "            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function (event) {"]}, {"lines": ["                        tb.toolbarMode(Fangorn.Components.toolbarModes.RENAME);"]}, {"lines": ["                    },"]}, {"lines": ["                    icon: 'fa fa-font',", "                    className: 'text-primary'", "                }, 'Rename')", "            );", "        }", "        if (item.data.isFolder && !item.data.isDashboard && !item.data.isSmartFolder) {", "            buttons.push(", "                m.component(Fangorn.Components.button, {", "                    onclick: function (event) {", "                        _deleteFolder.call(tb, item, theItem);", "                    },"]}, {"lines": ["                    icon: 'fa fa-trash',", "                    className: 'text-danger'", "                }, 'Delete')", "            );", "        }", "        return m('span', buttons);", "    }", "};"]}, {"lines": [""]}, {"lines": ["var _dismissToolbar = function () {"]}, {"lines": ["    var tb = this;"]}, {"lines": ["    if (tb.toolbarMode() === Fangorn.Components.toolbarModes.SEARCH){"]}, {"lines": ["        tb.resetFilter();", "    }"]}, {"lines": ["    tb.toolbarMode(Fangorn.Components.toolbarModes.DEFAULT);"]}, {"lines": ["    tb.filterText('');"]}, {"lines": ["    tb.select('.tb-header-row .twitter-typeahead').remove();"]}, {"lines": ["    m.redraw();"]}, {"lines": ["};"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["var POToolbar = {", "    controller: function (args) {", "        var self = this;", "        self.tb = args.treebeard;"]}, {"lines": ["        self.tb.toolbarMode = m.prop(Fangorn.Components.toolbarModes.DEFAULT);"]}, {"lines": ["        self.tb.inputValue = m.prop('');"]}, {"lines": ["        self.items = args.treebeard.multiselected;", "        self.mode = self.tb.toolbarMode;", "        self.helpText = m.prop('');"]}, {"lines": ["        self.dismissToolbar = _dismissToolbar.bind(self.tb);"]}, {"lines": ["    },", "    view: function (ctrl) {", "        var templates = {};", "        var generalButtons = [];"]}, {"lines": ["        var rowButtons = [];"]}, {"lines": ["        var dismissIcon = m.component(Fangorn.Components.button, {", "            onclick: ctrl.dismissToolbar,"]}, {"lines": ["            icon : 'fa fa-times'"]}, {"lines": ["        }, '');"]}, {"lines": ["        templates[Fangorn.Components.toolbarModes.SEARCH] =  ["]}, {"lines": ["            m('.col-xs-10', [", "                ctrl.tb.options.filterTemplate.call(ctrl.tb)", "            ]),", "            m('.col-xs-2.tb-buttons-col',"]}, {"lines": ["                m('.fangorn-toolbar.pull-right',", "                    ["]}, {"lines": ["                        m.component(Fangorn.Components.button, {", "                            onclick: ctrl.dismissToolbar,"]}, {"lines": ["                            icon : 'fa fa-times'", "                        }, 'Close')"]}, {"lines": ["                    ]"]}, {"lines": ["                    )"]}, {"lines": ["                )", "        ];"]}, {"lines": ["        templates[Fangorn.Components.toolbarModes.ADDFOLDER] = ["]}, {"lines": ["            m('.col-xs-9',", "                m.component(Fangorn.Components.input, {", "                    onkeypress: function (event) {"]}, {"lines": ["                        if (ctrl.tb.pressedKey === ENTER_KEY) {"]}, {"lines": ["                            _addFolderEvent.call(ctrl.tb);", "                        }", "                    },", "                    id : 'addNewFolder',", "                    helpTextId : 'addFolderHelp',", "                    placeholder : 'New collection name',"]}, {"lines": ["                }, ctrl.helpText())"]}, {"lines": ["                ),"]}, {"lines": ["            m('.col-xs-3.tb-buttons-col',", "                m('.fangorn-toolbar.pull-right',", "                    [", "                        m.component(Fangorn.Components.button, {", "                            onclick: function () {", "                                _addFolderEvent.call(ctrl.tb);", "                            },"]}, {"lines": ["                            icon : 'fa fa-plus',", "                            className : 'text-info'", "                        }, 'Add'),", "                        dismissIcon", "                    ]"]}, {"lines": ["                    )"]}, {"lines": ["                )", "        ];"]}, {"lines": ["        templates[Fangorn.Components.toolbarModes.RENAME] = ["]}, {"lines": ["            m('.col-xs-9',", "                m.component(Fangorn.Components.input, {", "                    onkeypress: function (event) {"]}, {"lines": ["                        ctrl.tb.inputValue($(event.target).val());"]}, {"lines": ["                        if (ctrl.tb.pressedKey === ENTER_KEY) {", "                            _renameEvent.call(ctrl.tb);", "                        }", "                    },", "                    id : 'renameInput',", "                    helpTextId : 'renameHelpText',", "                    placeholder : null,"]}, {"lines": ["                    value : ctrl.tb.inputValue(),"]}, {"lines": ["                    tooltip: 'Rename this item'", "                }, ctrl.helpText())", "                ),"]}, {"lines": ["            m('.col-xs-3.tb-buttons-col',", "                m('.fangorn-toolbar.pull-right',", "                    [", "                        m.component(Fangorn.Components.button, {", "                            onclick: function () {", "                                _renameEvent.call(ctrl.tb);", "                            },"]}, {"lines": ["                            icon : 'fa fa-pencil',", "                            className : 'text-info'", "                        }, 'Rename'),", "                        dismissIcon", "                    ]"]}, {"lines": ["                    )"]}, {"lines": ["                )", "        ];"]}, {"lines": ["        templates[Fangorn.Components.toolbarModes.ADDPROJECT] = ["]}, {"lines": ["            m('.col-xs-9', [", "                m('input#addprojectInput.tb-header-input', {", "                    config : function () {", "                        applyTypeahead.call(ctrl.tb);", "                    },"]}, {"lines": ["                    onkeypress : function (event) {", "                        if (ctrl.tb.pressedKey === ENTER_KEY) {", "                            addProjectEvent.call(ctrl.tb);", "                        }", "                    },"]}, {"lines": ["                    type : 'text',", "                    placeholder : 'Name of the project to find'", "                }),", "                m('#add-link-warning.text-warning.p-sm')", "            ]", "                ),", "            m('.col-xs-3.tb-buttons-col',", "                m('.fangorn-toolbar.pull-right',", "                    [", "                        m.component(Fangorn.Components.button, {", "                            onclick: function () {", "                                addProjectEvent.call(ctrl.tb);", "                            },"]}, {"lines": ["                            icon : 'fa fa-plus',", "                            className : 'text-info'", "                        }, 'Add'),", "                        dismissIcon", "                    ]"]}, {"lines": ["                    )"]}, {"lines": ["                )", "        ];", "        generalButtons.push(", "            m.component(Fangorn.Components.button, {", "                onclick: function (event) {"]}, {"lines": ["                    ctrl.mode(Fangorn.Components.toolbarModes.SEARCH);"]}, {"lines": ["                    ctrl.tb.clearMultiselect();", "                },"]}, {"lines": ["                icon: 'fa fa-search',", "                className : 'text-primary'", "            }, 'Search'),", "            m.component(Fangorn.Components.button, {", "                onclick: function (event) {", "                    showLegend.call(ctrl.tb);", "                },"]}, {"lines": ["                icon: 'fa fa-info',", "                className : 'text-info'", "            }, '')", "        );"]}, {"lines": ["        if(ctrl.items().length > 1){"]}, {"lines": ["            var someItemsAreFolders = false;", "            var pointerIds = [];", "            var theParentNode = ctrl.items()[0].parent();", "            ctrl.items().forEach(function (item) {", "                var thisItem = item.data;"]}, {"lines": ["                pointerIds.push(thisItem.node_id);", "            });", "            if(!someItemsAreFolders){", "                generalButtons.push(", "                    m.component(Fangorn.Components.button, {", "                        onclick: function (event) {", "                            deleteMultiplePointersFromFolder.call(ctrl.tb, pointerIds, theParentNode);", "                        },"]}, {"lines": ["                        icon: 'fa fa-minus',", "                        className : 'text-primary'", "                    }, 'Remove All from Collection')", "                );", "            }", "        }"]}, {"lines": ["        if (ctrl.items().length === 1) {"]}, {"lines": ["            rowButtons = m.component(POItemButtons, {treebeard : ctrl.tb, item : ctrl.items()[0]});"]}, {"lines": ["        }"]}, {"lines": ["        templates[Fangorn.Components.toolbarModes.DEFAULT] = m('.col-xs-12',m('.pull-right', [rowButtons, generalButtons]));"]}, {"lines": ["        return m('.row.tb-header-row', [", "            m('#headerRow', { config : function () {", "                $('#headerRow input').focus();", "            }}, [", "                templates[ctrl.mode()]"]}, {"lines": ["            ])", "        ]);", "    }"]}, {"lines": ["};"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["function _deleteFolder(item) {"]}, {"lines": ["    var tb = this;", "    var theItem = item.data;"]}, {"lines": ["    function runDeleteFolder() {"]}, {"lines": ["        var url = '/api/v1/folder/' + theItem.node_id;", "        var deleteAction = $.ajax({", "                type: 'DELETE',", "                url: url,", "                contentType: 'application/json',", "                dataType: 'json'", "            });", "        deleteAction.done(function () {", "            tb.updateFolder(null, item.parent());", "            tb.modal.dismiss();", "            tb.select('.tb-row').first().trigger('click');", "        });", "    }"]}, {"lines": ["    var mithrilContent = m('div', [", "            m('h3.break-word', 'Delete \"' + theItem.name + '\"?'),", "            m('p', 'Are you sure you want to delete this Collection? This will also delete any Collections ' +"]}, {"lines": ["                'inside this one. You will not delete any projects in this Collection.')"]}, {"lines": ["        ]);", "    var mithrilButtons = m('div', [", "            m('span.tb-modal-btn', { 'class' : 'text-primary', onclick : function() { tb.modal.dismiss(); } }, 'Cancel'),", "            m('span.tb-modal-btn', { 'class' : 'text-danger', onclick : function() { runDeleteFolder(); }  }, 'Delete')", "        ]);", "    tb.modal.update(mithrilContent, mithrilButtons);"]}, {"lines": ["}", ""]}, {"lines": ["/**", " * OSF-specific Treebeard options common to all addons.", " * For documentation visit: https://github.com/caneruguz/treebeard/wiki", " */"]}, {"lines": ["var tbOptions = {"]}, {"lines": ["    rowHeight : 35,         // user can override or get from .tb-row height"]}, {"lines": ["    showTotal : 15,         // Actually this is calculated with div height, not needed. NEEDS CHECKING", "    paginate : false,       // Whether the applet starts with pagination or not.", "    paginateToggle : false, // Show the buttons that allow users to switch between scroll and paginate.", "    uploads : false,         // Turns dropzone on/off.", "    columnTitles : _poColumnTitles,", "    resolveRows : _poResolveRows,"]}, {"lines": ["    showFilter : true,     // Gives the option to filter by showing the filter box."]}, {"lines": ["    title : false,          // Title of the grid, boolean, string OR function that returns a string.", "    allowMove : true,       // Turn moving on or off.", "    moveClass : 'po-draggable',"]}, {"lines": ["    hoverClass : 'fangorn-hover',", "    hoverClassMultiselect : 'fangorn-selected',"]}, {"lines": ["    togglecheck : _poToggleCheck,", "    sortButtonSelector : {"]}, {"lines": ["        up : 'i.fa.fa-chevron-up',", "        down : 'i.fa.fa-chevron-down'"]}, {"lines": ["    },"]}, {"lines": ["    sortDepth : 1,"]}, {"lines": ["    dragOptions : {},", "    dropOptions : {},", "    dragEvents : {", "        start : _poDragStart", "    },", "    dropEvents : {", "        drop : _poDrop,", "        over : _poOver", "    },", "    onload : function () {"]}, {"lines": ["        var tb = this,"]}, {"lines": ["            rowDiv = tb.select('.tb-row');"]}, {"lines": ["        _poLoadOpenChildren.call(tb);"]}, {"lines": ["        rowDiv.first().trigger('click');"]}, {"lines": [""]}, {"lines": ["        $('.gridWrapper').on('mouseout', function () {"]}, {"lines": ["            rowDiv.removeClass('po-hover');"]}, {"lines": ["    },", "    createcheck : function (item, parent) {"]}, {"lines": ["        return true;", "    },"]}, {"lines": ["    deletecheck : function (item) {"]}, {"lines": ["        return true;", "    },", "    ontogglefolder : function (item, event) {", "        if (event) {", "            saveExpandState(item.data);", "        }", "        if (!item.open) {", "            item.load = false;", "        }"]}, {"lines": ["        $('[data-toggle=\"tooltip\"]').tooltip();", "    },"]}, {"lines": ["    onscrollcomplete : function () {"]}, {"lines": ["        $('[data-toggle=\"tooltip\"]').tooltip();"]}, {"lines": ["    },", "    onmultiselect : _poMultiselect,"]}, {"lines": ["    resolveToggle : _poResolveToggle,", "    resolveLazyloadUrl : _poResolveLazyLoad,"]}, {"lines": ["    lazyLoadOnLoad : expandStateLoad,"]}, {"lines": ["    resolveRefreshIcon : function () {"]}, {"lines": ["        return m('i.fa.fa-refresh.fa-spin');"]}, {"lines": ["    },"]}, {"lines": ["    toolbarComponent : POToolbar"]}, {"lines": ["};"]}, {"lines": ["/**", " * Initialize Project organizer in the fashion of Fangorn. Prepeares an option object within ProjectOrganizer", " * @param options Treebeard type options to be extended with Treebeard default options.", " * @constructor", " */", "function ProjectOrganizer(options) {", "    this.options = $.extend({}, tbOptions, options);"]}, {"lines": ["    this.grid = null; // Set by _initGrid", "    this.init();", "}"]}, {"lines": ["/**", " * Project organizer prototype object with init functions set to Treebeard.", " * @type {{constructor: ProjectOrganizer, init: Function, _initGrid: Function}}", " */", "ProjectOrganizer.prototype = {", "    constructor: ProjectOrganizer,", "    init: function () {", "        this._initGrid();", "    },"]}, {"lines": ["    _initGrid: function () {", "        this.grid = new Treebeard(this.options);", "        return this.grid;"]}, {"lines": ["    }"]}, {"lines": ["};"]}, {"lines": [""]}, {"lines": ["require('../../css/navbar.css');"]}, {"lines": ["// $osf.applyBindings({}, '#navbarScope');"]}, {"lines": [""]}, {"lines": ["$(document).on('click', '.project-toggle', function() {"]}, {"lines": ["    var widget = $(this).closest('.addon-widget-container');"]}, {"lines": ["    if(up.length > 0) {"]}, {"lines": ["    }", "    if(down.length > 0) {"]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["    widget.find('.addon-widget-body').slideToggle();", "    return false;", "});"]}, {"lines": [""]}, {"lines": ["var nodeApiUrl = window.contextVars.node.urls.api;", "", "$(document).ready(function(){"]}, {"lines": ["        });"]}, {"lines": ["require('css/front-page.css');"]}, {"lines": ["new SignUp('#signUpScope', '/api/v1/register/');"]}, {"lines": ["var TweenLite = require('TweenLite');", "require('EasePack');"]}, {"lines": ["require('vendor/youtube');"]}, {"lines": ["", "// ANIMATION FOR FRONT PAGE"]}, {"lines": ["$( document ).ready(function() {", "    $('#logo').removeClass('off');"]}, {"lines": ["    $('.youtube').YouTubeModal({autoplay:1, width:640, height:480});"]}, {"lines": ["});", ""]}, {"lines": [""]}, {"lines": ["(function() {"]}, {"lines": ["    var width;", "    var height;", "    var largeHeader;", "    var canvas;", "    var ctx;", "    var points;", "    var target;", "    var animateHeader = true;"]}, {"lines": ["    // Main", "    initHeader();", "    initAnimation();", "    addListeners();", "", "    function initHeader() {", "        width = window.innerWidth;", "        height = '800';", "        target = {x: width/2, y: height/2};", "", "        largeHeader = document.getElementById('home-hero');", "", "        canvas = document.getElementById('demo-canvas');", "        canvas.width = width - 20;", "        canvas.height = height;", "        ctx = canvas.getContext('2d');", "", "        // create points", "        points = [];", "        for(var x = 0; x < width; x = x + width/20) {", "            for(var y = 0; y < height; y = y + height/20) {", "                var px = x + Math.random()*width/20;", "                var py = y + Math.random()*height/20;", "                var p = {x: px, originX: px, y: py, originY: py };", "                points.push(p);", "            }", "        }", "", "        // for each point find the 5 closest points", "        for(var i = 0; i < points.length; i++) {", "            var closest = [];", "            var p1 = points[i];", "            for(var j = 0; j < points.length; j++) {"]}, {"lines": ["                var p2 = points[j];", "                if(p1 !== p2) {"]}, {"lines": ["                    var placed = false;", "                    for(var k = 0; k < 5; k++) {", "                        if(!placed) {"]}, {"lines": ["                            if(closest[k] === undefined) {"]}, {"lines": ["                                closest[k] = p2;", "                                placed = true;", "                            }", "                        }", "                    }"]}, {"lines": ["                    for(var l = 0; l < 5; l++) {"]}, {"lines": ["                        if(!placed) {"]}, {"lines": ["                            if(getDistance(p1, p2) < getDistance(p1, closest[l])) {", "                                closest[l] = p2;"]}, {"lines": ["                                placed = true;", "                            }", "                        }", "                    }", "                }", "            }", "            p1.closest = closest;", "        }", "", "        // assign a circle to each point"]}, {"lines": ["        for(var m in points) {", "            var c = new Circle(points[m], 2+Math.random()*2, 'rgba(255,255,255,0.3)');", "            points[m].circle = c;"]}, {"lines": ["        }", "    }", "", "    // Event handling", "    function addListeners() {", "        setPos();", "        window.addEventListener('scroll', scrollCheck);", "        window.addEventListener('resize', resize);", "    }", "", "    function setPos(e) {", "        target.x = window.innerWidth/2;", "        target.y = 330;", "    }", "", "    function scrollCheck() {"]}, {"lines": ["        if(document.body.scrollTop > height) {", "            animateHeader = false;", "        } else {", "            animateHeader = true;", "        }"]}, {"lines": ["    }", "", "    function resize() {", "        target.x = window.innerWidth/2;", "        canvas.width = window.innerWidth - 20;", "    }", "", "    // animation", "    function initAnimation() {", "        animate();", "        for(var i in points) {", "            shiftPoint(points[i]);", "        }", "    }", "", "    function animate() {", "        if(animateHeader) {", "            ctx.clearRect(0,0,width,height);", "            for(var i in points) {", "                // detect points in range", "                if(Math.abs(getDistance(target, points[i])) < 4000) {", "                    points[i].active = 0.3;", "                    points[i].circle.active = 0.6;", "                } else if(Math.abs(getDistance(target, points[i])) < 20000) {", "                    points[i].active = 0.1;", "                    points[i].circle.active = 0.3;", "                } else if(Math.abs(getDistance(target, points[i])) < 40000) {", "                    points[i].active = 0.02;", "                    points[i].circle.active = 0.1;", "                } else {", "                    points[i].active = 0;", "                    points[i].circle.active = 0;", "                }"]}, {"lines": ["                drawLines(points[i]);", "                points[i].circle.draw();", "            }", "        }", "        requestAnimationFrame(animate);", "    }", "", "    function shiftPoint(p) {", "        TweenLite.to(p, 1+1*Math.random(), {x:p.originX-50+Math.random()*100,", "            y: p.originY-50+Math.random()*100, ease:Circ.easeInOut,", "            onComplete: function() {", "                shiftPoint(p);", "            }});", "    }", "", "    // Canvas manipulation", "    function drawLines(p) {"]}, {"lines": ["        if(!p.active) {", "            return;", "        }"]}, {"lines": ["        for(var i in p.closest) {", "            ctx.beginPath();", "            ctx.moveTo(p.x, p.y);", "            ctx.lineTo(p.closest[i].x, p.closest[i].y);", "            ctx.strokeStyle = 'rgba(156,217,249,'+ p.active+')';", "            ctx.stroke();", "        }", "    }", "", "    function Circle(pos,rad,color) {"]}, {"lines": ["        var self = this;"]}, {"lines": ["", "        // constructor", "        (function() {"]}, {"lines": ["            self.pos = pos || null;", "            self.radius = rad || null;", "            self.color = color || null;"]}, {"lines": ["        })();", "", "        this.draw = function() {"]}, {"lines": ["            if(!self.active) {", "                return;", "            }"]}, {"lines": ["            ctx.beginPath();"]}, {"lines": ["            ctx.arc(self.pos.x, self.pos.y, self.radius, 0, 2 * Math.PI, false);", "            ctx.fillStyle = 'rgba(156,217,249,'+ self.active+')';"]}, {"lines": ["            ctx.fill();", "        };", "    }", "", "    // Util", "    function getDistance(p1, p2) {", "        return Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2);", "    }", "", "})();"]}, {"lines": ["var m = require('mithril');"]}, {"lines": ["$('body').on('nodeLoad', function(event, data) {"]}, {"lines": ["});", ""]}, {"lines": ["$(document).ready(function () {"]}, {"lines": ["                        {"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        onSize : 'xs',"]}, {"lines": ["        'onclick' : function (event, title, buttonState, thisbtn, col) {"]}, {"lines": ["                buttonState"]}, {"lines": [""]}, {"lines": ["    var panelToggle = $('.panel-toggle');", "    var panelExpand = $('.panel-expand');"]}, {"lines": ["        el.children('.panel-collapsed').removeClass('hidden');", "        $('.wiki-nav').removeClass('hidden');"]}, {"lines": ["        var el = $(this).parent();", "        var toggle = el.closest('.panel-toggle');"]}, {"lines": ["        el.addClass('hidden');"]}, {"lines": ["        $('.wiki-nav').addClass('hidden');"]}, {"lines": ["    ${self.content_wrap()}"]}, {"lines": ["", "    ${self.footer()}", "    <%include file=\"copyright.mako\"/>"]}, {"lines": ["<%def name=\"footer()\">", "    <%include file=\"footer.mako\"/>", "</%def>"]}, {"lines": ["<%def name=\"content_wrap()\">"]}, {"lines": ["    <div class=\"watermarked\">", "        <div class=\"container ${self.container_class()}\">", "            % if status:", "                <%include file=\"alert.mako\"/>", "            % endif", "            ${self.content()}", "        </div><!-- end container -->", "    </div><!-- end watermarked -->", "</%def>", "", ""]}, {"lines": ["<div class=\"container copyright\">", "    <div class=\"row\">", "        <div class=\"col-md-12\">", "            <p>Copyright &copy; 2011-2015 <a href=\"http://centerforopenscience.org\">Center for Open Science</a> |", "                <a href=\"https://github.com/CenterForOpenScience/centerforopenscience.org/blob/master/TERMS_OF_USE.md\">Terms of Use</a> |", "                <a href=\"https://github.com/CenterForOpenScience/centerforopenscience.org/blob/master/PRIVACY_POLICY.md\">Privacy Policy</a>", "            </p>", "        </div>", "    </div>", "</div><!-- end container copyright -->"]}, {"lines": ["<%def name=\"content_wrap()\">"]}, {"lines": ["    <div class=\"watermarked\">", "            % if status:"]}, {"lines": ["                <div id=\"alert-container\">", "                % for message, css_class, dismissible in status:"]}, {"lines": ["                      <div class='alert alert-block alert-${css_class} fade in alert-front text-center'>"]}, {"lines": ["                        % if dismissible:", "                        <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\">", "                          <span aria-hidden=\"true\">&times;</span>", "                        </button>", "                        % endif", "                        <p>${message}</p>", "                      </div>", "                % endfor", "                </div>"]}, {"lines": ["            % endif", "            ${self.content()}", "    </div><!-- end watermarked -->", "</%def>", ""]}, {"lines": ["", "    <!-- Main jumbotron for a primary marketing message or call to action -->", "    <div id=\"home-hero\">", "      <div class=\"container text-center\">", "        <h1><strong>Simplified</strong> scientific collaboration</h1>"]}, {"lines": ["        <h3>Powerful end-to-end support for your research.</h3>"]}, {"lines": ["", "        <canvas id=\"demo-canvas\"></canvas>", "", "        <div id=\"logo\" class=\"off\">", "          <div class=\"circle\" id=\"circle-1\"><span></span></div>", "          <div class=\"circle\" id=\"circle-2\"><span></span></div>", "          <div class=\"circle\" id=\"circle-3\"><span></span></div>", "          <div class=\"circle\" id=\"circle-4\"><span></span></div>", "          <div class=\"circle\" id=\"circle-5\"><span></span></div>", "          <div class=\"circle\" id=\"circle-6\"><span></span></div>", "          <div class=\"circle\" id=\"circle-7\"><span></span></div>", "          <div class=\"circle\" id=\"circle-8\"><span></span></div>"]}, {"lines": ["", "        <div id=\"hero-signup\" class=\"container\">", "          <div class=\"row\">", "            <div class=\"col-sm-6 hidden-xs\">", "              <a class=\"youtube\" href=\"//www.youtube.com/watch?v=2TV21gOzfhw\"><i class=\"icon icon-play\"></i></a>"]}, {"lines": ["              <img src=\"/static/img/front-page/screenshot.png\" class=\"img-responsive\" id=\"screenshot\" alt=\"\" />"]}, {"lines": ["            </div>", "            <div class=\"col-sm-6\">"]}, {"lines": ["              <h2>Free. Get started today.</h2>"]}, {"lines": ["", "             <div id=\"signUp\" class=\"anchor\"></div>", "                <div id=\"signUpScope\">", "                    <form data-bind=\"submit: submit\">", "                        <div class=\"form-group\" data-bind=\"css: {'has-error': fullName() && !fullName.isValid(), 'has-success': fullName() && fullName.isValid()}\">", "                              <label class=\"placeholder-replace\" style=\"display:none\">Full Name</label>", "                              <input class=\"form-control\" placeholder=\"Full Name\" data-bind=\" value: fullName, disable: submitted(), event: { blur: trim.bind($data, fullName)}\">", "                              <p class=\"help-block signup-help\" data-bind=\"validationMessage: fullName\" style=\"display: none;\"></p>", "                          </div>", "                          <div class=\"form-group\" data-bind=\"css: {'has-error': email1() && !email1.isValid(), 'has-success': email1() && email1.isValid()}\">", "                              <label class=\"placeholder-replace\" style=\"display:none\">Contact Email</label>", "                              <input class=\"form-control\" placeholder=\"Contact Email\" data-bind=\" value: email1, disable: submitted(), event: { blur: trim.bind($data, email1)}\">", "                              <p class=\"help-block signup-help\" data-bind=\"validationMessage: email1\" style=\"display: none;\"></p>", "                          </div>", "                          <div class=\"form-group\" data-bind=\"css: {'has-error': email2() && !email2.isValid(),'has-success': email2() && email2.isValid()}\">", "                              <label class=\"placeholder-replace\" style=\"display:none\">Confirm Email</label>", "                              <input class=\"form-control\" placeholder=\"Confirm Email\" data-bind=\"value: email2, disable: submitted(), event: { blur: trim.bind($data, email2)}\">", "                              <p class=\"help-block signup-help\" data-bind=\"validationMessage: email2\" style=\"display: none;\"></p>", "                          </div>", "                          <div class=\"form-group\" data-bind=\"css: {'has-error': password() && !password.isValid(), 'has-success': password() && password.isValid()}\">", "                              <label class=\"placeholder-replace\" style=\"display:none\">Password</label>"]}, {"lines": ["                                <p class=\"help-block signup-help\" data-bind=\"validationMessage: password\" style=\"display: none;\"></p>", "                          </div>", "", "                          <!-- Flashed Messages -->", "                          <div class=\"help-block signup-help\" >", "                              <p data-bind=\"html: flashMessage, attr.class: flashMessageClass\" class=\"\"></p>", "                          </div>", "                          <div>", "                              <button type=\"submit\" class=\"btn btn-warning\" data-bind=\"visible: !submitted()\" id=\"signupSubmit\">Sign up free</button>", "                          </div>", "                  </form>", "", "                </div><!-- end #signUpScope -->", "", ""]}, {"lines": ["            </div>", "          </div>"]}, {"lines": ["      </div>"]}, {"lines": ["", "    <div class=\"container grey-pullout space-top space-bottom\">", "", "      <div class=\"row space-bottom\">", "        <div class=\"col-xs-12 text-center\">", "          <h2><strong>Open Science Framework</strong></h2>"]}, {"lines": ["      </div>", "", "      <div class=\"row feature-1\">", "        <div class=\"col-md-6\">", "          <div class=\"row\">", "            <div class=\"col-xs-1\">", "              <i class=\"icon icon-cloud\"></i>", "            </div>", "            <div class=\"col-xs-9 col-xs-offset-1\">"]}, {"lines": ["              <h3>Structured projects</h3>", "              <p>Keep all your files, data, and protocols in <strong>one centralized location.</strong> No more trawling emails to find files or scrambling to recover from lost data. <span class=\"label label-primary\">Secure Cloud</span></p>"]}, {"lines": ["            </div>", "          </div>", "          <div class=\"row\">", "            <div class=\"col-xs-1\">", "              <i class=\"icon icon-group\"></i>", "            </div>", "            <div class=\"col-xs-9 col-xs-offset-1\">", "              <h3>Control access</h3>", "              <p><strong>You control which parts of your project are public or private</strong> making it easy to collaborate with the worldwide community or just your team.  <span class=\"label label-primary\">Project-level Permissions</span></p>", "            </div>", "          </div>", "          <div class=\"row\">", "            <div class=\"col-xs-1\">", "              <i class=\"icon icon-workflow\"></i>", "            </div>", "            <div class=\"col-xs-9 col-xs-offset-1\">", "              <h3>Respect for your workflow</h3>"]}, {"lines": ["            </div>", "          </div>"]}, {"lines": ["        <div class=\"col-md-6\">", "          <div class=\"student-image\">", "            <div class=\"quote\">", "              <span class=\"main\">\u201cThe OSF is a great way to collaborate and stay organized while still using your favorite external services.\"</span>"]}, {"lines": ["              <span class=\"attrib\"><strong>Kara Woo</strong> - Information Manager, Aquatic Ecology, Washington State</span>"]}, {"lines": ["            </div>", "          </div>"]}, {"lines": ["      </div>", ""]}, {"lines": ["", "    <div class=\"container\">", "      <div class=\"feature-2 space-top space-bottom\">", "        <div class=\"row\">", "          <div class=\"col-xs-12 text-center headline\">"]}, {"lines": ["          </div>", "        </div>", "        <div class=\"row integrations\">", "          <div class=\"col-sm-3 col-xs-6\">"]}, {"lines": ["            <img src=\"/static/img/front-page/dropbox.png\" class=\"img-responsive\"/>"]}, {"lines": ["          </div>", "          <div class=\"col-sm-3 col-xs-6\">"]}, {"lines": ["            <img src=\"/static/img/front-page/github.png\" class=\"img-responsive\"/>"]}, {"lines": ["          </div>", "          <div class=\"col-sm-3 col-xs-6\">"]}, {"lines": ["            <img src=\"/static/img/front-page/amazon.png\" class=\"img-responsive\"/>"]}, {"lines": ["          </div>", "          <div class=\"col-sm-3 col-xs-6\">"]}, {"lines": ["            <img src=\"/static/img/front-page/box.png\" class=\"img-responsive\"/>"]}, {"lines": ["          </div>", "      </div>", "      <div class=\"row integrations\">", "          <div class=\"col-sm-3 col-xs-6\">"]}, {"lines": ["           <img src=\"/static/img/front-page/google.png\" class=\"img-responsive\"/>"]}, {"lines": ["          </div>", "          <div class=\"col-sm-3 col-xs-6\">"]}, {"lines": ["            <img src=\"/static/img/front-page/figshare.png\" class=\"img-responsive\"/>"]}, {"lines": ["          </div>", "          <div class=\"col-sm-3 col-xs-6\">"]}, {"lines": ["            <img src=\"/static/img/front-page/dataverse.png\" class=\"img-responsive\"/>"]}, {"lines": ["          </div>", "          <div class=\"col-sm-3 col-xs-6\">"]}, {"lines": ["            <img src=\"/static/img/front-page/mendeley.png\" class=\"img-responsive\"/>"]}, {"lines": ["          </div>", "      </div>"]}, {"lines": [""]}, {"lines": ["      </div>", "    </div>", "", "    <div class=\"feature-3\">", "      <div class=\"container\">", "        <div class=\"row space-top\">", "", "          <div class=\"col-md-12 text-center space-bottom\">", "            <h2><strong>Everything</strong> your research needs to be a success</h2>", "          </div>", "        </div>", "        <div class=\"row space-bottom\">", "          <div class=\"col-sm-6 text-right\">", "            <h3>Manage your project</h3>", "            <p>View all of your projects from <strong>one dashboard.</strong></p>", "", "            <h3>Quickly share files</h3>", "            <p><strong>Share key project information</strong> and allow others to use and cite it.</p>", "", "            <h3>See project changes</h3>", "            <p>See the latest project changes, who is contributing and <strong>historical file versions.</strong></p>", ""]}, {"lines": ["            <h3>View project statistics</h3>", "            <p>Access <strong>project data</strong> ranging from visits over time to top referring websites.</p>", ""]}, {"lines": ["          </div>", "", "          <div class=\"col-sm-6 text-left\">"]}, {"lines": ["            <h3>Archive your data</h3>"]}, {"lines": [""]}, {"lines": ["            <h3>Control access and collaboration</h3>", "            <p> Add others to your projects to collaborate, or provide private access to view.</p>"]}, {"lines": ["", "            <h3>Supercharge your workflow</h3>"]}, {"lines": ["", "            <h3>Registration</h3>", "            <p><strong>Preserve the state of a project at important parts of its lifecycle</strong> such as the onset of data collection.</p>", "          </div>"]}, {"lines": ["      </div>"]}, {"lines": ["", "      <div class=\"feature-4\">", "        <div class=\"container\">", "          <div class=\"row space-top space-bottom text-center\">", "            <div class=\"col-md-4 col-md-offset-1\">", "              <i class=\"icon icon-earth\"></i>", "              <h2><strong>Contribute</strong> to global scientific efforts</h2>"]}, {"lines": ["            </div>", "            <div class=\"col-md-4 col-md-offset-1\">", "              <i class=\"icon icon-nonprofit\"></i>", "              <h2>We are a <strong>mission-driven non-profit</strong></h2>"]}, {"lines": ["            </div>", "          </div>", "        </div>", "      </div>", "", "    <div class=\"container\">", "", "      <div class=\"space-top space-bottom feature-5\">", "", "        <div class=\"row\">", "          <div class=\"col-md-12 text-center\">", "            <h2><strong>Teachers, researchers, and global teams rely</strong> on the Open Science Framework</h2>", "          </div>", "        </div>", "", "        <div class=\"row\">", "          <div class=\"col-xs-3\">"]}, {"lines": ["            <img src=\"/static/img/front-page/user2.jpg\" class=\"img-circle img-responsive\" alt=\"Richard Ball\" />"]}, {"lines": ["          </div>", "          <div class=\"col-xs-8\">", "            <h3>Making research reproducible &amp; verifiable</h3>"]}, {"lines": ["          </div>", "        </div>", "", "        <div class=\"row hidden-xs hidden-sm\">", "          <div class=\"col-md-7 col-md-offset-2\">", "            <h3>Version control makes life easier</h3>"]}, {"lines": ["          </div>", "          <div class=\"col-md-3\">"]}, {"lines": ["            <img src=\"/static/img/front-page/user3.jpg\" class=\"img-circle img-responsive\" alt=\"Erica Baranski\" />"]}, {"lines": ["          </div>"]}, {"lines": ["", "        <div class=\"row hidden-xs hidden-sm\">", "          <div class=\"col-md-3\">"]}, {"lines": ["            <img src=\"/static/img/front-page/user4.jpg\" class=\"img-circle img-responsive\" alt=\"\" />"]}, {"lines": ["          </div>", "          <div class=\"col-md-7\">", "            <h3>A centralized hub of information</h3>", "            <p>The OSF creates a centralized hub of information where I can oversee a diversity of research projects across multiple classes. The centralization, organization and anywhere-access save me the time and energy necessary for managing these projects.<br/><small><em>Anne Allison, Associate Professor of Biology at Piedmont Virginia Community College</em></small></em></small></p>", "          </div>", "        </div>", "", "", "      </div>"]}, {"lines": ["    <div class=\"space-top space-bottom feature-6\">", "      <div class=\"container\">", "        <div class=\"row\">", "          <div class=\"col-md-8\">", "            <h2><strong>Free and open source.</strong></h2>"]}, {"lines": ["            <a href=\"#\" class=\"btn btn-info btn-lg\">Get Started</a>", "          </div>", "          <div class=\"col-md-4 hidden-xs hidden-sm\">", "            <div id=\"logo\">", "              <div class=\"circle\" id=\"circle-1\"><span></span></div>", "              <div class=\"circle\" id=\"circle-2\"><span></span></div>", "              <div class=\"circle\" id=\"circle-3\"><span></span></div>", "              <div class=\"circle\" id=\"circle-4\"><span></span></div>", "              <div class=\"circle\" id=\"circle-5\"><span></span></div>", "              <div class=\"circle\" id=\"circle-6\"><span></span></div>", "              <div class=\"circle\" id=\"circle-7\"><span></span></div>", "              <div class=\"circle\" id=\"circle-8\"><span></span></div>", "            </div>", "          </div>"]}, {"lines": ["      </div>", ""]}, {"lines": ["", "", "</%def>", "", "<%def name=\"footer()\">", ""]}, {"lines": [""]}, {"lines": ["<div class=\"osf-nav-wrapper\">"]}, {"lines": ["", "<nav class=\"navbar navbar-inverse navbar-fixed-top\" id=\"navbarScope\" role=\"navigation\">"]}, {"lines": ["    <div class=\"navbar-header\">", "      <button type=\"button\" class=\"navbar-toggle collapsed\" data-toggle=\"collapse\" data-target=\"#navbar\" aria-expanded=\"false\" aria-controls=\"navbar\">", "        <span class=\"sr-only\">Toggle navigation</span>", "        <span class=\"icon-bar\"></span>", "        <span class=\"icon-bar\"></span>", "        <span class=\"icon-bar\"></span>", "      </button>"]}, {"lines": ["      <a class=\"navbar-brand hidden-sm hidden-xs\" href=\"/\"><img src=\"/static/img/cos-white2.png\" class=\"osf-navbar-logo\" width=\"27\" alt=\"COS logo\"/> Open Science Framework</a>", "      <a class=\"navbar-brand visible-sm visible-xs\" href=\"/\"><img src=\"/static/img/cos-white2.png\" class=\"osf-navbar-logo\" width=\"27\" alt=\"COS logo\"/> OSF</a>"]}, {"lines": ["    </div>", "    <div id=\"navbar\" class=\"navbar-collapse collapse navbar-right\">", "      <ul class=\"nav navbar-nav\">"]}, {"lines": ["        <li class=\"dropdown\">", "          <a href=\"#\" class=\"dropdown-toggle\" data-toggle=\"dropdown\" role=\"button\" aria-expanded=\"false\">Explore <span class=\"caret hidden-xs\"></span></a>", "          <ul class=\"dropdown-menu\" role=\"menu\">", "              <li><a href=\"/search/?q=*&amp;filter=registration\">Registry</a></li>", "              <li><a href=\"/meetings/\">Meetings</a></li>"]}, {"lines": ["          </ul>", "        </li>", "        <li class=\"dropdown\">", "          <a href=\"#\" class=\"dropdown-toggle\" data-toggle=\"dropdown\" role=\"button\" aria-expanded=\"false\">Help <span class=\"caret hidden-xs\"></span></a>", "          <ul class=\"dropdown-menu\" role=\"menu\">", "              <li><a href=\"/4znZP/wiki/home\">About</a></li>", "              <li><a href=\"/faq/\">FAQ</a></li>", "              <li><a href=\"/getting-started\">Getting Started</a></li>"]}, {"lines": ["              <li><script type=\"text/javascript\">document.write(\"<n uers=\\\"znvygb:fhccbeg@bfs.vb\\\" ery=\\\"absbyybj\\\">Rznvy Fhccbeg</n>\".replace(/[a-zA-Z]/g,function(e){return String.fromCharCode((e<=\"Z\"?90:122)>=(e=e.charCodeAt(0)+13)?e:e-26)}));</script><noscript>Email Support: <span class=\"obfuscated-email-noscript\"><strong><u>supp<span style=\"display:none;\">null</span>ort@<span style=\"display:none;\">null</span>osf.<span style=\"display:none;\">null</span>io</u></strong></span></noscript></li>", "                <li><script type=\"text/javascript\">document.write(\"<n uers=\\\"znvygb:pbagnpg@bfs.vb\\\" ery=\\\"absbyybj\\\">Pbagnpg</n>\".replace(/[a-zA-Z]/g,function(e){return String.fromCharCode((e<=\"Z\"?90:122)>=(e=e.charCodeAt(0)+13)?e:e-26)}));</script><noscript>Contact OSF: <span class=\"obfuscated-email-noscript\"><strong><u>cont<span style=\"display:none;\">null</span>act@<span style=\"display:none;\">null</span>osf.<span style=\"display:none;\">null</span>io</u></strong></span></noscript></li>"]}, {"lines": ["          </ul>", "        </li>"]}, {"lines": ["", "        <!-- ko ifnot: onSearchPage -->", "        <li class=\"hidden-xs\" data-bind=\"click : toggleSearch, css: searchCSS\">", "            <a class=\"\" >", "                <span rel=\"tooltip\" data-placement=\"bottom\" title=\"Search OSF\" class=\"fa fa-search fa-lg\" ></span>", "            </a>", "        </li>", "        <!-- /ko -->", "        % if user_name and display_name:", "        <li>"]}, {"lines": ["            <a class=\"hidden-lg hidden-xs nav-profile\" href=\"/profile/\">"]}, {"lines": ["                <span rel=\"tooltip\" data-placement=\"bottom\" title=\"${user_name}\" class=\"osf-gravatar\"><img src=\"${user_gravatar}\" alt=\"User gravatar\"/> </span>", "            </a>"]}, {"lines": ["            <a class=\"visible-lg visible-xs nav-profile\" href=\"/profile/\">"]}, {"lines": ["                <span rel=\"tooltip\" data-placement=\"bottom\" title=\"${user_name}\"><span class=\"osf-gravatar\"> <img src=\"${user_gravatar}\" alt=\"User gravatar\"/> </span> ${display_name}</span>", "            </a>", "        </li>", "        <li>", "            <a href=\"${web_url_for('user_profile')}\">", "                <span rel=\"tooltip\" data-placement=\"bottom\" title=\"Settings\" class=\"fa fa-cog hidden-xs fa-lg\"></span>", "                <span class=\"visible-xs\">Settings</span>", "            </a>", "        </li>", "        <li>", "            <a href=\"${web_url_for('auth_logout')}\">", "                <span rel=\"tooltip\" data-placement=\"bottom\" title=\"Log&nbsp;out\" class=\"fa fa-sign-out hidden-xs fa-lg\"></span>", "                <span class=\"visible-xs\">Log out</span>", "            </a>", "        </li>", "        % elif allow_login:", "        <li class=\"dropdown sign-in\" data-bind=\"with: $root.signIn\">"]}, {"lines": ["          <div class=\"btn-group\">", "            <button type=\"button\" class=\"btn btn-info btn-top-login dropdown-toggle\" data-toggle=\"dropdown\" aria-expanded=\"false\">", "              Sign in <span class=\"caret hidden-xs\"></span>"]}, {"lines": ["            <ul class=\"dropdown-menu\" id=\"menuLogin\" role=\"menu\">"]}, {"lines": ["              <form class=\"form\" id=\"signInForm\" data-bind=\"submit: submit\" action=\"${login_url}\" method=\"POST\">", "                  <div class=\"form-group\"><input id=\"email\" class=\"form-control\" type=\"email\" data-bind=\"value: username\" name=\"username\" placeholder=\"Email\" aria-label=\"Username\"></div>", "                  <div class=\"form-group\"><input name=\"password\" id=\"password\" class=\"form-control\" type=\"password\" placeholder=\"Password\" data-bind=\"value: password\" aria-label=\"Password\"></div>"]}, {"lines": ["                  <div class=\"form-group\"><button type=\"submit\" id=\"btnLogin\" class=\"btn btn-block btn-primary\">Login</button></div>"]}, {"lines": ["                 <div class=\"text-center m-b-sm\"> <a href=\"/forgotpassword/\">Forgot Password?</a></div>"]}, {"lines": ["               </form>", "            </ul>", "          </div>", "        </li>"]}, {"lines": ["        % endif"]}, {"lines": ["    </div><!--/.navbar-collapse -->", "    </div>", ""]}, {"lines": [""]}, {"lines": ["</div>"]}, {"lines": ["<div class=\"osf-search\" data-bind=\"fadeVisible: showSearch\" style=\"display: none\">"]}, {"lines": ["<%def name=\"build_message(d, parent=None)\">"]}, {"lines": ["%for key in d['children']:"]}, {"lines": ["    %if d['children'][key]['messages']:"]}, {"lines": ["            <thead class=\"block-head\">"]}, {"lines": ["                %if parent :"]}, {"lines": ["                </h3>", "            </th>", "            </thead>", "            <tbody>", "            <tr>"]}, {"lines": ["                    %for m in d['children'][key]['messages']:"]}, {"lines": ["                </td>", "            </tr>", "            </tbody>", "        </table>"]}, {"lines": ["    %endif", "    %if isinstance(d['children'][key]['children'], dict):"]}, {"lines": ["        ${build_message(d['children'][key], key )}"]}, {"lines": ["    %endif", "%endfor", "</%def>", ""]}, {"lines": ["<div class=\"page-header  visible-xs\">"]}, {"lines": ["  <h2 class=\"text-300\">Files</h2>", "</div>", ""]}, {"lines": ["<div id=\"treeGrid\">"]}, {"lines": ["\t<div class=\"fangorn-loading\">"]}, {"lines": ["\t\t<div class=\"logo-spin text-center\"><img src=\"/static/img/logo_spin.png\" alt=\"loader\"> </div>", "\t\t<p class=\"m-t-sm fg-load-message\"> Loading files...  </p>", "\t</div>"]}, {"lines": ["</div>"]}, {"lines": ["", ""]}, {"lines": ["", ""]}, {"lines": ["<script type=\"text/javascript\">"]}, {"lines": ["    % endif", "</script>"]}, {"lines": ["    <div class=\"modal-dialog modal-lg\">"]}, {"lines": ["                            <table class=\"table-fixed\">"]}, {"lines": ["                                    <th width=\"10%\"></th>", "                                    <th width=\"15%\"></th>", "                                    <th width=\"45%\">Name</th>", "                                    <th width=\"30%\">"]}, {"lines": [""]}, {"lines": ["<div class=\"page-header visible-xs\">"]}, {"lines": ["  <h2 class=\"text-300\">Settings</h2>", "</div>", ""]}, {"lines": ["<div class=\"row project-page\">"]}, {"lines": ["    <div class=\"col-sm-3 affix-parent\">"]}, {"lines": ["    <div class=\"col-sm-9\">"]}, {"lines": ["<div class='addon-config-error p-sm'>"]}, {"lines": ["    ${globals.includes_top()}"]}], "name": "Caner Uguz"}, {"commits": [{"lines": ["        'ace-ext-language_tools': staticPath('vendor/bower_components/ace-builds/src-noconflict/ext-language_tools.js'),", "        'ace-mode-markdown': staticPath('vendor/bower_components/ace-builds/src-noconflict/mode-markdown.js'),"]}, {"lines": ["    sourcePrefix: ''"]}, {"lines": ["    analytics.hour.on(2)"]}, {"lines": ["    analytics.minute.on(0)  # Daily 2:00 a.m."]}, {"lines": ["    digest = ensure_item(cron, 'bash {}'.format(app_prefix('scripts/send_digest.sh')))"]}, {"lines": ["    digest.hour.on(2)"]}, {"lines": ["    digest.minute.on(0)  # Daily 2:00 a.m."]}, {"lines": [""]}, {"lines": ["    box = ensure_item(cron, 'bash {}'.format(app_prefix('scripts/refresh_box_tokens.sh')))"]}, {"lines": ["    box.hour.on(2)"]}, {"lines": ["    box.minute.on(0)  # Daily 2:00 a.m."]}, {"lines": ["    files_audit = ensure_item(cron, 'bash {}'.format(app_prefix('scripts/osfstorage/files_audit.sh')))"]}, {"lines": ["    files_audit.dow.on(0)"]}, {"lines": ["    files_audit.hour.on(2)"]}, {"lines": ["    files_audit.minute.on(0)  # Sunday 2:00 a.m."]}, {"lines": ["", "    glacier_inventory = ensure_item(cron, 'bash {}'.format(app_prefix('scripts/osfstorage/glacier_inventory.sh')))"]}, {"lines": ["    glacier_inventory.dow.on(0)"]}, {"lines": ["    glacier_inventory.hour.on(0)"]}, {"lines": ["    glacier_inventory.minute.on(0)  # Sunday 12:00 a.m."]}, {"lines": ["", "    glacier_audit = ensure_item(cron, 'bash {}'.format(app_prefix('scripts/osfstorage/glacier_audit.sh')))"]}, {"lines": ["    glacier_audit.dow.on(0)"]}, {"lines": ["    glacier_audit.hour.on(6)"]}, {"lines": ["    glacier_audit.minute.on(0)  # Sunday 6:00 a.m."]}, {"lines": ["from scripts.analytics import settings"]}, {"lines": ["    node = models.Node.load(settings.TABULATE_EMAILS_NODE_ID)", "    user = models.User.load(settings.TABULATE_EMAILS_USER_ID)", "    emails = get_emails_since(settings.TABULATE_EMAILS_TIME_DELTA)"]}, {"lines": ["    utils.send_file(app, settings.TABULATE_EMAILS_FILE_NAME, settings.TABULATE_EMAILS_CONTENT_TYPE, sio, node, user)"]}, {"lines": ["from scripts.analytics import settings"]}, {"lines": ["        settings.TABULATE_LOGS_RESULTS_COLLECTION,"]}, {"lines": ["    node = models.Node.load(settings.TABULATE_LOGS_NODE_ID)", "    user = models.User.load(settings.TABULATE_LOGS_USER_ID)", "    cutoff = datetime.datetime.utcnow() - settings.TABULATE_LOGS_TIME_OFFSET"]}, {"lines": ["    utils.send_file(app, settings.TABULATE_LOGS_FILE_NAME, settings.TABULATE_LOGS_CONTENT_TYPE, sio, node, user)"]}, {"lines": ["# encoding: utf-8", "", "from dateutil.relativedelta import relativedelta", "", "", "TABULATE_EMAILS_NODE_ID = '95nv8'  # Daily updates project", "TABULATE_EMAILS_USER_ID = 'icpnw'  # Daily updates user"]}, {"lines": ["TABULATE_EMAILS_FILE_NAME = '/daily-users.csv'"]}, {"lines": ["TABULATE_EMAILS_CONTENT_TYPE = 'text/csv'", "TABULATE_EMAILS_TIME_DELTA = relativedelta(days=1)", "", "TABULATE_LOGS_RESULTS_COLLECTION = 'logmetrics'", "TABULATE_LOGS_NODE_ID = '95nv8'  # Daily updates project", "TABULATE_LOGS_USER_ID = 'icpnw'  # Daily updates user"]}, {"lines": ["TABULATE_LOGS_FILE_NAME = '/log-counts.csv'"]}, {"lines": ["TABULATE_LOGS_CONTENT_TYPE = 'text/csv'", "TABULATE_LOGS_TIME_OFFSET = relativedelta(days=1)"]}, {"lines": ["audit_temp_path = None"]}, {"lines": ["    path = os.path.join(audit_temp_path, version.location['object'])"]}, {"lines": ["        obj.download(audit_temp_path)"]}, {"lines": ["        return path"]}, {"lines": ["        return None"]}, {"lines": ["    path = os.path.join(audit_temp_path, version.location['object'])"]}, {"lines": ["    file_path = download_from_cloudfiles(version)", "    if file_path:", "        glacier_id = vault.upload_archive(file_path, description=version.location['object'])", "        version.metadata['archive'] = glacier_id", "        version.save()"]}, {"lines": ["    if file_path:", "        parity_paths = storage_utils.create_parity_files(file_path)", "        for parity_path in parity_paths:", "            container_parity.create(parity_path)", "            os.remove(parity_path)", "        if not check_parity_files(version):", "            logger.error('Parity files for version {0} not found after update'.format(version._id))"]}, {"lines": ["    maxval = math.ceil(targets.count() / nworkers)", "    progress_bar = progressbar.ProgressBar(maxval=maxval).start()"]}, {"lines": ["    for version in targets:"]}, {"lines": ["            if idx < maxval:", "                progress_bar.update(idx)"]}, {"lines": ["            audit_temp_path = os.path.join(storage_settings.AUDIT_TEMP_PATH, str(worker_id))", "            try:", "                os.makedirs(audit_temp_path)", "            except OSError:", "                pass"]}, {"lines": ["# encoding: utf-8", ""]}, {"lines": ["USERNAME = None", "API_KEY = None", "REGION = None"]}, {"lines": [""]}, {"lines": ["PRIMARY_CONTAINER_NAME = None", "PARITY_CONTAINER_NAME = None"]}, {"lines": [""]}, {"lines": ["GLACIER_VAULT = None", "AWS_ACCESS_KEY = None", "AWS_SECRET_KEY = None", "AWS_SNS_ARN = None"]}, {"lines": [""]}, {"lines": ["AUDIT_TEMP_PATH = None"]}, {"lines": ["    def test_mfr_public_download_url_includes_view_only(self, mock_request):"]}, {"lines": ["        assert_in('view_only={}'.format(view_only), guid.mfr_public_download_url)", "        assert_in('accept_url=false', guid.mfr_public_download_url)", "", "    @mock.patch('website.addons.base.request')", "    def test_mfr_render_url(self, mock_request):", "        view_only = 'justworkplease'", "        mock_request.args = {", "            'view_only': view_only", "        }", "", "        path = 'cloudfiles'", "        guid, _ = self.node_addon.find_or_create_file_guid('/' + path)", "", "        assert_in(settings.MFR_SERVER_URL + '/render', guid.mfr_render_url)", "        assert_in('?url=', guid.mfr_render_url)"]}, {"lines": ["            '/' + self.attachment.filename,"]}, {"lines": ["            '/' + settings.MISSING_FILE_NAME,"]}, {"lines": ["from website.notifications.model import NotificationDigest", "from website.notifications.model import NotificationSubscription"]}, {"lines": ["        s = NotificationSubscription.find_one(Q('_id', 'eq', event_id))"]}, {"lines": ["            NotificationSubscription.find_one(Q('_id', 'eq', event_id))"]}, {"lines": ["        s = NotificationSubscription.find_one(Q('_id', 'eq', event_id))"]}, {"lines": ["        self.subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        self.node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["            subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["                NotificationSubscription.find_one(Q('owner', 'eq', project))"]}, {"lines": ["        self.project_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        self.node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        self.user_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        self.project_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        self.node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        user_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        project_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        project_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        project_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        node_subscription = factories.NotificationSubscriptionFactory("]}, {"lines": ["        subject = Template(emails.EMAIL_SUBJECT_MAP['comments']).render("]}, {"lines": ["        digest_count_before = NotificationDigest.find().count()"]}, {"lines": ["        digest_count = NotificationDigest.find().count()"]}, {"lines": ["        digest_count_before = NotificationDigest.find().count()"]}, {"lines": ["        digest_count = NotificationDigest.find().count()"]}, {"lines": ["        d = factories.NotificationDigestFactory("]}, {"lines": ["        d2 = factories.NotificationDigestFactory("]}, {"lines": ["        d = factories.NotificationDigestFactory("]}, {"lines": ["        d = factories.NotificationDigestFactory("]}, {"lines": ["            NotificationDigest.find_one(Q('_id', 'eq', digest_id))"]}, {"lines": ["        post_data = {'name': 'fullname', 'value': 'new<b> name</b>     '}"]}, {"lines": ["    def test_unserialize_names(self):"]}, {"lines": ["        fake_fullname_w_spaces = '    {}    '.format(fake.name())"]}, {"lines": ["        names = {", "            'full': fake_fullname_w_spaces,", "            'given': 'Tea',", "            'middle': 'Gray',", "            'family': 'Pot',", "            'suffix': 'Ms.',", "        }", "        url = api_url_for('unserialize_names')", "        res = self.app.put_json(url, names, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.user.reload()", "        # user is updated", "        assert_equal(self.user.fullname, fake_fullname_w_spaces.strip())", "        assert_equal(self.user.given_name, names['given'])", "        assert_equal(self.user.middle_names, names['middle'])", "        assert_equal(self.user.family_name, names['family'])", "        assert_equal(self.user.suffix, names['suffix'])", ""]}, {"lines": ["class TestUserAccount(OsfTestCase):", "", "    def setUp(self):", "        super(TestUserAccount, self).setUp()", "        self.user = AuthUserFactory()", "        self.user.set_password('password')", "        self.user.save()", "", "    @mock.patch('website.profile.views.push_status_message')", "    def test_password_change_valid(self, mock_push_status_message):", "        old_password = 'password'", "        new_password = 'Pa$$w0rd'", "        confirm_password = new_password", "        url = web_url_for('user_account_password')", "        post_data = {", "            'old_password': old_password,", "            'new_password': new_password,", "            'confirm_password': confirm_password,", "        }", "        res = self.app.post(url, post_data, auth=self.user.auth)", "        assert_true(302, res.status_code)", "        res = res.follow(auth=self.user.auth)", "        assert_true(200, res.status_code)", "        self.user.reload()", "        assert_true(self.user.check_password(new_password))", "        assert_true(mock_push_status_message.called)", "        assert_in('Password updated successfully', mock_push_status_message.mock_calls[0][1][0])", "", "    @mock.patch('website.profile.views.push_status_message')", "    def test_password_change_invalid(self, mock_push_status_message, old_password='', new_password='',", "                                     confirm_password='', error_message='Old password is invalid'):", "        url = web_url_for('user_account_password')", "        post_data = {", "            'old_password': old_password,", "            'new_password': new_password,", "            'confirm_password': confirm_password,", "        }", "        res = self.app.post(url, post_data, auth=self.user.auth)", "        assert_true(302, res.status_code)", "        res = res.follow(auth=self.user.auth)", "        assert_true(200, res.status_code)", "        self.user.reload()", "        assert_false(self.user.check_password(new_password))", "        assert_true(mock_push_status_message.called)", "        assert_in(error_message, mock_push_status_message.mock_calls[0][1][0])", "", "    def test_password_change_invalid_old_password(self):", "        self.test_password_change_invalid(", "            old_password='invalid old password',", "            new_password='new password',", "            confirm_password='new password',", "            error_message='Old password is invalid',", "        )", "", "    def test_password_change_invalid_confirm_password(self):", "        self.test_password_change_invalid(", "            old_password='password',", "            new_password='new password',", "            confirm_password='invalid confirm password',", "            error_message='Password does not match the confirmation',", "        )", "", "    def test_password_change_invalid_new_password_length(self):", "        self.test_password_change_invalid(", "            old_password='password',", "            new_password='12345',", "            confirm_password='12345',"]}, {"lines": ["            error_message='Password should be at least six characters',"]}, {"lines": ["        )", ""]}, {"lines": ["    def test_password_change_invalid_blank_password(self, old_password='', new_password='', confirm_password=''):", "        self.test_password_change_invalid(", "            old_password=old_password,", "            new_password=new_password,", "            confirm_password=confirm_password,", "            error_message='Passwords cannot be blank',", "        )", "", "    def test_password_change_invalid_blank_new_password(self):", "        for password in ('', '      '):", "            self.test_password_change_invalid_blank_password('password', password, 'new password')", "", "    def test_password_change_invalid_blank_confirm_password(self):", "        for password in ('', '      '):", "            self.test_password_change_invalid_blank_password('password', 'new password', password)", "", ""]}, {"lines": ["        assert_equal(res.request.path, web_url_for('auth_login'))"]}, {"lines": ["        res = self.app.get(web_url_for('forgot_password_get'))"]}, {"lines": ["        self.project2.update_node_wiki(name='home', content='', auth=Auth(self.project.creator))"]}, {"lines": ["import httplib as http"]}, {"lines": ["from flask import request"]}, {"lines": ["from framework.auth import cas"]}, {"lines": ["from framework.sessions import session"]}, {"lines": ["        'cookie_name': settings.COOKIE_NAME,"]}, {"lines": ["        'login_url': cas.get_login_url(request.url, auto=True),"]}, {"lines": ["        'access_token': session.data.get('auth_user_access_token') or '',"]}, {"lines": ["        Rule('/forgotpassword/', 'get', auth_views.forgot_password_get,"]}, {"lines": ["        Rule('/forgotpassword/', 'post', auth_views.forgot_password_post,"]}, {"lines": ["            '/settings/account/',", "            'get',", "            profile_views.user_account,", "            OsfWebRenderer('profile/account.mako'),", "        ),", "", "        Rule(", "            '/settings/account/password',", "            'post',", "            profile_views.user_account_password,", "            OsfWebRenderer('profile/account.mako'),", "        ),", "", "        Rule("]}, {"lines": ["            '/project/<pid>/get_most_in_common_contributors/',", "            '/project/<pid>/node/<nid>/get_most_in_common_contributors/',", "        ], 'get', project_views.contributor.get_most_in_common_contributors, json_renderer),", "", "        Rule(["]}, {"lines": ["from framework.sessions import session"]}, {"lines": ["        if session and 'auth_user_access_token' in session.data:"]}, {"lines": ["            url.args.add('token', session.data.get('auth_user_access_token'))", ""]}, {"lines": ["        url.args['url'] = self.mfr_public_download_url"]}, {"lines": ["    def mfr_public_download_url(self):"]}, {"lines": ["        url = furl.furl(settings.DOMAIN)"]}, {"lines": ["        url.args['accept_url'] = 'false'"]}, {"lines": ["    # TODO: why save?, should_raise or an exception try/except?"]}, {"lines": ["from framework.sessions import session"]}, {"lines": ["    cookie = request.args.get('cookie')"]}, {"lines": ["    view_only = request.args.get('view_only')"]}, {"lines": ["        user = User.load(session.data['auth_user_id'])", "    elif cookie:", "        user = User.from_cookie(cookie)"]}, {"lines": ["        guid_url.args.update(extras)", "        return redirect(guid_url)"]}, {"lines": ["        return redirect(download_url.url)"]}, {"lines": ["            'mfr': settings.MFR_SERVER_URL,"]}, {"lines": ["        # fetching the access token will guarantee a refresh", "        settings_obj.fetch_access_token()"]}, {"lines": [""]}, {"lines": ["            '/oauth/connect/box/',"]}, {"lines": ["            '/oauth/callback/box/',"]}, {"lines": ["            '/oauth/accounts/box/',"]}, {"lines": ["    ],", "}", "", "", "api_routes = {", "    'rules': [", "", "        ##### OAuth #####"]}, {"lines": ["        # avoid nginx rewrite (lack of 307 support)"]}, {"lines": ["                '/project/<pid>/oauth/connect/box/',", "                '/project/<pid>/node/<nid>/oauth/connect/box/',"]}, {"lines": ["        #### Profile settings ###", "", "        Rule(", "            '/settings/box/',", "            'get',", "            views.auth.box_user_config_get,", "            json_renderer,", "        ),", ""]}, {"lines": ["from website.util import permissions"]}, {"lines": [""]}, {"lines": ["        'path': metadata['path'],"]}, {"lines": ["        'path': '',"]}, {"lines": ["    folders = [root] + [", "        serialize_folder(each)", "        for each in metadata['contents'] if each['is_dir']", "    ]"]}, {"lines": ["        except BoxClientException:", "            valid_credentials = False"]}, {"lines": ["        result['urls']['owner'] = web_url_for(", "            'profile_view_id',"]}, {"lines": ["        )"]}, {"lines": ["        elif valid_credentials:", "            path = node_settings.fetch_full_folder_path()"]}, {"lines": ["                'path': path,"]}, {"lines": ["            'urls': serialize_urls(node_addon),"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                if contrib != auth.user"]}, {"lines": ["    except BoxClientException:"]}, {"lines": ["        assert_in('&force_reapprove=true', res.location)"]}, {"lines": ["    # Force the user to reapprove the dropbox authorization each time. Currently the", "    # URI component force_reapprove is not configurable from the dropbox python client.", "    # Issue: https://github.com/dropbox/dropbox-js/issues/160", "    return redirect(get_auth_flow().start() + '&force_reapprove=true')"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["    return waterbutler.buildTreeBeardUpload(item, file, {branch: item.data.branch});"]}, {"lines": ["            type : 'DELETE',", "            beforeSend: $osf.setXHRAuthorization"]}, {"lines": ["    item.data.branch = ref;"]}, {"lines": ["    return waterbutler.buildTreeBeardMetadata(item, {ref: item.data.branch});", "}", ""]}, {"lines": ["    tree.children.forEach(function(item) {", "        Fangorn.Utils.inheritFromParent(item, tree, ['branch']);", "    });"]}, {"lines": ["function _fangornUploadSuccess(file, item, response) {", "    if (response) {", "        response.branch = item.parent().data.branch;", "    }", "}", ""]}, {"lines": ["    onUploadComplete: _fangornUploadComplete,", "    lazyLoadOnLoad: _fangornLazyLoadOnLoad,"]}, {"lines": [""]}, {"lines": ["from requests_oauthlib import OAuth2Session"]}, {"lines": [""]}, {"lines": ["", "from website.util import api_url_for"]}, {"lines": ["from website.addons.googledrive import settings"]}, {"lines": ["", ""]}, {"lines": ["class GoogleAuthClient(BaseClient):", ""]}, {"lines": ["    def start(self):", "        client = OAuth2Session(", "            settings.CLIENT_ID,", "            redirect_uri=api_url_for('googledrive_oauth_finish', _absolute=True),", "            scope=settings.OAUTH_SCOPE", "        )", "        return client.authorization_url("]}, {"lines": ["            self._build_url(settings.OAUTH_BASE_URL, 'auth'),"]}, {"lines": ["            access_type='offline',", "            approval_prompt='force'", "        )", "", "    def finish(self, code):", "        client = OAuth2Session(", "            settings.CLIENT_ID,", "            redirect_uri=api_url_for('googledrive_oauth_finish', _absolute=True),", "        )", "        return client.fetch_token("]}, {"lines": ["            self._build_url(settings.API_BASE_URL, 'oauth2', 'v3', 'token'),"]}, {"lines": ["            client_secret=settings.CLIENT_SECRET,", "            code=code", "        )", ""]}, {"lines": ["    def refresh(self, access_token, refresh_token):"]}, {"lines": ["        client = OAuth2Session(", "            settings.CLIENT_ID,"]}, {"lines": ["            token={", "                'access_token': access_token,", "                'refresh_token': refresh_token,", "                'token_type': 'Bearer',", "                'expires_in': '-30',", "            }"]}, {"lines": ["        )"]}, {"lines": ["        extra = {", "            'client_id': settings.CLIENT_ID,", "            'client_secret': settings.CLIENT_SECRET,", "        }"]}, {"lines": ["                self._build_url(settings.API_BASE_URL, 'oauth2', 'v3', 'token'),", "                # ('love')"]}, {"lines": [""]}, {"lines": ["    def userinfo(self, access_token):"]}, {"lines": ["        return self._make_request(", "            'GET',", "            self._build_url(settings.API_BASE_URL, 'oauth2', 'v3', 'userinfo'),"]}, {"lines": ["            params={'access_token': access_token},"]}, {"lines": ["            expects=(200, ),", "            throws=HTTPError(401)", "        ).json()", ""]}, {"lines": ["    def revoke(self, token):", "        return self._make_request(", "            'GET',"]}, {"lines": ["            self._build_url(settings.OAUTH_BASE_URL, 'revoke'),", "            params={'token': token},"]}, {"lines": ["            expects=(200, 400, ),"]}, {"lines": ["            throws=HTTPError(401)"]}, {"lines": ["        )", "", "", "class GoogleDriveClient(BaseClient):", ""]}, {"lines": ["    def __init__(self, access_token=None):", "        self.access_token = access_token"]}, {"lines": ["", "    @property"]}, {"lines": ["        if self.access_token:", "            return {'authorization': 'Bearer {}'.format(self.access_token)}"]}, {"lines": ["        return {}", "", "    def about(self):", "        return self._make_request(", "            'GET',"]}, {"lines": ["            self._build_url(settings.API_BASE_URL, 'drive', 'v2', 'about', ),"]}, {"lines": ["            expects=(200, ),"]}, {"lines": ["            throws=HTTPError(401)"]}, {"lines": ["        ).json()", "", "    def folders(self, folder_id='root'):", "        query = ' and '.join([", "            \"'{0}' in parents\".format(folder_id),", "            'trashed = false',", "            \"mimeType = 'application/vnd.google-apps.folder'\",", "        ])", "        res = self._make_request(", "            'GET',"]}, {"lines": ["            self._build_url(settings.API_BASE_URL, 'drive', 'v2', 'files', ),", "            params={'q': query},"]}, {"lines": ["            expects=(200, ),"]}, {"lines": ["            throws=HTTPError(401)"]}, {"lines": ["        )", "        return res.json()['items']"]}, {"lines": ["\"\"\"Persistence layer for the google drive addon."]}, {"lines": ["from framework.mongo import StoredObject"]}, {"lines": ["from website.addons.googledrive.client import GoogleAuthClient"]}, {"lines": ["class GoogleDriveGuidFile(GuidFile):"]}, {"lines": ["        return 'googledrive'"]}, {"lines": ["class GoogleDriveOAuthSettings(StoredObject):"]}, {"lines": ["    this model address the problem if we have two osf user link", "    to the same google drive user and their access token conflicts issue", "    \"\"\"", "", "    # google drive user id, for example, \"4974056\"", "    user_id = fields.StringField(primary=True, required=True)", "    # google drive user name this is the user's login"]}, {"lines": ["    access_token = fields.StringField()"]}, {"lines": ["    expires_at = fields.DateTimeField()"]}, {"lines": ["    def fetch_access_token(self):"]}, {"lines": ["        self.refresh_access_token()"]}, {"lines": ["        return self.access_token"]}, {"lines": ["    def refresh_access_token(self, force=False):"]}, {"lines": ["        if self._needs_refresh() or force:"]}, {"lines": ["            client = GoogleAuthClient()"]}, {"lines": ["            token = client.refresh(self.access_token, self.refresh_token)"]}, {"lines": [""]}, {"lines": ["            self.access_token = token['access_token']"]}, {"lines": ["            self.refresh_token = token['refresh_token']", "            self.expires_at = datetime.utcfromtimestamp(token['expires_at'])", "            self.save()", ""]}, {"lines": ["    def revoke_access_token(self):"]}, {"lines": ["        # if there is only one osf user linked to this google drive user oauth, revoke the token,", "        # otherwise, disconnect the osf user from the googledriveoauthsettings", "        if len(self.googledriveusersettings__accessed) <= 1:", "            client = GoogleAuthClient()", "            try:"]}, {"lines": ["                client.revoke(self.access_token)"]}, {"lines": ["            except:", "                # no need to fail, revoke is opportunistic", "                pass", "", "            # remove the object as its the last instance.", "            GoogleDriveOAuthSettings.remove_one(self)", "", "    def _needs_refresh(self):", "        if self.expires_at is None:", "            return False"]}, {"lines": ["        return (self.expires_at - datetime.utcnow()).total_seconds() < drive_settings.REFRESH_TIME"]}, {"lines": [""]}, {"lines": ["", "class GoogleDriveUserSettings(AddonUserSettingsBase):", "    \"\"\"Stores user-specific information, including the Oauth access", "    token.", "    \"\"\"", "    oauth_settings = fields.ForeignField(", "        'googledriveoauthsettings', backref='accessed'", "    )"]}, {"lines": ["    def user_id(self):", "        if self.oauth_settings:", "            return self.oauth_settings.user_id", "        return None", "", "    @user_id.setter", "    def user_id(self, val):", "        self.oauth_settings.user_id = val", "", "    @property", "    def username(self):", "        if self.oauth_settings:", "            return self.oauth_settings.username", "        return None", "", "    @username.setter", "    def username(self, val):", "        self.oauth_settings.username = val", "", "    @property", "    def access_token(self):", "        if self.oauth_settings:", "            return self.oauth_settings.access_token", "        return None", "", "    @access_token.setter", "    def access_token(self, val):", "        self.oauth_settings.access_token = val", "", "    @property", "    def refresh_token(self):", "        if self.oauth_settings:", "            return self.oauth_settings.refresh_token", "        return None", "", "    @refresh_token.setter", "    def refresh_token(self, val):", "        self.oauth_settings.refresh_token = val", "", "    @property", "    def expires_at(self):", "        if self.oauth_settings:", "            return self.oauth_settings.expires_at", "        return None", "", "    @expires_at.setter", "    def expires_at(self, val):", "        self.oauth_settings.expires_at = val"]}, {"lines": ["        if self.oauth_settings:", "            return self.oauth_settings.access_token is not None", "        return False", ""]}, {"lines": ["    def fetch_access_token(self):", "        if self.oauth_settings:", "            return self.oauth_settings.fetch_access_token()", "        return None"]}, {"lines": ["    def clear(self):"]}, {"lines": ["        if self.oauth_settings:", "            self.oauth_settings.revoke_access_token()", "            self.oauth_settings = None", "            self.save()"]}, {"lines": [""]}, {"lines": ["        for node_settings in self.googledrivenodesettings__authorized:"]}, {"lines": ["    def save(self, *args, **kwargs):", "        if self.oauth_settings:", "            self.oauth_settings.save()", "        return super(GoogleDriveUserSettings, self).save(*args, **kwargs)", ""]}, {"lines": ["        super(GoogleDriveUserSettings, self).delete(save)"]}, {"lines": ["        return u'<GoogleDriveUserSettings(user={self.owner.username!r})>'.format(self=self)"]}, {"lines": ["        'googledriveusersettings', backref='authorized'"]}, {"lines": ["        \"\"\"Import a user's GoogleDrive authentication and create a NodeLog."]}, {"lines": ["        :param GoogleDriveUserSettings user_settings: The user settings to link."]}, {"lines": ["        return {'token': self.user_settings.fetch_access_token()}"]}, {"lines": ["        url = self.owner.web_url_for('addon_view_or_download_file', path=metadata['path'], provider='googledrive')"]}, {"lines": ["            'googledrive_{0}'.format(action),"]}, {"lines": ["        who authorized the GoogleDrive addon"]}, {"lines": ["                    'Removing this user will also remove write access to Google Drive '"]}, {"lines": ["        clone, _ = super(GoogleDriveNodeSettings, self).after_fork("]}, {"lines": ["        \"\"\"If the removed contributor was the user who authorized the GoogleDrive"]}, {"lines": ["        file_obj = GoogleDriveGuidFile(path='foo/bar.txt')"]}, {"lines": ["    :param GoogleDriveGuidFile file_obj: File object for file-related logs."]}, {"lines": ["        relevant parameters and prefixing log events with `\"googledrive_\"`."]}, {"lines": ["        # Prefix the action with googledrive"]}, {"lines": ["            action=\"googledrive_{0}\".format(action),"]}, {"lines": ["        'create': node.api_url_for('googledrive_oauth_start'),"]}, {"lines": ["        'deauthorize': node.api_url_for('googledrive_deauthorize'),"]}, {"lines": ["    View helper that returns a dictionary representation of a GoogleDriveNodeSettings record.", "    Provides the return value for the googledrive config endpoints."]}, {"lines": ["    current_user_settings = current_user.get_addon('googledrive')"]}, {"lines": ["def build_googledrive_urls(item, node, path):"]}, {"lines": ["        'fetch': node.api_url_for('googledrive_folders', folderId=item['id']),"]}, {"lines": ["CLIENT_ID = 'chaneme'"]}, {"lines": ["OAUTH_SCOPE = [", "    'https://www.googleapis.com/auth/userinfo.profile',", "    'https://www.googleapis.com/auth/drive',", "]"]}, {"lines": ["OAUTH_BASE_URL = 'https://accounts.google.com/o/oauth2/'"]}, {"lines": ["API_BASE_URL = 'https://www.googleapis.com/'"]}, {"lines": ["function _fangornLazyLoadError(item) {"]}, {"lines": ["Fangorn.config.googledrive = {"]}, {"lines": ["<div id=\"googleDriveAddonScope\" class=\"addon-settings scripted\">"]}, {"lines": ["import time"]}, {"lines": ["from website.addons.googledrive.client import GoogleAuthClient"]}, {"lines": ["from website.addons.googledrive.model import ("]}, {"lines": ["    GoogleDriveUserSettings,", "    GoogleDriveNodeSettings,", "    GoogleDriveOAuthSettings,", "    GoogleDriveGuidFile,"]}, {"lines": ["from website.addons.googledrive.tests.factories import ("]}, {"lines": ["    GoogleDriveNodeSettingsFactory,", "    GoogleDriveUserSettingsFactory,", "    GoogleDriveOAuthSettingsFactory,"]}, {"lines": ["class TestGoogleDriveUserSettingsModel(OsfTestCase):"]}, {"lines": ["        super(TestGoogleDriveUserSettingsModel, self).setUp()"]}, {"lines": ["        user_settings = GoogleDriveUserSettingsFactory()"]}, {"lines": ["        retrieved = GoogleDriveUserSettings.load(user_settings._primary_key)"]}, {"lines": ["        assert_true(retrieved.expires_at)"]}, {"lines": ["    def test_has_auth(self):", "        user_settings = GoogleDriveUserSettingsFactory(access_token=None)", "        assert_false(user_settings.has_auth)", "        user_settings.access_token = '12345'", "        user_settings.save()", "        assert_true(user_settings.has_auth)", ""]}, {"lines": ["    @mock.patch.object(GoogleDriveOAuthSettings, '_needs_refresh')"]}, {"lines": ["    def test_access_token_checks(self, mock_needs_refresh):", "        mock_needs_refresh.return_value = False", "        user_settings = GoogleDriveUserSettingsFactory()"]}, {"lines": ["        mock_needs_refresh.assert_called_once()"]}, {"lines": ["    @mock.patch.object(GoogleAuthClient, 'refresh')"]}, {"lines": ["    @mock.patch.object(GoogleDriveOAuthSettings, '_needs_refresh')"]}, {"lines": ["    def test_access_token_refreshes(self, mock_needs_refresh, mock_refresh):", "        mock_refresh.return_value = {", "            'access_token': 'abc',", "            'refresh_token': '123',", "            'expires_at': time.time(),", "        }", "        user_settings = GoogleDriveUserSettingsFactory()", "        user_settings.expires_at = datetime.now()", "        user_settings.access_token"]}, {"lines": ["        mock_refresh.assert_called_once()"]}, {"lines": ["", "    @mock.patch.object(GoogleAuthClient, 'refresh')"]}, {"lines": ["        mock_refresh.return_value = {", "            'access_token': 'abc',", "            'refresh_token': '123',", "            'expires_at': time.time(),", "        }", "        user_settings = GoogleDriveUserSettingsFactory()", "        user_settings.expires_at = (datetime.utcnow() + relativedelta.relativedelta(seconds=5))"]}, {"lines": ["        mock_refresh.assert_called_once()"]}, {"lines": ["    @mock.patch.object(GoogleAuthClient, 'refresh')"]}, {"lines": ["        mock_refresh.return_value = {", "            'access_token': 'abc',", "            'refresh_token': '123',", "            'expires_at': time.time(),", "        }", "        user_settings = GoogleDriveUserSettingsFactory()", "        user_settings.expires_at = datetime.utcnow() + relativedelta.relativedelta(minutes=4)"]}, {"lines": ["        mock_refresh.assert_called_once()"]}, {"lines": ["    @mock.patch.object(GoogleAuthClient, 'refresh')", "    def test_access_token_doesnt_refresh(self, mock_refresh):", "        user_settings = GoogleDriveUserSettingsFactory()", "        user_settings.save()", "        user_settings.access_token", "        assert_false(mock_refresh.called)", "", "    def test_clear_clears_associated_node_settings(self):", "        node_settings = GoogleDriveNodeSettingsFactory.build()", "        user_settings = GoogleDriveUserSettingsFactory()", "        node_settings.user_settings = user_settings", "        node_settings.save()", "        user_settings.clear()", "        user_settings.save()", "", "        # Node settings no longer associated with user settings", "        assert_is(node_settings.folder_id, None)", "        assert_is(node_settings.user_settings, None)", "", "    def test_clear(self):", "        node_settings = GoogleDriveNodeSettingsFactory.build()", "        user_settings = GoogleDriveUserSettingsFactory(access_token='abcde')", "        node_settings.user_settings = user_settings", "        node_settings.save()", "", "        assert_true(user_settings.access_token)", "        user_settings.clear()", "        user_settings.save()", "        assert_false(user_settings.access_token)", ""]}, {"lines": ["    @mock.patch.object(GoogleDriveOAuthSettings, 'revoke_access_token')", "    def test_clear_wo_oauth_settings(self, mock_revoke_access_token):", "        user_settings = GoogleDriveUserSettingsFactory(access_token='abcde')", "        user_settings.oauth_settings = None", "        user_settings.save()", "        node_settings = GoogleDriveNodeSettingsFactory.build()", "        node_settings.user_settings = user_settings", "        node_settings.save()", "", "        assert_false(user_settings.oauth_settings)", "        user_settings.clear()", "        user_settings.save()", "", "        assert_false(mock_revoke_access_token.called)", ""]}, {"lines": ["    def test_delete(self):", "        user_settings = GoogleDriveUserSettingsFactory()", "        assert_true(user_settings.has_auth)", "        user_settings.delete()", "        user_settings.save()", "        assert_false(user_settings.access_token)", "        assert_true(user_settings.deleted)", "", "    def test_delete_clears_associated_node_settings(self):", "        node_settings = GoogleDriveNodeSettingsFactory.build()", "        user_settings = GoogleDriveUserSettingsFactory()", "        node_settings.user_settings = user_settings", "        node_settings.save()", "", "        user_settings.delete()", "        user_settings.save()", "", "        # Node settings no longer associated with user settings", "        assert_false(node_settings.deleted)", "        assert_is(node_settings.folder_id, None)", "        assert_is(node_settings.user_settings, None)"]}, {"lines": ["class TestGoogleDriveNodeSettingsModel(OsfTestCase):"]}, {"lines": ["        super(TestGoogleDriveNodeSettingsModel, self).setUp()"]}, {"lines": ["        self.user.add_addon('googledrive')"]}, {"lines": ["        self.user_settings = self.user.get_addon('googledrive')"]}, {"lines": ["        oauth_settings = GoogleDriveOAuthSettingsFactory()", "        oauth_settings.save()", "        self.user_settings.oauth_settings = oauth_settings", "        self.user_settings.save()"]}, {"lines": ["        self.node_settings = GoogleDriveNodeSettingsFactory("]}, {"lines": ["        node_settings = GoogleDriveNodeSettings(user_settings=self.user_settings)"]}, {"lines": ["        node_settings = GoogleDriveNodeSettings(user_settings=self.user_settings)"]}, {"lines": ["        settings = GoogleDriveNodeSettings(user_settings=self.user_settings)"]}, {"lines": ["        settings.user_settings.access_token = None"]}, {"lines": ["    # TODO use this test if delete function is used in googledrive/model"]}, {"lines": ["        assert_equal(last_log.action, 'googledrive_folder_selected')"]}, {"lines": ["        node_settings = GoogleDriveNodeSettingsFactory()", "        user_settings = GoogleDriveUserSettingsFactory()"]}, {"lines": ["            'googledrive_{0}'.format(action),"]}, {"lines": ["        self.user_settings = GoogleDriveUserSettingsFactory(access_token='123abc', username='name/email')", "        self.node_settings = GoogleDriveNodeSettingsFactory("]}, {"lines": ["    def test_after_fork_by_authorized_googledrive_user(self):"]}, {"lines": ["    def test_after_fork_by_unauthorized_googledrive_user(self):"]}, {"lines": ["import httplib as http"]}, {"lines": ["from datetime import datetime"]}, {"lines": ["from flask import request"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website import models"]}, {"lines": ["from website.addons.googledrive.client import GoogleAuthClient"]}, {"lines": ["from website.addons.googledrive.model import GoogleDriveOAuthSettings"]}, {"lines": ["def googledrive_oauth_start(auth, **kwargs):"]}, {"lines": ["    user = auth.user"]}, {"lines": ["    node = models.Node.load(nid) if nid else None", "    node_addon = user.get_addon('googledrive')"]}, {"lines": ["    # Fail if node provided and user not contributor", "    if node and not node.is_contributor(user):", "        raise HTTPError(http.FORBIDDEN)"]}, {"lines": [""]}, {"lines": ["    client = GoogleAuthClient()", "    authorization_url, state = client.start()", "", "    session.data['googledrive_auth_state'] = state", "    if nid:", "        session.data['googledrive_auth_nid'] = nid", ""]}, {"lines": [""]}, {"lines": ["def googledrive_oauth_finish(auth, **kwargs):", "    \"\"\"View called when the Oauth flow is completed. Adds a new GoogleDriveUserSettings"]}, {"lines": ["    node = Node.load(session.data.pop('googledrive_auth_nid', None))"]}, {"lines": [""]}, {"lines": ["    user.add_addon('googledrive')"]}, {"lines": ["    user_settings = user.get_addon('googledrive')"]}, {"lines": [""]}, {"lines": ["    state = session.data.pop('googledrive_auth_state')"]}, {"lines": ["    if state != request.args.get('state'):", "        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["    auth_client = GoogleAuthClient()"]}, {"lines": ["    token = auth_client.finish(code)"]}, {"lines": ["    info = auth_client.userinfo(token['access_token'])", "", "    # Attempt to attach an existing oauth settings model", "    oauth_settings = GoogleDriveOAuthSettings.load(info['sub'])", "    # Create a new oauth settings model", "    if not oauth_settings:", "        oauth_settings = GoogleDriveOAuthSettings()", "        oauth_settings.user_id = info['sub']", "        oauth_settings.save()", "    user_settings.oauth_settings = oauth_settings", "", "    user_settings.username = info['name']"]}, {"lines": ["    user_settings.access_token = token['access_token']", "    user_settings.refresh_token = token['refresh_token']"]}, {"lines": ["    user_settings.expires_at = datetime.utcfromtimestamp(token['expires_at'])"]}, {"lines": [""]}, {"lines": ["    if node:"]}, {"lines": ["        if node.has_addon('googledrive'):", "            node_addon = node.get_addon('googledrive')"]}, {"lines": ["            node_addon.set_user_auth(user_settings)", "            node_addon.save()", "        return redirect(node.web_url_for('node_setting'))"]}, {"lines": ["@must_have_addon('googledrive', 'user')"]}, {"lines": ["@must_have_addon('googledrive', 'node')", "def googledrive_deauthorize(auth, node_addon, **kwargs):"]}, {"lines": ["@must_have_addon('googledrive', 'node')", "def googledrive_import_user_auth(auth, node_addon, **kwargs):", "    \"\"\"Import googledrive credentials from the currently logged-in user to a node."]}, {"lines": ["    user_addon = user.get_addon('googledrive')"]}, {"lines": ["    }"]}, {"lines": ["from framework.exceptions import HTTPError", ""]}, {"lines": ["from website.addons.googledrive import exceptions"]}, {"lines": ["from website.addons.googledrive.client import GoogleDriveClient"]}, {"lines": ["@must_have_addon('googledrive', 'user')", "@must_have_addon('googledrive', 'node')", "@must_be_addon_authorizer('googledrive')"]}, {"lines": ["    folder_id = request.args.get('folderId', 'root')", ""]}, {"lines": ["    try:", "        access_token = user_addon.fetch_access_token()", "    except exceptions.ExpiredAuthError:", "        raise HTTPError(403)", "", "    client = GoogleDriveClient(access_token)"]}, {"lines": ["        about = client.about()"]}, {"lines": ["def googledrive_addon_folder(node_settings, auth, **kwargs):"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from modularodm.exceptions import ValidationValueError", "from website.addons.base.exceptions import AddonError", "", "class WikiError(AddonError):", "    \"\"\"Base exception class for Wiki-related error.\"\"\"", "    pass", "", "class NameEmptyError(WikiError, ValidationValueError):", "    \"\"\"Raised if user tries to provide an empty name value.\"\"\"", "    pass", ""]}, {"lines": ["class NameInvalidError(WikiError, ValidationValueError):", "    \"\"\"Raised if user tries to provide a string containing an invalid character.\"\"\"", "    pass", ""]}, {"lines": ["class NameMaximumLengthError(WikiError, ValidationValueError):", "    \"\"\"Raised if user tries to provide a name which exceeds the maximum accepted length.\"\"\"", "    pass", "", "class PageCannotRenameError(WikiError):", "    \"\"\"Raised if user tried to rename special wiki pages, e.g. home.\"\"\"", "    pass", ""]}, {"lines": ["class PageConflictError(WikiError):", "    \"\"\"Raised if user tries to use an existing wiki page name.\"\"\"", "    pass"]}, {"lines": ["", "class PageNotFoundError(WikiError):", "    \"\"\"Raised if user tries to access a wiki page that does not exist.\"\"\""]}, {"lines": ["# NOTE: <wname> refers to a wiki page's key, e.g. 'Home'"]}, {"lines": ["        # Home (Base) | GET", "        Rule([", "            '/project/<pid>/wiki/',", "            '/project/<pid>/node/<nid>/wiki/',"]}, {"lines": [""]}, {"lines": ["        # View (Id) | GET", "        Rule([", "            '/project/<pid>/wiki/id/<wid>/',", "            '/project/<pid>/node/<nid>/wiki/id/<wid>/',"]}, {"lines": [""]}, {"lines": ["        Rule(["]}, {"lines": ["            '/project/<pid>/wiki/<wname>/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/',"]}, {"lines": ["        Rule(["]}, {"lines": ["            '/project/<pid>/wiki/<wname>/edit/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/edit/',"]}, {"lines": ["            '/project/<pid>/wiki/<wname>/compare/<int:wver>/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/compare/<int:wver>/',"]}, {"lines": [""]}, {"lines": ["        # Home (Base) : GET"]}, {"lines": ["            '/project/<pid>/wiki/<wname>/validate/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/validate/',"]}, {"lines": ["            '/project/<pid>/wiki/<wname>/edit/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/edit/',"]}, {"lines": ["        # Rename : PUT"]}, {"lines": ["            '/project/<pid>/wiki/<wname>/rename/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/rename/',"]}, {"lines": ["        # Delete : DELETE"]}, {"lines": ["            '/project/<pid>/wiki/<wname>/',", "            '/project/<pid>/node/<nid>/wiki/<wname>/',"]}, {"lines": [""]}, {"lines": ["from website.addons.wiki import settings as wiki_settings"]}, {"lines": ["    return client[wiki_settings.SHAREJS_DB_NAME]"]}, {"lines": ["        host=wiki_settings.SHAREJS_HOST,", "        port=wiki_settings.SHAREJS_PORT,"]}, {"lines": ["import logging", "from .defaults import *  # noqa", "", "", "logger = logging.getLogger(__name__)", "", "try:", "    from .local import *  # noqa", "except ImportError as error:", "    logger.warn('No local.py settings file found')"]}, {"lines": ["ace.define(\"ace/snippets/markdown\",[\"require\",\"exports\",\"module\"], function(require, exports, module) {", "\"use strict\";", ""]}, {"lines": ["exports.snippetText = \"# Markdown\\n\\", "\\n\\"]}, {"lines": ["snippet font-italic\\n\\"]}, {"lines": ["\t*${1:text}*\\n\\", "\\n\\", "snippet font-bold\\n\\", "\t**${1:text}**\\n\\", "\\n\\"]}, {"lines": ["snippet heading-1\\n\\"]}, {"lines": ["\t\\n\\"]}, {"lines": ["\t# ${1:title}\\n\\", "\\n\\", "snippet heading-2\\n\\"]}, {"lines": ["\t\\n\\"]}, {"lines": ["\t## ${1:title}\\n\\", "\\n\\", "snippet heading-3\\n\\"]}, {"lines": ["\t\\n\\"]}, {"lines": ["\t### ${1:title}\\n\\", "\\n\\", "snippet heading-4\\n\\"]}, {"lines": ["\t\\n\\"]}, {"lines": ["\t#### ${1:title}\\n\\", "\\n\\", "snippet horizontal-rule\\n\\", "\t\\n\\", "\t---\\n\\", "\t\\n\\", "\\n\\", "snippet blockquote\\n\\"]}, {"lines": ["\t\\n\\"]}, {"lines": ["\t> ${1:quote}\\n\\", "\\n\\", "snippet codeblock\\n\\"]}, {"lines": ["\t\\n\\"]}, {"lines": ["\t```\\n\\", "\t${1:snippet}\\n\\", "\t```\\n\\", "\\n\\", "snippet ![ (image)\\n\\", "snippet image\\n\\", "\t![${1:alttext}](${2:url} \\\"${3:title}\\\")\\n\\", "\\n\\", "snippet [ (hyperlink)\\n\\", "snippet hyperlink\\n\\", "\t[${1:linktext}](${2:url} \\\"${3:title}\\\")\\n\\", "\\n\\", "snippet numbered-list\\n\\"]}, {"lines": ["\t\\n\\"]}, {"lines": ["\t1. ${1:item}\\n\\", "\\n\\", "snippet bulleted-list\\n\\"]}, {"lines": ["\t\\n\\"]}, {"lines": ["\t* ${1:item}\\n\\", "\\n\\"]}, {"lines": ["\";", "exports.scope = \"markdown\";", "", "});"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["", "var WikiEditor = require('./WikiEditor.js');"]}, {"lines": ["var LanguageTools = ace.require('ace/ext/language_tools');"]}, {"lines": [""]}, {"lines": ["    var viewModel = wikiEditor.viewModel;"]}, {"lines": ["    var deleteModal = $('#deleteModal');", "    var renameModal = $('#renameModal');", "    var permissionsModal = $('#permissionsModal');"]}, {"lines": [""]}, {"lines": ["        enableBasicAutocompletion: [LanguageTools.snippetCompleter],"]}, {"lines": ["        enableSnippets: true,", "        enableLiveAutocompletion: true", "    });"]}, {"lines": ["        viewModel.fetchData().done(function(response) {"]}, {"lines": ["                viewModel.status('unsupported');"]}, {"lines": ["    // Requirements load order is specific in this case to compensate", "    // for older browsers.", "    var ReconnectingWebSocket = require('reconnectingWebsocket');"]}, {"lines": ["    require('addons/wiki/static/ace.js');", ""]}, {"lines": ["    var wsPrefix = (window.location.protocol === 'https:') ? 'wss://' : 'ws://';"]}, {"lines": ["        viewModel.fetchData().done(function(response) {"]}, {"lines": ["        switch (data.type) {", "            case 'meta':", "                // Convert users object into knockout array", "                activeUsers = [];", "                for (var user in data.users) {", "                    var userMeta = data.users[user];", "                    userMeta.id = user;", "                    activeUsers.push(userMeta);", "                }", "                viewModel.activeUsers(activeUsers);", "                break;", "            case 'lock':"]}, {"lines": ["                permissionsModal.modal({", "                    backdrop: 'static',", "                    keyboard: false", "                });"]}, {"lines": ["                break;", "            case 'unlock':"]}, {"lines": ["                break;", "            case 'redirect':"]}, {"lines": ["                renameModal.modal({", "                    backdrop: 'static',", "                    keyboard: false", "                });", "                setTimeout(function() {", "                    window.location.replace(data.redirect);", "                }, 3000);", "                break;", "            case 'delete':"]}, {"lines": ["                deleteModal.on('hide.bs.modal', function() {", "                    window.location.replace(data.redirect);", "                });", "                deleteModal.modal();", "                break;", "            default:", "                onmessage(message);", "                break;"]}, {"lines": [""]}, {"lines": ["<div class=\"modal fade\" id=\"newWiki\">"]}, {"lines": ["            <form class=\"form\">", "                <div class=\"modal-header\">", "                    <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>", "                    <h3 class=\"modal-title\">Add New Wiki Page</h3>", "                </div><!-- end modal-header -->", "                <div class=\"modal-body\">"]}, {"lines": ["                </div><!-- end modal-body -->", "                <div class=\"modal-footer\">", "                    <a id=\"close\" href=\"#\" class=\"btn btn-default\" data-dismiss=\"modal\">Close</a>", "                    <button id=\"add-wiki-submit\" type=\"submit\" class=\"btn btn-primary\">OK</button>", "                </div><!-- end modal-footer -->", "            </form>"]}, {"lines": ["    </div><!-- end modal-dialog -->", "</div><!-- end modal -->"]}, {"lines": ["<script type=\"text/javascript\">", "    $(function () {", "        var $newWikiForm = $('#newWiki form');"]}, {"lines": ["        $newWikiForm.on('submit', function (e) {", "            e.preventDefault();"]}, {"lines": ["            var $data = $newWikiForm.find('#data');", "            var $submitForm = $newWikiForm.find('#add-wiki-submit');", "            var $alert = $newWikiForm.find('#alert');"]}, {"lines": ["            $submitForm", "                .attr('disabled', 'disabled')", "                .text('Creating New Wiki page');"]}, {"lines": ["            if ($.trim($data.val()) === '') {", "                $alert.text('The new wiki page name cannot be empty');", "                $submitForm", "                    .removeAttr('disabled', 'disabled')", "                    .text('OK');", "            } else if ($data.val().length > 100) {", "                $alert.text('The new wiki page name cannot be more than 100 characters.');"]}, {"lines": ["                $submitForm", "                    .removeAttr('disabled', 'disabled')", "                    .text('OK');"]}, {"lines": ["            } else {"]}, {"lines": ["                // TODO: helper to eliminate slashes in the url."]}, {"lines": ["                var request = $.ajax({", "                    type: 'GET',", "                    cache: false,"]}, {"lines": ["                    url: '${urls['api']['base']}' + encodeURIComponent(wikiName) + '/validate/',"]}, {"lines": ["                    dataType: 'json'", "                });", "                request.done(function (response) {"]}, {"lines": ["                    window.location.href = '${urls['web']['base']}' + encodeURIComponent(wikiName) + '/edit/';"]}, {"lines": ["                });", "                request.fail(function (response, textStatus, error) {", "                    if (response.status === 409) {", "                        $alert.text('A wiki page with that name already exists.');", "                    } else {", "                        $alert.text('Could not validate wiki page. Please try again.');", "                        Raven.captureMessage('Error occurred while validating page', {"]}, {"lines": ["                            url: '${urls['api']['base']}' + encodeURIComponent(wikiName) + '/validate/',"]}, {"lines": ["                            textStatus: textStatus,", "                            error: error", "                        });", "                    }", "                    $submitForm", "                        .removeAttr('disabled', 'disabled')", "                        .text('OK');", "                });", "            }", "        });"]}, {"lines": ["        $newWikiForm.find('#close').on('click', function () {", "            var $data = $newWikiForm.find('#data');", "            var $alert = $newWikiForm.find('#alert');"]}, {"lines": ["            $alert.text('');", "            $data.val('');", "        });", "    });", "</script>"]}, {"lines": ["<%page expression_filter=\"h\"/>"]}, {"lines": ["<%inherit file=\"project/project_base.mako\"/>"]}, {"lines": ["<div class=\"modal fade\" id=\"permissionsModal\">"]}, {"lines": ["<div class=\"modal fade\" id=\"renameModal\">"]}, {"lines": ["<div class=\"modal fade\" id=\"deleteModal\" tabindex=\"-1\">"]}, {"lines": ["<div class=\"modal fade\" id=\"connectingModal\" tabindex=\"-1\">"]}, {"lines": ["        <h3 class=\"modal-title\">Connecting to the collaborative wiki</h3>"]}, {"lines": ["            This page is currently attempting to connect to the collaborative wiki. You may continue to make edits.", "            <strong>Changes will not be saved until you press the \"Save\" button.</strong>"]}, {"lines": ["<div class=\"modal fade\" id=\"disconnectedModal\" tabindex=\"-1\">"]}, {"lines": ["        <h3 class=\"modal-title\">Collaborative wiki is unavailable</h3>"]}, {"lines": ["            The collaborative wiki is currently unavailable. You may continue to make edits.", "            <strong>Changes will not be saved until you press the \"Save\" button.</strong>"]}, {"lines": ["<div class=\"modal fade\" id=\"unsupportedModal\" tabindex=\"-1\">"]}, {"lines": ["        <h3 class=\"modal-title\">Browser unsupported</h3>"]}, {"lines": ["            Your browser does not support collaborative editing. You may continue to make edits.", "            <strong>Changes will not be saved until you press the \"Save\" button.</strong>"]}, {"lines": ["        urls: {"]}, {"lines": ["            content: '${urls['api']['content']}',"]}, {"lines": ["            sharejs: '${sharejs_url}'", "        },"]}, {"lines": ["<script src=\"//${sharejs_url}/text.js\"></script>", "<script src=\"//${sharejs_url}/share.js\"></script>"]}, {"lines": ["<%page expression_filter=\"h\"/>", ""]}, {"lines": ["    </div>", "</nav>"]}, {"lines": ["<%page expression_filter=\"h\"/>", ""]}, {"lines": ["            % for page in pages_current:", "                %if page['name'] != 'home':"]}, {"lines": ["                        % for child_page in child['pages_current']:", "                            % if child_page['name'] != 'home':"]}, {"lines": ["                                    <a href=\"${child_page['url']}\">${child_page['name']}</a>"]}, {"lines": ["import httplib as http", ""]}, {"lines": ["import mock"]}, {"lines": ["import time"]}, {"lines": [""]}, {"lines": ["from website.addons.wiki import settings"]}, {"lines": ["from website.addons.wiki.views import _serialize_wiki_toc, _get_wiki_web_urls, _get_wiki_api_urls"]}, {"lines": ["from framework.mongo.utils import to_mongo_key"]}, {"lines": [""]}, {"lines": ["# forward slashes are not allowed, typically they would be replaced with spaces", "SPECIAL_CHARACTERS_ALL = u'`~!@#$%^*()-=_+ []{}\\|/?.df,;:''\"'", "SPECIAL_CHARACTERS_ALLOWED = u'`~!@#$%^*()-=_+ []{}\\|?.df,;:''\"'"]}, {"lines": [""]}, {"lines": ["        # TODO: explain how this tests a pointer"]}, {"lines": ["        serialized = _serialize_wiki_toc(project, auth=auth)"]}, {"lines": ["        serialized = _serialize_wiki_toc(project, auth=auth)"]}, {"lines": ["        serialized = _serialize_wiki_toc(project, auth)"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_edit_post', wname='home')"]}, {"lines": ["    def test_project_wiki_edit_post_with_new_wname_and_no_content(self):"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_edit_post', wname=page_name)"]}, {"lines": ["        assert_equal(res.status_code, 200)"]}, {"lines": ["    def test_project_wiki_edit_post_with_new_wname_and_content(self):"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_edit_post', wname=page_name)"]}, {"lines": ["        assert_equal(res.status_code, 200)"]}, {"lines": ["        # wname doesn't exist in the db, so it will be created", "        new_wname = u'\u00f8\u02c6\u2206\u00b4\u0192\u00f8\u00df\u00e5\u221a\u00df'", "        url = self.project.web_url_for('project_wiki_edit_post', wname=new_wname)"]}, {"lines": ["        wiki = self.project.get_wiki_page(new_wname)", "        assert_equal(wiki.page_name, new_wname)"]}, {"lines": ["    def test_project_wiki_edit_post_with_special_characters(self):"]}, {"lines": ["        new_wname = 'title: ' + SPECIAL_CHARACTERS_ALLOWED", "        new_wiki_content = 'content: ' + SPECIAL_CHARACTERS_ALL"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_edit_post', wname=new_wname)"]}, {"lines": ["        res = self.app.post(url, {'content': new_wiki_content}, auth=self.user.auth).follow()", "        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["        wiki = self.project.get_wiki_page(new_wname)", "        assert_equal(wiki.page_name, new_wname)"]}, {"lines": ["        assert_equal(wiki.content, new_wiki_content)", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["        # wname has a trailing space"]}, {"lines": ["        url = self.project.api_url_for('project_wiki_validate_name', wname='Capslock')"]}, {"lines": ["        url = self.project.api_url_for('project_wiki_validate_name', wname='CaPsLoCk')"]}, {"lines": ["        url = self.project.api_url_for('project_wiki_validate_name', wname='CaPsLoCk')"]}, {"lines": ["        url = self.project.api_url_for('project_wiki_validate_name', wname='CAPSLOCK')"]}, {"lines": ["        url = self.project.api_url_for('project_wiki_validate_name', wname='capslock')"]}, {"lines": ["    def test_project_dashboard_wiki_wname_get_shows_non_ascii_characters(self):"]}, {"lines": ["        assert_equals(res.status_code, 302)", "        # TODO: should this route exist? it redirects you to the web_url_for, not api_url_for."]}, {"lines": ["        # assert_in(page_url, res.location)"]}, {"lines": ["        assert_equals(res.status_code, 302)", "        assert_in(page_url, res.location)"]}, {"lines": ["    def test_wiki_id_url_get_returns_302_and_resolves(self):", "        name = 'page by id'", "        self.project.update_node_wiki(name, 'some content', Auth(self.project.creator))", "        page = self.project.get_wiki_page(name)"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_id_page', wid=page._primary_key, _guid=True)", "        res = self.app.get(url)", "        assert_equal(res.status_code, 302)", "        assert_in(page_url, res.location)", "        res = res.follow()", "        assert_equal(res.status_code, 200)", "        assert_in(page_url, res.request.url)", "", "    def test_wiki_id_url_get_returns_404(self):", "        url = self.project.web_url_for('project_wiki_id_page', wid='12345', _guid=True)", "        res = self.app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 404)", ""]}, {"lines": ["        self.wname = 'New page'", "        self.project.update_node_wiki(self.wname, 'some content', Auth(self.project.creator))"]}, {"lines": ["        urls = _get_wiki_web_urls(self.project, self.wname)"]}, {"lines": ["        urls = _get_wiki_api_urls(self.project, self.wname)"]}, {"lines": ["        assert_equal(urls['delete'], self.project.api_url_for('project_wiki_delete', wname=self.wname))", "        assert_equal(urls['rename'], self.project.api_url_for('project_wiki_rename', wname=self.wname))"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_project_wiki_delete(self, mock_shrejs):"]}, {"lines": ["        assert_in('elephants', self.project.wiki_pages_current)"]}, {"lines": ["            wname='elephants'"]}, {"lines": ["        assert_not_in('elephants', self.project.wiki_pages_current)"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_project_wiki_delete_w_valid_special_characters(self, mock_sharejs):"]}, {"lines": ["        # TODO: Need to understand why calling update_node_wiki with failure causes transaction rollback issue later", "        # with assert_raises(NameInvalidError):", "        #     self.project.update_node_wiki(SPECIAL_CHARACTERS_ALL, 'Hello Special Characters', self.consolidate_auth)", "        self.project.update_node_wiki(SPECIAL_CHARACTERS_ALLOWED, 'Hello Special Characters', self.consolidate_auth)", "        self.special_characters_wiki = self.project.get_wiki_page(SPECIAL_CHARACTERS_ALLOWED)", "        assert_in(to_mongo_key(SPECIAL_CHARACTERS_ALLOWED), self.project.wiki_pages_current)"]}, {"lines": ["        url = self.project.api_url_for(", "            'project_wiki_delete',"]}, {"lines": ["            wname=SPECIAL_CHARACTERS_ALLOWED"]}, {"lines": ["        )", "        self.app.delete(", "            url,", "            auth=self.auth", "        )", "        self.project.reload()"]}, {"lines": ["        assert_not_in(to_mongo_key(SPECIAL_CHARACTERS_ALLOWED), self.project.wiki_pages_current)"]}, {"lines": [""]}, {"lines": ["            wname=self.page_name,"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_rename_wiki_page_valid(self, mock_sharejs, new_name=u'away'):"]}, {"lines": ["            {'value': new_name},"]}, {"lines": ["        old_wiki = self.project.get_wiki_page(self.page_name)", "        assert_false(old_wiki)"]}, {"lines": ["        new_wiki = self.project.get_wiki_page(new_name)", "        assert_true(new_wiki)", "        assert_equal(new_wiki._primary_key, self.page._primary_key)", "        assert_equal(new_wiki.content, self.page.content)", "        assert_equal(new_wiki.version, self.page.version)"]}, {"lines": ["    def test_rename_wiki_page_invalid(self, new_name=u'invalid/name'):", "        res = self.app.put_json(", "            self.url,", "            {'value': new_name},", "            auth=self.auth,", "            expect_errors=True,", "        )", "        assert_equal(http.BAD_REQUEST, res.status_code)"]}, {"lines": ["        assert_equal(res.json['message_short'], 'Invalid name')", "        assert_equal(res.json['message_long'], 'Page name cannot contain forward slashes.')"]}, {"lines": ["        self.project.reload()", "        old_wiki = self.project.get_wiki_page(self.page_name)", "        assert_true(old_wiki)", ""]}, {"lines": ["        new_name = 'away'"]}, {"lines": ["            {'value': new_name},"]}, {"lines": ["            expect_errors=True,"]}, {"lines": ["    def test_rename_wiki_name_not_found(self):", "        url = self.project.api_url_for('project_wiki_rename', wname='not_found_page_name')", "        res = self.app.put_json(url, {'value': 'new name'},"]}, {"lines": ["    def test_rename_wiki_name_with_value_missing(self):"]}, {"lines": ["        res = self.app.put_json(self.url, {}, auth=self.auth, expect_errors=True)"]}, {"lines": ["        # attempt to rename 'page2' from setup to different case of 'away'."]}, {"lines": ["        old_name = 'away'", "        new_name = 'AwAy'", "        self.project.update_node_wiki(old_name, 'Hello world', self.consolidate_auth)"]}, {"lines": ["            {'value': new_name},"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_rename_wiki_page_same_name_different_casing(self, mock_sharejs):"]}, {"lines": ["        old_name = 'away'", "        new_name = 'AWAY'", "        self.project.update_node_wiki(old_name, 'Hello world', self.consolidate_auth)", "        url = self.project.api_url_for('project_wiki_rename', wname=old_name)"]}, {"lines": ["            url,"]}, {"lines": ["            {'value': new_name},"]}, {"lines": ["        url = self.project.api_url_for('project_wiki_rename', wname='home')", "        res = self.app.put_json(url, {'value': 'homelol'}, auth=self.auth, expect_errors=True)"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_can_rename_to_a_deleted_page(self, mock_sharejs):"]}, {"lines": ["        self.project.delete_node_wiki(self.page_name, self.consolidate_auth)"]}, {"lines": ["        url = self.project.api_url_for('project_wiki_rename', wname='page3')", "        res = self.app.put_json(url, {'value': self.page_name}, auth=self.auth)"]}, {"lines": ["    def test_rename_wiki_page_with_valid_html(self):"]}, {"lines": ["        # script is not an issue since data is sanitized via bleach or mako before display."]}, {"lines": ["        self.test_rename_wiki_page_valid(new_name=u'<html>hello<html>')", "", "    def test_rename_wiki_page_with_invalid_html(self):", "        # script is not an issue since data is sanitized via bleach or mako before display.", "        # with that said routes still do not accept forward slashes", "        self.test_rename_wiki_page_invalid(new_name=u'<html>hello</html>')"]}, {"lines": ["", "    def test_rename_wiki_page_with_non_ascii_title(self):", "        self.test_rename_wiki_page_valid(new_name=u'\u00f8\u02c6\u2206\u00b4\u0192\u00f8\u00df\u00e5\u221a\u00df')", ""]}, {"lines": ["    def test_rename_wiki_page_with_valid_special_character_title(self):", "        self.test_rename_wiki_page_valid(new_name=SPECIAL_CHARACTERS_ALLOWED)", "", "    def test_rename_wiki_page_with_invalid_special_character_title(self):", "        self.test_rename_wiki_page_invalid(new_name=SPECIAL_CHARACTERS_ALL)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_migration_does_not_affect_forks(self, mock_sharejs):"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_uuid_persists_after_delete(self, mock_sharejs):"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_uuid_persists_after_rename(self, mock_sharejs):"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_migrate_uuid(self, mock_sharejs):"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_migrate_uuid_no_mongo(self, mock_sharejs):"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_migrate_uuid_updates_node(self, mock_sharejs):"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_delete_share_doc(self, mock_sharejs):"]}, {"lines": ["    @mock.patch('website.addons.wiki.utils.broadcast_to_sharejs')", "    def test_delete_share_doc_updates_node(self, mock_sharejs):"]}, {"lines": ["    def test_get_draft(self):", "        # draft is current with latest wiki save", "        current_content = self.wiki_page.get_draft(self.project)", "        assert_equals(current_content, self.wiki_page.content)", "", "        # modify the sharejs wiki page contents and ensure we", "        # return the draft contents", "        new_content = 'I am a teapot'", "        new_time = int(time.time() * 1000) + 10000", "        new_version = self.example_docs[0]['_v'] + 1", "        self.db.docs.update(", "            {'_id': self.sharejs_uuid},", "            {'$set': {", "                '_v': new_version,", "                '_m.mtime': new_time,", "                '_data': new_content", "            }}", "        )", "        current_content = self.wiki_page.get_draft(self.project)", "        assert_equals(current_content, new_content)", ""]}, {"lines": ["            # Mailgun only inserts score headers for messages checked for spam.", "            sscore_header = float(self.form.get('X-Mailgun-Sscore', 0))"]}, {"lines": ["    name = '/' + (attachment.filename or settings.MISSING_FILE_NAME)"]}, {"lines": ["from website.notifications.model import NotificationDigest", "from website.notifications.model import NotificationSubscription"]}, {"lines": ["EMAIL_SUBJECT_MAP = {"]}, {"lines": ["}", "", ""]}, {"lines": ["    \"\"\""]}, {"lines": ["    :param uid: id of the event owner (Node or User)", "    :param event: name of notification event (e.g. 'comments')", "    :param context: context variables for email template"]}, {"lines": ["    :return:", "    \"\"\"", "    template = event + '.html.mako'"]}, {"lines": ["    subject = Template(EMAIL_SUBJECT_MAP[event]).render(**context)", ""]}, {"lines": ["        message = mails.render_message(template, **context)", ""]}, {"lines": ["            mails.send_mail(", "                to_addr=email,", "                mail=mails.TRANSACTIONAL,", "                mimetype='html',"]}, {"lines": ["                subject=subject,", "                message=message,"]}, {"lines": ["            )", "", ""]}, {"lines": ["    \"\"\" Render the email message from context vars and store in the", "        NotificationDigest objects created for each subscribed user.", "    \"\"\"", "    template = event + '.html.mako'"]}, {"lines": ["    node_lineage_ids = get_node_lineage(node) if node else []"]}, {"lines": [""]}, {"lines": ["        message = mails.render_message(template, **context)", ""]}, {"lines": ["            digest = NotificationDigest("]}, {"lines": ["                event=event,"]}, {"lines": ["                message=message,", "                node_lineage=node_lineage_ids", "            )", "            digest.save()", "", "", "EMAIL_FUNCTION_MAP = {", "    'email_transactional': email_transactional,", "    'email_digest': email_digest,", "}", ""]}, {"lines": ["    subscription = NotificationSubscription.load(utils.to_subscription_key(uid, event))"]}, {"lines": ["    if subscription:", "        for notification_type in constants.NOTIFICATION_TYPES:", "            subscribed_users = getattr(subscription, notification_type, [])"]}, {"lines": ["            node_subscribers.extend(subscribed_users)"]}, {"lines": ["            if subscribed_users and notification_type != 'none':"]}, {"lines": ["    if node and node.parent_id:", "        key = utils.to_subscription_key(node.parent_id, event)", "        subscription = NotificationSubscription.load(key)", "", "        if not subscription:"]}, {"lines": ["", "        for notification_type in constants.NOTIFICATION_TYPES:", "            subscribed_users = getattr(subscription, notification_type, [])", "", "            for u in subscribed_users:", "                if u not in node_subscribers and node.has_permission(u, 'read'):", "                    if notification_type != 'none':"]}, {"lines": ["                    node_subscribers.append(u)", ""]}, {"lines": ["        EMAIL_FUNCTION_MAP[notification_type]("]}, {"lines": ["            **context"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    model.NotificationSubscription.remove(Q('owner', 'eq', node))"]}, {"lines": ["    user_subscriptions = [s for s in model.NotificationSubscription.find(Q('owner', 'eq', user))]"]}, {"lines": ["                subscription = model.NotificationSubscription.find_one(Q('_id', 'eq', key))"]}, {"lines": ["        content_a = sanitize(seqm.a[a0:a1])", "        content_b = sanitize(seqm.b[b0:b1])"]}, {"lines": ["            output.append(content_a)"]}, {"lines": ["            output.append(insert_el + content_b + ins_el_close)"]}, {"lines": ["            output.append(del_el + content_a + del_el_close)"]}, {"lines": ["            output.append(del_el + content_a + del_el_close + insert_el + content_b + ins_el_close)"]}, {"lines": ["from collections import Counter"]}, {"lines": ["from framework.auth import cas"]}, {"lines": ["from framework.auth.core import generate_confirm_token"]}, {"lines": ["from website import security"]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["    node_contrib_ids = set(node.contributors._to_primary_keys())"]}, {"lines": ["    try:", "        n_contribs = int(request.args.get('max', None))", "    except (TypeError, ValueError):", "        n_contribs = settings.MAX_MOST_IN_COMMON_LENGTH"]}, {"lines": [""]}, {"lines": ["    contrib_counts = Counter(contrib_id", "        for node in auth.user.node__contributed", "        for contrib_id in node.contributors._to_primary_keys()", "        if contrib_id not in node_contrib_ids)"]}, {"lines": [""]}, {"lines": ["    contribs = ["]}, {"lines": ["    ]"]}, {"lines": ["    return {'contributors': contribs}", "", ""]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["            return {'redirectUrl': web_url_for('dashboard')}"]}, {"lines": ["    # roll the valid token for each email, thus user cannot change email and approve a different email address", "    timestamp = unclaimed_record.get('last_sent')", "    if not throttle_period_expired(timestamp, throttle):"]}, {"lines": ["    unclaimed_record['token'] = generate_confirm_token()"]}, {"lines": ["    unclaimed_record['claimer_email'] = claimer.username"]}, {"lines": ["    unreg_user.save()"]}, {"lines": ["    # Send mail to referrer, telling them to forward verification link to claimer", "    mails.send_mail(", "        referrer.username,", "        mails.FORWARD_INVITE_REGiSTERED,", "        user=unreg_user,", "        referrer=referrer,", "        node=node,", "        claim_url=claim_url,", "        fullname=unclaimed_record['name'],", "    )", "    unclaimed_record['last_sent'] = get_timestamp()", "    unreg_user.save()"]}, {"lines": ["    claimer_email = email.lower().strip()"]}, {"lines": ["    if unclaimed_record.get('email') == claimer_email:"]}, {"lines": ["        to_addr = claimer_email", "        unclaimed_record['claimer_email'] = claimer_email", "        user.save()"]}, {"lines": ["        # roll the valid token for each email, thus user cannot change email and approve a different email address", "        timestamp = unclaimed_record.get('last_sent')", "        if not throttle_period_expired(timestamp, throttle):"]}, {"lines": ["        unclaimed_record['last_sent'] = get_timestamp()", "        unclaimed_record['token'] = generate_confirm_token()"]}, {"lines": ["        unclaimed_record['claimer_email'] = claimer_email"]}, {"lines": ["        user.save()", "        claim_url = user.get_claim_url(node._primary_key, external=True)"]}, {"lines": ["                claimer_email,"]}, {"lines": ["        email=claimer_email,"]}, {"lines": ["    sign_out_url = web_url_for('auth_login', logout=True, next=request.url)"]}, {"lines": ["        return redirect(sign_out_url)"]}, {"lines": ["        logout_url = web_url_for('auth_logout', redirect_url=request.url)", "        data = {", "            'message_short': 'Already a contributor',"]}, {"lines": ["        }"]}, {"lines": ["        return redirect(web_url_for('auth_login'))"]}, {"lines": ["    # The email can be the original referrer email if no claimer email has been specified.", "    claimer_email = unclaimed_record.get('claimer_email') or unclaimed_record.get('email')"]}, {"lines": ["            username, password = claimer_email, form.password.data"]}, {"lines": ["            user.verification_key = security.random_string(20)"]}, {"lines": ["            status.push_status_message(language.CLAIMED_CONTRIBUTOR.format(node=node), 'success')", "            # Redirect to CAS and authenticate the user with a verification key."]}, {"lines": ["            return redirect(cas.get_login_url("]}, {"lines": ["                web_url_for('user_profile', _absolute=True),", "                auto=True,", "                username=user.username,", "                verification_key=user.verification_key", "            ))"]}, {"lines": ["        'email': claimer_email if claimer_email else '',"]}, {"lines": ["        if claimer and claimer.is_registered:"]}, {"lines": ["        ua = ua_count / rescale_ratio * 100"]}, {"lines": ["        non_ua = non_ua_count / rescale_ratio * 100"]}, {"lines": ["# May set these to True in local.py for development", "DEV_MODE = False", "DEBUG_MODE = False", ""]}, {"lines": ["    lambda url: url.startswith('/api/'),"]}, {"lines": ["", "# Add Contributors (most in common)", "MAX_MOST_IN_COMMON_LENGTH = 15"]}, {"lines": ["WATERBUTLER_URL = 'http://localhost:7777'"]}, {"lines": ["CAS_SERVER_URL = 'http://localhost:8080'"]}, {"lines": ["    var viewOnlyToken = $osf.urlParams().view_only;", "    return '/api/v1/user/' + uid + '/' + pid +  '/claim/email/' + (viewOnlyToken ? '?view_only=' + viewOnlyToken : '');"]}, {"lines": ["                error: $osf.handleJSONError,"]}, {"lines": ["                }"]}, {"lines": ["            });"]}, {"lines": ["var xdrExists = navigator.appVersion.indexOf('MSIE 9.') !== -1;", ""]}, {"lines": ["  if (!xdrExists) {"]}, {"lines": ["if (!xdrExists) {"]}, {"lines": [" * Inherits a list of data fields from one item (parent) to another.", " * @param {Object} item A Treebeard _item object. Node information is inside item.data", " * @param {Object} parent A Treebeard _item object. Node information is inside item.data", " * @this Treebeard.controller", " */", "var inheritedFields = ['nodeId', 'nodeUrl', 'nodeApiUrl', 'permissions', 'provider', 'accept'];"]}, {"lines": ["        item.data[field] = item.data[field] || parent.data[field];", "    });", "}", "", "/**"]}, {"lines": ["        inheritFromParent(item, item.parent());"]}, {"lines": ["            type: 'DELETE',", "            beforeSend: $osf.setXHRAuthorization"]}, {"lines": [" * Called when new object data has arrived to be loaded."]}, {"lines": [" * @this Treebeard.controller", " * @private", " */"]}, {"lines": ["    tree.children.forEach(function(item) {", "        inheritFromParent(item, tree);", "    });"]}, {"lines": ["}", "", "/**"]}, {"lines": [""]}, {"lines": ["    lazyLoadOnLoad : _fangornLazyLoadOnLoad,"]}, {"lines": ["Fangorn.DefaultColumns = {", "    _fangornTitleColumn: _fangornTitleColumn", "};", "", "Fangorn.Utils = {"]}, {"lines": ["    inheritFromParent: inheritFromParent,"]}, {"lines": ["};", ""]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["addExtender('trimmed', function(value) {", "    return $.trim(value);", "});", ""]}, {"lines": ["", "// Add custom effects", "", "// fadeVisible : http://knockoutjs.com/examples/animatedTransitions.html", "ko.bindingHandlers.fadeVisible = {", "    init: function(element, valueAccessor) {", "        // Initially set the element to be instantly visible/hidden depending on the value", "        var value = valueAccessor();", "        $(element).toggle(ko.unwrap(value)); // Use \"unwrapObservable\" so we can handle values that may or may not be observable", "    },", "    update: function(element, valueAccessor) {", "        // Whenever the value subsequently changes, slowly fade the element in or out", "        var value = valueAccessor();", "        ko.unwrap(value) ? $(element).fadeIn() : $(element).hide().fadeOut();", "    }", "};", "", ""]}, {"lines": ["        googledrive: {", "          // Shown on clicking \"Delete Access Token\" for googledrive"]}, {"lines": ["    var options = {"]}, {"lines": ["        provider: provider"]}, {"lines": ["    var viewOnly = getViewOnly();", "    if (viewOnly) {", "        options.view_only = viewOnly;", "    }", "    return options;"]}, {"lines": ["function buildUrl(suffix, path, provider, nid, options) {"]}, {"lines": ["    return baseUrl + $.param($.extend(getDefaultOptions(path, provider), {nid: nid}, options));"]}, {"lines": ["function buildUploadUrl(path, provider, nid, file, options) {"]}, {"lines": ["    return buildUrl('file?', path, provider, nid, options);"]}, {"lines": ["    return buildUrl(suffix, item.data.path, item.data.provider, item.data.nodeId, options);"]}, {"lines": ["    return buildUploadUrl(item.data.path, item.data.provider, item.data.nodeId, file, options);"]}, {"lines": ["    buildDownloadUrl: function(path, provider, nid, options) {", "        if (window.contextVars.accessToken) {", "            options = $.extend(options || {}, {token: window.contextVars.accessToken});", "        }", "        return buildCrudUrl(path, provider, nid, options);", "    },"]}, {"lines": ["    buildTreeBeardDownloadZip: function(item, options) {", "        if (window.contextVars.accessToken) {", "            options = $.extend(options || {}, {token: window.contextVars.accessToken});", "        }", "        return buildFromTreebeard('zip?', item, options);", "    },"]}, {"lines": ["            m('.wiki-connected-users', m('.row', m('.col-sm-12', ["]}, {"lines": ["                m('.row', m('.col-sm-12', ["]}, {"lines": ["var model = {", "    revisions: [],", "    loaded: m.prop(false),", "    errorMessage: undefined,"]}, {"lines": ["    selectedRevision: 0", "};", "", ""]}, {"lines": ["        model.hasDate = self.file.provider !== 'dataverse';"]}, {"lines": ["            model.loaded(false);"]}, {"lines": ["                async: true,"]}, {"lines": ["                model.revisions = response.data.map(function(rev, index) {"]}, {"lines": ["                        model.selectedRevision = index;"]}, {"lines": ["                model.loaded(true);"]}, {"lines": ["                if (model.selectedRevision === 0) {"]}, {"lines": ["                model.hasUser = model.revisions[0] && model.revisions[0].extra && model.revisions[0].extra.user;"]}, {"lines": ["                model.loaded(true);", "                model.errorMessage = response.responseJSON ?"]}, {"lines": ["                // model.errorMessage(err);"]}, {"lines": ["                    model.hasDate ? m('th', 'Date') : false,", "                    model.hasUser ? m('th', 'User') : false,"]}, {"lines": ["            var isSelected = index === model.selectedRevision;"]}, {"lines": ["                model.hasDate ? m('td', revision.displayDate) : false,", "                model.hasUser ?"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["            filesData: data.data,", "            xhrconfig: $osf.setXHRAuthorization"]}, {"lines": ["    url: '/api/v1/subscriptions',", "    type: 'GET',", "    dataType: 'json'", "}).done( function(response) {", "    new ProjectNotifications(response);", "}).fail( function() {", "    $notificationsMsg.addClass('text-danger');", "    $notificationsMsg.text('Could not retrieve notification settings.');", "});"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["                    }"]}, {"lines": ["(function () {", "    'use strict';", ""]}, {"lines": ["    var players = document.getElementsByClassName('youtube-loader');"]}, {"lines": ["", "    if (players.length > 0) {", "        var style = document.createElement('style');", "        style.type = 'text/css';", "        style.innerHTML ="]}, {"lines": ["            '.youtube-loader {' +"]}, {"lines": ["                'background-color:#000;' +", "                'max-width:100%;' +", "                'overflow:hidden;' +", "                'position:relative;' +", "                'cursor:hand;' +", "                'cursor:pointer;' +", "            '}' +"]}, {"lines": ["            '.youtube-loader .thumb {' +"]}, {"lines": ["                'bottom:0;' +", "                'display:block;' +", "                'left:0;' +", "                'margin:auto;' +", "                'max-width:100%;' +", "                'position:absolute;' +", "                'right:0;' +", "                'top:0;' +", "                'width:100%;' +", "                'height:auto;' +", "            '}' +"]}, {"lines": ["            '.youtube-loader .play {' +"]}, {"lines": ["                'transform:scale(0.858333333333333);' +", "                'filter:alpha(opacity=80);' +", "                'opacity:.9;' +", "                'height:60px;' +", "                'left:50%;' +", "                'margin-left:-38px;' +", "                'margin-top:-38px;' +", "                'position:absolute;' +", "                'top:50%;' +", "                'width:85px;' +", "                'background:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFUAAAA8CAYAAAAXDvbIAAAEmklEQVR4Xu2cv0/bQBTHa0BC6pAiuiAlgFm6tYUOnSo1/AVNNjaoWEBCKl1AQkiFv4BEsDdsbKUSsIDUIHVOwgIjCSQVEyV0AgHp9zk5K7YT7GAn9tl3UiSM757vPvfu3buf0rMWQzgcHpUk6QVL1tXVNYq/+xqIkRFPtig+ajGeWbQcIlyZRapUKnnEoZ8+XD08PJAMJSBeuVQqqc9mctl7ySzi0NDQJODEEI/gWYVkJpa391QBOUDePjs72zTLfFOogPkFMOcDDLIZuyvATQDuarMIBqiyLPehCawB6JRZjQT8fRqM4vl83mBuNFAJKGrhV62pB5yZpeLnAHZcD1YDdXh4+AdEkf0UwTqBdKFQGK+PrkKNRCLR7u5u0lIRWiQAc/n5/Pw8Zej9oaUENNqiPBG9SiAPbR3RQB0YGJB7e3tPBaGnE7i7uxtjPq3S/OE+zcPgrj1dpEiJDj4JN4tc0GcM6jagfhJobBHIwQSMqVBhT//iodFQ09ZXgpYYUBUllYQ9da7q7+/vx4vFYloSrpRzUOFaxeFabUuDg4MxzDSR0y+CTQLorFbRWa1I6PlX0El9sylPJAcBAbUNagCoP6GpMdLUFDR1sg3fsCwyFApdI4QsJ/BuxEN4AFEJ7lQaefzoZj4zmczRxcXFv9nZ2RFkKuxmXmx+21tQ+/v731KBjo+Pf09MTLzhVHOVAYBnNJVBJbC0NrS7u5tdWlp6xxtcGgAQVJpIkW2qva3k1PzroTJhPMJlUCu2iDiQuBlUPdy5ubmoA59rqwhuoDIKmF4rJhKJ/MbGxoe2krEhnDuoPMDlFmo93OXl5T9bW1vvbSiXo0lvbm5GqKPyvE01K/Xl5WVuYWFBOjg4UNwyNwPNVPkCKoPoBbi+g1oPd3p6+nk2m33Vaa31LVQGcmdn5xBuWEeH4L6FCterlEwmT9fX1zvuevkOqpswWevwDVQMZ6/39vYymCsYK5fL6t7ZTttT+h73UL0Es853VmapuPNTvQiTQeVyRHVyckLzra/dbubNTAtXUAnmzMyMjExH3LCVVr/JoNJOYFeN+2NTf7zA1Df/NP7RUQdZX+uNoGLIeRSPx196XTP1ZWGa6imoBHNxcbGyv79Pp2F4C2BakD2zRkX0OIbJKr+6mop1f9e3UcKtK/LWzJs0IRWq2PbjnJERUJ1jWZVUv5dKbE13iK4KVexPdYhoVVO/YoNaQqJT0T09PVnnRAdXkrqTmhB4YVLFD1VBK6nYaJdXNv57YeefD6Aqjj+VQ5yjcqg2DeeoxAkV+2SZPVU1VZgA21DVpq+BilMqUzil8t22+AAKYP4pK7r+vH8aL1ydBuSwTjRaqtFUeqjZVrrdxtVJa47AlrEsHtXfCGS4Q6U2GEihYK5v9vI43CMAnWp0xVLD235ql9PQnAAdtRZaq6td2NBN9D/zjS6lMTR/vWYQXLgKMbqXCr9owAEXADN1e3ubolHTY63I9LIvfWKagAHgPvzqlzv0z/pkXun8CsiYAQhg0eKn5qY0/I8u91KuR6KT0a2YopahtiLcibhUiY3kUIGfcmWcE3kyk/EfxreyUB6zPb0AAAAASUVORK5CYII=\") no-repeat' +", "            '}' +"]}, {"lines": ["            '.youtube-loader img:hover + .play,' +", "            '.youtube-loader .play:hover {' +"]}, {"lines": ["                'background:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFUAAAA8CAYAAAAXDvbIAAAE+0lEQVR4Xu2czW8bRRTAZ7whREg1ViuIpdbGuXCjxMThhIRz5oDDpSfU8CF64IDLl1pxoP0DoCn8AbgHJG4NokXiQ2oq9YZbO4cWKkV0bad4A6K1XYlC8O7jzVq78q7t7NpePLveGSlSbM+8mfntmzdvZmceJUOm0hOHF0GijxvFNIgsUkpidjFAIIXfsT8XiWZdZHLMAkDKlELDMSMhMiVU7mkzkEaEamXje6pCM/3HXfOzC7l6FuqUsRhPHicAOULpontITlID97uMDMrIYCOjVC84tX4g1OJ88h1Eng8xyP7sUJtxZK4vKdWzg+D2QC3FYjF17sA5VOI1pycS7t9hU/r7wWq60egxNxaoDGj70egVfBJsqIvkQIDZ8Jl/Wit2sBaoxfnERbQbOUFzGAKwmVFqK90lTKg/xY9kKYlcGUacyNshQAm8tqTUCqbXYPxTjCcQqDeuTQhhy+gVLFigluLxlEpm74QQhmddllQ1bfi0+vC/Pp/MAyU444s0MgHQzmd2d5gL2nH+cYLawAnq5ZEFioK4NiDl5d1qugtq8j7i7VlqClbDEUC7qispFfZ0OHD75QairSwrO5tUuFLeQSUarGZ+r23Q4pOJHInQix6KDq0oIOTsslI9g5qaPIOG4OPQkvCw4wKqhzBNUQBfZ3ZrOYorqQLOV8f/jzrcypSi0ZbaakXd5vdrPtyYv7qs1LI4/BObuAv+Is+GHr1Z2mrXlQfbb55Y2JOrh3m2ZZy6fQf1kYMHn2Udenjz1rXbrxw7GkTNNRYAvtFUAyoDCwDNxqXLpcr7p58LGly2AECbmmQbKalx1H7csmz4d0M15AURrgEVPQG+aRBUO9xf33o7y7elzrUHBqoJt93eqX+yLtfXP3/BuXt8cgQOahDgBhZqN9zKqY9++/PLr57no5e9tUpkb4FNVL63qU7A/r13ryyf/IC2vv9Rd8t4JrZTNRVQDYh+gDt1ULvhbr/6+mN/3Sg9PWmtnVqoBsj731y6im7YRJfgUwsV2u279U/P36mf+2zirtfUQeUJ0/RIpmWiwuVsq3n52xvye6fTaqtpnp2dtD1l9QVeU/0E03iA7FBFIF0qP8I0oAZyRfXw1s/Xbq8ee4b3MB9kWgIFlcHcfuNEak+uHOFhK93W2YE6n2zg6RSuxn2/rb+gwLQMf7+8o7JvUuOSc+uXl3KH/K6Zdg3WNdVvUBnMyrsfQvO7H4J4RL6CUFO+gcqeeIBh6gprvk31wzHK2dRTO0Eb5v0mrq5X1OLYj9uZ3SmfgOpEaITfzbNU4mj6CPQGFOk6oCau+niFlQI5ubRbXafsVrQqSSWvBIdZjnmSmkHww8u/aXgY7E1qWlHw2jsmPywApgCq7vizfoh7VF49Tfs9KnFDZXyyhj01NVWYgLGhmkPfAvV6PLEGhH4xtvgQCjD8U6Prlvv+YsIaSSMsWmrRVPZBt60wiwFY+G5aj9Q1HoWANCVNzdojAvXGUGGLgUikgBeAuR/24sHJdZ0AW5KmrfULsdQ32o8eS2UumsdlV15obT/McAGD0uT7BaXpGf724gyuNncgh7cuMK4KRq0It1mo4IRUmCF7BbZq2k+jHYN92QvrF4Q1GoOIHvxLTxS0GHSCgfVNvO9pdTUKwUAPEByRDWy/JVIa1aAMkU40NnYz2rVZYDyGycwjL3uI/eqdUaExSsi4SfThP5yCtWKJCDx6AAAAAElFTkSuQmCC\") no-repeat' +", "            '}';", "        document.body.appendChild(style);", "    }", "", "    var onClick = function () {", "        var iframe = document.createElement('iframe');"]}, {"lines": ["        iframe.className = this.className.replace('youtube-loader', 'youtube-loader-embedded');"]}, {"lines": ["        var src = '//www.youtube.com/embed/' + this.id + '?autoplay=1&autohide=1&border=0&wmode=opaque&enablejsapi=1&hd=1&showinfo=0';"]}, {"lines": ["        var start = this.getAttribute('start');"]}, {"lines": ["        if (start) {", "            src += '&start=' + start", "        }", "        iframe.setAttribute('src', src);"]}, {"lines": ["        iframe.setAttribute('allowfullscreen', '');", "        iframe.setAttribute('frameborder', '0');", "        iframe.setAttribute('type', 'text/html');"]}, {"lines": ["        this.parentNode.replaceChild(iframe, this);", "    };", "", "    for (var i = 0; i < players.length; i++) {", "        var player = players[i];", "", "        var img = document.createElement('img');"]}, {"lines": ["        img.setAttribute('src', '//i.ytimg.com/vi/' + player.id + '/maxresdefault.jpg');"]}, {"lines": ["        img.setAttribute('class', 'thumb');", "", "        var div = document.createElement('div');", "        div.setAttribute('class', 'play');", "", "        player.appendChild(img);", "        player.appendChild(div);", "", "        player.onclick = onClick;", "    }", "})();"]}, {"lines": ["    <meta name=\"fragment\" content=\"!\">"]}, {"lines": ["        <script>", "            // Mako variables accessible globally", "            window.contextVars = $.extend(true, {}, window.contextVars, {", "                waterbutlerURL: '${waterbutler_url if waterbutler_url.endswith('/') else waterbutler_url + '/' | js_str}',"]}, {"lines": ["            % if access_token:"]}, {"lines": ["                accessToken: '${access_token | js_str}',"]}, {"lines": ["            % endif"]}, {"lines": ["            });", "        </script>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    </div>"]}, {"lines": ["        </div>"]}, {"lines": ["        </div>"]}, {"lines": ["        </div>"]}, {"lines": ["    </div>"]}, {"lines": ["        </div>"]}, {"lines": ["    </div>"]}, {"lines": ["            </button>"]}, {"lines": ["                        ${m}"]}, {"lines": ["", "We may send you occasional Service-related emails that you may not opt-out of (e.g. changes or updates to features of our Services that have security or privacy implications, technical and security notices, account verification); this is one of those emails."]}, {"lines": ["<%inherit file=\"base.mako\"/>", "", "<%def name=\"title()\">Account Settings</%def>", "", "<%def name=\"content()\">"]}, {"lines": ["            </div>"]}, {"lines": ["                </div>"]}, {"lines": ["            </div>", "        </div>", "    </div>"]}, {"lines": ["</%def>"]}, {"lines": ["                <li><a href=\"${ web_url_for('user_account') }\">Account Settings</a></li>"]}, {"lines": ["<h2 class=\"page-header\">Profile Information</h2>"]}, {"lines": ["                <li><a href=\"${ web_url_for('user_account') }\">Account Settings</a></li>"]}, {"lines": ["                        <div class=\"row\">"]}, {"lines": ["                                        <input type=\"submit\" value=\"Search\" class=\"btn btn-default\">"]}, {"lines": ["                        </div>"]}, {"lines": ["                        <div class=\"row search-contributor-links\">"]}, {"lines": ["                            <div class=\"col-md-12\">"]}, {"lines": ["                                <div>"]}, {"lines": ["                                    <!-- ko if:parentId -->", "                                        <a data-bind=\"click:importFromParent, html:'Import contributors from <i>' + parentTitle + '</i>'\"></a>", "                                    <!-- /ko -->", "                                </div>", "                                <div>", "                                    Show my"]}, {"lines": ["                                    <a data-bind=\"click:recentlyAdded\">recent collaborators</a>,", "                                    <a data-bind=\"click:mostInCommon\">most frequent collaborators</a>"]}, {"lines": ["                                </div>"]}, {"lines": ["                            <div data-bind=\"html: notification().message, css: 'alert alert-' + notification().level\"></div>"]}, {"lines": ["    ${parent.javascript_bottom()}"]}, {"lines": ["  <div class=\"col-sm-5\">"]}, {"lines": ["  <div class=\"col-sm-7\">"]}, {"lines": ["  <div id=\"file-navigation\" class=\"panel-toggle col-sm-3 file-tree\">", "    <div class=\"osf-panel osf-panel-hide osf-panel-flex reset-height\">"]}, {"lines": ["          <div class=\"panel-collapse\"><i class=\"fa fa-angle-left\"></i></div>"]}, {"lines": ["    <div class=\"osf-panel osf-panel-show text-center reset-height\"  style=\"display: none\">"]}, {"lines": ["  <div id=\"fileViewPanelLeft\" class=\"col-sm-9 panel-expand\">"]}, {"lines": ["      <div id=\"mfrIframeParent\" class=\"col-sm-9\">"]}, {"lines": ["      <div class=\"file-view-panels col-sm-3\"></div>"]}, {"lines": ["    <link href=\"${urls['mfr']}/static/css/mfr.css\" media=\"all\" rel=\"stylesheet\" />", "    <script src=\"${urls['mfr']}/static/js/mfr.js\"></script>", ""]}, {"lines": ["                    \"action_string\": \"${login_url | h}\","]}, {"lines": ["            <div class=\"progress progress-user-activity\">"]}, {"lines": ["                % if summary['ua']:", "                    <div class=\"progress-bar progress-bar-success ${'last' if not summary['non_ua'] else ''}\" style=\"width: ${summary['ua']}%\"  data-toggle=\"tooltip\" title=\"${user_full_name} made ${summary['ua_count']} contributions\"></div>", "                % endif"]}, {"lines": ["                % if summary['non_ua']:"]}, {"lines": ["                    <div class=\"progress-bar progress-bar-info last\" style=\"width: ${summary['non_ua']}%\"></div>"]}, {"lines": ["                % endif"]}, {"lines": ["            <span class=\"text-muted\">${summary['nlogs']} contributions</span>"]}, {"lines": ["                <dl class=\"dl-horizontal activity-log\" data-bind=\"foreach: {data: logs, as: 'log'}\">"]}, {"lines": ["                    <dd class=\"log-content\">", "                        <span data-bind=\"if:log.anonymous\">", "                            <span><em>A user</em></span>", "                        </span>", "                        <span data-bind=\"ifnot:log.anonymous\">", "                            <a data-bind=\"text: log.userFullName || log.apiKey, attr: {href: log.userURL}\"></a>", "                        </span>", "                        <!-- log actions are the same as their template name -->", "                        <span data-bind=\"template: {name: log.action, data: log}\"></span>", "                        </dd>"]}, {"lines": ["import re"]}, {"lines": ["guid_url_node_pattern = re.compile('^/project/[a-zA-Z0-9]{5,}/node(?=/[a-zA-Z0-9]{5,})')", "guid_url_project_pattern = re.compile('^/project(?=/[a-zA-Z0-9]{5,})')", "guid_url_profile_pattern = re.compile('^/profile(?=/[a-zA-Z0-9]{5,})')"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def _get_guid_url_for(url):", "    \"\"\"URL Post-processor transforms specific `/project/<pid>` or `/project/<pid>/node/<nid>`", "    urls into guid urls. Ex: `<nid>/wiki/home`.", "    \"\"\"", "    guid_url = guid_url_node_pattern.sub('', url, count=1)", "    guid_url = guid_url_project_pattern.sub('', guid_url, count=1)", "    guid_url = guid_url_profile_pattern.sub('', guid_url, count=1)", "    return guid_url", ""]}, {"lines": ["    if _guid:", "        url = _get_guid_url_for(url)"]}, {"lines": ["    return url"]}], "name": "icereval"}, {"commits": [{"lines": ["            {test: /\\.png$/, loader: 'url-loader?limit=100000&mimetype=image/ng'},"]}, {"lines": ["    def test_new_project_returns_serialized_node_data(self):", "        payload = {", "            'title': 'Im a real title'", "        }", "        res = self.app.post_json(self.url, payload, auth=self.creator.auth)", "        assert_equal(res.status_code, 201)"]}, {"lines": ["        node = res.json['newNode']"]}, {"lines": ["        assert_true(node)"]}, {"lines": ["        assert_equal(node['title'], 'Im a real title')"]}, {"lines": [""]}, {"lines": ["            itemView: '<button class=\"btn btn-xs btn-danger revoke-badge\" aid=\"{{ assertion_id }}\" url=\"{{ node_api_url }}\"><i class=\"fa fa-minus\"></i></button>',"]}, {"lines": [""]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["\"\"\""]}, {"lines": ["import base64"]}, {"lines": ["from modularodm.exceptions import ModularOdmException"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["from website.addons.base import exceptions"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    path = fields.StringField(index=True)", "", "    @property"]}, {"lines": ["    def waterbutler_path(self):"]}, {"lines": [""]}, {"lines": ["    @property", "    def provider(self):"]}, {"lines": ["", "    @property", "    def version_identifier(self):", "        return 'revision'"]}, {"lines": [""]}, {"lines": ["    @property"]}, {"lines": ["    def unique_identifier(self):", "        return self._metadata_cache['extra']['revisionId']", "", "    @classmethod", "    def get_or_create(cls, node, path):", "        \"\"\"Get or create a new file record. Return a tuple of the form (obj, created)", "        \"\"\""]}, {"lines": ["        try:", "            new = cls.find_one(", "                Q('node', 'eq', node) &", "                Q('path', 'eq', path)", "            )", "            created = False", "        except ModularOdmException:", "            # Create new", "            new = cls(node=node, path=path)", "            new.save()", "            created = True", "        return new, created"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    \"\"\""]}, {"lines": [""]}, {"lines": ["    @property", "    def has_auth(self):"]}, {"lines": [""]}, {"lines": ["            node_settings.deauthorize(Auth(self.owner))", "            node_settings.save()"]}, {"lines": [""]}, {"lines": ["    def delete(self, save=True):", "        self.clear()"]}, {"lines": ["", "    def __repr__(self):"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    user_settings = fields.ForeignField("]}, {"lines": ["    )", ""]}, {"lines": [""]}, {"lines": ["    @property", "    def has_auth(self):", "        \"\"\"Whether an access token is associated with this node.\"\"\"", "        return bool(self.user_settings and self.user_settings.has_auth)", ""]}, {"lines": ["    def deauthorize(self, auth=None, add_log=True):"]}, {"lines": ["        \"\"\"Remove user authorization from this node and log the event.\"\"\""]}, {"lines": [""]}, {"lines": ["        self.user_settings = None"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        # Add log to node"]}, {"lines": [""]}, {"lines": ["    def set_user_auth(self, user_settings):"]}, {"lines": [""]}, {"lines": ["        \"\"\"", "        self.user_settings = user_settings"]}, {"lines": ["        nodelogger = GoogleDriveNodeLogger(node=self.owner, auth=Auth(user_settings.owner))", "        nodelogger.log(action=\"node_authorized\", save=True)"]}, {"lines": [""]}, {"lines": ["    def serialize_waterbutler_credentials(self):", "        if not self.has_auth:", "            raise exceptions.AddonError('Addon is not authorized')"]}, {"lines": ["", "    def serialize_waterbutler_settings(self):"]}, {"lines": ["            raise exceptions.AddonError('Folder is not configured')"]}, {"lines": ["", "    def create_waterbutler_log(self, auth, action, metadata):"]}, {"lines": ["        # cleaned_path = clean_path(metadata['path'])"]}, {"lines": [""]}, {"lines": ["        self.owner.add_log("]}, {"lines": ["            auth=auth,", "            params={", "                'project': self.owner.parent_id,", "                'node': self.owner._id,"]}, {"lines": ["", "                'urls': {"]}, {"lines": ["                    'view': url,", "                    'download': url + '?action=download'"]}, {"lines": ["                },", "            },", "        )", ""]}, {"lines": ["    def find_or_create_file_guid(self, path):"]}, {"lines": [""]}, {"lines": ["    # #### Callback overrides #####"]}, {"lines": ["", "    def before_register_message(self, node, user):", "        \"\"\"Return warning text to display if user auth will be copied to a", "        registration.", "        \"\"\"", "        category, title = node.project_or_component, node.title", "        if self.user_settings and self.user_settings.has_auth:"]}, {"lines": ["            return (", "                u'The contents of Google Drive add-ons cannot be registered at this time; '", "                u'the Google Drive folder linked to this {category} will not be included '", "                u'as part of this registration.'", "            ).format(**locals())"]}, {"lines": ["", "    # backwards compatibility", "    before_register = before_register_message", "", "    def before_fork_message(self, node, user):", "        \"\"\"Return warning text to display if user auth will be copied to a", "        fork.", "        \"\"\""]}, {"lines": ["        category = node.project_or_component", "        if self.user_settings and self.user_settings.owner == user:", "            return (u'Because you have authorized the Google Drive add-on for this '", "                    '{category}, forking it will also transfer your authentication token to '", "                    'the forked {category}.').format(category=category)", "", "        else:"]}, {"lines": ["                    'user, forking it will not transfer authentication token to the forked '", "                    '{category}.').format(category=category)"]}, {"lines": ["", "    # backwards compatibility", "    before_fork = before_fork_message", "", "    def before_remove_contributor_message(self, node, removed):", "        \"\"\"Return warning text to display if removed contributor is the user"]}, {"lines": ["        \"\"\"", "        if self.user_settings and self.user_settings.owner == removed:"]}, {"lines": ["            category = node.project_or_component", "            name = removed.fullname", "            return (u'The Google Drive add-on for this {category} is authenticated by {name}. '"]}, {"lines": ["                    'unless another contributor re-authenticates the add-on.'", "                    ).format(**locals())"]}, {"lines": ["", "    # backwards compatibility", "    before_remove_contributor = before_remove_contributor_message", ""]}, {"lines": ["    def after_fork(self, node, fork, user, save=True):", "        \"\"\"After forking, copy user settings if the user is the one who authorized", "        the addon.", "", "        :return: A tuple of the form (cloned_settings, message)", "        \"\"\""]}, {"lines": ["            node=node, fork=fork, user=user, save=False", "        )", "", "        if self.user_settings and self.user_settings.owner == user:", "            clone.user_settings = self.user_settings", "            message = 'Google Drive authorization copied to fork.'", "        else:"]}, {"lines": ["            message = ('Google Drive authorization not copied to forked {cat}. You may '"]}, {"lines": ["                       'authorize this fork on the <a href=\"{url}\">Settings</a>'", "                       'page.').format(", "                url=fork.web_url_for('node_setting'),", "                cat=fork.project_or_component"]}, {"lines": ["            )"]}, {"lines": ["        if save:", "            clone.save()", "        return clone, message", ""]}, {"lines": ["        addon, remove the auth credentials from this node.", "        Return the message text that will be displayed to the user.", "        \"\"\"", "        if self.user_settings and self.user_settings.owner == removed:"]}, {"lines": ["            self.user_settings = None", "            self.save()"]}, {"lines": ["", "    def after_delete(self, node, user):", "        self.deauthorize(Auth(user=user), add_log=True)"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Utility functions for the Google Drive add-on.", "\"\"\""]}, {"lines": ["from website.util import web_url_for"]}, {"lines": [""]}, {"lines": ["logger = logging.getLogger(__name__)", ""]}, {"lines": [""]}, {"lines": ["class GoogleDriveNodeLogger(object):", "    \"\"\"Helper class for adding correctly-formatted Google Drive logs to nodes.", "", "    Usage: ::", "", "        from website.project.model import NodeLog", ""]}, {"lines": ["        file_obj.save()", "        node = ...", "        auth = ...", "        nodelogger = GoogleDriveNodeLogger(node, auth, file_obj)", "        nodelogger.log(NodeLog.FILE_REMOVED, save=True)", "", "", "    :param Node node: The node to add logs to", "    :param Auth auth: Authorization of the person who did the action."]}, {"lines": ["    \"\"\"", "    def __init__(self, node, auth, file_obj=None, path=None):", "        self.node = node", "        self.auth = auth", "        self.file_obj = file_obj", "        self.path = path", "", "    def log(self, action, extra=None, save=False):", "        \"\"\"Log an event. Wraps the Node#add_log method, automatically adding"]}, {"lines": ["", "        :param str action: Log action. Should be a class constant from NodeLog.", "        :param dict extra: Extra parameters to add to the ``params`` dict of the", "            new NodeLog.", "        \"\"\"", "        params = {", "            'project': self.node.parent_id,", "            'node': self.node._primary_key,"]}, {"lines": ["        }", "        if extra:", "            params.update(extra)"]}, {"lines": ["        self.node.add_log("]}, {"lines": ["            params=params,", "            auth=self.auth", "        )", "        if save:", "            self.node.save()", ""]}, {"lines": [""]}, {"lines": ["def serialize_urls(node_settings):", "    node = node_settings.owner"]}, {"lines": ["    }"]}, {"lines": ["", "", "def serialize_settings(node_settings, current_user):", "    \"\"\""]}, {"lines": ["    \"\"\"", "    user_settings = node_settings.user_settings"]}, {"lines": ["        'nodeHasAuth': node_settings.has_auth,", "        'userIsOwner': user_is_owner,", "        'userHasAuth': current_user_settings is not None and current_user_settings.has_auth,"]}, {"lines": ["    }"]}, {"lines": ["    if node_settings.has_auth:"]}, {"lines": ["        # Add owner's profile URL"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    }", ""]}, {"lines": [""]}, {"lines": ["def to_hgrid(item, node, path):", "    \"\"\""]}, {"lines": ["    :param item: contents returned from Google Drive API"]}, {"lines": ["    :return: results formatted as required for Hgrid display", "    \"\"\""]}, {"lines": ["    serialized = {"]}, {"lines": ["        'id': item['id'],"]}, {"lines": ["        'kind': 'folder',"]}, {"lines": ["    }"]}, {"lines": ["    return serialized"]}, {"lines": ["", "# Drive credentials"]}, {"lines": ["CLIENT_SECRET = 'changeme'", ""]}, {"lines": ["# Check https://developers.google.com/drive/scopes for all available scopes"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    item.notify.update('Google Drive couldn\\'t load, please try again later.', 'deleting', undefined, 3000);", "    return true;", "}", ""]}, {"lines": ["    lazyLoadError : _fangornLazyLoadError", "};"]}, {"lines": ["", ""]}, {"lines": ["<h4 class=\"addon-title\">", "    Google Drive", "    <small>", "        <!-- Delete Access Token Button-->", "        <span data-bind=\"if: userHasAuth() && loaded()\">"]}, {"lines": ["            authorized"]}, {"lines": ["            <span data-bind=\"if: username()\">by {{ username }}</span>"]}, {"lines": ["            <a data-bind=\"click:deleteKey\" class=\"text-danger pull-right addon-auth\">", "                Delete Access Token", "            </a>", "        </span>", "        <!-- Create Access Token Button -->", "        <span data-bind=\"if: !userHasAuth() && loaded()\">"]}, {"lines": ["                Create Access Token", "            </a>", "        </span>", "    </small>", "", "</h4>"]}, {"lines": ["    <!-- Flashed Messages -->", "    <div class=\"help-block\">", "        <p data-bind=\"html: message, attr: {class: messageClass}\"></p>", "    </div>"]}, {"lines": ["</div>"]}, {"lines": ["", "<%include file=\"profile/addon_permissions.mako\" />"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from nose.tools import *  # noqa (PEP8 asserts)", ""]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["from tests.base import OsfTestCase", "from tests.factories import UserFactory, ProjectFactory", "from website.addons.base import exceptions", ""]}, {"lines": [")"]}, {"lines": [")"]}, {"lines": [""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = UserFactory()", "", "    def test_fields(self):"]}, {"lines": ["        assert_true(retrieved.owner)", "        assert_true(retrieved.username)"]}, {"lines": ["", ""]}, {"lines": ["", "    def setUp(self):"]}, {"lines": ["        self.user = UserFactory()"]}, {"lines": ["        self.user.save()"]}, {"lines": ["        self.project = ProjectFactory()"]}, {"lines": ["            user_settings=self.user_settings,", "            owner=self.project,", "        )", "", "    def test_fields(self):"]}, {"lines": ["        node_settings.save()"]}, {"lines": ["        assert_true(node_settings.user_settings)"]}, {"lines": ["        assert_equal(node_settings.user_settings.owner, self.user)"]}, {"lines": [""]}, {"lines": ["    def test_folder_defaults_to_none(self):"]}, {"lines": ["        node_settings.save()"]}, {"lines": ["", "    def test_has_auth(self):"]}, {"lines": ["        settings.save()"]}, {"lines": ["        assert_false(settings.has_auth)", "", "        settings.user_settings.access_token = '123abc'", "        settings.user_settings.save()"]}, {"lines": ["        assert_true(settings.has_auth)", ""]}, {"lines": ["    # def test_delete(self):", "    #     assert_true(self.node_settings.user_settings)", "    #     assert_true(self.node_settings.folder)", "    #     old_logs = self.project.logs", "    #     self.node_settings.delete()", "    #     self.node_settings.save()", "    #     assert_is(self.node_settings.user_settings, None)", "    #     assert_is(self.node_settings.folder, None)", "    #     assert_true(self.node_settings.deleted)", "    #     assert_equal(self.project.logs, old_logs)", "", "    def test_deauthorize(self):"]}, {"lines": ["        assert_true(self.node_settings.user_settings)"]}, {"lines": ["        self.node_settings.deauthorize(auth=Auth(self.user))", "        self.node_settings.save()"]}, {"lines": ["        assert_is(self.node_settings.user_settings, None)"]}, {"lines": ["", "        last_log = self.project.logs[-1]"]}, {"lines": ["        params = last_log.params"]}, {"lines": ["        assert_in('node', params)"]}, {"lines": ["        assert_in('folder', params)"]}, {"lines": ["", "    def test_set_folder(self):"]}, {"lines": ["        folder_name = {"]}, {"lines": ["            'id': '1234',"]}, {"lines": ["        }", ""]}, {"lines": ["        self.node_settings.set_folder(folder_name, auth=Auth(self.user))", "        self.node_settings.save()", "        # Folder was set"]}, {"lines": ["        # Log was saved", "        last_log = self.project.logs[-1]"]}, {"lines": ["", "    def test_set_user_auth(self):"]}, {"lines": ["", "        node_settings.set_user_auth(user_settings)", "        node_settings.save()", "", "        assert_true(node_settings.has_auth)", "        assert_equal(node_settings.user_settings, user_settings)", "        # A log was saved", "        last_log = node_settings.owner.logs[-1]"]}, {"lines": ["        log_params = last_log.params"]}, {"lines": ["        assert_equal(last_log.user, user_settings.owner)"]}, {"lines": ["", "    def test_serialize_credentials(self):", "        self.user_settings.access_token = 'secret'", "        self.user_settings.save()", "        credentials = self.node_settings.serialize_waterbutler_credentials()"]}, {"lines": ["        expected = {'token': self.node_settings.user_settings.access_token}", "        assert_equal(credentials, expected)", ""]}, {"lines": ["    def test_serialize_credentials_not_authorized(self):", "        self.node_settings.user_settings = None", "        self.node_settings.save()"]}, {"lines": ["        with assert_raises(exceptions.AddonError):", "            self.node_settings.serialize_waterbutler_credentials()", "", "    def test_serialize_settings(self):"]}, {"lines": ["        self.node_settings.save()"]}, {"lines": ["        settings = self.node_settings.serialize_waterbutler_settings()"]}, {"lines": ["        assert_equal(settings, expected)", "", "    def test_serialize_settings_not_configured(self):"]}, {"lines": ["        self.node_settings.save()"]}, {"lines": ["        with assert_raises(exceptions.AddonError):", "            self.node_settings.serialize_waterbutler_settings()", "", "    def test_create_log(self):", "        action = 'file_added'", "        path = '12345/camera uploads/pizza.nii'"]}, {"lines": ["        nlog = len(self.project.logs)", "        self.node_settings.create_waterbutler_log(", "            auth=Auth(user=self.user),", "            action=action,", "            metadata={'path': path},", "        )"]}, {"lines": ["        self.project.reload()"]}, {"lines": ["        assert_equal(len(self.project.logs), nlog + 1)", "        assert_equal(", "            self.project.logs[-1].action,"]}, {"lines": ["        )"]}, {"lines": ["        assert_equal(self.project.logs[-1].params['path'], path)"]}, {"lines": ["", "", "class TestNodeSettingsCallbacks(OsfTestCase):", "", "    def setUp(self):", "        super(TestNodeSettingsCallbacks, self).setUp()", "        # Create node settings with auth"]}, {"lines": ["            user_settings=self.user_settings,", "            folder='',", "        )", "", "        self.project = self.node_settings.owner", "        self.user = self.user_settings.owner", ""]}, {"lines": ["        fork = ProjectFactory()", "        clone, message = self.node_settings.after_fork(", "            node=self.project, fork=fork, user=self.user_settings.owner", "        )", "        assert_equal(clone.user_settings, self.user_settings)", ""]}, {"lines": ["        fork = ProjectFactory()", "        user = UserFactory()", "        clone, message = self.node_settings.after_fork(", "            node=self.project, fork=fork, user=user,", "            save=True", "        )", "        # need request context for url_for", "        assert_is(clone.user_settings, None)", "", "    def test_before_fork(self):", "        node = ProjectFactory()", "        message = self.node_settings.before_fork(node, self.user)", "        assert_true(message)", "", "    def test_before_remove_contributor_message(self):", "        message = self.node_settings.before_remove_contributor(", "            self.project, self.user)", "        assert_true(message)", "        assert_in(self.user.fullname, message)", "        assert_in(self.project.project_or_component, message)", ""]}, {"lines": ["        message = self.node_settings.after_remove_contributor(", "            self.project, self.user_settings.owner)", "        self.node_settings.save()", "        assert_is_none(self.node_settings.user_settings)", "        assert_true(message)"]}, {"lines": ["", "    def test_after_delete(self):", "        self.project.remove_node(Auth(user=self.project.creator))", "        # Ensure that changes to node settings have been saved", "        self.node_settings.reload()"]}, {"lines": ["        assert_true(self.node_settings.user_settings is None)"]}, {"lines": [""]}, {"lines": ["        registration = self.project.register_node(", "            schema=None,", "            auth=Auth(user=self.project.creator),", "            template='Template1',", "            data='hodor'", "        )", "        assert_false(registration.has_addon('googledrive'))"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["import website", "", ""]}, {"lines": ["mock_files_folders = {", " \"kind\": \"drive#fileList\",", " \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/OFY_BAPrn0m2U6l6Y1Al8txPdxM\\\"\",", " \"selfLink\": \"https://www.googleapis.com/drive/v2/files?q='0B8IkoNBph4qJenVUSDAxRFdjY1k'+in+parents+and+trashed%3DFalse\",", " \"items\": [", "  {"]}, {"lines": [""]}, {"lines": ["   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJbDV4cmpEM182RFk\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzU3ODcxNw\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJbDV4cmpEM182RFk\",", "   \"webContentLink\": \"https://docs.google.com/uc?id=0B8IkoNBph4qJbDV4cmpEM182RFk&export=download\",", "   \"alternateLink\": \"https://docs.google.com/file/d/0B8IkoNBph4qJbDV4cmpEM182RFk/edit?usp=drivesdk\",", "   \"openWithLinks\": {", "    \"457660898219\": \"https://accounts.google.com/o/oauth2/auth?scope=https://www.googleapis.com/auth/drive.file+https://www.googleapis.com/auth/drive+https://www.googleapis.com/auth/userinfo.email+https://www.googleapis.com/auth/userinfo.profile+https://docs.google.com/feeds/+https://docs.googleusercontent.com/feeds/&client_id=457660898219-m490arfh0gaim2bvsot4dg2jic6tvuos.apps.googleusercontent.com&response_type=code&access_type=offline&redirect_uri=https://gadgets.zoho.com/gdrive/writer&user_id=111890625752680749576&state=%7B%22ids%22:%5B%220B8IkoNBph4qJbDV4cmpEM182RFk%22%5D,%22action%22:%22open%22,%22userId%22:%22111890625752680749576%22%7D\"", "   },", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_10_text_list.png\",", "   \"thumbnailLink\": \"https://lh3.googleusercontent.com/pRKEtkdSgQbmSctvtBx07GO2g2lHFbjNw0sCBvIdyUEwTiTGXNm998qWJzOz1sIW60AaaA=s220\",", "   \"title\": \"Torrent downloaded from Demonoid.txt\",", "   \"mimeType\": \"text/plain\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": True,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": False", "   },", "   \"createdDate\": \"2014-09-27T22:39:38.717Z\",", "   \"modifiedDate\": \"2014-09-27T22:39:38.717Z\",", "   \"modifiedByMeDate\": \"2014-09-27T22:39:38.717Z\",", "   \"markedViewedByMeDate\": \"1970-01-01T00:00:00.000Z\",", "   \"version\": \"14879\",", "   \"parents\": [", "    {"]}, {"lines": [""]}, {"lines": ["     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJbDV4cmpEM182RFk/parents/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"isRoot\": False", "    }", "   ],", "   \"downloadUrl\": \"https://doc-0o-4s-docs.googleusercontent.com/docs/securesc/tujj9q5cg2f1cm3jop9gn86ej796p8ll/0fnlldf3r65apevhqo7155ms5gtpes1c/1424037600000/03716493619382043449/03716493619382043449/0B8IkoNBph4qJbDV4cmpEM182RFk?e=download&gd=True\",", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/IENhEp7JUQKowCOddON_fpygwuk\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJbDV4cmpEM182RFk/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"originalFilename\": \"Torrent downloaded from Demonoid.txt\",", "   \"fileExtension\": \"txt\",", "   \"md5Checksum\": \"0ba9b8b077f34d011dbe5bf4892a3cfe\",", "   \"fileSize\": \"46\",", "   \"quotaBytesUsed\": \"46\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": True,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False,", "   \"headRevisionId\": \"0B8IkoNBph4qJOE5kdGhyenlZMmxIVEoyNnRrNTViVUJkSm4wPQ\"", "  },", "  {"]}, {"lines": [""]}, {"lines": ["   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJRUNmVy12QWFnQWc\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzU3Nzg4NQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRUNmVy12QWFnQWc\",", "   \"webContentLink\": \"https://docs.google.com/uc?id=0B8IkoNBph4qJRUNmVy12QWFnQWc&export=download\",", "   \"alternateLink\": \"https://docs.google.com/file/d/0B8IkoNBph4qJRUNmVy12QWFnQWc/edit?usp=drivesdk\",", "   \"openWithLinks\": {", "    \"457660898219\": \"https://accounts.google.com/o/oauth2/auth?scope=https://www.googleapis.com/auth/drive.file+https://www.googleapis.com/auth/drive+https://www.googleapis.com/auth/userinfo.email+https://www.googleapis.com/auth/userinfo.profile+https://docs.google.com/feeds/+https://docs.googleusercontent.com/feeds/&client_id=457660898219-m490arfh0gaim2bvsot4dg2jic6tvuos.apps.googleusercontent.com&response_type=code&access_type=offline&redirect_uri=https://gadgets.zoho.com/gdrive/writer&user_id=111890625752680749576&state=%7B%22ids%22:%5B%220B8IkoNBph4qJRUNmVy12QWFnQWc%22%5D,%22action%22:%22open%22,%22userId%22:%22111890625752680749576%22%7D\"", "   },", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_10_text_list.png\",", "   \"thumbnailLink\": \"https://lh4.googleusercontent.com/_iZdicljCKzylIT87wBiOTlCZcnuKXzCu3zNejKowi1XbqSok0ojCf5a2eBhpEADOCwYuA=s220\",", "   \"title\": \"Torrent downloaded from AhaShare.com.txt\",", "   \"mimeType\": \"text/plain\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": True,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": False", "   },", "   \"createdDate\": \"2014-09-27T22:39:37.885Z\",", "   \"modifiedDate\": \"2014-09-27T22:39:37.885Z\",", "   \"modifiedByMeDate\": \"2014-09-27T22:39:37.885Z\",", "   \"markedViewedByMeDate\": \"1970-01-01T00:00:00.000Z\",", "   \"version\": \"14880\",", "   \"parents\": [", "    {"]}, {"lines": [""]}, {"lines": ["     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRUNmVy12QWFnQWc/parents/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"isRoot\": False", "    }", "   ],", "   \"downloadUrl\": \"https://doc-10-4s-docs.googleusercontent.com/docs/securesc/tujj9q5cg2f1cm3jop9gn86ej796p8ll/ojj7q9f2h03ivo4sk5nckm19mkfcsggq/1424037600000/03716493619382043449/03716493619382043449/0B8IkoNBph4qJRUNmVy12QWFnQWc?e=download&gd=True\",", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/j5r-DCqnrKy1l72lZhkDDLwyoUQ\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRUNmVy12QWFnQWc/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"originalFilename\": \"Torrent downloaded from AhaShare.com.txt\",", "   \"fileExtension\": \"txt\",", "   \"md5Checksum\": \"55e565dd59a868ba9d0366602e14c97b\",", "   \"fileSize\": \"59\",", "   \"quotaBytesUsed\": \"59\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": True,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False,", "   \"headRevisionId\": \"0B8IkoNBph4qJTi9KU0hyN2R3eEdRMzVMY05PQitTTUdTVklrPQ\"", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJUjREMFF0bEFQTlk\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzU3Njg1Nw\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJUjREMFF0bEFQTlk\",", "   \"webContentLink\": \"https://docs.google.com/uc?id=0B8IkoNBph4qJUjREMFF0bEFQTlk&export=download\",", "   \"alternateLink\": \"https://docs.google.com/file/d/0B8IkoNBph4qJUjREMFF0bEFQTlk/edit?usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_image_list.png\",", "   \"thumbnailLink\": \"https://lh5.googleusercontent.com/kSJ3Pdm2QNQ2-shVblA1Ea9MVSSyd3ev_CHEvN_MYouxkAjVnxUfZJkazbUZc6-DUV_log=s220\",", "   \"title\": \"Mantesh.jpg\",", "   \"mimeType\": \"image/jpeg\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": True,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": False", "   },", "   \"createdDate\": \"2014-09-27T22:39:36.857Z\",", "   \"modifiedDate\": \"2014-09-27T22:39:36.857Z\",", "   \"modifiedByMeDate\": \"2014-09-27T22:39:36.857Z\",", "   \"markedViewedByMeDate\": \"1970-01-01T00:00:00.000Z\",", "   \"version\": \"14874\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJUjREMFF0bEFQTlk/parents/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"isRoot\": False", "    }", "   ],", "   \"downloadUrl\": \"https://doc-10-4s-docs.googleusercontent.com/docs/securesc/tujj9q5cg2f1cm3jop9gn86ej796p8ll/21u4h1e2lhoae5aoq7n4eo12vses1r7q/1424037600000/03716493619382043449/03716493619382043449/0B8IkoNBph4qJUjREMFF0bEFQTlk?e=download&gd=True\",", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/w5nFwKOc3QNnwY4M_3kodROXJzo\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJUjREMFF0bEFQTlk/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"originalFilename\": \"Mantesh.jpg\",", "   \"fileExtension\": \"jpg\",", "   \"md5Checksum\": \"0c3a38836f4e1e4dcd96bfc8e6d0e9fb\",", "   \"fileSize\": \"75974\",", "   \"quotaBytesUsed\": \"75974\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": True,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False,", "   \"headRevisionId\": \"0B8IkoNBph4qJcVJ6bHh6OERDMXpFanE2SVJ2NWJFaWFSa0RzPQ\",", "   \"imageMediaMetadata\": {", "    \"width\": 400,", "    \"height\": 606", "   }", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJSVpjZ1FJUTJ5RTA\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzU3NjAwNQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJSVpjZ1FJUTJ5RTA\",", "   \"webContentLink\": \"https://docs.google.com/uc?id=0B8IkoNBph4qJSVpjZ1FJUTJ5RTA&export=download\",", "   \"alternateLink\": \"https://docs.google.com/file/d/0B8IkoNBph4qJSVpjZ1FJUTJ5RTA/edit?usp=drivesdk\",", "   \"openWithLinks\": {", "    \"1031094922298\": \"http://www.luminpdf.com/open/?state=%7B%22ids%22:%5B%220B8IkoNBph4qJSVpjZ1FJUTJ5RTA%22%5D,%22action%22:%22open%22,%22userId%22:%22111890625752680749576%22%7D\"", "   },", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_10_pdf_list.png\",", "   \"thumbnailLink\": \"https://lh3.googleusercontent.com/Y8z38ZIt2zPAhaoBHKyi8Z0r1cMBVBZJ0FHBCLa96h2KcqBrEWSw4Tu7z8SA33CW0vWNPg=s220\",", "   \"title\": \"Cracking the Coding Interview, 4 Edition - 150 Programming Interview Questions and Solutions.pdf\",", "   \"mimeType\": \"application/pdf\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": True,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": False", "   },", "   \"createdDate\": \"2014-09-27T22:39:36.005Z\",", "   \"modifiedDate\": \"2014-09-27T22:39:36.005Z\",", "   \"modifiedByMeDate\": \"2014-09-27T22:39:36.005Z\",", "   \"markedViewedByMeDate\": \"1970-01-01T00:00:00.000Z\",", "   \"version\": \"14873\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJSVpjZ1FJUTJ5RTA/parents/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "     \"isRoot\": False", "    }", "   ],", "   \"downloadUrl\": \"https://doc-08-4s-docs.googleusercontent.com/docs/securesc/tujj9q5cg2f1cm3jop9gn86ej796p8ll/fsmj9tb67k3alt8f4i9mm9naherhc4op/1424037600000/03716493619382043449/03716493619382043449/0B8IkoNBph4qJSVpjZ1FJUTJ5RTA?e=download&gd=True\",", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/-IguKToYlivdPOKVLm8-F-lrp4o\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJSVpjZ1FJUTJ5RTA/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"originalFilename\": \"Cracking the Coding Interview, 4 Edition - 150 Programming Interview Questions and Solutions.pdf\",", "   \"fileExtension\": \"pdf\",", "   \"md5Checksum\": \"4a77b3d15c6820472a3a2c7fb8f02426\",", "   \"fileSize\": \"4048243\",", "   \"quotaBytesUsed\": \"4048243\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": True,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False,", "   \"headRevisionId\": \"0B8IkoNBph4qJd2RMcng2TVBuZWZTRy8rdHpHUmc4dS81VTE4PQ\"", "  }", " ]", "}", "", "", "mock_folders = {", "", "         \"kind\": \"drive#fileList\",", "         \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/U8RO9tOkTpY5n55eC_2h11phZ30\\\"\",", "         \"selfLink\": \"https://www.googleapis.com/drive/v2/files?q='0B8IkoNBph4qJeWlDanNYbm9LT2c'+in+parents+and+trashed%3DFalse+and+mimeType%3D%22application/vnd.google-apps.folder%22\",", "         \"items\": [", "          {", "", "           \"kind\": \"drive#file\",", "           \"id\": \"0B8IkoNBph4qJeU9OSWQtaUNwbFE\",", "           \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "           \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeU9OSWQtaUNwbFE\",", "           \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJeU9OSWQtaUNwbFE&usp=drivesdk\",", "           \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\","]}, {"lines": ["           \"mimeType\": \"application/vnd.google-apps.folder\",", "           \"labels\": {", "            \"starred\": False,", "            \"hidden\": False,", "            \"trashed\": False,", "            \"restricted\": False,", "            \"viewed\": True", "           },", "           \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "           \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "           \"lastViewedByMeDate\": \"2014-11-19T06:00:42.553Z\",", "           \"markedViewedByMeDate\": \"1970-01-01T00:00:00.000Z\",", "           \"version\": \"16982\",", "           \"parents\": [", "            {", "", "             \"kind\": \"drive#parentReference\",", "             \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeU9OSWQtaUNwbFE/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"isRoot\": False", "            }", "           ],", "           \"userPermission\": {", "            \"kind\": \"drive#permission\",", "            \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/t67v37TpTJx78_ogH-jpDny1NB0\\\"\",", "            \"id\": \"me\",", "            \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeU9OSWQtaUNwbFE/permissions/me\",", "            \"role\": \"owner\",", "            \"type\": \"user\"", "           },", "           \"quotaBytesUsed\": \"0\",", "           \"ownerNames\": [", "            \"Kushagra Gupta\"", "           ],", "           \"owners\": [", "            {", "             \"kind\": \"drive#user\",", "             \"displayName\": \"Kushagra Gupta\",", "             \"picture\": {", "              \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "             },", "             \"isAuthenticatedUser\": True,", "             \"permissionId\": \"03716493619382043449\",", "             \"emailAddress\": \"imkushagra@gmail.com\"", "            }", "           ],", "           \"lastModifyingUserName\": \"Kushagra Gupta\",", "           \"lastModifyingUser\": {", "            \"kind\": \"drive#user\",", "            \"displayName\": \"Kushagra Gupta\",", "            \"picture\": {", "             \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "            },", "            \"isAuthenticatedUser\": True,", "            \"permissionId\": \"03716493619382043449\",", "            \"emailAddress\": \"imkushagra@gmail.com\"", "           },", "           \"editable\": True,", "           \"copyable\": False,", "           \"writersCanShare\": True,", "           \"shared\": False,", "           \"appDataContents\": False", "          },", "          {", "", "           \"kind\": \"drive#file\",", "           \"id\": \"0B8IkoNBph4qJZ0hORDNsbHJJSzQ\",", "           \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "           \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZ0hORDNsbHJJSzQ\",", "           \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJZ0hORDNsbHJJSzQ&usp=drivesdk\",", "           \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "           \"title\": \"Resume\",", "           \"mimeType\": \"application/vnd.google-apps.folder\",", "           \"labels\": {", "            \"starred\": False,", "            \"hidden\": False,", "            \"trashed\": False,", "            \"restricted\": False,", "            \"viewed\": True", "           },", "           \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "           \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "           \"lastViewedByMeDate\": \"2014-11-19T06:00:48.027Z\",", "           \"markedViewedByMeDate\": \"2014-09-27T22:55:27.484Z\",", "           \"version\": \"16983\",", "           \"parents\": [", "            {", "", "             \"kind\": \"drive#parentReference\",", "             \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZ0hORDNsbHJJSzQ/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"isRoot\": False", "            }", "           ],", "           \"userPermission\": {", "            \"kind\": \"drive#permission\",", "            \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/YXBw3kpw0bgZ4tLR0hdd0JH-BlY\\\"\",", "            \"id\": \"me\",", "            \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZ0hORDNsbHJJSzQ/permissions/me\",", "            \"role\": \"owner\",", "            \"type\": \"user\"", "           },", "           \"quotaBytesUsed\": \"0\",", "           \"ownerNames\": [", "            \"Kushagra Gupta\"", "           ],", "           \"owners\": [", "            {", "             \"kind\": \"drive#user\",", "             \"displayName\": \"Kushagra Gupta\",", "             \"picture\": {", "              \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "             },", "             \"isAuthenticatedUser\": True,", "             \"permissionId\": \"03716493619382043449\",", "             \"emailAddress\": \"imkushagra@gmail.com\"", "            }", "           ],", "           \"lastModifyingUserName\": \"Kushagra Gupta\",", "           \"lastModifyingUser\": {", "            \"kind\": \"drive#user\",", "            \"displayName\": \"Kushagra Gupta\",", "            \"picture\": {", "             \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "            },", "            \"isAuthenticatedUser\": True,", "            \"permissionId\": \"03716493619382043449\",", "            \"emailAddress\": \"imkushagra@gmail.com\"", "           },", "           \"editable\": True,", "           \"copyable\": False,", "           \"writersCanShare\": True,", "           \"shared\": False,", "           \"appDataContents\": False", "          },", "          {", "", "           \"kind\": \"drive#file\",", "           \"id\": \"0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "           \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "           \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "           \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJZmR5aUdSOEE3NGs&usp=drivesdk\",", "           \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "           \"title\": \"Books\",", "           \"mimeType\": \"application/vnd.google-apps.folder\",", "           \"labels\": {", "            \"starred\": False,", "            \"hidden\": False,", "            \"trashed\": False,", "            \"restricted\": False,", "            \"viewed\": True", "           },", "           \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "           \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "           \"lastViewedByMeDate\": \"2015-02-11T20:49:41.953Z\",", "           \"markedViewedByMeDate\": \"2014-12-09T15:02:15.658Z\",", "           \"version\": \"20900\",", "           \"parents\": [", "            {", "", "             \"kind\": \"drive#parentReference\",", "             \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZmR5aUdSOEE3NGs/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"isRoot\": False", "            }", "           ],", "           \"userPermission\": {", "            \"kind\": \"drive#permission\",", "            \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/wzYm9ul81FtNlP5K2MjdX4M4Z6k\\\"\",", "            \"id\": \"me\",", "            \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZmR5aUdSOEE3NGs/permissions/me\",", "            \"role\": \"owner\",", "            \"type\": \"user\"", "           },", "           \"quotaBytesUsed\": \"0\",", "           \"ownerNames\": [", "            \"Kushagra Gupta\"", "           ],", "           \"owners\": [", "            {", "             \"kind\": \"drive#user\",", "             \"displayName\": \"Kushagra Gupta\",", "             \"picture\": {", "              \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "             },", "             \"isAuthenticatedUser\": True,", "             \"permissionId\": \"03716493619382043449\",", "             \"emailAddress\": \"imkushagra@gmail.com\"", "            }", "           ],", "           \"lastModifyingUserName\": \"Kushagra Gupta\",", "           \"lastModifyingUser\": {", "            \"kind\": \"drive#user\",", "            \"displayName\": \"Kushagra Gupta\",", "            \"picture\": {", "             \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "            },", "            \"isAuthenticatedUser\": True,", "            \"permissionId\": \"03716493619382043449\",", "            \"emailAddress\": \"imkushagra@gmail.com\"", "           },", "           \"editable\": True,", "           \"copyable\": False,", "           \"writersCanShare\": True,", "           \"shared\": False,", "           \"appDataContents\": False", "          },", "          {", "", "           \"kind\": \"drive#file\",", "           \"id\": \"0B8IkoNBph4qJYmRhRWg3Xy05MzQ\",", "           \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "           \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ\",", "           \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJYmRhRWg3Xy05MzQ&usp=drivesdk\",", "           \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "           \"title\": \"Cover Letters\",", "           \"mimeType\": \"application/vnd.google-apps.folder\",", "           \"labels\": {", "            \"starred\": False,", "            \"hidden\": False,", "            \"trashed\": False,", "            \"restricted\": False,", "            \"viewed\": True", "           },", "           \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "           \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "           \"lastViewedByMeDate\": \"2014-10-03T15:09:47.550Z\",", "           \"markedViewedByMeDate\": \"2014-10-03T15:09:45.880Z\",", "           \"version\": \"15023\",", "           \"parents\": [", "            {", "", "             \"kind\": \"drive#parentReference\",", "             \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"isRoot\": False", "            }", "           ],", "           \"userPermission\": {", "            \"kind\": \"drive#permission\",", "            \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/BUcqbw0gcvz6B3GMqvXvGvdGS-w\\\"\",", "            \"id\": \"me\",", "            \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ/permissions/me\",", "            \"role\": \"owner\",", "            \"type\": \"user\"", "           },", "           \"quotaBytesUsed\": \"0\",", "           \"ownerNames\": [", "            \"Kushagra Gupta\"", "           ],", "           \"owners\": [", "            {", "             \"kind\": \"drive#user\",", "             \"displayName\": \"Kushagra Gupta\",", "             \"picture\": {", "              \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "             },", "             \"isAuthenticatedUser\": True,", "             \"permissionId\": \"03716493619382043449\",", "             \"emailAddress\": \"imkushagra@gmail.com\"", "            }", "           ],", "           \"lastModifyingUserName\": \"Kushagra Gupta\",", "           \"lastModifyingUser\": {", "            \"kind\": \"drive#user\",", "            \"displayName\": \"Kushagra Gupta\",", "            \"picture\": {", "             \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "            },", "            \"isAuthenticatedUser\": True,", "            \"permissionId\": \"03716493619382043449\",", "            \"emailAddress\": \"imkushagra@gmail.com\"", "           },", "           \"editable\": True,", "           \"copyable\": False,", "           \"writersCanShare\": True,", "           \"shared\": False,", "           \"appDataContents\": False", "          },", "          {", "", "           \"kind\": \"drive#file\",", "           \"id\": \"0B8IkoNBph4qJYmRhRWg3Xy05MzQ\",", "           \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "           \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ\",", "           \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJYmRhRWg3Xy05MzQ&usp=drivesdk\",", "           \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "           \"title\": \"Cover Letters\",", "           \"mimeType\": \"application/vnd.google-apps.folder\",", "           \"labels\": {", "            \"starred\": False,", "            \"hidden\": False,", "            \"trashed\": False,", "            \"restricted\": False,", "            \"viewed\": True", "           },", "           \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "           \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "           \"lastViewedByMeDate\": \"2014-10-03T15:09:47.550Z\",", "           \"markedViewedByMeDate\": \"2014-10-03T15:09:45.880Z\",", "           \"version\": \"15023\",", "           \"parents\": [", "            {", "", "             \"kind\": \"drive#parentReference\",", "             \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "             \"isRoot\": False", "            }", "           ],", "           \"userPermission\": {", "            \"kind\": \"drive#permission\",", "            \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/BUcqbw0gcvz6B3GMqvXvGvdGS-w\\\"\",", "            \"id\": \"me\",", "            \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ/permissions/me\",", "            \"role\": \"owner\",", "            \"type\": \"user\"", "           },", "           \"quotaBytesUsed\": \"0\",", "           \"ownerNames\": [", "            \"Kushagra Gupta\"", "           ],", "           \"owners\": [", "            {", "             \"kind\": \"drive#user\",", "             \"displayName\": \"Kushagra Gupta\",", "             \"picture\": {", "              \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "             },", "             \"isAuthenticatedUser\": True,", "             \"permissionId\": \"03716493619382043449\",", "             \"emailAddress\": \"imkushagra@gmail.com\"", "            }", "           ],", "           \"lastModifyingUserName\": \"Kushagra Gupta\",", "           \"lastModifyingUser\": {", "            \"kind\": \"drive#user\",", "            \"displayName\": \"Kushagra Gupta\",", "            \"picture\": {", "             \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "            },", "            \"isAuthenticatedUser\": True,", "            \"permissionId\": \"03716493619382043449\",", "            \"emailAddress\": \"imkushagra@gmail.com\"", "           },", "           \"editable\": True,", "           \"copyable\": False,", "           \"writersCanShare\": True,", "           \"shared\": False,", "           \"appDataContents\": False", "          }", "         ]", "        }", "", "mock_root_folders = {", " \"kind\": \"drive#fileList\",", " \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/8uR2e44OlkttLETnPe12RbBieXY\\\"\",", " \"selfLink\": \"https://www.googleapis.com/drive/v2/files?q=trashed%3DFalse+and+mimeType%3D'application/vnd.google-apps.folder'\",", " \"items\": [", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJZUViX241ZElCMG8\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxNzQxMDI0MzUwMQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8\",", "   \"webViewLink\": \"https://bbdd96037ece2445fdea4be607098721910701c6.googledrive.com/host/0B8IkoNBph4qJZUViX241ZElCMG8/\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJZUViX241ZElCMG8&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Public\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-10-09T00:49:50.281Z\",", "   \"modifiedDate\": \"2014-12-01T05:04:03.501Z\",", "   \"modifiedByMeDate\": \"2014-12-01T05:04:03.501Z\",", "   \"lastViewedByMeDate\": \"2015-02-10T18:56:54.433Z\",", "   \"markedViewedByMeDate\": \"2014-12-12T21:28:11.642Z\",", "   \"version\": \"20826\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0AMIkoNBph4qJUk9PVA\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8/parents/0AMIkoNBph4qJUk9PVA\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0AMIkoNBph4qJUk9PVA\",", "     \"isRoot\": True", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/kmjw_Z1znm9oW6hGq2UNvnLDC-Q\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJRlltcThyQ2tqdVE\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxNzQxMDI0MzUwMQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRlltcThyQ2tqdVE\",", "   \"webViewLink\": \"https://d7c92b972d893e03482edf5a2a8cddf38f365434.googledrive.com/host/0B8IkoNBph4qJRlltcThyQ2tqdVE/\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJRlltcThyQ2tqdVE&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"2048 Scramble Latest\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-12-01T05:03:26.996Z\",", "   \"modifiedDate\": \"2014-12-01T05:04:03.501Z\",", "   \"modifiedByMeDate\": \"2014-12-01T05:04:03.501Z\",", "   \"lastViewedByMeDate\": \"2015-02-10T20:36:38.980Z\",", "   \"markedViewedByMeDate\": \"2014-12-01T05:04:05.209Z\",", "   \"version\": \"20835\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRlltcThyQ2tqdVE/parents/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/9_lNg95yseaAoLRBC2BARhAT-gM\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRlltcThyQ2tqdVE/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJUXJFemUzWnZqa3c\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMzgxODgzNjc5MQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJUXJFemUzWnZqa3c\",", "   \"webViewLink\": \"https://3b0a85d7691f3d3faa8a9933374d5d17e9eb0960.googledrive.com/host/0B8IkoNBph4qJUXJFemUzWnZqa3c/\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJUXJFemUzWnZqa3c&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"2048 Scramble\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-10-20T15:27:16.791Z\",", "   \"modifiedDate\": \"2014-10-20T15:27:16.791Z\",", "   \"lastViewedByMeDate\": \"2015-02-10T18:56:46.397Z\",", "   \"markedViewedByMeDate\": \"2014-12-12T21:28:21.672Z\",", "   \"version\": \"20825\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJUXJFemUzWnZqa3c/parents/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/sMePGeebO5xrKOychfn0vwICgsY\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJUXJFemUzWnZqa3c/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJdEI3aFE1Q0VOZGM\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMjk4NzA0NTA2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJdEI3aFE1Q0VOZGM\",", "   \"webViewLink\": \"https://9e85300c8fd328bdb5c418bcfb1d30f57c569dbf.googledrive.com/host/0B8IkoNBph4qJdEI3aFE1Q0VOZGM/\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJdEI3aFE1Q0VOZGM&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Bull Shit 2.0\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-10-11T00:23:45.045Z\",", "   \"modifiedDate\": \"2014-10-11T00:24:05.060Z\",", "   \"modifiedByMeDate\": \"2014-10-11T00:24:05.060Z\",", "   \"lastViewedByMeDate\": \"2014-10-11T00:44:58.712Z\",", "   \"markedViewedByMeDate\": \"2014-10-11T00:26:56.895Z\",", "   \"version\": \"15564\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJdEI3aFE1Q0VOZGM/parents/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/bNAw5veeD5hKEJlvgqCFVFOXfR8\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJdEI3aFE1Q0VOZGM/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJdjF3X3JwN0FULWs\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMjk4NjQxODM5NQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJdjF3X3JwN0FULWs\",", "   \"webViewLink\": \"https://28fcf424d5c6758c1445177231408fdba004ac52.googledrive.com/host/0B8IkoNBph4qJdjF3X3JwN0FULWs/\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJdjF3X3JwN0FULWs&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Bull Shit OG\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-10-11T00:13:38.395Z\",", "   \"modifiedDate\": \"2014-10-11T00:13:38.395Z\",", "   \"lastViewedByMeDate\": \"2014-10-11T00:43:23.875Z\",", "   \"markedViewedByMeDate\": \"2014-10-11T00:43:23.767Z\",", "   \"version\": \"15561\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJdjF3X3JwN0FULWs/parents/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/lHDS1-kQ0_TREn-4q9UcDmo7_zs\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJdjF3X3JwN0FULWs/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJa0FXdEFjOUtxaGM\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMjgxNzIwNDE0MQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJa0FXdEFjOUtxaGM\",", "   \"webViewLink\": \"https://f352b1e47ebdd6d341da10a6750987da1b6d6a96.googledrive.com/host/0B8IkoNBph4qJa0FXdEFjOUtxaGM/\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJa0FXdEFjOUtxaGM&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Time is of the Essence\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-10-09T01:13:24.141Z\",", "   \"modifiedDate\": \"2014-10-09T01:13:24.141Z\",", "   \"lastViewedByMeDate\": \"2015-02-10T01:33:55.038Z\",", "   \"markedViewedByMeDate\": \"2014-10-09T01:13:29.042Z\",", "   \"version\": \"20807\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJa0FXdEFjOUtxaGM/parents/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/pzSVU8sfqoU7xxSQruQx_-6djGE\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJa0FXdEFjOUtxaGM/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJd25GRmplRE8tQmM\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMjgxNzE5MjM3NA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJd25GRmplRE8tQmM\",", "   \"webViewLink\": \"https://3069594c5ab7c04bc3d6d93cbf53824a16117798.googledrive.com/host/0B8IkoNBph4qJd25GRmplRE8tQmM/\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJd25GRmplRE8tQmM&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Celestial Ladder\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-10-09T01:08:51.778Z\",", "   \"modifiedDate\": \"2014-10-09T01:13:12.374Z\",", "   \"modifiedByMeDate\": \"2014-10-09T01:13:12.374Z\",", "   \"lastViewedByMeDate\": \"2014-10-10T04:04:04.748Z\",", "   \"markedViewedByMeDate\": \"2014-10-10T04:04:10.842Z\",", "   \"version\": \"15474\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJd25GRmplRE8tQmM/parents/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZUViX241ZElCMG8\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/nQ-eWxv2mgT1WFkxlr-AwBHfdHQ\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJd25GRmplRE8tQmM/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJV3F3TTFiai1ZT2M\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMjgxNTQzNDU0Mw\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJV3F3TTFiai1ZT2M\",", "   \"webViewLink\": \"https://c99f331e1529eb073bc9e05258789a78f2e4f945.googledrive.com/host/0B8IkoNBph4qJV3F3TTFiai1ZT2M/\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJV3F3TTFiai1ZT2M&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Test Unity Web\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-10-08T23:20:24.147Z\",", "   \"modifiedDate\": \"2014-10-09T00:43:54.543Z\",", "   \"lastViewedByMeDate\": \"2014-10-08T23:20:28.961Z\",", "   \"markedViewedByMeDate\": \"2014-10-08T23:20:29.104Z\",", "   \"version\": \"15140\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJRW5wVzctSzRmdlk\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJV3F3TTFiai1ZT2M/parents/0B8IkoNBph4qJRW5wVzctSzRmdlk\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRW5wVzctSzRmdlk\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/_Vxv6-xKgkszEawVh0pdH3FKjKA\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJV3F3TTFiai1ZT2M/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJRW5wVzctSzRmdlk\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMjgxMDQyNDE0Nw\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRW5wVzctSzRmdlk\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJRW5wVzctSzRmdlk&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"myGames\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-10-08T23:20:24.147Z\",", "   \"modifiedDate\": \"2014-10-08T23:20:24.147Z\",", "   \"lastViewedByMeDate\": \"2015-02-11T20:29:23.107Z\",", "   \"markedViewedByMeDate\": \"2015-02-04T18:59:43.738Z\",", "   \"version\": \"20880\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0AMIkoNBph4qJUk9PVA\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRW5wVzctSzRmdlk/parents/0AMIkoNBph4qJUk9PVA\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0AMIkoNBph4qJUk9PVA\",", "     \"isRoot\": True", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/UJJrJdw690qJqLy1LDemFACIaBI\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJRW5wVzctSzRmdlk/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJenVUSDAxRFdjY1k\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJenVUSDAxRFdjY1k&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Cracking the Coding Interview 150 Programming Interview Questions and Solutions\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "   \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "   \"lastViewedByMeDate\": \"2015-02-11T20:21:26.803Z\",", "   \"markedViewedByMeDate\": \"2015-02-05T04:22:49.252Z\",", "   \"version\": \"20861\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJenVUSDAxRFdjY1k/parents/0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/eh6r2G4xkGUDTYfB6q7pgu2BRU8\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJenVUSDAxRFdjY1k/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJeWlDanNYbm9LT2c&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Jobs\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "   \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "   \"lastViewedByMeDate\": \"2015-02-15T01:07:58.872Z\",", "   \"markedViewedByMeDate\": \"2014-12-09T15:02:11.855Z\",", "   \"version\": \"20983\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJYkJ4OHVqUnVHZFE\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c/parents/0B8IkoNBph4qJYkJ4OHVqUnVHZFE\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYkJ4OHVqUnVHZFE\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/TpcVIdjyymLv1XEoMuX-aadTfJU\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJeU9OSWQtaUNwbFE\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeU9OSWQtaUNwbFE\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJeU9OSWQtaUNwbFE&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Portfolio\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "   \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "   \"lastViewedByMeDate\": \"2014-11-19T06:00:42.553Z\",", "   \"markedViewedByMeDate\": \"1970-01-01T00:00:00.000Z\",", "   \"version\": \"16982\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeU9OSWQtaUNwbFE/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/t67v37TpTJx78_ogH-jpDny1NB0\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeU9OSWQtaUNwbFE/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJZ0hORDNsbHJJSzQ\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZ0hORDNsbHJJSzQ\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJZ0hORDNsbHJJSzQ&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Resume\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "   \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "   \"lastViewedByMeDate\": \"2014-11-19T06:00:48.027Z\",", "   \"markedViewedByMeDate\": \"2014-09-27T22:55:27.484Z\",", "   \"version\": \"16983\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZ0hORDNsbHJJSzQ/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/YXBw3kpw0bgZ4tLR0hdd0JH-BlY\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZ0hORDNsbHJJSzQ/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJZmR5aUdSOEE3NGs&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Books\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "   \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "   \"lastViewedByMeDate\": \"2015-02-11T20:49:41.953Z\",", "   \"markedViewedByMeDate\": \"2014-12-09T15:02:15.658Z\",", "   \"version\": \"20900\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZmR5aUdSOEE3NGs/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/wzYm9ul81FtNlP5K2MjdX4M4Z6k\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZmR5aUdSOEE3NGs/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJYmRhRWg3Xy05MzQ\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJYmRhRWg3Xy05MzQ&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Cover Letters\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "   \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "   \"lastViewedByMeDate\": \"2014-10-03T15:09:47.550Z\",", "   \"markedViewedByMeDate\": \"2014-10-03T15:09:45.880Z\",", "   \"version\": \"15023\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ/parents/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJeWlDanNYbm9LT2c\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/BUcqbw0gcvz6B3GMqvXvGvdGS-w\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmRhRWg3Xy05MzQ/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJNi1TT0N1bC1fQzg\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NzM1MTc2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJNi1TT0N1bC1fQzg\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJNi1TT0N1bC1fQzg&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Interview\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-09-27T22:35:51.760Z\",", "   \"modifiedDate\": \"2014-09-27T22:35:51.760Z\",", "   \"lastViewedByMeDate\": \"2014-10-01T21:33:37.615Z\",", "   \"markedViewedByMeDate\": \"2014-10-01T21:33:37.701Z\",", "   \"version\": \"14995\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJNi1TT0N1bC1fQzg/parents/0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZmR5aUdSOEE3NGs\",", "     \"isRoot\": False", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/DJP0-qL_woeDJ3JTxbhCcl6CUvs\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJNi1TT0N1bC1fQzg/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJYkJ4OHVqUnVHZFE\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQxMTg1NjY5MjI0MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYkJ4OHVqUnVHZFE\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJYkJ4OHVqUnVHZFE&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Jobs\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-09-27T22:24:52.240Z\",", "   \"modifiedDate\": \"2014-09-27T22:24:52.240Z\",", "   \"lastViewedByMeDate\": \"2015-02-15T01:07:57.439Z\",", "   \"markedViewedByMeDate\": \"2014-12-09T15:02:10.595Z\",", "   \"version\": \"20980\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0AMIkoNBph4qJUk9PVA\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYkJ4OHVqUnVHZFE/parents/0AMIkoNBph4qJUk9PVA\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0AMIkoNBph4qJUk9PVA\",", "     \"isRoot\": True", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/howkWIeLED_eVsPkIGfyMteBR5Y\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYkJ4OHVqUnVHZFE/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJZTRjQ3doVVgyd00\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTQwMDI2ODIyOTAwNQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZTRjQ3doVVgyd00\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJZTRjQ3doVVgyd00&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Audio\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-05-16T19:23:49.005Z\",", "   \"modifiedDate\": \"2014-05-16T19:23:49.005Z\",", "   \"lastViewedByMeDate\": \"2015-02-05T04:42:11.890Z\",", "   \"markedViewedByMeDate\": \"2014-06-08T19:10:34.192Z\",", "   \"version\": \"20672\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0AMIkoNBph4qJUk9PVA\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZTRjQ3doVVgyd00/parents/0AMIkoNBph4qJUk9PVA\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0AMIkoNBph4qJUk9PVA\",", "     \"isRoot\": True", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/oV0KQp3QUMssQkcwVLF2jPH0GUM\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJZTRjQ3doVVgyd00/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJTk9kdVY5TkFPUFE\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTM5OTkwMzA0MTM2MA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJTk9kdVY5TkFPUFE\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJTk9kdVY5TkFPUFE&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Networking\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-05-12T13:57:01.616Z\",", "   \"modifiedDate\": \"2014-05-12T13:57:21.360Z\",", "   \"modifiedByMeDate\": \"2014-05-12T13:57:21.360Z\",", "   \"lastViewedByMeDate\": \"2015-02-07T00:02:51.465Z\",", "   \"markedViewedByMeDate\": \"2014-05-12T14:00:47.853Z\",", "   \"version\": \"20734\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0AMIkoNBph4qJUk9PVA\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJTk9kdVY5TkFPUFE/parents/0AMIkoNBph4qJUk9PVA\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0AMIkoNBph4qJUk9PVA\",", "     \"isRoot\": True", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/t9WYOCKCXgATEnxHalGCSujOTSU\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJTk9kdVY5TkFPUFE/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJYmZmdnlkOVZya2c\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTM5OTkwMzAwODA5MQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmZmdnlkOVZya2c\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJYmZmdnlkOVZya2c&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"GGP\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-04-04T17:28:17.504Z\",", "   \"modifiedDate\": \"2014-05-12T13:56:48.091Z\",", "   \"modifiedByMeDate\": \"2014-05-12T13:56:48.091Z\",", "   \"lastViewedByMeDate\": \"2015-02-05T04:42:10.509Z\",", "   \"markedViewedByMeDate\": \"2014-12-09T14:54:03.513Z\",", "   \"version\": \"20670\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0AMIkoNBph4qJUk9PVA\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmZmdnlkOVZya2c/parents/0AMIkoNBph4qJUk9PVA\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0AMIkoNBph4qJUk9PVA\",", "     \"isRoot\": True", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/8cLEy9pBzolOGqrZaUc23Tjkshw\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJYmZmdnlkOVZya2c/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJWFRLSHltcmdHRDA\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTM5NjI4MTM5MDE1NA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJWFRLSHltcmdHRDA\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJWFRLSHltcmdHRDA&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"sayname\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2014-03-31T15:56:30.154Z\",", "   \"modifiedDate\": \"2014-03-31T15:56:30.154Z\",", "   \"lastViewedByMeDate\": \"2015-02-10T01:37:17.695Z\",", "   \"markedViewedByMeDate\": \"2014-03-31T16:04:10.195Z\",", "   \"version\": \"20814\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0AMIkoNBph4qJUk9PVA\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJWFRLSHltcmdHRDA/parents/0AMIkoNBph4qJUk9PVA\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0AMIkoNBph4qJUk9PVA\",", "     \"isRoot\": True", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/v80fVSMQmUMH6oETQT1doHPqlLk\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJWFRLSHltcmdHRDA/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0B8IkoNBph4qJb1F2S3RQRVl0UzQ\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTM4ODgwNDYxMDc3OA\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJb1F2S3RQRVl0UzQ\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0B8IkoNBph4qJb1F2S3RQRVl0UzQ&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"mYgAmes\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2013-12-29T22:28:42.365Z\",", "   \"modifiedDate\": \"2014-01-04T03:03:30.778Z\",", "   \"modifiedByMeDate\": \"2014-01-04T03:03:30.778Z\",", "   \"lastViewedByMeDate\": \"2015-02-05T04:42:08.315Z\",", "   \"markedViewedByMeDate\": \"2014-12-09T15:01:02.632Z\",", "   \"version\": \"20668\",", "   \"parents\": [", "    {", "", "     \"kind\": \"drive#parentReference\",", "     \"id\": \"0AMIkoNBph4qJUk9PVA\",", "     \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJb1F2S3RQRVl0UzQ/parents/0AMIkoNBph4qJUk9PVA\",", "     \"parentLink\": \"https://www.googleapis.com/drive/v2/files/0AMIkoNBph4qJUk9PVA\",", "     \"isRoot\": True", "    }", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/HH-QLdDf9gnoAHzkGEoed1_dDRs\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0B8IkoNBph4qJb1F2S3RQRVl0UzQ/permissions/me\",", "    \"role\": \"owner\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Kushagra Gupta\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Kushagra Gupta\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": True,", "     \"permissionId\": \"03716493619382043449\",", "     \"emailAddress\": \"imkushagra@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": False,", "   \"appDataContents\": False", "  },", "  {", "", "   \"kind\": \"drive#file\",", "   \"id\": \"0Bx_h7N2n3_3VZE5RZXJGTDIyVnc\",", "   \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/MTM4MTg3ODIzNTIwMQ\\\"\",", "   \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0Bx_h7N2n3_3VZE5RZXJGTDIyVnc\",", "   \"alternateLink\": \"https://docs.google.com/folderview?id=0Bx_h7N2n3_3VZE5RZXJGTDIyVnc&usp=drivesdk\",", "   \"iconLink\": \"https://ssl.gstatic.com/docs/doclist/images/icon_11_collection_list.png\",", "   \"title\": \"Conqueror of Kingdoms\",", "   \"mimeType\": \"application/vnd.google-apps.folder\",", "   \"labels\": {", "    \"starred\": False,", "    \"hidden\": False,", "    \"trashed\": False,", "    \"restricted\": False,", "    \"viewed\": True", "   },", "   \"createdDate\": \"2013-09-27T01:06:01.911Z\",", "   \"modifiedDate\": \"2013-10-15T23:03:55.201Z\",", "   \"modifiedByMeDate\": \"2013-10-15T23:03:55.201Z\",", "   \"lastViewedByMeDate\": \"2014-03-15T19:33:16.416Z\",", "   \"markedViewedByMeDate\": \"2014-03-15T19:33:16.495Z\",", "   \"sharedWithMeDate\": \"2013-09-27T01:07:42.816Z\",", "   \"version\": \"13537\",", "   \"sharingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Rushabh Gosar\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-ZvzdgXa1w9o/AAAAAAAAAAI/AAAAAAAAIJw/3Q5za_0T_1Q/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": False,", "    \"permissionId\": \"08913471013364666999\",", "    \"emailAddress\": \"rushabh.techie@gmail.com\"", "   },", "   \"parents\": [", "   ],", "   \"userPermission\": {", "    \"kind\": \"drive#permission\",", "    \"etag\": \"\\\"zWM2D6PBtLRQKuDNbaQNSNEy5BE/24y2r0v9zEJPfjgajp3-WZ34x9Y\\\"\",", "    \"id\": \"me\",", "    \"selfLink\": \"https://www.googleapis.com/drive/v2/files/0Bx_h7N2n3_3VZE5RZXJGTDIyVnc/permissions/me\",", "    \"role\": \"writer\",", "    \"type\": \"user\"", "   },", "   \"quotaBytesUsed\": \"0\",", "   \"ownerNames\": [", "    \"Rushabh Gosar\"", "   ],", "   \"owners\": [", "    {", "     \"kind\": \"drive#user\",", "     \"displayName\": \"Rushabh Gosar\",", "     \"picture\": {", "      \"url\": \"https://lh4.googleusercontent.com/-ZvzdgXa1w9o/AAAAAAAAAAI/AAAAAAAAIJw/3Q5za_0T_1Q/s64/photo.jpg\"", "     },", "     \"isAuthenticatedUser\": False,", "     \"permissionId\": \"08913471013364666999\",", "     \"emailAddress\": \"rushabh.techie@gmail.com\"", "    }", "   ],", "   \"lastModifyingUserName\": \"Kushagra Gupta\",", "   \"lastModifyingUser\": {", "    \"kind\": \"drive#user\",", "    \"displayName\": \"Kushagra Gupta\",", "    \"picture\": {", "     \"url\": \"https://lh4.googleusercontent.com/-kZ7H558nSOU/AAAAAAAAAAI/AAAAAAAAAJY/t1Cv0o4T-Lw/s64/photo.jpg\"", "    },", "    \"isAuthenticatedUser\": True,", "    \"permissionId\": \"03716493619382043449\",", "    \"emailAddress\": \"imkushagra@gmail.com\"", "   },", "   \"editable\": True,", "   \"copyable\": False,", "   \"writersCanShare\": True,", "   \"shared\": True,", "   \"appDataContents\": False", "  }", " ]", "}", "", "def create_mock_dict(mock_dict):", "    mock_dict.__getitem__.side_effect = getitem", "    mock_dict.__setitem__.side_effect = setitem", "", "", "def getitem(key):", "    return mock_folders[key]", "", "", "def setitem(key, val):"]}, {"lines": [""]}, {"lines": ["from framework.flask import redirect  # VOL-aware redirect"]}, {"lines": ["from framework.sessions import session"]}, {"lines": ["from website.util import web_url_for"]}, {"lines": ["", "", "@must_be_logged_in"]}, {"lines": ["    \"\"\"View function that does OAuth Authorization", "    and returns access token\"\"\""]}, {"lines": ["    # Run through the OAuth flow and retrieve credentials"]}, {"lines": ["    # Store the node ID on the session in order to get the correct redirect URL", "    # upon finishing the flow"]}, {"lines": ["        flash('You have already authorized Google Drive for this account', 'warning')", "        return redirect(web_url_for('user_addons'))"]}, {"lines": [""]}, {"lines": ["    record to the user and saves the user's access token and account info.", "    \"\"\""]}, {"lines": ["    user = auth.user"]}, {"lines": ["    user.save()"]}, {"lines": ["    if code is None:", "        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": ["    user_settings.save()"]}, {"lines": ["    flash('Successfully authorized Google Drive', 'success')"]}, {"lines": ["    return redirect(web_url_for('user_addons'))", "", "", "@must_be_logged_in"]}, {"lines": ["    user_addon.clear()", "    user_addon.save()", "", ""]}, {"lines": ["    node_addon.deauthorize(auth=auth)", "    node_addon.save()"]}, {"lines": ["", ""]}, {"lines": ["    \"\"\"", "    user = auth.user"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["    node_addon.set_user_auth(user_addon)", "    node_addon.save()", "    return {", "        'result': serialize_settings(node_addon, user),", "        'message': 'Successfully imported access token from profile.',"]}, {"lines": [""]}, {"lines": ["from flask import request"]}, {"lines": ["from website.util import rubeus"]}, {"lines": [""]}, {"lines": ["    \"\"\" Returns all the subsequent folders under the folder id passed \"\"\""]}, {"lines": [""]}, {"lines": ["    return contents"]}, {"lines": [""]}, {"lines": ["    \"\"\"Return the Rubeus/HGrid-formatted response for the root folder only.\"\"\""]}, {"lines": ["    # Quit if node settings does not have authentication"]}, {"lines": ["        return None", "    node = node_settings.owner"]}, {"lines": ["    root = rubeus.build_addon_root(", "        node_settings=node_settings,"]}, {"lines": ["        permissions=auth,", "        nodeUrl=node.url,"]}, {"lines": ["        nodeApiUrl=node.api_url,"]}, {"lines": ["    )", "    return [root]"]}, {"lines": ["            <i class=\"fa fa-list\"> </i>", "            <i class=\"fa fa-angle-right\"> </i>"]}, {"lines": ["                        <i class=\"fa fa-plus-circle\"></i>"]}, {"lines": ["                    <span class=\"wiki-nav-closed\"><i class=\"fa fa-trash-o text-danger\"> </i></span>"]}, {"lines": ["                        <i class=\"fa fa-plus-circle pointer fa-lg\" data-toggle=\"tooltip\" title=\"New\" data-placement=\"left\"></i>"]}, {"lines": ["                                            <i class=\"fa fa-trash-o text-danger pointer fa-lg\" data-toggle=\"tooltip\" title=\"Delete\" data-placement=\"left\"> </i>"]}, {"lines": ["                            <i class=\"fa fa-hand-o-right\"></i>"]}, {"lines": ["    new_project = {}"]}, {"lines": ["        new_project = _view_project(project, auth)"]}, {"lines": ["        'projectUrl': project.url,"]}, {"lines": ["        'newNode': new_project['node'] if new_project else None"]}, {"lines": ["        fallback: function(){}"]}, {"lines": ["        },"]}, {"lines": ["            confirmDeauth: 'Are you sure you want to delete your Google Drive access ' +", "                'key? This will revoke access to Google Drive for all projects you have ' +", "                'authorized.',", "            deauthError: 'Could not deauthorize Google Drive at this time',", "            deauthSuccess: 'Deauthorized Google Drive.'"]}, {"lines": [""]}, {"lines": ["        icon.removeClass('fa fa-minus');", "        icon.addClass('fa fa-plus');"]}, {"lines": ["        icon.removeClass('fa fa-plus');", "        icon.addClass('fa fa-minus');"]}, {"lines": ["require('font-awesome-webpack');"]}, {"lines": ["    var up = $(this).find('.fa fa-angle-up');", "    var down = $(this).find('.fa fa-angle-down');"]}, {"lines": ["        up.removeClass('fa fa-angle-up').addClass('fa fa-angle-down');"]}, {"lines": ["        down.removeClass('fa fa-angle-down').addClass('fa fa-angle-up');"]}, {"lines": ["                        m('button.btn.osf-search-btn', m('i.fa.fa-search.fa-lg')),"]}, {"lines": ["                ctrl.vm.showStats ? m('i.fa.fa-angle-up') : m('i.fa.fa-angle-down')"]}, {"lines": ["                        <button type=button class=\"btn osf-search-btn\" data-bind=\"click: submit\"><i class=\"fa fa-circle-arrow-right fa-lg\"></i></button>", "                        <button type=button class=\"btn osf-search-btn\" data-bind=\"click: help\"><i class=\"fa fa-question fa-lg\"></i></button>"]}, {"lines": ["                        <button type=\"button\" class=\"btn osf-search-btn\" data-bind=\"visible: showClose, click : toggleSearch\"><i class=\"fa fa-times fa-lg\"></i></button>"]}, {"lines": ["        <i class=\"fa fa-comments-o fa-inverse fa-2x comment-handle-icon\" style=\"\"></i>"]}, {"lines": ["                    <a class=\"btn btn-default btn-default\" data-bind=\"click: submitReply, css: {disabled: submittingReply}\"><i class=\"fa fa-check-square-o\"></i> {{saveButtonText}}</a>", "                    <a class=\"btn btn-default btn-default\" data-bind=\"click: cancelReply, css: {disabled: submittingReply}\"><i class=\"fa fa-undo\"></i> Cancel</a>"]}, {"lines": ["                                <a class=\"btn btn-default btn-default\" data-bind=\"click: submitEdit, visible: editNotEmpty\"><i class=\"fa fa-check-square-o\"></i> Save</a>", "                                <a class=\"btn btn-default btn-default\" data-bind=\"click: cancelEdit\"><i class=\"fa fa-undo\"></i> Cancel</a>"]}, {"lines": ["                                <i class=\"fa fa-reply\"></i>"]}, {"lines": ["                                <i class=\"fa fa-warning\"></i>"]}, {"lines": ["                                <i class=\"fa fa-trash-o\"></i>"]}, {"lines": ["                        <a class=\"btn btn-danger btn-sm\" data-bind=\"click: submitAbuse\"><i class=\"fa fa-check-square-o\"></i> Report</a>", "                        <a class=\"btn btn-default btn-sm\" data-bind=\"click: cancelAbuse\"><i class=\"fa fa-undo\"></i> Cancel</a>"]}, {"lines": ["                        <a class=\"btn btn-danger btn-sm\" data-bind=\"click: submitDelete\"><i class=\"fa fa-check-square-o\"></i> Delete</a>", "                        <a class=\"btn btn-default btn-sm\" data-bind=\"click: cancelDelete\"><i class=\"fa fa-undo\"></i> Cancel</a>"]}, {"lines": ["                        <a class=\"btn btn-default btn-default\" data-bind=\"click: submitReply, visible: replyNotEmpty, css: {disabled: submittingReply}\"><i class=\"fa fa-check-square-o\"></i> {{saveButtonText}}</a>", "                        <a class=\"btn btn-default btn-default\" data-bind=\"click: cancelReply, css: {disabled: submittingReply}\"><i class=\"fa fa-undo\"></i> Cancel</a>"]}, {"lines": ["                        <i class=\"fa fa-times text-danger\" title=\"Deauthorize Project\"></i>"]}, {"lines": ["          | <a href=\"${ meeting['info_url'] }\" target=\"_blank\">Conference homepage <i class=\"fa fa-sm fa fa-external-link\"></i></a>"]}, {"lines": ["              <i class=\"fa fa-link\" data-toggle=\"tooltip\" title=\"Linked ${summary['node_type']}\"></i>"]}, {"lines": ["                <span class=\"fa fa-lock\" data-toggle=\"tooltip\" title=\"This project is private\"></span>"]}, {"lines": ["                    <i class=\"fa fa-times remove-pointer\" data-id=\"${summary['id']}\" data-toggle=\"tooltip\" title=\"Remove link\"></i>", "                    <i class=\"fa fa-code-fork\" onclick=\"NodeActions.forkPointer('${summary['id']}', '${summary['primary_id']}');\" data-toggle=\"tooltip\" title=\"Fork this ${summary['node_type']} into ${node['node_type']} ${node['title']}\"></i>"]}, {"lines": ["                <i id=\"icon-${summary['id']}\" class=\"pointer fa fa-plus\" onclick=\"NodeActions.openCloseNode('${summary['id']}');\" data-toggle=\"tooltip\" title=\"More\"></i>"]}], "name": "kushG"}, {"commits": [{"lines": ["from raven.contrib.django.raven_compat.models import sentry_exception_handler"]}, {"lines": [""]}, {"lines": ["from framework.transactions import commands, messages, utils"]}, {"lines": ["        sentry_exception_handler(request=request)"]}, {"lines": ["    url(base_pattern,", "        include(patterns('',", "                         url(r'^$', views.root),", "                         url(r'^nodes/', include('api.nodes.urls', namespace='nodes')),", "                         url(r'^users/', include('api.users.urls', namespace='users')),", "                         url(r'^docs/', include('rest_framework_swagger.urls')),", "                         ))", "        )", "]", "", "urlpatterns += static('/static/', document_root=settings.STATIC_ROOT)"]}, {"lines": ["from rest_framework import authentication"]}, {"lines": ["from framework.auth import cas", "from framework.sessions.model import Session", "from framework.auth.core import User, get_user", "from website import settings", "", ""]}, {"lines": [""]}, {"lines": ["class OSFCASAuthentication(authentication.BaseAuthentication):", "    \"\"\"Check whether the user provides a valid OAuth2 bearer token\"\"\""]}, {"lines": [""]}, {"lines": ["    def authenticate(self, request):", "        client = cas.get_client()  # Returns a CAS server client"]}, {"lines": ["        try:"]}, {"lines": ["            auth_header_field = request.META[\"HTTP_AUTHORIZATION\"]"]}, {"lines": ["            auth_token = cas.parse_auth_header(auth_header_field)"]}, {"lines": ["        except (cas.CasTokenError, KeyError):", "            return None  # If no token in header, then this method is not applicable"]}, {"lines": [""]}, {"lines": ["        # Found a token; query CAS for the associated user id"]}, {"lines": ["        try:", "            resp = client.profile(auth_token)", "        except cas.CasHTTPError:", "            raise exceptions.NotAuthenticated('User provided an invalid OAuth2 access token')", ""]}, {"lines": ["        if resp.authenticated is False:", "            raise exceptions.NotAuthenticated('CAS server failed to authenticate this token')", "", "        user_id = resp.user", "        user = User.load(user_id)", "        if user is None:", "            raise exceptions.AuthenticationFailed(\"Could not find the user associated with this token\")", "", "        return user, auth_token", "", "    def authenticate_header(self, request):", "        return \"\""]}, {"lines": ["    'raven.contrib.django.raven_compat',"]}, {"lines": ["# TODO: Are there more granular ways to configure reporting specifically related to the API?", "RAVEN_CONFIG = {", "    'dsn': osf_settings.SENTRY_DSN", "}", ""]}, {"lines": ["        'api.base.authentication.drf.OSFCASAuthentication'"]}, {"lines": ["    # process_request to be skipped, e.g. when a trailing slash is omitted"]}, {"lines": ["API_PREFIX = '{}/{}'.format(API_PATH, API_BASE)", "STATIC_URL = '{}static/'.format(API_PREFIX)"]}, {"lines": ["}"]}, {"lines": ["    def test_register_scrubs_username(self):", "        \"\"\"Usernames are scrubbed of malicious HTML when registering\"\"\"", "        url = api_url_for('register_user')", "        name = \"<i>Eunice</i> O' \\\"Cornwallis\\\"<script type='text/javascript' src='http://www.cornify.com/js/cornify.js'></script><script type='text/javascript'>cornify_add()</script>\"", "        email, password = fake.email(), 'underpressure'", "        res = self.app.post_json(", "            url,", "            {", "                'fullName': name,", "                'email1': email,", "                'email2': email,", "                'password': password,", "            }", "        )", "", "        expected_scrub_username = \"Eunice O' \\\"Cornwallis\\\"cornify_add()\"", "        user = User.find_one(Q('username', 'eq', email))", "", "        assert_equal(res.status_code, http.OK)", "        assert_equal(user.fullname, expected_scrub_username)", ""]}, {"lines": ["\"\"\"", "Tests related to authenticating API requests", "\"\"\"", "", "import mock", "", "from nose.tools import *  # flake8: noqa", "", "from framework.auth import cas", "from tests.base import ApiTestCase", "from tests.factories import ProjectFactory, UserFactory", ""]}, {"lines": ["from api.base.settings import API_BASE", ""]}, {"lines": ["", "class TestOAuthValidation(ApiTestCase):", "    \"\"\"Test that OAuth2 requests can be validated\"\"\"", "    def setUp(self):", "        super(TestOAuthValidation, self).setUp()", "        self.user1 = UserFactory()", "        self.user2 = UserFactory()", "", "        # Test projects for which a given user DOES and DOES NOT  have appropriate permissions", "        self.reachable_project = ProjectFactory(title=\"Private Project User 1\", is_public=False, creator=self.user1)", "        self.unreachable_project = ProjectFactory(title=\"Private Project User 2\", is_public=False, creator=self.user2)", ""]}, {"lines": ["        self.reachable_url = \"/{}nodes/{}/\".format(API_BASE, self.reachable_project._id)", "        self.unreachable_url = \"/{}nodes/{}/\".format(API_BASE, self.unreachable_project._id)"]}, {"lines": [""]}, {"lines": ["    def test_missing_token_fails(self):"]}, {"lines": ["        assert_equal(res.status_code, 403)", "        assert_equal(res.json.get(\"detail\"),", "                     'Authentication credentials were not provided.')", "", "    @mock.patch('framework.auth.cas.CasClient.profile')", "    def test_invalid_token_fails(self, mock_user_info):", "        mock_user_info.return_value = cas.CasResponse(authenticated=False, user=None)", ""]}, {"lines": ["        assert_equal(res.status_code, 403, msg=res.json)", "", "    @mock.patch('framework.auth.cas.CasClient.profile')", "    def test_valid_token_returns_unknown_user_thus_fails(self, mock_user_info):", "        mock_user_info.return_value = cas.CasResponse(authenticated=True, user='fail')", ""]}, {"lines": ["        assert_equal(res.status_code, 403, msg=res.json)", "", "    @mock.patch('framework.auth.cas.CasClient.profile')", "    def test_valid_token_authenticates_and_has_permissions(self, mock_user_info):", "        mock_user_info.return_value = cas.CasResponse(authenticated=True, user=self.user1._id)", ""]}, {"lines": ["        assert_equal(res.status_code, 200, msg=res.json)", "", "    @mock.patch('framework.auth.cas.CasClient.profile')", "    def test_valid_token_authenticates_but_user_lacks_permissions(self, mock_user_info):", "        mock_user_info.return_value = cas.CasResponse(authenticated=True, user=self.user1._id)", ""]}, {"lines": ["        assert_equal(res.status_code, 403, msg=res.json)"]}, {"lines": ["        'api_v2_url': util.api_v2_url,  # URL function for templates", "        'api_v2_base': util.api_v2_url(''),  # Base url used by JS api helper"]}, {"lines": ["", "    describe('apiV2Url', () => {", "        it('returns correctly formatted URLs for described inputs', () => {", "            var fullUrl = $osf.apiV2Url('/nodes/abcd3/contributors/',"]}, {"lines": ["                {prefix: 'http://localhost:8000/v2/'});"]}, {"lines": ["", "            // No double slashes when apiPrefix and pathString have adjoining slashes"]}, {"lines": ["            fullUrl = $osf.apiV2Url('nodes/abcd3/contributors/',", "                {prefix: 'http://localhost:8000/v2/'});"]}, {"lines": ["", "            // User is still responsible for the trailing slash. If they omit it, it doesn't appear at end of URL"]}, {"lines": ["            fullUrl = $osf.apiV2Url('/nodes/abcd3/contributors',", "                {prefix: 'http://localhost:8000/v2/'});"]}, {"lines": ["", "            // Correctly handles- and encodes- URLs with parameters", "            fullUrl = $osf.apiV2Url('/nodes/abcd3/contributors/',"]}, {"lines": ["                {query:", "                    {'filter[fullname]': 'bob', 'page_size':10},", "                prefix: 'https://staging2.osf.io/api/v2/'});"]}, {"lines": ["", "            // Given a blank string, should return the base path (domain + port + prefix) with no extra cruft at end"]}, {"lines": ["            fullUrl = $osf.apiV2Url('',", "                {prefix: 'http://localhost:8000/v2/'});"]}, {"lines": ["        });", "    });", "", ""]}, {"lines": ["                cookieName: '${cookie_name}',", "                apiV2Prefix: '${api_v2_base | js_str }'"]}, {"lines": ["def api_v2_url(path_str,", "               params=None,"]}, {"lines": ["               **kwargs):", "    \"\"\"", "    Convenience function for APIv2 usage: Concatenates parts of the absolute API url based on arguments provided", "", "    For example: given path_str = '/nodes/abcd3/contributors/' and params {'filter[fullname]': 'bob'},", "        this function would return the following on the local staging environment:", "        'http://localhost:8000/nodes/abcd3/contributors/?filter%5Bfullname%5D=bob'", "", "    This is NOT a full lookup function. It does not verify that a route actually exists to match the path_str given.", "    \"\"\"", "    params = params or {}  # Optional params dict for special-character param names, eg filter[fullname]", "", "    base_url = furl.furl(base_route + base_prefix)", "    sub_url = furl.furl(path_str)", "", "    base_url.path.add(sub_url.path.segments)", "", "    base_url.args.update(params)", "    base_url.args.update(kwargs)", "    return str(base_url)", "", ""]}], "name": "Andy Boughton"}, {"commits": [{"lines": ["        parent_node = Node.load(request.parser_context['kwargs']['node_id'])"]}, {"lines": ["    url(r'^(?P<node_id>\\w+)/$', views.NodeDetail.as_view(), name='node-detail'),", "    url(r'^(?P<node_id>\\w+)/contributors/$', views.NodeContributorsList.as_view(), name='node-contributors'),", "    url(r'^(?P<node_id>\\w+)/registrations/$', views.NodeRegistrationsList.as_view(), name='node-registrations'),", "    url(r'^(?P<node_id>\\w+)/children/$', views.NodeChildrenList.as_view(), name='node-children'),", "    url(r'^(?P<node_id>\\w+)/pointers/$', views.NodePointersList.as_view(), name='node-pointers'),", "    url(r'^(?P<node_id>\\w+)/files/$', views.NodeFilesList.as_view(), name='node-files'),", "    url(r'^(?P<node_id>\\w+)/pointers/(?P<pointer_id>\\w+)', views.NodePointerDetail.as_view(), name='node-pointer-detail'),"]}, {"lines": ["", "    url(r'^(?P<user_id>\\w+)/$', views.UserDetail.as_view(), name='user-detail'),", "    url(r'^(?P<user_id>\\w+)/nodes/$', views.UserNodes.as_view(), name='user-nodes'),"]}, {"lines": ["<span id=\"citations\" class=\"anchor\"></span>", "    <h4>Citations</h4>", "<p>Every project, component, file, and user has a unique URL on the OSF. This means that anything you upload", "    and make public on the OSF can be cited, giving you credit for your work.</p>", "<p>To find a pre-formatted citation for a project, look directly below the grey navigation bar on the project's", "    page and you will see the URL to be cited. If you click \"more\" then you ill see the APA, MLA, and Chicago", "    citations.</p>"]}, {"lines": ["", "<div class=\"row\">", "    <div class=\"col-md-8 col-md-offset-2\">", "        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"Ow7YoAHrflo\"></div>"]}, {"lines": ["    </div>", "</div>", ""]}, {"lines": ["<p>The OSF offers DOIs and ARKs in addition to its own unique and persistent URLs. DOIs and ARKs can only be issued", "to public <a href=\"#registrations\">registrations</a>. To be issued one of these identifiers, visit your public registration", "and click \"Create DOI/ARK\" below the project title.</p>"]}, {"lines": ["", "<div class=\"row\">", "    <div class =\"col-md-8 col-md-offset-2\">", "        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"jnbeytIkfFs\"></div>"]}, {"lines": ["    </div>"]}, {"lines": ["<span id=\"components\" class=\"anchor\"></span>", "<h4>Components</h4>", "<p>Components are like sub-projects that help you organize different parts of your research. Components have their own privacy settings, contributors, wiki, add-ons, and files.</p>"]}, {"lines": ["<p>To delete a component or project, visit its page and go to \"Settings\" in the grey navigation bar under the component's title. This will also delete that component's wiki.</p>", "<p>A particular project and component structure that is useful for multiple projects can be used as a template when creating new projects.</p>", ""]}, {"lines": ["<div class=\"row\">"]}, {"lines": ["    <div class=\"col-md-8 col-md-offset-2\">"]}, {"lines": ["<span id=\"dashboards\" class=\"anchor\"></span>", "<h4>Dashboards</h4>", "<p>The Dashboard displays all of your projects and their components in the Project Organizer, and is", "    linked in the black navigation bar at the top of the page. From the Project Organizer, you can", "    open any of your projects or components by clicking on the \"open\" icon to the right of the project's name.", "    To the right of your project organizer you will find a set of widgets that make it easy to create,", "    register, and add files to your projects</p>", "<p>You can shrink or expand each project to display nested components by clicking the + or - to the", "    left of the projects name. A more detailed description of how to use the", "    <a href=\"#organizer\">Project Organizer</a> is below.</p>"]}, {"lines": ["<div class=\"row\">", "    <div class=\"col-md-8 col-md-offset-2\">"]}, {"lines": ["<span id=\"forks\" class=\"anchor\"></span>", "<h4>Forks</h4>", "<p>Forking a project means you have created a copy of it into your dashboard, and can change that copy", "    for your own purposes. You will be the only contributor to the forked project until you add others.</p>", "<p>Forks will automatically reference the original project as a functional citation. Over time, the network of", "    forks trace the evolution of project materials.</p>", "<p>To fork a project, visit the project and click the button at the top right of the page. This will give you", "    several options on how you can duplicate a project. Click \"Fork\" and a fork will be created. It is", "    important to note that the fork will contain only public components, or those for which you are a", "    contributor. Private components that you do not have access to will not be forked.</p>", "<p>A <a href=\"#links\">linked</a> project can also easily be turned into a fork. If you were originally"]}, {"lines": ["    can edit in addition to the original.</p>"]}, {"lines": ["", "<div class=\"row\">", "    <div class=\"col-md-8 col-md-offset-2\">"]}, {"lines": ["<span id=\"notifications\" class=\"anchor\"></span>", "<h4>Notifications</h4>", "<p>Notifications can be enabled for any OSF project or component. To be notified via email when a new comment", "    is added to a project or component, visit the settings page on the project. You can choose to receive an", "    email every time a comment is added or in a daily digest. You can also choose to receive email", "    notifications when someone replies to your comment on a project; configure this in your account settings.</p>"]}, {"lines": ["", "<div class=\"row\">", "    <div class=\"col-md-8 col-md-offset-2\">"]}, {"lines": ["<span id=\"privacy\" class=\"anchor\"></span>", "<h4>Privacy</h4>", "<p>All projects are private by default. However, you can choose to make your project's contents available for", "    anyone to view. Once you make a project public, you can gain more feedback about the impact of your work by", "    tracking how many people are visiting your project and downloading or forking your research materials.</p>", "<p>Components you have added can have their own privacy settings. Making the project public does not make all", "    of its components public. For example, you can make your methodology component public, but leave the data", "    in a private component.</p>"]}, {"lines": ["", "<div class=\"row\">", "    <div class=\"col-md-8 col-md-offset-2\">"]}, {"lines": ["<span id=\"registrations\" class=\"anchor\"></span>", "<h4>Registrations</h4>"]}, {"lines": ["    permanent URL that is linked to the project. Then, you can continue editing and revising the project itself.</p>"]}, {"lines": ["", "<div class=\"row\">", "    <div class=\"col-md-8 col-md-offset-2\">"]}, {"lines": ["<span id=\"userprofile\" class=\"anchor\"></span>", "<h4>User Profile</h4>", "<p>Updating your profile only takes seconds and makes using the Open Science Framework better for everyone. The OSF", "    lets you input your contact information, social media profiles, employment, and educational history so other researchers", "    can more easily discover, share, and collaborate with you.</p>", ""]}, {"lines": ["<div class=\"row\">"]}, {"lines": ["    <div class=\"col-md-8 col-md-offset-2\">", "        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"Yj2NwcdoNWc\"></div>"]}, {"lines": ["        </div>"]}, {"lines": ["    </div>"]}, {"lines": ["<h4>Collaborative Wiki</h4>", "<p>The wiki is a versatile tool for interacting with your team or the people who view your work. Each project", "    and component has a wiki and you can add more pages if you wish. For example, you might have a wiki page explaining", "    the main points of your project, but also have a wiki page with lab notes, with contact information, or with", "    more indepth detail on one aspect of your project. You can also turn the wiki off completely in the", "    \"Select Add-Ons\" section of your project settings.</p>"]}, {"lines": ["<p>The wiki supports collaborative editing. Your entire team can get online and write at the same time together.", " Furthermore, the wiki supports versioning, meaning that every time you hit save, the OSF will store a new copy of", "the wiki. You can always go back to previous versions of your wiki, and you compare your current wiki with", "    previous iterations.</p>", "<p>Here are two resources that you might find helpful for formatting your wiki with markdown and TeX:</p>", "<ul>", "    <li><a href=\"http://assemble.io/docs/Cheatsheet-Markdown.html\">Markdown</a></li>", "    <li><a href=\"http://en.wikibooks.org/wiki/LaTeX/Mathematics\">Inline Mathematics</a></li>", "</ul>"]}, {"lines": ["", "<div class=\"row\">", "    <div class=\"col-md-8 col-md-offset-2\">"]}, {"lines": ["<span id=\"box\" class=\"anchor\"></span>", "<h4>Box</h4>", "<p><a href=\"http://box.com/\">Box</a> is an online file storage program. After linking your OSF project to Box, you can", "    add files to your Box folder and those files can be accessed via the OSF. Likewise, files added to the Box folder", "    in your OSF account will update your Box account with that file.</p>", "<p>To link a Box folder to a project/component, first visit the project you want to add a Box folder to. Then go to", "    \"Settings\" in the grey navigation bar. Check \"Box\" under \"Select Add-ons\" to enable the add-on. Read, click \"OK\"", "    on the pop-up, then submit. Next, you will be asked to authenticate with Box by clicking the \"Authorize\" button.", "    Once you have said \"OK\" you can choose the folder you would like to add to your OSF project.</p>"]}, {"lines": ["<span id=\"drive\" class=\"anchor\"></span>", "<h4>Google Drive</h4>", "<p><a href=\"http://drive.google.com/\">Google Drive</a> is a popular file storage and collaboration tool. After linking", "    your OSF project to Google Drive, you will be able to access and import your Google Drive folders. Likewise, files", "    added to the Google Drive folder in your OSF account will update the folder in Google Drive. </p>", "<p>To enable, navigate to settings in your project, then navigate to \"Select Add-Ons.\"  Select Google Drive, and click", "    submit. You will be asked to give permission for the OSF to interact with Google Drive. Click \"Accept\" to create", "    your access token for your entire user account. Then navigate to \"Configure Add-Ons\" to import the access token", "    that you created in the previous step. Select \"Import Access Token\" and then select the folders you want to sync.", "    Now you will be able to find your Google Drive folder in your \"Files\" section. </p>"]}, {"lines": ["<span id=\"figshare\" class=\"anchor\"></span>", "<h4>Figshare</h4>", "<p><a href=\"http://figshare.com/\">figshare</a> is an online digital repository that allows researchers to preserve and", "    share their research outputs.</p>", "<p>Currently, the OSF only supports linking figshare projects to an OSF project-not individual files or articles.</p>", "<p>To link a figshare project to an OSF project, first visit your profile settings by clicking the gear in the top right", "    of the page. Check \"figshare\" under \"Select Add-on.\" Next, authenticate figshare by clicking \"Create Access Token\"", "    and following the instructions on the figshare website. Once you have enabled figshare in your user settings, you", "    won't need to do those previous steps again. </p>", "<p>To associate a figshare project with an OSF project, visit the project you want to add the figshare project to.", "    Go to \"Settings\" in the grey navigation bar. Select the figshare add-on under \"Select Add-ons\" and click \"OK\" on", "    the pop-up. Then, submit your new settings. Still in your project settings, now click the authorize button for", "    figshare under \"Configure Add-ons\" and then select the project you want to add.</p>"]}, {"lines": ["<span id=\"mendeley\" class=\"anchor\"></span>", "<h4>Mendeley</h4>", "<p><a href=\"http://mendeley.com/\">Mendeley</a> is a free reference and PDF manager. By Adding Mendeley to your OSF", "    projects you can view, copy, and download your citations.</p>"]}, {"lines": ["<p>First, visit the project to which you want to add Mendeley, then navigate to settings. Go to \"Select Add-Ons\", select", "    Mendeley, and then click submit. You will be asked to input your Mendeley information to create an access token.", "    Next, go to \"Configure Add-Ons\" and click \"Import Access Token.\" Now you will be able to pick which folders you", "    want to incorporate into your project. Click submit and go to your project overview page to see your new Mendeley", "    widget.</p>", "", "<div class=\"row\">"]}, {"lines": ["<span id=\"zotero\" class=\"anchor\"></span>", "<h4>Zotero</h4>", "<p><a href=\"https://www.zotero.org/\">Zotero</a> is a free tool that helps you collect, cite, share, and organize your", "    research sources. By Adding Zotero to your OSF projects you can view, copy, and download your citations.</p>", "<p>First, visit the project to which you want to add Zotero, then navigate to settings. Go to \"Select Add-Ons\", select", "    Zotero, and then click submit. You will be asked to input your zotero information to create an access token. Next,", "    go to \"Configure Add-Ons\" and click \"Import Access Token\", now you will be able to pick which folders you want to", "    incorporate into your project. Click submit, and go to your project overview page to see your new Zotero widget.</p>"]}], "name": "Patrick Gorman"}, {"commits": [{"lines": ["from django.conf.urls import url"]}, {"lines": ["from api.nodes import views", ""]}], "name": "Dawn Pattison"}, {"commits": [{"lines": ["from website.models import User", "from modularodm import Q"]}, {"lines": ["from modularodm.exceptions import ModularOdmException"]}, {"lines": ["from website.app import init_app", "import sys", "import argparse", "", "def main():", "    init_app(set_backends=True, routes=False)", "    args = parse_args()"]}, {"lines": ["        endpoint=args.endpoint,", "        name=args.name,", "        active=args.active,", "        info_url=args.info_url,", "        logo_url=args.logo_url,"]}, {"lines": ["        admins=args.admins,"]}, {"lines": ["        public_projects=args.public_projects", "    )", ""]}, {"lines": ["    try:", "        admin_users = [", "            User.find_one(Q('username', 'iexact', admin))", "            for admin in admins", "        ]", "    except ModularOdmException:"]}, {"lines": ["", "    conf = Conference(", "        endpoint=endpoint,", "        name=name,", "        active=active,", "        info_url=info_url,", "        logo_url=logo_url,"]}, {"lines": ["        admins=admin_users"]}, {"lines": ["    )"]}, {"lines": ["    try:", "        conf.save()", "    except ModularOdmException:"]}, {"lines": ["", "def parse_args():", "    parser = argparse.ArgumentParser(description='Create new conference.')", "    parser.add_argument('-e', '--endpoint', dest='endpoint', required=True)", "    parser.add_argument('--n', '--name', dest='name', required=True)", "    parser.add_argument('--active', dest='active', type=bool, default=False)", "    parser.add_argument('--i_url', '--info_url', dest='info_url')", "    parser.add_argument('--l_url', '--logo_url', dest='logo_url')"]}, {"lines": ["    parser.add_argument('--admins', dest='admins', nargs='+')"]}, {"lines": ["    parser.add_argument('--public', '--public_projects', dest='public_projects', type=bool, default=None)", "    return parser.parse_args()", ""]}, {"lines": ["if __name__ == '__main__':"]}, {"lines": [""]}, {"lines": ["MEETING_DATA = {", "    'spsp2014': {"]}, {"lines": ["        'info_url': None,", "        'logo_url': None,", "        'active': False,"]}, {"lines": ["        'public_projects': True,", "    },", "    'asb2014': {"]}, {"lines": ["        'info_url': 'http://www.sebiologists.org/meetings/talks_posters.html',", "        'logo_url': None,", "        'active': False,"]}, {"lines": ["        'public_projects': True,", "    },", "    'aps2014': {"]}, {"lines": ["        'info_url': 'http://centerforopenscience.org/aps/',", "        'logo_url': '/static/img/2014_Convention_banner-with-APS_700px.jpg',", "        'active': False,"]}, {"lines": ["        'public_projects': True,", "    },", "    'annopeer2014': {", "        'name': '#annopeer',", "        'info_url': None,", "        'logo_url': None,", "        'active': False,"]}, {"lines": ["        'public_projects': True,", "    },", "    'cpa2014': {"]}, {"lines": ["        'info_url': None,", "        'logo_url': None,", "        'active': False,"]}, {"lines": ["        'public_projects': True,", "    },", "    'filaments2014': {"]}, {"lines": ["        'info_url': None,", "        'logo_url': 'https://science.nrao.edu/science/meetings/2014/'", "                    'filamentary-structure/images/filaments2014_660x178.png',"]}, {"lines": ["        'admins': [", "            'lvonschi@nrao.edu',"]}, {"lines": ["        ],"]}, {"lines": ["        'public_projects': True,", "    },"]}, {"lines": ["}", ""]}, {"lines": ["def populate_conferences():"]}, {"lines": ["            '/api/v1/view/<meeting>/',", "            'get',"]}, {"lines": ["            json_renderer,", "        ),", "", "        Rule("]}, {"lines": ["            '/project/<pid>/get_recently_added_contributors/',", "            '/project/<pid>/node/<nid>/get_recently_added_contributors/',", "        ], 'get', project_views.contributor.get_recently_added_contributors, json_renderer),", "", "        Rule(["]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    return {'contributors': contribs}"]}, {"lines": ["/*!", " * jquery.event.drop - v 2.2", " * Copyright (c) 2010 Three Dub Media - http://threedubmedia.com", " * Open Source MIT License - http://threedubmedia.com/code/license", " */", "// Created: 2008-06-04", "// Updated: 2012-05-21", "// REQUIRES: jquery 1.7.x, event.drag 2.2", "", ";(function($){ // secure $ jQuery alias", "", "// Events: drop, dropstart, dropend", "", "// add the jquery instance method", "$.fn.drop = function( str, arg, opts ){", "\t// figure out the event type", "\tvar type = typeof str == \"string\" ? str : \"\",", "\t// figure out the event handler...", "\tfn = $.isFunction( str ) ? str : $.isFunction( arg ) ? arg : null;", "\t// fix the event type", "\tif ( type.indexOf(\"drop\") !== 0 )", "\t\ttype = \"drop\"+ type;", "\t// were options passed", "\topts = ( str == fn ? arg : opts ) || {};", "\t// trigger or bind event handler", "\treturn fn ? this.bind( type, opts, fn ) : this.trigger( type );", "};", "", "// DROP MANAGEMENT UTILITY", "// returns filtered drop target elements, caches their positions", "$.drop = function( opts ){", "\topts = opts || {};", "\t// safely set new options...", "\tdrop.multi = opts.multi === true ? Infinity :", "\t\topts.multi === false ? 1 : !isNaN( opts.multi ) ? opts.multi : drop.multi;", "\tdrop.delay = opts.delay || drop.delay;", "\tdrop.tolerance = $.isFunction( opts.tolerance ) ? opts.tolerance :", "\t\topts.tolerance === null ? null : drop.tolerance;", "\tdrop.mode = opts.mode || drop.mode || 'intersect';", "};", "", "// local refs (increase compression)", "var $event = $.event,", "$special = $event.special,", "// configure the drop special event", "drop = $.event.special.drop = {", "", "\t// these are the default settings", "\tmulti: 1, // allow multiple drop winners per dragged element", "\tdelay: 20, // async timeout delay", "\tmode: 'overlap', // drop tolerance mode", "", "\t// internal cache", "\ttargets: [],", "", "\t// the key name for stored drop data", "\tdatakey: \"dropdata\",", "", "\t// prevent bubbling for better performance", "\tnoBubble: true,", "", "\t// count bound related events", "\tadd: function( obj ){", "\t\t// read the interaction data", "\t\tvar data = $.data( this, drop.datakey );", "\t\t// count another realted event", "\t\tdata.related += 1;", "\t},", "", "\t// forget unbound related events", "\tremove: function(){", "\t\t$.data( this, drop.datakey ).related -= 1;", "\t},", "", "\t// configure the interactions", "\tsetup: function(){", "\t\t// check for related events", "\t\tif ( $.data( this, drop.datakey ) )", "\t\t\treturn;", "\t\t// initialize the drop element data", "\t\tvar data = {", "\t\t\trelated: 0,", "\t\t\tactive: [],", "\t\t\tanyactive: 0,", "\t\t\twinner: 0,", "\t\t\tlocation: {}", "\t\t};", "\t\t// store the drop data on the element", "\t\t$.data( this, drop.datakey, data );", "\t\t// store the drop target in internal cache", "\t\tdrop.targets.push( this );", "\t},", "", "\t// destroy the configure interaction", "\tteardown: function(){", "\t\tvar data = $.data( this, drop.datakey ) || {};", "\t\t// check for related events", "\t\tif ( data.related )", "\t\t\treturn;", "\t\t// remove the stored data", "\t\t$.removeData( this, drop.datakey );", "\t\t// reference the targeted element", "\t\tvar element = this;", "\t\t// remove from the internal cache", "\t\tdrop.targets = $.grep( drop.targets, function( target ){", "\t\t\treturn ( target !== element );", "\t\t});", "\t},", "", "\t// shared event handler", "\thandler: function( event, dd ){", "\t\t// local vars", "\t\tvar results, $targets;", "\t\t// make sure the right data is available", "\t\tif ( !dd )", "\t\t\treturn;", "\t\t// handle various events", "\t\tswitch ( event.type ){", "\t\t\t// draginit, from $.event.special.drag", "\t\t\tcase 'mousedown': // DROPINIT >>", "\t\t\tcase 'touchstart': // DROPINIT >>", "\t\t\t\t// collect and assign the drop targets", "\t\t\t\t$targets =  $( drop.targets );", "\t\t\t\tif ( typeof dd.drop == \"string\" )", "\t\t\t\t\t$targets = $targets.filter( dd.drop );", "\t\t\t\t// reset drop data winner properties", "\t\t\t\t$targets.each(function(){", "\t\t\t\t\tvar data = $.data( this, drop.datakey );", "\t\t\t\t\tdata.active = [];", "\t\t\t\t\tdata.anyactive = 0;", "\t\t\t\t\tdata.winner = 0;", "\t\t\t\t});", "\t\t\t\t// set available target elements", "\t\t\t\tdd.droppable = $targets;", "\t\t\t\t// activate drop targets for the initial element being dragged", "\t\t\t\t$special.drag.hijack( event, \"dropinit\", dd );", "\t\t\t\tbreak;", "\t\t\t// drag, from $.event.special.drag", "\t\t\tcase 'mousemove': // TOLERATE >>", "\t\t\tcase 'touchmove': // TOLERATE >>", "\t\t\t\tdrop.event = event; // store the mousemove event", "\t\t\t\tif ( !drop.timer )", "\t\t\t\t\t// monitor drop targets", "\t\t\t\t\tdrop.tolerate( dd );", "\t\t\t\tbreak;", "\t\t\t// dragend, from $.event.special.drag", "\t\t\tcase 'mouseup': // DROP >> DROPEND >>", "\t\t\tcase 'touchend': // DROP >> DROPEND >>", "\t\t\t\tdrop.timer = clearTimeout( drop.timer ); // delete timer", "\t\t\t\tif ( dd.propagates ){", "\t\t\t\t\t$special.drag.hijack( event, \"drop\", dd );", "\t\t\t\t\t$special.drag.hijack( event, \"dropend\", dd );", "\t\t\t\t}", "\t\t\t\tbreak;", "", "\t\t}", "\t},", "", "\t// returns the location positions of an element", "\tlocate: function( elem, index ){", "\t\tvar data = $.data( elem, drop.datakey ),", "\t\t$elem = $( elem ),", "\t\tposi = $elem.offset() || {},", "\t\theight = $elem.outerHeight(),", "\t\twidth = $elem.outerWidth(),", "\t\tlocation = {", "\t\t\telem: elem,", "\t\t\twidth: width,", "\t\t\theight: height,", "\t\t\ttop: posi.top,", "\t\t\tleft: posi.left,", "\t\t\tright: posi.left + width,", "\t\t\tbottom: posi.top + height", "\t\t};", "\t\t// drag elements might not have dropdata", "\t\tif ( data ){", "\t\t\tdata.location = location;", "\t\t\tdata.index = index;", "\t\t\tdata.elem = elem;", "\t\t}", "\t\treturn location;", "\t},", "", "\t// test the location positions of an element against another OR an X,Y coord", "\tcontains: function( target, test ){ // target { location } contains test [x,y] or { location }", "\t\treturn ( ( test[0] || test.left ) >= target.left && ( test[0] || test.right ) <= target.right", "\t\t\t&& ( test[1] || test.top ) >= target.top && ( test[1] || test.bottom ) <= target.bottom );", "\t},", "", "\t// stored tolerance modes", "\tmodes: { // fn scope: \"$.event.special.drop\" object", "\t\t// target with mouse wins, else target with most overlap wins", "\t\t'intersect': function( event, proxy, target ){", "\t\t\treturn this.contains( target, [ event.pageX, event.pageY ] ) ? // check cursor", "\t\t\t\t1e9 : this.modes.overlap.apply( this, arguments ); // check overlap", "\t\t},", "\t\t// target with most overlap wins", "\t\t'overlap': function( event, proxy, target ){", "\t\t\t// calculate the area of overlap...", "\t\t\treturn Math.max( 0, Math.min( target.bottom, proxy.bottom ) - Math.max( target.top, proxy.top ) )", "\t\t\t\t* Math.max( 0, Math.min( target.right, proxy.right ) - Math.max( target.left, proxy.left ) );", "\t\t},", "\t\t// proxy is completely contained within target bounds", "\t\t'fit': function( event, proxy, target ){", "\t\t\treturn this.contains( target, proxy ) ? 1 : 0;", "\t\t},", "\t\t// center of the proxy is contained within target bounds", "\t\t'middle': function( event, proxy, target ){", "\t\t\treturn this.contains( target, [ proxy.left + proxy.width * .5, proxy.top + proxy.height * .5 ] ) ? 1 : 0;", "\t\t}", "\t},", "", "\t// sort drop target cache by by winner (dsc), then index (asc)", "\tsort: function( a, b ){", "\t\treturn ( b.winner - a.winner ) || ( a.index - b.index );", "\t},", "", "\t// async, recursive tolerance execution", "\ttolerate: function( dd ){", "\t\t// declare local refs", "\t\tvar i, drp, drg, data, arr, len, elem,", "\t\t// interaction iteration variables", "\t\tx = 0, ia, end = dd.interactions.length,", "\t\t// determine the mouse coords", "\t\txy = [ drop.event.pageX, drop.event.pageY ],", "\t\t// custom or stored tolerance fn", "\t\ttolerance = drop.tolerance || drop.modes[ drop.mode ];", "\t\t// go through each passed interaction...", "\t\tdo if ( ia = dd.interactions[x] ){", "\t\t\t// check valid interaction", "\t\t\tif ( !ia )", "\t\t\t\treturn;", "\t\t\t// initialize or clear the drop data", "\t\t\tia.drop = [];", "\t\t\t// holds the drop elements", "\t\t\tarr = [];", "\t\t\tlen = ia.droppable.length;", "\t\t\t// determine the proxy location, if needed", "\t\t\tif ( tolerance )", "\t\t\t\tdrg = drop.locate( ia.proxy );", "\t\t\t// reset the loop", "\t\t\ti = 0;", "\t\t\t// loop each stored drop target", "\t\t\tdo if ( elem = ia.droppable[i] ){", "\t\t\t\tdata = $.data( elem, drop.datakey );", "\t\t\t\tdrp = data.location;", "\t\t\t\tif ( !drp ) continue;", "\t\t\t\t// find a winner: tolerance function is defined, call it", "\t\t\t\tdata.winner = tolerance ? tolerance.call( drop, drop.event, drg, drp )", "\t\t\t\t\t// mouse position is always the fallback", "\t\t\t\t\t: drop.contains( drp, xy ) ? 1 : 0;", "\t\t\t\tarr.push( data );", "\t\t\t} while ( ++i < len ); // loop", "\t\t\t// sort the drop targets", "\t\t\tarr.sort( drop.sort );", "\t\t\t// reset the loop", "\t\t\ti = 0;", "\t\t\t// loop through all of the targets again", "\t\t\tdo if ( data = arr[ i ] ){", "\t\t\t\t// winners...", "\t\t\t\tif ( data.winner && ia.drop.length < drop.multi ){", "\t\t\t\t\t// new winner... dropstart", "\t\t\t\t\tif ( !data.active[x] && !data.anyactive ){", "\t\t\t\t\t\t// check to make sure that this is not prevented", "\t\t\t\t\t\tif ( $special.drag.hijack( drop.event, \"dropstart\", dd, x, data.elem )[0] !== false ){", "\t\t\t\t\t\t\tdata.active[x] = 1;", "\t\t\t\t\t\t\tdata.anyactive += 1;", "\t\t\t\t\t\t}", "\t\t\t\t\t\t// if false, it is not a winner", "\t\t\t\t\t\telse", "\t\t\t\t\t\t\tdata.winner = 0;", "\t\t\t\t\t}", "\t\t\t\t\t// if it is still a winner", "\t\t\t\t\tif ( data.winner )", "\t\t\t\t\t\tia.drop.push( data.elem );", "\t\t\t\t}", "\t\t\t\t// losers...", "\t\t\t\telse if ( data.active[x] && data.anyactive == 1 ){", "\t\t\t\t\t// former winner... dropend", "\t\t\t\t\t$special.drag.hijack( drop.event, \"dropend\", dd, x, data.elem );", "\t\t\t\t\tdata.active[x] = 0;", "\t\t\t\t\tdata.anyactive -= 1;", "\t\t\t\t}", "\t\t\t} while ( ++i < len ); // loop", "\t\t} while ( ++x < end ) // loop", "\t\t// check if the mouse is still moving or is idle", "\t\tif ( drop.last && xy[0] == drop.last.pageX && xy[1] == drop.last.pageY )", "\t\t\tdelete drop.timer; // idle, don't recurse", "\t\telse  // recurse", "\t\t\tdrop.timer = setTimeout(function(){", "\t\t\t\tdrop.tolerate( dd );", "\t\t\t}, drop.delay );", "\t\t// remember event, to compare idleness", "\t\tdrop.last = drop.event;", "\t}", "", "};", "", "// share the same special event configuration with related events...", "$special.dropinit = $special.dropstart = $special.dropend = drop;", "", "})(jQuery); // confine scope"]}, {"lines": ["                            </div>"]}], "name": "jakerose27"}, {"commits": [{"lines": ["    add_conference("]}, {"lines": ["def add_conference(endpoint, name, active, admins, info_url=None,", "                    logo_url=None, public_projects=None):"]}, {"lines": ["        raise RuntimeError(\"Admin must be a current registered user on the OSF.\")"]}, {"lines": ["        raise RuntimeError(\"Conference already exists.\")"]}, {"lines": [""]}, {"lines": ["from nose.tools import *  # noqa", "from tests.base import OsfTestCase", "from tests.factories import UserFactory", "from tests.test_conferences import ConferenceFactory", "", "class TestAddConference(OsfTestCase):", "", "    def test_add_conference(self):", "        user = UserFactory()", "        add_conference('spsp2014', name='SPSP', admins=[user.username], active=True)", "", "        conf = Conference.find_one(Q('endpoint', 'eq', 'spsp2014'))", "        assert_equal(conf.name, 'SPSP')", "        assert_true(conf.active)", "        assert_in(user, conf.admins)", "", "    def test_add_conference_when_admin_user_not_registered(self):", "        with assert_raises(RuntimeError):", "            add_conference('spsp2014', name='SPSP',", "                    admins=['unregister@hotmail.com'], active=True)", "", "    def test_add_conference_when_conference_already_exists(self):", "        conf = ConferenceFactory()", "        user = UserFactory()", "", "        with assert_raises(RuntimeError):", "            add_conference(conf.endpoint, name='SPSP',", "                    admins=[user.username], active=True)", "", ""]}, {"lines": ["    main()"]}, {"lines": [""]}, {"lines": ["\"\"\"Migrate WIKI_DELETED logs that have an incorrect date."]}, {"lines": ["", "Log:", "", "    Executed on production by SL on 2014-10-06 at 23:55 EST.", "    25 NodeLog records were migrated."]}, {"lines": ["\"\"\""]}, {"lines": ["from website.app import init_app"]}, {"lines": ["from nose.tools import *   # noqa"]}, {"lines": ["    init_app(set_backends=True, routes=False)", "    count = 0"]}, {"lines": ["            count += 1"]}, {"lines": ["            print(log._id)", "            count += 1", "    print('Migrated {} logs'.format(count))"]}, {"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-", "\"\"\"Helper to get a list of all projects that are nested within another project.\"\"\"", "", "from website.project.model import Node", "from modularodm import Q", "", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory", "", "", "def find_nested_projects():"]}, {"lines": ["    return Node.find(", "            Q('__backrefs.parent.node.nodes.0', 'exists', True) &", "            Q('category', 'eq', 'project') &", "            Q('is_deleted', 'eq', False)", "    )", "    #return [node for node in Node.find()", "            #if node.category == 'project'", "            #and node.parent_node is not None]"]}, {"lines": ["", "class TestFindNestedProjects(OsfTestCase):", "", "    def test_find_nested(self):", "        project =ProjectFactory.build()", "        nested_project = ProjectFactory()", "        project.nodes.append(nested_project)", "        project.save()", "", "        result = find_nested_projects()", "        assert nested_project in result", "        assert project not in result", "", "    def test_unnested_project(self):", "        project = ProjectFactory()", "        assert project not in find_nested_projects()", ""]}, {"lines": ["    def test_deleted_projects_excluded(self):", "        project = ProjectFactory.build()", "        deleted = ProjectFactory(is_deleted=True)", "        project.nodes.append(deleted)", "        project.save()", "", "        result = find_nested_projects()", "        assert deleted not in result", ""]}, {"lines": ["", "def main():", "    result = find_nested_projects()", "    print('Number of nested projects: {0}'.format(len(results)))", "", "if __name__ == '__main__':", "    main()"]}, {"lines": ["\"\"\"Script to migrate addongithubusersettings and create and attach addongithuboauthsettings."]}, {"lines": ["", "Log:", "", "    Executed on production by SL on 2014-10-05 at 23:11 EST. 269 AddonGithubUserSettings records", "    were successfully migrated. 3 records with invalidated credentials were skipped."]}, {"lines": ["", "    Script was modified by @chennan47 to handle records with invalidated credentials by unsetting", "    the oauth_access_token, oauth_token_type, and github_user fields. Run on production by @sloria", "    on 2014-10-07 at 12:34 EST. 3 records with invalidated credentials were migrated."]}, {"lines": ["\"\"\""]}, {"lines": ["import github3"]}, {"lines": ["def do_migration(records, dry=True):"]}, {"lines": ["        # False if missing, None if field exists", "        access_token = raw_user_settings.get('oauth_access_token', False)", "        token_type = raw_user_settings.get('oauth_token_type', False)", "        github_user_name = raw_user_settings.get('github_user', False)"]}, {"lines": ["            if not dry:", "                gh = GitHub(access_token, token_type)"]}, {"lines": ["                try:", "                    github_user = gh.user()"]}, {"lines": ["                except github3.models.GitHubError:"]}, {"lines": ["                    continue", ""]}, {"lines": ["", "                oauth_settings = AddonGitHubOauthSettings()", "                oauth_settings.github_user_id = str(github_user.id)", "                oauth_settings.save()", "                oauth_settings.oauth_access_token = access_token", "                oauth_settings.oauth_token_type = token_type", "                oauth_settings.github_user_name = github_user_name", "                oauth_settings.save()", "", "                AddonGitHubUserSettings._storage[0].store.update(", "                    {'_id': raw_user_settings['_id']},", "                    {", "                        '$unset': {", "                            'oauth_access_token': True,", "                            'oauth_token_type': True,", "                            'github_user': True,", "                        },", "                        '$set': {", "                            'oauth_settings': oauth_settings.github_user_id,", "                        }"]}, {"lines": ["                )", "", "                AddonGitHubOauthSettings._storage[0].store.update(", "                    {'github_user_id': oauth_settings.github_user_id},", "                    {", "                        '$push': {", "                            '__backrefs.accessed.addongithubusersettings.oauth_settings': raw_user_settings['_id'],", "                        }"]}, {"lines": ["                )", "                print('Finished migrating AddonGithubUserSettings record: {}'.format(raw_user_settings['_id']))", "            count += 1"]}, {"lines": ["        # Old fields have not yet been unset"]}, {"lines": ["        elif None in set([access_token, token_type, github_user_name]):"]}, {"lines": ["            if not dry:", "                AddonGitHubUserSettings._storage[0].store.update(", "                    {'_id': raw_user_settings['_id']},", "                    {", "                        '$unset': {", "                            'oauth_access_token': True,", "                            'oauth_token_type': True,", "                            'github_user': True,", "                        },", "                    }", "                )", "                print('Unset oauth_access_token and oauth_token_type: {0}'.format(raw_user_settings['_id']))", "            count += 1", ""]}, {"lines": [""]}, {"lines": ["    print(\"Total migrated records: {}\".format(n_migrated))"]}, {"lines": ["", "", "NOTE: This is a one-time migration.", "", "Log:", "", "    Run by sloria on production on 2014-10-16 at 16:00 EST. 15 nodes were migrated", "    which include only the RPP and forks of the RPP, as expected. Verified that the", "    affected files are now accessible."]}, {"lines": ["#!/usr/bin/env python", "# encoding: utf-8"]}, {"lines": ["", "from modularodm import Q"]}, {"lines": ["from modularodm.exceptions import ModularOdmException"]}, {"lines": ["", "from framework.auth.core import User"]}, {"lines": ["from website.app import init_app"]}, {"lines": ["", "def main():", "    init_app(set_backends=True, routes=False)", "    populate_conferences()"]}, {"lines": ["        'admins': [],"]}, {"lines": ["        'admins': [],"]}, {"lines": ["        'admins': [],"]}, {"lines": ["        'admins': [],"]}, {"lines": ["        'admins': [],"]}, {"lines": ["    for meeting, attrs in MEETING_DATA.iteritems():"]}, {"lines": ["        admin_emails = attrs.pop('admins')", "        admin_objs = []", "        for email in admin_emails:", "            try:", "                user = User.find_one(Q('username', 'iexact', email))", "                admin_objs.append(user)", "            except ModularOdmException:", "                raise RuntimeError('Username {0!r} is not registered.'.format(email))"]}, {"lines": ["        try:"]}, {"lines": ["            conf.save()", "        except ModularOdmException:"]}, {"lines": ["", "", "if __name__ == '__main__':", "    main()"]}, {"lines": ["", "Log:", "", "    Performed on production by sloria on 2014-08-19 at 4:55PM (EST). 2008 projects", "    without the OSF File Storage Addon were migrated. 2 projects without the", "    OSF Wiki addon were migrated."]}, {"lines": ["from nose.tools import *  # noqa (PEP8 asserts)"]}, {"lines": ["        affected_nodes = list(get_affected_nodes(self.db, AddonWikiNodeSettings))"]}, {"lines": ["        assert_in(affected_node, affected_nodes)", "        assert_not_in(unaffected_node, affected_nodes)"]}, {"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-"]}, {"lines": ["::"]}, {"lines": ["    $ python -m scripts.consistency.fix_duplicate_addons"]}, {"lines": ["", "", "Performed on production by SL on 2014-08-12 at 5:10PM (EST)."]}, {"lines": ["\"\"\""]}, {"lines": ["from nose.tools import assert_raises", "from framework.auth.core import Auth"]}, {"lines": ["from tests.base import OsfTestCase", "from tests.factories import ProjectFactory", ""]}, {"lines": ["CORRUPT_ADDONS = (AddonWikiNodeSettings, AddonFilesNodeSettings)"]}, {"lines": ["def main():", "    from framework.mongo import db", "    init_app(routes=False)", "    do_migration(db)"]}, {"lines": ["", "def get_targets(db, addon_class):", "    \"\"\"Generate affected nodes.\"\"\""]}, {"lines": ["                'addons',", "                addon_class.__name__.lower(),", "                'owner'"]}, {"lines": ["    return (Node.load(node['_id']) for node in query)", "", "", "def do_migration(db):", "    for addon_class in CORRUPT_ADDONS:", "        print('Processing ' + addon_class.__name__)", "", "        for node in get_targets(db, addon_class):", "            print('- ' + node._id)"]}, {"lines": ["            backref_key = '{}__addons'.format(addon_class.__name__.lower())", "            keep, discard = getattr(node, backref_key)"]}, {"lines": ["            addon_class.remove_one(discard)", "", "        print('')", "", "    print('-----\\nDone.')", "", "", "class TestRemovingDuplicateFileAndWikiAddons(OsfTestCase):", "", "    def test_get_targets(self):", "        bad_project = ProjectFactory()", "        auth = Auth(bad_project.creator)", "        bad_project.add_addon('osffiles', auth=auth)", "", "        bad_project.add_addon('osffiles', auth=auth, _force=True)", "        bad_project.save()", "", "        good_project = ProjectFactory()", "        good_project.add_addon('osffiles', auth=Auth(good_project.creator))", "        good_project.save()", "", "        targets = get_targets(self.db, AddonFilesNodeSettings)", "        assert bad_project in targets", "        assert good_project not in targets", "", "    def test_do_migration(self):", "        bad_project = ProjectFactory()", "        auth = Auth(bad_project.creator)", "        bad_project.add_addon('osffiles', auth=auth)", "        bad_project.add_addon('osffiles', auth=auth, _force=True)", "        bad_project.save()"]}, {"lines": ["        bad_project2 = ProjectFactory()", "        auth2 = Auth(bad_project2.creator)", "        bad_project2.add_addon('wiki', auth=auth2)", "        bad_project2.add_addon('wiki', auth=auth2, _force=True)", "        bad_project2.save()", "        # sanity check", "        with assert_raises(AssertionError):", "            bad_project.get_addon('osffiles')", "        with assert_raises(AssertionError):", "            bad_project2.get_addon('wiki')", "        do_migration(self.db)", "        # no more errors", "        assert isinstance(bad_project.get_addon('wiki'), AddonWikiNodeSettings)", "        assert isinstance(bad_project2.get_addon('osffiles'), AddonFilesNodeSettings)"]}, {"lines": ["if __name__ == '__main__':", "    main()"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Unit tests for website.app.\"\"\"", "", "from nose.tools import *  # noqa (PEP8 asserts)", "from flask import Flask", ""]}, {"lines": ["", "import framework", "from website.app import attach_handlers", "from website import settings", "", ""]}, {"lines": ["def test_attach_handlers():", "    app = Flask(__name__)", "    attach_handlers(app, settings)", "", "    before_funcs = app.before_request_funcs[None]", "", "    # Check that necessary handlers are attached", "    assert_in(framework.sessions.prepare_private_key, before_funcs)", "    assert_in(framework.sessions.before_request, before_funcs)"]}, {"lines": ["", "    # Check that the order is correct", "    assert_before(before_funcs, framework.sessions.prepare_private_key,", "                framework.sessions.before_request)", ""]}, {"lines": ["    def test_repr(self):", "        auth = AuthFactory()", "        rep = repr(auth)", "        assert_in(str(auth.user), rep)", ""]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["from nose.tools import *  # noqa (PEP8 asserts)"]}, {"lines": ["from website.conferences.model import Conference"]}, {"lines": ["from website.util import api_url_for, web_url_for"]}, {"lines": ["", "from tests.base import OsfTestCase, fake"]}, {"lines": [""]}, {"lines": ["class ConferenceFactory(ModularOdmFactory):", "    FACTORY_FOR = Conference", ""]}, {"lines": ["    name = FakerAttribute('catch_phrase')", "    active = True", ""]}, {"lines": ["", "def create_fake_conference_nodes(n, endpoint):", "    nodes = []", "    for i in range(n):", "        node = ProjectFactory(is_public=True)", "        node.add_tag(endpoint, Auth(node.creator))", "        node.save()", "        nodes.append(node)", "    return nodes", "", ""]}, {"lines": ["class TestConferenceEmailViews(OsfTestCase):", ""]}, {"lines": ["    def test_conference_data(self):", "        conference = ConferenceFactory()", "", "        # Create conference nodes", "        n_conference_nodes = 3"]}, {"lines": ["        # Create a non-conference node", "        ProjectFactory()", "", "        url = api_url_for('conference_data', meeting=conference.endpoint)", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)"]}, {"lines": [""]}, {"lines": ["    def test_conference_results(self):", "        conference = ConferenceFactory()", "", "        url = web_url_for('conference_results', meeting=conference.endpoint)", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", "", "", "class TestConferenceModel(OsfTestCase):", "", "    def test_endpoint_and_name_are_required(self):", "        with assert_raises(ValidationError):", "            ConferenceFactory(endpoint=None, name=fake.company()).save()", "        with assert_raises(ValidationError):", "            ConferenceFactory(endpoint='spsp2014', name=None).save()"]}, {"lines": ["from nose.tools import *  # noqa (PEP8 asserts)"]}, {"lines": ["from tests.factories import (", "    ProjectFactory,", "    UserFactory,", "    RegistrationFactory,", "    NodeFactory,", "    NodeLogFactory,"]}, {"lines": ["    FolderFactory,", ")"]}, {"lines": ["        result = _get_summary(", "            node, auth=Auth(user),"]}, {"lines": ["    # https://github.com/CenterForOpenScience/openscienceframework.org/issues/668", "    def test_get_summary_for_registration_uses_correct_date_format(self):", "        reg = RegistrationFactory()", "        res = _get_summary(reg, auth=Auth(reg.creator), rescale_ratio=None)", "        assert_equal(res['summary']['registered_date'],"]}, {"lines": ["                reg.registered_date.strftime('%Y-%m-%d %H:%M UTC'))"]}, {"lines": ["        reg = RegistrationFactory(project=node, user=node.creator)"]}, {"lines": ["        res = _get_summary(", "            fork, auth=Auth(user),"]}, {"lines": ["        res = _get_summary(", "            fork, auth=Auth(user),"]}, {"lines": ["        assert_false(res['summary']['can_view'])", "        assert_true(res['summary']['is_fork'])"]}, {"lines": ["", "class TestViewProject(OsfTestCase):", "", "    # related to https://github.com/CenterForOpenScience/openscienceframework.org/issues/1109", "    def test_view_project_pointer_count_excludes_folders(self):", "        user = UserFactory()", "        pointer_project = ProjectFactory(is_public=True)  # project that points to another project", "        pointed_project = ProjectFactory(creator=user)  # project that other project points to", "        pointer_project.add_pointer(pointed_project, Auth(pointer_project.creator), save=True)", "", "        # Project is in a dashboard folder", "        folder = FolderFactory(creator=pointed_project.creator)", "        folder.add_pointer(pointed_project, Auth(pointed_project.creator), save=True)", "", "        result = _view_project(pointed_project, Auth(pointed_project.creator))", "        # pointer_project is included in count, but not folder", "        assert_equal(result['node']['points'], 1)", "", ""]}, {"lines": ["from framework.mongo import database"]}, {"lines": ["SILENT_LOGGERS = ['framework.transactions.handlers', 'framework.transactions.context']", "", "for each in SILENT_LOGGERS:", "    logger = logging.getLogger(each)", "    logger.setLevel(logging.CRITICAL)", ""]}, {"lines": ["from nose.tools import *  # noqa PEP8 asserts"]}, {"lines": ["from website.project.views.node import _view_project, abbrev_authors, _should_show_wiki_widget"]}, {"lines": ["        res = self.app.get(self.project_url, {'view_only': self.link.key})"]}, {"lines": ["        assert_equal(data['node']['category'], 'Project')", "        assert_equal(data['node']['node_type'], 'project')", ""]}, {"lines": ["            [reg_user2, project.creator, unregistered_user, reg_user1]"]}, {"lines": ["            [project.creator, unregistered_user, reg_user1]"]}, {"lines": ["        self.app.post(url, json.dumps({\"id\": self.user2._id}),"]}, {"lines": ["        self.app.post_json(url, {\"name\": \"title\", \"value\": \"Bacon\"},"]}, {"lines": ["        self.app.post_json(url, {}, auth=self.auth)"]}, {"lines": ["        self.app.post_json(url, {}, auth=self.auth)"]}, {"lines": ["    def test_register_template_page_with_invalid_template_name(self):", "        url = self.project.web_url_for('node_register_template_page', template='invalid')", "        res = self.app.get(url, expect_errors=True, auth=self.auth)", "        assert_equal(res.status_code, 404)", "        assert_in('Template not found', res)", ""]}, {"lines": ["    def test_view_project_returns_whether_to_show_wiki_widget(self):", "        user = AuthUserFactory()", "        project = ProjectFactory.build(creator=user, is_public=True)", "        project.add_contributor(user)", "        project.save()", "", "        url = project.api_url_for('view_project')", "        res = self.app.get(url, auth=user.auth)", "        assert_equal(res.status_code, http.OK)", "        assert_in('show_wiki_widget', res.json['user'])", "", "    def test_fork_count_does_not_include_deleted_forks(self):", "        user = AuthUserFactory()", "        project = ProjectFactory(creator=user)", "        auth = Auth(project.creator)", "        fork = project.fork_node(auth)"]}, {"lines": ["        project.save()", "        fork.remove_node(auth)", "        fork.save()", "", "        url = project.api_url_for('view_project')", "        res = self.app.get(url, auth=user.auth)", "        assert_in('fork_count', res.json['node'])"]}, {"lines": ["", ""]}, {"lines": ["    def test_sanitization_of_edit_profile(self):", "        url = api_url_for('edit_profile', uid=self.user._id)"]}, {"lines": ["        request = self.app.post(url, post_data, auth=self.user.auth)", "        assert_equal('new name', request.json['name'])", ""]}, {"lines": ["    def test_unserialize_and_serialize_jobs(self):", "        jobs = [{"]}, {"lines": ["        payload = {'contents': jobs}"]}, {"lines": ["        for i, job in enumerate(jobs):", "            assert_equal(job, res.json['contents'][i])", ""]}, {"lines": ["        schools = [{"]}, {"lines": ["        payload = {'contents': schools}"]}, {"lines": ["        for i, job in enumerate(schools):", "            assert_equal(job, res.json['contents'][i])"]}, {"lines": ["    def test_unserialize_jobs(self):", "        jobs = [", "            {", "                'institution': fake.company(),", "                'department': fake.catch_phrase(),", "                'title': fake.bs(),", "                'startMonth': 5,"]}, {"lines": ["                'endMonth': 3,"]}, {"lines": ["                'ongoing': False,", "            }", "        ]", "        payload = {'contents': jobs}", "        url = api_url_for('unserialize_jobs')", "        res = self.app.put_json(url, payload, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.user.reload()", "        # jobs field is updated", "        assert_equal(self.user.jobs, jobs)", ""]}, {"lines": ["        schools = [", "            {", "                'institution': fake.company(),", "                'department': fake.catch_phrase(),", "                'degree': fake.bs(),", "                'startMonth': 5,"]}, {"lines": ["                'endMonth': 3,"]}, {"lines": ["                'ongoing': False,", "            }", "        ]", "        payload = {'contents': schools}", "        url = api_url_for('unserialize_schools')", "        res = self.app.put_json(url, payload, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.user.reload()", "        # schools field is updated", "        assert_equal(self.user.schools, schools)", ""]}, {"lines": ["        jobs_cached = self.user.jobs"]}, {"lines": ["        jobs = [", "            {", "                'institution': fake.company(),", "                'department': fake.catch_phrase(),", "                'title': fake.bs(),", "                'startMonth': 5,"]}, {"lines": ["                'endMonth': 3,"]}, {"lines": ["                'ongoing': False,", "            }", "        ]", "        payload = {'contents': jobs}", "        url = api_url_for('unserialize_jobs')"]}, {"lines": [""]}, {"lines": ["    def test_add_contributors_post_only_sends_one_email_to_unreg_user(", "            self, mock_send_claim_email):"]}, {"lines": ["        self.app.post_json(url, payload, auth=self.creator.auth)"]}, {"lines": ["        name = fake.name()"]}, {"lines": ["        self.app.post_json(url, payload).maybe_follow()"]}, {"lines": ["        self.app.post_json(url, payload).maybe_follow()"]}, {"lines": ["        data = res.json"]}, {"lines": ["    def test_claim_user_post_with_email_already_registered_sends_correct_email(", "            self, send_claim_registered_email):"]}, {"lines": ["        self.app.post_json(url, payload)"]}, {"lines": ["        self.app.post(url, {"]}, {"lines": ["        self.app.post(claim_url, {"]}, {"lines": ["        self.app.post_json(url,"]}, {"lines": ["    # https://github.com/CenterForOpenScience/openscienceframework.org/issues/1109", "    def test_get_pointed_excludes_folders(self):", "        pointer_project = ProjectFactory(is_public=True)  # project that points to another project", "        pointed_project = ProjectFactory(creator=self.user)  # project that other project points to", "        pointer_project.add_pointer(pointed_project, Auth(pointer_project.creator), save=True)", "", "        # Project is in a dashboard folder", "        folder = FolderFactory(creator=pointed_project.creator)", "        folder.add_pointer(pointed_project, Auth(pointed_project.creator), save=True)", "", "        url = pointed_project.api_url_for('get_pointed')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        # pointer_project's id is included in response, but folder's id is not", "        pointer_ids = [each['id'] for each in res.json['pointed']]", "        assert_in(pointer_project._id, pointer_ids)", "        assert_not_in(folder._id, pointer_ids)", ""]}, {"lines": ["        res = self.app.post_json(", "            url,", "            {'nodeIds': node_ids},", "            auth=None,", "            expect_errors=True", "        )"]}, {"lines": ["        assert_equal(res.status_code, 401)"]}, {"lines": ["        res = self.app.post_json(url, {}, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)"]}, {"lines": ["        res = self.app.delete_json(url, {}, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)"]}, {"lines": ["        res = self.app.delete_json(", "            url,", "            {'pointerId': None},", "            auth=self.user.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)"]}, {"lines": ["        res = self.app.delete_json(", "            url,", "            {'pointerId': pointer._id},", "            auth=self.user.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)"]}, {"lines": ["        res = self.app.post_json(url, {}, auth=self.user.auth,", "                expect_errors=True)", "        assert_equal(res.status_code, 400)"]}, {"lines": ["        res = self.app.post_json(", "            url,", "            {'pointerId': None},", "            auth=self.user.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)"]}, {"lines": ["        res = self.app.post_json(", "            url,", "            {'pointerId': pointer._id},", "            auth=self.user.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 400)"]}, {"lines": ["    def test_register_after_being_invited_as_unreg_contributor(self):", "        # Regression test for:", "        #    https://github.com/CenterForOpenScience/openscienceframework.org/issues/861", "        #    https://github.com/CenterForOpenScience/openscienceframework.org/issues/1021", "        #    https://github.com/CenterForOpenScience/openscienceframework.org/issues/1026", "        # A user is invited as an unregistered contributor", "        project = ProjectFactory()", "", "        name, email = fake.name(), fake.email()", "", "        project.add_unregistered_contributor(fullname=name, email=email,", "                auth=Auth(project.creator))", "        project.save()", "", "        # The new, unregistered user", "        new_user = User.find_one(Q('username', 'eq', email))", "", "        # Instead of following the invitation link, they register at the regular", "        # registration page", "", "        # They use a different name when they register, but same email", "        real_name = fake.name()", "        password = 'myprecious'", "", "        url = api_url_for('register_user')", "        payload = {", "            'fullName': real_name,", "            'email1': email,", "            'email2': email,", "            'password': password,", "        }", "        # Send registration request", "        self.app.post_json(url, payload)", "", "        new_user.reload()", "", "        # New user confirms by following confirmation link", "        confirm_url = new_user.get_confirmation_url(email, external=False)", "        self.app.get(confirm_url)", "", "        new_user.reload()", "        # Password and fullname should be updated"]}, {"lines": ["        assert_true(new_user.check_password(password))", "        assert_equal(new_user.fullname, real_name)", ""]}, {"lines": ["    def test_confirm_email_clears_unclaimed_records_and_revokes_token(self):", "        unclaimed_user = UnconfirmedUserFactory()", "        # unclaimed user has been invited to a project.", "        referrer = UserFactory()", "        project = ProjectFactory(creator=referrer)", "        unclaimed_user.add_unclaimed_record(project, referrer, 'foo')", "        unclaimed_user.save()", "", "        # sanity check", "        assert_equal(len(unclaimed_user.email_verifications.keys()), 1)", "", "        # user goes to email confirmation link", "        token = unclaimed_user.get_confirmation_token(unclaimed_user.username)", "        url = web_url_for('confirm_email_get', uid=unclaimed_user._id, token=token)", "        res = self.app.get(url)", "        assert_equal(res.status_code, 302)", "", "        # unclaimed records and token are cleared", "        unclaimed_user.reload()", "        assert_equal(unclaimed_user.unclaimed_records, {})", "        assert_equal(len(unclaimed_user.email_verifications.keys()), 0)", ""]}, {"lines": ["        # Add, then delete, add-ons; assert that add-ons are not attached to", "        # project."]}, {"lines": ["        assert_datetime_equal(date_created, date_created2)", "        assert_datetime_equal(date_modified, date_modified2)"]}, {"lines": ["        assert_datetime_equal(date_created, date_created2)", "        assert_datetime_equal(date_modified, date_modified2)"]}, {"lines": ["        assert_datetime_equal(date_created, date_created2)", "        assert_datetime_equal(date_modified, date_modified2)"]}, {"lines": ["        CommentFactory(node=self.project, user=self.project.creator, is_public=False)"]}, {"lines": ["        CommentFactory(node=self.project, target=comment_l1, user=user_l2)"]}, {"lines": ["        CommentFactory(node=self.project, target=comment_l1)"]}, {"lines": ["        view_timestamp = dt.datetime.utcnow()", "        assert_datetime_equal(user_timestamp, view_timestamp)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        payload = {", "            'new_list': ["]}, {"lines": ["class TestDashboardViews(OsfTestCase):"]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        self.creator = AuthUserFactory()", "        self.contrib = AuthUserFactory()"]}, {"lines": ["", "    # https://github.com/CenterForOpenScience/openscienceframework.org/issues/571"]}, {"lines": ["        project = ProjectFactory(creator=self.creator, public=False)"]}, {"lines": ["        component.add_contributor(self.contrib, auth=Auth(self.creator))", "        component.save()"]}, {"lines": ["        res = self.app.get(url, auth=self.contrib.auth)"]}, {"lines": ["        res = self.app.get(url, auth=self.contrib.auth)"]}, {"lines": ["        self.project2 = ProjectFactory(creator=self.project.creator)"]}, {"lines": ["        assert_true(_should_show_wiki_widget(self.project, self.project.creator))", "        assert_true(_should_show_wiki_widget(self.project2, self.project.creator))"]}, {"lines": ["        assert_false(_should_show_wiki_widget(self.project, self.read_only_contrib))", "        assert_false(_should_show_wiki_widget(self.project2, self.read_only_contrib))"]}, {"lines": ["        assert_false(_should_show_wiki_widget(self.project, self.noncontributor))", "        assert_false(_should_show_wiki_widget(self.project2, self.read_only_contrib))"]}, {"lines": ["    def test_create_component_strips_html(self):", "        user = AuthUserFactory()", "        project = ProjectFactory(creator=user)", "        url = web_url_for('project_new_node', pid=project._id)", "        post_data = {'title': '<b>New <blink>Component</blink> Title</b>',  'category': ''}", "        request = self.app.post(url, post_data, auth=user.auth).follow()", "        project.reload()", "        child = project.nodes[0]", "        # HTML has been stripped", "        assert_equal(child.title, 'New Component Title')", ""]}, {"lines": ["class TestUnconfirmedUserViews(OsfTestCase):", "", "    def test_can_view_profile(self):", "        user = UnconfirmedUserFactory()", "        url = web_url_for('profile_view_id', uid=user._id)", "        res = self.app.get(url)", "        assert_equal(res.status_code, 200)", ""]}, {"lines": [""]}, {"lines": ["# -*- coding: utf-8 -*-", "import unittest", "", "from nose.tools import *  # noqa (PEP8 asserts)", "from flask import Flask", "from webtest_plus import TestApp", "", "from framework.exceptions import HTTPError", "from framework.routing import json_renderer, process_rules, Rule", "", "def error_view():", "    raise HTTPError(400)", "", "def error_with_msg():", "    raise HTTPError(400, data={", "        'message_short': 'Invalid',", "        'message_long': 'Invalid request'", "    })", "", "class TestJSONRenderer(unittest.TestCase):", "", "    def setUp(self):", "        self.app = Flask(__name__)", "        self.app.debug = True", "", "        self.wt = TestApp(self.app)", "", "    def test_error_handling(self):", "        rule = Rule(['/error/'], 'get', error_view, renderer=json_renderer)", "        process_rules(self.app, [rule])", "        res = self.wt.get('/error/', expect_errors=True)", "        assert_equal(res.status_code, 400)", "        assert_true(isinstance(res.json, dict))", "", "    def test_error_handling_with_message(self):", "        rule = Rule(['/error/'], 'get', error_with_msg, renderer=json_renderer)", "        process_rules(self.app, [rule])", "        res = self.wt.get('/error/', expect_errors=True)", "        assert_equal(res.status_code, 400)", "        data = res.json", "        assert_equal(data['message_short'], 'Invalid')", "        assert_equal(data['message_long'], 'Invalid request')"]}, {"lines": ["    pass"]}, {"lines": ["BLANK_OR_CORRUPT_TABLE_ERROR = 'Is this a valid instance of this file type?<p>{0}</p>'.format(SUPPORT)"]}, {"lines": ["import os"]}, {"lines": ["from flask import send_from_directory"]}, {"lines": ["from framework.flask import redirect"]}, {"lines": ["from website.conferences import views as conference_views"]}, {"lines": ["        'disk_saving_mode': settings.DISK_SAVING_MODE,"]}, {"lines": ["        Rule('/reproducibility/', 'get',"]}, {"lines": ["            conference_views.conference_results,"]}, {"lines": ["            conference_views.conference_results,"]}, {"lines": ["            conference_views.conference_data,"]}, {"lines": ["            conference_views.conference_view,"]}, {"lines": ["        Rule('/explore/activity/', 'get', discovery_views.activity,"]}, {"lines": ["        Rule('/register/', 'post', auth_views.auth_register_post,"]}, {"lines": ["        Rule(['/login/', '/account/'], 'get',"]}, {"lines": ["        Rule('/login/first/', 'get', auth_views.auth_login,"]}, {"lines": ["        Rule('/profile/<uid>/', 'get', profile_views.profile_view_id,"]}, {"lines": ["        Rule('/settings/key_history/<kid>/', 'get', profile_views.user_key_history,"]}, {"lines": ["        Rule([\"/user/merge/\"], 'get', auth_views.merge_user_get,"]}, {"lines": ["        Rule([\"/user/merge/\"], 'post', auth_views.merge_user_post,"]}, {"lines": ["        # Route for claiming and setting email and password.", "        # Verification token must be querystring argument"]}, {"lines": ["        Rule('/profile/<uid>/public_projects/', 'get',"]}, {"lines": ["        Rule('/profile/<uid>/public_components/', 'get',"]}, {"lines": ["        Rule('/profile/<user_id>/summary/', 'get',"]}, {"lines": ["        Rule('/user/<uid>/<pid>/claim/email/', 'post',"]}, {"lines": ["        # Create a new subproject/component"]}, {"lines": ["        Rule('/project/<pid>/newnode/', 'post', project_views.node.project_new_node,"]}, {"lines": ["        Rule('/project/new/<pid>/beforeTemplate/', 'get',"]}, {"lines": ["        ], 'get', project_views.register.node_register_page,", "            OsfWebRenderer('project/register.mako')),"]}, {"lines": ["        ], 'get', project_views.register.node_register_template_page,", "            OsfWebRenderer('project/register.mako')),"]}, {"lines": ["        ], 'get', project_views.node.node_registrations,", "            OsfWebRenderer('project/registrations.mako')),"]}, {"lines": ["        ], 'get', project_views.node.project_statistics,", "            OsfWebRenderer('project/statistics.mako')),"]}, {"lines": ["            conference_views.meeting_hook,"]}, {"lines": ["        # Create project, used by projectCreator.js", "        Rule('/project/new/', 'post', project_views.node.project_new_post, json_renderer),", ""]}, {"lines": ["        ], 'post', project_views.key.revoke_node_key, json_renderer),"]}, {"lines": ["        Rule('/project/<pid>/reorder_components/', 'post',"]}, {"lines": ["            [", "                '/project/<pid>/files/grid/',", "                '/project/<pid>/node/<nid>/files/grid/'"]}, {"lines": ["", "    # Set up static routing for addons", "    # NOTE: We use nginx to serve static addon assets in production", "    addon_base_path = os.path.abspath('website/addons')", "    if settings.DEV_MODE:", "        @app.route('/static/addons/<addon>/<path:filename>')", "        def addon_static(addon, filename):", "            addon_path = os.path.join(addon_base_path, addon, 'static')", "            return send_from_directory(addon_path, filename)"]}, {"lines": ["        \"\"\"Called when the addon is added (or re-added) to the owner (User or Node).\"\"\""]}, {"lines": ["        \"\"\"Called when the addon is deleted from the owner (User or Node).\"\"\""]}, {"lines": ["    def __repr__(self):", "        if self.owner:", "            return '<{cls} owned by user {uid}>'.format(cls=self.__class__.__name__, uid=self.owner._id)", "        else:", "            return '<{cls} with no owner>'.format(cls=self.__class__.__name__)", ""]}, {"lines": ["from .defaults import *  # noqa"]}, {"lines": ["    from .local import *  # noqa"]}, {"lines": ["from framework.auth import Auth", "", "from factory import SubFactory, Sequence, post_generation"]}, {"lines": ["", "    @post_generation", "    def add_dropbox_addon(self, created, extracted):", "        self.node.add_addon('dropbox', auth=Auth(user=self.node.creator))", "        self.node.save()"]}, {"lines": ["from nose.tools import *  # noqa (PEP8 asserts)"]}, {"lines": ["from nose.tools import *  # noqa (PEP8 asserts)"]}, {"lines": ["from dropbox.rest import ErrorResponse"]}, {"lines": ["        self.app.delete(url)"]}, {"lines": ["    @mock.patch('website.addons.dropbox.client.DropboxClient.metadata')", "    def test_dropbox_hgrid_data_contents_returns_error_if_invalid_path(self, mock_metadata):", "        mock_response = mock.Mock()", "        mock_metadata.side_effect = ErrorResponse(mock_response, body='File not found')", "        url = self.project.api_url_for('dropbox_hgrid_data_contents')", "        res = self.app.get(url, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, httplib.NOT_FOUND)", ""]}, {"lines": ["from framework.mongo import set_up_storage"]}, {"lines": ["    'revisions': [{u'bytes': 0,"]}, {"lines": ["def patch_client(target, mock_client=None):"]}, {"lines": ["        client = mock_client or MockDropbox()"]}, {"lines": ["from flask import request"]}, {"lines": ["from framework.flask import redirect  # VOL-aware redirect"]}, {"lines": ["from dropbox.rest import ErrorResponse"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["    path = kwargs.get('path', '')"]}, {"lines": ["    file_not_found = HTTPError(http.NOT_FOUND, data=dict(message_short='File not found',", "                                                  message_long='The Dropbox file '", "                                                  'you requested could not be found.'))"]}, {"lines": ["    try:", "        metadata = client.metadata(path)", "    except ErrorResponse:", "        raise file_not_found"]}, {"lines": ["        raise file_not_found"]}, {"lines": ["from flask import request"]}, {"lines": ["from framework.flask import redirect  # VOL-aware redirect"]}, {"lines": ["from website.addons.github.tests.factories import GitHubOauthSettingsFactory"]}, {"lines": ["    def test_before_make_public(self, mock_repo):", "        mock_repo.side_effect = NotFoundError", "", "        result = self.node_settings.before_make_public(self.project)", "        assert_is(result, None)", "", "    @mock.patch('website.addons.github.api.GitHub.repo')"]}, {"lines": [""]}, {"lines": ["class TestAddonGithubUserSettings(OsfTestCase):", "", "    def setUp(self):", "        OsfTestCase.setUp(self)"]}, {"lines": ["        self.user_settings = AddonGitHubUserSettings()"]}, {"lines": [""]}, {"lines": ["    def test_repr(self):", "        self.user_settings.owner = UserFactory()", "        assert_in(self.user_settings.owner._id, repr(self.user_settings))", "        oauth_settings = GitHubOauthSettingsFactory()", ""]}, {"lines": ["    def test_public_id_is_none_if_no_oauth_settings_attached(self):"]}, {"lines": ["        self.user_settings.oauth_settings = None", "        self.user_settings.save()"]}, {"lines": ["        # Regression test for:", "        #  https://github.com/CenterForOpenScience/openscienceframework.org/issues/1053", "        assert_is_none(self.user_settings.public_id)"]}, {"lines": [""]}, {"lines": ["    def test_github_user_name(self):"]}, {"lines": [""]}, {"lines": ["    def test_oauth_access_token(self):"]}, {"lines": [""]}, {"lines": ["    def test_oauth_token_type(self):"]}, {"lines": [""]}, {"lines": ["from nose.tools import *  # noqa (PEP8 asserts)"]}, {"lines": ["        assert_equal(sha, self._get_sha_for_branch(branch=None))  # Get refs for default branch"]}, {"lines": ["                    \"author\": {\"name\": \"Illidan\", \"email\": \"njqpw@osf.io\"},", "                    \"committer\": {\"name\": \"Testor\", \"email\": \"test@osf.io\", \"username\": \"tester\"},"]}, {"lines": ["                 \"commits\": [{\"id\": \"b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                              \"distinct\": True,", "                              \"message\": \" foo\",", "                              \"timestamp\": \"2014-01-08T14:15:51-08:00\",", "                              \"url\": \"https://github.com/tester/addontesting/commit/b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                              \"author\": {\"name\": \"Illidan\", \"email\": \"njqpw@osf.io\"},", "                              \"committer\": {\"name\": \"Testor\", \"email\": \"test@osf.io\",", "                                            \"username\": \"tester\"},", "                              \"added\": [], \"removed\":[], \"modified\":[\"PRJWN3TV\"]}]},"]}, {"lines": ["             \"commits\": [{\"id\": \"b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                          \"distinct\": True,", "                          \"message\": \"foo\",", "                          \"timestamp\": \"2014-01-08T14:15:51-08:00\",", "                          \"url\": \"https://github.com/tester/addontesting/commit/b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                          \"author\": {\"name\": \"Illidan\", \"email\": \"njqpw@osf.io\"},", "                          \"committer\": {\"name\": \"Testor\", \"email\": \"test@osf.io\", \"username\": \"tester\"},", "                          \"added\": [], \"removed\": [\"PRJWN3TV\"], \"modified\":[]}]},"]}, {"lines": ["             \"commits\": [{\"id\": \"b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                          \"distinct\": True,", "                          \"message\": \"Added via the Open Science Framework\",", "                          \"timestamp\": \"2014-01-08T14:15:51-08:00\",", "                          \"url\": \"https://github.com/tester/addontesting/commit/b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                          \"author\": {\"name\": \"Illidan\", \"email\": \"njqpw@osf.io\"},", "                          \"committer\": {\"name\": \"Testor\", \"email\": \"test@osf.io\", \"username\": \"tester\"},", "                          \"added\": [\"PRJWN3TV\"], \"removed\":[], \"modified\":[]}]},"]}, {"lines": ["             \"commits\": [{\"id\": \"b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                          \"distinct\": True,", "                          \"message\": \"Updated via the Open Science Framework\",", "                          \"timestamp\": \"2014-01-08T14:15:51-08:00\",", "                          \"url\": \"https://github.com/tester/addontesting/commit/b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                          \"author\": {\"name\": \"Illidan\", \"email\": \"njqpw@osf.io\"},", "                          \"committer\": {\"name\": \"Testor\", \"email\": \"test@osf.io\", \"username\": \"tester\"},", "                          \"added\": [], \"removed\":[], \"modified\":[\"PRJWN3TV\"]}]},"]}, {"lines": ["             \"commits\": [{\"id\": \"b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                          \"distinct\": True,", "                          \"message\": \"Deleted via the Open Science Framework\",", "                          \"timestamp\": \"2014-01-08T14:15:51-08:00\",", "                          \"url\": \"https://github.com/tester/addontesting/commit/b08dbb5b6fcd74a592e5281c9d28e2020a1db4ce\",", "                          \"author\": {\"name\": \"Illidan\", \"email\": \"njqpw@osf.io\"},", "                          \"committer\": {\"name\": \"Testor\", \"email\": \"test@osf.io\", \"username\": \"tester\"},", "                          \"added\": [], \"removed\":[\"PRJWN3TV\"], \"modified\":[]}]},"]}, {"lines": ["class TestAuthViews(OsfTestCase):", "", "    def setUp(self):"]}, {"lines": ["        self.user = AuthUserFactory()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website.addons.github.exceptions import NotFoundError"]}, {"lines": ["<%include file=\"profile/addon_permissions.mako\" />"]}, {"lines": ["from nose.tools import *  # noqa"]}, {"lines": ["from boto.s3.connection import *  # noqa"]}, {"lines": ["from . import config, crud, hgrid  # noqa"]}, {"lines": ["from flask import request"]}, {"lines": ["        res = self.app.post_json(", "            '/api/v1/settings/twofactor/',"]}, {"lines": ["            auth=self.user.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 403)", "        json = res.json", "        assert_in('verification code', json['message_long'])"]}, {"lines": [""]}, {"lines": ["# PEP8 asserts"]}, {"lines": ["from nose.tools import *  # noqa"]}, {"lines": ["from modularodm.exceptions import ValidationValueError", ""]}, {"lines": ["from tests.base import OsfTestCase, fake"]}, {"lines": ["from framework.auth import Auth"]}, {"lines": ["", "class TestNodeWikiPageModel(OsfTestCase):", "", "    def test_page_name_cannot_be_greater_than_100_characters(self):", "        bad_name = 'a' * 101", "        page = NodeWikiPage(page_name=bad_name)", "        with assert_raises(ValidationValueError):", "            page.save()"]}, {"lines": ["        self.user = AuthUserFactory()", "        self.project = ProjectFactory(is_public=True, creator=self.user)"]}, {"lines": ["        project = ProjectFactory(is_public=True)"]}, {"lines": ["        self.project.add_pointer(project, Auth(self.project.creator), save=True)"]}, {"lines": ["    def test_project_wiki_edit_post(self):", "        self.project.update_node_wiki(", "            'home',", "            content='old content',", "            auth=Auth(self.project.creator)", "        )"]}, {"lines": ["        res = self.app.post(url, {'content': 'new content'}, auth=self.user.auth).follow()", "        assert_equal(res.status_code, 200)", "        self.project.reload()", "        # page was updated with new content", "        new_wiki = self.project.get_wiki_page('home')", "        assert_equal(new_wiki.content, 'new content')", ""]}, {"lines": ["", "        old_wiki_page_count = NodeWikiPage.find().count()"]}, {"lines": ["        # User submits to edit form with no content", "        res = self.app.post(url, {'content': ''}, auth=self.user.auth).follow()"]}, {"lines": ["", "        new_wiki_page_count = NodeWikiPage.find().count()", "        # A new wiki page was created in the db", "        assert_equal(new_wiki_page_count, old_wiki_page_count + 1)", "", "        # Node now has the new wiki page associated with it", "        self.project.reload()", "        new_page = self.project.get_wiki_page(page_name)", "        assert_is_not_none(new_page)", ""]}, {"lines": ["", "        old_wiki_page_count = NodeWikiPage.find().count()"]}, {"lines": ["        # User submits to edit form with no content", "        res = self.app.post(url, {'content': page_content}, auth=self.user.auth).follow()"]}, {"lines": [""]}, {"lines": ["        new_wiki_page_count = NodeWikiPage.find().count()", "        # A new wiki page was created in the db", "        assert_equal(new_wiki_page_count, old_wiki_page_count + 1)", ""]}, {"lines": ["        # Node now has the new wiki page associated with it", "        self.project.reload()", "        new_page = self.project.get_wiki_page(page_name)", "        assert_is_not_none(new_page)", "        # content was set", "        assert_equal(new_page.content, page_content)", ""]}, {"lines": ["    def test_project_wiki_edit_post_with_non_ascii_title(self):", "        # regression test for https://github.com/CenterForOpenScience/openscienceframework.org/issues/1040"]}, {"lines": ["        res = self.app.post(url, {'content': 'new content'}, auth=self.user.auth).follow()", "        assert_equal(res.status_code, 200)", "        self.project.reload()"]}, {"lines": ["", "        # updating content should return correct url as well.", "        res = self.app.post(url, {'content': 'updated content'}, auth=self.user.auth).follow()", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["    def test_wiki_edit_get_home(self):"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)"]}, {"lines": ["    def test_wiki_page_creation_strips_whitespace(self):", "        # Regression test for:", "        # https://github.com/CenterForOpenScience/openscienceframework.org/issues/1080"]}, {"lines": ["        res = self.app.post(url, {'content': 'blah'}, auth=self.user.auth).follow()", "        assert_equal(res.status_code, 200)", "", "        self.project.reload()", "        wiki = self.project.get_wiki_page('cupcake')", "        assert_is_not_none(wiki)"]}, {"lines": [""]}, {"lines": ["    def test_project_dashboard_shows_no_wiki_content_text(self):", "        # Regression test for:", "        # https://github.com/CenterForOpenScience/openscienceframework.org/issues/1104", "        project = ProjectFactory(creator=self.user)", "        url = project.web_url_for('view_project')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_in('No wiki content', res)", ""]}, {"lines": ["        # Regression test for:", "        # https://github.com/CenterForOpenScience/openscienceframework.org/issues/1104", "        text = u'\u4f60\u597d'", "        self.project.update_node_wiki('home', text, Auth(self.user))", "", "        # can view wiki preview from project dashboard", "        url = self.project.web_url_for('view_project')", "        res = self.app.get(url, auth=self.user.auth)", "        assert_in(text, res)", ""]}, {"lines": [""]}, {"lines": ["class TestViewHelpers(OsfTestCase):", "", "    def setUp(self):", "        super(TestViewHelpers, self).setUp()", "        self.project = ProjectFactory()"]}, {"lines": ["", "    def test_get_wiki_web_urls(self):"]}, {"lines": ["        assert_equal(urls['home'], self.project.web_url_for('project_wiki_home', _guid=True))"]}, {"lines": ["", "    def test_get_wiki_api_urls(self):"]}, {"lines": ["", ""]}, {"lines": ["        url = self.project.api_url_for(", "            'project_wiki_delete',"]}, {"lines": ["        )"]}, {"lines": ["            url,"]}, {"lines": [""]}, {"lines": ["        self.page_name = 'page2'", "        self.project.update_node_wiki(self.page_name, 'content', self.consolidate_auth)", "        self.project.save()", "        self.page = self.project.get_wiki_page(self.page_name)", ""]}, {"lines": ["        res = self.app.put_json(", "            self.url,"]}, {"lines": ["            auth=self.auth,"]}, {"lines": ["        )"]}, {"lines": ["        assert_equal(res.status_code, 409)"]}, {"lines": ["            auth=self.auth, expect_errors=True)", "        assert_equal(res.status_code, 404)", ""]}, {"lines": ["        # value is missing"]}, {"lines": ["        assert_equal(res.status_code, 400)", ""]}, {"lines": ["    def test_cannot_rename_home_page(self):"]}, {"lines": ["        assert_equal(res.status_code, 400)", ""]}, {"lines": ["        self.project.save()", "", "        # Creates a new page", "        self.project.update_node_wiki('page3' ,'moarcontent', self.consolidate_auth)"]}, {"lines": ["        self.project.save()", ""]}, {"lines": ["        # Renames the wiki to the deleted page"]}, {"lines": ["        assert_equal(res.status_code, 200)", ""]}, {"lines": ["    params = {param: _locals[param] for param in ['r', 'size'] if _locals[param] is not None}"]}, {"lines": ["    fullname = user.display_full_name(node=node)"]}, {"lines": ["                user, use_ssl=True,", "                size=settings.GRAVATAR_SIZE_PROFILE", "            ),"]}, {"lines": ["", "from .model import Node, PrivateLink"]}, {"lines": ["    output = []"]}, {"lines": ["        Q('is_dashboard', 'eq', True)"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from framework.forms import (", "    BootstrapTextArea,", "    BootstrapTextInput,", ")", "", "###############################################################################", "# Forms", "###############################################################################", "", "class NewNodeForm(Form):", "    title = TextField('Title', [", "        validators.Required(message=u'Title is required'),", "        validators.Length(min=1, message=u'Title must contain at least 1 character.'),", "        validators.Length(max=200, message=u'Title must contain fewer than 200 characters.')", "    ], widget=BootstrapTextInput())", "    description = TextAreaField('Description', widget=BootstrapTextArea())", "    category = TextAreaField('Category', widget=BootstrapTextArea())"]}, {"lines": ["from . import contributor, key, log, node, register, tag, file, comment  # noqa"]}, {"lines": ["from flask import request"]}, {"lines": ["from website.models import Node"]}, {"lines": ["@must_be_valid_project  # injects project"]}, {"lines": ["        pid = unreg_user_info['pid']"]}, {"lines": ["        'keys': ["]}, {"lines": ["from website.project.forms import NewNodeForm"]}, {"lines": ["from website.util.sanitize import strip_html"]}, {"lines": ["    value = strip_html(post_data.get('value', ''))"]}, {"lines": ["    folder = new_folder(strip_html(title), user)"]}, {"lines": ["        and addon.short_name not in settings.SYSTEM_ADDED_ADDONS['node']"]}, {"lines": ["def _should_show_wiki_widget(node, user):"]}, {"lines": ["            'category': node.category_display,"]}, {"lines": ["            'node_type': node.project_or_component,"]}, {"lines": ["            'points': len(node.get_points(deleted=False, folders=False)),"]}, {"lines": ["            'absolute_url': parent.absolute_url if parent else '',"]}, {"lines": ["            'show_wiki_widget': _should_show_wiki_widget(node, user),"]}, {"lines": [""]}, {"lines": ["            'category': node.category,", "            'node_type': node.project_or_component,"]}, {"lines": ["            'registered_date': node.registered_date.strftime('%Y-%m-%d %H:%M UTC')"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["        raise HTTPError(http.BAD_REQUEST)"]}, {"lines": ["@must_be_valid_project  # injects project"]}, {"lines": ["@must_be_valid_project  # injects project"]}, {"lines": ["        # TODO: Change this to 404?"]}, {"lines": ["", "def serialize_pointer(pointer, auth):"]}, {"lines": ["            'id': node._id,"]}, {"lines": ["    \"\"\"View that returns the pointers for a project.\"\"\""]}, {"lines": ["    # exclude folders"]}, {"lines": ["@must_be_valid_project  # injects project"]}, {"lines": ["@must_be_valid_project  # injects project"]}, {"lines": ["os_env = os.environ"]}, {"lines": ["DB_PORT = os_env.get('OSF_DB_PORT', 27017)"]}, {"lines": ["    'security',"]}, {"lines": [""]}, {"lines": ["# FOR EMERGENCIES ONLY: Setting this to True will disable forks, registrations,", "# and uploads in order to save disk space.", "DISK_SAVING_MODE = False"]}, {"lines": ["USE_GNUPG = False"]}, {"lines": ["        maxWidthProp: 2/3,", "        onClose: function() {},", "        onOpen: function() {}"]}, {"lines": ["        var self = this;"]}, {"lines": ["                options.onClose.call(self);"]}, {"lines": ["                options.onOpen.call(self);"]}, {"lines": ["        );"]}, {"lines": ["            }"]}, {"lines": ["                }"]}, {"lines": ["        });"]}, {"lines": [""]}, {"lines": ["            $('#add-component-submit')"]}, {"lines": ["\tAuthor:\t\t\tEric M. Barnard - @ericmbarnard", "\tLicense:\t\tMIT (http://opensource.org/licenses/mit-license.php)", "", "\tDescription:\tValidation Library for KnockoutJS"]}, {"lines": ["!function(a){\"function\"==typeof require&&\"object\"==typeof exports&&\"object\"==typeof module?a(require(\"knockout\"),exports):\"function\"==typeof define&&define.amd?define([\"knockout\",\"exports\"],a):a(ko,ko.validation={})}(function(a,b){function c(a){var b=\"max\"===a;return function(c,d){if(f.utils.isEmptyVal(c))return!0;var e,g;void 0===d.typeAttr?(g=\"text\",e=d):(g=d.typeAttr,e=d.value),isNaN(e)||(g=\"number\");var h,i,j;switch(g.toLowerCase()){case\"week\":if(h=/^(\\d{4})-W(\\d{2})$/,i=c.match(h),null===i)throw\"Invalid value for \"+a+\" attribute for week input.  Should look like '2000-W33' http://www.w3.org/TR/html-markup/input.week.html#input.week.attrs.min\";return j=e.match(h),j?b?i[1]<j[1]||i[1]===j[1]&&i[2]<=j[2]:i[1]>j[1]||i[1]===j[1]&&i[2]>=j[2]:!1;case\"month\":if(h=/^(\\d{4})-(\\d{2})$/,i=c.match(h),null===i)throw\"Invalid value for \"+a+\" attribute for month input.  Should look like '2000-03' http://www.w3.org/TR/html-markup/input.month.html#input.month.attrs.min\";return j=e.match(h),j?b?i[1]<j[1]||i[1]===j[1]&&i[2]<=j[2]:i[1]>j[1]||i[1]===j[1]&&i[2]>=j[2]:!1;case\"number\":case\"range\":return b?!isNaN(c)&&parseFloat(c)<=parseFloat(e):!isNaN(c)&&parseFloat(c)>=parseFloat(e);default:return b?e>=c:c>=e}}}function d(a,b,c){return b.validator(a(),void 0===c.params?!0:h(c.params))?!0:(a.setError(f.formatMessage(c.message||b.message,h(c.params),a)),!1)}function e(a,b,c){a.isValidating(!0);var d=function(d){var e=!1,g=\"\";return a.__valid__()?(d.message?(e=d.isValid,g=d.message):e=d,e||(a.error(f.formatMessage(g||c.message||b.message,h(c.params),a)),a.__valid__(e)),void a.isValidating(!1)):void a.isValidating(!1)};b.validator(a(),h(c.params||!0),d)}if(void 0===typeof a)throw\"Knockout is required, please ensure it is loaded before loading this validation plug-in\";a.validation=b;var f=a.validation,g=a.utils,h=g.unwrapObservable,i=g.arrayForEach,j=g.extend,k={registerExtenders:!0,messagesOnModified:!0,errorsAsTitle:!0,errorsAsTitleOnModified:!1,messageTemplate:null,insertMessages:!0,parseInputAttributes:!1,writeInputAttributes:!1,decorateInputElement:!1,decorateElementOnModified:!0,errorClass:null,errorElementClass:\"validationElement\",errorMessageClass:\"validationMessage\",allowHtmlMessages:!1,grouping:{deep:!1,observable:!0,live:!1},validate:{}},l=j({},k);l.html5Attributes=[\"required\",\"pattern\",\"min\",\"max\",\"step\"],l.html5InputTypes=[\"email\",\"number\",\"date\"],l.reset=function(){j(l,k)},f.configuration=l,f.utils=function(){var a=(new Date).getTime(),b={},c=\"__ko_validation__\";return{isArray:function(a){return a.isArray||\"[object Array]\"===Object.prototype.toString.call(a)},isObject:function(a){return null!==a&&\"object\"==typeof a},isObservableArray:function(a){return!!a&&\"function\"==typeof a.remove&&\"function\"==typeof a.removeAll&&\"function\"==typeof a.destroy&&\"function\"==typeof a.destroyAll&&\"function\"==typeof a.indexOf&&\"function\"==typeof a.replace},values:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},getValue:function(a){return\"function\"==typeof a?a():a},hasAttribute:function(a,b){return null!==a.getAttribute(b)},getAttribute:function(a,b){return a.getAttribute(b)},setAttribute:function(a,b,c){return a.setAttribute(b,c)},isValidatable:function(a){return!!(a&&a.rules&&a.isValid&&a.isModified)},insertAfter:function(a,b){a.parentNode.insertBefore(b,a.nextSibling)},newId:function(){return a+=1},getConfigOptions:function(a){var b=f.utils.contextFor(a);return b||f.configuration},setDomData:function(a,d){var e=a[c];e||(a[c]=e=f.utils.newId()),b[e]=d},getDomData:function(a){var d=a[c];return d?b[d]:void 0},contextFor:function(a){switch(a.nodeType){case 1:case 8:var b=f.utils.getDomData(a);if(b)return b;if(a.parentNode)return f.utils.contextFor(a.parentNode)}return void 0},isEmptyVal:function(a){return void 0===a?!0:null===a?!0:\"\"===a?!0:void 0},getOriginalElementTitle:function(a){var b=f.utils.getAttribute(a,\"data-orig-title\"),c=a.title,d=f.utils.hasAttribute(a,\"data-orig-title\");return d?b:c},async:function(a){window.setImmediate?window.setImmediate(a):window.setTimeout(a,0)},forEach:function(a,b){if(f.utils.isArray(a))return i(a,b);for(var c in a)a.hasOwnProperty(c)&&b(a[c],c)}}}();var m=function(){function b(a){i(a.subscriptions,function(a){a.dispose()}),a.subscriptions=[]}function c(a){a.options.deep&&(i(a.flagged,function(a){delete a.__kv_traversed}),a.flagged.length=0),a.options.live||b(a)}function d(a,d){d.validatables=[],b(d),e(a,d),c(d)}function e(b,c,d){var f=[],g=b.peek?b.peek():b;b.__kv_traversed!==!0&&(c.options.deep&&(b.__kv_traversed=!0,c.flagged.push(b)),d=void 0!==d?d:c.options.deep?1:-1,a.isObservable(b)&&(b.isValid||b.extend({validatable:!0}),c.validatables.push(b),c.options.live&&n.isObservableArray(b)&&c.subscriptions.push(b.subscribe(function(){c.graphMonitor.valueHasMutated()}))),g&&!g._destroy&&(n.isArray(g)?f=g:n.isObject(g)&&(f=n.values(g))),0!==d&&n.forEach(f,function(a){a&&!a.nodeType&&e(a,c,d+1)}))}function k(a){var b=[];return i(a,function(a){a.isValid()||b.push(a.error())}),b}var l=0,m=f.configuration,n=f.utils;return{init:function(a,b){l>0&&!b||(a=a||{},a.errorElementClass=a.errorElementClass||a.errorClass||m.errorElementClass,a.errorMessageClass=a.errorMessageClass||a.errorClass||m.errorMessageClass,j(m,a),m.registerExtenders&&f.registerExtenders(),l=1)},configure:function(a){f.init(a)},reset:f.configuration.reset,group:function(b,c){c=j(j({},m.grouping),c);var e={options:c,graphMonitor:a.observable(),flagged:[],subscriptions:[],validatables:[]},f=null;return c.observable?(d(b,e),f=a.computed(function(){return e.graphMonitor(),d(b,e),k(e.validatables)})):f=function(){return d(b,e),k(e.validatables)},f.showAllMessages=function(a){void 0===a&&(a=!0),f(),i(e.validatables,function(b){b.isModified(a)})},b.errors=f,b.isValid=function(){return 0===b.errors().length},b.isAnyMessageShown=function(){var a=!1;return f(),a=!!g.arrayFirst(e.validatables,function(a){return!a.isValid()&&a.isModified()})},f},formatMessage:function(a,b,c){return\"function\"==typeof a?a(b,c):a.replace(/\\{0\\}/gi,h(b))},addRule:function(a,b){return a.extend({validatable:!0}),a.rules.push(b),a},addAnonymousRule:function(a,b){void 0===b.message&&(b.message=\"Error\"),b.onlyIf&&(b.condition=b.onlyIf),f.addRule(a,b)},addExtender:function(b){a.extenders[b]=function(a,c){return c&&(c.message||c.onlyIf)?f.addRule(a,{rule:b,message:c.message,params:n.isEmptyVal(c.params)?!0:c.params,condition:c.onlyIf}):f.addRule(a,{rule:b,params:c})}},registerExtenders:function(){if(m.registerExtenders)for(var b in f.rules)f.rules.hasOwnProperty(b)&&(a.extenders[b]||f.addExtender(b))},insertValidationMessage:function(a){var b=document.createElement(\"SPAN\");return b.className=n.getConfigOptions(a).errorMessageClass,n.insertAfter(a,b),b},parseInputValidationAttributes:function(a,b){i(f.configuration.html5Attributes,function(c){if(n.hasAttribute(a,c)){var d=a.getAttribute(c)||!0;if(\"min\"===c||\"max\"===c){var e=a.getAttribute(\"type\");\"undefined\"!=typeof e&&e||(e=\"text\"),d={typeAttr:e,value:d}}f.addRule(b(),{rule:c,params:d})}});var c=a.getAttribute(\"type\");i(f.configuration.html5InputTypes,function(a){a===c&&f.addRule(b(),{rule:\"date\"===a?\"dateISO\":a,params:!0})})},writeInputValidationAttributes:function(a,b){var c=b();if(c&&c.rules){var d=c.rules();i(f.configuration.html5Attributes,function(b){var c,e=g.arrayFirst(d,function(a){return a.rule.toLowerCase()===b.toLowerCase()});e&&(c=e.params,\"pattern\"===e.rule&&e.params instanceof RegExp&&(c=e.params.source),a.setAttribute(b,c))}),d=null}},makeBindingHandlerValidatable:function(b){var c=a.bindingHandlers[b].init;a.bindingHandlers[b].init=function(b,d,e,f,g){return c(b,d,e,f,g),a.bindingHandlers.validationCore.init(b,d,e,f,g)}},setRules:function(b,c){var d=function(b,c){if(b&&c)for(var e in c)if(c.hasOwnProperty(e)){var g=c[e];if(b[e]){var i=b[e],j=h(i),k={},l={};for(var m in g)g.hasOwnProperty(m)&&(f.rules[m]?k[m]=g[m]:l[m]=g[m]);if(a.isObservable(i)&&i.extend(k),j&&n.isArray(j))for(var o=0;o<j.length;o++)d(j[o],l);else d(j,l)}}};d(b,c)}}}();j(a.validation,m),f.rules={},f.rules.required={validator:function(a,b){var c,d=/^\\s+|\\s+$/g;return void 0===a||null===a?!b:(c=a,\"string\"==typeof a&&(c=a.replace(d,\"\")),b?(c+\"\").length>0:!0)},message:\"This field is required.\"},f.rules.min={validator:c(\"min\"),message:\"Please enter a value greater than or equal to {0}.\"},f.rules.max={validator:c(\"max\"),message:\"Please enter a value less than or equal to {0}.\"},f.rules.minLength={validator:function(a,b){return f.utils.isEmptyVal(a)||a.length>=b},message:\"Please enter at least {0} characters.\"},f.rules.maxLength={validator:function(a,b){return f.utils.isEmptyVal(a)||a.length<=b},message:\"Please enter no more than {0} characters.\"},f.rules.pattern={validator:function(a,b){return f.utils.isEmptyVal(a)||null!==a.toString().match(b)},message:\"Please check this value.\"},f.rules.step={validator:function(a,b){if(f.utils.isEmptyVal(a)||\"any\"===b)return!0;var c=100*a%(100*b);return Math.abs(c)<1e-5||Math.abs(1-c)<1e-5},message:\"The value must increment by {0}.\"},f.rules.email={validator:function(a,b){return b?f.utils.isEmptyVal(a)||b&&/^((([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+(\\.([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+)*)|((\\x22)((((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(([\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(\\\\([\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))))*(((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(\\x22)))@((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))$/i.test(a):!0},message:\"Please enter a proper email address.\"},f.rules.date={validator:function(a,b){return b?f.utils.isEmptyVal(a)||b&&!/Invalid|NaN/.test(new Date(a)):!0},message:\"Please enter a proper date.\"},f.rules.dateISO={validator:function(a,b){return b?f.utils.isEmptyVal(a)||b&&/^\\d{4}[\\/\\-]\\d{1,2}[\\/\\-]\\d{1,2}$/.test(a):!0},message:\"Please enter a proper date.\"},f.rules.number={validator:function(a,b){return b?f.utils.isEmptyVal(a)||b&&/^-?(?:\\d+|\\d{1,3}(?:,\\d{3})+)?(?:\\.\\d+)?$/.test(a):!0},message:\"Please enter a number.\"},f.rules.digit={validator:function(a,b){return b?f.utils.isEmptyVal(a)||b&&/^\\d+$/.test(a):!0},message:\"Please enter a digit.\"},f.rules.phoneUS={validator:function(a,b){return b?f.utils.isEmptyVal(a)?!0:\"string\"!=typeof a?!1:(a=a.replace(/\\s+/g,\"\"),b&&a.length>9&&a.match(/^(1-?)?(\\([2-9]\\d{2}\\)|[2-9]\\d{2})-?[2-9]\\d{2}-?\\d{4}$/)):!0},message:\"Please specify a valid phone number.\"},f.rules.equal={validator:function(a,b){var c=b;return a===f.utils.getValue(c)},message:\"Values must equal.\"},f.rules.notEqual={validator:function(a,b){var c=b;return a!==f.utils.getValue(c)},message:\"Please choose another value.\"},f.rules.unique={validator:function(a,b){var c=f.utils.getValue(b.collection),d=f.utils.getValue(b.externalValue),e=0;return a&&c?(g.arrayFilter(c,function(c){a===(b.valueAccessor?b.valueAccessor(c):c)&&e++}),(d?1:2)>e):!0},message:\"Please make sure the value is unique.\"},function(){f.registerExtenders()}(),a.bindingHandlers.validationCore=function(){return{init:function(b,c){var d=f.utils.getConfigOptions(b),e=c();if(d.parseInputAttributes&&f.utils.async(function(){f.parseInputValidationAttributes(b,c)}),d.insertMessages&&f.utils.isValidatable(e)){var g=f.insertValidationMessage(b);d.messageTemplate?a.renderTemplate(d.messageTemplate,{field:e},null,g,\"replaceNode\"):a.applyBindingsToNode(g,{validationMessage:e})}d.writeInputAttributes&&f.utils.isValidatable(e)&&f.writeInputValidationAttributes(b,c),d.decorateInputElement&&f.utils.isValidatable(e)&&a.applyBindingsToNode(b,{validationElement:e})}}}(),f.makeBindingHandlerValidatable(\"value\"),f.makeBindingHandlerValidatable(\"checked\"),a.bindingHandlers.validationMessage={update:function(b,c){var d=c(),e=f.utils.getConfigOptions(b),i=(h(d),!1),j=!1;if(!d.isValid||!d.isModified)throw new Error(\"Observable is not validatable\");i=d.isModified(),j=d.isValid();var k=null;(!e.messagesOnModified||i)&&(k=j?null:d.error);var l=!e.messagesOnModified||i?!j:!1,m=\"none\"!==b.style.display;e.allowHtmlMessages?g.setHtml(b,k):a.bindingHandlers.text.update(b,function(){return k}),m&&!l?b.style.display=\"none\":!m&&l&&(b.style.display=\"\")}},a.bindingHandlers.validationElement={update:function(b,c,d){var e=c(),g=f.utils.getConfigOptions(b),i=(h(e),!1),j=!1;if(!e.isValid||!e.isModified)throw new Error(\"Observable is not validatable\");i=e.isModified(),j=e.isValid();var k=function(){var a={},b=!g.decorateElementOnModified||i?!j:!1;return a[g.errorElementClass]=b,a};a.bindingHandlers.css.update(b,k,d),g.errorsAsTitle&&a.bindingHandlers.attr.update(b,function(){var a=!g.errorsAsTitleOnModified||i,c=f.utils.getOriginalElementTitle(b);return a&&!j?{title:e.error,\"data-orig-title\":c}:!a||j?{title:c,\"data-orig-title\":null}:void 0})}},a.bindingHandlers.validationOptions=function(){return{init:function(a,b){var c=h(b());if(c){var d=j({},f.configuration);j(d,c),f.utils.setDomData(a,d)}}}}(),a.extenders.validation=function(a,b){return i(f.utils.isArray(b)?b:[b],function(b){f.addAnonymousRule(a,b)}),a},a.extenders.validatable=function(b,c){if(f.utils.isObject(c)||(c={enable:c}),\"enable\"in c||(c.enable=!0),c.enable&&!f.utils.isValidatable(b)){var d=f.configuration.validate||{},e={throttleEvaluation:c.throttle||d.throttle};b.error=a.observable(null),b.rules=a.observableArray(),b.isValidating=a.observable(!1),b.__valid__=a.observable(!0),b.isModified=a.observable(!1),b.isValid=a.computed(b.__valid__),b.setError=function(a){b.error(a),b.__valid__(!1)},b.clearError=function(){return b.error(null),b.__valid__(!0),b};var g=b.subscribe(function(){b.isModified(!0)}),h=a.computed(j({read:function(){b(),b.rules();return f.validateObservable(b),!0}},e));j(h,e),b._disposeValidation=function(){b.isValid.dispose(),b.rules.removeAll(),b.isModified.getSubscriptionsCount()>0&&(b.isModified._subscriptions.change=[]),b.isValidating.getSubscriptionsCount()>0&&(b.isValidating._subscriptions.change=[]),b.__valid__.getSubscriptionsCount()>0&&(b.__valid__._subscriptions.change=[]),g.dispose(),h.dispose(),delete b.rules,delete b.error,delete b.isValid,delete b.isValidating,delete b.__valid__,delete b.isModified}}else c.enable===!1&&b._disposeValidation&&b._disposeValidation();return b},f.validateObservable=function(a){for(var b,c,g=0,h=a.rules(),i=h.length;i>g;g++)if(c=h[g],!c.condition||c.condition())if(b=c.rule?f.rules[c.rule]:c,b.async||c.async)e(a,b,c);else if(!d(a,b,c))return!1;return a.clearError(),!0},f.localize=function(a){var b;for(b in a)f.rules.hasOwnProperty(b)&&(f.rules[b].message=a[b])},a.applyBindingsWithValidation=function(b,c,d){var e,g,h=arguments.length;h>2?(e=c,g=d):2>h?e=document.body:arguments[1].nodeType?e=c:g=arguments[1],f.init(),g&&f.utils.setDomData(e,g),a.applyBindings(b,c)};var n=a.applyBindings;a.applyBindings=function(a,b){f.init(),n(a,b)},a.validatedObservable=function(b){if(!f.utils.isObject(b))return a.observable(b).extend({validatable:!0});var c=a.observable(b);return c.errors=f.group(b),c.isValid=a.observable(b.isValid()),c.errors.subscribe(function(a){c.isValid(0===a.length)}),c}});"]}, {"lines": ["    <script src=\"/static/vendor/bower_components/raven-js/plugins/jquery.js\"></script>", "    <script>"]}, {"lines": ["    % else:", "    <script>", "        window.Raven = {};", "        Raven.captureMessage = function(msg, context) {", "            console.error('=== Mock Raven.captureMessage called with: ===');", "            console.log('Message: ' + msg);", "            console.log(context);", "        };", "        Raven.captureException = function(err, context) {", "            console.error('=== Mock Raven.captureException called with: ===');", "            console.log('Error: ' + err);", "            console.log(context);", "        };", "    </script>"]}, {"lines": ["", "    <!-- Facebook display -->"]}, {"lines": ["                    <a class=\"btn btn-primary btn-sm\" data-bind=\"click: submitUnreportAbuse\">Submit</a>"]}, {"lines": ["                        <input class=\"form-control\" data-bind=\"value: institution\"", "                            placeholder=\"Required\"/>"]}, {"lines": ["                                         optionsCaption: '-- Month --',"]}, {"lines": ["                                         optionsCaption: '-- Month --',"]}, {"lines": ["                        <input class=\"form-control\" data-bind=\"value: institution\"", "                            placeholder=\"Required\" />"]}, {"lines": ["                                         optionsCaption: '-- Month --',"]}, {"lines": ["                                         optionsCaption: '-- Month --',"]}, {"lines": ["                        <th>Start&nbsp;Date</th>", "                        <th>End&nbsp;Date</th>"]}, {"lines": ["<%inherit file=\"base.mako\"/>"]}, {"lines": ["                    <form class='form' data-bind=\"submit: startSearch\">"]}, {"lines": ["                                            <!-- height and width are explicitly specified for faster rendering -->"]}, {"lines": ["                                        <td>"]}, {"lines": ["                                        </td>"]}, {"lines": [""]}, {"lines": ["            var $this = $(this);", "            var val = $this.val();", "            if (val !== '') {"]}, {"lines": ["            }"]}, {"lines": ["# Keep me: Makes rubeus importable from website.util", "from . import rubeus  # noqa"]}, {"lines": ["    return content_type and ('application/json' in content_type)"]}, {"lines": ["    return mimetype"]}], "name": "sloria"}, {"commits": [{"lines": ["FROM_ADDR = 'OSF Support <support@osf.io>'"]}, {"lines": ["    subject='OSF Privacy Notice',"]}, {"lines": [""]}, {"lines": ["FROM_EMAIL = 'openscienceframework-noreply@osf.io'"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    'tags': [", "        'a', 'abbr', 'acronym', 'b', 'bdo', 'big', 'blockquote', 'br',", "        'center', 'cite', 'code',", "        'dd', 'del', 'dfn', 'div', 'dl', 'dt', 'em', 'embed', 'font',", "        'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'hr', 'i', 'img', 'ins',", "        'kbd', 'li', 'object', 'ol', 'param', 'pre', 'p', 'q',", "        's', 'samp', 'small', 'span', 'strike', 'strong', 'sub', 'sup',", "        'table', 'tbody', 'td', 'th', 'thead', 'tr', 'tt', 'ul', 'u',", "        'var', 'wbr',", "    ],", "    'attributes': [", "        'align', 'alt', 'border', 'cite', 'class', 'dir',"]}, {"lines": ["        'face', 'size', # font tags"]}, {"lines": ["    ]", "}", ""]}, {"lines": ["        </div>"]}, {"lines": ["You are receiving this message because you have an account on the Open Science Framework (OSF). We are writing to let you know of a change to our permission model that may affect how you choose to organize your projects."]}, {"lines": ["Contributors on OSF projects have one of three permission statuses: administrator, read+write, and read-only. These affect what actions those contributors can perform on the project. Projects can have sub-components that have contributor lists that are distinct from the project contributor list."]}], "name": "Jeffrey Spies"}, {"commits": [{"lines": ["# -*- coding: utf-8 -*-", "import sys", "from datetime import datetime"]}, {"lines": ["", "from modularodm import Q"]}, {"lines": [""]}, {"lines": ["from website.archiver import ARCHIVER_UNCAUGHT_ERROR, ARCHIVER_FAILURE"]}, {"lines": ["from website.settings import ARCHIVE_TIMEOUT_TIMEDELTA"]}, {"lines": ["from website.archiver.utils import handle_archive_fail"]}, {"lines": ["from website.archiver.model import ArchiveJob", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def find_failed_registrations():"]}, {"lines": ["    jobs = ArchiveJob.find(", "        Q('sent', 'eq', False) &", "        Q('datetime_initiated', 'lt', expired_if_before)"]}, {"lines": ["    )"]}, {"lines": ["    return {node.root for node in [job.dst_node for job in jobs] if node}"]}, {"lines": ["", "def remove_failed_registrations(dry_run=True):"]}, {"lines": ["    failed = find_failed_registrations()", "    if not dry_run:"]}, {"lines": ["        for f in failed:"]}, {"lines": ["            if not f.registered_from:", "                logging.info('Node {0} had registered_from == None'.format(f._id))", "                continue"]}, {"lines": ["            if not f.archive_job:  # Be extra sure not to delete legacy registrations", "                continue"]}, {"lines": ["            f.archive_job.status = ARCHIVER_FAILURE", "            f.archive_job.sent = True", "            f.archive_job.save()"]}, {"lines": ["            handle_archive_fail("]}, {"lines": ["                ARCHIVER_UNCAUGHT_ERROR,"]}, {"lines": ["                f.registered_from,", "                f,", "                f.creator,"]}, {"lines": ["                f.archive_job.target_info()"]}, {"lines": ["            )"]}, {"lines": ["", "def main():"]}, {"lines": ["", "if __name__ == '__main__':", "    main()"]}, {"lines": ["from __future__ import print_function, absolute_import", "", "import time", "import sys", "import argparse", "from faker import Faker", "import itertools"]}, {"lines": ["from random import choice"]}, {"lines": ["", "from modularodm import Q", "", "from framework.auth import Auth", "from website.app import init_app", "from website import models, security"]}, {"lines": ["from tests.factories import NodeFactory"]}, {"lines": ["", "from website.models import NodeLog, Node", "", "fake = Faker()", "", "app = None"]}, {"lines": ["CATEGORY_MAP = Node.CATEGORY_MAP"]}, {"lines": ["descriptors = CATEGORY_MAP.keys()"]}, {"lines": ["", "def create_fake_projects(creator, depth, num_logs, level=1, parent=None):", "    #auth = Auth(user=creator)"]}, {"lines": ["    if depth < 0:"]}, {"lines": ["        return None"]}, {"lines": ["    descriptor = choice(descriptors) if (level % 2 == 0) else 'project'", "    project_title = parent.title + (': ' + CATEGORY_MAP[descriptor]) if (level % 2 == 0) else fake.word()"]}, {"lines": ["    project = NodeFactory.build(title=project_title, description=fake.sentences(), creator=creator, parent=parent, is_public=True, privacy='public', category=descriptor)", "    project.save()"]}, {"lines": ["    for i in range(int(num_logs)):", "        project.add_log('wiki_updated', {"]}, {"lines": ["            'node': project._id,"]}, {"lines": ["        },", "            Auth(creator),", "        )", "    project.save()", "    nextlevel = level + 1", "    nextdepth = int(depth) - 1", "    for i in range(nextlevel):", "        create_fake_projects(creator, nextdepth, num_logs, nextlevel, project)", "    return project", "", "class Result(object):", "    def __init__(self, *args, **kwargs):", "        self.keys = kwargs.keys()", "        for k, v in kwargs.iteritems():", "            setattr(self, k, v)", "    @property", "    def data(self):", "        ret = {}", "        for k in self.keys:", "            ret[k] = getattr(self, k)", "        return ret", "", "def get_nodes_recursive(project, include):", "    children = list(project.nodes)", "    descendants = children + [item for node in project.nodes for item in get_nodes_recursive(node, include)]", "    return [project] + [desc for desc in descendants if include(desc)]", "", "def get_aggregate_logs(ids, user, count=100):", "    query = Q('params.node', 'in', ids)", "    return list(NodeLog.find(query).sort('date').limit(int(count)))", "", "def get_logs(user, project, depth):", "    print (\"Fetching logs\")", "    t0 = time.clock()", "    nodes = get_nodes_recursive(project, lambda p: p.can_view(Auth(user)))", "    ids = [n._id for n in nodes]", "    t1 = time.clock()", "    logs = get_aggregate_logs(ids, user)", "    logs = [l for l in logs]", "    t2 = time.clock()", "    agg_time = t1 - t0", "    fetch_time = t2 - t1", "    total_time = t2 - t0", "    print (\"Took {0}s to fetch {1} logs with a depth of {2}\".format(total_time, len(logs), depth))", "    return Result(", "        total_time=total_time,", "        agg_time=agg_time,", "        fetch_time=fetch_time,", "        num_logs=len(logs),", "        depth=depth,", "    )", "", "def clean_up(creator, project):", "    if len(project.nodes) == 0:", "        project.remove_node(Auth(creator))", "    else:", "        [clean_up(creator, node) for node in project.nodes]", "", "def parse_args():", "    parser = argparse.ArgumentParser(description='Create fake data.')", "    parser.add_argument('-u', '--user', dest='user', required=True)", "    parser.add_argument('-d', '--depth', dest='depth', default=2)", "    parser.add_argument('-l', '--num-logs', dest='num_logs', default=10)"]}, {"lines": ["    parser.add_argument('-c', '--clean_up', dest='clean_up', default='true')"]}, {"lines": ["    return parser.parse_args()", "", "def run(username, depth, num_logs):", "    app = init_app('website.settings', set_backends=True, routes=True)", "    creator = models.User.find(Q('username', 'eq', username))[0]", "    project = create_fake_projects(creator, depth, num_logs)", "    ret = get_logs(creator, project, depth)"]}, {"lines": ["    if clean_up in ('true', 'True', True):", "        clean_up(creator, project)"]}, {"lines": ["    return ret", "", "def main():", "    args = parse_args()", "    run(args.user, int(args.depth or 0), int(args.num_logs or 0))", "    sys.exit(0)", "", "if __name__ == '__main__':", "    main()"]}, {"lines": ["from website.project.views.node import _view_project as serialize_node"]}, {"lines": ["    return kwargs.get('node') or kwargs.get('parent')"]}, {"lines": ["        node = NodeFactory(parent=self.project, creator=user)"]}, {"lines": ["        assert_equal(res, node)"]}, {"lines": ["        node = NodeFactory(parent=self.project, creator=user)"]}, {"lines": ["        mock_to_nodes.return_value = (None, project)"]}, {"lines": ["        mock_to_nodes.return_value = (None, project)"]}, {"lines": ["        mock_to_nodes.return_value = (None, project)"]}, {"lines": ["        mock_kwargs_to_nodes.return_value = (None, self.project)"]}, {"lines": ["        mock_kwargs_to_nodes.return_value = (None, self.project)"]}, {"lines": ["        mock_kwargs_to_nodes.return_value = (None, self.project)"]}, {"lines": ["import mock"]}, {"lines": ["        search.delete_index(elastic_search.INDEX)"]}, {"lines": ["    @mock.patch('website.project.model.Node.archiving', mock.PropertyMock(return_value=False))"]}, {"lines": ["    @mock.patch('website.project.model.Node.archiving', mock.PropertyMock(return_value=False))"]}, {"lines": ["        self.registration.update_search()"]}, {"lines": ["            parent=self.project,"]}, {"lines": ["        self.project.set_title('hello &amp; world', self.consolidate_auth)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from framework.tasks import handlers"]}, {"lines": ["    def setUp(self, *args, **kwargs):"]}, {"lines": ["        super(TestMailChimpHelpers, self).setUp(*args, **kwargs)", "        with self.context:", "            handlers.celery_before_request()"]}, {"lines": [""]}, {"lines": ["        handlers.celery_teardown_request()"]}, {"lines": ["        handlers.celery_teardown_request()"]}, {"lines": ["        handlers.celery_teardown_request()"]}, {"lines": ["        self.node = factories.NodeFactory(creator=self.user, parent=self.parent)"]}, {"lines": ["        node = factories.NodeFactory(parent=parent, category='project')", "        sub_component = factories.NodeFactory(parent=node)"]}, {"lines": ["        sub_component2 = factories.NodeFactory(parent=node)"]}, {"lines": ["        node = factories.NodeFactory(parent=parent, category='project')", "        sub_component = factories.NodeFactory(parent=node)"]}, {"lines": ["        sub_component2 = factories.NodeFactory(parent=node)"]}, {"lines": ["        node = factories.NodeFactory(parent=parent, category='project')", "        sub_component = factories.NodeFactory(parent=node)"]}, {"lines": ["        node = factories.NodeFactory(parent=parent, category='project')"]}, {"lines": ["        node = factories.NodeFactory(parent=parent, category='project')", "        sub_component = factories.NodeFactory(parent=node)"]}, {"lines": ["        self.node = factories.NodeFactory(parent=self.project)"]}, {"lines": ["        self.node = factories.NodeFactory(parent=self.project, creator=self.user)"]}, {"lines": ["        node = factories.NodeFactory(parent=self.project, category='project')"]}, {"lines": ["        node = factories.NodeFactory(parent=private_project)"]}, {"lines": ["        node = factories.NodeFactory(parent=private_project)"]}, {"lines": ["        node = factories.NodeFactory(parent=self.project)"]}, {"lines": ["        node = factories.NodeFactory(parent=private_project)"]}, {"lines": ["        self.node = factories.NodeFactory(parent=self.project)"]}, {"lines": ["    def test_email_transactional_sent_without_errors(self):", "", "        users = [factories.UserFactory() for i in range(5)]", "        context = dict(", "            gravatar_url=self.user.gravatar_url,", "            content='',", "            target_user=None,", "            parent_comment='',", "            url=self.node.absolute_url", "        )", "        try:", "            emails.email_transactional(", "                [u._id for u in users],", "                self.node._id,", "                'comments',", "                self.user,", "                self.project,", "                datetime.datetime.utcnow(),", "                **context", "            )", "            assert(True)", "        except Exception:", "            assert(False)", "", "    def test_email_digest_sent_without_errors(self):", "", "        users = [factories.UserFactory() for i in range(5)]", "        context = dict(", "            gravatar_url=self.user.gravatar_url,", "            content='',", "            target_user=None,", "            parent_comment='',", "            url=self.node.absolute_url", "        )", "        try:", "            emails.email_digest(", "                [u._id for u in users],", "                self.node._id,", "                'comments',", "                self.user,", "                self.project,", "                datetime.datetime.utcnow(),", "                **context", "            )", "            assert(True)", "        except Exception:", "            assert(False)", ""]}, {"lines": ["        node = factories.NodeFactory(parent=project)"]}, {"lines": ["        node = factories.NodeFactory(parent=project)"]}, {"lines": ["        node = factories.NodeFactory(parent=project)"]}, {"lines": ["", ""]}, {"lines": [""]}, {"lines": ["from website.archiver import utils as archiver_utils"]}, {"lines": ["            parent=self.project,"]}, {"lines": ["            parent=self.parent_project,"]}, {"lines": ["    @mock.patch('website.archiver.tasks.archive.si')", "    def test_register_template_page(self, mock_archive):"]}, {"lines": ["        archiver_utils.archive_success(self.project.node__registrations[0], self.project.creator)"]}, {"lines": ["    @mock.patch('framework.tasks.handlers.enqueue_task')", "    def test_register_template_make_public_creates_public_registration(self, mock_enquque):"]}, {"lines": ["    @mock.patch('website.archiver.tasks.archive.si')", "    def test_register_template_with_embargo_creates_embargo(self, mock_archive):"]}, {"lines": ["    @mock.patch('website.archiver.tasks.archive.si')", "    def test_registered_projects_contributions(self, mock_archive):"]}, {"lines": ["                    params={'node': self.project._id}"]}, {"lines": ["                    params={'node': self.project._id}"]}, {"lines": ["                    params={'node': self.project._id}"]}, {"lines": ["                    params={\"node\": self.project._id}"]}, {"lines": ["                params={'node': self.project._id}"]}, {"lines": ["        child = NodeFactory(parent=self.project)"]}, {"lines": ["                params={'node': child._id}"]}, {"lines": ["                log['params']['node']"]}, {"lines": ["                params={'node': self.project._id}"]}, {"lines": ["        child = NodeFactory(parent=self.project)"]}, {"lines": ["        url = self.project.api_url_for('get_logs')"]}, {"lines": ["                log['params']['node']"]}, {"lines": ["        node = NodeFactory(parent=self.project, creator=self.user1)"]}, {"lines": ["        node = NodeFactory(parent=self.project, creator=self.user1)"]}, {"lines": ["        assert_equal(0, res.json['node']['fork_count'])"]}, {"lines": ["        self.child = ProjectFactory(parent=self.project, creator=self.user, is_public=True)", "        self.grandchild = ProjectFactory(parent=self.child, creator=self.user, is_public=False)", "        self.great_grandchild = ProjectFactory(parent=self.grandchild, creator=self.user, is_public=True)", "        self.great_great_grandchild = ProjectFactory(parent=self.great_grandchild, creator=self.user, is_public=False)"]}, {"lines": ["        child = NodeFactory(parent=project, creator=self.user)"]}, {"lines": ["        read_only_pointed = ProjectFactory()"]}, {"lines": ["        child = NodeFactory(parent=project, creator=self.user)"]}, {"lines": ["        NodeFactory(parent=project, creator=self.user)"]}, {"lines": ["        from website.project.signals import unreg_contributor_added"]}, {"lines": ["        child = NodeFactory(parent=self.project, creator=self.creator)"]}, {"lines": ["            NodeLog.TAG_ADDED,", "            params={'node': self.project._primary_key},", "            auth=self.consolidate_auth,", "            log_date=dt.datetime.utcnow(),"]}, {"lines": ["        node = NodeFactory(creator=self.user, parent=self.project, is_public=True)"]}, {"lines": ["        self.project.set_privacy('private')"]}, {"lines": ["        self.url = api_url_for('search_projects_by_title')"]}, {"lines": ["        component = NodeFactory(creator=self.creator, parent=project)"]}, {"lines": ["        component = NodeFactory(creator=self.creator, parent=project)"]}, {"lines": ["        assert_equal(len(nodes), 2)"]}, {"lines": ["        component = NodeFactory(creator=self.creator, parent=project)"]}, {"lines": ["        # friend requests dashboard nodes, filtering against components"]}, {"lines": ["    def test_registered_components_with_are_accessible_from_dashboard(self):"]}, {"lines": ["        component = NodeFactory(creator=self.creator, parent=project)"]}, {"lines": [""]}, {"lines": ["    def test_archiving_nodes_appear_in_all_my_registrations(self):", "        project = ProjectFactory(creator=self.creator, public=False)", "        reg = RegistrationFactory(project=project, user=self.creator)", "", "        # Get the All My Registrations smart folder from the dashboard", "        url = api_url_for('get_dashboard', nid=ALL_MY_REGISTRATIONS_ID)", "        res = self.app.get(url, auth=self.creator.auth)", "", "        assert_equal(res.json['data'][0]['node_id'], reg._id)", ""]}, {"lines": ["        res = self.app.post(url, auth=non_contributor.auth)"]}, {"lines": ["        res = self.app.post(url, auth=contributor.auth)"]}, {"lines": ["        self.public_component = NodeFactory(parent=self.public, is_public=True)"]}, {"lines": ["    an embargo period of up to four years. At the end of the embargo period,"]}, {"lines": ["    directories=[EMAIL_TEMPLATES_DIR],"]}, {"lines": [""]}, {"lines": [")"]}, {"lines": [""]}, {"lines": ["UNESCAPE = \"<% from website.util.sanitize import safe_unescape_html %> ${safe_unescape_html(src.title)}\"", "PROBLEM_REGISTERING = \"Problem registering \" + UNESCAPE", ""]}, {"lines": ["ARCHIVE_SIZE_EXCEEDED_DESK = Mail(", "    'archive_size_exceeded_desk',"]}, {"lines": ["    subject=PROBLEM_REGISTERING"]}, {"lines": [")", "ARCHIVE_SIZE_EXCEEDED_USER = Mail(", "    'archive_size_exceeded_user',"]}, {"lines": ["    subject=PROBLEM_REGISTERING"]}, {"lines": [")", "", "ARCHIVE_COPY_ERROR_DESK = Mail(", "    'archive_copy_error_desk',"]}, {"lines": ["    subject=PROBLEM_REGISTERING"]}, {"lines": [")", "ARCHIVE_COPY_ERROR_USER = Mail(", "    'archive_copy_error_user',"]}, {"lines": ["    subject=PROBLEM_REGISTERING"]}, {"lines": [")", ""]}, {"lines": ["ARCHIVE_UNCAUGHT_ERROR_DESK = Mail(", "    'archive_uncaught_error_desk',"]}, {"lines": ["    subject=PROBLEM_REGISTERING"]}, {"lines": [")", "ARCHIVE_UNCAUGHT_ERROR_USER = Mail(", "    'archive_uncaught_error_user',"]}, {"lines": ["    subject=PROBLEM_REGISTERING"]}, {"lines": [")", ""]}, {"lines": ["ARCHIVE_SUCCESS = Mail(", "    'archive_success',"]}, {"lines": ["    subject=\"Registration of \" + UNESCAPE + \" complete\""]}, {"lines": [")"]}, {"lines": ["        # Update", "        Rule(", "            [", "                '/project/<pid>/',", "                '/project/<pid>/node/<nid>/',", "            ],", "            'put',", "            project_views.node.update_node,", "            json_renderer,", "        ),", ""]}, {"lines": ["            [", "                '/registration/<pid>/callbacks/',", "            ],", "            'put',", "            project_views.register.registration_callbacks,", "            json_renderer,", "        ),"]}, {"lines": ["from website.project import signals as project"]}, {"lines": ["]"]}, {"lines": ["from time import sleep"]}, {"lines": [""]}, {"lines": ["from framework.exceptions import (", "    PermissionsError,", "    HTTPError,", ")"]}, {"lines": ["from website.util import waterbutler_url_for"]}, {"lines": ["from website.oauth.signals import oauth_complete", ""]}, {"lines": ["NODE_SETTINGS_TEMPLATE_DEFAULT = os.path.join(", "    settings.TEMPLATES_PATH,", "    'project',", "    'addon',", "    'node_settings_default.mako',", ")", "", "USER_SETTINGS_TEMPLATE_DEFAULT = os.path.join(", "    settings.TEMPLATES_PATH,", "    'project',", "    'addon',", "    'user_settings_default.mako',", ")"]}, {"lines": ["        if not user_settings_template or not os.path.exists(os.path.dirname(user_settings_template)):", "            # Use the default template (ATM for OAuth addons)"]}, {"lines": ["            self.user_settings_template = USER_SETTINGS_TEMPLATE_DEFAULT"]}, {"lines": ["        # Provide the path the the node_settings template"]}, {"lines": ["        if not node_settings_template or not os.path.exists(os.path.dirname(node_settings_template)):"]}, {"lines": ["            # Use the default template"]}, {"lines": ["            self.node_settings_template = NODE_SETTINGS_TEMPLATE_DEFAULT"]}, {"lines": ["        template_dirs = list(", "            set(", "                [", "                    path", "                    for path in [os.path.dirname(self.user_settings_template), os.path.dirname(self.node_settings_template), settings.TEMPLATES_PATH]", "                    if os.path.exists(path)"]}, {"lines": ["        if template_dirs:", "            self.template_lookup = TemplateLookup(", "                directories=template_dirs"]}, {"lines": ["            self.template_lookup = None"]}, {"lines": ["            if node_addon.owner and not node_addon.owner.is_deleted"]}, {"lines": ["            if node is None:", "                continue"]}, {"lines": ["            },", "            'node_settings_template': os.path.basename(self.config.node_settings_template),"]}, {"lines": ["############", "# Archiver #", "############"]}, {"lines": ["class GenericRootNode(object):", "    path = '/'", "    name = ''", ""]}, {"lines": ["class StorageAddonBase(object):"]}, {"lines": ["    \"\"\"", "    Mixin class for traversing file trees of addons with files", "    \"\"\""]}, {"lines": [""]}, {"lines": ["    root_node = GenericRootNode()"]}, {"lines": [""]}, {"lines": ["    @property", "    def archive_folder_name(self):", "        name = \"Archive of {addon}\".format(addon=self.config.full_name)"]}, {"lines": ["        folder_name = getattr(self, 'folder_name', '').lstrip('/').strip()"]}, {"lines": ["        if folder_name:", "            name = name + \": {folder}\".format(folder=folder_name)", "        return name", ""]}, {"lines": ["    def _get_fileobj_child_metadata(self, filenode, user, cookie=None, version=None):"]}, {"lines": ["        kwargs = dict("]}, {"lines": ["            provider=self.config.short_name,"]}, {"lines": ["            path=filenode.get('path', ''),"]}, {"lines": ["            node=self.owner,"]}, {"lines": ["            user=user,", "            view_only=True,"]}, {"lines": ["        )"]}, {"lines": ["        if cookie:", "            kwargs['cookie'] = cookie"]}, {"lines": ["        if version:", "            kwargs['version'] = version"]}, {"lines": ["        metadata_url = waterbutler_url_for(", "            'metadata',", "            **kwargs", "        )"]}, {"lines": ["        res = requests.get(metadata_url)", "        if res.status_code != 200:"]}, {"lines": ["            raise HTTPError(res.status_code, data={", "                'error': res.json(),", "            })"]}, {"lines": ["        # TODO: better throttling?", "        sleep(1.0 / 5.0)"]}, {"lines": ["        return res.json().get('data', [])"]}, {"lines": [""]}, {"lines": ["    def _get_file_tree(self, filenode=None, user=None, cookie=None, version=None):"]}, {"lines": ["        \"\"\"", "        Recursively get file metadata", "        \"\"\""]}, {"lines": ["        filenode = filenode or {"]}, {"lines": ["            'path': '/',"]}, {"lines": ["            'kind': 'folder',"]}, {"lines": ["            'name': self.root_node.name,"]}, {"lines": ["        }"]}, {"lines": ["        if filenode.get('kind') == 'file':", "            return filenode"]}, {"lines": ["        elif 'size' in filenode:", "            return filenode"]}, {"lines": ["        kwargs = {", "            'version': version,", "            'cookie': cookie,", "        }"]}, {"lines": ["        filenode['children'] = [", "            self._get_file_tree(child, user, cookie=cookie)", "            for child in self._get_fileobj_child_metadata(filenode, user, **kwargs)", "        ]"]}, {"lines": ["        return filenode"]}, {"lines": ["import abc", ""]}, {"lines": ["from website.util import api_url_for, web_url_for"]}, {"lines": [""]}, {"lines": ["class AddonSerializer(object):", "    __metaclass__ = abc.ABCMeta", ""]}, {"lines": ["    # TODO take addon_node_settings, addon_user_settings"]}, {"lines": ["", "    @abc.abstractproperty"]}, {"lines": ["    def addon_serialized_urls(self):", "        pass", "", "    @abc.abstractproperty"]}, {"lines": ["    def serialized_urls(self):", "        pass", "", "    @abc.abstractproperty"]}, {"lines": ["    def user_is_owner(self):", "        pass", "", "    @abc.abstractproperty", "    def credentials_owner(self):", "        pass", "", "    @property"]}, {"lines": ["        result = {"]}, {"lines": ["            'userIsOwner': self.user_is_owner,"]}, {"lines": ["            'urls': self.serialized_urls,", "        }", ""]}, {"lines": ["            owner = self.credentials_owner", "            if owner:", "                result['urls']['owner'] = web_url_for('profile_view_id',", "                                                  uid=owner._primary_key)", "                result['ownerName'] = owner.fullname", "", "        return result", ""]}, {"lines": ["        retval['accounts'] = []"]}, {"lines": ["        if self.user_settings:", "            retval['accounts'] = self.serialized_accounts"]}, {"lines": ["            'provider_name': external_account.provider_name,", "            'provider_short_name': external_account.provider,"]}, {"lines": ["            ],"]}, {"lines": [""]}, {"lines": ["    REQUIRED_URLS = ['importAuth', 'folders', 'config', 'deauthorize', 'accounts']", ""]}, {"lines": ["    @property"]}, {"lines": ["    def serialized_urls(self):"]}, {"lines": ["        ret = {", "            'auth': api_url_for('oauth_connect',"]}, {"lines": ["            'settings': web_url_for('user_addons'),"]}, {"lines": ["        }", "        if external_account and external_account.profile_url:", "            ret['owner'] = external_account.profile_url"]}, {"lines": [""]}, {"lines": ["        addon_urls = self.addon_serialized_urls", "        # Make sure developer returns set of needed urls", "        for url in self.REQUIRED_URLS:"]}, {"lines": ["        ret.update(addon_urls)"]}, {"lines": ["        return ret", "", "    @property"]}, {"lines": ["        result['folder'] = {", "            'name': self.node_settings.selected_folder_name", "        }"]}, {"lines": ["        return result", "", "    @property"]}, {"lines": ["    def user_is_owner(self):"]}, {"lines": ["", "    @property", "    def credentials_owner(self):"]}, {"lines": [""]}, {"lines": ["    @abc.abstractmethod", "    def serialize_folder(self, folder):", "        pass", "", "    def serialize_citation(self, citation):", "        return {", "            'csl': citation,", "            'kind': 'file',", "            'id': citation['id'],", "        }"]}, {"lines": ["from website.project.utils import serialize_node"]}, {"lines": ["            ('create_waterbutler_log' if not node.is_registration else 'registration_callbacks'),"]}, {"lines": ["'use strict';"]}, {"lines": ["var AddonNodeConfig = require('js/addonNodeConfig').AddonNodeConfig;"]}, {"lines": ["new AddonNodeConfig('Box', '#boxScope', url, '#boxGrid', {", "    onPickFolder: function(evt, item) {", "        evt.preventDefault();", "        var name = item.data.path === 'All Files' ? '/ (Full Box)' : item.data.path.replace('All Files', '');", "        this.selected({", "            name: name,", "            path: item.data.path,", "            id: item.data.id", "        });", "        return false; // Prevent event propagation", "    }", "});"]}, {"lines": ["", "</div>"]}, {"lines": ["        name = '/ (Full Box)'"]}, {"lines": ["        'name': '/ (Full Box)',"]}, {"lines": ["                'name': path.replace('All Files', '') if path != 'All Files' else '/ (Full Box)',"]}, {"lines": ["import abc"]}, {"lines": ["", "from framework.exceptions import HTTPError"]}, {"lines": [""]}, {"lines": ["from website.oauth.models import ExternalAccount", ""]}, {"lines": ["class CitationsProvider(object):", "", "    __metaclass__ = abc.ABCMeta"]}, {"lines": ["    def __init__(self, provider_name):"]}, {"lines": ["        self.provider_name = provider_name"]}, {"lines": ["    @abc.abstractproperty", "    def serializer(self):", "        pass"]}, {"lines": [""]}, {"lines": ["    def user_accounts(self, user):", "        \"\"\" Gets a list of the accounts authorized by 'user' \"\"\"", "        return {", "            'accounts': ["]}, {"lines": ["                    user_settings=user.get_addon(self.provider_name) if user else None"]}, {"lines": ["                for each in user.external_accounts"]}, {"lines": ["                if each.provider == self.provider_name", "            ]", "        }", ""]}, {"lines": ["        # Ensure request has all required information"]}, {"lines": [""]}, {"lines": ["    def add_user_auth(self, node_addon, user, external_account_id):"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        if external_account not in user.external_accounts:", "            raise HTTPError(http.FORBIDDEN)", ""]}, {"lines": [""]}, {"lines": ["        return {'result': result}", ""]}, {"lines": ["    def remove_user_auth(self, node_addon, user):", ""]}, {"lines": ["        return {'result': result}", ""]}, {"lines": ["    def widget(self, node_addon):"]}, {"lines": ["        ret = node_addon.config.to_json()", "        ret.update({", "            'complete': node_addon.complete,", "        })", "        return ret", ""]}, {"lines": ["    def _extract_folder(self, folder):", "        folder = self._folder_to_dict(folder)", "        ret = {", "            'name': folder['name'],", "            'provider_list_id': folder['list_id'],", "            'id': folder['id'],", "        }", "        if folder['parent_id']:", "            ret['parent_list_id'] = folder['parent_id']", "        return ret"]}, {"lines": [""]}, {"lines": ["    @abc.abstractmethod", "    def _folder_to_dict(self, data):", "        pass"]}, {"lines": ["", "    @abc.abstractmethod"]}, {"lines": ["    def _folder_id(self):", "", "        return None", "", "    def citation_list(self, node_addon, user, list_id, show='all'):", "", "        attached_list_id = self._folder_id(node_addon)", "        account_folders = node_addon.api.citation_lists(self._extract_folder)", "", "        # Folders with 'parent_list_id'==None are children of 'All Documents'", "        for folder in account_folders:", "            if folder.get('parent_list_id') is None:", "                folder['parent_list_id'] = 'ROOT'", "", "        node_account = node_addon.external_account", "        user_accounts = [", "            account for account in user.external_accounts", "            if account.provider == self.provider_name"]}, {"lines": ["        ] if user else []"]}, {"lines": ["        user_is_owner = node_account in user_accounts", "", "        # verify this list is the attached list or its descendant", "        if not user_is_owner and (list_id != attached_list_id and attached_list_id is not None):", "            folders = {", "                (each['provider_list_id'] or 'ROOT'): each", "                for each in account_folders", "            }", "            if list_id is None:", "                ancestor_id = 'ROOT'", "            else:", "                ancestor_id = folders[list_id].get('parent_list_id')", "", "            while ancestor_id != attached_list_id:", "                if ancestor_id is '__':", "                    raise HTTPError(http.FORBIDDEN)", "                ancestor_id = folders[ancestor_id].get('parent_list_id')", "", "        contents = []", "        if list_id is None:", "            contents = [node_addon.root_folder]", "        else:"]}, {"lines": ["            user_settings = user.get_addon(self.provider_name) if user else None"]}, {"lines": ["            if show in ('all', 'folders'):", "                contents += ["]}, {"lines": ["                        user_settings=user_settings,"]}, {"lines": ["                    for each in account_folders", "                    if each.get('parent_list_id') == list_id", "                ]", "", "            if show in ('all', 'citations'):", "                contents += ["]}, {"lines": ["                        user_settings=user_settings,"]}, {"lines": ["                    for each in node_addon.api.get_list(list_id)", "                ]", "", "        return {", "            'contents': contents", "        }"]}, {"lines": ["import os", ""]}, {"lines": ["HERE = os.path.dirname(os.path.abspath(__file__))", "NODE_SETTINGS_TEMPLATE = os.path.join(HERE, 'templates', 'dataverse_node_settings.mako')", "USER_SETTINGS_TEMPLATE = os.path.join(HERE, 'templates', 'dataverse_user_settings.mako')"]}, {"lines": ["from time import sleep", "import requests"]}, {"lines": ["import httplib as http"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website.addons.base import StorageAddonBase"]}, {"lines": ["from website.util import waterbutler_url_for"]}, {"lines": [""]}, {"lines": ["from website.addons.dataverse.client import connect_from_settings_or_401"]}, {"lines": ["class AddonDataverseNodeSettings(StorageAddonBase, AddonNodeSettingsBase):"]}, {"lines": ["    def folder_name(self):", "        return self.dataset", "", "    @property"]}, {"lines": ["    def _get_fileobj_child_metadata(self, filenode, user, cookie=None, version=None):", "        kwargs = dict(", "            provider=self.config.short_name,", "            path=filenode.get('path', ''),", "            node=self.owner,", "            user=user,", "            view_only=True,", "        )", "        if cookie:", "            kwargs['cookie'] = cookie", "        if version:", "            kwargs['version'] = version", "        metadata_url = waterbutler_url_for(", "            'metadata',", "            **kwargs", "        )", "        res = requests.get(metadata_url)", "        if res.status_code != 200:", "            # The Dataverse API returns a 404 if the dataset has no published files", "            if res.status_code == http.NOT_FOUND and version == 'latest-published':", "                return []", "            raise HTTPError(res.status_code, data={", "                'error': res.json(),", "            })", "        # TODO: better throttling?", "        sleep(1.0 / 5.0)", "        return res.json().get('data', [])", ""]}, {"lines": [" * Module that controls the Dataverse node settings. Includes Knockout view-model", " * for syncing data.", " */"]}, {"lines": ["var Raven = require('raven-js');", ""]}, {"lines": ["    self.messages = {"]}, {"lines": ["        userSettingsError: ko.pureComputed(function() {"]}, {"lines": ["            return 'Could not retrieve settings. Please refresh the page or ' +", "                'contact <a href=\"mailto: support@osf.io\">support@osf.io</a> if the ' +", "                'problem persists.';", "        }),"]}, {"lines": ["        confirmNodeDeauth: ko.pureComputed(function() {"]}, {"lines": ["            return 'Are you sure you want to unlink this Dataverse account? This will ' +", "                'revoke the ability to view, download, modify, and upload files ' +"]}, {"lines": ["                'Dataverse authorization from your <a href=\"' + self.urls().settings + '\">user settings</a> ' +", "                'page.';", "        }),"]}, {"lines": ["        confirmImportAuth: ko.pureComputed(function() {"]}, {"lines": ["            return 'Are you sure you want to authorize this project with your Dataverse credentials?';", "        }),"]}, {"lines": ["        deauthError: ko.pureComputed(function() {"]}, {"lines": ["            return 'Could not unlink Dataverse at this time. Please refresh the page or ' +", "                'contact <a href=\"mailto: support@osf.io\">support@osf.io</a> if the ' +", "                'problem persists.';", "        }),"]}, {"lines": ["        deauthSuccess: ko.pureComputed(function() {"]}, {"lines": ["            return 'Successfully unlinked your Dataverse account.';", "        }),"]}, {"lines": ["        authInvalid: ko.pureComputed(function() {"]}, {"lines": ["        }),"]}, {"lines": ["        authError: ko.pureComputed(function() {", "            return 'There was a problem connecting to the Dataverse. Please refresh the page or ' +", "                'contact <a href=\"mailto: support@osf.io\">support@osf.io</a> if the ' +", "                'problem persists.';", "        }),", "        importAuthSuccess: ko.pureComputed(function() {"]}, {"lines": ["            return 'Successfully linked your Dataverse account';", "        }),"]}, {"lines": ["        importAuthError: ko.pureComputed(function() {"]}, {"lines": ["            return 'There was a problem connecting to the Dataverse. Please refresh the page or ' +", "                'contact <a href=\"mailto: support@osf.io\">support@osf.io</a> if the ' +", "                'problem persists.';", "        }),"]}, {"lines": ["                'and cannot be connected to the OSF.';", "        }),"]}, {"lines": ["        forbiddenCharacters: ko.pureComputed(function() {"]}, {"lines": ["                'development team.';", "        }),"]}, {"lines": ["        setInfoSuccess: ko.pureComputed(function() {"]}, {"lines": ["            var filesUrl = window.contextVars.node.urls.web + 'files/';"]}, {"lines": ["                filesUrl + '\">Files page</a> to view your content.';", "        }),"]}, {"lines": ["                'contact <a href=\"mailto: support@osf.io\">support@osf.io</a> if the ' +", "                'problem persists.';", "        }),"]}, {"lines": ["                'contact <a href=\"mailto: support@osf.io\">support@osf.io</a> if the ' +", "                'problem persists.';", "        })", "    };"]}, {"lines": [""]}, {"lines": ["    self.savedDataverseUrl = ko.pureComputed(function() {"]}, {"lines": ["    self.selectedDataverseTitle = ko.pureComputed(function() {", "        for (var i = 0; i < self.dataverses().length; i++) {"]}, {"lines": ["    self.showLinkDataverse = ko.pureComputed(function() {"]}, {"lines": ["    self.credentialsChanged = ko.pureComputed(function() {"]}, {"lines": ["    self.showInputCredentials = ko.pureComputed(function() {", "        return (self.credentialsChanged() && self.userIsOwner()) ||"]}, {"lines": ["    self.hasDataverses = ko.pureComputed(function() {"]}, {"lines": ["    self.showNotFound = ko.pureComputed(function() {"]}, {"lines": ["    // Flashed messages", "    self.message = ko.observable('');", "    self.messageClass = ko.observable('text-info');"]}, {"lines": ["        self.changeMessage(self.messages.userSettingsError, 'text-warning');"]}, {"lines": ["}"]}, {"lines": ["/**", " * Update the view model from data returned from the server.", " */"]}, {"lines": ["ViewModel.prototype.updateFromData = function(data) {", "    var self = this;", "    self.urls(data.urls);"]}, {"lines": ["    self.ownerName(data.ownerName);", "    self.nodeHasAuth(data.nodeHasAuth);", "    self.userHasAuth(data.userHasAuth);", "    self.userIsOwner(data.userIsOwner);"]}, {"lines": ["    if (self.nodeHasAuth()) {", "        self.dataverses(data.dataverses);", "        self.savedDataverseAlias(data.savedDataverse.alias);", "        self.savedDataverseTitle(data.savedDataverse.title);", "        self.selectedDataverseAlias(data.savedDataverse.alias);"]}, {"lines": ["        self.connected(data.connected);", "        if (self.userIsOwner()) {"]}, {"lines": ["        }", "    }", "};"]}, {"lines": ["ViewModel.prototype.setInfo = function() {", "    var self = this;", "    self.submitting(true);"]}, {"lines": ["    return osfHelpers.postJSON("]}, {"lines": ["        self.urls().set,", "        ko.toJS({", "            dataverse: {", "                alias: self.selectedDataverseAlias", "            },"]}, {"lines": ["        })", "    ).done(function() {", "        self.submitting(false);", "        self.savedDataverseAlias(self.selectedDataverseAlias());", "        self.savedDataverseTitle(self.selectedDataverseTitle());"]}, {"lines": ["        self.changeMessage(self.messages.setInfoSuccess, 'text-success');"]}, {"lines": ["    }).fail(function(xhr, textStatus, error) {", "        self.submitting(false);"]}, {"lines": ["        Raven.captureMessage('Could not authenticate with Dataverse', {", "            url: self.urls().set,", "            textStatus: textStatus,", "            error: error", "        });", "    });", "};"]}, {"lines": ["/**"]}, {"lines": [" * This prevents an additional request to the server, but requires additional logic.", " */"]}, {"lines": ["    var self = this;"]}, {"lines": ["            return;"]}, {"lines": ["    }", "};"]}, {"lines": ["    var self = this;"]}, {"lines": ["    return osfHelpers.postJSON("]}, {"lines": ["        ko.toJS({", "            alias: self.selectedDataverseAlias", "        })", "    ).done(function(response) {"]}, {"lines": ["    });", "};"]}, {"lines": ["ViewModel.prototype.authorizeNode = function() {", "    var self = this;", "    return osfHelpers.putJSON(", "        self.urls().importAuth, {}", "    ).done(function(response) {", "        self.updateFromData(response.result);"]}, {"lines": ["        self.changeMessage(self.messages.importAuthSuccess, 'text-success', 3000);"]}, {"lines": ["        self.changeMessage(self.messages.importAuthError, 'text-danger');"]}, {"lines": ["    });", "};"]}, {"lines": ["/** Send POST request to authorize Dataverse */", "ViewModel.prototype.sendAuth = function() {", "    var self = this;", "    return osfHelpers.postJSON(", "        self.urls().create,"]}, {"lines": ["    ).done(function() {", "        // User now has auth", "        self.authorizeNode();", "    }).fail(function(xhr) {"]}, {"lines": ["        var errorMessage = (xhr.status === 401) ? self.messages.authInvalid : self.messages.authError;"]}, {"lines": ["        self.changeMessage(errorMessage, 'text-danger');", "    });", "};"]}, {"lines": ["/**", " *  Send PUT request to import access token from user profile.", " */", "ViewModel.prototype.importAuth = function() {", "    var self = this;", "    bootbox.confirm({", "        title: 'Link to Dataverse Account?',"]}, {"lines": ["        message: self.messages.confirmImportAuth(),"]}, {"lines": ["        callback: function(confirmed) {", "            if (confirmed) {", "                self.authorizeNode();"]}, {"lines": ["        }", "    });", "};"]}, {"lines": ["ViewModel.prototype.clickDeauth = function() {", "    var self = this;"]}, {"lines": ["            self.changeMessage(self.messages.deauthSuccess, 'text-success', 3000);"]}, {"lines": ["            self.changeMessage(self.messages.deauthError, 'text-danger');"]}, {"lines": ["    bootbox.confirm({", "        title: 'Deauthorize?',"]}, {"lines": ["        message: self.messages.confirmNodeDeauth(),"]}, {"lines": ["        callback: function(confirmed) {", "            if (confirmed) {", "                sendDeauth();", "            }"]}, {"lines": ["    });", "};"]}, {"lines": ["/** Change the flashed status message */", "ViewModel.prototype.changeMessage = function(text, css, timeout) {"]}, {"lines": ["    var self = this;"]}, {"lines": ["    if (typeof text === 'function') {", "        text = text();", "    }", "    self.message(text);", "    var cssClass = css || 'text-info';", "    self.messageClass(cssClass);", "    if (timeout) {", "        // Reset message after timeout period", "        setTimeout(function() {", "            self.message('');", "            self.messageClass('text-info');", "        }, timeout);", "    }", "};"]}, {"lines": ["in"]}, {"lines": ["in"]}, {"lines": ["<span class=\"overflow\">{{ params.dataset }}</span> to"]}, {"lines": ["<span class=\"overflow\">{{ params.study }}</span> to"]}, {"lines": ["<span class=\"overflow\">{{ params.dataset }}</span> to", "for"]}, {"lines": ["<span class=\"overflow\">{{ params.study }}</span> to", "for"]}, {"lines": ["authorized the Dataverse addon for"]}, {"lines": ["deauthorized the Dataverse addon for"]}, {"lines": ["Dropbox in"]}, {"lines": ["Dropbox in"]}, {"lines": ["Dropbox in"]}, {"lines": ["Dropbox in"]}, {"lines": ["linked Dropbox folder <span class=\"overflow\">{{ params.folder === '/' ? '/ (Full Dropbox)' : params.folder }}</span> to"]}, {"lines": ["deauthorized the Dropbox addon for"]}, {"lines": ["authorized the Dropbox addon for"]}, {"lines": ["    @mock.patch('website.archiver.tasks.archive.si')", "    def test_does_not_get_copied_to_registrations(self, mock_archive):"]}, {"lines": ["import os", "import json"]}, {"lines": ["", "import requests"]}, {"lines": ["from . import settings as figshare_settings"]}, {"lines": ["class Figshare(object):", ""]}, {"lines": ["        # if no OAuth", "        if owner_token is None:", "            self.session = requests", "        else:", "            self.client_token = client_token", "            self.client_secret = client_secret", "            self.owner_token = owner_token", "            self.owner_secret = owner_secret", "", "            self.session = OAuth1Session(", "                client_token,", "                client_secret=client_secret,", "                resource_owner_key=owner_token,"]}, {"lines": ["            )"]}, {"lines": ["", "    @classmethod", "    def from_settings(cls, settings):", "        if settings is None or not hasattr(settings, 'oauth_access_token'):", "            return cls(None, None, None, None)", "        else:", "            return cls("]}, {"lines": ["                client_token=figshare_settings.CLIENT_ID or '',", "                client_secret=figshare_settings.CLIENT_SECRET or '',", "                owner_token=settings.oauth_access_token or '',", "                owner_secret=settings.oauth_access_token_secret or '',"]}, {"lines": ["            )", ""]}, {"lines": ["    def _send(self, url, method='get', output='json', cache=True, **kwargs):"]}, {"lines": ["        func = getattr(self.session, method.lower())"]}, {"lines": ["        # Send request", "        req = func(url, **kwargs)", "", "        # Get return value", "        rv = None", "        if 200 <= req.status_code < 300:", "            if output is None:", "                rv = req", "            else:", "                rv = getattr(req, output)", "                if callable(rv):", "                    rv = rv()"]}, {"lines": ["        else:"]}, {"lines": ["            return False"]}, {"lines": ["        mapper = kwargs.get('mapper')", "        if mapper:", "            del kwargs['mapper']", "", "        files = kwargs.get('files')", "        data = kwargs.get('data')", "", "        func = getattr(self.session, method.lower())", "", "        req = None"]}, {"lines": ["        headers = {}", "        if data:"]}, {"lines": ["        elif files:", "            req = func(url, **kwargs)", "        if 200 <= req.status_code < 300:", "            if output is None:", "                return req", "            rv = getattr(req, output)", "            if mapper:"]}, {"lines": ["            elif callable(rv):"]}, {"lines": ["            return rv", "        else:"]}, {"lines": ["", "    # PROJECT LEVEL API"]}, {"lines": ["    def projects(self, node_settings):", "        res = self._send(os.path.join(node_settings.api_url, 'projects'))", "        return res"]}, {"lines": ["    def project(self, node_settings, project_id):"]}, {"lines": ["        if not project_id:", "            return"]}, {"lines": ["        if not project:"]}, {"lines": ["        project['articles'] = []"]}, {"lines": ["        if(articles):"]}, {"lines": ["            project['articles'] = []", "            for article in articles:", "                fetched = self.article(node_settings, article['id'])", "                if fetched:", "                    project['articles'].append(fetched['items'][0])"]}, {"lines": [""]}, {"lines": ["    # ARTICLE LEVEL API"]}, {"lines": ["        if not articles:", "            return [], self.last_error", "        articles = [self.article(node_settings, article['article_id']) for article in articles['items']]", "        return articles, 200"]}, {"lines": [""]}, {"lines": ["        if res.status_code == 200:", "            data = json.loads(res.content)", "            if data['count'] == 0:", "                return False", "            elif data['items'][0]['status'] == 'Public':", "                return True", "        return False", ""]}, {"lines": ["        return res"]}, {"lines": ["    # OTHER HELPERS"]}, {"lines": ["    def get_options(self):", "        projects = self._send(\"http://api.figshare.com/v1/my_data/projects\")"]}, {"lines": ["            [{'label': (article['title'] or 'untitled article'), 'value': 'fileset_{0}'.format(article['article_id'])}"]}, {"lines": [""]}, {"lines": ["    def categories(self):", "        return self._send(\"http://api.figshare.com/v1/categories\")", ""]}, {"lines": ["    def handle_error(self, request):", "        # TODO handle errors nicely", "        return False"]}, {"lines": ["from website.addons.base import StorageAddonBase"]}, {"lines": ["from .api import Figshare"]}, {"lines": ["from . import settings as figshare_settings"]}, {"lines": ["class AddonFigShareUserSettings(AddonUserSettingsBase):", "", "    oauth_request_token = fields.StringField()", "    oauth_request_token_secret = fields.StringField()", "    oauth_access_token = fields.StringField()"]}, {"lines": ["", "    @property", "    def has_auth(self):", "        return self.oauth_access_token is not None"]}, {"lines": ["    def to_json(self, user):"]}, {"lines": ["            'authorized': self.has_auth,", "        })"]}, {"lines": [""]}, {"lines": ["class AddonFigShareNodeSettings(StorageAddonBase, AddonNodeSettingsBase):"]}, {"lines": ["    figshare_type = fields.StringField()"]}, {"lines": ["        'addonfigshareusersettings', backref='authorized'", "    )"]}, {"lines": ["    @property", "    def folder_name(self):"]}, {"lines": ["        return self.figshare_title"]}, {"lines": [""]}, {"lines": ["    def archive_errors(self):", "        api = Figshare.from_settings(self.user_settings)", "        items = []", "        if self.figshare_type in ('article', 'fileset'):", "            items = api.article(self, self.figshare_id)['items']", "        else:", "            items = api.project(self, self.figshare_id)['articles']", "        private = any(", "            [item for item in items if item['status'] != 'Public']", "        )", "", "        if private:", "            return 'The figshare {figshare_type} <strong>{figshare_title}</strong> contains private content that we cannot copy to the registration. If this content is made public on figshare we should then be able to copy those files. You can view those files <a href=\"{url}\" target=\"_blank\">here.</a>'.format(", "                figshare_type=self.figshare_type,", "                figshare_title=self.figshare_title,", "                url=self.owner.web_url_for('collect_file_trees'))", ""]}, {"lines": ["    @property"]}, {"lines": ["    def linked_content(self):"]}, {"lines": ["            'name': self.figshare_title,"]}, {"lines": [""]}, {"lines": ["        self.user_settings = user_settings"]}, {"lines": ["        node.add_log(", "            action='figshare_node_authorized',"]}, {"lines": ["            params={", "                'project': node.parent_id,"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["        \"\"\"Remove user authorization from this node and log the event.\"\"\"", "        self.user_settings = None", "        self.figshare_id = None", "        self.figshare_type = None"]}, {"lines": ["", "        if add_log:", "            node = self.owner", "            self.owner.add_log("]}, {"lines": [""]}, {"lines": ["        updated = False"]}, {"lines": ["        if fields.get('id'):", "            updated = updated or (fields['id'] != self.figshare_id)", "            self.figshare_id = fields['id']"]}, {"lines": ["        if fields.get('name'):", "            updated = updated or (fields['name'] != self.figshare_title)", "            self.figshare_title = fields['name']"]}, {"lines": ["        if fields.get('type'):", "            updated = updated or (fields['type'] != self.figshare_type)"]}, {"lines": [""]}, {"lines": ["        self.save()", "        if updated:", "            node.add_log(", "                action='figshare_content_linked',", "                params={", "                    'project': node.parent_id,", "                    'node': node._id,", "                    'figshare': {", "                        'type': self.figshare_type,", "                        'id': self.figshare_id,", "                        'title': self.figshare_title,"]}, {"lines": ["                    },"]}, {"lines": ["                auth=auth,"]}, {"lines": [""]}, {"lines": ["            'figshare_type': self.figshare_type or '',"]}, {"lines": ["    #############", "    # Callbacks #", "    #############"]}, {"lines": ["    def before_page_load(self, node, user):", "        \"\"\"", "", "        :param Node node:", "        :param User user:", "        :return str: Alert message", "", "        \"\"\""]}, {"lines": ["        figshare = node.get_addon('figshare')", "        # Quit if no user authorization"]}, {"lines": [""]}, {"lines": ["        node_permissions = 'public' if node.is_public else 'private'", ""]}, {"lines": ["        if figshare.figshare_type == 'project':", "            if node_permissions == 'private':", "                message = messages.BEFORE_PAGE_LOAD_PRIVATE_NODE_MIXED_FS.format(category=node.project_or_component, project_id=figshare.figshare_id)", "                return [message]", "            else:", "                message = messages.BEFORE_PAGE_LOAD_PUBLIC_NODE_MIXED_FS.format(category=node.project_or_component, project_id=figshare.figshare_id)"]}, {"lines": [""]}, {"lines": ["        if article_permissions != node_permissions:"]}, {"lines": ["            message = messages.BEFORE_PAGE_LOAD_PERM_MISMATCH.format("]}, {"lines": ["            if article_permissions == 'private' and node_permissions == 'public':", "                message += messages.BEFORE_PAGE_LOAD_PUBLIC_NODE_PRIVATE_FS"]}, {"lines": ["", "    def before_remove_contributor(self, node, removed):", "        \"\"\""]}, {"lines": ["        :param Node node:", "        :param User removed:", "        :return str: Alert message"]}, {"lines": ["        \"\"\"", "        if self.user_settings and self.user_settings.owner == removed:"]}, {"lines": ["            return messages.BEFORE_REMOVE_CONTRIBUTOR.format("]}, {"lines": ["                category=node.project_or_component,"]}, {"lines": ["        \"\"\""]}, {"lines": ["        :param Node node:", "        :param User removed:", "        :return str: Alert message"]}, {"lines": ["        \"\"\"", "        if self.user_settings and self.user_settings.owner == removed:"]}, {"lines": ["            # Delete OAuth tokens", "            self.user_settings = None"]}, {"lines": ["            self.save()"]}, {"lines": ["    def before_fork(self, node, user):", "        \"\"\""]}, {"lines": ["        :param Node node:", "        :param User user:", "        :return str: Alert message"]}, {"lines": ["        \"\"\"", "        if self.user_settings and self.user_settings.owner == user:"]}, {"lines": ["            return messages.BEFORE_FORK_OWNER.format(", "                category=node.project_or_component,"]}, {"lines": ["        return messages.BEFORE_FORK_NOT_OWNER.format(", "            category=node.project_or_component,"]}, {"lines": ["    def after_fork(self, node, fork, user, save=True):", "        \"\"\""]}, {"lines": ["        :param Node node: Original node", "        :param Node fork: Forked node", "        :param User user: User creating fork", "        :param bool save: Save settings after callback", "        :return tuple: Tuple of cloned settings and alert message"]}, {"lines": ["        \"\"\"", "        clone, _ = super(AddonFigShareNodeSettings, self).after_fork(", "            node, fork, user, save=False"]}, {"lines": ["        # Copy authentication if authenticated by forking user", "        if self.user_settings and self.user_settings.owner == user:", "            clone.user_settings = self.user_settings"]}, {"lines": ["            message = messages.AFTER_FORK_OWNER.format(", "                category=fork.project_or_component,"]}, {"lines": ["        else:"]}, {"lines": ["            message = messages.AFTER_FORK_NOT_OWNER.format(", "                category=fork.project_or_component,"]}, {"lines": ["                url=fork.url + 'settings/'"]}, {"lines": ["        if save:", "            clone.save()"]}, {"lines": ["        return clone, message"]}, {"lines": ["from website.util import rubeus", "", "def options_to_hgrid(node, fs_options):", "    permissions = {"]}, {"lines": ["    }", "    for o in fs_options:", "        parts = o['value'].split('_')", "        ftype = parts[0]", "        fid = int(parts[1])", "        o['name'] = o['label']", "        o[rubeus.KIND] = rubeus.FOLDER"]}, {"lines": ["        o['permissions'] = permissions"]}, {"lines": ["        o['type'] = ftype", "        o['id'] = fid"]}, {"lines": ["        # Currently we flatten the FS data structure when rendering in folderPicker.", "        # This lets folderPicker know these items have no children to be expanded", "        o['hasChildren'] = False"]}, {"lines": ["    return fs_options", ""]}, {"lines": ["        if not project.get('articles') or len(project['articles']) == 0:", "            return []"]}, {"lines": ["CLIENT_ID = None", "CLIENT_SECRET = None", ""]}, {"lines": ["API_URL = 'http://api.figshare.com/v1/'", "API_OAUTH_URL = API_URL + 'my_data/'", ""]}, {"lines": ["MAX_RENDER_SIZE = 1000"]}, {"lines": ["'use strict';", ""]}, {"lines": ["var AddonNodeConfig = require('js/addonNodeConfig').AddonNodeConfig;"]}, {"lines": ["new AddonNodeConfig('figshare', '#figshareScope', url, '#figshareGrid', {"]}, {"lines": ["    onPickFolder: function (evt, item) {", "        evt.preventDefault();", "        this.selected({name: item.data.name, type: item.data.type, id: item.data.id});", "        return false; // Prevent event propagation", "    }", "});"]}, {"lines": ["<!-- Authorization -->", "<div>"]}, {"lines": ["</div>", ""]}, {"lines": ["from nose.tools import *", ""]}, {"lines": [""]}, {"lines": ["from website.addons.figshare import settings as figshare_settings", ""]}, {"lines": ["", "    def setUp(self):", "", "        super(TestCallbacks, self).setUp()"]}, {"lines": ["        self.project.add_contributor(", "            contributor=self.non_authenticator,"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["        self.project.creator.add_addon('figshare')", "        self.node_settings = self.project.get_addon('figshare')", "        self.user_settings = self.project.creator.get_addon('figshare')"]}, {"lines": ["        self.node_settings.user_settings = self.user_settings", "        self.node_settings.figshare_id = '123456'"]}, {"lines": ["        self.node_settings.save()", ""]}, {"lines": ["    def test_update_fields_project(self):", "        num_logs = len(self.project.logs)", "        # try updating fields", "        newfields = {", "            'type': 'project',"]}, {"lines": ["            'id': '313131',"]}, {"lines": ["            'name': 'A PROJECT'"]}, {"lines": ["        self.node_settings.update_fields(newfields, self.project, Auth(self.project.creator))", "        #check for updated"]}, {"lines": ["        assert_equals(self.node_settings.figshare_id, '313131')"]}, {"lines": ["        assert_equals(self.node_settings.figshare_type, 'project')", "        assert_equals(self.node_settings.figshare_title, 'A PROJECT')", "        # check for log added"]}, {"lines": ["", "    def test_update_fields_fileset(self):", "        num_logs = len(self.project.logs)", "        # try updating fields", "        newfields = {", "            'type': 'fileset',"]}, {"lines": ["            'id': '313131',"]}, {"lines": ["            'name': 'A FILESET'"]}, {"lines": ["        self.node_settings.update_fields(newfields, self.project, Auth(self.project.creator))", "        #check for updated"]}, {"lines": ["        assert_equals(self.node_settings.figshare_id, '313131')"]}, {"lines": ["        assert_equals(self.node_settings.figshare_type, 'fileset')", "        assert_equals(self.node_settings.figshare_title, 'A FILESET')", "        # check for log added"]}, {"lines": ["", "    def test_update_fields_some_missing(self):", "        num_logs = len(self.project.logs)", "        # try updating fields", "        newfields = {", "            'type': 'project',"]}, {"lines": ["            'id': '313131',"]}, {"lines": ["            'name': 'A PROJECT'"]}, {"lines": ["        self.node_settings.update_fields(newfields, self.project, Auth(self.project.creator))", "        #check for updated"]}, {"lines": ["        assert_equals(self.node_settings.figshare_id, '313131')"]}, {"lines": ["        assert_equals(self.node_settings.figshare_title, 'A PROJECT')", "        # check for log added"]}, {"lines": ["", "    def test_update_fields_invalid(self):", "        num_logs = len(self.project.logs)", "        # try updating fields", "        newfields = {"]}, {"lines": ["            'i1513': '313131',"]}, {"lines": ["            'titladad': 'A PROJECT'"]}, {"lines": ["        self.node_settings.update_fields(newfields, self.project, Auth(self.project.creator))", "        #check for updated", "        assert_equals(self.node_settings.figshare_id, '123456')", "        assert_equals(self.node_settings.figshare_type, 'project')", "        assert_equals(self.node_settings.figshare_title, 'singlefile')", "        # check for log added", "        assert_equals(len(self.project.logs), num_logs)", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def test_before_remove_contributor_authenticator(self):", "        message = self.node_settings.before_remove_contributor(", "            self.project, self.project.creator"]}, {"lines": ["        assert_true(message)", "", "    def test_before_remove_contributor_not_authenticator(self):", "        message = self.node_settings.before_remove_contributor(", "            self.project, self.non_authenticator", "        )", "        assert_false(message)", ""]}, {"lines": ["        )"]}, {"lines": ["        assert_equal(", "            self.node_settings.user_settings,", "            None", "        )"]}, {"lines": [""]}, {"lines": ["    def test_after_fork_authenticator(self):", "        fork = ProjectFactory()", "        clone, message = self.node_settings.after_fork(", "            self.project, fork, self.project.creator,", "        )", "        assert_equal(", "            self.node_settings.user_settings,", "            clone.user_settings,", "        )", "", "    def test_after_fork_not_authenticator(self):", "        fork = ProjectFactory()", "        clone, message = self.node_settings.after_fork(", "            self.project, fork, self.non_authenticator,", "        )", "        assert_equal(", "            clone.user_settings,", "            None,", "        )", ""]}, {"lines": ["    @mock.patch('website.archiver.tasks.archive.si')"]}, {"lines": ["    @mock.patch('website.addons.figshare.model.AddonFigShareNodeSettings.archive_errors')", "    def test_does_not_get_copied_to_registrations(self, mock_errors, mock_archive):"]}, {"lines": ["import mock", "", "from website.addons.figshare.api import Figshare", ""]}, {"lines": ["article = {u'count': 1, u'items': [{u'status': u'Draft', u'files': [{u'thumb': None, u'download_url': u'http://files.figshare.com/1348803/0NUTZ', u'name': u'0NUTZ', u'id': 1348803, u'mime_type': u'text/plain', u'size': u'0 KB'}, {u'thumb': None, u'download_url': u'http://files.figshare.com/1348805/0MNXS', u'name': u'0MNXS', u'id': 1348805, u'mime_type': u'text/plain', u'size': u'0 KB'}, {u'thumb': None, u'download_url': u'http://files.figshare.com/1348806/0NUTZ', u'name': u'0NUTZ', u'id': 1348806, u'mime_type': u'text/plain', u'size': u'0 KB'}, {u'thumb': None, u'download_url': u'http://files.figshare.com/1348807/0OX1G', u'name': u'0OX1G', u'id': 1348807, u'mime_type': u'text/plain', u'size': u'0 KB'}, {u'thumb': u'http://previews.figshare.com/1350751/250_1350751.jpg', u'download_url': u'http://files.figshare.com/1350751/Selection_003.png', u'name': u'Selection_003.png', u'id': 1350751, u'mime_type': u'image/png', u'size': u'18 KB'}, {u'thumb': u'http://previews.figshare.com/1350754/250_1350754.jpg', u'download_url': u'http://files.figshare.com/1350754/Selection_003.png', u'name': u'Selection_003.png', u'id': 1350754, u'mime_type': u'image/png', u'size': u'18 KB'}], u'description': u'<p>This is made using python</p>', u'links': [], u'title': u'New fileset', u'total_size': u'34.59 KB', u'master_publisher_id': 0, u'authors': [{u'first_name': u'Samuel', u'last_name': u'Chrisinger', u'id': 506241, u'full_name': u'Samuel Chrisinger'}], u'defined_type': u'fileset', u'version': 15, u'categories': [{u'id': 77, u'name': u'Applied Computer Science'}], u'published_date': u'22:13, Jan 16, 2014', u'description_nohtml': u'This is made using python', u'article_id': 902210, u'tags': [{u'id': 3564, u'name': u'code'}]}]}", ""]}, {"lines": ["def create_mock_figshare(project):", "    figshare_mock = mock.create_autospec(Figshare)"]}, {"lines": ["    figshare_mock.projects.return_value = [{u'owner': 506241, u'description': u'', u'id': 436, u'title': u'OSF Test'}]"]}, {"lines": ["    figshare_mock.articles.return_value = article"]}, {"lines": ["    figshare_mock.article.return_value = article"]}, {"lines": [""]}, {"lines": ["    return figshare_mock"]}, {"lines": ["import os", "import httplib as http", ""]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["", "from website import models"]}, {"lines": [""]}, {"lines": ["from ..auth import oauth_start_url, oauth_get_token"]}, {"lines": [""]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["", "    nid = kwargs.get('nid') or kwargs.get('pid')", "    node = models.Node.load(nid) if nid else None", "", "    if node and not node.is_contributor(user):"]}, {"lines": ["", "    user.add_addon('figshare')", "    figshare_user = user.get_addon('figshare')", "", "    if node:", "        figshare_node = node.get_addon('figshare')", "        figshare_node.user_settings = figshare_user", "        figshare_node.save()"]}, {"lines": ["    request_token, request_token_secret, authorization_url = oauth_start_url(user, node)", "", "    figshare_user.oauth_request_token = request_token", "    figshare_user.oauth_request_token_secret = request_token_secret", "    figshare_user.save()"]}, {"lines": ["    return redirect(authorization_url)", "", ""]}, {"lines": ["@must_have_addon('figshare', 'node')"]}, {"lines": ["    node = kwargs['node'] or kwargs['project']"]}, {"lines": [""]}, {"lines": ["", "    node.add_log("]}, {"lines": ["", "    return {}", ""]}, {"lines": [""]}, {"lines": ["", "    nid = kwargs.get('nid') or kwargs.get('pid')", "    node = models.Node.load(nid) if nid else None"]}, {"lines": ["    # Fail if node provided and user not contributor", "    if node and not node.is_contributor(user):", "        raise HTTPError(http.FORBIDDEN)", "", "    if user is None:", "        raise HTTPError(http.NOT_FOUND)", "    if kwargs.get('nid') and not node:", "        raise HTTPError(http.NOT_FOUND)", "", "    figshare_user = user.get_addon('figshare')", "", "    verifier = request.args.get('oauth_verifier')", "", "    access_token, access_token_secret = oauth_get_token("]}, {"lines": ["        figshare_user.oauth_request_token_secret,", "        verifier", "    )"]}, {"lines": ["", "    figshare_user.oauth_request_token = None", "    figshare_user.oauth_request_token_secret = None", "    figshare_user.oauth_access_token = access_token", "    figshare_user.oauth_access_token_secret = access_token_secret", "    figshare_user.save()"]}, {"lines": ["        figshare_node.user_settings = figshare_user"]}, {"lines": ["        figshare_node.save()"]}, {"lines": ["    if node:", "        return redirect(os.path.join(node.url, 'settings'))"]}, {"lines": ["", ""]}, {"lines": ["@must_have_addon('figshare', 'node')"]}, {"lines": [""]}, {"lines": ["    node = kwargs['node'] or kwargs['project']", "", "    figshare_node = node.get_addon('figshare')", "    figshare_user = user.get_addon('figshare')", "", "    if figshare_node is None or figshare_user is None:", "        raise HTTPError(http.BAD_REQUEST)", "", "    figshare_node.user_settings = figshare_user", "    # ensure api url is correct"]}, {"lines": ["    figshare_node.save()", "", "    return {}", ""]}, {"lines": [""]}, {"lines": ["    return {}"]}, {"lines": ["from website.util import rubeus"]}, {"lines": ["", "from ..api import Figshare", ""]}, {"lines": ["def figshare_hgrid_data(node_settings, auth, parent=None, **kwargs):"]}, {"lines": ["            node_settings, u'{0}:{1}'.format(node_settings.figshare_title or \"Unnamed {0}\".format(node_settings.figshare_type or ''), node_settings.figshare_id), permissions=auth,"]}, {"lines": ["    complete = True", ""]}, {"lines": ["    @property", "    def link_text(self):"]}, {"lines": ["    @mock.patch('website.archiver.tasks.archive.si')", "    def test_does_not_get_copied_to_registrations(self, mock_archive):"]}, {"lines": ["        assert_true('GitHub' in res.json['prompts'][1])", ""]}, {"lines": ["from website.addons.base import StorageAddonBase"]}, {"lines": ["class GoogleDriveNodeSettings(StorageAddonBase, AddonNodeSettingsBase):"]}, {"lines": ["from website.addons.googledrive.exceptions import ExpiredAuthError"]}, {"lines": ["        'folders': node.api_url_for('googledrive_folders'),"]}, {"lines": ["        'auth': node.api_url_for('googledrive_oauth_start'),"]}, {"lines": ["", "    valid_credentials = True", "    if user_settings:", "        try:"]}, {"lines": ["            user_settings.fetch_access_token()"]}, {"lines": ["        except ExpiredAuthError:"]}, {"lines": ["            valid_credentials = False"]}, {"lines": ["        'urls': serialize_urls(node_settings),", "        'validCredentials': valid_credentials,"]}, {"lines": ["            ret['folder'] = {", "                'name': '/ (Full Google Drive)' if path == '/' else '/' + path,", "                'path': '/' + path.lstrip('/'),", "            }"]}, {"lines": ["        'folders': node.api_url_for('googledrive_folders', folderId=item['id'], path=path),"]}, {"lines": ["'use strict';"]}, {"lines": ["var AddonNodeConfig = require('js/addonNodeConfig').AddonNodeConfig;"]}, {"lines": ["", "var url = window.contextVars.node.urls.api + 'googledrive/config/';"]}, {"lines": ["            <a data-bind=\"attr.href: urls().create\" class=\"text-primary pull-right addon-auth\">"]}, {"lines": ["    @mock.patch('website.archiver.tasks.archive.si')", "    def test_does_not_get_copied_to_registrations(self, mock_archive):"]}, {"lines": ["    return redirect(authorization_url)"]}, {"lines": ["                'folders': node.api_url_for('googledrive_folders', folderId=about['rootFolderId'])"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from website.addons.citations.provider import CitationsProvider"]}, {"lines": ["from website.addons.mendeley.serializer import MendeleySerializer", "", "class MendeleyCitationsProvider(CitationsProvider):"]}, {"lines": ["", "    def __init__(self):"]}, {"lines": ["        super(MendeleyCitationsProvider, self).__init__('mendeley')"]}, {"lines": ["", "    @property", "    def serializer(self):", "        return MendeleySerializer", ""]}, {"lines": ["    def widget(self, node_addon):"]}, {"lines": ["        ret = super(MendeleyCitationsProvider, self).widget(node_addon)", "        ret.update({", "            'list_id': node_addon.mendeley_list_id", "        })", "        return ret", ""]}, {"lines": ["    def _folder_to_dict(self, data):", "        return dict(", "            name=data.name,"]}, {"lines": ["            list_id=data.json['id'],", "            parent_id=data.json.get('parent_id'),"]}, {"lines": ["            id=data.json.get('id'),"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["    def _folder_id(self, node_addon):"]}, {"lines": ["        return node_addon.mendeley_list_id"]}, {"lines": ["from website.addons.base.serializer import CitationsAddonSerializer", "", "class MendeleySerializer(CitationsAddonSerializer):", ""]}, {"lines": ["    def serialize_folder(self, folder):", "        return {", "            'data': folder,", "            'kind': 'folder',", "            'name': folder['name'],", "            'id': folder['id'],", "            'urls': {"]}, {"lines": ["                    'mendeley_citation_list',"]}, {"lines": ["                    mendeley_list_id=folder['id']", "                ),"]}, {"lines": ["            },", "        }", "", "    @property", "    def addon_serialized_urls(self):"]}, {"lines": ["", "        return {", "            'importAuth': node.api_url_for('mendeley_add_user_auth'),", "            'folders': node.api_url_for('mendeley_citation_list'),", "            'config': node.api_url_for('mendeley_set_config'),", "            'deauthorize': node.api_url_for('mendeley_remove_user_auth'),"]}, {"lines": ["            'accounts': node.api_url_for('mendeley_get_user_accounts'),"]}, {"lines": ["        }"]}, {"lines": ["from framework.auth.decorators import must_be_logged_in"]}, {"lines": ["from website.project.decorators import (", "    must_be_contributor_or_public,", "    must_have_permission,", "    must_not_be_registration,", "    must_have_addon,", ")"]}, {"lines": [""]}, {"lines": ["from .provider import MendeleyCitationsProvider"]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["def mendeley_get_user_accounts(auth):"]}, {"lines": ["    \"\"\" Returns the list of all of the current user's authorized Mendeley accounts \"\"\""]}, {"lines": ["def mendeley_get_config(auth, node_addon, **kwargs):"]}, {"lines": ["    \"\"\" Serialize node addon settings and relevant urls"]}, {"lines": ["    provider = MendeleyCitationsProvider()"]}, {"lines": ["    return {", "        'result': provider.serializer(", "            node_addon,", "            auth.user.get_addon('mendeley')", "        ).serialized_node_settings", "    }"]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["def mendeley_set_config(auth, node_addon, **kwargs):"]}, {"lines": ["    \"\"\" Updates MendeleyNodeSettings based on submitted account and folder information \"\"\""]}, {"lines": [""]}, {"lines": ["    provider = MendeleyCitationsProvider()"]}, {"lines": ["    args = request.get_json()"]}, {"lines": ["    external_list_id = args.get('external_list_id')"]}, {"lines": ["    provider.set_config("]}, {"lines": ["        node_addon,", "        auth.user,"]}, {"lines": ["        external_list_id,"]}, {"lines": ["    return {", "        'result': provider.serializer(", "            node_addon,", "            auth.user.get_addon('mendeley')", "        ).serialized_node_settings", "    }"]}, {"lines": ["", "@must_have_permission('write')", "@must_have_addon('mendeley', 'node')"]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["def mendeley_add_user_auth(auth, node_addon, **kwargs):"]}, {"lines": ["    \"\"\" Allows for importing existing auth to MendeleyNodeSettings \"\"\""]}, {"lines": ["    provider = MendeleyCitationsProvider()"]}, {"lines": ["    external_account_id = request.get_json().get('external_account_id')"]}, {"lines": ["", ""]}, {"lines": ["@must_have_permission('write')", "@must_have_addon('mendeley', 'node')"]}, {"lines": ["def mendeley_remove_user_auth(auth, node_addon, **kwargs):"]}, {"lines": ["    \"\"\" Removes auth from MendeleyNodeSettings \"\"\""]}, {"lines": ["    provider = MendeleyCitationsProvider()", "    return provider.remove_user_auth(node_addon, auth.user)"]}, {"lines": ["    \"\"\" Collects and serializes settting needed to build the widget \"\"\""]}, {"lines": ["    provider = MendeleyCitationsProvider()", "    return provider.widget(node_addon)"]}, {"lines": ["def mendeley_citation_list(auth, node_addon, mendeley_list_id=None, **kwargs):"]}, {"lines": ["    provider = MendeleyCitationsProvider()", "    show = request.args.get('view', 'all')"]}, {"lines": ["from website.addons.mendeley.provider import MendeleyCitationsProvider"]}, {"lines": [""]}, {"lines": ["        res = self.provider.citation_lists(MendeleyCitationsProvider()._extract_folder)"]}, {"lines": ["import httpretty"]}, {"lines": [""]}, {"lines": ["from website.addons.mendeley.serializer import MendeleySerializer"]}, {"lines": ["from utils import mock_responses", ""]}, {"lines": [""]}, {"lines": ["class MockFolder(object):", "    def __init__(self, **kwargs):"]}, {"lines": ["        for k, v in kwargs.iteritems():"]}, {"lines": ["            setattr(self, k, v)"]}, {"lines": ["        self.account.display_name = self.user.fullname", "        self.account.save()"]}, {"lines": ["        #self.user_addon.grant_oauth_access(self.node_addon, self.account, metadata={'lists': 'list'})"]}, {"lines": ["    def test_serialize_settings_authorizer(self):"]}, {"lines": ["        #\"\"\"dict: a serialized version of user-specific addon settings\"\"\""]}, {"lines": ["            auth=self.user.auth,"]}, {"lines": ["        result = res.json['result']", "        assert_true(result['nodeHasAuth'])", "        assert_true(result['userHasAuth'])", "        assert_true(result['userIsOwner'])", "        assert_equal(result['folder'], {'name': ''})", "        assert_equal(result['ownerName'], self.user.fullname)", "        assert_true(result['urls']['auth'])", "        assert_true(result['urls']['config'])", "        assert_true(result['urls']['deauthorize'])", "        assert_true(result['urls']['folders'])", "        assert_true(result['urls']['importAuth'])", "        assert_true(result['urls']['settings'])"]}, {"lines": ["", "    def test_serialize_settings_non_authorizer(self):"]}, {"lines": ["        #\"\"\"dict: a serialized version of user-specific addon settings\"\"\""]}, {"lines": ["        non_authorizing_user = AuthUserFactory()"]}, {"lines": ["        self.project.add_contributor(non_authorizing_user, save=True)"]}, {"lines": ["            auth=non_authorizing_user.auth,"]}, {"lines": ["        result = res.json['result']", "        assert_true(result['nodeHasAuth'])", "        assert_false(result['userHasAuth'])", "        assert_false(result['userIsOwner'])", "        assert_equal(result['folder'], {'name': ''})", "        assert_equal(result['ownerName'], self.user.fullname)", "        assert_true(result['urls']['auth'])", "        assert_true(result['urls']['config'])", "        assert_true(result['urls']['deauthorize'])", "        assert_true(result['urls']['folders'])", "        assert_true(result['urls']['importAuth'])", "        assert_true(result['urls']['settings'])"]}, {"lines": [""]}, {"lines": ["        res = self.app.put_json("]}, {"lines": ["    @mock.patch('website.addons.mendeley.model.Mendeley._folder_metadata')", "    def test_set_config_owner(self, mock_metadata):", "        mock_metadata.return_value = MockFolder(name='Fake Folder')"]}, {"lines": ["        self.node_addon.reload()"]}, {"lines": ["        serializer = MendeleySerializer(node_settings=self.node_addon, user_settings=self.user_addon)", "        expected = {", "            'result': serializer.serialized_node_settings", "        }", "        assert_equal(res.json, expected)", "", "    @mock.patch('website.addons.mendeley.model.Mendeley._folder_metadata')", "    def test_set_config_not_owner(self, mock_metadata):", "        mock_metadata.return_value = MockFolder(name='Fake Folder')"]}, {"lines": ["        serializer = MendeleySerializer(node_settings=self.node_addon, user_settings=None)", "        expected = {", "            'result': serializer.serialized_node_settings", "        }", "        assert_equal(res.json, expected)"]}, {"lines": ["        url = self.project.api_url_for('mendeley_widget')", "        res = self.app.get(url, auth=self.user.auth).json", ""]}, {"lines": ["        url = self.project.api_url_for('mendeley_widget')", "        res = self.app.get(url, auth=self.user.auth).json", ""]}, {"lines": [""]}, {"lines": ["    @httpretty.activate"]}, {"lines": ["    def test_mendeley_citation_list_root(self):"]}, {"lines": [""]}, {"lines": ["        httpretty.register_uri(", "            httpretty.GET,"]}, {"lines": ["            urlparse.urljoin(API_URL, 'folders'),", "            body=mock_responses['folders'],", "            content_type='application/json'", "        )"]}, {"lines": [""]}, {"lines": ["        res = self.app.get("]}, {"lines": ["            self.project.api_url_for('mendeley_citation_list'),"]}, {"lines": ["            auth=self.user.auth", "        )"]}, {"lines": ["        root = res.json['contents'][0]", "        assert_equal(root['kind'], 'folder')", "        assert_equal(root['id'], 'ROOT')", "        assert_equal(root['parent_list_id'], '__')"]}, {"lines": ["    @httpretty.activate"]}, {"lines": ["    def test_mendeley_citation_list_non_root(self):", ""]}, {"lines": ["        httpretty.register_uri(", "            httpretty.GET,"]}, {"lines": ["            urlparse.urljoin(API_URL, 'folders'),", "            body=mock_responses['folders'],", "            content_type='application/json'", "        )"]}, {"lines": [""]}, {"lines": ["        httpretty.register_uri(", "            httpretty.GET,"]}, {"lines": ["            urlparse.urljoin(API_URL, 'documents'),", "            body=mock_responses['documents'],", "            content_type='application/json'"]}, {"lines": ["        )", ""]}, {"lines": ["        res = self.app.get(", "            self.project.api_url_for('mendeley_citation_list', mendeley_list_id='ROOT'),", "            auth=self.user.auth", "        )"]}, {"lines": [""]}, {"lines": ["        children = res.json['contents']", "        assert_equal(len(children), 7)", "        assert_equal(children[0]['kind'], 'folder')"]}, {"lines": ["        assert_true(children[1].get('csl') is not None)"]}, {"lines": [""]}, {"lines": ["    @httpretty.activate"]}, {"lines": ["    def test_mendeley_citation_list_non_linked_or_child_non_authorizer(self):", "", "        non_authorizing_user = AuthUserFactory()", "        self.project.add_contributor(non_authorizing_user, save=True)"]}, {"lines": [""]}, {"lines": ["        self.node_addon.mendeley_list_id = 'e843da05-8818-47c2-8c37-41eebfc4fe3f'", "        self.node_addon.save()", ""]}, {"lines": ["        httpretty.register_uri(", "            httpretty.GET,"]}, {"lines": ["            urlparse.urljoin(API_URL, 'folders'),", "            body=mock_responses['folders'],", "            content_type='application/json'", "        )", ""]}, {"lines": ["        httpretty.register_uri(", "            httpretty.GET,"]}, {"lines": ["            urlparse.urljoin(API_URL, 'documents'),", "            body=mock_responses['documents'],", "            content_type='application/json'"]}, {"lines": ["        )", ""]}, {"lines": ["        res = self.app.get(", "            self.project.api_url_for('mendeley_citation_list', mendeley_list_id='ROOT'),", "            auth=non_authorizing_user.auth,"]}, {"lines": ["            expect_errors=True"]}, {"lines": ["        )", "        assert_equal(res.status_code, 403)"]}, {"lines": [""]}, {"lines": ["# HERE = os.path.dirname(os.path.abspath(__file__))"]}, {"lines": ["NODE_SETTINGS_TEMPLATE = None  # no node settings view", "USER_SETTINGS_TEMPLATE = None  # no user settings view"]}, {"lines": ["from website.addons.base import StorageAddonBase"]}, {"lines": ["        ret = super(AddonS3UserSettings, self).to_json(user)", "        ret['has_auth'] = self.has_auth", "        return ret"]}, {"lines": ["    @property", "    def is_valid(self):"]}, {"lines": ["class AddonS3NodeSettings(StorageAddonBase, AddonNodeSettingsBase):"]}, {"lines": ["    @property", "    def folder_name(self):", "        return self.bucket", ""]}, {"lines": ["        ret = super(AddonS3NodeSettings, self).to_json(user)"]}, {"lines": ["        ret.update({"]}, {"lines": ["            'valid_credentials': user_settings and user_settings.is_valid,"]}, {"lines": ["            ret['owner'] = self.user_settings.owner.fullname", "            ret['owner_url'] = self.user_settings.owner.url", "            ret['node_has_auth'] = True"]}, {"lines": ["        return ret"]}, {"lines": ["        return bool(self.user_settings and self.user_settings.has_auth)"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from website.util import web_url_for"]}, {"lines": [""]}, {"lines": ["        raise HTTPError(e.status)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    node = node_addon.owner", "    user_settings = node_addon.user_settings", "", "    result = {"]}, {"lines": ["        'import_auth': node.api_url_for('s3_node_import_auth'),", "        'create_auth': node.api_url_for('s3_authorize_node'),"]}, {"lines": ["        'settings': web_url_for('user_addons'),"]}, {"lines": ["    }", "    if user_settings:"]}, {"lines": ["    return result"]}, {"lines": ["bucket {{ params.bucket }} in"]}, {"lines": ["authorized the Amazon S3 addon for"]}, {"lines": ["deauthorized the Amazon S3 addon for"]}, {"lines": ["    @mock.patch('website.addons.s3.model.AddonS3UserSettings.is_valid')", "    def test_node_settings_empty_bucket(self, mock_is_valid):", "        mock_is_valid.return_value = True"]}, {"lines": ["    @mock.patch('website.addons.s3.model.AddonS3UserSettings.is_valid')", "    def test_node_settings_full_bucket(self, mock_is_valid):", "        mock_is_valid.return_value = True"]}, {"lines": ["    @mock.patch('website.addons.s3.model.AddonS3UserSettings.is_valid')", "    def test_node_settings_user_auth(self, mock_is_valid):", "        mock_is_valid.return_value = True"]}, {"lines": ["    @mock.patch('website.addons.s3.model.AddonS3UserSettings.is_valid')", "    def test_node_settings_moar_use(self, mock_is_valid):", "        mock_is_valid.return_value = True"]}, {"lines": ["    @mock.patch('website.addons.s3.model.AddonS3UserSettings.is_valid')", "    def test_node_settings_no_contributor_user_settings(self, mock_is_valid):", "        mock_is_valid.return_value = True"]}, {"lines": ["    @mock.patch('website.archiver.tasks.archive.si')", "    def test_does_not_get_copied_to_registrations(self, mock_archive):"]}, {"lines": ["from website.project.decorators import must_have_addon", "from website.project.decorators import must_have_permission"]}, {"lines": ["@must_have_permission('write')"]}, {"lines": ["    if not utils.validate_bucket_name(bucket_name):"]}, {"lines": ["        return {", "            'message': 'That bucket name is not valid.',", "            'title': 'Invalid bucket name',"]}, {"lines": ["        return {", "            'message': e.message,", "            'title': 'Problem connecting to S3',"]}, {"lines": ["        return {", "            'message': e.message,", "            'title': \"Problem creating bucket '{0}'\".format(bucket_name),"]}, {"lines": ["        return {", "            'message': e.message,", "            'title': 'Error connecting to S3',"]}, {"lines": ["import os", ""]}, {"lines": [""]}, {"lines": ["HERE = os.path.dirname(os.path.abspath(__file__))"]}, {"lines": ["NODE_SETTINGS_TEMPLATE = None  # no node settings view"]}, {"lines": ["USER_SETTINGS_TEMPLATE = os.path.join(HERE, 'templates', 'twofactor_user_settings.mako')"]}, {"lines": ["        NodeFactory(parent=project, creator=project.creator)", "        no_wiki = NodeFactory(parent=project, creator=project.creator)"]}, {"lines": ["    def citation_lists(self, extract_folder):"]}, {"lines": ["            id='ROOT',", "            parent_id='__'"]}, {"lines": ["            extract_folder(each)"]}, {"lines": ["    def _folder_metadata(self, folder_id):", "        collection = self.client.collection(folder_id)", "        return collection", ""]}, {"lines": ["    def get_list(self, list_id=None):"]}, {"lines": ["        if list_id == 'ROOT':", "            list_id = None", ""]}, {"lines": ["        if list_id:"]}, {"lines": ["            citations = []", "            more = True", "            offset = 0"]}, {"lines": ["                page = self.client.collection_items(list_id, content='csljson', size=100, start=offset)", "                citations = citations + page", "                if len(page) == 0 or len(page) < 100:", "                    more = False", "                else:", "                    offset = offset + len(page)"]}, {"lines": ["            return self._citations_for_zotero_collection(citations)"]}, {"lines": ["        else:", "            return self._citations_for_zotero_user()"]}, {"lines": ["        citations = []", "        more = True", "        offset = 0"]}, {"lines": ["            page = self.client.items(content='csljson', limit=100, start=offset)", "            citations = citations + page", "            if len(page) == 0 or len(page) < 100:", "                more = False", "            else:", "                offset = offset + len(page)", "        return citations"]}, {"lines": ["# -*- coding: utf-8 -*-", ""]}, {"lines": ["            views.zotero_list_accounts_user,"]}, {"lines": ["                '/project/<pid>/zotero/settings/',", "                '/project/<pid>/node/<nid>/zotero/settings/',"]}, {"lines": ["            views.zotero_get_config,"]}, {"lines": ["                '/project/<pid>/zotero/settings/',", "                '/project/<pid>/node/<nid>/zotero/settings/',"]}, {"lines": ["            'put',", "            views.zotero_set_config,"]}, {"lines": ["                '/project/<pid>/zotero/user_auth/',", "                '/project/<pid>/node/<nid>/zotero/user_auth/',"]}, {"lines": ["            'put',"]}, {"lines": ["            views.zotero_add_user_auth,"]}, {"lines": ["                '/project/<pid>/zotero/user_auth/',", "                '/project/<pid>/node/<nid>/zotero/user_auth/',"]}, {"lines": ["            'delete',", "            views.zotero_remove_user_auth,"]}, {"lines": ["                '/project/<pid>/zotero/citations/<zotero_list_id>/',", "                '/project/<pid>/node/<nid>/zotero/citations/<zotero_list_id>/',"]}, {"lines": ["    'prefix': '/api/v1',", "", "}"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from flask import request", "", "from framework.auth.decorators import must_be_logged_in", ""]}, {"lines": ["from website.project.decorators import (", "    must_be_contributor_or_public,", "    must_have_permission,", "    must_not_be_registration,", "    must_have_addon,", ")"]}, {"lines": ["", "from .provider import ZoteroCitationsProvider", ""]}, {"lines": ["@must_be_logged_in"]}, {"lines": ["def zotero_list_accounts_user(auth):"]}, {"lines": ["", "    provider = ZoteroCitationsProvider()", "    return provider.user_accounts(auth.user)", "", "", "@must_have_permission('write')", "@must_have_addon('zotero', 'node')", "def zotero_get_config(auth, node_addon, **kwargs):"]}, {"lines": ["    (see serialize_settings/serialize_urls)", "    \"\"\"", "", "    provider = ZoteroCitationsProvider()"]}, {"lines": ["    return {", "        'result': provider.serializer(", "            node_settings=node_addon,", "            user_settings=auth.user.get_addon('zotero'),", "        ).serialized_node_settings", "    }"]}, {"lines": ["", "@must_have_permission('write')", "@must_have_addon('zotero', 'node')", "@must_not_be_registration", "def zotero_set_config(auth, node_addon, **kwargs):"]}, {"lines": ["", "    provider = ZoteroCitationsProvider()"]}, {"lines": ["    args = request.get_json()"]}, {"lines": ["    external_list_id = args.get('external_list_id')"]}, {"lines": ["    provider.set_config("]}, {"lines": ["        node_addon,", "        auth.user,"]}, {"lines": ["        external_list_id,"]}, {"lines": ["    )"]}, {"lines": ["    return {", "        'result': provider.serializer(", "            node_settings=node_addon,", "            user_settings=auth.user.get_addon('zotero'),", "        ).serialized_node_settings", "    }"]}, {"lines": ["", "@must_have_permission('write')", "@must_have_addon('zotero', 'node')", "@must_not_be_registration", "def zotero_add_user_auth(auth, node_addon, **kwargs):"]}, {"lines": ["", "    provider = ZoteroCitationsProvider()"]}, {"lines": ["    external_account_id = request.get_json().get('external_account_id')"]}, {"lines": ["    return provider.add_user_auth(node_addon, auth.user, external_account_id)", "", "", "@must_have_permission('write')", "@must_have_addon('zotero', 'node')", "@must_not_be_registration", "def zotero_remove_user_auth(auth, node_addon, **kwargs):"]}, {"lines": ["", "    provider = ZoteroCitationsProvider()", "    return provider.remove_user_auth(node_addon, auth.user)", "", "", "@must_be_contributor_or_public", "@must_have_addon('zotero', 'node')", "def zotero_widget(node_addon, **kwargs):"]}, {"lines": ["", "    provider = ZoteroCitationsProvider()", "    return provider.widget(node_addon)", "", "", "@must_be_contributor_or_public", "@must_have_addon('zotero', 'node')", "def zotero_citation_list(auth, node_addon, zotero_list_id=None, **kwargs):"]}, {"lines": ["    \"\"\"", "", "    provider = ZoteroCitationsProvider()", "    show = request.args.get('view', 'all')", "    return provider.citation_list(node_addon, auth.user, zotero_list_id, show)"]}, {"lines": ["function CitationsWidget(gridSelector, styleSelector) {", "    var apiUrl = window.contextVars.node.urls.api + 'zotero/citations/' + window.contextVars.zotero.folder_id + '/';", "    this.grid = new CitationGrid('Zotero', gridSelector, styleSelector, apiUrl);"]}, {"lines": ["// Skip if widget is not correctly configured", "if ($('#zoteroWidget').length) {", "    new CitationsWidget('#zoteroWidget', '#zoteroStyleSelect');", "}"]}, {"lines": ["    provider_name = 'Fake Provider'"]}, {"lines": ["    FACTORY_FOR = model.ZoteroUserSettings"]}, {"lines": ["    FACTORY_FOR = model.ZoteroNodeSettings"]}, {"lines": ["        {", "            \"id\": \"547a1215-efdb-36d2-93b2-e3ef8991264f\",", "            \"title\": \"Cloud Computing\",", "            \"type\": \"journal\",", "            \"authors\": [", "                {", "                    \"first_name\": \"Shivaji P\",", "                    \"last_name\": \"Mirashe\"", "                },", "                {", "                    \"first_name\": \"N V\",", "                    \"last_name\": \"Kalyankar\"", "                }", "            ],", "            \"year\": 2010,", "            \"source\": \"Communications of the ACM\",", "            \"identifiers\": {", "                \"issn\": \"03621340\",", "                \"doi\": \"10.1145/358438.349303\",", "                \"pmid\": \"22988693\",", "                \"arxiv\": \"1003.4074\",", "                \"isbn\": \"1-58113-199-2\"", "            },", "            \"created\": \"2015-02-13T18:17:47.000Z\",", "            \"profile_id\": \"53f383b4-1100-30d5-9473-2dde614dfcaa\",", "            \"last_modified\": \"2015-02-13T20:34:44.000Z\",", "            \"abstract\": \"Computing as you know it is about to change, your applications and documents are going to move from the desktop into the cloud. I'm talking about cloud computing, where applications and files are hosted on a \\\"cloud\\\" consisting of thousands of computers and servers, all linked together and accessible via the Internet. With cloud computing, everything you do is now web based instead of being desktop based. You can access all your programs and documents from any computer that's connected to the Internet. How will cloud computing change the way you work? For one thing, you're no longer tied to a single computer. You can take your work anywhere because it's always accessible via the web. In addition, cloud computing facilitates group collaboration, as all group members can access the same programs and documents from wherever they happen to be located. Cloud computing might sound far-fetched, but chances are you're already using some cloud applications. If you're using a web-based email program, such as Gmail or Hotmail, you're computing in the cloud. If you're using a web-based application such as Google Calendar or Apple Mobile Me, you're computing in the cloud. If you're using a file- or photo-sharing site, such as Flickr or Picasa Web Albums, you're computing in the cloud. It's the technology of the future, available to use today.\"", "        },", "        {", "            \"id\": \"5e95a1a9-d789-3576-9943-35eee8e59ea9\",", "            \"title\": \"The Google file system\",", "            \"type\": \"generic\",", "            \"authors\": [", "                {", "                    \"first_name\": \"Sanjay\",", "                    \"last_name\": \"Ghemawat\"", "                },", "                {", "                    \"first_name\": \"Howard\",", "                    \"last_name\": \"Gobioff\"", "                },", "                {", "                    \"first_name\": \"Shun-Tak\",", "                    \"last_name\": \"Leung\"", "                }", "            ],", "            \"year\": 2003,", "            \"source\": \"ACM SIGOPS Operating Systems Review\",", "            \"identifiers\": {", "                \"pmid\": \"191\",", "                \"issn\": \"01635980\"", "            },", "            \"created\": \"2015-02-13T18:17:48.000Z\",", "            \"profile_id\": \"53f383b4-1100-30d5-9473-2dde614dfcaa\",", "            \"last_modified\": \"2015-02-13T20:34:44.000Z\",", "            \"abstract\": \"We have designed and implemented the Google File System, a scalable distributed file system for large distributed data-intensive applications. It provides fault tolerance while running on inexpensive commodity hardware, and it delivers high aggregate performance to a large number of clients. While sharing many of the same goals as previous distributed file systems, our design has been driven by observations of our application workloads and technological environment, both current and anticipated, that reflect a marked departure from some earlier file system assumptions. This has led us to reexamine traditional choices and explore radically different design points. The file system has successfully met our storage needs. It is widely deployed within Google as the storage platform for the generation and processing of data used by our service as well as research and development efforts that require large data sets. The largest cluster to date provides hundreds of terabytes of storage across thousands of disks on over a thousand machines, and it is concurrently accessed by hundreds of clients. In this paper, we present file system interface extensions designed to support distributed applications, discuss many aspects of our design, and report measurements from both micro-benchmarks and real world use.\"", "        },", "        {", "            \"id\": \"3480056e-fe4d-339b-afed-4312d03739a4\",", "            \"title\": \"Above the clouds: A Berkeley view of cloud computing\",", "            \"type\": \"journal\",", "            \"authors\": [", "                {", "                    \"first_name\": \"M\",", "                    \"last_name\": \"Armbrust\"", "                },", "                {", "                    \"first_name\": \"A\",", "                    \"last_name\": \"Fox\""]}, {"lines": ["                {", "                    \"first_name\": \"R\",", "                    \"last_name\": \"Griffith\""]}, {"lines": ["                {", "                    \"first_name\": \"AD\",", "                    \"last_name\": \"Joseph\""]}, {"lines": ["                {", "                    \"last_name\": \"RH\"", "                }", "            ],", "            \"year\": 2009,", "            \"source\": \"  University of California, Berkeley, Tech. Rep. UCB \",", "            \"identifiers\": {", "                \"pmid\": \"11242594\",", "                \"arxiv\": \"0521865719 9780521865715\"", "            },", "            \"keywords\": [", "                \"cloud computing\",", "                \"distributed system economics\",", "                \"internet datacenters\",", "                \"utility computing\"", "            ],", "            \"created\": \"2015-02-13T18:17:48.000Z\",", "            \"profile_id\": \"53f383b4-1100-30d5-9473-2dde614dfcaa\",", "            \"last_modified\": \"2015-02-13T20:34:45.000Z\",", "            \"abstract\": \"Cloud Computing, the long-held dream of computing as a utility, has the potential to transform a large part of the  IT industry, making software even more attractive as a service and shaping the way IT hardware is designed and  purchased. Developers with innovative ideas for new Internet services no longer require the large capital outlays  in hardware to deploy their service or the human expense to operate it. They need not be concerned about over-  provisioning for a service whose popularity does not meet their predictions, thus wasting costly resources, or under-  provisioning for one that becomes wildly popular, thus missing potential customers and revenue. Moreover, companies  with large batch-oriented tasks can get results as quickly as their programs can scale, since using 1000 servers for one  hour costs no more than using one server for 1000 hlarge scale, is unprecedented in the history of IT.  \"", "        },", "        {", "            \"id\": \"e917dd51-8b94-3748-810b-cafa2accc18a\",", "            \"title\": \"Toward the next generation of recommender systems: A survey of the state-of-the-art and possible extensions\",", "            \"type\": \"generic\",", "            \"authors\": [", "                {", "                    \"first_name\": \"Gediminas\",", "                    \"last_name\": \"Adomavicius\""]}, {"lines": ["                {", "                    \"first_name\": \"Alexander\",", "                    \"last_name\": \"Tuzhilin\"", "                }", "            ],", "            \"year\": 2005,", "            \"source\": \"IEEE Transactions on Knowledge and Data Engineering\",", "            \"identifiers\": {", "                \"issn\": \"10414347\",", "                \"pmid\": \"1423975\",", "                \"arxiv\": \"3\"", "            },", "            \"keywords\": [", "                \"Collaborative filtering\",", "                \"Extensions to recommander systems\",", "                \"Rating estimation methods\",", "                \"Recommander systems\"", "            ],", "            \"created\": \"2015-02-13T18:17:48.000Z\",", "            \"profile_id\": \"53f383b4-1100-30d5-9473-2dde614dfcaa\",", "            \"last_modified\": \"2015-02-13T20:34:45.000Z\",", "            \"abstract\": \" This paper presents an overview of the field of recommender systems and describes the current generation of recommendation methods that are usually classified into the following three main categories: content-based, collaborative, and hybrid recommendation approaches. This paper also describes various limitations of current recommendation methods and discusses possible extensions that can improve recommendation capabilities and make recommender systems applicable to an even broader range of applications. These extensions include, among others, an improvement of understanding of users and items, incorporation of the contextual information into the recommendation process, support for multicriteria ratings, and a provision of more flexible and less intrusive types of recommendations.\"", "        },", "        {", "            \"id\": \"8cd60008-888a-3212-966f-29d481b4b7b7\",", "            \"title\": \"An Introduction to Information Retrieval\",", "            \"type\": \"patent\",", "            \"authors\": [", "                {", "                    \"first_name\": \"Christopher D.\",", "                    \"last_name\": \"Manning\""]}, {"lines": ["                {", "                    \"first_name\": \"Prabhakar\",", "                    \"last_name\": \"Raghavan\"", "                }", "            ],", "            \"year\": 2009,", "            \"source\": \"Online\",", "            \"identifiers\": {", "                \"issn\": \"13864564\",", "                \"doi\": \"10.1109/LPT.2009.2020494\",", "                \"pmid\": \"10575050\",", "                \"arxiv\": \"0521865719 9780521865715\",", "                \"isbn\": \"0521865719\"", "            },", "            \"keywords\": [", "                \"keyword\"", "            ],", "            \"created\": \"2015-02-13T18:17:48.000Z\",", "            \"profile_id\": \"53f383b4-1100-30d5-9473-2dde614dfcaa\",", "            \"last_modified\": \"2015-02-17T15:27:14.000Z\",", "            \"abstract\": \"Class-tested and coherent, this groundbreaking new textbook teaches web-era information retrieval, including web search and the related areas of text classification and text clustering from basic concepts. Written from a computer science perspective by three leading experts in the field, it gives an up-to-date treatment of all aspects of the design and implementation of systems for gathering, indexing, and searching documents; methods for evaluating systems; and an introduction to the use of machine learning methods on text collections. All the important ideas are explained using examples and figures, making it perfect for introductory courses in information retrieval for advanced undergraduates and graduate students in computer science. Based on feedback from extensive classroom experience, the book has been carefully structured in order to make teaching more natural and effective. Although originally designed as the primary text for a graduate or advanced undergraduate course in information retrieval, the book will also create a buzz for researchers and professionals alike.\"", "        },", "        {", "            \"id\": \"de25a64f-493b-330e-a48c-4089bab938f5\",", "            \"title\": \"Learning of ontologies for the web: The analysis of existent approaches\",", "            \"type\": \"journal\",", "            \"authors\": [", "                {", "                    \"first_name\": \"Borys\",", "                    \"last_name\": \"Omelayenko\""]}, {"lines": ["            ],", "            \"year\": 2001,", "            \"source\": \"CEUR Workshop Proceedings\",", "            \"identifiers\": {", "                \"issn\": \"16130073\"", "            },", "            \"created\": \"2015-02-13T18:17:52.000Z\",", "            \"profile_id\": \"53f383b4-1100-30d5-9473-2dde614dfcaa\",", "            \"last_modified\": \"2015-02-13T20:34:43.000Z\",", "            \"abstract\": \"The next generation of the Web, called Semantic Web, has to improve\\\\nthe Web with semantic (ontological) page annotations to enable knowledge-level\\\\nquerying and searches. Manual construction of these ontologies will\\\\nrequire tremendous efforts that force future integration of machine\\\\nlearning with knowledge acquisition to enable highly automated ontology\\\\nlearning. In the paper we present the state of the-art in the field\\\\nof ontology learning from the Web to see how it can contribute to\\\\nthe task...\"", "        }", "    ]"]}, {"lines": ["mock_responses = {k: dumps(v) for k, v in mock_responses.iteritems()}"]}, {"lines": ["import functools", "", "from framework.exceptions import HTTPError", ""]}, {"lines": ["from website.project.decorators import _inject_nodes"]}, {"lines": ["from website.archiver import ARCHIVER_NETWORK_ERROR"]}, {"lines": ["from website.archiver import signals"]}, {"lines": ["", "def fail_archive_on_error(func):", "", "    @functools.wraps(func)", "    def wrapped(*args, **kwargs):", "        try:", "            return func(*args, **kwargs)", "        except HTTPError as e:"]}, {"lines": ["            _inject_nodes(kwargs)"]}, {"lines": ["            registration = kwargs['node']"]}, {"lines": ["            registration.archive_status = ARCHIVER_NETWORK_ERROR", "            registration.save()"]}, {"lines": ["            signals.archive_fail.send("]}, {"lines": ["                registration,"]}, {"lines": ["                errors=[e.message]"]}, {"lines": ["            )", "    return wrapped"]}, {"lines": ["import datetime"]}, {"lines": [""]}, {"lines": ["from modularodm import fields"]}, {"lines": ["", "from framework.mongo import ObjectId", "from framework.mongo import StoredObject", "", "from website.archiver import (", "    ARCHIVER_INITIATED,", "    ARCHIVER_SUCCESS,", "    ARCHIVER_FAILURE,", "    ARCHIVER_FAILURE_STATUSES", ")", ""]}, {"lines": ["from website.addons.base import StorageAddonBase", "from website import settings"]}, {"lines": [""]}, {"lines": ["class ArchiveTarget(StoredObject):"]}, {"lines": ["    \"\"\"Stores the results of archiving a single addon", "    \"\"\""]}, {"lines": ["", "    _id = fields.StringField(", "        primary=True,", "        default=lambda: str(ObjectId())", "    )", ""]}, {"lines": ["    # addon_short_name of target addon"]}, {"lines": ["    name = fields.StringField()", "", "    status = fields.StringField(default=ARCHIVER_INITIATED)"]}, {"lines": ["    # <dict> representation of a website.archiver.AggregateStatResult", "    # Format: {", "    #     'target_id': <str>,", "    #     'target_name': <str>,", "    #     'targets': <list>(StatResult | AggregateStatResult),", "    #     'num_files': <int>,", "    #     'disk_usage': <float>,", "    # }"]}, {"lines": ["    stat_result = fields.DictionaryField()", "    errors = fields.StringField(list=True)", ""]}, {"lines": ["    def __repr__(self):"]}, {"lines": [""]}, {"lines": ["class ArchiveJob(StoredObject):", "", "    _id = fields.StringField(", "        primary=True,", "        default=lambda: str(ObjectId())", "    )"]}, {"lines": [""]}, {"lines": ["    # whether or not the ArchiveJob is complete (success or fail)"]}, {"lines": ["    done = fields.BooleanField(default=False)"]}, {"lines": ["    # whether or not emails have been sent for this ArchiveJob"]}, {"lines": ["    sent = fields.BooleanField(default=False)"]}, {"lines": ["    status = fields.StringField(default=ARCHIVER_INITIATED)"]}, {"lines": ["    datetime_initiated = fields.DateTimeField(default=datetime.datetime.utcnow)"]}, {"lines": [""]}, {"lines": ["    dst_node = fields.ForeignField('node', backref='active')", "    src_node = fields.ForeignField('node')", "    initiator = fields.ForeignField('user')"]}, {"lines": [""]}, {"lines": ["    target_addons = fields.ForeignField('archivetarget', list=True)"]}, {"lines": [""]}, {"lines": ["    # This field is used for stashing embargo URLs while still in the app context"]}, {"lines": ["    # Format: {", "    #     'view': <str> url,", "    #     'approve': <str> url,", "    #     'disapprove': <str> url,", "    # }"]}, {"lines": ["    meta = fields.DictionaryField()", ""]}, {"lines": ["    @property", "    def children(self):"]}, {"lines": ["        return [node.archive_job for node in self.dst_node.nodes if node.primary]"]}, {"lines": ["", "    @property", "    def parent(self):"]}, {"lines": ["        parent_node = self.dst_node.parent_node", "        return parent_node.archive_job if parent_node else None"]}, {"lines": ["", "    @property", "    def success(self):", "        return self.status == ARCHIVER_SUCCESS"]}, {"lines": [""]}, {"lines": ["    @property", "    def pending(self):", "        return any([", "            target for target in self.target_addons", "            if target.status not in (ARCHIVER_SUCCESS, ARCHIVER_FAILURE)", "        ])", ""]}, {"lines": ["    def info(self):", "        return self.src_node, self.dst_node, self.initiator"]}, {"lines": [""]}, {"lines": ["    def target_info(self):", "        return [", "            {", "                'name': target.name,", "                'status': target.status,", "                'stat_result': target.stat_result,", "                'errors': target.errors", "            }", "            for target in self.target_addons", "        ]", ""]}, {"lines": ["    def archive_tree_finished(self):"]}, {"lines": ["        if not self.pending:"]}, {"lines": ["            return len(", "                [", "                    ret for ret in ["]}, {"lines": ["                        child.archive_tree_finished()"]}, {"lines": ["                        for child in self.children"]}, {"lines": ["                    ] if ret]"]}, {"lines": ["            ) if len(self.children) else True", "        return False", ""]}, {"lines": ["    def _fail_above(self):"]}, {"lines": ["        \"\"\"Marks all ArchiveJob instances attached to Nodes above this as failed", "        \"\"\""]}, {"lines": ["        parent = self.parent", "        if parent:", "            parent.status = ARCHIVER_FAILURE", "            parent.save()", ""]}, {"lines": ["    def _post_update_target(self):"]}, {"lines": ["        \"\"\"Checks for success or failure if the ArchiveJob on self.dst_node", "        is finished", "        \"\"\""]}, {"lines": ["        if self.status == ARCHIVER_FAILURE:", "            return"]}, {"lines": ["        if not self.pending:"]}, {"lines": ["            self.done = True"]}, {"lines": ["            if any([target.status for target in self.target_addons if target.status in ARCHIVER_FAILURE_STATUSES]):"]}, {"lines": ["                self.status = ARCHIVER_FAILURE"]}, {"lines": ["                self._fail_above()"]}, {"lines": ["            else:", "                self.status = ARCHIVER_SUCCESS"]}, {"lines": ["            self.save()"]}, {"lines": [""]}, {"lines": ["    def get_target(self, addon_short_name):", "        try:"]}, {"lines": ["            return [addon for addon in self.target_addons if addon.name == addon_short_name][0]"]}, {"lines": ["        except IndexError:", "            return None", "", "    def _set_target(self, addon_short_name):", "        if self.get_target(addon_short_name):", "            return", "        target = ArchiveTarget(name=addon_short_name)", "        target.save()", "        self.target_addons.append(target)", ""]}, {"lines": ["    def set_targets(self):"]}, {"lines": ["        addons = []", "        for addon in [self.src_node.get_addon(name)", "                      for name in settings.ADDONS_ARCHIVABLE", "                      if settings.ADDONS_ARCHIVABLE[name] != 'none']:", "            if not addon or not addon.complete or not isinstance(addon, StorageAddonBase):", "                continue", "            archive_errors = getattr(addon, 'archive_errors', None)", "            if not archive_errors or (archive_errors and not archive_errors()):"]}, {"lines": ["                if addon.config.short_name == 'dataverse':", "                    addons.append(addon.config.short_name + '-draft')", "                    addons.append(addon.config.short_name + '-published')", "                else:", "                    addons.append(addon.config.short_name)"]}, {"lines": ["        for addon in addons:"]}, {"lines": ["            self._set_target(addon)"]}, {"lines": ["        self.save()", ""]}, {"lines": ["    def update_target(self, addon_short_name, status, stat_result=None, errors=None):"]}, {"lines": ["        stat_result = stat_result or {}"]}, {"lines": ["        errors = errors or []", ""]}, {"lines": ["        target = self.get_target(addon_short_name)"]}, {"lines": ["        target.status = status", "        target.errors = errors", "        target.stat_result = stat_result", "        target.save()"]}, {"lines": ["        self._post_update_target()"]}, {"lines": ["import requests", "import json"]}, {"lines": [""]}, {"lines": ["import celery"]}, {"lines": ["from celery.utils.log import get_task_logger"]}, {"lines": ["", "from framework.tasks import app as celery_app"]}, {"lines": ["from framework.tasks.utils import logged"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": [""]}, {"lines": ["from website.archiver import ("]}, {"lines": ["    ARCHIVER_SUCCESS,"]}, {"lines": ["    ARCHIVER_FAILURE,"]}, {"lines": ["    ARCHIVER_SIZE_EXCEEDED,", "    ARCHIVER_NETWORK_ERROR,", "    ARCHIVER_UNCAUGHT_ERROR,"]}, {"lines": ["    AggregateStatResult,"]}, {"lines": [")"]}, {"lines": ["from website.archiver import utils"]}, {"lines": ["from website.archiver.model import ArchiveJob"]}, {"lines": ["from website.archiver import signals as archiver_signals"]}, {"lines": [""]}, {"lines": ["from website.project import signals as project_signals"]}, {"lines": ["from website import settings", "from website.app import init_addons, do_set_backends"]}, {"lines": ["", "def create_app_context():", "    try:", "        init_addons(settings)", "        do_set_backends(settings)"]}, {"lines": ["    except AssertionError:  # ignore AssertionErrors"]}, {"lines": ["        pass", ""]}, {"lines": [""]}, {"lines": ["logger = get_task_logger(__name__)"]}, {"lines": [""]}, {"lines": ["class ArchiverSizeExceeded(Exception):", "", "    def __init__(self, result, *args, **kwargs):", "        super(ArchiverSizeExceeded, self).__init__(*args, **kwargs)", "        self.result = result", "", "", "class ArchiverStateError(Exception):", "", "    def __init__(self, info, *args, **kwargs):", "        super(ArchiverStateError, self).__init__(*args, **kwargs)", "        self.info = info", ""]}, {"lines": ["class ArchiverTask(celery.Task):", "    abstract = True", "    max_retries = 0", ""]}, {"lines": ["    def on_failure(self, exc, task_id, args, kwargs, einfo):"]}, {"lines": ["        job = ArchiveJob.load(kwargs.get('job_pk'))", "        if not job:", "            raise ArchiverStateError({", "                'exception': exc,", "                'args': args,", "                'kwargs': kwargs,", "                'einfo': einfo,", "            })"]}, {"lines": ["        if job.status == ARCHIVER_FAILURE:", "            # already captured", "            return"]}, {"lines": ["        src, dst, user = job.info()"]}, {"lines": ["        errors = []"]}, {"lines": ["        if isinstance(exc, ArchiverSizeExceeded):"]}, {"lines": ["            dst.archive_status = ARCHIVER_SIZE_EXCEEDED"]}, {"lines": ["            errors = exc.result"]}, {"lines": ["        elif isinstance(exc, HTTPError):"]}, {"lines": ["            dst.archive_status = ARCHIVER_NETWORK_ERROR"]}, {"lines": ["            errors = dst.archive_job.target_info()"]}, {"lines": ["        else:"]}, {"lines": ["            dst.archive_status = ARCHIVER_UNCAUGHT_ERROR"]}, {"lines": ["            errors = [einfo]"]}, {"lines": ["        dst.save()", "        archiver_signals.archive_fail.send(dst, errors=errors)"]}, {"lines": [""]}, {"lines": ["", "@celery_app.task(base=ArchiverTask, name=\"archiver.stat_addon\")"]}, {"lines": ["@logged('stat_addon')"]}, {"lines": ["def stat_addon(addon_short_name, job_pk):"]}, {"lines": ["    \"\"\"Collect metadata about the file tree of a given addon", "", "    :param addon_short_name: AddonConfig.short_name of the addon to be examined"]}, {"lines": ["    :param job_pk: primary key of archive_job"]}, {"lines": ["    :return: AggregateStatResult containing file tree metadata", "    \"\"\""]}, {"lines": ["    # Dataverse reqires special handling for draft and", "    # published content", "    addon_name = addon_short_name", "    version = None", "    if 'dataverse' in addon_short_name:", "        addon_name = 'dataverse'", "        version = 'latest' if addon_short_name.split('-')[-1] == 'draft' else 'latest-published'"]}, {"lines": ["    create_app_context()"]}, {"lines": ["    job = ArchiveJob.load(job_pk)", "    src, dst, user = job.info()"]}, {"lines": ["    src_addon = src.get_addon(addon_name)"]}, {"lines": ["    try:"]}, {"lines": ["        file_tree = src_addon._get_file_tree(user=user, version=version)"]}, {"lines": ["    except HTTPError as e:"]}, {"lines": ["        dst.archive_job.update_target("]}, {"lines": ["            addon_short_name,", "            ARCHIVER_NETWORK_ERROR,"]}, {"lines": ["            errors=[e.data['error']],"]}, {"lines": ["        )"]}, {"lines": ["        raise"]}, {"lines": ["    result = AggregateStatResult(", "        src_addon._id,"]}, {"lines": ["        addon_short_name,"]}, {"lines": ["        targets=[utils.aggregate_file_tree_metadata(addon_short_name, file_tree, user)],"]}, {"lines": ["    )"]}, {"lines": ["    return result"]}, {"lines": [""]}, {"lines": ["@celery_app.task(base=ArchiverTask, name=\"archiver.make_copy_request\")"]}, {"lines": ["@logged('make_copy_request')"]}, {"lines": ["def make_copy_request(job_pk, url, data):"]}, {"lines": ["    \"\"\"Make the copy request to the WaterBulter API and handle"]}, {"lines": ["    successful and failed responses"]}, {"lines": [""]}, {"lines": ["    :param job_pk: primary key of ArchiveJob"]}, {"lines": ["    :param url: URL to send request to"]}, {"lines": ["    :param data: <dict> of setting to send in POST to WaterBulter API"]}, {"lines": ["    :return: None", "    \"\"\""]}, {"lines": ["    create_app_context()"]}, {"lines": ["    job = ArchiveJob.load(job_pk)", "    src, dst, user = job.info()"]}, {"lines": ["    provider = data['source']['provider']"]}, {"lines": ["    logger.info(\"Sending copy request for addon: {0} on node: {1}\".format(provider, dst._id))"]}, {"lines": ["    requests.post(url, data=json.dumps(data))"]}, {"lines": [""]}, {"lines": ["def make_waterbutler_payload(src, dst, addon_short_name, rename, cookie, revision=None):", "    ret = {", "        'source': {", "            'cookie': cookie,", "            'nid': src._id,", "            'provider': addon_short_name,", "            'path': '/',", "        },", "        'destination': {", "            'cookie': cookie,", "            'nid': dst._id,", "            'provider': settings.ARCHIVE_PROVIDER,", "            'path': '/',", "        },"]}, {"lines": ["        'rename': rename.replace('/', '-')"]}, {"lines": ["    }", "    if revision:"]}, {"lines": ["        ret['source']['revision'] = revision"]}, {"lines": ["    return ret", ""]}, {"lines": ["@celery_app.task(base=ArchiverTask, name=\"archiver.archive_addon\")"]}, {"lines": ["@logged('archive_addon')"]}, {"lines": ["def archive_addon(addon_short_name, job_pk, stat_result):"]}, {"lines": ["    \"\"\"Archive the contents of an addon by making a copy request to the", "    WaterBulter API", "", "    :param addon_short_name: AddonConfig.short_name of the addon to be archived"]}, {"lines": ["    :param job_pk: primary key of ArchiveJob"]}, {"lines": ["    :return: None", "    \"\"\""]}, {"lines": ["    # Dataverse requires special handling for draft"]}, {"lines": ["    # and published content", "    addon_name = addon_short_name", "    if 'dataverse' in addon_short_name:", "        addon_name = 'dataverse'"]}, {"lines": ["    create_app_context()"]}, {"lines": ["    job = ArchiveJob.load(job_pk)", "    src, dst, user = job.info()", "    logger.info(\"Archiving addon: {0} on node: {1}\".format(addon_short_name, src._id))"]}, {"lines": ["    src_provider = src.get_addon(addon_name)"]}, {"lines": ["    folder_name = src_provider.archive_folder_name"]}, {"lines": ["    cookie = user.get_or_create_cookie()"]}, {"lines": ["    copy_url = settings.WATERBUTLER_URL + '/ops/copy'"]}, {"lines": ["    if addon_name == 'dataverse':"]}, {"lines": ["        # The dataverse API will not differentiate between published and draft files", "        # unless expcicitly asked. We need to create seperate folders for published and", "        # draft in the resulting archive.", "        #", "        # Additionally trying to run the archive without this distinction creates a race", "        # condition that non-deterministically caused archive jobs to fail."]}, {"lines": ["        data = make_waterbutler_payload(src, dst, addon_name, '{0} (published)'.format(folder_name), cookie, revision='latest-published')"]}, {"lines": ["        make_copy_request.delay(job_pk=job_pk, url=copy_url, data=data)"]}, {"lines": ["        data = make_waterbutler_payload(src, dst, addon_name, '{0} (draft)'.format(folder_name), cookie, revision='latest')"]}, {"lines": ["        make_copy_request.delay(job_pk=job_pk, url=copy_url, data=data)", "    else:"]}, {"lines": ["        data = make_waterbutler_payload(src, dst, addon_name, folder_name, cookie)"]}, {"lines": ["        make_copy_request.delay(job_pk=job_pk, url=copy_url, data=data)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["@celery_app.task(base=ArchiverTask, name=\"archiver.archive_node\")"]}, {"lines": ["@logged('archive_node')"]}, {"lines": ["def archive_node(results, job_pk):"]}, {"lines": ["    \"\"\"First use the results of #stat_node to check disk usage of the"]}, {"lines": ["    initated registration, then either fail the registration or", "    create a celery.group group of subtasks to archive addons", ""]}, {"lines": ["    :param results: results from the #stat_addon subtasks spawned in #stat_node"]}, {"lines": ["    :param job_pk: primary key of ArchiveJob"]}, {"lines": ["    :return: None", "    \"\"\""]}, {"lines": ["    create_app_context()"]}, {"lines": ["    job = ArchiveJob.load(job_pk)", "    src, dst, user = job.info()", "    logger.info(\"Archiving node: {0}\".format(src._id))"]}, {"lines": ["    stat_result = AggregateStatResult("]}, {"lines": ["        src._id,"]}, {"lines": ["        src.title,"]}, {"lines": ["        targets=results,"]}, {"lines": ["    )"]}, {"lines": ["    if stat_result.disk_usage > settings.MAX_ARCHIVE_SIZE:"]}, {"lines": ["        raise ArchiverSizeExceeded(result=stat_result)", "    else:"]}, {"lines": ["        if not results:", "            job.status = ARCHIVER_SUCCESS", "            job.save()"]}, {"lines": ["        for result in stat_result.targets:"]}, {"lines": ["            if not result.num_files:", "                job.update_target(result.target_name, ARCHIVER_SUCCESS)"]}, {"lines": ["            else:", "                archive_addon.delay(", "                    addon_short_name=result.target_name,", "                    job_pk=job_pk,", "                    stat_result=result,", "                )", "        project_signals.archive_callback.send(dst)"]}, {"lines": [""]}, {"lines": ["@celery_app.task(bind=True, base=ArchiverTask, name='archiver.archive')"]}, {"lines": ["@logged('archive')"]}, {"lines": ["def archive(self, job_pk):"]}, {"lines": ["    \"\"\"Starts a celery.chord that runs stat_addon for each", "    complete addon attached to the Node, then runs", "    #archive_node with the result"]}, {"lines": [""]}, {"lines": ["    :param job_pk: primary key of ArchiveJob"]}, {"lines": ["    :return: None", "    \"\"\""]}, {"lines": ["    create_app_context()"]}, {"lines": ["    job = ArchiveJob.load(job_pk)", "    src, dst, user = job.info()", "    logger = get_task_logger(__name__)", "    logger.info(\"Received archive task for Node: {0} into Node: {1}\".format(src._id, dst._id))"]}, {"lines": ["    celery.chord("]}, {"lines": ["        celery.group("]}, {"lines": ["            stat_addon.si("]}, {"lines": ["                addon_short_name=target.name,"]}, {"lines": ["                job_pk=job_pk,"]}, {"lines": ["            )"]}, {"lines": ["            for target in job.target_addons"]}, {"lines": ["        )"]}, {"lines": ["    )(archive_node.s(job_pk=job_pk))"]}, {"lines": ["    # The proper 'name' of the service", "    # Needed for account serialization", "    provider_name = fields.StringField(required=True)"]}, {"lines": ["                provider_name=self.name,"]}, {"lines": ["from modularodm import Q"]}, {"lines": ["    return list(user.node__contributed.find(", "        (", "            Q('category', 'eq', 'project') &", "            Q('is_registration', 'eq', False) &", "            Q('is_deleted', 'eq', False) &", "            Q('is_folder', 'eq', False)"]}, {"lines": ["        )"]}, {"lines": ["    ))"]}, {"lines": ["def new_node(category, title, user, description=None, parent=None):"]}, {"lines": ["    category = category"]}, {"lines": ["        parent=parent"]}, {"lines": ["import blinker", "", "signals = blinker.Namespace()", "contributor_added = signals.signal('contributor-added')", "unreg_contributor_added = signals.signal('unreg-contributor-added')", "write_permissions_revoked = signals.signal('write-permissions-revoked')", ""]}, {"lines": ["after_create_registration = signals.signal('post-create-registration')"]}, {"lines": ["", "archive_callback = signals.signal('archive-callback')"]}, {"lines": ["from website.project.signals import unreg_contributor_added"]}, {"lines": ["def get_node_contributors_abbrev(auth, node, **kwargs):"]}, {"lines": ["def get_contributors(auth, node, **kwargs):"]}, {"lines": ["def get_contributors_from_parent(auth, node, **kwargs):"]}, {"lines": ["def get_most_in_common_contributors(auth, node, **kwargs):"]}, {"lines": ["def get_recently_added_contributors(auth, node, **kwargs):"]}, {"lines": ["def project_before_remove_contributor(auth, node, **kwargs):"]}, {"lines": ["def project_removecontributor(auth, node, **kwargs):"]}, {"lines": ["def project_contributors_post(auth, node, **kwargs):"]}, {"lines": ["def project_manage_contributors(auth, node, **kwargs):"]}, {"lines": ["def claim_user_registered(auth, node, **kwargs):"]}, {"lines": ["def invite_contributor_post(node, **kwargs):"]}, {"lines": ["def claim_user_post(node, **kwargs):"]}, {"lines": ["from website.util.permissions import ADMIN"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)", "def get_node_keys(node, **kwargs):"]}, {"lines": ["            for key in node.api_keys"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)", "def create_node_key(node, **kwargs):"]}, {"lines": ["    node.api_keys.append(api_key)", "    node.save()"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)", "def revoke_node_key(node, **kwargs):"]}, {"lines": ["    node.api_keys.remove(api_key)", "    node.save()"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)", "def node_key_history(auth, node, **kwargs):"]}, {"lines": ["    rv.update(_view_project(node, auth))"]}, {"lines": ["from framework.exceptions import HTTPError, PermissionsError"]}, {"lines": ["from framework.mongo.utils import from_mongo, get_or_http_error"]}, {"lines": ["from website.util.permissions import ADMIN, READ, WRITE"]}, {"lines": ["from website.project.model import has_anonymous_link, get_pointer_parent, NodeUpdateError"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def edit_node(auth, node, **kwargs):"]}, {"lines": ["    data = request.get_json()", "    title = strip_html(data.get('title'))"]}, {"lines": ["    category = data.get('category', 'project')", "    template = data.get('template')", "    description = strip_html(data.get('description'))"]}, {"lines": ["            'title': title,", "            'category': category,", "            'template_node': original_node,"]}, {"lines": ["                template: changes,", "            }", "        )"]}, {"lines": ["def project_new_from_template(auth, node, **kwargs):"]}, {"lines": ["    new_node = node.use_as_template("]}, {"lines": ["        auth=auth,"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["def folder_new_post(auth, node, **kwargs):"]}, {"lines": ["    if not node.is_folder:"]}, {"lines": [""]}, {"lines": ["def add_folder(auth, **kwargs):", "    data = request.get_json()", "    node_id = data.get('node_id')", "    node = get_or_http_error(Node, node_id)", ""]}, {"lines": ["    title = strip_html(data.get('title'))"]}, {"lines": ["    if not node.is_folder:"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def project_new_node(auth, node, **kwargs):"]}, {"lines": ["    user = auth.user"]}, {"lines": ["        ).format(url=node.url)"]}, {"lines": ["    raise HTTPError(http.BAD_REQUEST, redirect_url=node.url)"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["def project_before_fork(auth, node, **kwargs):", "    user = auth.user"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["def project_before_template(auth, node, **kwargs):"]}, {"lines": ["def node_fork_page(auth, node, **kwargs):"]}, {"lines": ["            redirect_url=node.url"]}, {"lines": ["    try:"]}, {"lines": ["        fork = node.fork_node(auth)"]}, {"lines": ["    except PermissionsError:", "        raise HTTPError(", "            http.FORBIDDEN,"]}, {"lines": ["            redirect_url=node.url"]}, {"lines": ["        )"]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["def node_registrations(auth, node, **kwargs):", "    return _view_project(node, auth, primary=True)"]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["def node_forks(auth, node, **kwargs):", "    return _view_project(node, auth, primary=True)"]}, {"lines": ["def node_setting(auth, node, **kwargs):"]}, {"lines": ["            config = addon.to_json(auth.user)"]}, {"lines": ["            # inject the MakoTemplateLookup into the template context", "            # TODO inject only short_name and render fully client side", "            config['template_lookup'] = addon.config.template_lookup"]}, {"lines": ["            addon_enabled_settings.append(config)"]}, {"lines": ["    ret['addons_available'] = sorted(["]}, {"lines": [""]}, {"lines": ["    ret['categories'] = Node.CATEGORY_MAP", "    ret['categories'].update({", "        'project': 'Project'", "    })"]}, {"lines": ["    return ret"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def node_choose_addons(auth, node, **kwargs):"]}, {"lines": ["@must_have_permission(READ)", "def node_contributors(auth, node, **kwargs):"]}, {"lines": ["@must_have_permission(ADMIN)", "def configure_comments(node, **kwargs):"]}, {"lines": ["def view_project(auth, node, **kwargs):"]}, {"lines": ["def expand(auth, node, **kwargs):", "    node.expand(user=auth.user)"]}, {"lines": ["def collapse(auth, node, **kwargs):", "    node.collapse(user=auth.user)"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def project_reorder_components(node, **kwargs):"]}, {"lines": ["        tuple(n.split(':'))", "        for n in request.json.get('new_list', [])"]}, {"lines": ["        n for n in node.nodes", "        if not n.is_deleted"]}, {"lines": ["        n for n in node.nodes", "        if n.is_deleted"]}, {"lines": ["        node.nodes = nodes_new + deleted_nodes", "        node.save()"]}, {"lines": ["@must_be_contributor_or_public"]}, {"lines": ["def project_statistics(auth, node, **kwargs):"]}, {"lines": ["@must_have_permission(ADMIN)", "def project_before_set_public(node, **kwargs):"]}, {"lines": ["@must_have_permission(ADMIN)", "def project_set_privacy(auth, node, **kwargs):"]}, {"lines": ["    try:", "        node.set_privacy(permissions, auth)", "    except NodeStateError as e:", "        raise HTTPError(http.BAD_REQUEST, data=dict(", "            message_short=\"Can't change privacy\",", "            message_long=e.message", "        ))"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["def watch_post(auth, node, **kwargs):", "    user = auth.user"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["def unwatch_post(auth, node, **kwargs):", "    user = auth.user"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["def togglewatch_post(auth, node, **kwargs):"]}, {"lines": ["    user = auth.user"]}, {"lines": ["@must_be_valid_project", "@must_not_be_registration"]}, {"lines": ["def update_node(auth, node, **kwargs):"]}, {"lines": ["    try:", "        return {", "            'updated_fields': {", "                key: getattr(node, key)", "                for key in"]}, {"lines": ["                node.update(request.get_json(), auth=auth)"]}, {"lines": ["            }", "        }", "    except NodeUpdateError as e:", "        raise HTTPError(400, data=dict(", "            message_short=\"Failed to update attribute '{0}'\".format(e.key),", "            message_long=e.reason", "        ))"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)"]}, {"lines": ["def component_remove(auth, node, **kwargs):"]}, {"lines": ["        node.remove_node(auth)"]}, {"lines": ["    node.save()"]}, {"lines": ["        node.project_or_component.capitalize()"]}, {"lines": ["    parent = node.parent_node", "    if parent and parent.can_view(auth):"]}, {"lines": ["        redirect_url = node.node__parent[0].url"]}, {"lines": ["@must_have_permission(ADMIN)"]}, {"lines": ["def delete_folder(auth, node, **kwargs):"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["", "    has_wiki = bool(node.get_addon('wiki'))", "    wiki_page = node.get_wiki_page('home', None)"]}, {"lines": ["        return has_wiki and wiki_page and wiki_page.html(node)"]}, {"lines": ["        return has_wiki"]}, {"lines": ["            'category_short': node.category,"]}, {"lines": ["            'update_url': node.api_url_for('update_node'),"]}, {"lines": ["            'is_archiving': node.archiving,"]}, {"lines": ["            'exists': parent is not None,"]}, {"lines": ["            'category': parent.category_display if parent else '',"]}, {"lines": ["            'registrations_url': parent.web_url_for('node_registrations') if parent else '',"]}, {"lines": ["        'node_categories': Node.CATEGORY_MAP,"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)", "def private_link_table(node, **kwargs):"]}, {"lines": ["def get_editable_children(auth, node, **kwargs):"]}, {"lines": ["def get_recent_logs(node, **kwargs):"]}, {"lines": ["    logs = list(reversed(node.logs._to_primary_keys()))[:3]"]}, {"lines": ["        'archiving': node.archiving,"]}, {"lines": ["def get_summary(auth, node, **kwargs):"]}, {"lines": ["def get_children(auth, node, **kwargs):"]}, {"lines": ["        nodes = [", "            each", "            for each in node.nodes", "            if perm in each.get_permissions(user) and not each.is_deleted", "        ]"]}, {"lines": ["            each", "            for each in node.nodes", "            if not each.is_deleted"]}, {"lines": ["def get_folder_pointers(auth, node, **kwargs):", "    if not node.is_folder:"]}, {"lines": ["    nodes = ["]}, {"lines": ["        each.resolve()._id", "        for each in node.nodes", "        if each is not None and not each.is_deleted and not each.primary"]}, {"lines": ["    return nodes"]}, {"lines": ["def get_forks(auth, node, **kwargs):"]}, {"lines": ["def get_registrations(auth, node, **kwargs):"]}, {"lines": ["    registrations = [n for n in node.node__registrations if not n.is_deleted]  # get all registrations, including archiving"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)"]}, {"lines": ["def project_generate_private_link_post(auth, node, **kwargs):"]}, {"lines": ["    if node._id not in node_ids:", "        node_ids.insert(0, node._id)"]}, {"lines": ["@must_be_valid_project"]}, {"lines": ["@must_have_permission(ADMIN)"]}, {"lines": ["    first_author = node.visible_contributors[0]", ""]}, {"lines": ["        'firstAuthor': first_author.family_name or first_author.given_name or first_author.full_name,"]}, {"lines": ["def search_node(auth, **kwargs):"]}, {"lines": ["    size = float(request.json.get('size', '5').strip())"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def add_pointers(auth, node, **kwargs):"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def remove_pointer(auth, node, **kwargs):"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def remove_pointer_from_folder(auth, node, pointer_id, **kwargs):"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def remove_pointers_from_folder(auth, node, **kwargs):"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["def fork_pointer(auth, node, **kwargs):"]}, {"lines": ["def get_pointed(auth, node, **kwargs):"]}, {"lines": ["def project_addtag(auth, node, **kwargs):"]}, {"lines": ["def project_removetag(auth, node, **kwargs):"]}, {"lines": ["from datetime import timedelta"]}, {"lines": ["CELERY_RESULT_BACKEND = 'amqp://'"]}, {"lines": ["    addon_settings = json.load(fp)", "    ADDONS_REQUESTED = addon_settings['addons']", "    ADDONS_ARCHIVABLE = addon_settings['addons_archivable']"]}, {"lines": [""]}, {"lines": ["", "###### ARCHIVER ###########", "ARCHIVE_PROVIDER = 'osfstorage'", "", "MAX_ARCHIVE_SIZE = 1024 ** 3  # == math.pow(1024, 3) == 1 GB", "MAX_FILE_SIZE = MAX_ARCHIVE_SIZE  # TODO limit file size?", "", "ARCHIVE_TIMEOUT_TIMEDELTA = timedelta(1)  # 24 hours"]}, {"lines": ["", "ENABLE_ARCHIVER = True"]}, {"lines": ["###########################"]}, {"lines": ["            window.setTimeout(function () {"]}, {"lines": ["    },", "    resetMessage: function() {", "        this.message('');", "        this.messageClass('text-info');"]}, {"lines": ["/**", " * Module that controls the citations addons node settings. Includes Knockout view-model", " * for syncing data, and HGrid-folderpicker for selecting a folder.", " */"]}, {"lines": ["var ko = require('knockout');"]}, {"lines": ["require('knockout.punches');"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": ["var bootbox = require('bootbox');"]}, {"lines": [""]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["var oop = require('js/oop');", "var FolderPickerViewModel = require('js/folderPickerNodeConfig');"]}, {"lines": ["", "ko.punches.enableAll();"]}, {"lines": [""]}, {"lines": ["/**"]}, {"lines": [" * View model to support instances of CitationsNodeConfig (folder picker widget)", " *", " * @class AddonFolderPickerViewModel", " * @param {String} addonName Full display name of the addon", " * @param {String} url API url to initially fetch settings", " * @param {String} selector CSS selector for containing div", " * @param {String} folderPicker CSS selector for folderPicker div"]}, {"lines": [" */"]}, {"lines": ["var CitationsFolderPickerViewModel = oop.extend(FolderPickerViewModel, {", "    constructor: function(addonName, url, selector, folderPicker) {", "        var self = this;", "        self.super.constructor.call(self, addonName, url, selector, folderPicker);", "        self.userAccountId = ko.observable('');"]}, {"lines": ["        // externalAccounts", "        self.accounts = ko.observable([]);", ""]}, {"lines": ["        self.messages.submitSettingsSuccess = ko.pureComputed(function(){"]}, {"lines": ["            return 'Successfully linked \"' + $osf.htmlEscape(self.folder().name) + '\". Go to the <a href=\"' +", "                self.urls().files + '\">Overview page</a> to view your citations.';", "        });"]}, {"lines": ["", "        self.treebeardOptions = $.extend(", "            {},", "            FolderPickerViewModel.prototype.treebeardOptions,", "            {", "                /** Callback for chooseFolder action.", "                 *   Just changes the ViewModel's self.selected observable to the selected", "                 *   folder.", "                 */", "                onPickFolder: function(evt, item){", "                    evt.preventDefault();", "                    this.selected({", "                        name: item.data.name,", "                        id: item.data.id", "                    });", "                    return false; // Prevent event propagation", "                }.bind(this),", "                lazyLoadPreprocess: function(data) {", "                    return data.contents.filter(function(item) {", "                    return item.kind === 'folder';", "                    });", "                },", "                resolveLazyloadUrl: function(item) {", "                    return this.urls().folders + item.data.id + '/?view=folders';", "                }.bind(this)", "            });"]}, {"lines": ["    },"]}, {"lines": ["    fetchAccounts: function() {"]}, {"lines": ["        var self = this;"]}, {"lines": ["        var ret = $.Deferred();"]}, {"lines": ["        var request = $.get(self.urls().accounts);"]}, {"lines": ["        request.then(function(data) {"]}, {"lines": ["            ret.resolve(data.accounts);"]}, {"lines": ["        });"]}, {"lines": ["        request.fail(function(xhr, textStatus, error) {"]}, {"lines": ["            self.changeMessage(self.messages.updateAccountsError(), 'text-warning');"]}, {"lines": ["            Raven.captureMessage('Could not GET ' + self.addonName + ' accounts for user', {", "                url: self.url,"]}, {"lines": ["                textStatus: textStatus,", "                error: error", "            });"]}, {"lines": ["            ret.reject(xhr, textStatus, error);"]}, {"lines": ["        });"]}, {"lines": ["        return ret.promise();"]}, {"lines": ["    },"]}, {"lines": ["    updateAccounts: function() {", "        var self = this;", "        return self.fetchAccounts()"]}, {"lines": ["            .done(function(accounts) {", "                self.accounts(", "                    $.map(accounts, function(account) {", "                        return {", "                            name: account.display_name,", "                            id: account.id", "                        };", "                    })", "                );", "            });"]}, {"lines": ["    },"]}, {"lines": ["    /**", "     * Allows a user to create an access token from the nodeSettings page", "     */"]}, {"lines": ["    connectAccount: function() {"]}, {"lines": ["        var self = this;", "", "        window.oauthComplete = function(res) {", "            // Update view model based on response"]}, {"lines": ["            self.changeMessage(self.messages.connectAccountSuccess(), 'text-success', 3000);"]}, {"lines": ["            self.importAuth.call(self);"]}, {"lines": ["        };", "        window.open(self.urls().auth);", "    },", "    connectExistingAccount: function(account_id) {", "        var self = this;", ""]}, {"lines": ["        return $osf.putJSON("]}, {"lines": ["            self.urls().importAuth, {", "                external_account_id: account_id", "            }", "        ).then(self.onImportSuccess.bind(self), self.onImportError.bind(self));", "    },", "    _updateCustomFields: function(settings){", "        this.userAccountId(settings.userAccountId);", "    },", "    _serializeSettings: function(){", "        return {", "            external_account_id: this.userAccountId(),", "            external_list_id: this.selected().id,", "            external_list_name: this.selected().name", "        };"]}, {"lines": ["    },", "    importAuth: function() {", "        var self = this;", "        self.updateAccounts()", "            .then(function(){", "                if (self.accounts().length > 1) {", "                    bootbox.prompt({", "                        title: 'Choose ' + self.addonName + ' Access Token to Import',", "                        inputType: 'select',", "                        inputOptions: ko.utils.arrayMap(", "                            self.accounts(),", "                            function(item) {", "                                return {", "                                    text: item.name,", "                                    value: item.id", "                                };", "                            }", "                        ),", "                        value: self.accounts()[0].id,"]}, {"lines": ["                    });", "                } else {", "                    bootbox.confirm({", "                        title: 'Import ' + self.addonName + ' Access Token?',", "                        message: self.messages.confirmAuth(),", "                        callback: function(confirmed) {", "                            if (confirmed) {", "                                self.connectExistingAccount.call(self, (self.accounts()[0].id));", "                            }", "                        }", "                    });", "                }", "            });"]}, {"lines": ["    }"]}, {"lines": ["});"]}, {"lines": ["// Public API", "function CitationsNodeConfig(addonName, selector, url, folderPicker) {", "    var self = this;", "    self.url = url;", "    self.folderPicker = folderPicker;", "    self.viewModel = new CitationsFolderPickerViewModel(addonName, url, selector, folderPicker);"]}, {"lines": ["    self.viewModel.updateFromData();"]}, {"lines": ["    $osf.applyBindings(self.viewModel, selector);", "}", ""]}, {"lines": ["module.exports = {", "    CitationsNodeConfig: CitationsNodeConfig,", "    _CitationsNodeConfigViewModel: CitationsFolderPickerViewModel", "};"]}, {"lines": [" * Controller for the Add Contributor modal.", " */"]}, {"lines": ["    constructor: function(title, parentId, parentTitle) {"]}, {"lines": ["            nodeApiUrl + 'get_editable_children/', {},"]}, {"lines": ["            });", "            return names.join(', ');"]}, {"lines": ["    selectWhom: function() {"]}, {"lines": ["    selectWhich: function() {"]}, {"lines": ["    gotoInvite: function() {"]}, {"lines": ["    goToPage: function(page) {"]}, {"lines": ["     * A simple Contributor model that receives data from the", "     * contributor search endpoint. Adds an addiitonal displayProjectsinCommon", "     * attribute which is the human-readable display of the number of projects the", "     * currently logged-in user has in common with the contributor.", "     */"]}, {"lines": ["    startSearch: function() {"]}, {"lines": ["            return $.getJSON("]}, {"lines": ["                '/api/v1/user/search/', {"]}, {"lines": ["    importFromParent: function() {"]}, {"lines": ["            nodeApiUrl + 'get_contributors_from_parent/', {},"]}, {"lines": ["    recentlyAdded: function() {"]}, {"lines": ["        return $.getJSON("]}, {"lines": ["            url, {},"]}, {"lines": ["                for (var i = 0; i < numToDisplay; i++) {"]}, {"lines": ["        ).fail(function(xhr, textStatus, error) {"]}, {"lines": ["                'message': 'OSF was unable to resolve your request. If this issue persists, ' +"]}, {"lines": ["    mostInCommon: function() {"]}, {"lines": ["        return $.getJSON("]}, {"lines": ["            url, {},"]}, {"lines": ["                for (var i = 0; i < numToDisplay; i++) {"]}, {"lines": ["        ).fail(function(xhr, textStatus, error) {"]}, {"lines": ["                'message': 'OSF was unable to resolve your request. If this issue persists, ' +"]}, {"lines": ["    addTips: function(elements) {"]}, {"lines": ["    afterRender: function(elm, data) {"]}, {"lines": ["    makeAfterRender: function() {"]}, {"lines": ["        var self = this;"]}, {"lines": ["        return function(elm, data) {"]}, {"lines": ["            return self.afterRender(elm, data);", "        };"]}, {"lines": ["     *   true if validation succeeds.", "     */", "    validateInviteForm: function() {"]}, {"lines": ["        for (var i = 0, contrib; contrib = self.selection()[i]; ++i) {"]}, {"lines": ["    postInvite: function() {"]}, {"lines": ["    add: function(data) {"]}, {"lines": ["    remove: function(data) {"]}, {"lines": ["    addAll: function() {"]}, {"lines": ["    removeAll: function() {"]}, {"lines": ["    cantSelectNodes: function() {"]}, {"lines": ["    cantDeselectNodes: function() {"]}, {"lines": ["    selectNodes: function() {"]}, {"lines": ["    deselectNodes: function() {"]}, {"lines": ["    selected: function(data) {"]}, {"lines": ["    submit: function() {"]}, {"lines": ["        return $osf.postJSON("]}, {"lines": ["            nodeApiUrl + 'contributors/', {"]}, {"lines": ["            $osf.growl('Error', 'Add contributor failed.');"]}, {"lines": ["    clear: function() {"]}, {"lines": ["    postInviteRequest: function(fullname, email) {"]}, {"lines": ["        return $osf.postJSON("]}, {"lines": ["            nodeApiUrl + 'invite_contributor/', {", "                'fullname': fullname,", "                'email': email", "            }"]}, {"lines": ["    onInviteSuccess: function(result) {"]}, {"lines": ["    onInviteError: function(xhr) {"]}, {"lines": ["function ContribAdder(selector, nodeTitle, nodeId, parentTitle) {"]}, {"lines": ["var $osf = require('js/osfHelpers');", "var waterbutler = require('js/waterbutler');"]}, {"lines": ["require('css/fangorn.css');"]}, {"lines": ["* `onPickFolder` option (the callback executed when a folder is selected)."]}, {"lines": ["function treebeardToggleCheck(item) {"]}, {"lines": ["    return ((typeof item.data.hasChildren === 'undefined') || item.data.hasChildren);"]}, {"lines": ["function treebeardResolveToggle(item) {"]}, {"lines": ["    if ((typeof item.data.hasChildren !== 'undefined') && item.data.hasChildren === false) {"]}, {"lines": ["function treebeardResolveIcon(item) {"]}, {"lines": ["", "function treebeardTitleColumn(item, col) {"]}, {"lines": ["    var tb = this; // jshint ignore: line", "", "    var cls = '';"]}, {"lines": ["    var onclick = function() {};", "    if (typeof item.data.hasChildren === 'undefined' || item.data.hasChildren) {"]}, {"lines": ["        cls = 'hasChildren';"]}, {"lines": ["        onclick = function() {"]}, {"lines": ["            tb.updateFolder(null, item);", "        };", "    }"]}, {"lines": [" * Returns the folder select button for a single row.", " */"]}, {"lines": ["function treebeardSelectView(item) {"]}, {"lines": ["    var tb = this; // jshint ignore: line", "    var setTempPicked = function() {"]}, {"lines": ["        type: 'radio',", "        checked: 'checked',"]}, {"lines": ["        value: item.id"]}, {"lines": ["    var templateUnchecked = m('input', {"]}, {"lines": ["        onclick: setTempPicked.bind(tb),", "        onchange: function(evt) {"]}, {"lines": ["        name: '#' + tb.options.divID + INPUT_NAME"]}, {"lines": ["function treebeardColumnTitle() {"]}, {"lines": ["    return [{", "        title: 'Folders',", "        width: '75%',", "        sort: false", "    }, {", "        title: 'Select',", "        width: '25%',", "        sort: false", "    }];"]}, {"lines": ["function treebeardResolveRows(item) {"]}, {"lines": ["    return [{", "        data: 'name', // Data field name", "        folderIcons: true,", "        filter: false,"]}, {"lines": ["        custom: treebeardTitleColumn"]}, {"lines": ["    }, {", "        sortInclude: false,", "        css: 'p-l-xs',"]}, {"lines": ["        custom: treebeardSelectView"]}, {"lines": ["    }];"]}, {"lines": ["function treebeardOnload() {"]}, {"lines": ["    var tb = this; // jshint ignore: line"]}, {"lines": ["    var node = tb.treeData.children[0];"]}, {"lines": ["    if ((typeof node.data.hasChildren === 'undefined') || node.data.hasChildren) {"]}, {"lines": ["function treebeardLazyLoadOnLoad(item) {"]}, {"lines": ["    var tb = this; // jshint ignore: line"]}, {"lines": ["        if ((typeof item.data.hasChildren !== 'undefined') && item.data.hasChildren === false) {"]}, {"lines": ["    columnTitles: treebeardColumnTitle,", "    resolveRows: treebeardResolveRows,", "    resolveIcon: treebeardResolveIcon,", "    togglecheck: treebeardToggleCheck,", "    resolveToggle: treebeardResolveToggle,", "    ondataload: treebeardOnload,", "    lazyLoadOnLoad: treebeardLazyLoadOnLoad,"]}, {"lines": ["    }"]}, {"lines": ["        throw new Error('FolderPicker must have the \"onPickFolder\" option defined');"]}, {"lines": ["FolderPicker.prototype.destroy = function() {"]}, {"lines": ["    this.grid.destroy();"]}, {"lines": ["};", ""]}, {"lines": ["    var $el = $(this);"]}, {"lines": ["        if (!this.id) {"]}, {"lines": ["            throw new Error('FolderPicker must have an ID if initializing with jQuery.');"]}, {"lines": ["        }"]}, {"lines": ["        this._tb = new FolderPicker(selector, options);"]}, {"lines": ["FolderPicker.selectView = treebeardSelectView;"]}, {"lines": ["var SUPPORT_EMAIL = 'support@osf.io';", ""]}, {"lines": ["    registrations: {", "        registrationFailed: 'Registration failed. If this problem persists, please contact ' + SUPPORT_EMAIL + '.',", "        invalidEmbargoTitle: 'Invalid embargo end date',", "        invalidEmbargoMessage: 'Please choose a date more than two days, but less than four years, from today.',", "        registerConfirm: 'Are you sure you want to register this project?',"]}, {"lines": ["    },"]}, {"lines": ["                'contact <a href=\"mailto: ' + SUPPORT_EMAIL + '\">' + SUPPORT_EMAIL + '</a> if the ' +"]}, {"lines": ["/**", " * Controls the \"Add Links\" modal.", " */", "'use strict';", "", "var $ = require('jquery');", "var ko = require('knockout');", ""]}, {"lines": ["", "// Grab nodeID from global context (mako)", "var nodeApiUrl = window.contextVars.node.urls.api;", "var nodeId = window.contextVars.node.id;", ""]}, {"lines": ["    constructor: function(nodeTitle) {"]}, {"lines": ["        var self = this;"]}, {"lines": ["        this.nodeTitle = nodeTitle;", "        this.submitEnabled = ko.observable(true);", "", "        this.query = ko.observable();", "        this.results = ko.observableArray();", "        this.selection = ko.observableArray();", "        this.errorMsg = ko.observable('');"]}, {"lines": ["        this.totalPages = ko.observable(0);"]}, {"lines": ["        this.includePublic = ko.observable(true);"]}, {"lines": [""]}, {"lines": ["            return self.query() && self.results().length;"]}, {"lines": ["        });", ""]}, {"lines": ["            return self.query() && !self.results().length;"]}, {"lines": ["        });"]}, {"lines": ["    searchAllProjects: function() {"]}, {"lines": ["        this.includePublic(true);"]}, {"lines": ["    searchMyProjects: function() {"]}, {"lines": ["        this.includePublic(false);"]}, {"lines": ["        var self = this;", "        self.errorMsg('');", "        if (self.query()) {", "            osfHelpers.postJSON(", "                '/api/v1/search/node/', {", "                    query: self.query(),", "                    nodeId: nodeId,", "                    includePublic: self.includePublic(),", "                    page: self.currentPage()", "                }", "            ).done(function(result) {", "                if (!result.nodes.length) {", "                    self.errorMsg('No results found.');", "                }", "                self.results(result.nodes);", "                self.currentPage(result.page);", "                self.numberOfPages(result.pages);"]}, {"lines": ["                self.addNewPaginators();", "            }).fail(", "                osfHelpers.handleJSONError", "            );", "        } else {", "            self.results([]);", "            self.currentPage(0);", "            self.totalPages(0);"]}, {"lines": ["        }"]}, {"lines": ["    addTips: function(elements) {"]}, {"lines": ["        elements.forEach(function(element) {", "            $(element).find('.contrib-button').tooltip();", "        });"]}, {"lines": ["    add: function(data) {"]}, {"lines": ["        this.selection.push(data);", "        // Hack: Hide and refresh tooltips", "        $('.tooltip').hide();", "        $('.contrib-button').tooltip();"]}, {"lines": ["    remove: function(data) {"]}, {"lines": ["        var self = this;", "        self.selection.splice(", "            self.selection.indexOf(data), 1", "        );", "        // Hack: Hide and refresh tooltips", "        $('.tooltip').hide();", "        $('.contrib-button').tooltip();"]}, {"lines": ["    addAll: function() {"]}, {"lines": ["        var self = this;", "        $.each(self.results(), function(idx, result) {", "            if (self.selection().indexOf(result) === -1) {", "                self.add(result);", "            }", "        });"]}, {"lines": ["    removeAll: function() {"]}, {"lines": ["        var self = this;", "        $.each(self.selection(), function(idx, selected) {", "            self.remove(selected);", "        });"]}, {"lines": ["    selected: function(data) {"]}, {"lines": ["        var self = this;", "        for (var idx = 0; idx < self.selection().length; idx++) {", "            if (data.id === self.selection()[idx].id) {", "                return true;", "            }"]}, {"lines": ["        }"]}, {"lines": ["        return false;"]}, {"lines": ["    submit: function() {"]}, {"lines": ["        var self = this;", "        self.submitEnabled(false);", "        var nodeIds = osfHelpers.mapByProperty(self.selection(), 'id');", "        osfHelpers.postJSON(", "            nodeApiUrl + 'pointer/', {", "                nodeIds: nodeIds", "            }", "        ).done(function() {", "            window.location.reload();", "        }).fail(function(data) {", "            self.submitEnabled(true);", "            osfHelpers.handleJSONError(data);", "        });"]}, {"lines": ["    clear: function() {"]}, {"lines": ["        this.query('');", "        this.results([]);", "        this.selection([]);"]}, {"lines": ["    authorText: function(node) {"]}, {"lines": ["        var rv = node.firstAuthor;", "        if (node.etal) {", "            rv += ' et al.';"]}, {"lines": ["        }"]}, {"lines": ["        return rv;"]}, {"lines": ["    }"]}, {"lines": ["", "var LinksViewModel = function($elm) {", "", "    var self = this;", "    self.links = ko.observableArray([]);", "", "    $elm.on('shown.bs.modal', function() {", "        if (self.links().length === 0) {", "            $.ajax({", "                type: 'GET',", "                url: nodeApiUrl + 'pointer/',"]}, {"lines": ["            }).done(function(response) {", "                self.links(response.pointed);", "            }).fail(function() {", "                $elm.modal('hide');", "                osfHelpers.growl('Error:', 'Could not get links');", "            });", "        }", "    });", "", "};", "", "////////////////", "// Public API //", "////////////////", "", "function PointerManager(selector, nodeName) {", "    var self = this;", "    self.selector = selector;", "    self.$element = $(self.selector);", "    self.nodeName = nodeName;", "    self.viewModel = new AddPointerViewModel(nodeName);", "    self.init();", "}", "", "PointerManager.prototype.init = function() {", "    var self = this;", "    ko.applyBindings(self.viewModel, self.$element[0]);", "    self.$element.on('hidden.bs.modal', function() {", "        self.viewModel.clear();", "    });", "};", "", "function PointerDisplay(selector) {", "    this.selector = selector;", "    this.$element = $(selector);", "    this.viewModel = new LinksViewModel(this.$element);", "    ko.applyBindings(this.viewModel, this.$element[0]);", "}", "", "module.exports = {", "    PointerManager: PointerManager,", "    PointerDisplay: PointerDisplay", "};"]}, {"lines": ["var $osf = require('js/osfHelpers');", "var LogFeed = require('js/logFeed.js');"]}, {"lines": ["    });"]}, {"lines": ["        });"]}, {"lines": ["        });"]}, {"lines": ["require('css/typeahead.css');", "require('css/fangorn.css');", "require('css/projectorganizer.css');"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["var iconmap = require('js/iconmap');"]}, {"lines": ["var legendView = require('js/components/legend').view;"]}, {"lines": ["var nodeCategories = require('json!built/nodeCategories.json');"]}, {"lines": ["var projectOrganizerCategories = $.extend({}, {"]}, {"lines": ["    project: 'Project',"]}, {"lines": ["    link:  'Link'", "}, nodeCategories);", ""]}, {"lines": ["    if(item.data.archiving) {", "        return  m('span', {'class': 'registration-archiving'}, item.data.name + ' [Archiving]');", "    } else if(item.data.urls.fetch){"]}, {"lines": ["    var personString = '';", "    var dateString = '';"]}, {"lines": ["        personString = ', by ' + item.data.modifiedBy.toString();"]}, {"lines": ["    return m('span', dateString + personString);"]}, {"lines": ["", "    if (item.data.isPointer && !item.data.parentIsFolder) {"]}, {"lines": ["        item.data.expand = false;", "    }"]}, {"lines": ["/*"]}, {"lines": [" *", " */", "var $ = require('jquery');", "var bootbox = require('bootbox');", ""]}, {"lines": ["};", "", "$(document).ready(function() {", "    $('#registerNode').click(function(event) {", "        var node = window.contextVars.node;", "        var target = event.currentTarget.href;"]}, {"lines": ["        var bootboxTitle = 'Register ' + title;"]}, {"lines": ["    });", "});"]}, {"lines": ["            self.registrationTitle = $osf.htmlDecode(registrationTitle);"]}, {"lines": ["            // Truncate title to around 50 chars"]}, {"lines": ["            var parts = self.registrationTitle.slice(0, 50).split(' ');"]}, {"lines": ["            if (parts.length > 1) {", "                self.truncatedTitle = parts.slice(0, -1).join(' ');", "            }", "            else {", "                self.truncatedTitle = parts[0];", "            }", ""]}, {"lines": ["                mustEqual: self.truncatedTitle", "            });", "            self.valid = ko.pureComputed(function(){", "                return self.confirmationText.isValid();"]}, {"lines": ["};"]}, {"lines": ["require('js/onboarder.js');", "var $osf = require('js/osfHelpers');"]}, {"lines": ["var ProjectOrganizer = require('js/projectorganizer').ProjectOrganizer;"]}, {"lines": [""]}, {"lines": ["    // If we need to change what nodes can be registered, filter here", "    var registrationSelection = uploadSelection;"]}, {"lines": ["    $osf.applyBindings({nodes: registrationSelection, enableComponents: true}, '#obRegisterProject');"]}, {"lines": ["        var po = new ProjectOrganizer({"]}, {"lines": ["var language = require('js/osfLanguage').registrations;", ""]}, {"lines": ["var MetaData = require('js/metadata_1.js');"]}, {"lines": ["function registrationFailed() {"]}, {"lines": ["        if (response.status === 'initiated') {", "            $osf.unblock();"]}, {"lines": ["            window.location.assign(response.urls.registrations);"]}, {"lines": ["            registrationFailed();"]}, {"lines": ["        registrationFailed();"]}, {"lines": ["                    language.invalidEmbargoTitle,", "                    language.invalidEmbargoMessage,"]}, {"lines": ["        $osf.block();"]}, {"lines": ["                var preRegisterWarnings = function() {"]}, {"lines": ["                        $osf.joinPrompts(response.prompts, language.registerConfirm),"]}, {"lines": ["                };", "                var preRegisterErrors = function(confirm, reject) {", "                    bootbox.confirm(", "                        $osf.joinPrompts(", "                            response.errors,", "                            'Before you continue...'", "                        ) + '<br /><hr /> ' + language.registerSkipAddons,", "                        function(result) {", "                            if(result) {", "                                confirm();", "                            }", "                        }", "                    );", "                };", "", "                if (response.errors && response.errors.length) {", "                    preRegisterErrors(preRegisterWarnings);", "                }", "                else if (response.prompts && response.prompts.length) {", "                    preRegisterWarnings();", "                }", "                else {"]}, {"lines": ["        }).always(function() {", "            $osf.unblock();"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';", "var assert = require('chai').assert;", "var $osf = require('js/osfHelpers');", "", "var ChangeMessageMixin = require('js/changeMessage');", "", "describe('ChangeMessageMixin', () => {", "    var changeable = new ChangeMessageMixin();", "    describe('#resetMessage', () => {"]}, {"lines": ["            changeable.message('Some message');", "            changeable.messageClass('some-class');", "            changeable.resetMessage();", "            assert.equal(changeable.message(), '');", "            assert.equal(changeable.messageClass(), 'text-info');", "        });", "    });", "    describe('#changeMessage', () => {", "        it('updates the VM\\'s message and message CSS class', () => {", "            changeable.resetMessage();", "            var msg = 'Such success!';", "            var cls = 'text-success';", "            changeable.changeMessage(msg, cls);", "            assert.equal(changeable.message(), msg);", "            assert.equal(changeable.messageClass(), cls);", "            msg = 'Much fail!';", "            cls = 'text-error';", "            changeable.changeMessage(msg, cls);", "            assert.equal(changeable.message(), msg);", "            assert.equal(changeable.messageClass(), cls);", "        });", "        var timer;", "        before(() => {", "            timer = sinon.useFakeTimers();", "        });", "        after(() => {", "            timer.restore();", "        });", "        it('... and removes the message after a timeout if supplied', () => {", "            changeable.resetMessage();", "            var oldMsg = changeable.message();", "            var oldCls = changeable.messageClass();", "            var msg = 'Such success!';", "            var cls = 'text-success';", "            changeable.changeMessage(msg, cls, 200);", "            timer.tick(201);", "            assert.equal(changeable.message(), oldMsg);", "            assert.equal(changeable.messageClass(), oldCls);", "        });", "    });", "});"]}, {"lines": ["        var stub;", "        beforeEach(() => {", "            stub = new sinon.stub($, 'blockUI');", "        });", "        afterEach(() => {", "            $.blockUI.restore();", "        });", ""]}, {"lines": ["        it('calls $.blockUI with the passed message if provided', () => {", "            var msg = 'Some custom message';", "            $osf.block(msg);", "            assert.calledOnce(stub);", "            assert.calledWith(stub, {", "                css: {", "                    border: 'none',", "                    padding: '15px',", "                    backgroundColor: '#000',", "                    '-webkit-border-radius': '10px',", "                    '-moz-border-radius': '10px',", "                    opacity: 0.5,", "                    color: '#fff'", "                },", "                message: msg", "            });", "        });"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';", "var assert = require('chai').assert;", "var utils = require('tests/utils');", "var faker = require('faker');", "", "var $osf = require('js/osfHelpers');", "var Raven = require('raven-js');", ""]}, {"lines": [" * Dear sloria,", " *", " * I'm sorry for injecting globals. Please forgive me.", " *", " * Yours truly,", " * samchrisinger", " */"]}, {"lines": ["", "var ProjectSettings = require('js/projectSettings.js');", "", "var NodeCategorySettings = ProjectSettings.NodeCategorySettings;", "", "describe('NodeCategorySettings', () => {", "    var category = faker.internet.domainWord();", "    var categories = [];", "    for (var i = 0; i < 10; i++) {", "        categories.push(faker.internet.domainWord());", "    }"]}, {"lines": ["    var vm = new NodeCategorySettings(category, categories, updateUrl);", "    describe('#constructor', function() {", "        it('throws an error if no updateUrl is passed', () => {", "            var broken = function() {", "                new NodeCategorySettings(category, categories);", "            };", "            assert.throws(broken , vm.INSTANTIATION_ERROR_MESSAGE);", "        });", "        it('implements the changeMessage interface', () => {", "            assert.isTrue(vm.hasOwnProperty('message'));", "            assert.isTrue(vm.hasOwnProperty('messageClass'));", "            assert.isTrue(Boolean(vm.changeMessage) || false);", "            assert.isTrue(Boolean(vm.resetMessage) || false);", "        });", "    });", "    describe('#updateSuccess', () => {", "        var changeMessageSpy;", "        before(() => {"]}, {"lines": ["        });", "        after(() => {", "            vm.changeMessage.restore();", "        });", "        it('updates the message, updates the category, and sets the dirty state to false', () => {", "            var newcategory = categories[0];", "            vm.updateSuccess(newcategory);", "            assert.calledWith(changeMessageSpy, vm.UPDATE_SUCCESS_MESSAGE, vm.MESSAGE_SUCCESS_CLASS);", "            assert.equal(newcategory, vm.category());", "            assert.isFalse(vm.dirty());"]}, {"lines": ["    });", "    describe('#updateError', () => {", "        var changeMessageSpy;", "        var ravenStub;", "        before(() => {"]}, {"lines": ["            ravenStub = sinon.stub(Raven, 'captureMessage');", "        });", "        after(() => {", "            vm.changeMessage.restore();", "            Raven.captureMessage.restore();", "        });", "        it('updates the message, and captures the error with Raven', () => {", "            var error = faker.lorem.sentence();", "            vm.updateError({}, error, {});", "            assert.calledWith(changeMessageSpy, vm.UPDATE_ERROR_MESSAGE, vm.MESSAGE_ERROR_CLASS);", "            assert.calledWith(ravenStub, vm.UPDATE_ERROR_MESSAGE_RAVEN, {", "                url: updateUrl,", "                textStatus: error,", "                err: {}", "            });", "        });", "    });"]}, {"lines": ["        var server;", "        var serverSpy = sinon.spy();"]}, {"lines": ["        before(() => {", "            server = sinon.fakeServer.create();"]}, {"lines": ["                'PUT',", "                updateUrl,", "                function(xhr) {", "                    serverSpy();", "                    var response = {", "                        'updated_fields': JSON.parse(xhr.requestBody)"]}, {"lines": ["                    xhr.respond(", "                        200,", "                        {'Content-Type': 'application/json'},", "                        JSON.stringify(response)", "                    );", "                }", "            );", "        });", "        after(() => {", "            server.restore();"]}, {"lines": ["        it('sends a put to the updateUrl with the selected category, and updates the category on success', (done) => {", "            var newcategory = categories[0];", "            vm.selectedCategory(newcategory);", "            vm.updateCategory()", "                .always(function() {", "                    assert.called(serverSpy);", "                    assert.calledWith(updateSuccessSpy, newcategory);", "                    done();", "                });", "            server.respond();", "        });", "    });", "    describe('#cancelUpdateCategory', () => {", "        var resetMessageSpy;", "        before(() => {", "            resetMessageSpy = sinon.spy(vm, 'resetMessage');", "        });", "        after(() => {", "            vm.resetMessage.restore();", "        });"]}, {"lines": ["            vm.selectedCategory(categories[0]);", "            vm.dirty(true);", "            vm.changeMessage('Some message', 'some-class');", "            vm.cancelUpdateCategory();", "            assert.equal(vm.selectedCategory(), vm.category());", "            assert.isFalse(vm.dirty());", "            assert.called(resetMessageSpy);", "        });", "    });", "});"]}, {"lines": ["            var truncatedTitle = registrationTitle.slice(0, 50).split(' ').slice(0, -1).join(' ');"]}, {"lines": ["                 vm.confirmationText(truncatedTitle);"]}, {"lines": ["            it('decodes html entities in project title', () => {", "                var test = new registrationRetraction.ViewModel(submitUrl, 'Carrot &gt;== Cake');", "                assert.equal(test.registrationTitle, 'Carrot >== Cake');", "            });", ""]}, {"lines": ["                    vm.confirmationText(truncatedTitle);"]}, {"lines": ["                    vm.confirmationText(truncatedTitle);"]}, {"lines": ["var $ = require('jquery');", "var $osf = require('js/osfHelpers');", "var ZeroClipboard = require('zeroclipboard');", "var AddonNodeConfigVM = require('js/addonNodeConfig')._AddonNodeConfigViewModel;", "var testUtils = require('./folderPickerTestUtils.js');"]}, {"lines": ["var makeEmailList = function(n) {", "    var ret = [];", "    for (var i = 0; i < n; i++){", "        ret.push(faker.internet.email());", "    }", "    return ret;", "};"]}, {"lines": ["describe('AddonNodeConfig', () => {", "    describe('AddonFolderPickerViewModel', () => {", "        var settingsUrl = '/api/v1/12345/addon/config/';", "        var onPickFolderSpy = sinon.spy();"]}, {"lines": ["        var opts = {"]}, {"lines": ["        };", "        var vm = new AddonNodeConfigVM('Fake Addon', settingsUrl, '#fakeAddonScope', '#fakeAddonPicker', opts);", "", "        describe('#constructor', () => {", "            it('applies overrides from the opts param if supplied', () => {", "                vm.treebeardOptions.onPickFolder();", "                assert.calledOnce(opts.onPickFolder);"]}, {"lines": ["            });", "        });"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';", "var assert = require('chai').assert;", "", "var utils = require('tests/utils');", "var faker = require('faker');"]}, {"lines": ["var Raven = require('raven-js');"]}, {"lines": ["var oop = require('js/oop');", "var ko = require('knockout');", "var $ = require('jquery');"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["", "var FolderPickerNodeConfigVM = require('js/folderPickerNodeConfig');"]}, {"lines": ["var FolderPicker = require('js/folderpicker');"]}, {"lines": ["var testUtils = require('./folderPickerTestUtils.js');"]}, {"lines": ["", "var onPickFolderSpy = new sinon.spy();", "var resolveLazyloadUrlSpy = new sinon.spy();", "var TestSubclassVM = oop.extend(FolderPickerNodeConfigVM, {", "    constructor: function(addonName, url, selector, folderPicker) {", "        this.super.constructor.call(this, addonName, url, selector, folderPicker);", "        this.customField = ko.observable('');"]}, {"lines": [""]}, {"lines": ["        this.messages.submitSettingsSuccess = ko.pureComputed(function(){"]}, {"lines": ["            return 'SUCCESS';", "        });"]}, {"lines": ["    },", "    _updateCustomFields: function(settings) {", "        this.customField(settings.customField);", "    },", "    _serializeSettings: function(settings) {", "        return this.folder().name.toUpperCase();", "    }", "});", ""]}, {"lines": ["describe('FolderPickerNodeConfigViewModel', () => {"]}, {"lines": [""]}, {"lines": ["    var settingsUrl = '/api/v1/12345/addon/config/';"]}, {"lines": ["    var endpoints = [{", "        method: 'GET',", "        url: settingsUrl,", "        response: {", "            result: {", "                ownerName: faker.name.findName(),", "                userisOwner: true,", "                userHasAuth: true,", "                validCredentials: true,", "                nodeHasAuth: true,", "                urls: {", "                    owner: '/abc123/',", "                    config: settingsUrl"]}, {"lines": ["                }", "            }", "        }"]}, {"lines": ["    }];"]}, {"lines": ["", "    var server;", "    before(() => {", "        server = utils.createServer(sinon, endpoints);", "    });"]}, {"lines": ["    after(() => {", "        server.restore();", "    });", "", "    describe('ViewModel', () => {"]}, {"lines": ["        var vm;", "        var doActivatePickerStub;"]}, {"lines": ["        var hardReset = () => {", "            vm = new TestSubclassVM('Fake Addon', settingsUrl, '#fakeAddonScope', '#fakeAddonPicker');"]}, {"lines": ["            doActivatePickerStub = sinon.stub(vm, 'doActivatePicker');"]}, {"lines": ["        };"]}, {"lines": ["        before(hardReset);", "        after(() => {", "           vm.doActivatePicker.restore();", "        });", "        afterEach(() => {", "            doActivatePickerStub.reset();", "        });", ""]}, {"lines": ["        describe('#showImport', () => {", "            var reset = () => {", "                vm.loadedSettings(true);", "                vm.nodeHasAuth(false);", "                vm.userHasAuth(true);", "            };", "            it('shows the import button when the User has auth, the Node doesn\\'t have auth, and the VM has loaded settings', () => {", "                reset();", "                assert.isTrue(vm.showImport());", "            });", "            it('... and it doesn\\'t show the import button otherwise', () => {", "                reset();", "                vm.loadedSettings(false);", "                assert.isFalse(vm.showImport());", "                reset();", "                vm.nodeHasAuth(true);", "                assert.isFalse(vm.showImport());", "                reset();", "                vm.userHasAuth(false);", "                assert.isFalse(vm.showImport());", "                reset();", "                vm.loadedSettings(false);", "                vm.nodeHasAuth(true);", "                vm.userHasAuth(false);", "                assert.isFalse(vm.showImport());", "            });", "        });", "        describe('#showSettings', () => {", "            var reset = () => {", "                vm.nodeHasAuth(true);", "            };", "            it('shows settings if the Node has auth', () => {", "                reset();", "                assert.isTrue(vm.showSettings());", "            });", "            it('... and doesn\\'t show settings otherwise', () => {", "                reset();", "                vm.nodeHasAuth(false);", "                assert.isFalse(vm.showSettings());", "            });", "        });", "        describe('#showTokenCreateButton', () => {", "            var reset = () => {", "                vm.userHasAuth(false);", "                vm.nodeHasAuth(false);", "                vm.loadedSettings(true);", "            };", "            it('shows the token create button if the User doesn\\'t have auth, the Node doesn\\'t have auth, and the VM has loaded settings', () => {", "                reset();", "                assert.isTrue(vm.showTokenCreateButton());", "            });", "            it('... and doesn\\'t show the token create button otherwise', () => {", "                reset();", "                vm.userHasAuth(true);", "                assert.isFalse(vm.showTokenCreateButton());", "                reset();", "                vm.nodeHasAuth(true);", "                assert.isFalse(vm.showTokenCreateButton());", "                reset();", "                vm.loadedSettings(false);", "                assert.isFalse(vm.showTokenCreateButton());", "                reset();", "                vm.userHasAuth(true);", "                vm.nodeHasAuth(true);", "                vm.loadedSettings(false);", "                assert.isFalse(vm.showTokenCreateButton());", "            });", "        });", "        describe('#folderName', () => {", "            it('returns the value of the name property of the currently set folder when the Node has auth', () => {", "                vm.nodeHasAuth(true);", "                vm.folder({", "                    name: null,", "                    id: null", "                });"]}, {"lines": ["                assert.equal(vm.folderName(), '');"]}, {"lines": ["                var name = faker.hacker.noun();", "                vm.folder({", "                    name: name,", "                    id: faker.finance.account()", "                });", "                assert.equal(vm.folderName(), name);", "            });"]}, {"lines": ["                vm.nodeHasAuth(false);", "                assert.equal(vm.folderName(), '');", "            });", "        });", "        describe('#selectedFolderName', () => {"]}, {"lines": ["                vm.userIsOwner(true);", "                vm.selected({", "                    name: null,", "                    id: null", "                });", "                assert.equal(vm.selectedFolderName(), 'None');", "                var name = faker.hacker.noun();", "                assert.notEqual(name, 'None');", "                vm.selected({", "                    name: name,", "                    id: faker.finance.account()", "                });", "                assert.equal(vm.selectedFolderName(), name);", "            });", "            it('... and returns an empty string otherwise', () => {", "                vm.userIsOwner(false);", "                assert.equal(vm.selectedFolderName(), '');", "            });", "        });", "        describe('#changeMessage', () => {", "            var reset = () => {"]}, {"lines": ["                vm.resetMessage();"]}, {"lines": ["            };", "            it('updates the VM\\'s message and message CSS class', () => {", "                reset();"]}, {"lines": ["                var msg = 'Such success!';", "                var cls = 'text-success';", "                vm.changeMessage(msg, cls);", "                assert.equal(vm.message(), msg);", "                assert.equal(vm.messageClass(), cls);", "                msg = 'Much fail!';", "                cls = 'text-error';", "                vm.changeMessage(msg, cls);", "                assert.equal(vm.message(), msg);", "                assert.equal(vm.messageClass(), cls);", "            });", "            var timer;", "            before(() => {", "                timer = sinon.useFakeTimers();", "            });", "            after(() => {", "                timer.restore();", "            });", "            it('... and removes the message after a timeout if supplied', () => {", "                reset();", "                var oldMsg = vm.message();", "                var oldCls = vm.messageClass();", "                var msg = 'Such success!';", "                var cls = 'text-success';", "                vm.changeMessage(msg, cls, 200);", "                timer.tick(201);", "                assert.equal(vm.message(), oldMsg);", "                assert.equal(vm.messageClass(), oldCls);", "            });", "        });", "        describe('#updateFromData', () => {"]}, {"lines": ["            var spy;", "            before(() => {", "                spy = sinon.spy(vm, 'fetchFromServer');", "            });", "            after(() => {", "                vm.fetchFromServer.restore();", "            });", ""]}, {"lines": ["            it('makes a call to fetchFromServer if no data passed as an argument', (done) => {"]}, {"lines": ["                vm.updateFromData()", "                    .always(function() {"]}, {"lines": ["                        assert.calledOnce(spy);"]}, {"lines": ["                        done();", "                    });", "            });"]}, {"lines": ["            var data = testUtils.makeFakeData();"]}, {"lines": ["            it('updates the VM with data if data passed as argument', (done) => {", "                vm.updateFromData(data)", "                    .always(function() {", "                        assert.equal(vm.nodeHasAuth(), data.nodeHasAuth);", "                        assert.equal(vm.userHasAuth(), data.userHasAuth);", "                        assert.equal(vm.userIsOwner(), data.userIsOwner);", "                        assert.deepEqual(vm.folder(), data.folder);", "                        assert.equal(vm.ownerName(), data.ownerName);", "                        assert.deepEqual(vm.urls(), data.urls);", "                        done();", "                    });", "            });", "            it('... and updates the custom fields requested in \\'_updateCustomFields\\'', (done) => {", "                var customField = faker.hacker.noun();", "                data.customField = customField;", "                vm.updateFromData(data)", "                    .always(function() {", "                        assert.equal(vm.customField(), customField);", "                        done();", "                    });", "            });", "        });", "        describe('#fetchFromServer', () => {"]}, {"lines": ["            var data = testUtils.makeFakeData();"]}, {"lines": ["            var endpoints = [{", "                method: 'GET',", "                url: settingsUrl,", "                response: {", "                    result: data"]}, {"lines": ["                }"]}, {"lines": ["            }];"]}, {"lines": ["            var server;", "            before(() => {", "                server = utils.createServer(sinon, endpoints);", "            });", "            after(() => {", "                server.restore();", "            });", "            it('makes GET request to the passed settings url returns a promise that resolves to the response', (done) => {", "                vm.fetchFromServer()", "                    .always(function(resp) {", "                        assert.deepEqual(resp, data);", "                        done();", "                    });", "            });", "        });", "        describe('#submitSettings', () => {"]}, {"lines": ["            var data = testUtils.makeFakeData();"]}, {"lines": ["            data.urls.view = faker.internet.ip();"]}, {"lines": ["            var configUrl = faker.internet.ip();"]}, {"lines": ["            var endpoints = [{", "                method: 'PUT',", "                url: configUrl,", "                response: {", "                    result: data"]}, {"lines": ["                }"]}, {"lines": ["            }];"]}, {"lines": ["            var server;"]}, {"lines": ["            var spy;"]}, {"lines": ["            before(() => {", "                server = utils.createServer(sinon, endpoints);"]}, {"lines": ["                spy = sinon.spy($osf, 'putJSON');"]}, {"lines": ["            });", "            after(() => {", "                server.restore();"]}, {"lines": ["                $osf.putJSON.restore();"]}, {"lines": ["            });"]}, {"lines": ["            data.urls.config = configUrl;", "            it('serializes the VM state and sends a PUT request to the \\'config\\' url passed in settings', (done) => {", "                hardReset();"]}, {"lines": ["                vm.updateFromData(data)", "                    .always(function() {", "                        vm.submitSettings()", "                            .always(function() {"]}, {"lines": ["                                assert.calledWith(spy, data.urls.config, vm.folder().name.toUpperCase());"]}, {"lines": ["                                done();", "                            });"]}, {"lines": ["                    });", "            });"]}, {"lines": ["        });", "        describe('#_importAuthConfirm', () => {", "            var importAuthUrl = faker.internet.ip();", "            var endpoints = [{", "                method: 'PUT',", "                url: importAuthUrl,", "                response: {}", "            }];", "            var server;"]}, {"lines": ["            var putJSONSpy;", "            var activatePickerSpy;"]}, {"lines": ["            before(() => {"]}, {"lines": ["                hardReset();"]}, {"lines": ["                server = utils.createServer(sinon, endpoints);"]}, {"lines": ["                putJSONSpy = sinon.spy($osf, 'putJSON');", "                activatePickerSpy = sinon.spy(vm, 'activatePicker');"]}, {"lines": ["            });", "            after(() => {", "                server.restore();"]}, {"lines": ["                $osf.putJSON.restore();", "                activatePickerSpy.restore();"]}, {"lines": ["            });"]}, {"lines": ["            var data = testUtils.makeFakeData();"]}, {"lines": ["            data.urls.importAuth = importAuthUrl;", "            it('sends a PUT request to the \\'importAuth\\' url passed in settings, calls updateFromData with the response, and calls activatePicker', (done) => {"]}, {"lines": ["                vm.updateFromData(data)", "                    .always(function() {", "                        vm._importAuthConfirm()", "                            .always(function() {"]}, {"lines": ["                                assert.calledWith(", "                                    putJSONSpy,", "                                    importAuthUrl,", "                                    {}"]}, {"lines": ["                                );"]}, {"lines": ["                                assert.calledOnce(activatePickerSpy);"]}, {"lines": ["                                done();", "                            });", "                    });", "            });", "        });", "        describe('#_deauthorizeConfirm', () => {", "            var deleteUrl = faker.internet.ip();", "            var endpoints = [{", "                url: deleteUrl,", "                method: 'DELETE',", "                response: {}", "            }];", "            var server;", "            var spy;"]}, {"lines": ["            var destroyPickerStub;"]}, {"lines": ["            before(() => {"]}, {"lines": ["                hardReset();"]}, {"lines": ["                server = utils.createServer(sinon, endpoints);", "                spy = sinon.spy($, 'ajax');"]}, {"lines": ["                destroyPickerStub = sinon.stub(vm, 'destroyPicker');"]}, {"lines": ["            });", "            after(() => {", "                server.restore();", "                $.ajax.restore();"]}, {"lines": ["                vm.destroyPicker.restore();"]}, {"lines": ["            });"]}, {"lines": ["            var data = testUtils.makeFakeData();"]}, {"lines": ["            data.urls.deauthorize = deleteUrl;", "            it('sends a DELETE request to the \\'deauthorize\\' url passed in settings', (done) => {"]}, {"lines": ["                vm.updateFromData(data)"]}, {"lines": ["                    .always(function() {", "                        vm._deauthorizeConfirm()", "                            .always(function() {"]}, {"lines": ["                                assert.calledWith(", "                                    spy,", "                                    {"]}, {"lines": ["                                        url: deleteUrl,", "                                        type: 'DELETE'"]}, {"lines": ["                                    }"]}, {"lines": ["                                );", "                                done();", "                            });", "                    });", "            });", "        });", "        describe('#togglePicker', () => {", "            it('shows the folder picker and calls activatePicker if hidden', () => {", "                vm.currentDisplay(null);", "                var spy = sinon.spy(vm, 'activatePicker');", "                vm.togglePicker();"]}, {"lines": ["                assert.calledOnce(spy);"]}, {"lines": ["                assert.equal(vm.currentDisplay(), vm.PICKER);", "                vm.activatePicker.restore();", "            });", "            it('hides the folder picker and cancels the selection if visible', () => {", "                vm.currentDisplay(vm.PICKER);", "                var spy = sinon.spy(vm, 'cancelSelection');", "                vm.togglePicker();"]}, {"lines": ["                assert.calledOnce(spy);"]}, {"lines": ["                assert.isNull(vm.currentDisplay());", "                vm.cancelSelection.restore();", "            });", "        });", "        describe('#treebeardOptions', () => {", "            it('throws an Error if the Subclass does not override the default \\'resolveLazyloadUrl\\'', () => {", "                var broken = new TestSubclassVM('Fake Addon', settingsUrl, '#fakeAddonScope', '#fakeAddonPicker');"]}, {"lines": ["                assert.throw(broken.treebeardOptions.resolveLazyloadUrl, 'Subclasses of FolderPickerViewModel must implement a \"resolveLazyloadUrl(item)\" method');"]}, {"lines": ["            });", "            it('throws an Error if the Subclassess does not override the default \\'onPickFolder\\'', () => {", "                var broken = new TestSubclassVM('Fake Addon', settingsUrl, '#fakeAddonScope', '#fakeAddonPicker');"]}, {"lines": ["                assert.throw(broken.treebeardOptions.onPickFolder, 'Subclasses of FolderPickerViewModel must implement a \"onPickFolder(evt, item)\" method');"]}, {"lines": ["            });", "        });", "        describe('#activatePicker', () => {", "            it('instantiates a new folderPicker instance if folders have not been loaded', () => {", "                var urls = vm.urls();", "                urls.folders = faker.internet.ip();", "                vm.urls(urls);", "                var opts = $.extend({}, {", "                    initialFolderPath: vm.folder().path || '',", "                    filesData: vm.urls().folders"]}, {"lines": ["                }, vm.treebeardOptions);"]}, {"lines": [""]}, {"lines": ["                vm.loadedFolders(false);", "                vm.activatePicker();"]}, {"lines": ["                assert.calledOnce(doActivatePickerStub);"]}, {"lines": ["            });"]}, {"lines": ["        });", "    });", "});"]}, {"lines": ["/*global describe, it, expect, example, before, after, beforeEach, afterEach, mocha, sinon*/", "'use strict';", "", "var assert = require('chai').assert;", "var $osf = require('js/osfHelpers');", "", "var utils = require('js/share/utils');"]}, {"lines": ["", "var noop = function(){};", "", "var resultsLoadingSpy = new sinon.spy();", "describe('share/utils', () => {"]}, {"lines": ["    var vm = {", "        page: 0,", "        sort: function(){"]}, {"lines": ["        },", "        sortMap: {", "            sort: 'sort'", "        },"]}, {"lines": ["    };", "", "    describe('#loadMore', () => {"]}, {"lines": ["        var stub;"]}, {"lines": ["        before(() => {"]}, {"lines": ["            stub = sinon.stub(utils, 'buildQuery', function(){"]}, {"lines": ["            });", "        });", "        after(() => {", "            utils.buildQuery.restore();"]}, {"lines": ["        });", ""]}, {"lines": ["            utils.loadMore(vm)", "                .then(function(data){", "                    assert.isNull(data);", "                    done();", "                });", "        });"]}, {"lines": ["    });"]}, {"lines": ["});"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a> based on <a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: params.template_node.url}\">another</a>"]}, {"lines": ["edited description of  <a class=\"log-node-title-link\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["<script type=\"text/html\" id=\"updated_fields\">"]}, {"lines": ["  changed the <span data-bind=\"listing: {"]}, {"lines": ["                                 data: params.updated_fields,"]}, {"lines": ["                                 map: mapUpdates"]}, {"lines": ["                               }\"></span> for"]}, {"lines": ["  <a class=\"log-node-title-link\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["User: ${user.fullname} (${user.username}) [${user._id}]", ""]}, {"lines": ["Tried to register ${src.title} (${src.url}) [${src._id}], but the archive task failed when copying files."]}, {"lines": ["", "A report is included below:", ""]}, {"lines": ["<% import json %>", "", "% for addon in results:"]}, {"lines": ["${addon['name']}:", "  - ${addon['status']}", "   % for err in addon['errors']:"]}, {"lines": ["     ${json.dumps(err)}", "   % endfor"]}, {"lines": ["% endfor"]}, {"lines": ["<% from website import settings %>"]}, {"lines": ["", "User: ${user.fullname} (${user.username}) [${user._id}]", "", "Tried to register ${src.title} (${src.url}), but the resulting archive would have exceeded our caps for disk usage (${settings.MAX_ARCHIVE_SIZE}MB).", "", "A report is included below:", ""]}, {"lines": ["${str(stat_result)}"]}, {"lines": ["<%inherit file=\"notify_base.mako\" />", "", "<%def name=\"content()\">"]}, {"lines": ["<tr>", "  <td style=\"border-collapse: collapse;\">"]}, {"lines": ["  </td>", "</tr>", "<tr>", "  <td style=\"border-collapse: collapse;\">"]}, {"lines": ["    <% from website import settings %>"]}, {"lines": ["    You can view the registration <a href=\"${settings.DOMAIN.rstrip('/') + src.url}\">here.</a>"]}, {"lines": ["  </td>", "</tr>"]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"notify_base.mako\" />", "", "<%def name=\"content()\">"]}, {"lines": ["<tr>", "  <td style=\"border-collapse: collapse;\">", "  <h3 class=\"text-center\" style=\"padding: 0;margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300;text-align: center;\">Issue registering ${src.title}</h3>", "  </td>", "</tr>", "<tr>", "  <td style=\"border-collapse: collapse;\">"]}, {"lines": ["    We cannot archive ${src.title} at this time because there were errors copying files to the registration. Our development team is investigating this failure. We're sorry for any inconvienence this may have caused."]}, {"lines": ["  </td>", "</tr>"]}, {"lines": ["</%def>"]}, {"lines": ["<%inherit file=\"notify_base.mako\" />", ""]}, {"lines": ["                  <% from website.project.model import Node %>"]}, {"lines": ["<%def name=\"content()\">"]}, {"lines": ["<tr>", "  <td style=\"border-collapse: collapse;\">", "    <h3 class=\"text-center\" style=\"padding: 0;margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300;text-align: center;\">Recent Activity</h3>", "  </td>", "</tr>", "<tr>", "  <td style=\"border-collapse: collapse;\">", "    ${build_message(message)}", "  </td>", "</tr>"]}, {"lines": ["</%def>"]}, {"lines": ["<!doctype html>", "<html class=\"no-js\" lang=\"\">", "<head>", "    <meta charset=\"utf-8\">", "    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">", "    <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\">", "    <title>COS Email Notification Template</title>", "    <meta name=\"description\" content=\"Center for Open Science Notifications\">", "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">", "</head>", "<body leftmargin=\"0\" marginwidth=\"0\" topmargin=\"0\" marginheight=\"0\" offset=\"0\" style=\"-webkit-text-size-adjust: none;font-family: 'Helvetica', sans-serif;background: #eeeeee;padding: 0;margin: 0;border: none;list-style: none;width: 100% !important;\">", "    <table id=\"layout-table\" width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">", "        <tr>", "            <td style=\"border-collapse: collapse;\">", "                <table id=\"layout-table\" width=\"100%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\" height=\"100%\">", "                    <tbody>", "                        <tr class=\"banner\" style=\"background: #214762;color: white;\">", "                            <td class=\"text-center\" style=\"border-collapse: collapse;text-align: center;\">", "                                <table id=\"header-logo\" border=\"0\" style=\"margin: 0 auto;padding: 0px;\">", "                                    <tr>", "                                        <td style=\"border-collapse: collapse;\">", "                                            <img src=\"https://osf.io/static/img/cos-white2.png\" alt=\"COS logo\" width=\"36\" style=\"border: 0;height: auto;line-height: 100%;outline: none;text-decoration: none;\">", "                                        </td>", "                                        <td style=\"border-collapse: collapse;\">", "                                            <h2 style=\"padding: 0;margin: 0;border: none;list-style: none;font-weight: 300;font-size: 20px;text-align: left; color:white;\">Open Science Framework</h2>", "                                        </td>", "                                    </tr>", "                                </table>", "                            </td>", "                        </tr>", "                    </tbody>", "                </table>", "            </td>", "        </tr>", "        <tr>", "          <td style=\"border-collapse: collapse;\">"]}, {"lines": ["            <table id=\"content\" width=\"600\" border=\"0\" cellpadding=\"25\" cellspacing=\"0\" align=\"center\" style=\"margin: 30px auto 0 auto;background: white;box-shadow: 0 0 2px #ccc;\">", "              <tbody>", "                ${self.content()}", "              </tbody>", "            </table>"]}, {"lines": ["          </td>", "        </tr>", "        <tr>", "            <td style=\"border-collapse: collapse; padding-top: 15px;\">", "                <table width=\"80%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\" align=\"center\" class=\"footer\" style=\"margin-top: 45px;padding: 25px 0 35px;background-color: rgb(244, 244, 244);border-top: 1px solid #E5E5E5;border-bottom: 1px solid #E5E5E5;width: 100%;color: #555;\">", "                    <tbody>", "                        <tr>", "                            <td style=\"border-collapse: collapse;\">", "                                <p class=\"small text-center\" style=\"text-align: center;font-size: 12px;\">Copyright &copy; 2015 Center For Open Science, All rights reserved. </p>"]}, {"lines": ["                                ${footer()}"]}, {"lines": ["                            </td>", "                        </tr>", "                    </tbody>", "                </table>", "            </td>", "        </tr>", "    </table>", "</body>", "</html>", "", "<%def name=\"content()\">", "", "</%def>"]}, {"lines": ["", "<%def name=\"footer()\">", "", "</%def>"]}, {"lines": ["<%inherit file=\"notify_base.mako\"/>"]}, {"lines": ["<%def name=\"content()\">"]}, {"lines": ["    <table id=\"content\" width=\"600\" border=\"0\" cellpadding=\"25\" cellspacing=\"0\" align=\"center\" style=\"margin: 30px auto 0 auto;background: white;box-shadow: 0 0 2px #ccc;\">", "        <tbody>", "            <tr>", "                <td style=\"border-collapse: collapse;\">", "                    <h3 class=\"text-center\" style=\"padding: 0;margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300;text-align: center;\">Recent Activity</h3>", "                </td>", "            </tr>", "            <tr>", "                <th colspan=\"2\" style=\"padding: 0px 15px 0 15px\">", "                    <h3 style=\"padding: 0 15px 5px 15px; margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300; border-bottom: 1px solid #eee; text-align: left;\">"]}, {"lines": ["                                <% from website.project.model import Node %>"]}, {"lines": ["                </th>", "            </tr>", "        </tbody>", "        <tbody>", "            <tr>", "                <td style=\"border-collapse: collapse;\">", "                    ${message}", "                </td>", "            </tr>", "        </tbody>", "    </table>", "</%def>"]}, {"lines": ["", "", "<%def name=\"footer()\">", "<p class=\"small text-center\" style=\"text-align: center;font-size: 12px; line-height: 20px;\">You received this email because you are subscribed to email notifications.", "  <br><a href=\"${url}\" style=\"padding: 0;margin: 0;border: none;list-style: none;color: #008de5;text-decoration: none;font-weight: bold;\">Update Subscription Preferences</a>", "</p>", "</%def>"]}, {"lines": ["                        ${render_user_settings(user_addons_enabled[name])}"]}, {"lines": ["<%def name=\"render_user_settings(data)\">", "    <%", "       template_name = data['user_settings_template']", "       tpl = data['template_lookup'].get_template(template_name).render(**data)", "    %>", "    ${tpl}", "</%def>", ""]}, {"lines": ["                                <tbody data-bind=\"sortable: {data: selection, as: 'contributor', afterRender: makeAfterRender(), options: {containment: 'parent'}}\">"]}, {"lines": ["       parent_exists = parent_node['exists']"]}, {"lines": ["       parent_title = ''", "       parent_registration_url = ''", "       if parent_exists:", "           parent_title = \"Private {0}\".format(parent_node['category'])", "           parent_registration_url = ''", "       if parent_node['can_view'] or parent_node['is_contributor']:"]}, {"lines": ["           parent_title = parent_node['title']"]}, {"lines": ["    %>"]}, {"lines": ["            urls: {"]}, {"lines": ["                web: ${json.dumps(node['url'])},"]}, {"lines": ["            },"]}, {"lines": ["            anonymous: ${json.dumps(node['anonymous'])},"]}, {"lines": ["            category: '${node['category_short']}',"]}, {"lines": ["            parentExists: ${'true' if parent_exists else 'false'}"]}, {"lines": ["<%def name=\"title()\">Register ${node['title']}</%def>"]}, {"lines": ["                    Type <span data-bind=\"text: truncatedTitle\" style=\"font-weight:bold\"></span> and click Retract Registration if you are sure you want to continue."]}, {"lines": ["            <button type=\"submit\" class=\"btn btn-danger\" data-bind=\"click: submit, css: {disabled: !valid()}\">Retract Registration</button>"]}, {"lines": ["</%def>"]}, {"lines": ["       template_name = data['node_settings_template']"]}, {"lines": ["       tpl = data['template_lookup'].get_template(template_name).render(**data)"]}, {"lines": ["      window.contextVars.nodeCategories = ${json.dumps(categories)};"]}, {"lines": ["<div id=\"${addon_short_name}Scope\" class=\"scripted\">", "    <h4 class=\"addon-title\">", "    ${addon_full_name}", "        <small class=\"authorized-by\">", "            <span data-bind=\"if: nodeHasAuth\">", "                authorized by <a data-bind=\"attr.href: urls().owner\">", "                    {{ownerName}}", "                </a>", "                % if not is_registration:", "                    <a data-bind=\"click: deauthorize\"", "                        class=\"text-danger pull-right addon-auth\">Deauthorize</a>", "                % endif", "            </span>", "", "             <!-- Import Access Token Button -->", "            <span data-bind=\"if: showImport\">", "                <a data-bind=\"click: importAuth\" href=\"#\" class=\"text-primary pull-right addon-auth\">", "                    Import Access Token", "                </a>", "            </span>", ""]}, {"lines": ["            <!-- Oauth Start Button -->", "            <span data-bind=\"if: showTokenCreateButton\">", "                <a data-bind=\"click: connectAccount\" class=\"text-primary pull-right addon-auth\">", "                    Create Access Token", "                </a>", "            </span>", "        </small>", "    </h4>", "    <!-- Settings Pane -->"]}, {"lines": ["    <div class=\"${addon_short_name}-settings\" data-bind=\"visible: showSettings\">"]}, {"lines": ["        <div class=\"row\">", "            <div class=\"col-md-12\">"]}, {"lines": ["                    <strong>Current Folder:</strong>"]}, {"lines": ["                    <a data-bind=\"ifnot: folderName() === '', attr.href: urls().files\">"]}, {"lines": ["                        {{folderName}}", "                    </a>"]}, {"lines": ["                    <span data-bind=\"if: folderName() === ''\" class=\"text-muted\">"]}, {"lines": ["                        None", "                    </span>", "                </p>", "                <!-- Folder buttons -->", "                <div class=\"btn-group\" data-bind=\"visible: userIsOwner() && validCredentials()\">", "                    <button data-bind=\"click: togglePicker,", "                                       css: {active: currentDisplay() === PICKER}\" class=\"btn btn-sm btn-addon\"><i class=\"icon-edit\"></i> Change</button>"]}, {"lines": ["                </div>", "                <!-- Folder picker -->"]}, {"lines": ["                <div class=\"addon-folderpicker-widget ${addon_short_name}-widget\">"]}, {"lines": ["                    <p class=\"text-muted text-center ${addon_short_name}-loading-text\" data-bind=\"visible: loading\">", "                        Loading folders...</p>", "                    <div data-bind=\"visible: currentDisplay() === PICKER\">", "                        <div id=\"${addon_short_name}Grid\" class=\"filebrowser ${addon_short_name}-folder-picker\"></div>", "                    </div>"]}, {"lines": ["                    <!-- Queued selection -->", "                    <div class=\"${addon_short_name}-confirm-selection\" data-bind=\"visible: currentDisplay() == PICKER && selected()\">", "                        <form data-bind=\"submit: submitSettings\">"]}, {"lines": ["                            <div class=\"pull-right\">", "                                <button class=\"btn btn-default\" data-bind=\"click: cancelSelection\">", "                                    Cancel", "                                </button>", "                                <input type=\"submit\" class=\"btn btn-primary\" value=\"Submit\" />", "                            </div>"]}, {"lines": ["                        </form>", "                    </div>", "                </div>", "            </div>", "            <!-- end col -->", "        </div>", "        <!-- end row -->", "    </div>", "    <!-- Flashed Messages -->", "    <div class=\"help-block\">", "        <p data-bind=\"html: message, attr.class: messageClass\"></p>", "    </div>", "</div>"]}, {"lines": ["    <!-- Flashed Messages -->", "    <div class=\"help-block\">", "        <p data-bind=\"html: message, attr: {class: messageClass}\"></p>", "    </div>"]}, {"lines": ["            <span class=\"component-overflow\" style=\"line-height: 1.5;\">"]}, {"lines": ["                <span class=\"project-statuses-lg\">", "                  % if summary['is_retracted']:", "                  <span class=\"label label-danger\"><strong>Retracted</strong></span> |", "                  % elif summary['pending_retraction']:", "                  <span class=\"label label-info\"><strong>Pending Retraction</strong></span> |", "                  % elif summary['embargo_end_date']:", "                  <span class=\"label label-info\"><strong>Embargoed</strong></span> |", "                  % elif summary['pending_embargo']:", "                  <span class=\"label label-info\"><strong>Pending Embargo</strong></span> |", "                  % endif", "                  % if summary['archiving']:", "                  <span class=\"label label-primary\"><strong>Archiving</strong></span> |", "                  % endif", "                </span>"]}, {"lines": ["            % if not summary['archiving']:", "                <a href=\"${summary['url']}\">${summary['title']}</a>", "            % endif", "            % if summary['archiving']:", "                <span>${summary['title']}</span>", "            % endif"]}, {"lines": ["            % if not summary['archiving']:"]}, {"lines": ["            % endif"]}, {"lines": ["        % if not summary['archiving']:"]}, {"lines": ["        % endif"]}, {"lines": ["def conjunct(words, conj='and'):"]}, {"lines": ["    words = list(words)"]}, {"lines": ["    num_words = len(words)", "    if num_words == 0:", "        return ''", "    elif num_words == 1:", "        return words[0]", "    elif num_words == 2:", "        return ' {0} '.format(conj).join(words)", "    elif num_words > 2:", "        return ', '.join(words[:-1]) + ', {0} {1}'.format(conj, words[-1])", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["def waterbutler_url_for(route, provider, path, node, user=None, **kwargs):"]}, {"lines": ["    view_only = False", "    if 'view_only' in kwargs:", "        view_only = kwargs.get('view_only')", "    else:", "        view_only = request.args.get('view_only')"]}, {"lines": ["    url.args['view_only'] = view_only", "", "    url.args.update(kwargs)"]}], "name": "Sam Chrisinger"}, {"commits": [{"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-"]}, {"lines": ["", "import sys"]}, {"lines": ["import mock"]}, {"lines": ["", "from nose.tools import *"]}, {"lines": ["", "from framework.mongo import database"]}, {"lines": ["from website.app import init_app", "from tests.base import OsfTestCase"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from website.addons.github.api import GitHub", "from website.addons.github.model import AddonGitHubOauthSettings, AddonGitHubUserSettings", "", ""]}, {"lines": ["    count, inval_cred_handled = 0, 0"]}, {"lines": [""]}, {"lines": ["    for raw_user_settings in records:"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        if access_token and token_type and github_user_name:"]}, {"lines": ["                    AddonGitHubUserSettings._storage[0].store.update(", "                        {'_id': raw_user_settings['_id']},", "                        {", "                            '$unset': {", "                                \"oauth_access_token\" : True,", "                                \"oauth_token_type\" : True,", "                                \"github_user\" : True,", "                            },", "                        }", "                    )", "                    inval_cred_handled += 1", "                    print('invalidated credentials handled record: {}'.format(raw_user_settings['_id']))"]}, {"lines": ["                    }"]}, {"lines": ["                    }"]}, {"lines": ["    return count, inval_cred_handled"]}, {"lines": ["def get_user_settings():", "    # ... return the StoredObjects to migrate ..."]}, {"lines": ["    return database.addongithubusersettings.find()"]}, {"lines": ["", "def main():"]}, {"lines": ["    init_app('website.settings', set_backends=True, routes=True)  # Sets the storage backends on all models"]}, {"lines": ["    user_settings = get_user_settings()"]}, {"lines": ["    n_migrated, n_inval_cred_handled = do_migration(user_settings, dry='dry' in sys.argv)"]}, {"lines": ["    print(\"Total invalidated credentials handled records: {}\".format(n_inval_cred_handled))"]}, {"lines": [""]}, {"lines": ["", "class TestMigrateGitHubOauthSettings(OsfTestCase):"]}, {"lines": [""]}, {"lines": ["    def setUp(self):", "        super(TestMigrateGitHubOauthSettings, self).setUp()"]}, {"lines": [""]}, {"lines": ["        self.mongo_collection = database.addongithubusersettings"]}, {"lines": ["        self.user_settings = {", "            \"__backrefs\" : {", "                \"authorized\" : {", "                    \"addongithubnodesettings\" : {", "                        \"user_settings\" : [", "                            \"678910\",", "                        ]", "                    }", "                }", "            },", "            \"_id\" : \"123456\",", "            \"_version\" : 1,", "            \"deletedAddonGitHubUserSettings\" : False,", "            \"github_user\" : \"testing user\",", "            \"oauth_access_token\" : \"testing acess token\",", "            \"oauth_state\" : \"no state\",", "            \"oauth_token_type\" : \"testing token type\",", "            \"owner\" : \"abcde\"", "        }", "        self.mongo_collection.insert(self.user_settings)"]}, {"lines": [""]}, {"lines": ["    def test_get_user_settings(self):"]}, {"lines": [""]}, {"lines": ["        records = list(get_user_settings())"]}, {"lines": ["", "        assert_equal(1, len(records))", "        assert_equal("]}, {"lines": ["            records[0]['github_user'],", "            self.user_settings['github_user']"]}, {"lines": ["        )", "        assert_equal("]}, {"lines": ["            records[0]['oauth_state'],", "            self.user_settings['oauth_state']"]}, {"lines": ["        )", "        assert_equal("]}, {"lines": ["            records[0]['oauth_access_token'],", "            self.user_settings['oauth_access_token']"]}, {"lines": ["        )", "        assert_equal("]}, {"lines": ["            records[0]['oauth_token_type'],", "            self.user_settings['oauth_token_type']"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.user')"]}, {"lines": ["    def test_do_migration(self, mock_github_user):", "        user = mock.Mock()", "        user.id = \"testing user id\"", "        mock_github_user.return_value = user"]}, {"lines": ["        do_migration(get_user_settings())"]}, {"lines": ["        user_settings = AddonGitHubUserSettings.find()[0]"]}, {"lines": ["        assert_true(user_settings.oauth_settings)", "        assert_true(user_settings.oauth_state)"]}, {"lines": ["        assert_equal("]}, {"lines": ["            user_settings.oauth_settings.github_user_name,"]}, {"lines": ["            \"testing user\"", "        )", "        assert_equal("]}, {"lines": ["            user_settings.oauth_settings.oauth_access_token,"]}, {"lines": ["            \"testing acess token\"", "        )", "        assert_equal("]}, {"lines": ["            user_settings.oauth_settings.oauth_token_type,"]}, {"lines": ["            \"testing token type\"", "        )", "        assert_equal("]}, {"lines": ["            user_settings.oauth_settings.github_user_id,"]}, {"lines": ["            \"testing user id\"", "        )"]}, {"lines": [""]}, {"lines": ["    def tearDown(self):", "        self.mongo_collection.remove()", ""]}, {"lines": ["if __name__ == '__main__':", "    main()"]}, {"lines": ["import sys", "import logging", "", "from website.app import init_app", "from website.models import User", "from scripts import utils as script_utils", "from modularodm import Q", "", "logger = logging.getLogger(__name__)", "", ""]}, {"lines": ["def do_migration(records, dry=False):"]}, {"lines": ["    for user in records:", "        log_info(user)"]}, {"lines": ["        if not dry:", "            user.username = None", "            user.password = None", "            user.email_verifications = {}", "            user.verification_key = None", "            user.save()"]}, {"lines": ["", "", "def get_targets():", "    return User.find(Q('merged_by', 'ne', None) & Q('username', 'ne', None))", "", "", "def log_info(user):", "    logger.info("]}, {"lines": ["            user._id,"]}, {"lines": ["        )", "    )", "", "", "def main():", "    init_app(routes=False)  # Sets the storage backends on all models"]}, {"lines": ["    dry = 'dry' in sys.argv", "    if not dry:", "        script_utils.add_file_logger(logger, __file__)", "    do_migration(get_targets(), dry)"]}, {"lines": ["", "", "if __name__ == '__main__':"]}, {"lines": ["    main()"]}, {"lines": ["import sys", "import logging", "", "from website.app import init_app", "from website.models import Node", "from scripts import utils as script_utils", "from modularodm import Q", "", "logger = logging.getLogger(__name__)", "", "", "def do_migration(records, dry=False):"]}, {"lines": ["    for node in records:"]}, {"lines": ["            logger.info("]}, {"lines": ["            )"]}, {"lines": ["", "", "def get_targets():", "    return Node.find(Q('is_deleted', 'ne', True))", "", "", "def main():", "    init_app(routes=False)  # Sets the storage backends on all models", "    dry = 'dry' in sys.argv", "    if not dry:", "        script_utils.add_file_logger(logger, __file__)", "    do_migration(get_targets(), dry)", "", "", "if __name__ == '__main__':"]}, {"lines": ["import sys", "import logging", "", "from framework.auth.core import get_user"]}, {"lines": ["from website.project.model import Node", "from website.app import init_app", "from scripts import utils as script_utils", "", "", "logger = logging.getLogger(__name__)", "", "", "def do_migration(records, dry=False):", "    for user in records:", "        logger.info('Deleting user - {}'.format(user._id))", "        if not dry:"]}, {"lines": ["    logger.info('{}Deleted {} users'.format('[dry]'if dry else '', len(records)))", "", "", "def migrate_project_contributed(user):", "    count = 0", "    for node_id in user.node__contributed:", "        node = Node.load(node_id)", "        if node._primary_key in user.unclaimed_records:", "            del user.unclaimed_records[node._primary_key]", "", "        node.contributors.remove(user._id)", "", "        node.clear_permission(user)", "        if user._id in node.visible_contributor_ids:", "            node.visible_contributor_ids.remove(user._id)", "", "        node.save()", "        count += 1", "        logger.info('Removed user - {} as a contributor from project - {}'.format(user._id, node._id))", "    logger.info('Removed user - {} as a contributor from {} projects'.format(user._id, count))", "", "", "def get_targets():", "    users = []", "    user1 = get_user(email='presentations@cos.io')", "    if user1:", "        users.append(user1)", "    user2 = get_user(email='presentations@osf.io')", "    if user2:", "        users.append(user2)", "    return users", "", "", "def main():", "    init_app(routes=False)  # Sets the storage backends on all models", "    dry = 'dry' in sys.argv", "    if not dry:", "        script_utils.add_file_logger(logger, __file__)", "    do_migration(get_targets(), dry)", "", "", "if __name__ == '__main__':", "    main()"]}, {"lines": ["from website.models import Node", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory, UserFactory, NodeFactory", "from scripts.migrate_logs_fix import (", "    do_migration, get_targets", ")", "", "", "class TestMigrateLogs(OsfTestCase):", "", "    def tearDown(self):", "        OsfTestCase.tearDown(self)", "        Node.remove()", "", "    def test_get_targets(self):", "        project1 = ProjectFactory()", "        for log in project1.logs:", "            log.should_hide = True", "            log.save()", "        project1.save()", ""]}, {"lines": ["", "    def test_do_migration(self):", "        project = ProjectFactory()", "        user = UserFactory()", "        node = NodeFactory(parent=project)", "        node.add_contributor(contributor=user)", "        node.save()", "        for log in node.logs:", "            if log.action == 'contributor_added':", "                log.should_hide = True", "                log.save()", "                project.logs.append(log)", "        project.save()", ""]}, {"lines": ["", "        logs = [each for each in project.logs if each.action == 'contributor_added']", "        assert len(logs) is 0", "", "        logs2 = [each for each in node.logs if each.action == 'contributor_added']", "        assert logs2[0].should_hide is False"]}, {"lines": ["from website.models import Node", "from framework.auth import Auth", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory, UserFactory, NodeFactory", "from scripts.migrate_registration_and_fork_log import (", "    get_parent, get_all_parents", ")", "", "", "class TestMigrateLogs(OsfTestCase):", "", "    def tearDown(self):", "        OsfTestCase.tearDown(self)", "        Node.remove()", "", "    def test_get_parent(self):", "        user = UserFactory()", "        auth = Auth(user=user)", "        project1 = ProjectFactory(creator=user)", "        project2 = project1.fork_node(auth=auth)", "        forked_from = get_parent(project2)", "", "        assert forked_from is project1", "", "        project3 = project2.register_node(schema=None, auth=auth, template=\"foo\", data=\"bar\")", "        registered_from = get_parent(project3)", "", "        assert registered_from is project2", "", "    def test_get_all_parents(self):", "        user = UserFactory()", "        auth = Auth(user=user)", "        project1 = ProjectFactory(creator=user)", "        project2 = project1.fork_node(auth=auth)", "        project3 = project2.register_node(schema=None, auth=auth, template=\"foo\", data=\"bar\")", "        parent_list = get_all_parents(project3)", "", "        assert len(parent_list) is 2", "        assert project1 in parent_list", "        assert project2 in parent_list"]}, {"lines": ["        request_args = {'view_only': 'mykey'}"]}, {"lines": ["        assert_equal(auth_obj.private_key, request_args['view_only'])"]}, {"lines": ["        self.link = PrivateLinkFactory()"]}, {"lines": ["        self.link.nodes.append(self.project)", "        self.link.save()"]}, {"lines": ["            {'view_only': self.link.key})"]}, {"lines": ["    def test_public_parent_title(self):"]}, {"lines": ["        self.project.save()", "        docs = query('category:component AND ' + self.title)['results']", "        assert_equal(len(docs), 1)", "        assert_equal(docs[0]['parent_title'], 'hello & world')", "        assert_true(docs[0]['parent_url'])", ""]}, {"lines": ["from framework.auth.exceptions import InvalidTokenError"]}, {"lines": ["from website.project.model import ensure_schemas, has_anonymous_link"]}, {"lines": ["from website.project.decorators import check_can_access"]}, {"lines": ["from website.addons.github.model import AddonGitHubOauthSettings"]}, {"lines": ["        self.link = PrivateLinkFactory()"]}, {"lines": ["        self.link.nodes.append(self.project)", "        self.link.save()"]}, {"lines": ["    def test_not_anonymous_for_public_project(self):", "        anonymous_link = PrivateLinkFactory(anonymous=True)", "        anonymous_link.nodes.append(self.project)", "        anonymous_link.save()", "        self.project.set_privacy('public')", "        self.project.save()", "        self.project.reload()"]}, {"lines": ["        auth = Auth(user=self.user, private_key=anonymous_link.key)", "        assert_false(has_anonymous_link(self.project, auth))"]}, {"lines": [""]}, {"lines": ["        res = self.app.get(self.project_url, {'view_only': None})"]}, {"lines": ["        res = self.app.get(self.project_url, {'view_only': None}, auth=self.user.auth,"]}, {"lines": ["        res = self.app.get(self.project_url, {'key': self.link.key})"]}, {"lines": ["        assert_equal(res.request.GET['key'], self.link.key)"]}, {"lines": ["    def test_can_view_nested_project_as_admin(self):", "        self.parent_project = NodeFactory(", "            title='parent project',", "            category='project',"]}, {"lines": ["            is_public=False", "        )", "        self.parent_project.save()", "        self.child_project = NodeFactory(", "            title='child project',", "            category='project',"]}, {"lines": ["            is_public=False", "        )", "        self.child_project.save()", "        url = self.child_project.web_url_for('view_project')", "        res = self.app.get(url, auth=self.auth)", "        assert_not_in('Private Project', res.body)", "        assert_in('parent project', res.body)", ""]}, {"lines": ["        for _ in range(5):"]}, {"lines": ["        url = self.project.api_url_for('get_logs')"]}, {"lines": ["        assert_equal(data['total'], len(self.project.logs))", "        assert_equal(data['page'], 0)", "        assert_equal(data['pages'], 1)"]}, {"lines": ["    def test_get_logs_invalid_page_input(self):"]}, {"lines": ["        url = self.project.api_url_for('get_logs')"]}, {"lines": ["        invalid_input = 'invalid page'"]}, {"lines": ["        res = self.app.get("]}, {"lines": ["            url, {'page': invalid_input}, auth=self.auth, expect_errors=True"]}, {"lines": ["        )", "        assert_equal(res.status_code, 400)", "        assert_equal(", "            res.json['message_long'],"]}, {"lines": ["            'Invalid value for \"page\".'"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["        for _ in range(5):"]}, {"lines": ["        url = self.project.api_url_for('get_logs')"]}, {"lines": ["        # 1 project create log, 1 add contributor log, then 5 generated logs"]}, {"lines": ["        assert_equal(res.json['total'], 5 + 2)"]}, {"lines": ["        assert_equal(res.json['page'], 0)"]}, {"lines": ["        assert_equal(res.json['pages'], 3)"]}, {"lines": ["        for _ in range(12):"]}, {"lines": ["        url = self.project.api_url_for('get_logs')"]}, {"lines": ["        # 1 project create log, 1 add contributor log, then 5 generated logs"]}, {"lines": ["        assert_equal(res.json['total'], 12 + 2)"]}, {"lines": ["        assert_equal(res.json['page'], 0)", "        assert_equal(res.json['pages'], 2)"]}, {"lines": ["    def test_get_more_logs(self):", "        # Add some logs"]}, {"lines": ["        for _ in range(12):"]}, {"lines": ["        self.project.save()"]}, {"lines": ["        url = self.project.api_url_for('get_logs')"]}, {"lines": ["        res = self.app.get(url, {\"page\": 1}, auth=self.auth)"]}, {"lines": ["        assert_equal(len(res.json['logs']), 4)"]}, {"lines": ["        #1 project create log, 1 add contributor log, then 12 generated logs"]}, {"lines": ["        assert_equal(res.json['total'], 12 + 2)"]}, {"lines": ["        assert_equal(res.json['page'], 1)", "        assert_equal(res.json['pages'], 2)"]}, {"lines": [""]}, {"lines": ["        for _ in range(15):"]}, {"lines": ["        for _ in range(5):"]}, {"lines": [""]}, {"lines": ["        url = self.project.api_url_for('get_logs')"]}, {"lines": ["        # 1 project create log, 1 add contributor log, then 15 generated logs"]}, {"lines": ["        assert_equal(res.json['total'], 15 + 2)"]}, {"lines": ["        assert_equal(res.json['page'], 0)", "        assert_equal(res.json['pages'], 2)"]}, {"lines": ["    def test_can_view_public_log_from_private_project(self):", "        project = ProjectFactory(is_public=True)", "        fork = project.fork_node(auth=self.consolidate_auth1)", "        url = fork.api_url_for('get_logs')", "        res = self.app.get(url, auth=self.auth)", "        assert_equal(", "            [each['action'] for each in res.json['logs']],", "            ['node_forked', 'project_created'],", "        )", "        project.is_public = False", "        project.save()", "        res = self.app.get(url, auth=self.auth)", "        assert_equal(", "            [each['action'] for each in res.json['logs']],", "            ['node_forked', 'project_created'],", "        )"]}, {"lines": ["    def test_for_private_component_log(self):"]}, {"lines": ["        for _ in range(5):", "            self.project.add_log(", "                auth=self.consolidate_auth1,", "                action='file_added',"]}, {"lines": ["            )", "        self.project.is_public = True", "        self.project.save()"]}, {"lines": ["        child.is_public = False", "        child.set_title(\"foo\", auth=self.consolidate_auth1)"]}, {"lines": ["        child.set_title(\"bar\", auth=self.consolidate_auth1)", "        child.save()"]}, {"lines": ["        res = self.app.get(url).maybe_follow()", "        assert_equal(len(res.json['logs']), 7)", "        assert_not_in(", "            child._id,", "            ["]}, {"lines": ["                for log in res.json['logs']", "            ]", "        )", ""]}, {"lines": ["    def test_private_link_edit_name(self):", "        link = PrivateLinkFactory()", "        link.nodes.append(self.project)", "        link.save()", "        assert_equal(link.name, \"link\")", "        url = self.project.api_url + 'private_link/edit/'"]}, {"lines": ["        self.project.reload()", "        link.reload()", "        assert_equal(link.name, \"new name\")", ""]}, {"lines": ["    def test_remove_private_link(self):", "        link = PrivateLinkFactory()"]}, {"lines": ["        link.nodes.append(self.project)", "        link.save()"]}, {"lines": ["        self.project.reload()"]}, {"lines": ["        link.reload()", "        assert_true(link.is_deleted)"]}, {"lines": [""]}, {"lines": ["        oauth_settings = AddonGitHubOauthSettings()"]}, {"lines": ["        oauth_settings.github_user_id = 'testuser'"]}, {"lines": ["        oauth_settings.save()", "        user_github.oauth_settings = oauth_settings"]}, {"lines": ["        user_github.github_user_name = 'howtogithub'"]}, {"lines": ["        oauth_settings.save()"]}, {"lines": ["        oauth_settings = AddonGitHubOauthSettings()"]}, {"lines": ["        oauth_settings.github_user_id = 'testuser'"]}, {"lines": ["        oauth_settings.save()", "        user_github.oauth_settings = oauth_settings"]}, {"lines": ["        user_github.github_user_name = 'howtogithub'"]}, {"lines": ["        oauth_settings.save()"]}, {"lines": ["        payload = {'timezone': 'America/New_York', 'id': self.user._id}"]}, {"lines": ["        payload = {'locale': 'de_DE', 'id': self.user._id}"]}, {"lines": ["        payload = {'locale': None, 'id': self.user._id}"]}, {"lines": ["        payload = {'locale': '', 'id': self.user._id}"]}, {"lines": ["        url = '/api/v1/user/{uid}/{pid}/claim/email/'.format("]}, {"lines": ["    def test_user_with_removed_unclaimed_url_claiming(self):"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        url = '/api/v1/user/{0}/{1}/claim/email/'.format(self.user._primary_key,"]}, {"lines": ["        url = '/api/v1/user/{0}/{1}/claim/email/'.format(self.user._primary_key,"]}, {"lines": ["        assert_equal(len(res.json['logs']), 10)"]}, {"lines": ["    def test_get_watched_logs(self):", "        project = ProjectFactory()", "        # Add some logs", "        for _ in range(12):", "            project.logs.append(NodeLogFactory(user=self.user, action=\"file_added\"))", "        project.save()", "        watch_cfg = WatchConfigFactory(node=project)", "        self.user.watch(watch_cfg)", "        self.user.save()", "        url = api_url_for(\"watched_logs_get\")", "        res = self.app.get(url, auth=self.auth)", "        assert_equal(len(res.json['logs']), 10)"]}, {"lines": ["        # 1 project create log then 12 generated logs"]}, {"lines": ["        assert_equal(res.json['total'], 12 + 1)", "        assert_equal(res.json['page'], 0)", "        assert_equal(res.json['pages'], 2)", "        assert_equal(res.json['logs'][0]['action'], 'file_added')", ""]}, {"lines": ["    def test_get_more_watched_logs(self):", "        project = ProjectFactory()", "        # Add some logs", "        for _ in range(12):", "            project.logs.append(NodeLogFactory(user=self.user, action=\"file_added\"))", "        project.save()", "        watch_cfg = WatchConfigFactory(node=project)", "        self.user.watch(watch_cfg)", "        self.user.save()"]}, {"lines": ["        url = api_url_for(\"watched_logs_get\")", "        page = 1", "        res = self.app.get(url, {'page': page}, auth=self.auth)"]}, {"lines": ["        assert_equal(len(res.json['logs']), 3)"]}, {"lines": ["        # 1 project create log then 12 generated logs"]}, {"lines": ["        assert_equal(res.json['total'], 12 + 1)", "        assert_equal(res.json['page'], page)"]}, {"lines": ["        assert_equal(res.json['pages'], 2)"]}, {"lines": ["    def test_get_more_watched_logs_invalid_page(self):"]}, {"lines": ["        project = ProjectFactory()"]}, {"lines": ["        watch_cfg = WatchConfigFactory(node=project)", "        self.user.watch(watch_cfg)", "        self.user.save()", "        url = api_url_for(\"watched_logs_get\")"]}, {"lines": ["        invalid_page = 'invalid page'"]}, {"lines": ["        res = self.app.get("]}, {"lines": ["            url, {'page': invalid_page}, auth=self.auth, expect_errors=True"]}, {"lines": ["        )", "        assert_equal(res.status_code, 400)", "        assert_equal(", "            res.json['message_long'],"]}, {"lines": ["            'Invalid value for \"page\".'"]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["    def test_get_more_watched_logs_invalid_size(self):"]}, {"lines": ["        project = ProjectFactory()"]}, {"lines": ["        watch_cfg = WatchConfigFactory(node=project)", "        self.user.watch(watch_cfg)", "        self.user.save()", "        url = api_url_for(\"watched_logs_get\")"]}, {"lines": ["        invalid_size = 'invalid size'"]}, {"lines": ["        res = self.app.get("]}, {"lines": ["            url, {'size': invalid_size}, auth=self.auth, expect_errors=True"]}, {"lines": ["        )", "        assert_equal(res.status_code, 400)", "        assert_equal(", "            res.json['message_long'],"]}, {"lines": ["            'Invalid value for \"size\".'"]}, {"lines": ["        )"]}, {"lines": ["    def test_add_pointers_no_user_logg_in(self):", "", "        url = self.project.api_url_for('add_pointers')", "        node_ids = [", "            NodeFactory()._id", "            for _ in range(5)", "        ]"]}, {"lines": [""]}, {"lines": ["", "    def test_add_pointers_public_non_contributor(self):", "", "        project2 = ProjectFactory()", "        project2.set_privacy('public')", "        project2.save()"]}, {"lines": ["", "        url = self.project.api_url_for('add_pointers')", "", "        self.app.post_json(", "            url,", "            {'nodeIds': [project2._id]},", "            auth=self.user.auth,", "        ).maybe_follow()", "", "        self.project.reload()", "        assert_equal(", "            len(self.project.nodes),", "            1", "        )", "", "    def test_add_pointers_contributor(self):", "        user2 = AuthUserFactory()", "        self.project.add_contributor(user2)", "        self.project.save()"]}, {"lines": [""]}, {"lines": ["        url = self.project.api_url_for('add_pointers')", "        node_ids = [", "            NodeFactory()._id", "            for _ in range(5)", "        ]", "        self.app.post_json(", "            url,", "            {'nodeIds': node_ids},", "            auth=user2.auth,", "        ).maybe_follow()", "", "        self.project.reload()", "        assert_equal(", "            len(self.project.nodes),", "            5", "        )", ""]}, {"lines": ["    @mock.patch('framework.auth.views.mails.send_mail')", "    def test_resend_confirmation(self, send_mail):", "        email = 'test@example.com'", "        token = self.user.add_unconfirmed_email(email)", "        self.user.save()", "        url = api_url_for('resend_confirmation')", "        header = {'address': email, 'primary': False, 'confirmed': False}", "        self.app.put_json(url, {'id': self.user._id, 'email': header}, auth=self.user.auth)", "        assert_true(send_mail.called)", "        assert_true(send_mail.called_with(", "            to_addr=email", "        ))", "        self.user.reload()", "        assert_not_equal(token, self.user.get_confirmation_token(email))", "        with assert_raises(InvalidTokenError):", "            self.user._get_unconfirmed_email_for_token(token)"]}, {"lines": ["    def test_resend_confirmation_without_user_id(self):", "        email = 'test@example.com'", "        url = api_url_for('resend_confirmation')", "        header = {'address': email, 'primary': False, 'confirmed': False}", "        res = self.app.put_json(url, {'email': header}, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)", "        assert_equal(res.json['message_long'], '\"id\" is required')", "", "    def test_resend_confirmation_without_email(self):", "        url = api_url_for('resend_confirmation')", "        res = self.app.put_json(url, {'id': self.user._id}, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)", "", "    def test_resend_confirmation_not_work_for_primary_email(self):", "        email = 'test@example.com'", "        url = api_url_for('resend_confirmation')", "        header = {'address': email, 'primary': True, 'confirmed': False}", "        res = self.app.put_json(url, {'id': self.user._id, 'email': header}, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)", "        assert_equal(res.json['message_long'], 'Cannnot resend confirmation for confirmed emails')", "", "    def test_resend_confirmation_not_work_for_confirmed_email(self):", "        email = 'test@example.com'", "        url = api_url_for('resend_confirmation')", "        header = {'address': email, 'primary': False, 'confirmed': True}", "        res = self.app.put_json(url, {'id': self.user._id, 'email': header}, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)", "        assert_equal(res.json['message_long'], 'Cannnot resend confirmation for confirmed emails')"]}, {"lines": ["    def test_view_comments_with_anonymous_link(self):"]}, {"lines": ["        self.project.save()"]}, {"lines": ["        self.project.reload()", "        user = AuthUserFactory()", "        link = PrivateLinkFactory(anonymous=True)", "        link.nodes.append(self.project)", "        link.save()", "", "        CommentFactory(node=self.project, user=self.project.creator, is_public=False)", "", "        url = self.project.api_url + 'comments/'", "        res = self.app.get(url, {\"view_only\": link.key}, auth=user.auth)", "        comment = res.json['comments'][0]", "        author = comment['author']", "        assert_in('A user', author['name'])", "        assert_false(author['gravatarUrl'])", "        assert_false(author['url'])", "        assert_false(author['id'])", ""]}, {"lines": ["        self.project = ProjectFactory.build(creator=self.user, is_public=True)"]}, {"lines": ["    def test_fork_private_project_non_contributor(self):", "        self.project.set_privacy(\"private\")", "        self.project.save()"]}, {"lines": ["", "        url = self.project.api_url_for('node_fork_page')", "        non_contributor = AuthUserFactory()", "        res = self.app.post_json(url,", "                                 auth=non_contributor.auth,", "                                 expect_errors=True)", "        assert_equal(res.status_code, http.FORBIDDEN)", "", "    def test_fork_public_project_non_contributor(self):", "        url = self.project.api_url_for('node_fork_page')", "        non_contributor = AuthUserFactory()", "        res = self.app.post_json(url, auth=non_contributor.auth)", "        assert_equal(res.status_code, 200)", "", "    def test_fork_project_contributor(self):", "        contributor = AuthUserFactory()", "        self.project.set_privacy(\"private\")", "        self.project.add_contributor(contributor)", "        self.project.save()"]}, {"lines": ["", "        url = self.project.api_url_for('node_fork_page')", "        res = self.app.post_json(url, auth=contributor.auth)", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["    def test_project_new_from_template_non_user(self):", "        project = ProjectFactory()", "        url = api_url_for('project_new_from_template', nid=project._id)"]}, {"lines": ["        assert_equal(res.status_code, 302)"]}, {"lines": ["", "    def test_project_new_from_template_public_non_contributor(self):", "        non_contributor = AuthUserFactory()", "        project = ProjectFactory(is_public=True)", "        url = api_url_for('project_new_from_template', nid=project._id)"]}, {"lines": ["        assert_equal(res.status_code, 201)", "", "    def test_project_new_from_template_contributor(self):", "        contributor = AuthUserFactory()", "        project = ProjectFactory(is_public=False)", "        project.add_contributor(contributor)", "        project.save()", "", "        url = api_url_for('project_new_from_template', nid=project._id)"]}, {"lines": ["        assert_equal(res.status_code, 201)", ""]}, {"lines": ["from framework.exceptions import PermissionsError"]}, {"lines": ["        u = factories.UnconfirmedUserFactory.build(", "            username='letsgettacos@lgt.com'"]}, {"lines": ["        u.add_unconfirmed_email('LetsGetTacos@LGT.com')"]}, {"lines": ["        u.save()"]}, {"lines": ["", "    def test_cannot_remove_primary_email_from_email_list(self):", "        with assert_raises(PermissionsError) as e:", "            self.user.remove_email(self.user.username)", "        assert_equal(e.exception.message, \"Can't remove primary email\")", ""]}, {"lines": ["    def test_add_same_unconfirmed_email_twice(self):", "        email = \"test@example.com\"", "        token1 = self.user.add_unconfirmed_email(email)", "        self.user.save()", "        self.user.reload()", "        assert_equal(token1, self.user.get_confirmation_token(email))", "        assert_equal(email, self.user._get_unconfirmed_email_for_token(token1))", "", "        token2 = self.user.add_unconfirmed_email(email)", "        self.user.save()", "        self.user.reload()", "        assert_not_equal(token1, self.user.get_confirmation_token(email))", "        assert_equal(token2, self.user.get_confirmation_token(email))", "        assert_equal(email, self.user._get_unconfirmed_email_for_token(token2))", "        with assert_raises(exceptions.InvalidTokenError):"]}, {"lines": ["            self.user._get_unconfirmed_email_for_token(token1)", ""]}, {"lines": [""]}, {"lines": ["", "#disk saving mode"]}, {"lines": ["            '/meetings/',"]}, {"lines": ["        Rule(", "            '/presentations/',", "            'get',", "            conference_views.redirect_to_meetings,", "            json_renderer,", "        ),", ""]}, {"lines": ["        Rule('/resend/', 'put', profile_views.resend_confirmation, json_renderer),"]}, {"lines": [""]}, {"lines": ["        Rule(["]}, {"lines": ["            '/project/<pid>/private_link/',", "            '/project/<pid>/node/<nid>/private_link/',"]}, {"lines": ["        ], 'post', project_views.node.project_generate_private_link_post, json_renderer),"]}, {"lines": [""]}, {"lines": ["        Rule(["]}, {"lines": ["            '/project/<pid>/private_link/edit/',", "            '/project/<pid>/node/<nid>/private_link/edit/',"]}, {"lines": ["", "        Rule(["]}, {"lines": ["            '/project/<pid>/private_link/',", "            '/project/<pid>/node/<nid>/private_link/',", "        ], 'delete', project_views.node.remove_private_link, json_renderer),"]}, {"lines": [""]}, {"lines": ["        Rule(["]}, {"lines": ["            '/project/<pid>/private_link/',", "            '/project/<pid>/node/<nid>/private_link/',"]}, {"lines": ["        ], 'get', project_views.node.private_link_table, json_renderer),", ""]}, {"lines": ["                    'api_url': node.api_url"]}, {"lines": ["    def after_remove_contributor(self, node, removed, auth=None):"]}, {"lines": ["    def after_remove_contributor(self, node, removed, auth=None):"]}, {"lines": ["", "            # Delete OAuth tokens"]}, {"lines": ["            message = (", "                u'Because the {addon} add-on for {category} \"{title}\" was authenticated '", "                u'by {user}, authentication information has been deleted.'"]}, {"lines": ["                category=node.category_display,", "                title=node.title,", "                user=removed.fullname"]}, {"lines": ["            if not auth or auth.user != removed:", "                url = node.web_url_for('node_setting')"]}, {"lines": ["                message += (", "                    u' You can re-authenticate on the <a href=\"{url}\">Settings</a> page.'", "                ).format(url=url)"]}, {"lines": ["            #", "            return message", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def after_remove_contributor(self, node, removed, auth=None):"]}, {"lines": [""]}, {"lines": ["            message = (", "                u'Because the Dataverse add-on for {category} \"{title}\" was authenticated '", "                u'by {user}, authentication information has been deleted.'", "            ).format(", "                category=node.category_display,", "                title=node.title,", "                user=removed.fullname", "            )"]}, {"lines": [""]}, {"lines": ["            if not auth or auth.user != removed:"]}, {"lines": ["                url = node.web_url_for('node_setting')"]}, {"lines": ["                message += (", "                    u' You can re-authenticate on the <a href=\"{url}\">Settings</a> page.'", "                ).format(url=url)"]}, {"lines": ["            #", "            return message"]}, {"lines": ["@decorators.must_not_be_registration"]}, {"lines": ["<span class=\"overflow log-folder\">{{ stripSlash(params.path) }}</span> in"]}, {"lines": ["removed {{ pathType(params.path) }} <span class=\"overflow\">{{ stripSlash(params.path) }}</span> from"]}, {"lines": ["    def test_after_remove_authorized_dropbox_user_self(self):", "        auth = Auth(user=self.user_settings.owner)", "        message = self.node_settings.after_remove_contributor(", "            self.project, self.user_settings.owner, auth)", "        self.node_settings.save()", "        assert_is_none(self.node_settings.user_settings)", "        assert_true(message)", "        assert_not_in(\"You can re-authenticate\", message)", "", "    def test_after_remove_authorized_dropbox_user_not_self(self):"]}, {"lines": ["            node=self.project, removed=self.user_settings.owner)"]}, {"lines": ["        assert_in(\"You can re-authenticate\", message)"]}, {"lines": ["from dropbox.client import DropboxOAuth2Flow", ""]}, {"lines": [""]}, {"lines": ["from tests.factories import AuthUserFactory, ProjectFactory"]}, {"lines": ["    @mock.patch('website.addons.dropbox.views.auth.session')", "    @mock.patch('website.addons.dropbox.views.auth.DropboxOAuth2Flow.finish')", "    def test_dropbox_oauth_finish_cancelled(self, mock_finish, mock_session):", "        node = ProjectFactory(creator=self.user)", "        mock_session.data = {'dropbox_auth_nid': node._id}", "        mock_response = mock.Mock()", "        mock_response.status = 404", "        mock_finish.side_effect = DropboxOAuth2Flow.NotApprovedException", "        settings = self.user.get_addon('dropbox')", "        url = api_url_for('dropbox_oauth_finish')", "        res = self.app.get(url)", "", "        assert_is_redirect(res)", "        assert_in(node._id, res.headers[\"location\"])", "        assert_false(settings)", ""]}, {"lines": ["def finish_auth(node):"]}, {"lines": ["        if node:", "            return redirect(node.web_url_for('node_setting'))"]}, {"lines": ["    result = finish_auth(node)"]}, {"lines": ["    def after_remove_contributor(self, node, removed, auth=None):"]}, {"lines": ["            message = (", "                u'Because the FigShare add-on for {category} \"{title}\" was authenticated '", "                u'by {user}, authentication information has been deleted.'", "            ).format(", "                category=node.category_display,", "                title=node.title,", "                user=removed.fullname", "            )"]}, {"lines": [""]}, {"lines": ["            if not auth or auth.user != removed:"]}, {"lines": ["                url = node.web_url_for('node_setting')"]}, {"lines": ["                message += (", "                    u' You can re-authenticate on the <a href=\"{url}\">Settings</a> page.'", "                ).format(url=url)"]}, {"lines": ["            #", "            return message"]}, {"lines": ["    def test_after_remove_contributor_authenticator_not_self(self):", "        auth = Auth(user=self.non_authenticator)"]}, {"lines": ["            self.project, self.project.creator, auth", "        )", "", "        assert_in(", "            self.project.project_or_component,", "            msg", "        )", "        assert_equal(", "            self.node_settings.user_settings,", "            None", "        )"]}, {"lines": ["        assert_in(\"You can re-authenticate\", msg)"]}, {"lines": ["", "    def test_after_remove_contributor_authenticator_self(self):", "        msg = self.node_settings.after_remove_contributor(", "            self.project, self.project.creator, self.consolidated_auth"]}, {"lines": ["            self.project.title,"]}, {"lines": ["        assert_not_in(\"You can re-authenticate\", msg)"]}, {"lines": ["from .utils import create_mock_github", "mock_github = create_mock_github()"]}, {"lines": [""]}, {"lines": ["    def test_after_remove_contributor_authenticator_self(self):", "        message = self.node_settings.after_remove_contributor(", "            self.project, self.project.creator, self.consolidated_auth"]}, {"lines": ["        assert_true(message)"]}, {"lines": ["        assert_not_in(\"You can re-authenticate\", message)"]}, {"lines": ["", "    def test_after_remove_contributor_authenticator_not_self(self):", "        auth = Auth(user=self.non_authenticator)", "        message = self.node_settings.after_remove_contributor(", "            self.project, self.project.creator, auth", "        )", "        assert_equal(", "            self.node_settings.user_settings,", "            None", "        )", "        assert_true(message)"]}, {"lines": ["        assert_in(\"You can re-authenticate\", message)"]}, {"lines": ["            self.project, self.non_authenticator, self.consolidated_auth"]}, {"lines": [""]}, {"lines": ["        self.oauth_settings = AddonGitHubOauthSettings()", "        self.oauth_settings.github_user_id = 'testuser'", "        self.oauth_settings.save()", "        self.user_settings.oauth_settings = self.oauth_settings", "        self.user_settings.save()"]}, {"lines": ["        self.oauth_settings.github_user_name = \"test user name\"", "        self.oauth_settings.save()", "        assert_equal(self.user_settings.github_user_name, \"test user name\")"]}, {"lines": ["        self.oauth_settings.oauth_access_token = \"test access token\"", "        self.oauth_settings.save()", "        assert_equal(self.user_settings.oauth_access_token, \"test access token\")"]}, {"lines": ["        self.oauth_settings.oauth_token_type = \"test token type\"", "        self.oauth_settings.save()", "        assert_equal(self.user_settings.oauth_token_type, \"test token type\")"]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.revoke_token')", "    def test_clear_auth(self, mock_revoke_token):", "        mock_revoke_token.return_value = True"]}, {"lines": ["        self.user_settings.clear_auth(save=True)", "        assert_false(self.user_settings.github_user_name)", "        assert_false(self.user_settings.oauth_token_type)", "        assert_false(self.user_settings.oauth_access_token)"]}, {"lines": ["        assert_false(self.user_settings.oauth_settings)"]}, {"lines": ["import mock"]}, {"lines": ["        url = \"/api/v1/project/{0}/github/hook/\".format(self.project._id)"]}, {"lines": ["            url,"]}, {"lines": ["        self.project.reload()", "        assert_equal(self.project.logs[-1].action, \"github_file_added\")"]}, {"lines": [""]}, {"lines": ["        url = \"/api/v1/project/{0}/github/hook/\".format(self.project._id)"]}, {"lines": ["            url,"]}, {"lines": ["            content_type=\"application/json\").maybe_follow()", "        self.project.reload()", "        assert_equal(self.project.logs[-1].action, \"github_file_updated\")"]}, {"lines": [""]}, {"lines": ["        url = \"/api/v1/project/{0}/github/hook/\".format(self.project._id)"]}, {"lines": ["            url,"]}, {"lines": ["            content_type=\"application/json\").maybe_follow()", "        self.project.reload()", "        assert_equal(self.project.logs[-1].action, \"github_file_removed\")"]}, {"lines": [""]}, {"lines": ["        url = \"/api/v1/project/{0}/github/hook/\".format(self.project._id)"]}, {"lines": ["            url,"]}, {"lines": ["            content_type=\"application/json\").maybe_follow()", "        self.project.reload()", "        assert_not_equal(self.project.logs[-1].action, \"github_file_added\")", ""]}, {"lines": ["        url = \"/api/v1/project/{0}/github/hook/\".format(self.project._id)"]}, {"lines": ["            url,"]}, {"lines": ["            content_type=\"application/json\").maybe_follow()", "        self.project.reload()", "        assert_not_equal(self.project.logs[-1].action, \"github_file_updated\")", ""]}, {"lines": ["        url = \"/api/v1/project/{0}/github/hook/\".format(self.project._id)"]}, {"lines": ["            url,"]}, {"lines": ["            content_type=\"application/json\").maybe_follow()", "        self.project.reload()", "        assert_not_equal(self.project.logs[-1].action, \"github_file_removed\")", ""]}, {"lines": ["    def setUp(self):", "", "        super(TestRegistrationsWithGithub, self).setUp()", "        self.project = ProjectFactory.build()", "        self.project.save()"]}, {"lines": [""]}, {"lines": ["        self.project.creator.add_addon('github')", "        self.node_settings = self.project.get_addon('github')", "        self.user_settings = self.project.creator.get_addon('github')", "        self.node_settings.user_settings = self.user_settings", "        self.node_settings.user = 'Queen'", "        self.node_settings.repo = 'Sheer-Heart-Attack'", "        self.node_settings.save()", ""]}, {"lines": ["        super(TestAuthViews, self).setUp()"]}, {"lines": ["        self.user.add_addon('github')", "        self.user.save()", "        self.user_settings = self.user.get_addon('github')", "", "    def test_oauth_callback_with_invalid_user(self):", "        url = api_url_for('github_oauth_callback', uid=\"\")", "        res = self.app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 404)", "", "    def test_oauth_callback_with_invalid_node(self):", "        url = api_url_for('github_oauth_callback', uid=self.user._id, nid=\"\")", "        res = self.app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 404)", "", "    def test_oauth_callback_without_github_enabled(self):", "        user2 = AuthUserFactory()", "        url = api_url_for('github_oauth_callback', uid=user2._id)", "        res = self.app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 400)"]}, {"lines": ["    def test_oauth_callback_with_no_code(self):", "        url = api_url_for('github_oauth_callback', uid=self.user._id)", "        res = self.app.get(url, expect_errors=True)", "        assert_equal(res.status_code, 400)"]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.user')", "    @mock.patch('website.addons.github.views.auth.oauth_get_token')", "    def test_oauth_callback_without_node(self, mock_get_token, mock_github_user):", "        mock_get_token.return_value = {"]}, {"lines": ["            \"access_token\": \"testing access token\","]}, {"lines": ["            \"token_type\": \"testing token type\",", "            \"scope\": [\"repo\"]", "        }", "        user = mock.Mock()", "        user.id = \"testing user id\"", "        user.login = \"testing user\"", "        mock_github_user.return_value = user", "", "        url = api_url_for('github_oauth_callback', uid=self.user._id)", "        res = self.app.get(url, {\"code\": \"12345\"}, auth=self.user.auth)"]}, {"lines": ["        self.user_settings.reload()"]}, {"lines": ["        assert_true(res.status_code, 302)", "        assert_in(\"/settings/addons/\", res.location)"]}, {"lines": ["        assert_true(self.user_settings.oauth_settings)", "        assert_equal(self.user_settings.oauth_access_token, \"testing access token\")", "        assert_equal(self.user_settings.oauth_token_type, \"testing token type\")", "        assert_equal(self.user_settings.github_user_name, \"testing user\")", "        assert_equal(self.user_settings.oauth_settings.github_user_id, \"testing user id\")"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.user')", "    @mock.patch('website.addons.github.views.auth.oauth_get_token')", "    def test_oauth_callback_with_node(self, mock_get_token, mock_github_user):", "        mock_get_token.return_value = {"]}, {"lines": ["            \"access_token\": \"testing access token\","]}, {"lines": ["            \"token_type\": \"testing token type\",", "            \"scope\": [\"repo\"]", "        }", "        user = mock.Mock()", "        user.id = \"testing user id\"", "        user.login = \"testing user\"", "        mock_github_user.return_value = user", "", "        project = ProjectFactory(creator=self.user)", "        project.add_addon('github', auth=Auth(user=self.user))", "        project.save()", "", "        url = api_url_for('github_oauth_callback', uid=self.user._id, nid=project._id)", "        res = self.app.get(url, {\"code\": \"12345\"}, auth=self.user.auth)"]}, {"lines": ["        self.user_settings.reload()", "", "        node_settings = project.get_addon('github')", "        node_settings.reload()"]}, {"lines": ["", "        assert_true(res.status_code, 302)", "        assert_not_in(\"/settings/addons/\", res.location)", "        assert_in(\"/settings\", res.location)"]}, {"lines": ["        assert_true(self.user_settings.oauth_settings)", "        assert_equal(self.user_settings.oauth_access_token, \"testing access token\")", "        assert_equal(self.user_settings.oauth_token_type, \"testing token type\")", "        assert_equal(self.user_settings.github_user_name, \"testing user\")", "        assert_equal(self.user_settings.oauth_settings.github_user_id, \"testing user id\")"]}, {"lines": ["        assert_equal(node_settings.user_settings, self.user_settings)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.user')", "    def test_create_and_attach_oauth(self, mock_github_user):", "        user = mock.Mock()", "        user.id = \"testing user id\"", "        user.login = \"testing user\"", "        mock_github_user.return_value = user"]}, {"lines": ["        views.auth.create_and_attach_oauth(self.user_settings, \"testing access token\", \"testing token type\")"]}, {"lines": ["        assert_true(self.user_settings.oauth_settings)", "        assert_false(self.user_settings.oauth_state)", "        assert_equal(", "            self.user_settings.github_user_name,", "            \"testing user\"", "        )", "        assert_equal(", "            self.user_settings.oauth_access_token,"]}, {"lines": ["            \"testing access token\""]}, {"lines": ["        )", "        assert_equal(", "            self.user_settings.oauth_token_type,", "            \"testing token type\"", "        )", "        assert_equal(", "            self.user_settings.oauth_settings.github_user_id,", "            \"testing user id\"", "        )", "", "    @mock.patch('website.addons.github.api.GitHub.user')"]}, {"lines": ["    @mock.patch('website.addons.github.api.GitHub.revoke_token')", "    def test_oauth_delete_user_one_osf_user(self, mock_revoke_token, mock_github_user):", "        mock_revoke_token.return_value = True"]}, {"lines": ["        user = mock.Mock()", "        user.id = \"testing user id\"", "        user.login = \"testing user\"", "        mock_github_user.return_value = user"]}, {"lines": ["        views.auth.create_and_attach_oauth(self.user_settings, \"testing access token\", \"testing token type\")"]}, {"lines": ["        url = api_url_for(\"github_oauth_delete_user\")", "        self.app.delete(url, auth=self.user.auth)"]}, {"lines": ["        self.user_settings.reload()"]}, {"lines": ["        assert_false(self.user_settings.oauth_token_type)", "        assert_false(self.user_settings.oauth_access_token)"]}, {"lines": ["        assert_false(self.user_settings.github_user_name)", "        assert_false(self.user_settings.oauth_settings)", "", "    @mock.patch('website.addons.github.api.GitHub.user')", "    @mock.patch('website.addons.github.api.GitHub.revoke_token')", "    def test_oauth_delete_user_two_osf_user(self, mock_revoke_token, mock_github_user):", "        mock_revoke_token.return_value = True", "        user = mock.Mock()", "        user.id = \"testing user id\"", "        user.login = \"testing user\"", "        mock_github_user.return_value = user", "        views.auth.create_and_attach_oauth(self.user_settings, \"testing acess token\", \"testing token type\")", "", "        user2 = AuthUserFactory()", "        user2.add_addon('github')", "        user2.save()", "        user_settings2 = user2.get_addon('github')", "        views.auth.create_and_attach_oauth(user_settings2, \"testing access token\", \"testing token type\")"]}, {"lines": [""]}, {"lines": ["        url = api_url_for(\"github_oauth_delete_user\")", "        self.app.delete(url, auth=self.user.auth)", "        self.user_settings.reload()", "        user_settings2.reload()", "        assert_false(self.user_settings.oauth_token_type)", "        assert_false(self.user_settings.oauth_access_token)", "        assert_false(self.user_settings.github_user_name)", "        assert_false(self.user_settings.oauth_settings)", "        assert_true(user_settings2.oauth_settings)", "        assert_equal(user_settings2.oauth_token_type, \"testing token type\")", "        assert_equal(user_settings2.oauth_access_token, \"testing access token\")", "        assert_equal(user_settings2.github_user_name, \"testing user\")"]}, {"lines": ["    def after_remove_contributor(self, node, removed, auth=None):"]}, {"lines": ["", "            # Delete OAuth tokens"]}, {"lines": ["            message = (", "                u'Because the Google Drive add-on for {category} \"{title}\" was '", "                u'authenticated by {user}, authentication information has been deleted.'", "            ).format(category=node.category_display, title=node.title, user=removed.fullname)"]}, {"lines": ["", "            if not auth or auth.user != removed:", "                url = node.web_url_for('node_setting')"]}, {"lines": ["                message += (", "                    u' You can re-authenticate on the <a href=\"{url}\">Settings</a> page.'", "                ).format(url=url)"]}, {"lines": ["            #", "            return message"]}, {"lines": ["            'folder': self.node.get_addon('googledrive', deleted=True).folder_path"]}, {"lines": ["    def test_after_remove_authorized_googledrive_user_not_self(self):"]}, {"lines": ["        assert_in(\"You can re-authenticate\", message)"]}, {"lines": ["    def test_after_remove_authorized_googledrive_user_self(self):", "        auth = Auth(user=self.user_settings.owner)", "        message = self.node_settings.after_remove_contributor(", "            self.project, self.user_settings.owner, auth)", "        self.node_settings.save()", "        assert_is_none(self.node_settings.user_settings)", "        assert_true(message)", "        assert_not_in(\"You can re-authenticate\", message)"]}, {"lines": ["    def get_versions(self, page, size):"]}, {"lines": ["<a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect\">"]}, {"lines": ["    {{ stripSlash(params.path) }}</a> to OSF Storage in"]}, {"lines": ["<span class=\"overflow log-folder\">{{ stripSlash(params.path) }}</span> in"]}, {"lines": ["<a class=\"overflow log-file-link\" data-bind=\"click: NodeActions.addonFileRedirect\">"]}, {"lines": ["    {{ stripSlash(params.path) }}</a> to OSF Storage in"]}, {"lines": ["      {{ stripSlash(params.path) }}</span> from OSF Storage in"]}, {"lines": ["    def after_remove_contributor(self, node, removed, auth=None):"]}, {"lines": ["            message = (", "                u'Because the Amazon Simple Storage add-on for {category} \"{title}\" was '", "                u'authenticated by {user}, authentication information has been deleted.'", "            ).format(category=node.category_display, title=node.title, user=removed.fullname)"]}, {"lines": [""]}, {"lines": ["            if not auth or auth.user != removed:"]}, {"lines": ["                url = node.web_url_for('node_setting')"]}, {"lines": ["                message += (", "                    u' You can re-authenticate on the <a href=\"{url}\">Settings</a> page.'", "                ).format(url=url)"]}, {"lines": ["            #", "            return message"]}, {"lines": ["<span class=\"overflow log-folder\">{{ stripSlash(params.path) }}</span> in"]}, {"lines": ["removed {{ pathType(params.path) }} <span class=\"overflow\">{{ stripSlash(params.path) }}</span> from"]}, {"lines": ["linked the Amazon S3 bucket /"]}, {"lines": ["<span data-bind=\"text: params.bucket\"></span> to"]}, {"lines": ["    def test_after_remove_contributor_self(self):", "        message = self.node_settings.after_remove_contributor(", "            self.project, self.project.creator, self.consolidated_auth"]}, {"lines": ["        assert_true(message)"]}, {"lines": ["        assert_not_in(\"You can re-authenticate\", message)"]}, {"lines": ["", "    def test_after_remove_contributor_not_self(self):", "        auth = Auth(user=self.non_authenticator)", "        message = self.node_settings.after_remove_contributor(", "            self.project, self.project.creator, auth", "        )", "        assert_equal(self.node_settings.user_settings, None)", "        assert_true(message)"]}, {"lines": ["        assert_in(\"You can re-authenticate\", message)"]}, {"lines": [""]}, {"lines": ["    <div class=\"modal-dialog\">", "        <div class=\"modal-content\">"]}, {"lines": ["                    <div class='form-group'>"]}, {"lines": ["                        <input id=\"data\" placeholder=\"New Wiki Name\" type=\"text\" class='form-control'>"]}, {"lines": ["                    </div>"]}, {"lines": ["        </div><!-- end modal- content -->"]}, {"lines": ["            % for child in toc:"]}, {"lines": ["                                </li>", "                            % endif", "                        % endfor", "                    </ul>"]}, {"lines": ["                </li>", "            % endfor"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class TestWikiRename(OsfTestCase):"]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        self.project = ProjectFactory(is_public=True)", "        api_key = ApiKeyFactory()", "        self.project.creator.api_keys.append(api_key)", "        self.project.creator.save()", "        self.consolidate_auth = Auth(user=self.project.creator, api_key=api_key)", "        self.auth = ('test', api_key._primary_key)", "        self.project.update_node_wiki('home', 'Hello world', self.consolidate_auth)"]}, {"lines": ["        self.wiki = self.project.get_wiki_page('home')"]}, {"lines": [""]}, {"lines": ["        self.project.reload()", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def test_rename_wiki_page_duplicate(self):", "        self.project.update_node_wiki('away', 'Hello world', self.consolidate_auth)"]}, {"lines": ["from framework.auth.core import get_user"]}, {"lines": ["    user = get_user(email=address)", "    if user:"]}, {"lines": ["    else:"]}, {"lines": ["import uuid"]}, {"lines": ["def new_private_link(name, user, nodes, anonymous):"]}, {"lines": ["    \"\"\"Create a new private link.", ""]}, {"lines": ["    :param str name: private link name"]}, {"lines": ["    :param User user: User object"]}, {"lines": ["    :param list Node node: a list of node object"]}, {"lines": ["    :param bool anonymous: make link anonymous or not"]}, {"lines": ["    :return PrivateLink: Created private link"]}, {"lines": ["", "    \"\"\""]}, {"lines": ["    key = str(uuid.uuid4()).replace(\"-\", \"\")"]}, {"lines": ["    if name:", "        name = sanitize(name.strip())", "    else:"]}, {"lines": ["        name = \"Shared project link\""]}, {"lines": ["", "    private_link = PrivateLink(", "        key=key,"]}, {"lines": ["        name=name,"]}, {"lines": ["        creator=user,"]}, {"lines": ["        nodes=nodes,", "        anonymous=anonymous"]}, {"lines": ["    )", "", "    private_link.save()", "", "    return private_link", "", ""]}, {"lines": ["    anonymous = has_anonymous_link(node, auth)"]}, {"lines": [""]}, {"lines": ["    if anonymous or not node.can_view(auth):"]}, {"lines": ["    anonymous = has_anonymous_link(node, auth)"]}, {"lines": ["", "    if anonymous or not node.can_view(auth):"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["import math", "from itertools import islice"]}, {"lines": ["from website.project import clean_template_name, new_node, new_private_link"]}, {"lines": ["from website.models import Node, Pointer, WatchConfig, PrivateLink"]}, {"lines": ["    if settings.DISK_SAVING_MODE:", "        raise HTTPError(", "            http.METHOD_NOT_ALLOWED,"]}, {"lines": ["        )"]}, {"lines": ["    if not (node.can_edit(auth) or node.is_public):", "        raise HTTPError(http.FORBIDDEN)"]}, {"lines": ["    prompt = node.callback('before_make_public')", "    anonymous_link_warning = any(private_link.anonymous for private_link in node.private_links_active)", "    if anonymous_link_warning:"]}, {"lines": ["        'prompts': prompt"]}, {"lines": ["@must_have_permission(WRITE)"]}, {"lines": ["    # in node.update() method there is a key list node.WRITABLE_WHITELIST only allow user to modify", "    # category, title, and discription which can be edited by write permission contributor"]}, {"lines": ["@must_have_permission(ADMIN)"]}, {"lines": ["def remove_private_link(*args, **kwargs):"]}, {"lines": ["    link_id = request.json['private_link_id']", ""]}, {"lines": ["    try:"]}, {"lines": ["        link = PrivateLink.load(link_id)", "        link.is_deleted = True", "        link.save()"]}, {"lines": ["    except ModularOdmException:"]}, {"lines": ["        raise HTTPError(http.NOT_FOUND)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    view_only_link = auth.private_key or request.args.get('view_only', '').strip('/')"]}, {"lines": ["    anonymous = has_anonymous_link(node, auth)"]}, {"lines": ["    redirect_url = node.url + '?view_only=None'"]}, {"lines": [""]}, {"lines": ["            'redirect_url': redirect_url,"]}, {"lines": ["            'private_links': [x.to_json() for x in node.private_links_active],"]}, {"lines": ["            'link': view_only_link,"]}, {"lines": ["            'anonymous': anonymous,"]}, {"lines": ["            'is_public': parent.is_public if parent else '',"]}, {"lines": ["            'is_contributor': parent.is_contributor(user) if parent else '',"]}, {"lines": ["            'can_view': parent.can_view(auth) if parent else False"]}, {"lines": ["                'is_public': child.is_public,"]}, {"lines": [""]}, {"lines": ["    data = {", "        'node': {", "            'absolute_url': node.absolute_url,"]}, {"lines": ["            'private_links': [x.to_json() for x in node.private_links_active],"]}, {"lines": ["    }", "    return data", ""]}, {"lines": ["    if not node.can_edit(auth):"]}, {"lines": ["    children = _get_children(node, auth)"]}, {"lines": ["    return {"]}, {"lines": ["        'children': children,"]}, {"lines": ["            'anonymous': has_anonymous_link(node, auth),"]}, {"lines": ["    \"\"\" creata a new private link object and add it to the node and its selected children\"\"\""]}, {"lines": [""]}, {"lines": ["    node_ids = request.json.get('node_ids', [])"]}, {"lines": ["    name = request.json.get('name', '')"]}, {"lines": ["    anonymous = request.json.get('anonymous', False)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    nodes = [Node.load(node_id) for node_id in node_ids]"]}, {"lines": [""]}, {"lines": ["    has_public_node = any(node.is_public for node in nodes)"]}, {"lines": [""]}, {"lines": ["    new_link = new_private_link("]}, {"lines": ["        name=name, user=auth.user, nodes=nodes, anonymous=anonymous"]}, {"lines": ["    )"]}, {"lines": [""]}, {"lines": ["    if anonymous and has_public_node:"]}, {"lines": ["        status.push_status_message("]}, {"lines": [""]}, {"lines": ["    return new_link"]}, {"lines": ["", ""]}, {"lines": ["def project_private_link_edit(auth, **kwargs):", "    new_name = request.json.get('value', '')"]}, {"lines": ["    private_link = PrivateLink.load(private_link_id)"]}, {"lines": ["    if private_link:", "        private_link.name = new_name", "        private_link.save()", ""]}, {"lines": [""]}, {"lines": ["    page = request.json.get('page', 0)"]}, {"lines": ["", "    start = (page * size)"]}, {"lines": ["    nodes = Node.find(odm_query)", "    count = nodes.count()", "    pages = math.ceil(count / size)"]}, {"lines": ["            for each in islice(nodes, start, start + size)"]}, {"lines": ["        ],", "        'total': count,", "        'pages': pages,", "        'page': page"]}, {"lines": ["USE_CELERY = True"]}, {"lines": ["            var nodeId = $(this).attr('node-id');", "            var apiUrl = $(this).attr('api-url')+ addonShortName + '/config/';", "            bootbox.confirm({", "                title: 'Remove addon?',", "                message: 'Are you sure you want to remove the ' + addonFullname + ' authorization from this project?',", "                callback: function (confirm) {", "                    if (confirm) {", "                        $.ajax({", "                            type: 'DELETE',", "                            url: apiUrl,"]}, {"lines": ["                            success: function (response) {"]}, {"lines": ["                                if (numNodes === 1) {"]}, {"lines": ["                                }", "                                if (numNodes === 4) {"]}, {"lines": ["                                }", "                            },"]}, {"lines": ["                            error: function () {", "                                $osf.growl('An error occurred, the project has not been deauthorized. ',", "                                    'If the issue persists, please report it to <a href=\"mailto:support@osf.io\">support@osf.io</a>.');", "                            }", "                        });", "                    }"]}, {"lines": ["            });"]}, {"lines": ["/**", " * ViewModel mixin for displaying form input help messages.", " * Adds message and messageClass observables that can be changed with the", " * changeMessage method.", " */"]}, {"lines": ["'use strict';", "var ko = require('knockout');", "var oop = require('js/oop');", "/** Change the flashed status message */", ""]}, {"lines": ["    constructor: function() {", "        this.message = ko.observable('');", "        this.messageClass = ko.observable('text-info');", "    },", "    changeMessage: function(text, css, timeout) {", "        var self = this;", "        if (typeof text === 'function') {", "            text = text();", "        }", "        self.message(text);", "        var cssClass = css || 'text-info';", "        self.messageClass(cssClass);", "        if (timeout) {", "            // Reset message after timeout period"]}, {"lines": ["                self.message('');", "                self.messageClass('text-info');", "            }, timeout);", "        }"]}, {"lines": ["    }", "});", ""]}, {"lines": ["var NODE_OFFSET = 25;"]}, {"lines": ["function Contributor(data) {", "    $.extend(this, data);", "    if (data.n_projects_in_common === 1) {", "        this.displayProjectsInCommon = data.n_projects_in_common + ' project in common';", "    } else if (data.n_projects_in_common !== 0) {", "        this.displayProjectsInCommon = data.n_projects_in_common + ' projects in common';", "    } else {", "        this.displayProjectsInCommon = '';", "    }", "}", ""]}, {"lines": ["        this.super.constructor.call(this);"]}, {"lines": ["        var self = this;", ""]}, {"lines": ["        self.title = title;", "        self.parentId = parentId;", "        self.parentTitle = parentTitle;", ""]}, {"lines": ["        self.page = ko.observable('whom');", "        self.pageTitle = ko.computed(function() {", "            return {", "                whom: 'Add Contributors',", "                which: 'Select Components',", "                invite: 'Add Unregistered Contributor'", "            }[self.page()];", "        });", "        self.query = ko.observable();", "        self.results = ko.observableArray([]);", "        self.selection = ko.observableArray();", "        self.notification = ko.observable('');", "        self.inviteError = ko.observable('');"]}, {"lines": ["        self.totalPages = ko.observable(0);"]}, {"lines": ["        self.nodes = ko.observableArray([]);", "        self.nodesToChange = ko.observableArray();", "        $.getJSON("]}, {"lines": ["            function(result) {", "                $.each(result.children || [], function(idx, child) {", "                    child.margin = NODE_OFFSET + child.indent * NODE_OFFSET + 'px';", "                });", "                self.nodes(result.children);", "            }", "        );"]}, {"lines": ["        self.foundResults = ko.pureComputed(function() {"]}, {"lines": ["            return self.query() && self.results().length;", "        });"]}, {"lines": ["        self.noResults = ko.pureComputed(function() {"]}, {"lines": ["            return self.query() && !self.results().length;", "        });"]}, {"lines": ["        self.inviteName = ko.observable();", "        self.inviteEmail = ko.observable();"]}, {"lines": ["        self.addingSummary = ko.computed(function() {", "            var names = $.map(self.selection(), function(result) {", "                return result.fullname;"]}, {"lines": ["        });"]}, {"lines": ["    },"]}, {"lines": ["        this.page('whom');"]}, {"lines": ["    },"]}, {"lines": ["        this.page('which');"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["        this.page(page);"]}, {"lines": ["    },"]}, {"lines": ["        this.currentPage(0);"]}, {"lines": ["        this.fetchResults();"]}, {"lines": ["    },"]}, {"lines": ["    fetchResults: function() {"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["        return self.postInviteRequest(self.inviteName(), self.inviteEmail());"]}, {"lines": ["    },"]}, {"lines": ["        this.selection.push(data);"]}, {"lines": ["    },"]}, {"lines": ["        this.selection.splice(", "            this.selection.indexOf(data), 1"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;", "        $.each(self.results(), function(idx, result) {", "            if (self.selection().indexOf(result) === -1) {", "                self.add(result);"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;", "        $.each(self.selection(), function(idx, selected) {", "            self.remove(selected);"]}, {"lines": ["    },"]}, {"lines": ["        return this.nodesToChange().length === this.nodes().length;"]}, {"lines": ["    },"]}, {"lines": ["        return this.nodesToChange().length === 0;"]}, {"lines": ["    },"]}, {"lines": ["        this.nodesToChange($osf.mapByProperty(this.nodes(), 'id'));"]}, {"lines": ["    },"]}, {"lines": ["        this.nodesToChange([]);"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;", "        for (var idx = 0; idx < self.selection().length; idx++) {", "            if (data.id === self.selection()[idx].id) {"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;"]}, {"lines": ["        ).done(", "            self.onInviteSuccess.bind(self)", "        ).fail(", "            self.onInviteError.bind(self)", "        );"]}, {"lines": ["    },"]}, {"lines": ["        var self = this;", "        self.query('');", "        self.results([]);", "        self.page('whom');", "        self.add(result.contributor);"]}, {"lines": ["    },"]}, {"lines": ["        var response = JSON.parse(xhr.responseText);", "        // Update error message", "        this.inviteError(response.message);", "    }"]}, {"lines": ["});"]}, {"lines": ["        itemID = parseInt(closestTarget.attr('data-id')),"]}, {"lines": ["var DEFAULT_ERROR_MESSAGE = 'Could not upload file. The file may be invalid ' +", "    'or the file folder has been deleted.';"]}, {"lines": ["    constructor: function(title, message, type) {"]}, {"lines": ["        this.type = type || 'danger';"]}, {"lines": ["    show: function() {"]}, {"lines": ["var $osf = require('js/osfHelpers');"]}, {"lines": ["            inputLabel.css( 'visibility', 'visible' );"]}, {"lines": ["            inputLabel.css( 'visibility', 'hidden' );"]}, {"lines": ["    inputDom.attr('placeholder', ''); //Clear the original placeholder"]}, {"lines": [""]}, {"lines": ["    if($osf.isIE()){"]}, {"lines": ["var Paginator = require('js/paginator');"]}, {"lines": ["var oop = require('js/oop');"]}, {"lines": ["var AddPointerViewModel = oop.extend(Paginator, {"]}, {"lines": ["        this.super.constructor.call(this);"]}, {"lines": ["        this.foundResults = ko.pureComputed(function() {"]}, {"lines": ["        this.noResults = ko.pureComputed(function() {"]}, {"lines": ["    },"]}, {"lines": ["        this.fetchResults();"]}, {"lines": ["    },"]}, {"lines": ["        this.fetchResults();"]}, {"lines": ["    },"]}, {"lines": ["    fetchResults: function() {"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["    },"]}, {"lines": ["});"]}, {"lines": ["                dataType: 'json'"]}, {"lines": ["    };"]}, {"lines": ["    };", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        };"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                new LogFeed('#logs-' + nodeId, response.logs);"]}, {"lines": [""]}, {"lines": ["var preRegisterMessage =  function(title, parentTitle, parentUrl, category) {"]}, {"lines": ["    if (parentUrl) {"]}, {"lines": ["        return 'You are about to register the ' + category + ' <b>' + title +"]}, {"lines": ["    } else {"]}, {"lines": ["    }"]}, {"lines": ["", "        event.preventDefault();", "        var title = node.title;", "        var parentTitle = node.parentTitle;", "        var parentRegisterUrl = node.parentRegisterUrl;"]}, {"lines": ["        var category = node.category;"]}, {"lines": ["        if (node.category !== 'project'){", "            category = 'component';"]}, {"lines": ["        }", "", "        bootbox.confirm({", "            title: bootboxTitle,", "            message: preRegisterMessage(title, parentTitle, parentRegisterUrl, category),"]}, {"lines": ["            callback: function (confirmed) {", "                if(confirmed) {", "                    window.location.href = target;", "                }"]}, {"lines": ["            }", "        });"]}, {"lines": ["        //in order to make the href redirect work under knockout onclick binding", "        return true;"]}, {"lines": ["var LogFeed = require('js/logFeed');"]}, {"lines": ["var ensureUserTimezone = function(savedTimezone, savedLocale, id) {"]}, {"lines": ["                'locale': clientLocale,", "                'id': id"]}, {"lines": ["        ensureUserTimezone(data.timezone, data.locale, data.id);"]}, {"lines": ["});"]}, {"lines": ["// Initialize logfeed", "new LogFeed('#logScope', '/api/v1/watched/logs/');"]}, {"lines": [""]}, {"lines": ["            <div class='col-sm-2 hidden-xs'>"]}, {"lines": ["                <img class=\"logo\" src=\"/static/img/circle_logo.png\">"]}, {"lines": ["                    <a data-bind=\"click: trackClick.bind($data, 'Create Account')\" class=\"btn btn-primary\" href=\"${web_url_for('index')}#signUp\">Create an Account</a>", "", "                    <a data-bind=\"click: trackClick.bind($data, 'Learn More')\" class=\"btn btn-primary\" href=\"/getting-started/\">Learn More</a>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle, attr: {href: nodeUrl}\"></a>"]}, {"lines": ["<script type=\"text/html\" id=\"node_removed\">"]}, {"lines": ["</script>", ""]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a> public"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a> private"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["changed the title from <span class=\"overflow\" data-bind=\"text: params.title_original\"></span>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}, text: nodeTitle\"></a>"]}, {"lines": ["<a data-bind=\"attr.href: 'http://ezid.cdlib.org/id/doi:' + params.identifiers.doi, text: 'ark:' + params.identifiers.ark\"></a>"]}, {"lines": ["                        <span data-bind=\"if: author.id\">", "                            <a class=\"comment-author\" data-bind=\"text: author.name, attr: {href: author.url}\"></a>", "                        </span>", "                        <span data-bind=\"ifnot: author.id\">", "                            <span class=\"comment-author\" data-bind=\"text: author.name\"></span>", "                        </span>"]}, {"lines": ["                                    <td><a data-bind=\"click: $parent.resendConfirmation\">resend&nbsp;confirmation</a></td>"]}, {"lines": ["                                            <input type=\"submit\" value=\"Add Email\" class=\"btn btn-default\">"]}, {"lines": ["                                        <div class=\"help-block\">", "                                            <p data-bind=\"html: message, attr: {class: messageClass}\"></p>", "                                        </div>"]}, {"lines": [""]}, {"lines": ["    <% import json %>", "    % if 'write' in user['permissions'] and not node['is_registration']:"]}, {"lines": ["        window.contextVars.diskSavingMode = !${json.dumps(disk_saving_mode)};"]}, {"lines": ["                                        <i class=\"fa fa-question-circle permission-info\""]}, {"lines": ["                                <div data-bind=\"style:{marginLeft: margin}\">"]}, {"lines": ["                            % if node['points'] > 0:", "                                <a class=\"btn btn-primary pull-right\"", "                                   href=\"#showLinks\"", "                                   data-toggle=\"modal\"", "                                   data-dismiss=\"modal\"", "                                >", "                                    ${ node['points'] }", "                                </a>", "                            % else:", "                                 <span class=\"well well-inline pull-right\">", "                                    ${ node['points'] }", "                                </span>", "                            % endif"]}, {"lines": ["                        % if not disk_saving_mode:", "                            ${ language.FORK_DESCRIPTION }", "                        % else:", "                            ${ language.DISK_SAVING_MODE}", "                        % endif"]}, {"lines": [""]}, {"lines": ["                        % if not disk_saving_mode:", "                            <a class=\"btn btn-primary form-control${ '' if user_name and (user['is_contributor'] or node['is_public']) else ' disabled'}\"", "                               data-dismiss=\"modal\"", "                               onclick=\"NodeActions.forkNode();\"", "                            >", "                                ${ language.FORK_ACTION }", "                            </a>", "                        % endif"]}, {"lines": [""]}, {"lines": ["            parentRegisterUrl: '${parent_registration_url}',"]}, {"lines": ["                var urlparse = window.location.href.split(\"?\");"]}, {"lines": ["                window.location.href = urlparse.join(\"?\")"]}, {"lines": [""]}, {"lines": ["                <ul class=\"nav nav-stacked nav-pills\">"]}, {"lines": ["                </ul>"]}, {"lines": ["        % endif"]}, {"lines": [""]}, {"lines": ["                    </div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["                    </div>"]}, {"lines": ["                        % endfor"]}, {"lines": ["                    </div>"]}, {"lines": ["            % endif"]}, {"lines": [""]}, {"lines": ["            <h6 class=\"text-center text-muted text-300\"><a href=\"${ web_url_for('index') }\">Back to OSF</a></h6>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        % if not summary['anonymous']:"]}, {"lines": ["        % else:"]}, {"lines": ["         <div>Anonymous Contributors</div>"]}, {"lines": ["        % endif"]}, {"lines": ["        % if not summary['anonymous']:"]}, {"lines": ["            </div>"]}, {"lines": ["        % endif"]}, {"lines": ["            <div id=\"logs-${summary['id']}\" class=\"log-container\" data-uri=\"${summary['api_url']}log/\">"]}, {"lines": ["                    <dt><span class=\"date log-date\" data-bind=\"text: log.date.local, tooltip: {title: log.date.utc}\"></span></dt>"]}, {"lines": ["                </dl><!-- end foreach logs -->", "            </div>"]}, {"lines": ["         </div>"]}, {"lines": ["% if user_is_claimed:"]}, {"lines": ["    >${user_display_name}</a>", "% else:"]}], "name": "Nan Chen"}, {"commits": [{"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-", "\"\"\"Script to migrate users with a valid date_last_login but no date_confirmed.\"\"\"", "", "import sys", "import logging", "", "from website.app import init_app", "from website.models import User", "from scripts import utils as script_utils", "from tests.base import OsfTestCase", "from tests.factories import UserFactory", "from modularodm import Q", "import datetime as dt", "", "logger = logging.getLogger(__name__)", "", "def do_migration(records):", "    for user in records:"]}, {"lines": ["        user.date_confirmed = user.date_last_login", "        if not user.is_registered:", "            user.is_registered = True"]}, {"lines": ["", "def get_targets():", "    return User.find(Q('date_confirmed', 'eq', None) & Q('date_last_login', 'ne', None))", ""]}, {"lines": ["def main():", "    init_app(routes=False)  # Sets the storage backends on all models", "    if 'dry' in sys.argv:"]}, {"lines": ["    else:", "        do_migration(get_targets())", "", "class TestMigrateNodeCategories(OsfTestCase):", "", "    def test_get_targets(self):"]}, {"lines": ["", "    def test_do_migration(self):", "        today = dt.datetime.utcnow()", "        user1 = UserFactory.build(date_confirmed=None, date_last_login=today, is_registered=False)", "        user2 = UserFactory.build(date_confirmed=None, date_last_login=today, is_registered=True)", "        user1.save()", "        user2.save()"]}, {"lines": ["        user_list = User.find(Q('_id', 'eq', user1._id) | Q('_id', 'eq', user2._id))", "        do_migration(user_list)", "", "        assert user1.date_confirmed is today", "        assert user1.is_registered", "        assert user2.date_confirmed is today", "        assert user2.is_registered", "", "", "if __name__ == '__main__':"]}, {"lines": ["    main()"]}, {"lines": ["class UnmockedError(Exception):"]}, {"lines": ["    def __init__(self, message='No requests mocking exists, \\", "real connections are not allowed.'):", "        super(UnmockedError, self).__init__(message)"]}, {"lines": ["# -*- coding: utf-8 -*-"]}, {"lines": ["from box import BoxClient"]}, {"lines": [""]}, {"lines": ["", "def get_client(user):"]}, {"lines": ["    \"\"\"Return a :class:`boxview.boxview.BoxView`, using a user's"]}, {"lines": ["    access token.", "", "    :param User user: The user.", "    :raises: AddonError if user does not have the Box addon enabled.", "    \"\"\"", "    user_settings = user.get_addon('box')", "    if not user_settings:", "        raise AddonError('User does not have the Box addon enabled.')"]}, {"lines": ["    return get_client_from_user_settings(user_settings)"]}, {"lines": ["", "", "def get_client_from_user_settings(settings_obj):", "    \"\"\"Same as get client, except its argument is a BoxUserSettingsObject.\"\"\""]}, {"lines": ["    if settings_obj.has_auth:"]}, {"lines": ["        return BoxClient(settings_obj.get_credentialsv2())", "    raise AddonError('Box credentials for this user have expired.')"]}, {"lines": ["", "", "def get_node_client(node):", "    node_settings = node.get_addon('box')", "    return get_node_addon_client(node_settings)", "", "", "def get_node_addon_client(node_addon):", "    if node_addon:", "        if node_addon.has_auth:", "            return get_client_from_user_settings(node_addon.user_settings)", "        else:", "            raise AddonError('Node is not authorized')", "    raise AddonError('Node does not have the Box addon enabled.')"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Box addon routes.\"\"\"", "from framework.routing import Rule, json_renderer", "", "from website.addons.box import views"]}, {"lines": ["", "", "auth_routes = {", "    'rules': [", ""]}, {"lines": ["        ##### OAuth #####"]}, {"lines": ["        Rule("]}, {"lines": ["            'get',", "            views.auth.box_oauth_start,  # Use same view func as node oauth start", "            json_renderer,", "            endpoint_suffix='_user'          # but add a suffix for url_for", "        ),", "", "        Rule("]}, {"lines": ["            'get',", "            views.auth.box_oauth_finish,", "            json_renderer,", "        ),", "", "        Rule("]}, {"lines": ["            'delete',", "            views.auth.box_oauth_delete_user,", "            json_renderer,", "        ),"]}, {"lines": [""]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["            ],", "            'get',", "            views.auth.box_oauth_start,", "            json_renderer,", "        ),"]}, {"lines": [""]}, {"lines": ["        ##### Node settings #####", "", "        Rule(", "            ['/project/<pid>/box/config/',", "            '/project/<pid>/node/<nid>/box/config/'],", "            'get',", "            views.config.box_config_get,", "            json_renderer", "        ),", "", "        Rule(", "            ['/project/<pid>/box/config/',", "            '/project/<pid>/node/<nid>/box/config/'],", "            'put',", "            views.config.box_config_put,", "            json_renderer", "        ),", "        Rule(", "            ['/project/<pid>/box/config/',", "            '/project/<pid>/node/<nid>/box/config/'],", "            'delete',", "            views.config.box_deauthorize,", "            json_renderer", "        ),", "", "        Rule(", "            ['/project/<pid>/box/config/import-auth/',", "            '/project/<pid>/node/<nid>/box/config/import-auth/'],", "            'put',", "            views.config.box_import_user_auth,", "            json_renderer", "        ),", ""]}, {"lines": ["        Rule(", "            ['/project/<pid>/box/config/share/',", "            '/project/<pid>/node/<nid>/box/config/share/'],", "            'get',", "            views.config.box_get_share_emails,", "            json_renderer", "        ),", ""]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["            ],", "            'get',"]}, {"lines": ["            json_renderer", "        ),", "    ],", "    'prefix': '/api/v1'", "}"]}, {"lines": ["import logging", "from .defaults import *  # noqa", ""]}, {"lines": ["try:", "    from .local import *  # noqa", "except ImportError as error:"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Example Box local settings file. Copy this file to local.py and change", "these settings.", "\"\"\"", "# Get an app key and secret at https://www.box.com/developers/apps"]}, {"lines": ["BOX_KEY = None", "BOX_SECRET = None"]}, {"lines": [""]}, {"lines": ["", "function _fangornLazyLoadError (item) {"]}, {"lines": ["    return true;", "}", "", "Fangorn.config.box = {"]}, {"lines": ["    lazyLoadError : _fangornLazyLoadError", "};"]}, {"lines": ["/**", "* View model that controls the Box configuration on the user settings page.", "*/", "'use strict';", "var ko = require('knockout');"]}, {"lines": ["ko.punches.enableAll();", "var $ = require('jquery');", "var Raven = require('raven-js');", "var bootbox = require('bootbox');", ""]}, {"lines": ["function ViewModel(url) {", "    var self = this;", "    self.userHasAuth = ko.observable(false);", "    // Whether the auth token is valid", "    self.validCredentials = ko.observable(true);", "    self.boxName = ko.observable();", "    self.urls = ko.observable({});", "    // Whether the initial data has been loaded.", "    self.loaded = ko.observable(false);", "    self.nNodesAuthorized = 0;", "    // Update above observables with data from server", "    $.ajax({", "        url: url, type: 'GET', dataType: 'json',", "        success: function(response) {", "            var data = response.result;", "            self.userHasAuth(data.userHasAuth);", "            self.boxName(data.boxName);", "            self.urls(data.urls);", "            self.loaded(true);", "            self.validCredentials(data.validCredentials);", "            self.nNodesAuthorized = data.nNodesAuthorized;", "            if (!self.validCredentials()) {", "                self.changeMessage('Could not retrieve Box settings at ' +", "                    'this time. The Box addon credentials may no longer be valid.' +", "                    ' Try deauthorizing and reauthorizing Box.',", "                    'text-warning');", "            } else if (self.userHasAuth() && self.nNodesAuthorized === 0) {", "                self.changeMessage('Add-on successfully authorized. To link this add-on to an OSF project, ' +", "                    'go to the settings page of the project, enable Box, and choose content to connect.',", "                    'text-success');", "            }", "        },", "        error: function(xhr, textStatus, error){", "            self.changeMessage('Could not retrieve settings. Please refresh the page or ' +", "                'contact <a href=\"mailto: support@osf.io\">support@osf.io</a> if the ' +", "                'problem persists.', 'text-warning');", "            Raven.captureMessage('Could not GET Box settings', {", "                url: url,", "                textStatus: textStatus,", "                error: error", "            });", "        }", "    });", "    // Flashed messages", "    self.message = ko.observable('');", "    self.messageClass = ko.observable('text-info');", "", "    /** Send DELETE request to deauthorize Box */", "    function sendDeauth() {", "        return $.ajax({", "            url: self.urls().delete,", "            type: 'DELETE',", "            success: function() {", "                // Page must be refreshed to remove the list of authorized nodes", "                window.location.reload();", "            },", "            error: function(textStatus, error) {", "                self.changeMessage(language.deauthError, 'text-danger');", "                Raven.captureMessage('Could not deauthorize Box.', {", "                    url: url,", "                    textStatus: textStatus,", "                    error: error", "                });", "            }", "        });", "    }", "", "    /** Change the flashed status message */", "    self.changeMessage = function(text, css, timeout) {", "        self.message(text);", "        var cssClass = css || 'text-info';", "        self.messageClass(cssClass);", "        if (timeout) {", "            // Reset message after timeout period", "            setTimeout(function() {", "                self.message('');", "                self.messageClass('text-info');", "            }, timeout);", "        }", "    };", "", "    /** Pop up confirm dialog for deleting user's access token. */", "    self.deleteKey = function() {", "        bootbox.confirm({", "            title: 'Delete Box Token?',", "            message: language.confirmDeauth,", "            callback: function(confirmed) {", "                if (confirmed) {", "                    sendDeauth();", "                }", "            }", "        });", "    };", "}", "", "function BoxUserConfig(selector, url) {", "    var self = this;", "    self.selector = selector;", "    self.url = url;", "    // On success, instantiate and bind the ViewModel", "    self.viewModel = new ViewModel(url);", "    osfHelpers.applyBindings(self.viewModel, selector);", "}", "module.exports = BoxUserConfig;"]}, {"lines": [""]}, {"lines": ["var url = window.contextVars.node.urls.api + 'box/config/';"]}, {"lines": ["## Template for the \"Box\" section in the \"Configure Add-ons\" panel", "<div id='boxAddonScope' class='addon-settings scripted'>", "", "    <h4 class=\"addon-title\">", "        Box", "        <!-- Delete Access Token Button -->", "        <small class=\"authorized-by\">", "            <span data-bind=\"if: userHasAuth() && loaded()\">", "                    authorized", "                    <span data-bind=\"if: boxName()\">by {{ boxName }}</span>", "                    <a data-bind=\"click: deleteKey\" class=\"text-danger pull-right addon-auth\">Delete Access Token</a>", "            </span>", "", "            <!-- Create Access Token Button -->", "            <span data-bind=\"if: !userHasAuth() && loaded()\">", "                <a data-bind=\"attr: {href: urls().create}\"", "                   class=\"text-primary pull-right addon-auth\">Create Access Token</a>", "            </span>", "        </small>", "    </h4>", "", "    <!-- Flashed Messages -->", "    <div class=\"help-block\">", "        <p data-bind=\"html: message, attr: {class: messageClass}\"></p>", "    </div>", "", "<%include file=\"profile/addon_permissions.mako\" />"]}, {"lines": ["# -*- coding: utf-8 -*-", "", "from nose.tools import *  # noqa (PEP8 asserts)"]}, {"lines": ["from box import BoxClient", "from datetime import datetime"]}, {"lines": ["", "from tests.base import OsfTestCase", "from tests.factories import UserFactory", "", "from website.addons.base.exceptions import AddonError", "from website.addons.box.model import BoxUserSettings", "from website.addons.box.tests.factories import ("]}, {"lines": ["    BoxNodeSettingsFactory,"]}, {"lines": [")", "from website.addons.box.client import (", "    get_client, get_node_addon_client, get_node_client,", "    get_client_from_user_settings", ")", "", "", "class TestCore(OsfTestCase):", "", "    def setUp(self):", "", "        super(TestCore, self).setUp()", "", "        self.user = UserFactory()", "        self.user.add_addon('box')", "        self.user.save()", "", "        self.settings = self.user.get_addon('box')"]}, {"lines": ["        self.settings.save()", "", "    def test_get_addon_returns_box_user_settings(self):", "        result = self.user.get_addon('box')", "        assert_true(isinstance(result, BoxUserSettings))", "", "", "class TestClientHelpers(OsfTestCase):", "", "    def setUp(self):", "", "        super(TestClientHelpers, self).setUp()", "", "        self.user_settings = BoxUserSettingsFactory()"]}, {"lines": ["        self.user = self.user_settings.owner", "        self.node = self.node_settings.owner", "", "    def test_get_client_returns_a_box_client(self):", "        client = get_client(self.user)"]}, {"lines": ["        assert_true(isinstance(client, BoxClient))"]}, {"lines": ["", "    def test_get_client_raises_addon_error_if_user_doesnt_have_addon_enabled(self):", "        user_no_box = UserFactory()", "        with assert_raises(AddonError):", "            get_client(user_no_box)", "", "    def test_get_node_addon_client(self):", "        client = get_node_addon_client(self.node_settings)"]}, {"lines": ["        assert_true(isinstance(client, BoxClient))"]}, {"lines": ["", "    def test_get_node_client(self):", "        client = get_node_client(self.node)"]}, {"lines": ["        assert_true(isinstance(client, BoxClient))"]}, {"lines": ["", "    def test_get_client_from_user_settings(self):", "        client = get_client_from_user_settings(self.user_settings)"]}, {"lines": ["        assert_true(isinstance(client, BoxClient))"]}, {"lines": ["# -*- coding: utf-8 -*-", "\"\"\"Tests for website.addons.box.utils.\"\"\""]}, {"lines": ["", "from nose.tools import *  # noqa (PEP8 asserts)"]}, {"lines": ["", "from framework.auth import Auth", "from website.project.model import NodeLog", "", "from tests.base import OsfTestCase", "from tests.factories import ProjectFactory", "", "from website.addons.box.tests.factories import BoxFileFactory", "from website.addons.box.tests.utils import BoxAddonTestCase, mock_responses", "from website.addons.box import utils", "from website.addons.box.views.config import serialize_folder"]}, {"lines": ["", "", "class TestNodeLogger(BoxAddonTestCase):", "", "    def test_log_file_added(self):", "        df = BoxFileFactory()", "        logger = utils.BoxNodeLogger(", "            node=self.project,", "            auth=Auth(self.user),", "            file_obj=df", "        )", "        logger.log(NodeLog.FILE_ADDED, save=True)", "", "        last_log = self.project.logs[-1]", "", "        assert_equal(last_log.action, \"box_{0}\".format(NodeLog.FILE_ADDED))", "", "    # Regression test for https://github.com/CenterForOpenScience/osf.io/issues/1557", "    def test_log_deauthorized_when_node_settings_are_deleted(self):", "        project = ProjectFactory()", "        project.add_addon('box', auth=Auth(project.creator))", "        dbox_settings = project.get_addon('box')", "        dbox_settings.delete(save=True)", "        # sanity check", "        assert_true(dbox_settings.deleted)", "", "        logger = utils.BoxNodeLogger(node=project, auth=Auth(self.user))", "        logger.log(action='node_deauthorized', save=True)", "", "        last_log = project.logs[-1]", "        assert_equal(last_log.action, 'box_node_deauthorized')", "", ""]}, {"lines": ["# FIXME(sloria): This test is incorrect. The mocking needs work.", "# class TestRenderFile(OsfTestCase):", "", "#     @mock.patch('website.addons.box.client.BoxClient.get_file_and_metadata')", "#     def test_render_box_file_when_file_has_taken_down_by_dmca(self, mock_get_file):", "#         mock_resp = mock.Mock(spec=BoxResponse)", "#         mock_resp.reason = 'This file is no longer available due to a takedown request under the Digital Millennium Copyright Act'", "#         mock_resp.status = 461", "#         mock_client = mock.Mock(spec=BoxClient)", "#         mock_client.get_file_and_metadata.side_effect = ErrorResponse(mock_resp, 'DMCA takedown')", "#         with patch_client('website.addons.box.utils.get_node_addon_client', mock_client=mock_client):", "#             f = BoxFileFactory()", "#             result = utils.render_box_file(f, client=mock_client)", "", ""]}, {"lines": ["# TODO(mfraezz): Add support for folder sharing urls", "# def test_get_share_folder_uri():", "#     expected = 'https://box.com/home/foo?shareoptions=1&share_subfolder=0&share=1'", "#     assert_equal(utils.get_share_folder_uri('/foo/'), expected)", "#     assert_equal(utils.get_share_folder_uri('foo'), expected)"]}, {"lines": ["", "", "def test_serialize_folder():", "    metadata = {", "        u'bytes': 0,", "        u'icon': u'folder',", "        u'is_dir': True,", "        u'modified': u'Sat, 22 Mar 2014 05:40:29 +0000',", "        u'path': u'/datasets/New Folder',", "        u'rev': u'3fed51f002c12fc',", "        u'revision': 67032351,", "        u'root': u'box',", "        u'size': u'0 bytes',", "        u'thumb_exists': False", "    }", "    result = serialize_folder(metadata)", "    assert_equal(result['path'], metadata['path'])", "    assert_equal(result['name'], 'Box' + metadata['path'])"]}, {"lines": ["# -*- coding: utf-8 -*-", "from nose.tools import *  # noqa (PEP8 asserts)", "", "from website.util import api_url_for, web_url_for", "from tests.base import OsfTestCase", "from tests.factories import AuthUserFactory", ""]}, {"lines": ["", "class TestBoxIntegration(OsfTestCase):", "", "    def setUp(self):", "        super(TestBoxIntegration, self).setUp()", "        self.user = AuthUserFactory()", "        # User is logged in", "        self.app.authenticate(*self.user.auth)", "", "    def test_cant_start_oauth_if_already_authorized(self):", "        # User already has box authorized", "        self.user.add_addon('box')", "        self.user.save()", "        settings = self.user.get_addon('box')"]}, {"lines": ["        settings.save()"]}, {"lines": ["        assert_true(self.user.get_addon('box').has_auth)", "        # Tries to start oauth again", "        url = api_url_for('box_oauth_start_user')", "        res = self.app.get(url).follow()", "", "        # Is redirected back to settings page", "        assert_equal(", "            res.request.path,", "            web_url_for('user_addons')", "        )"]}, {"lines": ["\"\"\"Views fo the node settings page.\"\"\"", "# -*- coding: utf-8 -*-"]}, {"lines": ["import httplib as http", "", "from flask import request"]}, {"lines": ["", "from framework.exceptions import HTTPError"]}, {"lines": [""]}, {"lines": ["from website.project.decorators import (", "    must_have_addon, must_be_addon_authorizer,", "    must_have_permission, must_not_be_registration,"]}, {"lines": [")"]}, {"lines": [""]}, {"lines": ["from website.addons.box.client import get_client_from_user_settings"]}, {"lines": [""]}, {"lines": ["@must_have_addon('box', 'node')"]}, {"lines": ["def box_config_get(node_addon, auth, **kwargs):", "    \"\"\"API that returns the serialized node settings.\"\"\"", "    return {", "        'result': serialize_settings(node_addon, auth.user),"]}, {"lines": ["", "", "def serialize_folder(metadata):", "    \"\"\"Serializes metadata to a dict with the display name and path", "    of the folder.", "    \"\"\"", "    # if path is root", "    if metadata['path'] == '' or metadata['path'] == '/':"]}, {"lines": ["    else:", "        name = 'Box' + metadata['path']", "    return {", "        'name': name,"]}, {"lines": ["    }", "", "", "def get_folders(client):", "    \"\"\"Gets a list of folders in a user's Box, including the root.", "    Each folder is represented as a dict with its display name and path.", "    \"\"\"", "    metadata = client.metadata('/', list=True)", "    # List each folder, including the root", "    root = {"]}, {"lines": ["    }"]}, {"lines": ["    return folders", "", "", "def serialize_urls(node_settings):", "    node = node_settings.owner"]}, {"lines": ["", "    urls = {"]}, {"lines": ["        'config': node.api_url_for('box_config_put'),"]}, {"lines": ["        'deauthorize': node.api_url_for('box_deauthorize'),"]}, {"lines": ["        'importAuth': node.api_url_for('box_import_user_auth'),"]}, {"lines": ["        # Endpoint for fetching only folders (including root)"]}, {"lines": ["    }", "    return urls", "", "", "def serialize_settings(node_settings, current_user, client=None):", "    \"\"\"View helper that returns a dictionary representation of a", "    BoxNodeSettings record. Provides the return value for the", "    box config endpoints.", "    \"\"\""]}, {"lines": ["    user_settings = node_settings.user_settings"]}, {"lines": ["    current_user_settings = current_user.get_addon('box')"]}, {"lines": ["", "    if user_settings:", "        try:", "            client = client or get_client_from_user_settings(user_settings)"]}, {"lines": ["            client.get_user_info()"]}, {"lines": ["", "    result = {"]}, {"lines": ["        'userIsOwner': user_is_owner,"]}, {"lines": ["        'urls': serialize_urls(node_settings),"]}, {"lines": ["    }", "", "    if node_settings.has_auth:", "        # Add owner's profile URL"]}, {"lines": ["        result['ownerName'] = user_settings.owner.fullname", "        # Show available folders"]}, {"lines": ["            result['folder'] = {'name': None, 'path': None}"]}, {"lines": ["            result['folder'] = {"]}, {"lines": ["            }", "    return result", "", ""]}, {"lines": ["@must_not_be_registration", "@must_have_addon('box', 'user')", "@must_have_addon('box', 'node')", "@must_be_addon_authorizer('box')"]}, {"lines": ["def box_config_put(node_addon, user_addon, auth, **kwargs):", "    \"\"\"View for changing a node's linked box folder.\"\"\"", "    folder = request.json.get('selected')"]}, {"lines": ["    uid = folder['id']"]}, {"lines": ["    node_addon.set_folder(uid, auth=auth)"]}, {"lines": ["    return {", "        'result': {", "            'folder': {"]}, {"lines": ["            },"]}, {"lines": ["        },", "        'message': 'Successfully updated settings.',"]}, {"lines": ["", ""]}, {"lines": ["@must_have_addon('box', 'user')", "@must_have_addon('box', 'node')"]}, {"lines": ["def box_import_user_auth(auth, node_addon, user_addon, **kwargs):", "    \"\"\"Import box credentials from the currently logged-in user to a node.", "    \"\"\""]}, {"lines": ["    node_addon.set_user_auth(user_addon)", "    node_addon.save()"]}, {"lines": ["    return {"]}, {"lines": ["        'message': 'Successfully imported access token from profile.',"]}, {"lines": [""]}, {"lines": ["@must_not_be_registration"]}, {"lines": ["def box_deauthorize(auth, node_addon, **kwargs):", "    node_addon.deauthorize(auth=auth)", "    node_addon.save()"]}, {"lines": [""]}, {"lines": ["@must_have_addon('box', 'user')", "@must_have_addon('box', 'node')"]}, {"lines": ["def box_get_share_emails(auth, user_addon, node_addon, **kwargs):", "    \"\"\"Return a list of emails of the contributors on a project.", "", "    The current user MUST be the user who authenticated Box for the node.", "    \"\"\"", "    if not node_addon.user_settings:", "        raise HTTPError(http.BAD_REQUEST)", "    # Current user must be the user who authorized the addon", "    if node_addon.user_settings.owner != auth.user:", "        raise HTTPError(http.FORBIDDEN)"]}, {"lines": ["    }"]}, {"lines": ["import httplib as http"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class MockFolder(object):"]}, {"lines": ["    @property", "    def name(self):", "        return 'somename'", "", "    @property", "    def json(self):", "        return {'id': 'abc123', 'parent_id': 'cba321'}"]}, {"lines": ["    def test_citation_lists(self):"]}, {"lines": ["        mock_folders = [MockFolder()]"]}, {"lines": ["        assert_equal(res[1]['name'], mock_folders[0].name)", "        assert_equal(res[1]['id'], mock_folders[0].json['id'])", ""]}, {"lines": ["import mock"]}, {"lines": ["class MockNode(object):"]}, {"lines": ["    addon = None", "", "    @property", "    def is_deleted(self):", "        return False", "", "    @property", "    def is_public(self):", "        return True", "", "    def get_addon(self, name):", "        if name == 'mendeley':", "            return self.addon", "        return None"]}, {"lines": [""]}, {"lines": ["        self.user_addon = MendeleyUserSettingsFactory(owner=self.user, external_account=self.account)"]}, {"lines": ["        self.node_addon = MendeleyNodeSettingsFactory(owner=self.project)", "        self.node_addon.set_auth(external_account=self.account, user=self.user)"]}, {"lines": ["        self.node = MockNode()", "        self.node.addon = self.node_addon"]}, {"lines": ["        self.id_patcher = mock.patch('website.addons.mendeley.model.Mendeley.client_id')", "        self.secret_patcher = mock.patch('website.addons.mendeley.model.Mendeley.client_secret')", "        self.id_patcher.__get__ = mock.Mock(return_value='1234567890asdf')", "        self.secret_patcher.__get__ = mock.Mock(return_value='1234567890asdf')", "        self.id_patcher.start()", "        self.secret_patcher.start()", "", "    def tearDown(self):", "        self.id_patcher.stop()", "        self.secret_patcher.stop()"]}, {"lines": ["        res = self.app.get(", "            self.project.api_url_for('mendeley_get_config'),"]}, {"lines": ["        )"]}, {"lines": ["        res = self.app.get(", "            self.project.api_url_for('mendeley_get_config'),"]}, {"lines": ["        )"]}, {"lines": ["            {", "                'external_account_id': self.account._id,"]}, {"lines": ["            },", "            auth=self.user.auth,", "        )"]}, {"lines": [""]}, {"lines": ["        self.node_addon.associated_user_settings = []", "        self.node_addon.save()", "        res = self.app.put_json(", "            self.project.api_url_for('mendeley_set_config'),", "            {"]}, {"lines": ["                'external_list_id': 'list',", "            },"]}, {"lines": ["        )"]}, {"lines": ["        res = self.app.put_json(", "            self.project.api_url_for('mendeley_set_config'),", "            {", "                'external_account_id': self.account._id,", "                'external_list_id': 'list',", "            },"]}, {"lines": ["        )", "        self.node_addon.reload()"]}, {"lines": ["    def test_mendeley_widget_view_complete(self):"]}, {"lines": ["        assert_false(self.node_addon.complete)"]}, {"lines": ["        assert_equal(self.node_addon.mendeley_list_id, None)"]}, {"lines": ["        assert_true(res['complete'])"]}, {"lines": ["        assert_false(self.node_addon.complete)"]}, {"lines": ["        assert_equal(self.node_addon.mendeley_list_id, None)"]}, {"lines": ["        assert_false(res['complete'])", "        assert_is_none(res['list_id'])"]}, {"lines": ["        assert_equal(children[1]['kind'], 'file')"]}, {"lines": ["        box: {", "            // Shown on clicking \"Delete Access Token\" for dropbox", "            confirmDeauth: 'Are you sure you want to delete your Box access ' +", "                'key? This will revoke access to Box for all projects you have ' +", "                'authorized.',", "            deauthError: 'Could not deauthorize Box at this time',", "            deauthSuccess: 'Deauthorized Box.'", "        },"]}], "name": "Matt Frazier"}, {"commits": [{"lines": ["        'name': 'Society for Personality and Social Psychology 2014',"]}, {"lines": ["        'name': 'Association of Southeastern Biologists 2014',"]}, {"lines": ["        'name': 'Association for Psychological Science 2014',"]}, {"lines": ["        'name': 'Canadian Psychological Association 2014',"]}, {"lines": ["        'name': 'National Radio Astronomy Observatory Filaments 2014',"]}, {"lines": ["        'name': 'Berkeley Initiative for Transparency in the Social Sciences Research Transparency Forum 2014',"]}, {"lines": ["        'name': 'Society for Personality and Social Psychology 2015',"]}, {"lines": ["        'name': 'Association for Psychological Science 2015',"]}, {"lines": ["        'name': 'International Convention of Psychological Science 2015',"]}, {"lines": ["        'name': 'Midwestern Psychological Association 2015',"]}, {"lines": ["        'name': 'North Carolina Cognition Conference 2015',"]}, {"lines": ["        'name': 'Virginia Piedmont Regional Science Fair 2015',"]}, {"lines": ["        'name': 'Association of Southeastern Biologists 2015',"]}, {"lines": ["    },", "    'SEP2015': {", "        'name': 'Society of Experimental Psychologists Meeting 2015',", "        'info_url': 'http://faculty.virginia.edu/Society_of_Experimental_Psychologists/',", "        'logo_url': 'http://www.sepsych.org/nav/images/SEP-header.gif',"]}, {"lines": ["        'admins': [],", "        'public_projects': True,"]}, {"lines": ["    'Reid2015': {", "        'name': 'L. Starling Reid Undergraduate Psychology Conference 2015',", "        'info_url': 'http://avillage.web.virginia.edu/Psych/Conference',", "        'logo_url': None,"]}, {"lines": ["        'active': True,"]}, {"lines": ["        'admins': [],", "        'public_projects': True,"]}, {"lines": ["        'name': 'Virginia Section American Chemical Society Student Poster Session 2015',"]}, {"lines": ["    },"]}, {"lines": ["    'MADSSCi2015': {"]}, {"lines": ["        'name': 'Mid-Atlantic Directors and Staff of Scientific Cores & Southeastern Association of Shared Services 2015',"]}, {"lines": ["        'info_url': 'http://madssci.abrf.org',"]}, {"lines": ["        'logo_url': 'http://s24.postimg.org/qtc3baefp/2015madssci_seasr.png',"]}, {"lines": ["        'active': True,", "        'admins': [],", "        'public_projects': True,", "    },"]}, {"lines": ["        'name': 'National Radio Astronomy Observatory Accretion 2015',"]}, {"lines": ["        'info_url': 'https://science.nrao.edu/science/meetings/2015/accretion2015/posters',"]}, {"lines": ["        'logo_url': None,", "        'active': True,", "        'admins': [],", "        'public_projects': True,"]}, {"lines": ["        'name': 'OSF for Meetings 2015',", "        'info_url': None,", "        'logo_url': None,", "        'active': True,", "        'admins': [],", "        'public_projects': True,", "    },"]}], "name": "jolene-esposito"}, {"commits": [{"lines": ["        'info_url': None,"]}, {"lines": ["        'info_url': None,"]}, {"lines": ["        'info_url': None,"]}, {"lines": ["        'info_url': None,"]}, {"lines": ["        ],", "        'public_projects': True,", "    },", "    'NCCC2015': {"]}, {"lines": ["        'info_url': None,", "        'logo_url': None,"]}, {"lines": ["        'admins': [", "            'aoverman@elon.edu',"]}, {"lines": ["        ],", "        'public_projects': True,"]}, {"lines": ["    },", "    'VPRSF2015': {"]}, {"lines": ["        'info_url': None,"]}, {"lines": ["        'admins': [", "            'director@vprsf.org',"]}, {"lines": ["        ],", "        'public_projects': True,", "    },", "    'APRS2015': {", "        'name': 'UVA Annual Postdoctoral Research Symposium 2015',", "        'info_url': None,", "        'logo_url': 'http://s1.postimg.org/50qj9u6i7/GPA_Logo.jpg',"]}, {"lines": ["        'admins': ["]}, {"lines": ["        ],", "        'public_projects': True,", "    },", "    'ASB2015': {"]}, {"lines": ["        'info_url': None,", "        'logo_url': 'http://www.sebiologists.org/wp/wp-content/uploads/2014/09/banner_image_Large.png',"]}, {"lines": ["        'admins': [", "            'amorris.mtsu@gmail.com',"]}], "name": "Katy Cain"}, {"commits": [{"lines": ["        'logo_url': None,"]}, {"lines": ["    'TeaP2015': {", "        'name': 'Tagung experimentell arbeitender Psychologen 2015',"]}, {"lines": ["        'info_url': None,"]}, {"lines": ["        'logo_url': None,"]}, {"lines": ["        'admins': ["]}, {"lines": ["        ],", "        'public_projects': True,", "    },"]}, {"lines": ["    },", "    'RMPA2015': {", "        'name': 'Rocky Mountain Psychological Association 2015',", "        'info_url': 'http://www.rockymountainpsych.org/uploads/7/4/2/6/7426961/85th_annual_rmpa_conference_program_hr.pdf',", "        'logo_url': 'http://www.rockymountainpsych.org/uploads/7/4/2/6/7426961/header_images/1397234084.jpg',"]}, {"lines": ["        'admins': [],", "        'public_projects': True,", "    },", "    'ARP2015': {", "        'name': 'Association for Research in Personality 2015',", "        'info_url': 'http://www.personality-arp.org/conference/',", "        'logo_url': 'http://www.personality-arp.org/wp-content/uploads/conference/st-louis-arp.jpg',", "        'active': True,", "        'admins': [],", "        'public_projects': True,"]}, {"lines": ["    },"]}, {"lines": ["        'name': 'Northeastern Evolutionary Psychology Conference 2015',", "        'info_url': 'http://neeps2015.weebly.com/',", "        'logo_url': None,"]}, {"lines": ["        'admins': [],", "        'public_projects': True,"]}, {"lines": ["    'VaACS2015': {"]}, {"lines": ["        'info_url': 'http://virginia.sites.acs.org/',", "        'logo_url': 'http://virginia.sites.acs.org/Bulletin/15/UVA.jpg',"]}, {"lines": ["        'admins': [],", "        'public_projects': True,"]}, {"lines": ["        'name': 'Advancing Research Communication and Scholarship 2015',", "        'info_url': 'http://commons.pacificu.edu/arcs/',", "        'logo_url': 'http://commons.pacificu.edu/assets/md5images/4dfd167454e9f4745360a9550e189323.png',", "        'active': True,", "        'admins': [],", "        'public_projects': True,", "    },"]}, {"lines": ["        'name': 'Single Case Designs in Clinical Psychology: Uniting Research and Practice',", "        'info_url': 'https://www.royalholloway.ac.uk/psychology/events/eventsarticles/singlecasedesignsinclinicalpsychologyunitingresearchandpractice.aspx',"]}, {"lines": ["        'active': True,", "        'admins': [],", "        'public_projects': True,", "    },"]}, {"lines": ["        'name': 'Japanese Society of Social Psychology 2015',", "        'info_url': 'http://www.socialpsychology.jp/conf2015/index.html',", "        'logo_url': None,", "        'active': True,", "        'admins': [],", "        'public_projects': True,", "    },"]}, {"lines": ["        'name': 'Society for Social Studies of Science 2015',", "        'info_url': 'http://www.4sonline.org/meeting',", "        'logo_url': 'http://www.4sonline.org/ee/denver-skyline.jpg',", "        'active': True,", "        'admins': [],", "        'public_projects': True,", "    },"]}, {"lines": ["    'IARR2016': {", "        'name': 'International Association for Relationship Research 2016',", "        'info_url': 'http://iarr.psych.utoronto.ca/',"]}, {"lines": ["        'logo_url': None,"]}, {"lines": ["        'active': True,", "        'admins': [],", "        'public_projects': True,", "    },", "    'IA2015': {", "        'name': 'Inclusive Astronomy 2015',", "        'info_url': 'https://vanderbilt.irisregistration.com/Home/Site?code=InclusiveAstronomy2015',", "        'logo_url': 'https://vanderbilt.blob.core.windows.net/images/Inclusive%20Astronomy.jpg',", "        'active': True,", "        'admins': [],", "        'public_projects': True,", "    },"]}, {"lines": ["            <script>"]}, {"lines": ["            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){", "            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),", "            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)", "            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');", ""]}, {"lines": ["            ga('require', 'linker');", "            ga('linker:autoLink', ['centerforopenscience.org'] );", "            ga('send', 'pageview');"]}, {"lines": ["    it works, watch our short <a"]}, {"lines": ["        Started</a> videos, see the <a"]}, {"lines": ["        href=\"mailto:contact@osf.io\">dev team</a> for"]}, {"lines": ["            href=\"mailto:contact@osf.io\">here</a>.</p>"]}, {"lines": ["", "<h3>Is the OSF HIPAA compliant?</h3>", "<p>You should refer to your institutional policies regarding specific security requirements for your research.</p>", "", "<h3>What is the cap on data per user?</h3>", "<p>There is a limit on the size of individual files uploaded to the OSF. This limit is 128 mb. If you have larger files to upload, you might consider utilizing add-ons.</p>", ""]}, {"lines": ["<h3>How do I get a DOI or ARK for my project?</h3>", "<p>DOIs and ARKs are available for <b>public registrations</b> of projects. To get a DOI or ARK for your project, first create a registration of your project, and make sure the registration is public. Then click \"Create DOI / ARK\" link, located in the block of text below the project title. A DOI and ARK will be automatically created. </p>", "", "<h3>I have a DOI for my project on the OSF, but I've decided I'd rather host the material elsewhere. How can I do this without losing/needing a new DOI?</h3>", "<p>Send us an email with your DOI and the new location of your materials and we'll update the URL associated with your DOI. </p>"]}, {"lines": ["", "<h3>How do I rename a project?</h3>", "<p>You can rename a project or a component by clicking on the project title in the project or component overview page.</p>", ""]}, {"lines": ["<h3>Can I move a file from one storage add-on to another? Or one component to another?</h3>", "<p>Yes, you can move files between add-ons and between components, provided the add-ons or components are a part of the same project.</p>"]}, {"lines": ["", "<h3>Can I rename files after they are uploaded?</h3>", "<p>Unfortunately, no - you will have to delete the file and re-upload a new file with the desired name.</p>", "", "<h3>My email address has changed. How do I change my login email?</h3>"]}, {"lines": ["", "<h3>How can I license my data/code/etc.?</h3>"]}, {"lines": ["", "<h3>How do I create a lab group/organizational group?</h3>"]}, {"lines": [""]}, {"lines": ["<h3>I have multiple OSF accounts. Can I merge them into one account?</h3>", "<p>Yes. Log into the account you wish to keep and navigate to your Account Settings. There, enter the email address associated with your other OSF account. You will receive a confirmation link via email. Clicking the link will merge the projects and components under one account.</p>"]}, {"lines": [""]}, {"lines": ["<h3>What is the difference between a component and a folder?</h3>"]}, {"lines": ["", "<h3>I\u2019m using the search function to find one of my projects, but it\u2019s not showing up in the results. What\u2019s wrong?</h3>", "<p>The search function only returns public projects, so if you\u2019re searching for one of your own private projects, it won\u2019t be returned in the results. To search for your own projects, go to your dashboard, and use the \u201cGo to my project\u201d widget on the top right.</p>", "", "<h3>None of these FAQs answered my question. Now what?</h3>"]}, {"lines": ["</div>"]}], "name": "saradbowman"}, {"commits": [{"lines": ["        'active': False,"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'name': 'Virginia State Science and Engineering Fair 2015',", "        'info_url': 'http://www.vmi.edu/conferences/vssef/vssef_home/',", "        'logo_url': 'http://www.vmi.edu/uploadedImages/Images/Headers/vssef4.jpg',"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'admins': [],", "        'public_projects': True,"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'active': False,"]}, {"lines": ["    },"]}, {"lines": ["        'active': False,"]}, {"lines": ["        'active': False,"]}], "name": "Andrew Sallans"}, {"commits": [{"lines": ["#!/usr/bin/env python", "# -*- coding: utf-8 -*-", "\"\"\"", "Adds wiki and osffiles addons to nodes that do not have them."]}, {"lines": ["\"\"\"", ""]}, {"lines": ["import logging", ""]}, {"lines": ["", "from tests.base import OsfTestCase", "from tests.factories import NodeFactory", "", "from website.app import init_app", "from website.project.model import Node", ""]}, {"lines": ["from website.addons.wiki.model import AddonWikiNodeSettings", "from website.addons.osffiles.model import AddonFilesNodeSettings", ""]}, {"lines": ["logger = logging.getLogger(__name__)", ""]}, {"lines": ["ADDONS = {AddonFilesNodeSettings, AddonWikiNodeSettings}", ""]}, {"lines": ["", "def main():"]}, {"lines": ["    from framework.mongo import db", "    init_app(routes=False)", "    migrate_nodes(db)", ""]}, {"lines": ["", "def migrate_addons(node):", "    ret = False", "    if not node.has_addon('wiki'):", "        node.add_addon('wiki', auth=node.creator, log=False)", "        ret = True", "    if not node.has_addon('osffiles'):", "        node.add_addon('osffiles', auth=node.creator, log=False)", "        ret = True", "    return ret", ""]}, {"lines": ["", "def migrate_nodes(db):", "    for addon_class in ADDONS:", "        print('Processing ' + addon_class.__name__)", "", "        for node in get_affected_nodes(db, addon_class):", "            print(' - ' + node._id)", "            migrate_addons(node)", "", "        print('')", "", "    print('-----\\nDone.')", "", "", "def get_affected_nodes(db, addon_class):", "    \"\"\"Generate affected nodes.\"\"\"", "    query = db['node'].find({", "        '.'.join(", "            ('__backrefs',", "                'addons',", "                addon_class.__name__.lower(),", "                'owner',", "                '0'", "            )", "        ): {'$exists': False}", "    })", "    return (Node.load(node['_id']) for node in query)"]}, {"lines": ["", "", "class TestMigratingAddons(OsfTestCase):", "", "    def test_migrate_wiki(self):", "        node = NodeFactory()"]}, {"lines": ["        wiki_addon = node.get_addon('wiki')", "        AddonWikiNodeSettings.remove_one(wiki_addon)"]}, {"lines": ["        assert_false(node.has_addon('wiki'))", "        was_migrated = migrate_addons(node)", "        assert_true(was_migrated)"]}, {"lines": ["        assert_true(node.has_addon('wiki'))", "", "    def test_migrate_osffiles(self):", "        node = NodeFactory()"]}, {"lines": ["        osf_addon = node.get_addon('osffiles')", "        AddonFilesNodeSettings.remove_one(osf_addon)"]}, {"lines": ["        assert_false(node.has_addon('osffiles'))", "        was_migrated = migrate_addons(node)", "        assert_true(was_migrated)"]}, {"lines": ["        assert_true(node.has_addon('osffiles'))", "", "    def test_no_migration_if_addon_exists(self):", "        node = NodeFactory()", "        assert_true(node.has_addon('wiki'))", "        assert_true(node.has_addon('osffiles'))"]}, {"lines": ["        migrate_nodes(self.db)", "        assert_false(migrate_addons(node))", "", "    def test_affected_nodes(self):", "        affected_node = NodeFactory()", "        AddonWikiNodeSettings.remove_one(affected_node.get_addon('wiki'))", "        assert_false(affected_node.has_addon('wiki'))", "", "        unaffected_node = NodeFactory()", "        assert_true(unaffected_node.has_addon('wiki'))", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "if __name__ == '__main__':", "    main()"]}, {"lines": ["            'sharejs_uuid': '',", "            'urls': {"]}, {"lines": ["            },"]}, {"lines": ["            'extra': '',"]}, {"lines": ["    def test_get_contributors_abbrev(self):", "        # create a project with 3 registered contributors", "        project = ProjectFactory(creator=self.user1, is_public=True)", "        reg_user1, reg_user2 = UserFactory(), UserFactory()", "        project.add_contributors(", "            [", "                {'user': reg_user1, 'permissions': [", "                    'read', 'write', 'admin'], 'visible': True},", "                {'user': reg_user2, 'permissions': [", "                    'read', 'write', 'admin'], 'visible': True},", "            ]", "        )", "", "        # add an unregistered contributor"]}, {"lines": ["            fullname=fake.name(), email=fake.email(),", "            auth=self.consolidate_auth1,", "            save=True,", "        )", "", "        url = project.api_url_for('get_node_contributors_abbrev')", "        res = self.app.get(url, auth=self.auth)", "        assert_equal(len(project.contributors), 4)", "        assert_equal(len(res.json['contributors']), 3)", "        assert_equal(len(res.json['others_count']), 1)", "        assert_equal(res.json['contributors'][0]['separator'], ',')", "        assert_equal(res.json['contributors'][1]['separator'], ',')", "        assert_equal(res.json['contributors'][2]['separator'], '&nbsp;&')", ""]}, {"lines": ["    def test_get_children_rescale_ratio(self):", "        project = ProjectFactory(creator=self.user)"]}, {"lines": ["", "        url = project.api_url_for('get_children')", "        res = self.app.get(url, auth=self.user.auth)", "", "        rescale_ratio = res.json['rescale_ratio']"]}, {"lines": ["", "    def test_get_children_render_nodes_receives_auth(self):", "        project = ProjectFactory(creator=self.user)"]}, {"lines": ["", "        url = project.api_url_for('get_children')", "        res = self.app.get(url, auth=self.user.auth)", "", "        perm = res.json['nodes'][0]['permissions']"]}, {"lines": ["    'registered. If you wish to register the linked projects, you must fork '"]}, {"lines": ["                var url = $self.attr('url');"]}, {"lines": ["from website.profile.utils import get_gravatar"]}, {"lines": ["    guid_file, created = node_addon.find_or_create_file_guid(path)"]}, {"lines": ["    if guid_file.guid_url != request.path:", "        guid_url = furl.furl(guid_file.guid_url)"]}, {"lines": ["    guid_file.maybe_set_version(**extras)"]}, {"lines": ["        download_url = furl.furl(guid_file.download_url)"]}, {"lines": ["        download_url = furl.furl(guid_file.download_url)"]}, {"lines": ["    return addon_view_file(auth, node, node_addon, guid_file, extras)"]}, {"lines": ["def addon_view_file(auth, node, node_addon, guid_file, extras):"]}, {"lines": ["    # TODO: resolve circular import issue"]}, {"lines": ["    from website.addons.wiki import settings as wiki_settings"]}, {"lines": [""]}, {"lines": ["    else:", "        sharejs_uuid = None", ""]}, {"lines": ["        'provider': guid_file.provider,", "        'file_path': guid_file.waterbutler_path,"]}, {"lines": ["        'urls': {"]}, {"lines": ["        },"]}, {"lines": ["        'extra': json.dumps(getattr(guid_file, 'extra', {})),"]}, {"lines": ["        'file_name': getattr(guid_file, 'name', os.path.split(guid_file.waterbutler_path)[1]),"]}, {"lines": ["        'materialized_path': getattr(guid_file, 'materialized', guid_file.waterbutler_path),"]}, {"lines": ["            message = (", "                'Dataverse authorization copied to forked {cat}.'", "            ).format(", "                cat=fork.project_or_component", "            )"]}, {"lines": ["            message = (", "                'Dataverse authorization not copied to forked {cat}. You may '", "                'authorize this fork on the <a href=\"{url}\">Settings</a> '", "                'page.'", "            ).format(", "                url=fork.web_url_for('node_setting'),", "                cat=fork.project_or_component", "            )"]}, {"lines": [""]}, {"lines": ["                <a id=\"figshareDelKey\" class=\"text-danger pull-right addon-auth\">Delete Access Token</a>"]}, {"lines": ["        Rule([", "            '/project/<pid>/wiki/',", "            '/project/<pid>/node/<nid>/wiki/',", "        ], 'get', views.project_wiki_home, json_renderer),", ""]}, {"lines": ["        # Validate | GET"]}, {"lines": ["        Rule(["]}, {"lines": ["        ], 'get', views.project_wiki_validate_name, json_renderer),"]}, {"lines": [""]}, {"lines": ["        Rule(["]}, {"lines": ["        ], 'put', views.project_wiki_rename, json_renderer),"]}, {"lines": ["<%page expression_filter=\"h\"/>"]}, {"lines": ["<!-- New Component Modal -->"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "            } else if ($data.val().indexOf('/') != -1) {"]}, {"lines": ["                $alert.text('The new wiki page name cannot contain forward slashes.');", "                $submitForm", "                    .removeAttr('disabled', 'disabled')", "                    .text('OK');"]}, {"lines": ["                var wikiName = $data.val();"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["<script>"]}, {"lines": ["</script>"]}, {"lines": ["        % if category == 'project':"]}, {"lines": ["                    <ul class=\"wiki-component\">"]}, {"lines": ["                                <li>"]}, {"lines": ["        self.consolidate_auth = Auth(user=self.project.creator)"]}, {"lines": ["    def test_wiki_validate_name(self):"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["    def test_wiki_validate_name_cannot_create_home(self):", "        url = self.project.api_url_for('project_wiki_validate_name', wname='home')", "        res = self.app.get(url, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, 409)", ""]}, {"lines": ["    def test_project_wiki_validate_name_mixed_casing(self):"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_not_in('capslock', self.project.wiki_pages_current)", "        self.project.update_node_wiki('CaPsLoCk', 'hello', self.consolidate_auth)", "        assert_in('capslock', self.project.wiki_pages_current)", "", "    def test_project_wiki_validate_name_diplay_correct_capitalization(self):"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        assert_in('CaPsLoCk', res)", ""]}, {"lines": ["    def test_project_wiki_validate_name_conflict_different_casing(self):"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth)", "        assert_equal(res.status_code, 200)", "        self.project.update_node_wiki('CaPsLoCk', 'hello', self.consolidate_auth)"]}, {"lines": ["        assert_in('capslock', self.project.wiki_pages_current)"]}, {"lines": ["        res = self.app.get(url, auth=self.user.auth, expect_errors=True)", "        assert_equal(res.status_code, 409)", ""]}, {"lines": ["    def test_project_wiki_home_api_route(self):", "        url = self.project.api_url_for('project_wiki_home')", "        res = self.app.get(url, auth=self.user.auth)"]}, {"lines": ["", "    def test_project_wiki_home_web_route(self):"]}, {"lines": ["        url = self.project.web_url_for('project_wiki_home')", "        res = self.app.get(url, auth=self.user.auth)"]}, {"lines": [""]}, {"lines": ["class TestWikiDelete(OsfTestCase):", "", "    def setUp(self):", "        super(TestWikiDelete, self).setUp()", "", "        self.project = ProjectFactory(is_public=True)", "        api_key = ApiKeyFactory()", "        self.project.creator.api_keys.append(api_key)", "        self.project.creator.save()", "        self.consolidate_auth = Auth(user=self.project.creator, api_key=api_key)", "        self.auth = ('test', api_key._primary_key)", "        self.project.update_node_wiki('Elephants', 'Hello Elephants', self.consolidate_auth)", "        self.project.update_node_wiki('Lions', 'Hello Lions', self.consolidate_auth)", "        self.elephant_wiki = self.project.get_wiki_page('Elephants')", "        self.lion_wiki = self.project.get_wiki_page('Lions')"]}, {"lines": [""]}, {"lines": ["        self.app.delete("]}, {"lines": ["            auth=self.auth", "        )", "        self.project.reload()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            auth=self.auth"]}, {"lines": ["    def test_cannot_rename_wiki_page_to_home(self):"]}, {"lines": ["        user = AuthUserFactory()", "        # A fresh project where the 'home' wiki page has no content", "        project = ProjectFactory(creator=user)", "        project.update_node_wiki('Hello', 'hello world', Auth(user=user))", "        url = project.api_url_for('project_wiki_rename', wname=to_mongo_key('Hello'))", "        res = self.app.put_json(url, {'value': 'home'}, auth=user.auth, expect_errors=True)"]}, {"lines": ["        assert_equal(res.status_code, 409)", ""]}, {"lines": ["    def test_rename_wiki_page_duplicate_different_casing(self):"]}, {"lines": ["        res = self.app.put_json(", "            self.url,"]}, {"lines": ["            auth=self.auth,", "            expect_errors=True", "        )", "        assert_equal(res.status_code, 409)", ""]}, {"lines": ["        res = self.app.put_json("]}, {"lines": ["            auth=self.auth,", "            expect_errors=False", "        )", "        assert_equal(res.status_code, 200)", ""]}, {"lines": ["            'activity_points': user.get_activity_points(),"]}, {"lines": ["            separator = '&nbsp&'"]}, {"lines": ["    return _render_nodes(nodes, auth)"]}, {"lines": ["        });"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            if(self.changed()) {"]}, {"lines": ["                var request = $.ajax({", "                    type: 'PUT',"]}, {"lines": ["                    beforeSend: $osf.setXHRAuthorization", "                }).done(function () {"]}, {"lines": ["                    Raven.captureMessage('Could not PUT file content.', {"]}, {"lines": ["                        url: self.url", "                    });"]}, {"lines": ["            } else {", "                alert('There are no changes to save.');", "            }"]}, {"lines": [""]}, {"lines": ["                m('.wmd-input.wiki-editor#editor', {config: ctrl.bindAce})", "            ]),"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": [""]}, {"lines": ["var collaborative = (typeof WebSocket !== 'undefined' && typeof sharejs !== 'undefined');", ""]}, {"lines": ["var ShareJSDoc = function(shareWSUrl, metadata, editor, observables) {"]}, {"lines": ["    var self = this;", "    self.editor = editor;"]}, {"lines": [""]}, {"lines": ["", "    // Initialize Ace and configure settings", "    self.editor.getSession().setMode('ace/mode/markdown');", "    self.editor.getSession().setUseSoftTabs(true);   // Replace tabs with spaces", "    self.editor.getSession().setUseWrapMode(true);   // Wraps text", "    self.editor.renderer.setShowGutter(false);       // Hides line number", "    self.editor.setShowPrintMargin(false);           // Hides print margin", "    self.editor.commands.removeCommand('showSettingsMenu');  // Disable settings menu", "    self.editor.setReadOnly(true); // Read only until initialized", "    self.editor.setOptions({"]}, {"lines": ["        enableBasicAutocompletion: false,", "        enableSnippets: false,", "        enableLiveAutocompletion: false"]}, {"lines": ["    });", ""]}, {"lines": ["    self.observables = observables;"]}, {"lines": ["", "    // Requirements load order is specific in this case to compensate", "    // for older browsers.", "    var ReconnectingWebSocket = require('reconnectingWebsocket');", "    require('addons/wiki/static/ace.js');", "", "    // Configure connection", "    var wsPrefix = (window.location.protocol === 'https:') ? 'wss://' : 'ws://';"]}, {"lines": ["    var wsUrl = wsPrefix + shareWSUrl;"]}, {"lines": ["    var socket = new ReconnectingWebSocket(wsUrl);", "    var sjs = new sharejs.Connection(socket);", "    var doc = sjs.get('docs', metadata.docId);", "    var madeConnection = false;", "    var allowRefresh = true;", "    var refreshTriggered = false;", "    var canEdit = true;", "", "    function whenReady() {"]}, {"lines": ["", "        // Create a text document if one does not exist", "        if (!doc.type) {"]}, {"lines": ["            doc.create('text');"]}, {"lines": ["        }", ""]}, {"lines": ["", "    }", "", "    function unlockEditor() {", "        self.editor.gotoLine(0,0);", "        var undoManager = self.editor.getSession().getUndoManager();", "        undoManager.reset();", "        self.editor.getSession().setUndoManager(undoManager);", "        self.editor.setReadOnly(false);", "    }", "", "    // Send user metadata", "    function register() {", "        socket.send(JSON.stringify(metadata));", "    }", "", "    function refreshMaybe() {", "        if (allowRefresh && refreshTriggered) {"]}, {"lines": ["        }", "    }", "", "    // Handle our custom messages separately", "    var onmessage = socket.onmessage;", "    socket.onmessage = function (message) {", "        var data = JSON.parse(message.data);", "        // Meta type is not built into sharejs; we pass it manually", "        switch (data.type) {", "            case 'meta':"]}, {"lines": ["                break;"]}, {"lines": ["            case 'lock':", "                allowRefresh = false;", "                self.editor.setReadOnly(true);", "                permissionsModal.modal({", "                    backdrop: 'static',", "                    keyboard: false", "                });", "                setTimeout(function() {", "                    allowRefresh = true;", "                    refreshMaybe();", "                }, 3000);", "                break;", "            case 'unlock':", "                canEdit = data.contributors.indexOf(metadata.userId) > -1;", "                refreshTriggered = true;", "                refreshMaybe();", "                break;", "            default:", "                onmessage(message);", "                break;"]}, {"lines": ["        }", "    };", "", "    // Update status when reconnecting", "    var onclose = socket.onclose;", "    socket.onclose = function (event) {", "        onclose(event);"]}, {"lines": ["        self.observables.status('connecting');"]}, {"lines": ["    };", "", "    var onopen = socket.onopen;", "    socket.onopen = function(event) {", "        onopen(event);", "        if (madeConnection) {"]}, {"lines": ["            self.observables.status('connected');"]}, {"lines": ["        }", "    };", "", "    // This will be called on both connect and reconnect", "    doc.on('subscribe', register);", "", "    // This will be called when we have a live copy of the server's data.", "    doc.whenReady(whenReady);", "", "    // Subscribe to changes", "    doc.subscribe();", "};", ""]}, {"lines": ["                        handle: '.sort-handle',"]}, {"lines": ["                        handle: '.sort-handle',"]}, {"lines": ["        </div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["</div>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}], "name": "Casey Rollins"}, {"commits": [{"lines": ["\"\"\" Ensure that users with User.email_verifications == None now have {} instead", "\"\"\"", "", "import logging", "import sys"]}, {"lines": ["from modularodm import Q", "from nose.tools import *", "from website import models", "from website.app import init_app", "from scripts import utils as scripts_utils"]}, {"lines": [""]}, {"lines": ["logger = logging.getLogger(__name__)", "logger.setLevel(logging.INFO)", "", "def main():", "    init_app(routes=False)", "    dry_run = 'dry' in sys.argv", "    count = 0", "", "    if not dry_run:", "        scripts_utils.add_file_logger(logger, __file__)", "    logger.info(\"Iterating users with None as their email_verification\")", "    for user in get_users_with_none_in_email_verifications():", "        user.email_verifications = {}", "        count += 1", "        logger.info(repr(user))", "        if not dry_run:", "            user.save()", ""]}, {"lines": ["    logger.info('Done with {} users migrated'.format(count))"]}, {"lines": ["", "def get_users_with_none_in_email_verifications():"]}, {"lines": ["    return models.User.find(Q('email_verifications', 'eq', None))"]}, {"lines": ["", "if __name__ == '__main__':"]}, {"lines": ["    main()"]}, {"lines": ["from tests.base import OsfTestCase", "from tests.factories import UserFactory", "from nose.tools import *", "", "from scripts.migration.migrate_none_as_email_verification import main as do_migration", "", "class TestMigrateDates(OsfTestCase):", "    def setUp(self):", "        super(TestMigrateDates, self).setUp()", "        self.user1 = UserFactory(email_verfications=None)", "        self.user2 = UserFactory(email_verfications={})", "", "    def test_migrate_none_as_email(self):", "        do_migration()", "        assert_equal(self.user1.email_verifications, {})", "        assert_not_equal(self.user2.email_verifications, None)", ""]}], "name": "Eric Barbour"}, {"commits": [{"lines": ["import unittest"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["import website.search.search as search"]}, {"lines": [""]}, {"lines": ["class SearchTestCase(OsfTestCase):", ""]}, {"lines": ["    def tearDown(self):"]}, {"lines": ["", "", "def query(term):"]}, {"lines": ["", "", "def query_user(name):"]}, {"lines": ["    return query(term)", ""]}, {"lines": ["class TestUserUpdate(SearchTestCase):", ""]}, {"lines": [""]}, {"lines": ["        assert_equal(len(docs), 1)", "", "    def test_change_name(self):"]}, {"lines": ["        user = UserFactory(fullname='Barry Mitchell')", "        fullname_original = user.fullname", "        user.fullname = user.fullname[::-1]", "        user.save()"]}, {"lines": [""]}, {"lines": ["        assert_equal(len(docs_original), 0)", ""]}, {"lines": ["        assert_equal(len(docs_current), 1)", ""]}, {"lines": ["    def test_merged_user(self):", "        user = UserFactory(fullname='Annie Lennox')", "        merged_user = UserFactory(fullname='Lisa Stansfield')", "        user.save()", "        merged_user.save()"]}, {"lines": ["", "        user.merge_user(merged_user)", ""]}, {"lines": [""]}, {"lines": ["class TestProject(SearchTestCase):", "", "    def setUp(self):"]}, {"lines": ["        self.user = UserFactory(fullname='John Deacon')", "        self.project = ProjectFactory(title='Red Special', creator=self.user)", "", "    def test_new_project_private(self):"]}, {"lines": ["        assert_equal(len(docs), 0)", "", "    def test_make_public(self):"]}, {"lines": ["        self.project.set_privacy('public')"]}, {"lines": ["        assert_equal(len(docs), 1)", ""]}, {"lines": ["class TestPublicNodes(SearchTestCase):"]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        self.user = UserFactory(usename='Doug Bogie')"]}, {"lines": ["        self.title = 'Red Special'"]}, {"lines": ["        self.consolidate_auth = Auth(user=self.user)", "        self.project = ProjectFactory("]}, {"lines": ["            title=self.title,"]}, {"lines": ["            creator=self.user,"]}, {"lines": ["        )"]}, {"lines": ["        self.component = NodeFactory("]}, {"lines": ["            title=self.title,", "            creator=self.user,", "            is_public=True", "        )", "        self.registration = ProjectFactory(", "            title=self.title,", "            creator=self.user,", "            is_public=True,", "            is_registration=True", "        )"]}, {"lines": ["", "    def test_make_private(self):"]}, {"lines": ["        self.project.set_privacy('private')"]}, {"lines": ["        assert_equal(len(docs), 0)", "", "        self.component.set_privacy('private')"]}, {"lines": ["        assert_equal(len(docs), 0)"]}, {"lines": [""]}, {"lines": ["    def test_delete_project(self):"]}, {"lines": ["        self.component.remove_node(self.consolidate_auth)"]}, {"lines": ["        assert_equal(len(docs), 0)", ""]}, {"lines": ["        self.project.remove_node(self.consolidate_auth)"]}, {"lines": ["        assert_equal(len(docs), 0)", "", "    def test_change_title(self):"]}, {"lines": ["        title_original = self.project.title", "        self.project.set_title("]}, {"lines": ["            'Blue Ordinary', self.consolidate_auth, save=True)"]}, {"lines": [""]}, {"lines": ["        assert_equal(len(docs), 0)", ""]}, {"lines": ["        assert_equal(len(docs), 1)", ""]}, {"lines": ["    def test_add_tags(self):"]}, {"lines": [""]}, {"lines": ["        tags = ['stonecoldcrazy', 'just a poor boy', 'from-a-poor-family']"]}, {"lines": [""]}, {"lines": ["        for tag in tags:"]}, {"lines": ["            assert_equal(len(docs), 0)", "            self.project.add_tag(tag, self.consolidate_auth, save=True)"]}, {"lines": [""]}, {"lines": ["        for tag in tags:"]}, {"lines": ["            assert_equal(len(docs), 1)"]}, {"lines": ["", "    def test_remove_tag(self):", ""]}, {"lines": ["        tags = ['stonecoldcrazy', 'just a poor boy', 'from-a-poor-family']"]}, {"lines": [""]}, {"lines": ["        for tag in tags:", "            self.project.add_tag(tag, self.consolidate_auth, save=True)", "            self.project.remove_tag(tag, self.consolidate_auth, save=True)"]}, {"lines": ["            assert_equal(len(docs), 0)"]}, {"lines": ["", "    def test_update_wiki(self):", "        \"\"\"Add text to a wiki page, then verify that project is found when", "        searching for wiki text.", "", "        \"\"\""]}, {"lines": ["", "    def test_clear_wiki(self):"]}, {"lines": ["        wiki_content = 'Hammer to fall'", "        self.project.update_node_wiki("]}, {"lines": ["        self.project.update_node_wiki('home', '', self.consolidate_auth)", ""]}, {"lines": ["        assert_equal(len(docs), 0)", "", "    def test_add_contributor(self):"]}, {"lines": ["        user2 = UserFactory(fullname='Adam Lambert')", ""]}, {"lines": ["        assert_equal(len(docs), 0)", "", "        self.project.add_contributor(user2, save=True)", ""]}, {"lines": ["        assert_equal(len(docs), 1)", "", "    def test_remove_contributor(self):"]}, {"lines": ["        user2 = UserFactory(fullname='Brian May')", "", "        self.project.add_contributor(user2, save=True)", "        self.project.remove_contributor(user2, self.consolidate_auth)", ""]}, {"lines": ["        assert_equal(len(docs), 0)", ""]}, {"lines": ["class TestAddContributor(SearchTestCase):"]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        self.name1 = 'Roger1 Taylor1'", "        self.name2 = 'John2 Deacon2'"]}, {"lines": ["        self.user = UserFactory(fullname=self.name1)"]}, {"lines": [""]}, {"lines": ["    def test_unreg_users_dont_show_in_search(self):", "        unreg = UnregUserFactory()", "        contribs = search.search_contributor(unreg.fullname)", "        assert_equal(len(contribs['users']), 0)", ""]}, {"lines": ["    def test_search_fullname(self):"]}, {"lines": ["        contribs = search.search_contributor(self.name1)", "        assert_equal(len(contribs['users']), 1)", "", "        contribs = search.search_contributor(self.name2)", "        assert_equal(len(contribs['users']), 0)", "", "    def test_search_firstname(self):"]}, {"lines": ["        contribs = search.search_contributor(self.name1.split(' ')[0])", "        assert_equal(len(contribs['users']), 1)", "", "        contribs = search.search_contributor(self.name2.split(' ')[0])", "        assert_equal(len(contribs['users']), 0)", "", "    def test_search_partial(self):"]}, {"lines": ["        contribs = search.search_contributor(self.name1.split(' ')[0][:-1])", "        assert_equal(len(contribs['users']), 1)", "", "        contribs = search.search_contributor(self.name2.split(' ')[0][:-1])", "        assert_equal(len(contribs['users']), 0)"]}, {"lines": ["from tests.test_features import requires_search"]}, {"lines": ["@requires_search"]}, {"lines": ["        import website.search.search as search", "        search.delete_all()"]}, {"lines": ["        self.project = ProjectFactory(creator=UserFactory(fullname='Robbie Williams'))"]}, {"lines": ["import website.search.search as search"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["'''Migration script for Search-enabled Models.'''"]}, {"lines": ["import website.search.search as search"]}, {"lines": ["SEARCH_ENGINE = 'elastic'"]}, {"lines": ["", "            % if not summary['is_public']:"]}, {"lines": ["            % endif"]}, {"lines": [""]}], "name": "fabian"}, {"commits": [{"lines": ["TEST_INDEX = 'test'"]}, {"lines": ["", ""]}, {"lines": ["        elastic_search.INDEX = TEST_INDEX", "        settings.ELASTIC_INDEX = TEST_INDEX"]}, {"lines": ["        self.name3 = u'j\\xc3\\xb3ebert3 Smith3'", "        self.name4 = u'B\\xc3\\xb3bbert4 Jones4'"]}, {"lines": ["        self.user3 = UserFactory(fullname=self.name3)"]}, {"lines": ["    def test_search_fullname_special_character(self):"]}, {"lines": ["        contribs = search.search_contributor(self.name3)", "        assert_equal(len(contribs['users']), 1)", "", "        contribs = search.search_contributor(self.name4)", "        assert_equal(len(contribs['users']), 0)", "", "    def test_search_firstname_special_charcter(self):"]}, {"lines": ["        contribs = search.search_contributor(self.name3.split(' ')[0])", "        assert_equal(len(contribs['users']), 1)"]}, {"lines": ["        contribs = search.search_contributor(self.name4.split(' ')[0])", "        assert_equal(len(contribs['users']), 0)", "", "    def test_search_partial_special_character(self):"]}, {"lines": ["        contribs = search.search_contributor(self.name3.split(' ')[0][:-1])", "        assert_equal(len(contribs['users']), 1)"]}, {"lines": ["        contribs = search.search_contributor(self.name4.split(' ')[0][:-1])", "        assert_equal(len(contribs['users']), 0)", ""]}, {"lines": ["@requires_search", "class TestProjectSearchResults(SearchTestCase):", "    def setUp(self):", "        super(TestProjectSearchResults, self).setUp()", "        self.user = UserFactory(usename='Doug Bogie')"]}, {"lines": [""]}, {"lines": ["        self.singular = 'Spanish Inquisition'", "        self.plural = 'Spanish Inquisitions'", "        self.possessive = 'Spanish\\'s Inquisition'"]}, {"lines": ["", "        self.project_singular = ProjectFactory("]}, {"lines": ["            title=self.singular,"]}, {"lines": ["            creator=self.user,", "            is_public=True,", "        )", "", "        self.project_plural = ProjectFactory("]}, {"lines": ["            title=self.plural,"]}, {"lines": ["            creator=self.user,", "            is_public=True,", "        )", ""]}, {"lines": ["        self.project_possessive = ProjectFactory("]}, {"lines": ["            title=self.possessive,"]}, {"lines": ["            creator=self.user,", "            is_public=True,", "        )", "", "        self.project_unrelated = ProjectFactory(", "            title='Cardinal Richelieu',", "            creator=self.user,", "            is_public=True,", "        )", "", "    def test_singular_query(self):"]}, {"lines": ["        results = query(self.singular)['results']"]}, {"lines": ["        assert_equal(len(results), 3)", "", "    def test_plural_query(self):"]}, {"lines": ["        results = query(self.plural)['results']"]}, {"lines": ["        assert_equal(len(results), 3)", ""]}, {"lines": ["    def test_possessive_query(self):"]}, {"lines": ["        results = query(self.possessive)['results']"]}, {"lines": ["        assert_equal(len(results), 3)", ""]}, {"lines": [""]}, {"lines": ["        )", "", "    def test_unescape_html(self):", "        assert_equal("]}, {"lines": ["            sanitize.safe_unescape_html('&lt;&gt; diamonds &amp; diamonds &lt;&gt;'),"]}, {"lines": ["            '<> diamonds & diamonds <>'"]}, {"lines": ["        )", "        assert_equal(", "            sanitize.safe_unescape_html(['&lt;&gt;&amp;'])[0],", "            '<>&'", "        )", "        assert_equal("]}, {"lines": ["            sanitize.safe_unescape_html({'key': '&lt;&gt;&amp;'})['key'],", "            '<>&'"]}, {"lines": ["def migrate(delete, index=None, app=None):", "    index = index or settings.ELASTIC_INDEX"]}, {"lines": ["                        m('p', [ m('b', 'Select Rows:'), m('span', ' Click on a row (outside the name) to show further actions in the toolbar.')]),"]}, {"lines": ["                        Select any other components to which you would like to apply these settings."]}, {"lines": ["", ""]}, {"lines": ["# TODO: Remove safe_unescape_html when mako html safe comes in"]}, {"lines": ["    \"\"\""]}, {"lines": ["    Return data without html escape characters."]}, {"lines": [""]}, {"lines": ["    :param s: A string, dict, or list", "    :return: A string or list or dict without html escape characters"]}, {"lines": ["", "    \"\"\""]}, {"lines": ["    safe_characters = {", "        '&amp;': '&',", "        '&lt;': '<',", "        '&gt;': '>',", "    }"]}, {"lines": ["        return {", "            key: safe_unescape_html(value)"]}, {"lines": ["        }"]}, {"lines": ["        return ["]}, {"lines": ["        ]"]}, {"lines": ["        for escape_sequence, character in safe_characters.items():"]}], "name": "Brandon Purvis"}, {"commits": [{"lines": ["    def test_employment(self):", "        user = UserFactory(fullname='Helga Finn')", "        user.save()", "        institution = 'Finn\\'s Fine Filers'", ""]}, {"lines": ["        assert_equal(len(docs), 0)", "        user.jobs.append({", "            'institution': institution,", "            'title': 'The Big Finn',", "        })", "        user.save()", ""]}, {"lines": ["        assert_equal(len(docs), 1)", "", "    def test_education(self):", "        user = UserFactory(fullname='Henry Johnson')", "        user.save()", "        institution = 'Henry\\'s Amazing School!!!'", ""]}, {"lines": ["        assert_equal(len(docs), 0)", "        user.schools.append({", "            'institution': institution,", "            'degree': 'failed all classes',", "        })", "        user.save()", ""]}, {"lines": ["        assert_equal(len(docs), 1)", ""]}, {"lines": ["    def test_make_parent_private(self):"]}, {"lines": ["        self.project.set_privacy('private')"]}, {"lines": ["        assert_equal(len(docs), 1)", "        assert_equal(docs[0]['parent_title'], '-- private project --')", "        assert_false(docs[0]['parent_url'])", ""]}, {"lines": ["    def test_wrong_order_search(self):", "        title_parts = self.title.split(' ')", "        title_parts.reverse()", "        title_search = ' '.join(title_parts)", ""]}, {"lines": ["        assert_equal(len(docs), 3)", ""]}, {"lines": ["            'title': 'Lover Boy',"]}, {"lines": ["    def test_watch_and_unwatch(self):"]}, {"lines": ["        url = self.project.api_url_for('togglewatch_post')"]}, {"lines": ["        self.app.post_json(url, {}, auth=self.auth)", "        res = self.app.get(self.project.api_url, auth=self.auth)", "        assert_equal(res.json['node']['watched_count'], 1)", "        self.app.post_json(url, {}, auth=self.auth)", "        res = self.app.get(self.project.api_url, auth=self.auth)", "        assert_equal(res.json['node']['watched_count'], 0)"]}, {"lines": ["            'institution': 'an institution',", "            'department': 'a department',", "            'title': 'a title',"]}, {"lines": ["            'ongoing': False,", "        }, {", "            'institution': 'another institution',", "            'department': None,", "            'title': None,"]}, {"lines": ["            'ongoing': True,", "        }]"]}, {"lines": ["        url = api_url_for('unserialize_jobs')", "        self.app.put_json(url, payload, auth=self.user.auth)", "        self.user.reload()", "        assert_equal(len(self.user.jobs), 2)", "        url = api_url_for('serialize_jobs')", "        res = self.app.get(", "            url,", "            auth=self.user.auth,", "        )"]}, {"lines": ["            'institution': 'an institution',", "            'department': 'a department',", "            'degree': 'a degree',"]}, {"lines": ["            'ongoing': False,", "        }, {", "            'institution': 'another institution',", "            'department': None,", "            'degree': None,"]}, {"lines": ["            'ongoing': True,", "        }]"]}, {"lines": ["        url = api_url_for('unserialize_schools')", "        self.app.put_json(url, payload, auth=self.user.auth)", "        self.user.reload()", "        assert_equal(len(self.user.schools), 2)", "        url = api_url_for('serialize_schools')", "        res = self.app.get(", "            url,", "            auth=self.user.auth,", "        )"]}, {"lines": [""]}, {"lines": ["            user.unwatch(watch_config)"]}, {"lines": ["            user.watch(watch_config)"]}, {"lines": ["                    <div class=\"form-group\" data-bind=\"ifnot: ongoing\">"]}, {"lines": ["                    <div class=\"form-group\">", "                        <label>Ongoing</label>", "                        <input type=\"checkbox\" data-bind=\"checked: ongoing, click: clearEnd\"/>", "                    </div>", ""]}, {"lines": ["                    <div class=\"form-group\" data-bind=\"ifnot: ongoing\">"]}, {"lines": ["                    <div class=\"form-group\">", "                        <label>Ongoing</label>", "                        <input type=\"checkbox\" data-bind=\"checked: ongoing, click: clearEnd\"/>", "                    </div>", ""]}, {"lines": ["                        <td>{{ endView }}</td>"]}], "name": "XTech2K"}, {"commits": [{"lines": ["        emails.notify(node._id, 'comments', user=self.user, node=node, timestamp=datetime.datetime.utcnow())"]}, {"lines": ["        emails.notify(node._id, 'comments', user=self.user, node=node, timestamp=datetime.datetime.utcnow())"]}, {"lines": ["        time_now = datetime.datetime.utcnow()", "        emails.notify(self.project._id, 'comments', user=self.user, node=self.node, timestamp=time_now)"]}, {"lines": ["        send.assert_called_with(subscribed_users, 'email_transactional', self.project._id, 'comments', self.user, self.node, time_now)"]}, {"lines": ["        emails.notify(node._id, 'comments', user=user, node=node, timestamp=datetime.datetime.utcnow())"]}, {"lines": ["        time_now = datetime.datetime.utcnow()", "        sent_subscribers = emails.notify(self.project._id, 'comments', user=self.user, node=self.node, timestamp=time_now, target_user=self.project.creator)", "        mock_send.assert_called_with([self.project.creator._id], 'email_transactional', self.project._id, 'comment_replies', self.user, self.node, time_now, target_user=self.project.creator)"]}, {"lines": ["        time_now = datetime.datetime.utcnow()", "        sent_subscribers = emails.notify(self.project._id, 'comments', user=user, node=self.node, timestamp=time_now, target_user=user)", "        mock_send.assert_called_with([self.project.creator._id], 'email_transactional', self.project._id, 'comments', user, self.node, time_now, target_user=user)"]}, {"lines": ["        time_now = datetime.datetime.utcnow()", "        sent_subscribers = emails.notify(self.project._id, 'comments', user=self.project.creator, node=self.project, timestamp=time_now,  target_user=self.project.creator)", "        mock_send.assert_called_with([self.project.creator._id], 'email_transactional', self.project._id, 'comment_replies', self.project.creator, self.project, time_now, target_user=self.project.creator)"]}, {"lines": ["        time_now = datetime.datetime.utcnow()", "        sent_subscribers = emails.notify(self.node._id, 'comments', user, self.node,", "                                         time_now, target_user=user)", "        mock_send.assert_called_with([self.project.creator._id], 'email_transactional', self.node._id, 'comments',", "                                     user, self.node, time_now, target_user=user)"]}, {"lines": ["        time_now = datetime.datetime.utcnow()", "        project = factories.ProjectFactory()", "        emails.check_parent(self.node._id, 'comments', [], self.user, project, time_now)"]}, {"lines": ["        send.assert_called_with([self.project.creator._id], 'email_transactional', self.node._id, 'comments',", "                                self.user, project, time_now)"]}, {"lines": ["        emails.check_parent(node._id, 'comments', [], self.user, project, datetime.datetime.utcnow())"]}, {"lines": ["        emails.check_parent(node._id, 'comments', [], self.user, node, datetime.datetime.utcnow())"]}, {"lines": ["        emails.check_parent(node._id, 'comments', [], user, node, datetime.datetime.utcnow())"]}, {"lines": ["    #                 user=self.project.creator,"]}, {"lines": ["            user=self.project.creator,"]}, {"lines": ["            node=self.project,", "            timestamp=timestamp,"]}, {"lines": ["            user=self.project.creator,"]}, {"lines": ["            user=self.project.creator,"]}, {"lines": ["                            user=self.user,", "                            node=self.project,"]}, {"lines": ["                            user=self.user,"]}, {"lines": ["                            node=self.project,", "                            timestamp=datetime.datetime.utcnow().replace(tzinfo=pytz.utc),"]}, {"lines": ["    def test_manage_permissions_again(self):", "        url = self.project.api_url + 'contributors/manage/'", "        self.app.post_json(", "            url,", "            {", "                'contributors': [", "                    {'id': self.user1._id, 'permission': 'admin',", "                     'registered': True, 'visible': True},", "                    {'id': self.user2._id, 'permission': 'admin',", "                     'registered': True, 'visible': True},", "                ]", "            },", "            auth=self.auth,", "        )", "", "        self.project.reload()", "        self.app.post_json(", "            url,", "            {", "                'contributors': [", "                    {'id': self.user1._id, 'permission': 'admin',", "                     'registered': True, 'visible': True},", "                    {'id': self.user2._id, 'permission': 'read',", "                     'registered': True, 'visible': True},", "                ]", "            },", "            auth=self.auth,", "        )", "", "        self.project.reload()", "", "        assert_equal(self.project.get_permissions(self.user2), ['read'])", "        assert_equal(self.project.get_permissions(self.user1), ['read', 'write', 'admin'])", ""]}, {"lines": ["    'comments': '${user.fullname} commented on \"${title}\".',", "    'comment_replies': '${user.fullname} replied to your comment on \"${title}\".'"]}, {"lines": ["def email_transactional(recipient_ids, uid, event, user, node, timestamp, **context):"]}, {"lines": ["    :param recipient_ids: mod-odm User object ids"]}, {"lines": ["        See notify for specifics"]}, {"lines": ["    context['title'] = node.title"]}, {"lines": ["    context['user'] = user"]}, {"lines": ["    for user_id in recipient_ids:"]}, {"lines": ["        recipient = website_models.User.load(user_id)", "        email = recipient.username"]}, {"lines": ["        context['localized_timestamp'] = localize_timestamp(timestamp, recipient)"]}, {"lines": ["        if user._id != recipient._id:"]}, {"lines": ["                name=recipient.fullname,", "                node_id=node._id,", "                node_title=node.title,"]}, {"lines": ["                url=get_settings_url(uid, recipient)"]}, {"lines": ["def email_digest(recipient_ids, uid, event, user, node, timestamp, **context):"]}, {"lines": ["    context['user'] = user"]}, {"lines": ["    for user_id in recipient_ids:"]}, {"lines": ["        recipient = website_models.User.load(user_id)"]}, {"lines": ["        context['localized_timestamp'] = localize_timestamp(timestamp, recipient)"]}, {"lines": ["        if user._id != recipient._id:"]}, {"lines": ["                timestamp=timestamp,"]}, {"lines": ["                user_id=recipient._id,"]}, {"lines": ["def notify(uid, event, user, node, timestamp, **context):"]}, {"lines": ["    \"\"\""]}, {"lines": ["    :param uid: node's id", "    :param event: type of notification"]}, {"lines": ["    :param user: user \"sending\" notification"]}, {"lines": ["    :param node: the node", "    :param timestamp: time", "    :param context: optional variables specific to templates", "        target_user: used with comment_replies"]}, {"lines": ["    :return:", "    \"\"\""]}, {"lines": ["                for recipient in subscribed_users:", "                    event = 'comment_replies' if context.get('target_user') == recipient else event"]}, {"lines": ["                    send([recipient._id], notification_type, uid, event, user, node, timestamp, **context)"]}, {"lines": ["    return check_parent(uid, event, node_subscribers, user, node, timestamp, **context)"]}, {"lines": ["def check_parent(uid, event, node_subscribers, user, orig_node, timestamp, **context):"]}, {"lines": ["            return check_parent(node.parent_id, event, node_subscribers, user, orig_node, timestamp, **context)"]}, {"lines": ["                        send([u._id], notification_type, uid, event, user, orig_node, timestamp, **context)"]}, {"lines": ["        return check_parent(node.parent_id, event, node_subscribers, user, orig_node, timestamp, **context)"]}, {"lines": ["def send(recipient_ids, notification_type, uid, event, user, node, timestamp, **context):"]}, {"lines": ["            recipient_ids=recipient_ids,"]}, {"lines": ["            user=user,", "            node=node,", "            timestamp=timestamp,"]}, {"lines": ["        //list of permission objects for select."]}, {"lines": ["        self.permissionList = [", "            {value: 'read', text: 'Read'},", "            {value: 'write', text: 'Read + Write'},", "            {value: 'admin', text: 'Administrator'}", "        ];", ""]}, {"lines": ["        var self = this;"]}, {"lines": ["        data.permission = ko.observable(self.permissionList[1]); //default permission write"]}, {"lines": ["                users: ko.utils.arrayMap(self.selection(), function(user) {"]}, {"lines": ["                    var permission = user.permission().value; //removes the value from the object", "                    var tUser = JSON.parse(ko.toJSON(user)); //The serialized user minus functions", "                    tUser.permission = permission; //shoving the permission value into permission", "                    return tUser; //user with simplified permissions"]}, {"lines": ["/* maps js data one deep to observables", "    options:", "        exclude: adds listed parameters without making observable", "*/"]}, {"lines": ["var mapJStoKO = function(data, options) {", "    var settings = $.extend({", "        exclude: []   //List of object parameters to exclude", "    }, options || {});", "    var dataOut = {};", "", "    for (var key in data) {", "        // checks for key, if in the exclude list", "        if (data.hasOwnProperty(key) && $.inArray(key, settings.exclude) === -1) {", "            if(Array.isArray(data[key])) {", "                dataOut[key] = ko.observableArray(data[key]);", "            } else {", "                dataOut[key] = ko.observable(data[key]);", "            }", "        } else if (data.hasOwnProperty(key)) {"]}, {"lines": ["            dataOut[key] = data[key]; //excluded parameters"]}, {"lines": ["        }", "    }", "    return dataOut;", "};", ""]}, {"lines": ["    sanitizedObservable: sanitizedObservable,", "    mapJStoKO: mapJStoKO"]}, {"lines": ["${user} replied to your comment \"${parent_comment}\" on your project \"${title}\": \"${content}\"."]}, {"lines": ["${user} at ${localized_timestamp}: \"${content}\"."]}, {"lines": ["                                            <select class=\"form-control\" data-bind=\""]}, {"lines": ["                                                options: $root.permissionList,"]}, {"lines": ["                                                value: permission,"]}, {"lines": ["                                                optionsText: 'text'\">", "                                            </select>"]}], "name": "Bryan Gorges"}, {"commits": [{"lines": ["from website.profile.views import fmt_date_or_none"]}, {"lines": ["    def test_fmt_date_or_none(self):", "        with assert_raises(HTTPError) as cm:", "            #enter a date before 1900", "            fmt_date_or_none(dt.datetime(1890, 10, 31, 18, 23, 29, 227))", "        # error should be raised because date is before 1900", "        assert_equal(cm.exception.code, http.BAD_REQUEST)", ""]}, {"lines": ["from .badges import Badge, BadgeAssertion  # noqa", "from .settings import BadgesUserSettings, BadgesNodeSettings  # noqa"]}, {"lines": ["from . import crud, openbadge, render  # noqa"]}, {"lines": ["        self.get_hgrid_data = get_hgrid_data  # if has_hgrid_files and not get_hgrid_data rubeus.make_dummy()"]}, {"lines": ["from .defaults import *  # noqa"]}, {"lines": ["    from .local import *  # noqa"]}, {"lines": ["        res = requests.get(os.path.join(figshare_settings.API_URL, 'articles', str(article)))"]}, {"lines": ["        'view': True"]}, {"lines": ["        o['addon'] = 'figshare'"]}, {"lines": ["            'urls': {"]}, {"lines": ["        'urls': urls,"]}, {"lines": ["            <a data-bind=\"attr.href: url\" target=\"_blank\">{{ linkDisplay }}</a>."]}, {"lines": ["from . import config, widget  # noqa"]}, {"lines": ["from github3 import GitHubError  # noqa"]}, {"lines": ["class ApiError(Exception):", "    pass", "", "", "class NotFoundError(ApiError):", "    pass", "", "", "class EmptyRepoError(ApiError):", "    pass", "", "", "class TooBigError(ApiError):"]}, {"lines": ["from .defaults import *  # noqa"]}, {"lines": ["    from .local import *  # noqa"]}, {"lines": ["    # Can set limit to only receive a specified number of contributors in a call to this route"]}, {"lines": ["    if request.args.get('limit'):", "        try:", "            limit = int(request.args['limit'])", "        except ValueError:", "            raise HTTPError(http.BAD_REQUEST, data=dict(", "                message_long='Invalid value for \"limit\": {}'.format(request.args['limit'])", "            ))", "    else:", "        limit = None"]}, {"lines": [""]}, {"lines": ["    # Limit is either an int or None:", "    # if int, contribs list is sliced to specified length", "    # if None, contribs list is not sliced"]}, {"lines": ["        node.visible_contributors[0:limit],"]}, {"lines": ["    # Will either return just contributor list or contributor list + 'more' element"]}, {"lines": ["    if limit:", "        return {", "            'contributors': contribs,", "            'more': max(0, len(node.visible_contributors) - limit)", "        }", "    else:", "        return {'contributors': contribs}"]}, {"lines": [""]}, {"lines": ["    <meta name=\"og:image\" content=\"http://centerforopenscience.org/static/img/cos_center_logo_small.png\"/>"]}, {"lines": ["    <meta name=\"og:title\" content=\"${self.title()}\"/>", "    <meta name=\"og:ttl\" content=\"3\"/>", "    <meta name=\"og:description\" content=\"${self.og_description()}\"/>", ""]}, {"lines": ["<%def name=\"og_description()\">", "    Hosted on the Open Science Framework", "</%def>", ""]}, {"lines": ["<script type=\"text/html\" id=\"project_deleted\">"]}, {"lines": ["<span class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle\"></span>", "</script>", ""]}, {"lines": ["<span class=\"log-node-title-link overflow\" data-bind=\"text: nodeTitle\"></span>"]}, {"lines": ["as contributor(s) to"]}, {"lines": ["                        <th>Start&nbsp;Date</th>", "                        <th>End&nbsp;Date</th>"]}, {"lines": ["<%def name=\"og_description()\">"]}, {"lines": ["    %if node['description']:"]}, {"lines": ["    %endif", "    Hosted on the Open Science Framework"]}, {"lines": ["</%def>"]}, {"lines": ["<h3>How much does the OSF service cost?</h3><p>It's free!</p>"]}, {"lines": ["<h3>How can it be free? How are you funded?</h3><p>OSF is"]}, {"lines": ["    organization. COS is supported through grants from a variety of supporters,", "    including <a href=\"http://centerforopenscience.org/about_sponsors/\">", "    federal agencies, private foundations, and commercial entities</a>.</p>"]}, {"lines": ["    designs, materials, and data. OSF facilitates sharing of materials and data", "    within a laboratory or across laboratories. OSF also facilitates transparency of", "    laboratory research and provides a network design that details and credits"]}, {"lines": ["    your project collaborators have access to them.</p>"]}, {"lines": ["    advance of data analysis or confirms the exact state of the project at", "    important points of the lifecycle, such as manuscript submission or the"]}, {"lines": ["    password. When you click \"Forgot your password,\" OSF sends you a new random", "    password because it neither stores nor has the ability to compute your password.</p>"]}, {"lines": ["<p>Data and materials posted on OSF are not yet encrypted, unless you encrypt"]}], "name": "Cailey Fitzgerald"}, {"commits": [{"lines": [""]}, {"lines": ["    var absoluteUrl = '${node['display_absolute_url']}';"]}], "name": "AzeemMufti"}, {"commits": [{"lines": ["        user3 = UserFactory()"]}, {"lines": ["        assert_in(user2._id, project.contributors)"]}, {"lines": ["        assert_equal(len(project.contributors), 3)"]}, {"lines": ["        # Manually reset log date to 100 days ago so it won't show up in feed", "        self.project.logs[0].date = dt.datetime.utcnow() - dt.timedelta(days=100)", "        self.project.logs[0].save()"]}, {"lines": ["        self.last_log = self.project.add_log("]}, {"lines": ["            save=True,"]}, {"lines": ["        )"]}, {"lines": ["                                 params={\"digest\": True},", "                                 auth=self.auth)"]}, {"lines": ["from .model import AddonDataverseUserSettings, AddonDataverseNodeSettings, \\", "    DataverseFile"]}, {"lines": ["import views"]}, {"lines": [""]}, {"lines": ["MODELS = [AddonDataverseNodeSettings, AddonDataverseUserSettings, DataverseFile]"]}, {"lines": ["USER_SETTINGS_MODEL = AddonDataverseUserSettings", "NODE_SETTINGS_MODEL = AddonDataverseNodeSettings", ""]}, {"lines": ["", "SHORT_NAME = 'dataverse'", "FULL_NAME = 'Dataverse'", "", "OWNERS = ['user', 'node']", ""]}, {"lines": ["ADDED_DEFAULT = []", "ADDED_MANDATORY = []"]}, {"lines": [""]}, {"lines": ["CONFIGS = ['user', 'node']", "", "CATEGORIES = ['storage']", "", "INCLUDE_JS = {"]}, {"lines": ["    'widget': [],"]}, {"lines": ["    'page': [],"]}, {"lines": ["}", "", "INCLUDE_CSS = {"]}, {"lines": ["    'page': [],"]}, {"lines": ["}"]}, {"lines": ["", "HAS_HGRID_FILES = True"]}, {"lines": ["GET_HGRID_DATA = views.hgrid.dataverse_hgrid_root"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from framework.auth.decorators import Auth"]}, {"lines": [""]}, {"lines": ["class DataverseFile(GuidFile):", ""]}, {"lines": ["    file_id = fields.StringField(required=True, index=True)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["class AddonDataverseUserSettings(AddonUserSettingsBase):", ""]}, {"lines": [""]}, {"lines": ["    @property", "    def has_auth(self):"]}, {"lines": [""]}, {"lines": ["    def delete(self, save=True):"]}, {"lines": ["        self.clear()"]}, {"lines": ["        super(AddonDataverseUserSettings, self).delete(save)"]}, {"lines": ["", "    def clear(self):"]}, {"lines": ["        \"\"\"Clear settings and deauthorize any associated nodes.", "", "        :param bool delete: Indicates if the settings should be deleted.", "        \"\"\""]}, {"lines": ["        for node_settings in self.addondataversenodesettings__authorized:"]}, {"lines": ["            node_settings.deauthorize(Auth(self.owner))", "            node_settings.save()", "        return self", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    dataverse_alias = fields.StringField()"]}, {"lines": ["    dataverse = fields.StringField()"]}, {"lines": [""]}, {"lines": ["    user_settings = fields.ForeignField(", "        'addondataverseusersettings', backref='authorized'", "    )", ""]}, {"lines": ["    @property"]}, {"lines": ["", "    @property"]}, {"lines": ["    def has_auth(self):", "        \"\"\"Whether a dataverse account is associated with this node.\"\"\"", "        return bool(self.user_settings and self.user_settings.has_auth)", ""]}, {"lines": ["    def delete(self, save=True):", "        self.deauthorize(add_log=False)", "        super(AddonDataverseNodeSettings, self).delete(save)"]}, {"lines": [""]}, {"lines": ["    def set_user_auth(self, user_settings):", "        node = self.owner", "        self.user_settings = user_settings", "        node.add_log(", "            action='dataverse_node_authorized',", "            auth=Auth(user_settings.owner),", "            params={"]}, {"lines": ["                'project': node.parent_id,", "                'node': node._primary_key,", "            }", "        )", ""]}, {"lines": ["    def deauthorize(self, auth=None, add_log=True):"]}, {"lines": ["        \"\"\"Remove user authorization from this node and log the event.\"\"\""]}, {"lines": ["        self.dataverse_alias = None"]}, {"lines": ["        self.dataverse = None"]}, {"lines": ["        self.user_settings = None"]}, {"lines": [""]}, {"lines": ["        if add_log:", "            node = self.owner", "            self.owner.add_log(", "                action='dataverse_node_deauthorized',", "                params={", "                    'project': node.parent_id,", "                    'node': node._id,", "                },", "                auth=auth,", "            )"]}, {"lines": [""]}, {"lines": ["    ##### Callback overrides #####", "", "    # Note: Registering Dataverse content is disabled for now"]}, {"lines": ["", "    def before_fork_message(self, node, user):", "        \"\"\"Return warning text to display if user auth will be copied to a", "        fork.", "        \"\"\"", "        category = node.project_or_component", "        if self.user_settings and self.user_settings.owner == user:", "            return ('Because you have authorized the Dataverse add-on for this '", "                '{category}, forking it will also transfer your authentication '", "                'to the forked {category}.').format(category=category)", "", "        else:", "            return ('Because the Dataverse add-on has been authorized by a different '", "                    'user, forking it will not transfer authentication to the forked '", "                    '{category}.').format(category=category)", "", "    # backwards compatibility", "    before_fork = before_fork_message", "", "    def before_remove_contributor_message(self, node, removed):", "        \"\"\"Return warning text to display if removed contributor is the user", "        who authorized the Dataverse addon", "        \"\"\"", "        if self.user_settings and self.user_settings.owner == removed:", "            category = node.project_or_component", "            name = removed.fullname", "            return ('The Dataverse add-on for this {category} is authenticated by {name}. '", "                    'Removing this user will also remove write access to Dataverse '", "                    'unless another contributor re-authenticates the add-on.'", "                    ).format(**locals())", "", "    # backwards compatibility", "    before_remove_contributor = before_remove_contributor_message", "", "    # Note: Registering Dataverse content is disabled for now", "    # def after_register(self, node, registration, user, save=True):", "    #     \"\"\"After registering a node, copy the user settings and save the", "    #     chosen folder.", "    #", "    #     :return: A tuple of the form (cloned_settings, message)", "    #     \"\"\"", "    #     clone, message = super(AddonDataverseNodeSettings, self).after_register(", "    #         node, registration, user, save=False", "    #     )", "    #     # Copy user_settings and add registration data", "    #     if self.has_auth and self.folder is not None:", "    #         clone.user_settings = self.user_settings", "    #         clone.registration_data['folder'] = self.folder", "    #     if save:", "    #         clone.save()", "    #     return clone, message", "", "    def after_fork(self, node, fork, user, save=True):", "        \"\"\"After forking, copy user settings if the user is the one who authorized", "        the addon.", "", "        :return: A tuple of the form (cloned_settings, message)", "        \"\"\"", "        clone, _ = super(AddonDataverseNodeSettings, self).after_fork(", "            node=node, fork=fork, user=user, save=False", "        )", "", "        if self.user_settings and self.user_settings.owner == user:", "            clone.user_settings = self.user_settings"]}, {"lines": ["        else:"]}, {"lines": ["        if save:", "            clone.save()", "        return clone, message", ""]}, {"lines": ["        \"\"\"If the removed contributor was the user who authorized the Dataverse", "        addon, remove the auth credentials from this node.", "        Return the message text that will be displayed to the user.", "        \"\"\"", "        if self.user_settings and self.user_settings.owner == removed:", "            self.user_settings = None", "            self.save()"]}, {"lines": ["import logging"]}, {"lines": [""]}, {"lines": ["try:"]}, {"lines": ["except ImportError as error:"]}, {"lines": ["/**"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            }"]}, {"lines": ["            }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            }"]}, {"lines": [""]}, {"lines": ["        }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["            }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["## Template for the \"Dataverse\" section in the \"Configure Add-ons\" panel"]}, {"lines": [""]}, {"lines": ["<div id='dataverseAddonScope' class='addon-settings scripted'>"]}, {"lines": [""]}, {"lines": ["    <h4 class=\"addon-title\">", "        Dataverse", "        <span data-bind=\"if: showDeleteAuth\">", "            <small class=\"authorized-by\">"]}, {"lines": ["            </small>", "        </span>", "    </h4>"]}, {"lines": [""]}, {"lines": ["    <!-- Enter Credentials -->"]}, {"lines": ["    <form data-bind=\"if: showInputCredentials\">"]}, {"lines": ["        </div>"]}, {"lines": ["        <div class=\"form-group\">"]}, {"lines": ["        </div>", "        <button data-bind=\"click: sendAuth\" class=\"btn btn-success\">", "            Submit", "        </button>", "    </form>", "", "    <!-- Flashed Messages -->", "    <div class=\"help-block\">", "        <p data-bind=\"html: message, attr: {class: messageClass}\"></p>", "    </div>", "</div>"]}, {"lines": [""]}, {"lines": ["<script type=\"text/html\" id=\"dataverse_file_added\">", "added file"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>"]}, {"lines": ["</script>", "", "<script type=\"text/html\" id=\"dataverse_file_removed\">"]}, {"lines": ["removed file <span class=\"overflow\">{{ params.filename }}</span> from"]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>"]}, {"lines": ["</script>", ""]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>"]}, {"lines": ["</script>"]}, {"lines": [""]}, {"lines": ["<a class=\"log-node-title-link overflow\" data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>"]}, {"lines": ["</script>", ""]}, {"lines": ["<a class=\"log-node-title-link overflow\"", "    data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>", "</script>", ""]}, {"lines": ["<a class=\"log-node-title-link overflow\"", "    data-bind=\"attr: {href: nodeUrl}\">{{ nodeTitle }}</a>"]}, {"lines": ["from nose.tools import *", "import mock"]}, {"lines": ["import unittest"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from website.addons.dataverse.tests.utils import DataverseAddonTestCase"]}, {"lines": ["from website.addons.dataverse.model import AddonDataverseUserSettings"]}, {"lines": ["", "", "class TestClient(DataverseAddonTestCase):", ""]}, {"lines": ["    def setUp(self):"]}, {"lines": ["        self.mock_connection = mock.create_autospec(Connection)"]}, {"lines": ["        self.mock_dataverse = mock.create_autospec(Dataverse)"]}, {"lines": ["        self.mock_file = mock.create_autospec(DataverseFile)"]}, {"lines": [""]}, {"lines": ["        self.mock_dataverse.connection = self.mock_connection"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.dataverse.client.Connection')"]}, {"lines": [""]}, {"lines": ["        assert_true(c)", ""]}, {"lines": ["    @mock.patch('website.addons.dataverse.client.Connection')"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.dataverse.client.Connection')"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        assert_true(c)", ""]}, {"lines": ["    @mock.patch('website.addons.dataverse.client.Connection')"]}, {"lines": ["        with assert_raises(HTTPError) as cm:"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    def test_connect_from_settings(self, mock_connect):", "        user_settings = AddonDataverseUserSettings()"]}, {"lines": [""]}, {"lines": ["        connection = connect_from_settings(user_settings)", "        assert_true(connection)"]}, {"lines": [""]}, {"lines": ["        user_settings = AddonDataverseUserSettings()"]}, {"lines": [""]}, {"lines": ["        assert_true(connection)"]}, {"lines": [""]}, {"lines": ["    @mock.patch('website.addons.dataverse.client.Connection')"]}, {"lines": ["        user_settings = AddonDataverseUserSettings()"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        )"]}, {"lines": [""]}, {"lines": ["    def test_get_files(self):"]}, {"lines": ["        ]", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        with assert_raises(HTTPError) as e:"]}, {"lines": [""]}, {"lines": ["        assert_equal(e.exception.code, 410)"]}, {"lines": [""]}, {"lines": ["        error = UnicodeDecodeError('utf-8', b'', 1, 2, 'jeepers')"]}, {"lines": [""]}, {"lines": ["        with assert_raises(HTTPError) as e:"]}, {"lines": ["        assert_equal(e.exception.code, 406)"]}, {"lines": ["", "    def test_get_dataverses(self):"]}, {"lines": ["        self.mock_connection.get_dataverses.return_value = ["]}, {"lines": ["        ]", "", "        dvs = get_dataverses(self.mock_connection)", "        self.mock_connection.get_dataverses.assert_called_once_with()", ""]}, {"lines": ["", "    def test_get_dataverse(self):"]}, {"lines": ["        self.mock_connection.get_dataverse.return_value = self.mock_dataverse", "", "        d = get_dataverse(self.mock_connection, 'ALIAS')", "        self.mock_connection.get_dataverse.assert_called_once_with('ALIAS')", "", "        assert_equal(d, self.mock_dataverse)", ""]}, {"lines": ["        self.mock_connection.get_dataverse.return_value = self.mock_dataverse", "", "        d = get_dataverse(self.mock_connection, 'ALIAS')", "        self.mock_connection.get_dataverse.assert_called_once_with('ALIAS')", ""]}, {"lines": ["from nose.tools import *"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "class TestUtils(DataverseAddonTestCase):", "", "    def test_mock_connection(self):"]}, {"lines": ["        mock_connection = create_mock_connection()"]}, {"lines": ["        assert_equal(len(mock_connection.get_dataverses()), 3)"]}, {"lines": ["        assert_is_instance(mock_connection.get_dataverses()[0], Dataverse)"]}, {"lines": ["        assert_equal("]}, {"lines": ["            mock_connection.get_dataverse(mock_connection.get_dataverses()[1].alias),", "            mock_connection.get_dataverses()[1],"]}, {"lines": ["        )", ""]}, {"lines": ["    def test_mock_dataverse(self):", "        mock_dv = create_mock_dataverse('Example 1')", "        assert_equal(mock_dv.title, 'Example 1')"]}, {"lines": ["        assert_equal(mock_dv.alias, 'ALIAS1')"]}, {"lines": [""]}, {"lines": ["", "    def test_mock_dvn_file(self):", "        fid = '65432'"]}, {"lines": ["        mock_file = create_mock_draft_file(fid)"]}, {"lines": ["        assert_equal(mock_file.name, 'file.txt')", "        assert_equal(mock_file.id, fid)"]}, {"lines": ["        assert_is_instance(mock_file, DataverseFile)"]}, {"lines": [""]}, {"lines": ["import mock"]}, {"lines": ["", "from webtest_plus import TestApp"]}, {"lines": [""]}, {"lines": ["from website.addons.base.testing import AddonTestCase"]}, {"lines": [""]}, {"lines": ["", "class DataverseAddonTestCase(AddonTestCase):", "    ADDON_SHORT_NAME = 'dataverse'", "", "    def create_app(self):", "        return TestApp(app)", "", "    def set_user_settings(self, settings):"]}, {"lines": ["", "    def set_node_settings(self, settings):"]}, {"lines": ["        settings.dataverse_alias = 'ALIAS2'"]}, {"lines": ["        settings.dataverse = 'Example 2'"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    \"\"\"", "    Create a mock dataverse connection.", "", "    Pass any credentials other than the default parameters and the connection"]}, {"lines": ["    \"\"\""]}, {"lines": [""]}, {"lines": ["    mock_connection = mock.create_autospec(Connection)"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    mock_connection.get_dataverses.return_value = [", "        create_mock_dataverse('Example 1'),", "        create_mock_dataverse('Example 2'),"]}, {"lines": ["    ]"]}, {"lines": [""]}, {"lines": ["    def _get_dataverse(alias):"]}, {"lines": ["        return next(("]}, {"lines": ["            dataverse for dataverse in mock_connection.get_dataverses()"]}, {"lines": ["            if alias is not None and dataverse.title[-1] == alias[-1]), None"]}, {"lines": ["        )", "", "    mock_connection.get_dataverse = mock.MagicMock(", "        side_effect=_get_dataverse", "    )", "    mock_connection.get_dataverse.return_value = create_mock_dataverse()", ""]}, {"lines": ["", ""]}, {"lines": ["def create_mock_dataverse(title='Example Dataverse 0'):"]}, {"lines": ["", "    mock_dataverse = mock.create_autospec(Dataverse)", "", "    type(mock_dataverse).title = mock.PropertyMock(return_value=title)"]}, {"lines": ["    type(mock_dataverse).alias = mock.PropertyMock("]}, {"lines": ["        return_value='ALIAS{}'.format(title[-1])", "    )"]}, {"lines": [""]}, {"lines": ["    ]", ""]}, {"lines": ["        return next(("]}, {"lines": ["        )", ""]}, {"lines": ["    )"]}, {"lines": ["", "    return mock_dataverse", "", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    # Fail if not given a valid ID", "    if 'DVN' in id:"]}, {"lines": [""]}, {"lines": ["def create_mock_draft_file(id='54321'):", "    mock_file = mock.create_autospec(DataverseFile)"]}, {"lines": ["", "    mock_file.name = 'file.txt'"]}, {"lines": ["    mock_file.id = id"]}, {"lines": [""]}, {"lines": ["    return mock_file"]}, {"lines": [""]}, {"lines": ["    mock_file = mock.create_autospec(DataverseFile)"]}, {"lines": [""]}, {"lines": ["    mock_file.id = id"]}, {"lines": ["", "    return mock_file", ""]}, {"lines": ["mock_responses = {", "    'contents': {", "        u'kind': u'item',", "        u'name': u'file.txt',", "        u'ext': u'.txt',", "        u'file_id': u'54321',", "        u'urls': {u'download': u'/project/xxxxx/dataverse/file/54321/download/',", "                 u'delete': u'/api/v1/project/xxxxx/dataverse/file/54321/',", "                 u'view': u'/project/xxxxx/dataverse/file/54321/'},", "        u'permissions': {u'edit': False, u'view': True},"]}, {"lines": ["    }"]}, {"lines": ["import httplib as http"]}, {"lines": [""]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from framework.auth.decorators import must_be_logged_in"]}, {"lines": ["from website.project import decorators"]}, {"lines": ["from website.util import api_url_for"]}, {"lines": ["", "", "@decorators.must_be_contributor", "@decorators.must_have_addon('dataverse', 'node')"]}, {"lines": ["def deauthorize_dataverse(*args, **kwargs):"]}, {"lines": [""]}, {"lines": ["    node_settings = kwargs['node_addon']"]}, {"lines": ["    auth = kwargs['auth']"]}, {"lines": [""]}, {"lines": ["    node_settings.deauthorize(auth)"]}, {"lines": ["    node_settings.save()"]}, {"lines": ["", "    return {}", "", "", "@decorators.must_have_addon('dataverse', 'user')", "def dataverse_delete_user(*args, **kwargs):", ""]}, {"lines": ["    user_settings = kwargs['user_addon']"]}, {"lines": [""]}, {"lines": ["    user_settings.clear()"]}, {"lines": ["    user_settings.save()"]}, {"lines": [""]}, {"lines": ["    return {}", ""]}, {"lines": [""]}, {"lines": ["@must_be_logged_in", "@decorators.must_have_addon('dataverse', 'user')", "def dataverse_user_config_get(user_addon, auth, **kwargs):", "    \"\"\"View for getting a JSON representation of the logged-in user's", "    Dataverse user settings.", "    \"\"\""]}, {"lines": ["    try:"]}, {"lines": ["    except HTTPError as error:"]}, {"lines": ["            connection = None", "        else:", "            raise"]}, {"lines": ["", "    urls = {", "        'create': api_url_for('dataverse_set_user_config'),"]}, {"lines": ["        'delete': api_url_for('dataverse_delete_user'),"]}, {"lines": ["    }", "    return {", "        'result': {", "            'connected': connection is not None,", "            'userHasAuth': user_addon.has_auth,"]}, {"lines": ["            'urls': urls", "        },"]}, {"lines": ["import logging"]}, {"lines": ["from framework.exceptions import HTTPError"]}, {"lines": ["from website.project.decorators import must_have_permission"]}, {"lines": ["from website.project.decorators import must_not_be_registration", "from website.project.decorators import must_have_addon"]}, {"lines": [""]}, {"lines": ["logger = logging.getLogger(__name__)"]}, {"lines": [""]}, {"lines": ["", "@must_have_permission('write')", "@must_not_be_registration", "@must_have_addon('dataverse', 'node')"]}, {"lines": [""]}, {"lines": ["    node = node_addon.owner", "    user_settings = node_addon.user_settings"]}, {"lines": ["", "    now = datetime.datetime.utcnow()", ""]}, {"lines": ["    try:"]}, {"lines": ["    except HTTPError as error:"]}, {"lines": ["            connection = None", "        else:", "            raise", "", "    dataverse = get_dataverse(connection, node_addon.dataverse_alias)"]}, {"lines": [""]}, {"lines": ["", "    # Add a log", "    node.add_log("]}, {"lines": ["        params={", "            'project': node.parent_id,", "            'node': node._primary_key,"]}, {"lines": ["        },", "        auth=auth,", "        log_date=now,", "    )", ""]}, {"lines": ["import httplib as http", ""]}, {"lines": ["from website.addons.dataverse.settings import HOST", "from website.project.decorators import must_be_contributor_or_public, \\", "    must_have_addon", "", "", "@must_be_contributor_or_public", "@must_have_addon('dataverse', 'node')", "def dataverse_widget(node_addon, **kwargs):", "", "    node = node_addon.owner", "    widget_url = node.api_url_for('dataverse_get_widget_contents')", ""]}, {"lines": ["        'widget_url': widget_url,", "    }"]}, {"lines": [""]}, {"lines": ["", "", "@must_be_contributor_or_public", "@must_have_addon('dataverse', 'node')", "def dataverse_get_widget_contents(node_addon, **kwargs):", ""]}, {"lines": ["    data = {", "        'connected': False,", "    }", ""]}, {"lines": ["        return {'data': data}, http.OK", ""]}, {"lines": ["    alias = node_addon.dataverse_alias", ""]}, {"lines": ["    dataverse = get_dataverse(connection, alias)"]}, {"lines": [""]}, {"lines": ["        return {'data': data}, http.BAD_REQUEST", ""]}, {"lines": [""]}, {"lines": ["    data.update({", "        'connected': True,"]}, {"lines": ["        'dataverse': node_addon.dataverse,", "        'dataverseUrl': dataverse_url,"]}, {"lines": ["        'doi': doi,"]}, {"lines": ["    })"]}, {"lines": ["<a class=\"log-node-title-link overflow\""]}, {"lines": ["        assert_true(user_settings.deleted)", "", "    def test_delete_clears_associated_node_settings(self):", "        node_settings = DropboxNodeSettingsFactory.build()", "        user_settings = DropboxUserSettingsFactory()", "        node_settings.user_settings = user_settings", "        node_settings.save()", ""]}, {"lines": ["        user_settings.delete()", "        user_settings.save()", "", "        # Node settings no longer associated with user settings", "        assert_is(node_settings.user_settings, None)", "        assert_is(node_settings.folder, None)", "        assert_false(node_settings.deleted)"]}, {"lines": ["    def test_delete(self):", "        assert_true(self.node_settings.user_settings)", "        assert_true(self.node_settings.folder)", "        old_logs = self.project.logs", "        self.node_settings.delete()", "        self.node_settings.save()", "        assert_is(self.node_settings.user_settings, None)", "        assert_is(self.node_settings.folder, None)", "        assert_true(self.node_settings.deleted)", "        assert_equal(self.project.logs, old_logs)", ""]}, {"lines": ["        assert_equal(log_params['folder'], node_settings.folder)"]}, {"lines": ["        clone, message = self.node_settings.after_fork(", "            node=self.project, fork=fork, user=user,", "            save=True", "        )", "        # need request context for url_for", "        assert_is(clone.user_settings, None)"]}, {"lines": ["        message = self.node_settings.after_remove_contributor("]}, {"lines": ["from website.util import api_url_for, web_url_for"]}, {"lines": ["from tests.base import OsfTestCase, assert_is_redirect"]}, {"lines": ["from website.addons.dropbox.views.hgrid import dropbox_addon_folder"]}, {"lines": ["        url = api_url_for('dropbox_oauth_start_user')"]}, {"lines": ["    @mock.patch('website.addons.dropbox.views.auth.get_client_from_user_settings')", "    def test_dropbox_oauth_finish(self, mock_get, mock_finish):", "        mock_client = mock.MagicMock()", "        mock_client.account_info.return_value = {'display_name': 'Mr. Drop Box'}", "        mock_get.return_value = mock_client"]}, {"lines": ["        url = api_url_for('dropbox_oauth_finish')"]}, {"lines": ["        url = api_url_for('dropbox_oauth_delete_user')"]}, {"lines": ["        url = api_url_for('dropbox_user_config_get')"]}, {"lines": ["        url = api_url_for('dropbox_user_config_get')"]}, {"lines": ["        assert_equal(urls['delete'], api_url_for('dropbox_oauth_delete_user'))", "        assert_equal(urls['create'], api_url_for('dropbox_oauth_start_user'))"]}, {"lines": ["        urls = result['urls']", "", "        assert_equal(urls['config'], self.project.api_url_for('dropbox_config_put'))", "        assert_equal(urls['deauthorize'], self.project.api_url_for('dropbox_deauthorize'))", "        assert_equal(urls['auth'], self.project.api_url_for('dropbox_oauth_start'))", "        assert_equal(urls['importAuth'], self.project.api_url_for('dropbox_import_user_auth'))"]}, {"lines": ["        # Includes endpoint for fetching folders only", "        # NOTE: Querystring params are in camelCase", "        assert_equal(urls['folders'],"]}, {"lines": ["        expected_result = serialize_settings(self.node_settings, self.user,"]}, {"lines": ["    def test_dropbox_addon_folder_if_folder_is_none(self):", "        # Something is returned on normal circumstances", "        root = dropbox_addon_folder(", "            node_settings=self.node_settings, auth=self.user.auth)", "        assert_true(root)", "", "        # Nothing is returned when there is no folder linked", "        self.node_settings.folder = None", "        self.node_settings.save()", "        root = dropbox_addon_folder(", "            node_settings=self.node_settings, auth=self.user.auth)", "        assert_is_none(root)", ""]}, {"lines": ["        url = self.project.api_url_for('dropbox_hgrid_data_contents')"]}, {"lines": ["        url = self.project.api_url_for('dropbox_hgrid_data_contents',", "            path='foo bar')"]}, {"lines": ["    client = get_client_from_user_settings(user_settings)"]}, {"lines": ["    user_settings.dropbox_info = client.account_info()"]}, {"lines": ["    info = user_addon.dropbox_info"]}, {"lines": ["            'dropboxName': info['display_name'] if info else None,"]}, {"lines": ["    if not node_settings.has_auth or not node_settings.folder:"]}, {"lines": ["    <h4 class=\"addon-title\">"]}, {"lines": ["        <small class=\"authorized-by\">", "            % if authorized:", "                    authorized"]}, {"lines": ["            % else:"]}, {"lines": ["                <a id=\"figshareAddKey\" class=\"text-primary pull-right addon-auth\">"]}, {"lines": ["                    Create Access Token", "                </a>", "            % endif", "        </small>"]}, {"lines": ["    </h4>"]}, {"lines": ["    # TODO: Test", "    def starball(self, user, repo, archive='tar', ref='master'):"]}, {"lines": ["        # github3 archive method writes file to disk", "        repository = self.repo(user, repo)", "        url = repository._build_url(archive + 'ball', ref, base_url=repository._api)", "        resp = repository._get(url, allow_redirects=True, stream=True)", "", "        return resp.headers, resp.content"]}, {"lines": ["    <h4 class=\"addon-title\">", "        GitHub"]}, {"lines": ["        <small class=\"authorized-by\">", "            % if authorized:", "                    authorized by", "                    <a href=\"https://github.com/${authorized_github_user}\" target=\"_blank\">", "                        ${authorized_github_user}", "                    </a>"]}, {"lines": ["                <a id=\"githubDelKey\" class=\"text-danger pull-right addon-auth\">Delete Access Token</a>"]}, {"lines": ["            % else:"]}, {"lines": ["                <a id=\"githubAddKey\" class=\"text-primary pull-right addon-auth\">"]}, {"lines": ["                    Create Access Token"]}, {"lines": ["                </a>"]}, {"lines": ["            % endif", "        </small>"]}, {"lines": ["    </h4>"]}, {"lines": ["        'zip': node_settings.owner.api_url + 'github/zipball/' + (ref or ''),"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["        user_settings = user.get_addon('s3')", ""]}, {"lines": ["            'user_is_owner': ("]}, {"lines": ["            'node_has_auth': self.has_auth,", "            'owner': None,"]}, {"lines": ["        if self.has_auth:"]}, {"lines": ["<form role=\"form\" id=\"addonSettings${addon_short_name.capitalize()}\" data-addon=\"${addon_short_name}\">"]}, {"lines": ["    <span data-owner=\"user\"></span>"]}, {"lines": ["    <div>", "        <h4 class=\"addon-title\">", "            Amazon S3", "", "            <small class=\"authorized-by\">", "                % if has_auth:", "                    authorized"]}, {"lines": ["                    <a id=\"s3RemoveAccess\" class=\"text-danger pull-right addon-auth\">Delete Credentials</a>"]}, {"lines": ["                % endif", "            </small>", "", "        </h4>"]}, {"lines": ["    % if not has_auth:", "        <div class=\"form-group\">", "            <label for=\"s3Addon\">Access Key</label>", "            <input class=\"form-control\" id=\"access_key\" name=\"access_key\" ${'disabled' if disabled else ''} />", "        </div>", "        <div class=\"form-group\">", "            <label for=\"s3Addon\">Secret Key</label>", "            <input type=\"password\" class=\"form-control\" id=\"secret_key\" name=\"secret_key\" ${'disabled' if disabled else ''} />", "        </div>", "", "        <button class=\"btn btn-success addon-settings-submit\">", "            Submit"]}, {"lines": ["    % endif", "", "    ${self.on_submit()}", "", "    <!-- Form feedback -->", "    <div class=\"addon-settings-message\" style=\"display: none; padding-top: 10px;\"></div>", "", "</form>"]}, {"lines": ["    <script type=\"text/javascript\">"]}, {"lines": ["    </script>"]}, {"lines": ["", "(function () {", "", "", "    var util = {},", "        position = {},", "        ui = {},", "        doc = window.document,", "        re = window.RegExp,", "        nav = window.navigator,", "        SETTINGS = { lineLength: 72 },", "", "    // Used to work around some browser bugs where we can't use feature testing.", "        uaSniffed = {", "            isIE: /msie/.test(nav.userAgent.toLowerCase()),", "            isIE_5or6: /msie 6/.test(nav.userAgent.toLowerCase()) || /msie 5/.test(nav.userAgent.toLowerCase()),", "            isOpera: /opera/.test(nav.userAgent.toLowerCase())", "        };", "", "    var defaultsStrings = {", "        bold: \"Strong <strong>\",", "        boldexample: \"strong text\",", "", "        italic: \"Emphasis <em>\",", "        italicexample: \"emphasized text\",", "", "        link: \"Hyperlink <a>\",", "        linkdescription: \"enter link description here\",", "        linkdialog: \"<p><b>Insert Hyperlink</b></p><p>http://example.com/ \\\"optional title\\\"</p>\",", "", "        quote: \"Blockquote <blockquote>\",", "        quoteexample: \"Blockquote\",", "", "        code: \"Code Sample <pre><code>\",", "        codeexample: \"enter code here\",", "", "        image: \"Image <img>\",", "        imagedescription: \"enter image description here\",", "        imagedialog: \"<p><b>Insert Image</b></p><p>http://example.com/images/diagram.jpg \\\"optional title\\\"<br><br>Need <a href='http://www.google.com/search?q=free+image+hosting' target='_blank'>free image hosting?</a></p>\",", "", "        olist: \"Numbered List <ol>\",", "        ulist: \"Bulleted List <ul>\",", "        litem: \"List item\",", "", "        heading: \"Heading <h1>/<h2>\",", "        headingexample: \"Heading\",", "", "        hr: \"Horizontal Rule <hr>\",", "", "        undo: \"Undo -\",", "        redo: \"Redo -\",", "", "        help: \"Markdown Editing Help\"", "    };", "", "    var keyStrokes = {", "        bold: {", "            win: 'Ctrl-B',", "            mac: 'Command-B|Ctrl-B',", "        },", "        italic: {", "            win: 'Ctrl-I',", "            mac: 'Command-I|Ctrl-I',", "        },", "        link: {", "            win: 'Ctrl-L',", "            mac: 'Command-L|Ctrl-L',", "        },", "        quote: {", "            win: 'Ctrl-Q',", "            mac: 'Command-Q|Ctrl-Q',", "        },", "        code: {", "            win: 'Ctrl-K',", "            mac: 'Command-K|Ctrl-K',", "        },", "        image: {", "            win: 'Ctrl-G',", "            mac: 'Command-G|Ctrl-G',", "        },", "        olist: {", "            win: 'Ctrl-O',", "            mac: 'Command-O|Ctrl-O',", "        },", "        ulist: {", "            win: 'Ctrl-U',", "            mac: 'Command-U|Ctrl-U',", "        },", "        heading: {", "            win: 'Ctrl-H',", "            mac: 'Command-H|Ctrl-H',", "        },", "        hr: {", "            win: 'Ctrl-R',", "            mac: 'Command-R|Ctrl-R',", "        },", "        undo: {", "            win: 'Ctrl-Z',", "            mac: 'Command-Z',", "        },", "        redo: {", "            win: 'Ctrl-Y|Ctrl-Shift-Z',", "            mac: 'Command-Y|Command-Shift-Z',", "        },", "    };", "", "", "    // -------------------------------------------------------------------", "    //  YOUR CHANGES GO HERE", "    //", "    // I've tried to localize the things you are likely to change to", "    // this area.", "    // -------------------------------------------------------------------", "", "    // The default text that appears in the dialog input box when entering", "    // links.", "    var imageDefaultText = \"http://\";", "    var linkDefaultText = \"http://\";", ""]}, {"lines": ["    // -------------------------------------------------------------------", "    //  END OF YOUR CHANGES", "    // -------------------------------------------------------------------", "", "    // options, if given, can have the following properties:", "    //   options.helpButton = { handler: yourEventHandler }", "    //   options.strings = { italicexample: \"slanted text\" }", "    // `yourEventHandler` is the click handler for the help button.", "    // If `options.helpButton` isn't given, not help button is created.", "    // `options.strings` can have any or all of the same properties as", "    // `defaultStrings` above, so you can just override some string displayed", "    // to the user on a case-by-case basis, or translate all strings to", "    // a different language.", "    //", "    // For backwards compatibility reasons, the `options` argument can also", "    // be just the `helpButton` object, and `strings.help` can also be set via", "    // `helpButton.title`. This should be considered legacy.", "    //", "    // The constructed editor object has the methods:", "    // - getConverter() returns the markdown converter object that was passed to the constructor", "    // - run() actually starts the editor; should be called after all necessary plugins are registered. Calling this more than once is a no-op.", "    // - refreshPreview() forces the preview to be updated. This method is only available after run() was called.", "    Markdown.Editor = function (markdownConverter, idPostfix, options) {", "", "        options = options || {};", "", "        if (typeof options.handler === \"function\") { //backwards compatible behavior", "            options = { helpButton: options };", "        }", "        options.strings = options.strings || {};", "        if (options.helpButton) {", "            options.strings.help = options.strings.help || options.helpButton.title;", "        }", "        // Override default keystrokes", "        if(options.keyStrokes) {", "            for(var key in options.keyStrokes) {", "                keyStrokes[key] = options.keyStrokes[key];", "            }", "        }", "        var getString = function (identifier) { return options.strings[identifier] || defaultsStrings[identifier]; }", "", "        idPostfix = idPostfix || \"\";", "", "        var hooks = this.hooks = new Markdown.HookCollection();", "        hooks.addNoop(\"onPreviewRefresh\");       // called with no arguments after the preview has been refreshed", "        hooks.addNoop(\"postBlockquoteCreation\"); // called with the user's selection *after* the blockquote was created; should return the actual to-be-inserted text", "        hooks.addFalse(\"insertImageDialog\");     /* called with one parameter: a callback to be called with the URL of the image. If the application creates", "                                                  * its own image insertion dialog, this hook should return true, and the callback should be called with the chosen", "                                                  * image url (or null if the user cancelled). If this hook returns false, the default dialog will be used.", "                                                  */", "        hooks.addFalse(\"insertLinkDialog\");", "", "        this.getConverter = function () { return markdownConverter; }", "", "        var that = this,", "            panels;", "", "        var undoManager;"]}, {"lines": ["            if (panels)", "                return; // already initialized", "", "            panels = new PanelCollection(idPostfix, aceEditor);", "            var commandManager = new CommandManager(hooks, getString);"]}, {"lines": ["            var uiManager;", ""]}, {"lines": ["            var getKey = function (identifier) {", "                var keyStroke = keyStrokes[identifier][useragent.isMac ? \"mac\" : \"win\"];", "                var orIndex = keyStroke.indexOf('|');", "                return keyStroke.substring(0, orIndex > 0 ? orIndex : keyStroke.length);", "            };", "            uiManager = new UIManager(idPostfix, panels, undoManager, previewManager, commandManager, options.helpButton, getString, getKey);", "            uiManager.setUndoRedoButtonStates();", ""]}, {"lines": ["            that.uiManager = uiManager;", "        };", "", "    }", "", "    // before: contains all the text in the input box BEFORE the selection.", "    // after: contains all the text in the input box AFTER the selection.", "    function Chunks() { }", "", "    // startRegex: a regular expression to find the start tag", "    // endRegex: a regular expresssion to find the end tag", "    Chunks.prototype.findTags = function (startRegex, endRegex) {", "", "        var chunkObj = this;", "        var regex;", "", "        if (startRegex) {", "", "            regex = util.extendRegExp(startRegex, \"\", \"$\");", "", "            this.before = this.before.replace(regex,", "                function (match) {", "                    chunkObj.startTag = chunkObj.startTag + match;", "                    return \"\";", "                });", "", "            regex = util.extendRegExp(startRegex, \"^\", \"\");", "", "            this.selection = this.selection.replace(regex,", "                function (match) {", "                    chunkObj.startTag = chunkObj.startTag + match;", "                    return \"\";", "                });", "        }", "", "        if (endRegex) {", "", "            regex = util.extendRegExp(endRegex, \"\", \"$\");", "", "            this.selection = this.selection.replace(regex,", "                function (match) {", "                    chunkObj.endTag = match + chunkObj.endTag;", "                    return \"\";", "                });", "", "            regex = util.extendRegExp(endRegex, \"^\", \"\");", "", "            this.after = this.after.replace(regex,", "                function (match) {", "                    chunkObj.endTag = match + chunkObj.endTag;", "                    return \"\";", "                });", "        }", "    };", "", "    // If remove is false, the whitespace is transferred", "    // to the before/after regions.", "    //", "    // If remove is true, the whitespace disappears.", "    Chunks.prototype.trimWhitespace = function (remove) {", "        var beforeReplacer, afterReplacer, that = this;", "        if (remove) {", "            beforeReplacer = afterReplacer = \"\";", "        } else {", "            beforeReplacer = function (s) { that.before += s; return \"\"; }", "            afterReplacer = function (s) { that.after = s + that.after; return \"\"; }", "        }", "", "        this.selection = this.selection.replace(/^(\\s*)/, beforeReplacer).replace(/(\\s*)$/, afterReplacer);", "    };", "", "", "    Chunks.prototype.skipLines = function (nLinesBefore, nLinesAfter, findExtraNewlines) {", "", "        if (nLinesBefore === undefined) {", "            nLinesBefore = 1;", "        }", "", "        if (nLinesAfter === undefined) {", "            nLinesAfter = 1;", "        }", "", "        nLinesBefore++;", "        nLinesAfter++;", "", "        var regexText;", "        var replacementText;", "", "        // chrome bug ... documented at: http://meta.stackoverflow.com/questions/63307/blockquote-glitch-in-editor-in-chrome-6-and-7/65985#65985", "        if (navigator.userAgent.match(/Chrome/)) {", "            \"X\".match(/()./);", "        }", "", "        this.selection = this.selection.replace(/(^\\n*)/, \"\");", "", "        this.startTag = this.startTag + re.$1;", "", "        this.selection = this.selection.replace(/(\\n*$)/, \"\");", "        this.endTag = this.endTag + re.$1;", "        this.startTag = this.startTag.replace(/(^\\n*)/, \"\");", "        this.before = this.before + re.$1;", "        this.endTag = this.endTag.replace(/(\\n*$)/, \"\");", "        this.after = this.after + re.$1;", "", "        if (this.before) {", "", "            regexText = replacementText = \"\";", "", "            while (nLinesBefore--) {", "                regexText += \"\\\\n?\";", "                replacementText += \"\\n\";", "            }", "", "            if (findExtraNewlines) {", "                regexText = \"\\\\n*\";", "            }", "            this.before = this.before.replace(new re(regexText + \"$\", \"\"), replacementText);", "        }", "", "        if (this.after) {", "", "            regexText = replacementText = \"\";", "", "            while (nLinesAfter--) {", "                regexText += \"\\\\n?\";", "                replacementText += \"\\n\";", "            }", "            if (findExtraNewlines) {", "                regexText = \"\\\\n*\";", "            }", "", "            this.after = this.after.replace(new re(regexText, \"\"), replacementText);", "        }", "    };", "", "    // end of Chunks", "", "    // A collection of the important regions on the page.", "    // Cached so we don't have to keep traversing the DOM.", "    // Also holds ieCachedRange and ieCachedScrollTop, where necessary; working around", "    // this issue:", "    // Internet explorer has problems with CSS sprite buttons that use HTML", "    // lists.  When you click on the background image \"button\", IE will", "    // select the non-existent link text and discard the selection in the", "    // textarea.  The solution to this is to cache the textarea selection", "    // on the button's mousedown event and set a flag.  In the part of the", "    // code where we need to grab the selection, we check for the flag", "    // and, if it's set, use the cached area instead of querying the", "    // textarea.", "    //", "    // This ONLY affects Internet Explorer (tested on versions 6, 7", "    // and 8) and ONLY on button clicks.  Keyboard shortcuts work", "    // normally since the focus never leaves the textarea.", "    function PanelCollection(postfix, aceEditor) {", "        this.buttonBar = doc.getElementById(\"wmd-button-bar\" + postfix);", "        this.preview = doc.getElementById(\"wmd-preview\" + postfix);", "        this.input = aceEditor;", "    };", "", "    // Returns true if the DOM element is visible, false if it's hidden.", "    // Checks if display is anything other than none.", "    util.isVisible = function (elem) {", "", "        if (window.getComputedStyle) {", "            // Most browsers", "            return window.getComputedStyle(elem, null).getPropertyValue(\"display\") !== \"none\";", "        }", "        else if (elem.currentStyle) {", "            // IE", "            return elem.currentStyle[\"display\"] !== \"none\";", "        }", "    };", "", "", "    // Adds a listener callback to a DOM element which is fired on a specified", "    // event.", "    util.addEvent = function (elem, event, listener) {", "        if (elem.attachEvent) {", "            // IE only.  The \"on\" is mandatory.", "            elem.attachEvent(\"on\" + event, listener);", "        }", "        else {", "            // Other browsers.", "            elem.addEventListener(event, listener, false);", "        }", "    };", "", "", "    // Removes a listener callback from a DOM element which is fired on a specified", "    // event.", "    util.removeEvent = function (elem, event, listener) {", "        if (elem.detachEvent) {", "            // IE only.  The \"on\" is mandatory.", "            elem.detachEvent(\"on\" + event, listener);", "        }", "        else {", "            // Other browsers.", "            elem.removeEventListener(event, listener, false);", "        }", "    };", "", "    // Converts \\r\\n and \\r to \\n.", "    util.fixEolChars = function (text) {", "        text = text.replace(/\\r\\n/g, \"\\n\");", "        text = text.replace(/\\r/g, \"\\n\");", "        return text;", "    };", "", "    // Extends a regular expression.  Returns a new RegExp", "    // using pre + regex + post as the expression.", "    // Used in a few functions where we have a base", "    // expression and we want to pre- or append some", "    // conditions to it (e.g. adding \"$\" to the end).", "    // The flags are unchanged.", "    //", "    // regex is a RegExp, pre and post are strings.", "    util.extendRegExp = function (regex, pre, post) {", "", "        if (pre === null || pre === undefined) {", "            pre = \"\";", "        }", "        if (post === null || post === undefined) {", "            post = \"\";", "        }", "", "        var pattern = regex.toString();", "        var flags;", "", "        // Replace the flags with empty space and store them.", "        pattern = pattern.replace(/\\/([gim]*)$/, function (wholeMatch, flagsPart) {", "            flags = flagsPart;", "            return \"\";", "        });", "", "        // Remove the slash delimiters on the regular expression.", "        pattern = pattern.replace(/(^\\/|\\/$)/g, \"\");", "        pattern = pre + pattern + post;", "", "        return new re(pattern, flags);", "    }", "", "    // UNFINISHED", "    // The assignment in the while loop makes jslint cranky.", "    // I'll change it to a better loop later.", "    position.getTop = function (elem, isInner) {", "        var result = elem.offsetTop;", "        if (!isInner) {", "            while (elem = elem.offsetParent) {", "                result += elem.offsetTop;", "            }", "        }", "        return result;", "    };", "", "    position.getHeight = function (elem) {", "        return elem.offsetHeight || elem.scrollHeight;", "    };", "", "    position.getWidth = function (elem) {", "        return elem.offsetWidth || elem.scrollWidth;", "    };", "", "    position.getPageSize = function () {", "", "        var scrollWidth, scrollHeight;", "        var innerWidth, innerHeight;", "", "        // It's not very clear which blocks work with which browsers.", "        if (self.innerHeight && self.scrollMaxY) {", "            scrollWidth = doc.body.scrollWidth;", "            scrollHeight = self.innerHeight + self.scrollMaxY;", "        }", "        else if (doc.body.scrollHeight > doc.body.offsetHeight) {", "            scrollWidth = doc.body.scrollWidth;", "            scrollHeight = doc.body.scrollHeight;", "        }", "        else {", "            scrollWidth = doc.body.offsetWidth;", "            scrollHeight = doc.body.offsetHeight;", "        }", "", "        if (self.innerHeight) {", "            // Non-IE browser", "            innerWidth = self.innerWidth;", "            innerHeight = self.innerHeight;", "        }", "        else if (doc.documentElement && doc.documentElement.clientHeight) {", "            // Some versions of IE (IE 6 w/ a DOCTYPE declaration)", "            innerWidth = doc.documentElement.clientWidth;", "            innerHeight = doc.documentElement.clientHeight;", "        }", "        else if (doc.body) {", "            // Other versions of IE", "            innerWidth = doc.body.clientWidth;", "            innerHeight = doc.body.clientHeight;", "        }", "", "        var maxWidth = Math.max(scrollWidth, innerWidth);", "        var maxHeight = Math.max(scrollHeight, innerHeight);", "        return [maxWidth, maxHeight, innerWidth, innerHeight];", "    };", "", "    /*benweet", "    // Handles pushing and popping TextareaStates for undo/redo commands.", "    // I should rename the stack variables to list.", "    function UndoManager(callback, panels) {", "", "        var undoObj = this;", "        var undoStack = []; // A stack of undo states", "        var stackPtr = 0; // The index of the current state", "        var mode = \"none\";", "        var lastState; // The last state", "        var timer; // The setTimeout handle for cancelling the timer", "        var inputStateObj;", "", "        // Set the mode for later logic steps.", "        var setMode = function (newMode, noSave) {", "            if (mode != newMode) {", "                mode = newMode;", "                if (!noSave) {", "                    saveState();", "                }", "            }", "", "            if (!uaSniffed.isIE || mode != \"moving\") {", "                timer = setTimeout(refreshState, 1);", "            }", "            else {", "                inputStateObj = null;", "            }", "        };", "", "        var refreshState = function (isInitialState) {", "            inputStateObj = new TextareaState(panels, isInitialState);", "            timer = undefined;", "        };", "", "        this.setCommandMode = function () {", "            mode = \"command\";", "            saveState();", "            timer = setTimeout(refreshState, 0);", "        };", "", "        this.canUndo = function () {", "            return stackPtr > 1;", "        };", "", "        this.canRedo = function () {", "            if (undoStack[stackPtr + 1]) {", "                return true;", "            }", "            return false;", "        };", "", "        // Removes the last state and restores it.", "        this.undo = function () {", "", "            if (undoObj.canUndo()) {", "                if (lastState) {", "                    // What about setting state -1 to null or checking for undefined?", "                    lastState.restore();", "                    lastState = null;", "                }", "                else {", "                    undoStack[stackPtr] = new TextareaState(panels);", "                    undoStack[--stackPtr].restore();", "", "                    if (callback) {", "                        callback();", "                    }", "                }", "            }", "", "            mode = \"none\";", "            panels.input.focus();", "            refreshState();", "        };", "", "        // Redo an action.", "        this.redo = function () {", "", "            if (undoObj.canRedo()) {", "", "                undoStack[++stackPtr].restore();", "", "                if (callback) {", "                    callback();", "                }", "            }", "", "            mode = \"none\";", "            panels.input.focus();", "            refreshState();", "        };", "", "        // Push the input area state to the stack.", "        var saveState = function () {", "            var currState = inputStateObj || new TextareaState(panels);", "", "            if (!currState) {", "                return false;", "            }", "            if (mode == \"moving\") {", "                if (!lastState) {", "                    lastState = currState;", "                }", "                return;", "            }", "            if (lastState) {", "                if (undoStack[stackPtr - 1].text != lastState.text) {", "                    undoStack[stackPtr++] = lastState;", "                }", "                lastState = null;", "            }", "            undoStack[stackPtr++] = currState;", "            undoStack[stackPtr + 1] = null;", "            if (callback) {", "                callback();", "            }", "        };", "", "        var handleCtrlYZ = function (event) {", "", "            var handled = false;", "", "            if ((event.ctrlKey || event.metaKey) && !event.altKey) {", "", "                // IE and Opera do not support charCode.", "                var keyCode = event.charCode || event.keyCode;", "                var keyCodeChar = String.fromCharCode(keyCode);", "", "                switch (keyCodeChar.toLowerCase()) {", "", "                    case \"y\":", "                        undoObj.redo();", "                        handled = true;", "                        break;", "", "                    case \"z\":", "                        if (!event.shiftKey) {", "                            undoObj.undo();", "                        }", "                        else {", "                            undoObj.redo();", "                        }", "                        handled = true;", "                        break;", "                }", "            }", "", "            if (handled) {", "                if (event.preventDefault) {", "                    event.preventDefault();", "                }", "                if (window.event) {", "                    window.event.returnValue = false;", "                }", "                return;", "            }", "        };", "", "        // Set the mode depending on what is going on in the input area.", "        var handleModeChange = function (event) {", "", "            if (!event.ctrlKey && !event.metaKey) {", "", "                var keyCode = event.keyCode;", "", "                if ((keyCode >= 33 && keyCode <= 40) || (keyCode >= 63232 && keyCode <= 63235)) {", "                    // 33 - 40: page up/dn and arrow keys", "                    // 63232 - 63235: page up/dn and arrow keys on safari", "                    setMode(\"moving\");", "                }", "                else if (keyCode == 8 || keyCode == 46 || keyCode == 127) {", "                    // 8: backspace", "                    // 46: delete", "                    // 127: delete", "                    setMode(\"deleting\");", "                }", "                else if (keyCode == 13) {", "                    // 13: Enter", "                    setMode(\"newlines\");", "                }", "                else if (keyCode == 27) {", "                    // 27: escape", "                    setMode(\"escape\");", "                }", "                else if ((keyCode < 16 || keyCode > 20) && keyCode != 91) {", "                    // 16-20 are shift, etc.", "                    // 91: left window key", "                    // I think this might be a little messed up since there are", "                    // a lot of nonprinting keys above 20.", "                    setMode(\"typing\");", "                }", "            }", "        };", "", "        var setEventHandlers = function () {", "            util.addEvent(panels.input, \"keypress\", function (event) {", "                // keyCode 89: y", "                // keyCode 90: z", "                if ((event.ctrlKey || event.metaKey) && !event.altKey && (event.keyCode == 89 || event.keyCode == 90)) {", "                    event.preventDefault();", "                }", "            });", "", "            var handlePaste = function () {", "                if (uaSniffed.isIE || (inputStateObj && inputStateObj.text != panels.input.value)) {", "                    if (timer == undefined) {", "                        mode = \"paste\";", "                        saveState();", "                        refreshState();", "                    }", "                }", "            };", "", "            //util.addEvent(panels.input, \"keydown\", handleCtrlYZ);", "            util.addEvent(panels.input, \"keydown\", handleModeChange);", "            util.addEvent(panels.input, \"mousedown\", function () {", "                setMode(\"moving\");", "            });", "", "            panels.input.onpaste = handlePaste;", "            panels.input.ondrop = handlePaste;", "        };", "", "        var init = function () {", "            setEventHandlers();", "            refreshState(true);", "            //Not necessary", "            //saveState();", "        };", "", "        this.reinit = function(content, start, end, scrollTop) {", "            undoStack = [];", "            stackPtr = 0;", "            mode = \"none\";", "            lastState = undefined;", "            timer = undefined;", "            refreshState();", "            inputStateObj.text = content;", "            inputStateObj.start = start;", "            inputStateObj.end = end;", "            inputStateObj.scrollTop = scrollTop;", "            inputStateObj.setInputAreaSelection();", "            saveState();", "        };", "        this.setMode = setMode;", "", "        init();", "    }", "", "    // end of UndoManager", "    */", "", "    // The input textarea state/contents.", "    // This is used to implement undo/redo by the undo manager.", "    function TextareaState(panels, isInitialState) {", "", "        // Aliases", "        var stateObj = this;", "        var inputArea = panels.input;", "        this.init = function () {", "            /*benweet", "            if (!util.isVisible(inputArea)) {", "                return;", "            }", "            if (!isInitialState && doc.activeElement && doc.activeElement !== inputArea) { // this happens when tabbing out of the input box", "                return;", "            }", "            */", ""]}, {"lines": ["            (function(range) {", "                stateObj.before = inputArea.session.getTextRange(new Range(0,0,range.start.row, range.start.column));", "                stateObj.selection = inputArea.session.getTextRange();", "                stateObj.after = inputArea.session.getTextRange(new Range(range.end.row, range.end.column, Number.MAX_VALUE, Number.MAX_VALUE));", "            })(inputArea.selection.getRange());", "            this.text = [this.before, this.selection, this.after].join('');", "            this.length = this.text.length;", "            this.setInputAreaSelectionStartEnd();", "            this.scrollTop = inputArea.renderer.getScrollTop();", "            /*benweet", "            if (!this.text && inputArea.selectionStart || inputArea.selectionStart === 0) {", "                this.text = inputArea.value;", "            }", "            */", "        }", "", "        // Sets the selected text in the input box after we've performed an", "        // operation.", "        this.setInputAreaSelection = function () {", ""]}, {"lines": ["            inputArea.selection.setSelectionRange((function(posStart, posEnd) {", "                return new Range(posStart.row, posStart.column, posEnd.row, posEnd.column);", "            })(inputArea.session.doc.indexToPosition(stateObj.start), inputArea.session.doc.indexToPosition(stateObj.end)));", "            inputArea.renderer.scrollToY(stateObj.scrollTop);"]}, {"lines": ["", "            /*benweet", "            if (!util.isVisible(inputArea)) {", "                return;", "            }", "", "            if (inputArea.selectionStart !== undefined && !uaSniffed.isOpera) {", "", "                inputArea.focus();", "                inputArea.selectionStart = stateObj.start;", "                inputArea.selectionEnd = stateObj.end;", "                inputArea.scrollTop = stateObj.scrollTop;", "            }", "            else if (doc.selection) {", "", "                if (doc.activeElement && doc.activeElement !== inputArea) {", "                    return;", "                }", "", "                inputArea.focus();", "                var range = inputArea.createTextRange();", "                range.moveStart(\"character\", -inputArea.value.length);", "                range.moveEnd(\"character\", -inputArea.value.length);", "                range.moveEnd(\"character\", stateObj.end);", "                range.moveStart(\"character\", stateObj.start);", "                range.select();", "            }", "            */", "        };", "", "        this.setInputAreaSelectionStartEnd = function () {", "", "            stateObj.start = stateObj.before.length;", "            stateObj.end = stateObj.after.length;", "", "            /*benweet", "            if (!panels.ieCachedRange && (inputArea.selectionStart || inputArea.selectionStart === 0)) {", "", "                stateObj.start = inputArea.selectionStart;", "                stateObj.end = inputArea.selectionEnd;", "            }", "            else if (doc.selection) {", "", "                stateObj.text = util.fixEolChars(inputArea.value);", "", "                // IE loses the selection in the textarea when buttons are", "                // clicked.  On IE we cache the selection. Here, if something is cached,", "                // we take it.", "                var range = panels.ieCachedRange || doc.selection.createRange();", "", "                var fixedRange = util.fixEolChars(range.text);", "                var marker = \"\\x07\";", "                var markedRange = marker + fixedRange + marker;", "                range.text = markedRange;", "                var inputText = util.fixEolChars(inputArea.value);", "", "                range.moveStart(\"character\", -markedRange.length);", "                range.text = fixedRange;", "", "                stateObj.start = inputText.indexOf(marker);", "                stateObj.end = inputText.lastIndexOf(marker) - marker.length;", "", "                var len = stateObj.text.length - util.fixEolChars(inputArea.value).length;", "", "                if (len) {", "                    range.moveStart(\"character\", -fixedRange.length);", "                    while (len--) {", "                        fixedRange += \"\\n\";", "                        stateObj.end += 1;", "                    }", "                    range.text = fixedRange;", "                }", "", "                if (panels.ieCachedRange)", "                    stateObj.scrollTop = panels.ieCachedScrollTop; // this is set alongside with ieCachedRange", "", "                panels.ieCachedRange = null;", "", "                this.setInputAreaSelection();", "            }", "            */", "        };", "", "        // Restore this state into the input area.", "        this.restore = function () {", "            // Here we could do editor.setValue but we want to update the less we can for undo management", "", "            // Find the first modified char", "            var startIndex = 0;", "            var startIndexMax = stateObj.before.length;", "            while(startIndex < startIndexMax) {", "                if(stateObj.before.charCodeAt(startIndex) !== stateObj.text.charCodeAt(startIndex))", "                    break;", "                startIndex++;", "            }", "            // Find the last modified char", "            var endIndex = 0;", "            var endIndexMax = stateObj.after.length;", "            var beforeMaxOffset = stateObj.after.length - 1;", "            var afterMaxOffset = stateObj.text.length - 1;", "            while(endIndex < endIndexMax) {", "                if(stateObj.after.charCodeAt(beforeMaxOffset - endIndex) !== stateObj.text.charCodeAt(afterMaxOffset - endIndex))", "                    break;", "                endIndex++;", "            }", ""]}, {"lines": ["            var range = (function(posStart, posEnd) {", "                return new Range(posStart.row, posStart.column, posEnd.row, posEnd.column);", "            })(inputArea.session.doc.indexToPosition(startIndex), inputArea.session.doc.indexToPosition(stateObj.length - endIndex));", "            inputArea.session.replace(range, stateObj.text.substring(startIndex, afterMaxOffset - endIndex + 1));", "            this.setInputAreaSelection();", "", "            /*benweet", "            if (stateObj.text != undefined && stateObj.text != inputArea.value) {", "                inputArea.value = stateObj.text;", "            }", "            inputArea.scrollTop = stateObj.scrollTop;", "            */", "        };", "", "        // Gets a collection of HTML chunks from the inptut textarea.", "        this.getChunks = function () {", "", "            var chunk = new Chunks();", "            chunk.before = stateObj.before;", "            chunk.startTag = \"\";", "            chunk.selection = stateObj.selection;", "            chunk.endTag = \"\";", "            chunk.after = stateObj.after;", "            chunk.scrollTop = stateObj.scrollTop;", "", "            return chunk;", "        };", "", "        // Sets the TextareaState properties given a chunk of markdown.", "        this.setChunks = function (chunk) {", "", "            chunk.before = chunk.before + chunk.startTag;", "            chunk.after = chunk.endTag + chunk.after;", "", "            this.start = chunk.before.length;", "            this.end = chunk.before.length + chunk.selection.length;", "            this.text = chunk.before + chunk.selection + chunk.after;", "            this.scrollTop = chunk.scrollTop;", "        };", "        this.init();", "    };", "", "    function PreviewManager(converter, panels, previewRefreshCallback, previewWrapper) {", "", "        var managerObj = this;", "        var timeout;", "        var elapsedTime;", "        var oldInputText;", "        var maxDelay = 3000;", "        var startType = \"delayed\"; // The other legal value is \"manual\"", "", "        // Adds event listeners to elements", "        /*benweet", "        var setupEvents = function (inputElem, listener) {", "", "            util.addEvent(inputElem, \"input\", listener);", "            inputElem.onpaste = listener;", "            inputElem.ondrop = listener;", "", "            util.addEvent(inputElem, \"keypress\", listener);", "            util.addEvent(inputElem, \"keydown\", listener);", "        };", "        */", "", "        var getDocScrollTop = function () {", "", "            var result = 0;", "", "            if (window.innerHeight) {", "                result = window.pageYOffset;", "            }", "            else", "                if (doc.documentElement && doc.documentElement.scrollTop) {", "                    result = doc.documentElement.scrollTop;", "                }", "                else", "                    if (doc.body) {", "                        result = doc.body.scrollTop;", "                    }", "", "            return result;", "        };", "", "        var makePreviewHtml = function () {", "", "            // If there is no registered preview panel", "            // there is nothing to do.", "            if (!panels.preview)", "                return;", "", "", "            var text = panels.input.getValue();", "            if (text && text == oldInputText) {", "                return; // Input text hasn't changed.", "            }", "            else {", "                oldInputText = text;", "            }", "", "            var prevTime = new Date().getTime();", "", "            text = converter.makeHtml(text);", "", "            // Calculate the processing time of the HTML creation.", "            // It's used as the delay time in the event listener.", "            var currTime = new Date().getTime();", "            elapsedTime = currTime - prevTime;", "", "            pushPreviewHtml(text);", "        };", "        if(previewWrapper !== undefined) {", "            makePreviewHtml = previewWrapper(makePreviewHtml);", "        }", "", "        // setTimeout is already used.  Used as an event listener.", "        var applyTimeout = function () {", "", "            if (timeout) {", "                clearTimeout(timeout);", "                timeout = undefined;", "            }", "", "            if (startType !== \"manual\") {", "", "                var delay = 0;", "", "                if (startType === \"delayed\") {", "                    delay = elapsedTime;", "                }", "", "                if (delay > maxDelay) {", "                    delay = maxDelay;", "                }", "                timeout = setTimeout(makePreviewHtml, delay);", "            }", "        };", "", "        var getScaleFactor = function (panel) {", "            if (panel.scrollHeight <= panel.clientHeight) {", "                return 1;", "            }", "            return panel.scrollTop / (panel.scrollHeight - panel.clientHeight);", "        };", "", "        var setPanelScrollTops = function () {", "            if (panels.preview) {", "                panels.preview.scrollTop = (panels.preview.scrollHeight - panels.preview.clientHeight) * getScaleFactor(panels.preview);", "            }", "        };", "", "        this.refresh = function (requiresRefresh) {", "", "            if (requiresRefresh) {", "                oldInputText = \"\";", "                makePreviewHtml();", "            }", "            else {", "                applyTimeout();", "            }", "        };", "", "        this.processingTime = function () {", "            return elapsedTime;", "        };", "", "        var isFirstTimeFilled = true;", "", "        // IE doesn't let you use innerHTML if the element is contained somewhere in a table", "        // (which is the case for inline editing) -- in that case, detach the element, set the", "        // value, and reattach. Yes, that *is* ridiculous.", "        var ieSafePreviewSet = function (text) {", "            var preview = panels.preview;", "            var parent = preview.parentNode;", "            var sibling = preview.nextSibling;", "            parent.removeChild(preview);", "            preview.innerHTML = text;", "            if (!sibling)", "                parent.appendChild(preview);", "            else", "                parent.insertBefore(preview, sibling);", "        }", "", "        var nonSuckyBrowserPreviewSet = function (text) {", "            panels.preview.innerHTML = text;", "        }", "", "        var previewSetter;", "", "        var previewSet = function (text) {", "            if (previewSetter)", "                return previewSetter(text);", "", "            try {", "                nonSuckyBrowserPreviewSet(text);", "                previewSetter = nonSuckyBrowserPreviewSet;", "            } catch (e) {", "                previewSetter = ieSafePreviewSet;", "                previewSetter(text);", "            }", "        };", "", "        var pushPreviewHtml = function (text) {", ""]}, {"lines": ["", "            if (panels.preview) {", "                previewSet(text);", "                previewRefreshCallback();", "            }", ""]}, {"lines": ["        };", "", "        var init = function () {", "", "            /*benweet", "            setupEvents(panels.input, applyTimeout);", "            */", "            panels.input.session.on('change', applyTimeout);", "            //Not necessary", "            //makePreviewHtml();", "", "            if (panels.preview) {", "                panels.preview.scrollTop = 0;", "            }", "        };", "", "        init();", "    };", "", "    // Creates the background behind the hyperlink text entry box.", "    // And download dialog", "    // Most of this has been moved to CSS but the div creation and", "    // browser-specific hacks remain here.", "    ui.createBackground = function () {", "", "        var background = doc.createElement(\"div\"),", "            style = background.style;", "", "        background.className = \"wmd-prompt-background\";", "", "        style.position = \"absolute\";", "        style.top = \"0\";", "", "        style.zIndex = \"1000\";", "", "        if (uaSniffed.isIE) {", "            style.filter = \"alpha(opacity=50)\";", "        }", "        else {", "            style.opacity = \"0.5\";", "        }", "", "        var pageSize = position.getPageSize();", "        style.height = pageSize[1] + \"px\";", "", "        if (uaSniffed.isIE) {", "            style.left = doc.documentElement.scrollLeft;", "            style.width = doc.documentElement.clientWidth;", "        }", "        else {", "            style.left = \"0\";", "            style.width = \"100%\";", "        }", "", "        doc.body.appendChild(background);", "        return background;", "    };", "", "    // This simulates a modal dialog box and asks for the URL when you", "    // click the hyperlink or image buttons.", "    //", "    // text: The html for the input box.", "    // defaultInputText: The default value that appears in the input box.", "    // callback: The function which is executed when the prompt is dismissed, either via OK or Cancel.", "    //      It receives a single argument; either the entered text (if OK was chosen) or null (if Cancel", "    //      was chosen).", "    ui.prompt = function (text, defaultInputText, callback) {", "", "        // These variables need to be declared at this level since they are used", "        // in multiple functions.", "        var dialog;         // The dialog box.", "        var input;         // The text box where you enter the hyperlink.", "", "", "        if (defaultInputText === undefined) {", "            defaultInputText = \"\";", "        }", "", "        // Used as a keydown event handler. Esc dismisses the prompt.", "        // Key code 27 is ESC.", "        var checkEscape = function (key) {", "            var code = (key.charCode || key.keyCode);", "            if (code === 27) {", "                close(true);", "            }", "        };", "", "        // Dismisses the hyperlink input box.", "        // isCancel is true if we don't care about the input text.", "        // isCancel is false if we are going to keep the text.", "        var close = function (isCancel) {", "            util.removeEvent(doc.body, \"keydown\", checkEscape);", "            var text = input.value;", "", "            if (isCancel) {", "                text = null;", "            }", "            else {", "                // Fixes common pasting errors.", "                text = text.replace(/^http:\\/\\/(https?|ftp):\\/\\//, '$1://');", "                if (!/^(?:https?|ftp):\\/\\//.test(text))", "                    text = 'http://' + text;", "            }", "", "            dialog.parentNode.removeChild(dialog);", "", "            callback(text);", "            return false;", "        };", "", "", "", "        // Create the text input box form/window.", "        var createDialog = function () {", "", "            // The main dialog box.", "            dialog = doc.createElement(\"div\");", "            dialog.className = \"wmd-prompt-dialog\";", "            dialog.style.padding = \"10px;\";", "            dialog.style.position = \"fixed\";", "            dialog.style.width = \"400px\";", "            dialog.style.zIndex = \"1001\";", "", "            // The dialog text.", "            var question = doc.createElement(\"div\");", "            question.innerHTML = text;", "            question.style.padding = \"5px\";", "            dialog.appendChild(question);", "", "            // The web form container for the text box and buttons.", "            var form = doc.createElement(\"form\"),", "                style = form.style;", "            form.onsubmit = function () { return close(false); };", "            style.padding = \"0\";", "            style.margin = \"0\";", "            style.cssFloat = \"left\";", "            style.width = \"100%\";", "            style.textAlign = \"center\";", "            style.position = \"relative\";", "            dialog.appendChild(form);", "", "            // The input text box", "            input = doc.createElement(\"input\");", "            input.type = \"text\";", "            input.value = defaultInputText;", "            style = input.style;", "            style.display = \"block\";", "            style.width = \"80%\";", "            style.marginLeft = style.marginRight = \"auto\";", "            form.appendChild(input);", "", "            // The ok button", "            var okButton = doc.createElement(\"input\");", "            okButton.type = \"button\";", "            okButton.onclick = function () { return close(false); };", "            okButton.value = \"OK\";", "            style = okButton.style;", "            style.margin = \"10px\";", "            style.display = \"inline\";", "            style.width = \"7em\";", "", "", "            // The cancel button", "            var cancelButton = doc.createElement(\"input\");", "            cancelButton.type = \"button\";", "            cancelButton.onclick = function () { return close(true); };", "            cancelButton.value = \"Cancel\";", "            style = cancelButton.style;", "            style.margin = \"10px\";", "            style.display = \"inline\";", "            style.width = \"7em\";", "", "            form.appendChild(okButton);", "            form.appendChild(cancelButton);", "", "            util.addEvent(doc.body, \"keydown\", checkEscape);", "            dialog.style.top = \"50%\";", "            dialog.style.left = \"50%\";", "            dialog.style.display = \"block\";", "            if (uaSniffed.isIE_5or6) {", "                dialog.style.position = \"absolute\";", "                dialog.style.top = doc.documentElement.scrollTop + 200 + \"px\";", "                dialog.style.left = \"50%\";", "            }", "            doc.body.appendChild(dialog);", "", "            // This has to be done AFTER adding the dialog to the form if you", "            // want it to be centered.", "            dialog.style.marginTop = -(position.getHeight(dialog) / 2) + \"px\";", "            dialog.style.marginLeft = -(position.getWidth(dialog) / 2) + \"px\";", "", "        };", "", "        // Why is this in a zero-length timeout?", "        // Is it working around a browser bug?", "        setTimeout(function () {", "", "            createDialog();", "", "            var defTextLen = defaultInputText.length;", "            if (input.selectionStart !== undefined) {", "                input.selectionStart = 0;", "                input.selectionEnd = defTextLen;", "            }", "            else if (input.createTextRange) {", "                var range = input.createTextRange();", "                range.collapse(false);", "                range.moveStart(\"character\", -defTextLen);", "                range.moveEnd(\"character\", defTextLen);", "                range.select();", "            }", ""]}, {"lines": ["        }, 0);", "    };", "", "    function UIManager(postfix, panels, undoManager, previewManager, commandManager, helpOptions, getString, getKey) {", "        var getStringAndKey = function (identifier) { return getString(identifier) + ' ' + getKey(identifier); };", "", "        var inputBox = panels.input,", "            buttons = {}; // buttons.undo, buttons.link, etc. The actual DOM elements.", "", "        this.setUndoRedoButtonStates = function() {", "            setTimeout(function() {", "                setupButton(buttons.undo, inputBox.session.getUndoManager().hasUndo());", "                setupButton(buttons.redo, inputBox.session.getUndoManager().hasRedo());", "            }, 50);", "        };", "", "        var that = this;", "        makeSpritedButtonRow();", "", "        var keyEvent = \"keydown\";", "        if (uaSniffed.isOpera) {", "            keyEvent = \"keypress\";", "        }", "", "        function addKeyCmd(identifierList) {", "            if(identifierList.length === 0) {", "                return;", "            }", "            var identifier = identifierList.pop();", "            inputBox.commands.addCommand({", "                name: getString(identifier),", "                bindKey: keyStrokes[identifier],", "                exec: function(editor) {", "                    doClick(buttons[identifier]);", "                },", "            });", "            addKeyCmd(identifierList);", "        }", "        addKeyCmd(['bold', 'italic', 'link', 'quote', 'code', 'image', 'olist', 'ulist', 'heading', 'hr']);", "", "        /*benweet", "        util.addEvent(inputBox, keyEvent, function (key) {", "", "            // Check to see if we have a button key and, if so execute the callback.", "            if ((key.ctrlKey || key.metaKey) && !key.altKey) {", "", "                var keyCode = key.charCode || key.keyCode;", "                var keyCodeStr = String.fromCharCode(keyCode).toLowerCase();", "", "                switch (keyCodeStr) {", "                    case \"b\":", "                        doClick(buttons.bold);", "                        break;", "                    case \"i\":", "                        doClick(buttons.italic);", "                        break;", "                    case \"l\":", "                        doClick(buttons.link);", "                        break;", "                    case \"q\":", "                        doClick(buttons.quote);", "                        break;", "                    case \"k\":", "                        doClick(buttons.code);", "                        break;", "                    case \"g\":", "                        doClick(buttons.image);", "                        break;", "                    case \"o\":", "                        doClick(buttons.olist);", "                        break;", "                    case \"u\":", "                        doClick(buttons.ulist);", "                        break;", "                    case \"h\":", "                        doClick(buttons.heading);", "                        break;", "                    case \"r\":", "                        doClick(buttons.hr);", "                        break;", "                    case \"y\":", "                        doClick(buttons.redo);", "                        break;", "                    case \"z\":", "                        if (key.shiftKey) {", "                            doClick(buttons.redo);", "                        }", "                        else {", "                            doClick(buttons.undo);", "                        }", "                        break;", "                    case \"v\":", "                        undoManager.setMode(\"typing\");", "                        return;", "                    case \"x\":", "                        undoManager.setMode(\"deleting\");", "                        return;", "                    default:", "                        return;", "                }", "", "", "                if (key.preventDefault) {", "                    key.preventDefault();", "                }", "", "                if (window.event) {", "                    window.event.returnValue = false;", "                }", "            }", "        });", "", "        // Auto-indent on shift-enter", "        util.addEvent(inputBox, \"keyup\", function (key) {", "            if (key.shiftKey && !key.ctrlKey && !key.metaKey) {", "                var keyCode = key.charCode || key.keyCode;", "                // Character 13 is Enter", "                if (keyCode === 13) {", "                    var fakeButton = {};", "                    fakeButton.textOp = bindCommand(\"doAutoindent\");", "                    doClick(fakeButton);", "                }", "            }", "        });", "", "        // special handler because IE clears the context of the textbox on ESC", "        if (uaSniffed.isIE) {", "            util.addEvent(inputBox, \"keydown\", function (key) {", "                var code = key.keyCode;", "                if (code === 27) {", "                    return false;", "                }", "            });", "        }", "        */", "", "", "        // Perform the button's action.", "        function doClick(button) {", ""]}, {"lines": ["            var linkOrImage = button.id == \"wmd-link-button\" || button.id == \"wmd-image-button\";", "", "            if (button.textOp) {", "", "                if (undoManager && !linkOrImage) {", "                    undoManager.setCommandMode();", "                }", "", "                var state = new TextareaState(panels);", "", "                if (!state) {", "                    return;", "                }", "", "                var chunks = state.getChunks();", "", "                // Some commands launch a \"modal\" prompt dialog.  Javascript", "                // can't really make a modal dialog box and the WMD code", "                // will continue to execute while the dialog is displayed.", "                // This prevents the dialog pattern I'm used to and means", "                // I can't do something like this:", "                //", "                // var link = CreateLinkDialog();", "                // makeMarkdownLink(link);", "                //", "                // Instead of this straightforward method of handling a", "                // dialog I have to pass any code which would execute", "                // after the dialog is dismissed (e.g. link creation)", "                // in a function parameter.", "                //", "                // Yes this is awkward and I think it sucks, but there's", "                // no real workaround.  Only the image and link code", "                // create dialogs and require the function pointers.", "                var fixupInputArea = function () {", ""]}, {"lines": ["", "                    if (chunks) {", "                        state.setChunks(chunks);", "                    }", "", "                    state.restore();", "                    previewManager.refresh();", "                };", "", "                var noCleanup = button.textOp(chunks, fixupInputArea);", "", "                if (!noCleanup) {", "                    fixupInputArea();", "                    /*benweet", "                    if(!linkOrImage) {", "                        inputBox.dispatchEvent(new Event('input'));", "                    }", "                    */", "                }", "", "            }", "", "            if (button.execute) {", "                button.execute(undoManager);", "            }", "        };", "", "        function setupButton(button, isEnabled) {", "", "            var normalYShift = \"0px\";", "            var disabledYShift = \"-20px\";", "            var highlightYShift = \"-40px\";", "            var image = button.getElementsByTagName(\"span\")[0];", "            button.className = button.className.replace(/ disabled/g, \"\");", "            if (isEnabled) {", "                image.style.backgroundPosition = button.XShift + \" \" + normalYShift;", "                button.onmouseover = function () {", "                    image.style.backgroundPosition = this.XShift + \" \" + highlightYShift;", "                };", "", "                button.onmouseout = function () {", "                    image.style.backgroundPosition = this.XShift + \" \" + normalYShift;", "                };", "", "                // IE tries to select the background image \"button\" text (it's", "                // implemented in a list item) so we have to cache the selection", "                // on mousedown.", "                if (uaSniffed.isIE) {", "                    button.onmousedown = function () {", "                        if (doc.activeElement && doc.activeElement !== panels.input) { // we're not even in the input box, so there's no selection", "                            return;", "                        }", "                        panels.ieCachedRange = document.selection.createRange();", "                        panels.ieCachedScrollTop = panels.input.renderer.getScrollTop();", "                    };", "                }", "", "                if (!button.isHelp) {", "                    button.onclick = function () {", "                        if (this.onmouseout) {", "                            this.onmouseout();", "                        }", "                        doClick(this);", "                        return false;", "                    }", "                }", "            }", "            else {", "                image.style.backgroundPosition = button.XShift + \" \" + disabledYShift;", "                button.onmouseover = button.onmouseout = button.onclick = function () { };", "                button.className += \" disabled\";", "            }", "        }", "", "        function bindCommand(method) {", "            if (typeof method === \"string\")", "                method = commandManager[method];", "            return function () { method.apply(commandManager, arguments); }", "        }", "", "        function makeSpritedButtonRow() {", "", "            var buttonBar = panels.buttonBar;", "", "            var normalYShift = \"0px\";", "            var disabledYShift = \"-20px\";", "            var highlightYShift = \"-40px\";", "", "            var buttonRow = document.createElement(\"ul\");", "            buttonRow.id = \"wmd-button-row\" + postfix;", "            buttonRow.className = 'wmd-button-row';", "            buttonRow = buttonBar.appendChild(buttonRow);", "            var xPosition = 0;", "            var makeButton = function (id, title, XShift, textOp) {", "                var button = document.createElement(\"li\");", "                button.className = \"wmd-button\";", "                button.style.left = xPosition + \"px\";", "                xPosition += 25;", "                var buttonImage = document.createElement(\"span\");", "                button.id = id + postfix;", "                button.appendChild(buttonImage);", "                button.title = title;", "                button.XShift = XShift;", "                if (textOp)", "                    button.textOp = textOp;", "                setupButton(button, true);", "                buttonRow.appendChild(button);", "                return button;", "            };", "            var makeSpacer = function (num) {", "                var spacer = document.createElement(\"li\");", "                spacer.className = \"wmd-spacer wmd-spacer\" + num;", "                spacer.id = \"wmd-spacer\" + num + postfix;", "                buttonRow.appendChild(spacer);", "                xPosition += 25;", "            }", "", "            buttons.bold = makeButton(\"wmd-bold-button\", getStringAndKey(\"bold\"), \"0px\", bindCommand(\"doBold\"));", "            buttons.italic = makeButton(\"wmd-italic-button\", getStringAndKey(\"italic\"), \"-20px\", bindCommand(\"doItalic\"));", "            makeSpacer(1);", "            buttons.link = makeButton(\"wmd-link-button\", getStringAndKey(\"link\"), \"-40px\", bindCommand(function (chunk, postProcessing) {", "                return this.doLinkOrImage(chunk, postProcessing, false);", "            }));", "            buttons.quote = makeButton(\"wmd-quote-button\", getStringAndKey(\"quote\"), \"-60px\", bindCommand(\"doBlockquote\"));", "            buttons.code = makeButton(\"wmd-code-button\", getStringAndKey(\"code\"), \"-80px\", bindCommand(\"doCode\"));", "            buttons.image = makeButton(\"wmd-image-button\", getStringAndKey(\"image\"), \"-100px\", bindCommand(function (chunk, postProcessing) {", "                return this.doLinkOrImage(chunk, postProcessing, true);", "            }));", "            makeSpacer(2);", "            buttons.olist = makeButton(\"wmd-olist-button\", getStringAndKey(\"olist\"), \"-120px\", bindCommand(function (chunk, postProcessing) {", "                this.doList(chunk, postProcessing, true);", "            }));", "            buttons.ulist = makeButton(\"wmd-ulist-button\", getStringAndKey(\"ulist\"), \"-140px\", bindCommand(function (chunk, postProcessing) {", "                this.doList(chunk, postProcessing, false);", "            }));", "            buttons.heading = makeButton(\"wmd-heading-button\", getStringAndKey(\"heading\"), \"-160px\", bindCommand(\"doHeading\"));", "            buttons.hr = makeButton(\"wmd-hr-button\", getStringAndKey(\"hr\"), \"-180px\", bindCommand(\"doHorizontalRule\"));", "            makeSpacer(3);", "            buttons.undo = makeButton(\"wmd-undo-button\", getStringAndKey(\"undo\"), \"-200px\", null);", "            buttons.undo.execute = function (manager) { inputBox.session.getUndoManager().undo(); };", "", "            buttons.redo = makeButton(\"wmd-redo-button\", getStringAndKey(\"redo\"), \"-220px\", null);", "            buttons.redo.execute = function (manager) { inputBox.session.getUndoManager().redo(); };", "", "            if (helpOptions) {", "                var helpButton = document.createElement(\"li\");", "                var helpButtonImage = document.createElement(\"span\");", "                helpButton.appendChild(helpButtonImage);", "                helpButton.className = \"wmd-button wmd-help-button\";", "                helpButton.id = \"wmd-help-button\" + postfix;", "                helpButton.XShift = \"-240px\";", "                helpButton.isHelp = true;", "                helpButton.style.right = \"0px\";", "                helpButton.title = getString(\"help\");", "                helpButton.onclick = helpOptions.handler;", "", "                setupButton(helpButton, true);", "                buttonRow.appendChild(helpButton);", "                buttons.help = helpButton;", "            }", "", "            that.setUndoRedoButtonStates();", "            inputBox.session.on('change', function() {", "                that.setUndoRedoButtonStates();", "            });", "        }", "", "        this.buttons = buttons;", "        this.setButtonState = setupButton;", "", "    }", "", "    function CommandManager(pluginHooks, getString) {", "        this.hooks = pluginHooks;", "        this.getString = getString;", "    }", "", "    var commandProto = CommandManager.prototype;", "", "    // The markdown symbols - 4 spaces = code, > = blockquote, etc.", "    commandProto.prefixes = \"(?:\\\\s{4,}|\\\\s*>|\\\\s*-\\\\s+|\\\\s*\\\\d+\\\\.|=|\\\\+|-|_|\\\\*|#|\\\\s*\\\\[[^\\n]]+\\\\]:)\";", "", "    // Remove markdown symbols from the chunk selection.", "    commandProto.unwrap = function (chunk) {", "        var txt = new re(\"([^\\\\n])\\\\n(?!(\\\\n|\" + this.prefixes + \"))\", \"g\");", "        chunk.selection = chunk.selection.replace(txt, \"$1 $2\");", "    };", "", "    commandProto.wrap = function (chunk, len) {", "        this.unwrap(chunk);", "        var regex = new re(\"(.{1,\" + len + \"})( +|$\\\\n?)\", \"gm\"),", "            that = this;", "", "        chunk.selection = chunk.selection.replace(regex, function (line, marked) {", "            if (new re(\"^\" + that.prefixes, \"\").test(line)) {", "                return line;", "            }", "            return marked + \"\\n\";", "        });", "", "        chunk.selection = chunk.selection.replace(/\\s+$/, \"\");", "    };", "", "    commandProto.doBold = function (chunk, postProcessing) {", "        return this.doBorI(chunk, postProcessing, 2, this.getString(\"boldexample\"));", "    };", "", "    commandProto.doItalic = function (chunk, postProcessing) {", "        return this.doBorI(chunk, postProcessing, 1, this.getString(\"italicexample\"));", "    };", "", "    // chunk: The selected region that will be enclosed with */**", "    // nStars: 1 for italics, 2 for bold", "    // insertText: If you just click the button without highlighting text, this gets inserted", "    commandProto.doBorI = function (chunk, postProcessing, nStars, insertText) {", "", "        // Get rid of whitespace and fixup newlines.", "        chunk.trimWhitespace();", "        chunk.selection = chunk.selection.replace(/\\n{2,}/g, \"\\n\");", "", "        // Look for stars before and after.  Is the chunk already marked up?", "        // note that these regex matches cannot fail", "        var starsBefore = /(\\**$)/.exec(chunk.before)[0];", "        var starsAfter = /(^\\**)/.exec(chunk.after)[0];", "", "        var prevStars = Math.min(starsBefore.length, starsAfter.length);", "", "        // Remove stars if we have to since the button acts as a toggle.", "        if ((prevStars >= nStars) && (prevStars != 2 || nStars != 1)) {", "            chunk.before = chunk.before.replace(re(\"[*]{\" + nStars + \"}$\", \"\"), \"\");", "            chunk.after = chunk.after.replace(re(\"^[*]{\" + nStars + \"}\", \"\"), \"\");", "        }", "        else if (!chunk.selection && starsAfter) {", "            // It's not really clear why this code is necessary.  It just moves", "            // some arbitrary stuff around.", "            chunk.after = chunk.after.replace(/^([*_]*)/, \"\");", "            chunk.before = chunk.before.replace(/(\\s?)$/, \"\");", "            var whitespace = re.$1;", "            chunk.before = chunk.before + starsAfter + whitespace;", "        }", "        else {", "", "            // In most cases, if you don't have any selected text and click the button", "            // you'll get a selected, marked up region with the default text inserted.", "            if (!chunk.selection && !starsAfter) {", "                chunk.selection = insertText;", "            }", "", "            // Add the true markup.", "            var markup = nStars <= 1 ? \"*\" : \"**\"; // shouldn't the test be = ?", "            chunk.before = chunk.before + markup;", "            chunk.after = markup + chunk.after;", "        }", "", "        return;", "    };", "", "    commandProto.stripLinkDefs = function (text, defsToAdd) {", "", "        text = text.replace(/^[ ]{0,3}\\[(\\d+)\\]:[ \\t]*\\n?[ \\t]*<?(\\S+?)>?[ \\t]*\\n?[ \\t]*(?:(\\n*)[\"(](.+?)[\")][ \\t]*)?(?:\\n+|$)/gm,", "            function (totalMatch, id, link, newlines, title) {", "                defsToAdd[id] = totalMatch.replace(/\\s*$/, \"\");", "                if (newlines) {", "                    // Strip the title and return that separately.", "                    defsToAdd[id] = totalMatch.replace(/[\"(](.+?)[\")]$/, \"\");", "                    return newlines + title;", "                }", "                return \"\";", "            });", "", "        return text;", "    };", "", "    commandProto.addLinkDef = function (chunk, linkDef) {", "", "        var refNumber = 0; // The current reference number", "        var defsToAdd = {}; //", "        // Start with a clean slate by removing all previous link definitions.", "        chunk.before = this.stripLinkDefs(chunk.before, defsToAdd);", "        chunk.selection = this.stripLinkDefs(chunk.selection, defsToAdd);", "        chunk.after = this.stripLinkDefs(chunk.after, defsToAdd);", "", "        var defs = \"\";", "        var regex = /(\\[)((?:\\[[^\\]]*\\]|[^\\[\\]])*)(\\][ ]?(?:\\n[ ]*)?\\[)(\\d+)(\\])/g;", "", "        var addDefNumber = function (def) {", "            refNumber++;", "            def = def.replace(/^[ ]{0,3}\\[(\\d+)\\]:/, \"  [\" + refNumber + \"]:\");", "            defs += \"\\n\" + def;", "        };", "", "        // note that", "        // a) the recursive call to getLink cannot go infinite, because by definition", "        //    of regex, inner is always a proper substring of wholeMatch, and", "        // b) more than one level of nesting is neither supported by the regex", "        //    nor making a lot of sense (the only use case for nesting is a linked image)", "        var getLink = function (wholeMatch, before, inner, afterInner, id, end) {", "            inner = inner.replace(regex, getLink);", "            if (defsToAdd[id]) {", "                addDefNumber(defsToAdd[id]);", "                return before + inner + afterInner + refNumber + end;", "            }", "            return wholeMatch;", "        };", "", "        chunk.before = chunk.before.replace(regex, getLink);", "", "        if (linkDef) {", "            addDefNumber(linkDef);", "        }", "        else {", "            chunk.selection = chunk.selection.replace(regex, getLink);", "        }", "", "        var refOut = refNumber;", "", "        chunk.after = chunk.after.replace(regex, getLink);", "", "        if (chunk.after) {", "            chunk.after = chunk.after.replace(/\\n*$/, \"\");", "        }", "        if (!chunk.after) {", "            chunk.selection = chunk.selection.replace(/\\n*$/, \"\");", "        }", "", "        chunk.after += \"\\n\\n\" + defs;", "", "        return refOut;", "    };", "", "    // takes the line as entered into the add link/as image dialog and makes", "    // sure the URL and the optinal title are \"nice\".", "    function properlyEncoded(linkdef) {", "        return linkdef.replace(/^\\s*(.*?)(?:\\s+\"(.+)\")?\\s*$/, function (wholematch, link, title) {", "            link = link.replace(/\\?.*$/, function (querypart) {", "                return querypart.replace(/\\+/g, \" \"); // in the query string, a plus and a space are identical", "            });", "            link = decodeURIComponent(link); // unencode first, to prevent double encoding", "            link = encodeURI(link).replace(/'/g, '%27').replace(/\\(/g, '%28').replace(/\\)/g, '%29');", "            link = link.replace(/\\?.*$/, function (querypart) {", "                return querypart.replace(/\\+/g, \"%2b\"); // since we replaced plus with spaces in the query part, all pluses that now appear where originally encoded", "            });", "            if (title) {", "                title = title.trim ? title.trim() : title.replace(/^\\s*/, \"\").replace(/\\s*$/, \"\");", "                title = title.replace(/\"/g, \"quot;\").replace(/\\(/g, \"&#40;\").replace(/\\)/g, \"&#41;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\");", "            }", "            return title ? link + ' \"' + title + '\"' : link;", "        });", "    }", "", "    commandProto.doLinkOrImage = function (chunk, postProcessing, isImage) {", "", "        chunk.trimWhitespace();", "        chunk.findTags(/\\s*!?\\[/, /\\][ ]?(?:\\n[ ]*)?(\\[.*?\\])?/);", "        var background;", "", "        if (chunk.endTag.length > 1 && chunk.startTag.length > 0) {", "", "            chunk.startTag = chunk.startTag.replace(/!?\\[/, \"\");", "            chunk.endTag = \"\";", "            this.addLinkDef(chunk, null);", "", "        }", "        else {", "", "            // We're moving start and end tag back into the selection, since (as we're in the else block) we're not", "            // *removing* a link, but *adding* one, so whatever findTags() found is now back to being part of the", "            // link text. linkEnteredCallback takes care of escaping any brackets.", "            chunk.selection = chunk.startTag + chunk.selection + chunk.endTag;", "            chunk.startTag = chunk.endTag = \"\";", "", "            if (/\\n\\n/.test(chunk.selection)) {", "                this.addLinkDef(chunk, null);", "                return;", "            }", "            var that = this;", "            // The function to be executed when you enter a link and press OK or Cancel.", "            // Marks up the link and adds the ref.", "            var linkEnteredCallback = function (link) {", "", "                background.parentNode.removeChild(background);", "", "                if (link !== null) {", "                    // (                          $1", "                    //     [^\\\\]                  anything that's not a backslash", "                    //     (?:\\\\\\\\)*              an even number (this includes zero) of backslashes", "                    // )", "                    // (?=                        followed by", "                    //     [[\\]]                  an opening or closing bracket", "                    // )", "                    //", "                    // In other words, a non-escaped bracket. These have to be escaped now to make sure they", "                    // don't count as the end of the link or similar.", "                    // Note that the actual bracket has to be a lookahead, because (in case of to subsequent brackets),", "                    // the bracket in one match may be the \"not a backslash\" character in the next match, so it", "                    // should not be consumed by the first match.", "                    // The \"prepend a space and finally remove it\" steps makes sure there is a \"not a backslash\" at the", "                    // start of the string, so this also works if the selection begins with a bracket. We cannot solve", "                    // this by anchoring with ^, because in the case that the selection starts with two brackets, this", "                    // would mean a zero-width match at the start. Since zero-width matches advance the string position,", "                    // the first bracket could then not act as the \"not a backslash\" for the second.", "                    chunk.selection = (\" \" + chunk.selection).replace(/([^\\\\](?:\\\\\\\\)*)(?=[[\\]])/g, \"$1\\\\\").substr(1);", "", "                    var linkDef = \" [999]: \" + properlyEncoded(link);", "", "                    var num = that.addLinkDef(chunk, linkDef);", "                    chunk.startTag = isImage ? \"![\" : \"[\";", "                    chunk.endTag = \"][\" + num + \"]\";", "", "                    if (!chunk.selection) {", "                        if (isImage) {", "                            chunk.selection = that.getString(\"imagedescription\");", "                        }", "                        else {", "                            chunk.selection = that.getString(\"linkdescription\");", "                        }", "                    }", "                }", "                postProcessing();", "            };", "", "            background = ui.createBackground();", "", "            if (isImage) {", "                if (!this.hooks.insertImageDialog(linkEnteredCallback))", "                    ui.prompt(this.getString(\"imagedialog\"), imageDefaultText, linkEnteredCallback);", "            }", "            else {", "                if (!this.hooks.insertLinkDialog(linkEnteredCallback))", "                    ui.prompt(this.getString(\"linkdialog\"), linkDefaultText, linkEnteredCallback);", "            }", "            return true;", "        }", "    };", "", "    // When making a list, hitting shift-enter will put your cursor on the next line", "    // at the current indent level.", "    commandProto.doAutoindent = function (chunk, postProcessing) {", "", "        var commandMgr = this,", "            fakeSelection = false;", "", "        chunk.before = chunk.before.replace(/(\\n|^)[ ]{0,3}([*+-]|\\d+[.])[ \\t]*\\n$/, \"\\n\\n\");", "        chunk.before = chunk.before.replace(/(\\n|^)[ ]{0,3}>[ \\t]*\\n$/, \"\\n\\n\");", "        chunk.before = chunk.before.replace(/(\\n|^)[ \\t]+\\n$/, \"\\n\\n\");", "", "        // There's no selection, end the cursor wasn't at the end of the line:", "        // The user wants to split the current list item / code line / blockquote line", "        // (for the latter it doesn't really matter) in two. Temporarily select the", "        // (rest of the) line to achieve this.", "        if (!chunk.selection && !/^[ \\t]*(?:\\n|$)/.test(chunk.after)) {", "            chunk.after = chunk.after.replace(/^[^\\n]*/, function (wholeMatch) {", "                chunk.selection = wholeMatch;", "                return \"\";", "            });", "            fakeSelection = true;", "        }", "", "        if (/(\\n|^)[ ]{0,3}([*+-]|\\d+[.])[ \\t]+.*\\n$/.test(chunk.before)) {", "            if (commandMgr.doList) {", "                commandMgr.doList(chunk);", "            }", "        }", "        if (/(\\n|^)[ ]{0,3}>[ \\t]+.*\\n$/.test(chunk.before)) {", "            if (commandMgr.doBlockquote) {", "                commandMgr.doBlockquote(chunk);", "            }", "        }", "        if (/(\\n|^)(\\t|[ ]{4,}).*\\n$/.test(chunk.before)) {", "            if (commandMgr.doCode) {", "                commandMgr.doCode(chunk);", "            }", "        }", "", "        if (fakeSelection) {", "            chunk.after = chunk.selection + chunk.after;", "            chunk.selection = \"\";", "        }", "    };", "", "    commandProto.doBlockquote = function (chunk, postProcessing) {", "", "        chunk.selection = chunk.selection.replace(/^(\\n*)([^\\r]+?)(\\n*)$/,", "            function (totalMatch, newlinesBefore, text, newlinesAfter) {", "                chunk.before += newlinesBefore;", "                chunk.after = newlinesAfter + chunk.after;", "                return text;", "            });", "", "        chunk.before = chunk.before.replace(/(>[ \\t]*)$/,", "            function (totalMatch, blankLine) {", "                chunk.selection = blankLine + chunk.selection;", "                return \"\";", "            });", "", "        chunk.selection = chunk.selection.replace(/^(\\s|>)+$/, \"\");", "        chunk.selection = chunk.selection || this.getString(\"quoteexample\");", "", "        // The original code uses a regular expression to find out how much of the", "        // text *directly before* the selection already was a blockquote:", "", "        /*", "        if (chunk.before) {", "        chunk.before = chunk.before.replace(/\\n?$/, \"\\n\");", "        }", "        chunk.before = chunk.before.replace(/(((\\n|^)(\\n[ \\t]*)*>(.+\\n)*.*)+(\\n[ \\t]*)*$)/,", "        function (totalMatch) {", "        chunk.startTag = totalMatch;", "        return \"\";", "        });", "        */", "", "        // This comes down to:", "        // Go backwards as many lines a possible, such that each line", "        //  a) starts with \">\", or", "        //  b) is almost empty, except for whitespace, or", "        //  c) is preceeded by an unbroken chain of non-empty lines", "        //     leading up to a line that starts with \">\" and at least one more character", "        // and in addition", "        //  d) at least one line fulfills a)", "        //", "        // Since this is essentially a backwards-moving regex, it's susceptible to", "        // catstrophic backtracking and can cause the browser to hang;", "        // see e.g. http://meta.stackoverflow.com/questions/9807.", "        //", "        // Hence we replaced this by a simple state machine that just goes through the", "        // lines and checks for a), b), and c).", "", "        var match = \"\",", "            leftOver = \"\",", "            line;", "        if (chunk.before) {", "            var lines = chunk.before.replace(/\\n$/, \"\").split(\"\\n\");", "            var inChain = false;", "            for (var i = 0; i < lines.length; i++) {", "                var good = false;", "                line = lines[i];", "                inChain = inChain && line.length > 0; // c) any non-empty line continues the chain", "                if (/^>/.test(line)) {                // a)", "                    good = true;", "                    if (!inChain && line.length > 1)  // c) any line that starts with \">\" and has at least one more character starts the chain", "                        inChain = true;", "                } else if (/^[ \\t]*$/.test(line)) {   // b)", "                    good = true;", "                } else {", "                    good = inChain;                   // c) the line is not empty and does not start with \">\", so it matches if and only if we're in the chain", "                }", "                if (good) {", "                    match += line + \"\\n\";", "                } else {", "                    leftOver += match + line;", "                    match = \"\\n\";", "                }", "            }", "            if (!/(^|\\n)>/.test(match)) {             // d)", "                leftOver += match;", "                match = \"\";", "            }", "        }", "", "        chunk.startTag = match;", "        chunk.before = leftOver;", "", "        // end of change", "", "        /*benweet Don't really know the purpose of it but it is destructive", "", "        if (chunk.after) {", "            chunk.after = chunk.after.replace(/^\\n?/, \"\\n\");", "        }", "", "        chunk.after = chunk.after.replace(/^(((\\n|^)(\\n[ \\t]*)*>(.+\\n)*.*)+(\\n[ \\t]*)*)/,", "            function (totalMatch) {", "                chunk.endTag = totalMatch;", "                return \"\";", "            }", "        );", "        */", "", "        var replaceBlanksInTags = function (useBracket) {", "", "            var replacement = useBracket ? \"> \" : \"\";", "", "            if (chunk.startTag) {", "                chunk.startTag = chunk.startTag.replace(/\\n((>|\\s)*)\\n$/,", "                    function (totalMatch, markdown) {", "                        return \"\\n\" + markdown.replace(/^[ ]{0,3}>?[ \\t]*$/gm, replacement) + \"\\n\";", "                    });", "            }", "            if (chunk.endTag) {", "                chunk.endTag = chunk.endTag.replace(/^\\n((>|\\s)*)\\n/,", "                    function (totalMatch, markdown) {", "                        return \"\\n\" + markdown.replace(/^[ ]{0,3}>?[ \\t]*$/gm, replacement) + \"\\n\";", "                    });", "            }", "        };", "", "        if (/^(?![ ]{0,3}>)/m.test(chunk.selection)) {", "            this.wrap(chunk, SETTINGS.lineLength - 2);", "            chunk.selection = chunk.selection.replace(/^/gm, \"> \");", "            replaceBlanksInTags(true);", "            chunk.skipLines();", "        } else {", "            chunk.selection = chunk.selection.replace(/^[ ]{0,3}> ?/gm, \"\");", "            this.unwrap(chunk);", "            replaceBlanksInTags(false);", "", "            if (!/^(\\n|^)[ ]{0,3}>/.test(chunk.selection) && chunk.startTag) {", "                chunk.startTag = chunk.startTag.replace(/\\n{0,2}$/, \"\\n\\n\");", "            }", "", "            if (!/(\\n|^)[ ]{0,3}>.*$/.test(chunk.selection) && chunk.endTag) {", "                chunk.endTag = chunk.endTag.replace(/^\\n{0,2}/, \"\\n\\n\");", "            }", "        }", "", "        chunk.selection = this.hooks.postBlockquoteCreation(chunk.selection);", "", "        if (!/\\n/.test(chunk.selection)) {", "            chunk.selection = chunk.selection.replace(/^(> *)/,", "            function (wholeMatch, blanks) {", "                chunk.startTag += blanks;", "                return \"\";", "            });", "        }", "    };", "", "    commandProto.doCode = function (chunk, postProcessing) {", "", "        var hasTextBefore = /\\S[ ]*$/.test(chunk.before);", "        var hasTextAfter = /^[ ]*\\S/.test(chunk.after);", "", "        // Use 'four space' markdown if the selection is on its own", "        // line or is multiline.", "        if ((!hasTextAfter && !hasTextBefore) || /\\n/.test(chunk.selection)) {", "", "            chunk.before = chunk.before.replace(/[ ]{4}$/,", "                function (totalMatch) {", "                    chunk.selection = totalMatch + chunk.selection;", "                    return \"\";", "                });", "", "            var nLinesBack = 1;", "            var nLinesForward = 1;", "", "            if (/(\\n|^)(\\t|[ ]{4,}).*\\n$/.test(chunk.before)) {", "                nLinesBack = 0;", "            }", "            if (/^\\n(\\t|[ ]{4,})/.test(chunk.after)) {", "                nLinesForward = 0;", "            }", "", "            chunk.skipLines(nLinesBack, nLinesForward);", "", "            if (!chunk.selection) {", "                chunk.startTag = \"    \";", "                chunk.selection = this.getString(\"codeexample\");", "            }", "            else {", "                if (/^[ ]{0,3}\\S/m.test(chunk.selection)) {", "                    if (/\\n/.test(chunk.selection))", "                        chunk.selection = chunk.selection.replace(/^/gm, \"    \");", "                    else // if it's not multiline, do not select the four added spaces; this is more consistent with the doList behavior", "                        chunk.before += \"    \";", "                }", "                else {", "                    chunk.selection = chunk.selection.replace(/^(?:[ ]{4}|[ ]{0,3}\\t)/gm, \"\");", "                }", "            }", "        }", "        else {", "            // Use backticks (`) to delimit the code block.", "", "            chunk.trimWhitespace();", "            chunk.findTags(/`/, /`/);", "", "            if (!chunk.startTag && !chunk.endTag) {", "                chunk.startTag = chunk.endTag = \"`\";", "                if (!chunk.selection) {", "                    chunk.selection = this.getString(\"codeexample\");", "                }", "            }", "            else if (chunk.endTag && !chunk.startTag) {", "                chunk.before += chunk.endTag;", "                chunk.endTag = \"\";", "            }", "            else {", "                chunk.startTag = chunk.endTag = \"\";", "            }", "        }", "    };", "", "    commandProto.doList = function (chunk, postProcessing, isNumberedList) {", "", "        // These are identical except at the very beginning and end.", "        // Should probably use the regex extension function to make this clearer.", "        var previousItemsRegex = /(\\n|^)(([ ]{0,3}([*+-]|\\d+[.])[ \\t]+.*)(\\n.+|\\n{2,}([*+-].*|\\d+[.])[ \\t]+.*|\\n{2,}[ \\t]+\\S.*)*)\\n*$/;", "        var nextItemsRegex = /^\\n*(([ ]{0,3}([*+-]|\\d+[.])[ \\t]+.*)(\\n.+|\\n{2,}([*+-].*|\\d+[.])[ \\t]+.*|\\n{2,}[ \\t]+\\S.*)*)\\n*/;", "", "        // The default bullet is a dash but others are possible.", "        // This has nothing to do with the particular HTML bullet,", "        // it's just a markdown bullet.", "        var bullet = \"-\";", "", "        // The number in a numbered list.", "        var num = 1;", "", "        // Get the item prefix - e.g. \" 1. \" for a numbered list, \" - \" for a bulleted list.", "        var getItemPrefix = function () {", "            var prefix;", "            if (isNumberedList) {", "                prefix = \" \" + num + \". \";", "                num++;", "            }", "            else {", "                prefix = \" \" + bullet + \" \";", "            }", "            return prefix;", "        };", "", "        // Fixes the prefixes of the other list items.", "        var getPrefixedItem = function (itemText) {", "", "            // The numbering flag is unset when called by autoindent.", "            if (isNumberedList === undefined) {", "                isNumberedList = /^\\s*\\d/.test(itemText);", "            }", "", "            // Renumber/bullet the list element.", "            itemText = itemText.replace(/^[ ]{0,3}([*+-]|\\d+[.])\\s/gm,", "                function (_) {", "                    return getItemPrefix();", "                });", "", "            return itemText;", "        };", "", "        chunk.findTags(/(\\n|^)*[ ]{0,3}([*+-]|\\d+[.])\\s+/, null);", "", "        if (chunk.before && !/\\n$/.test(chunk.before) && !/^\\n/.test(chunk.startTag)) {", "            chunk.before += chunk.startTag;", "            chunk.startTag = \"\";", "        }", "", "        if (chunk.startTag) {", "", "            var hasDigits = /\\d+[.]/.test(chunk.startTag);", "            chunk.startTag = \"\";", "            chunk.selection = chunk.selection.replace(/\\n[ ]{4}/g, \"\\n\");", "            this.unwrap(chunk);", "            chunk.skipLines();", "", "            if (hasDigits) {", "                // Have to renumber the bullet points if this is a numbered list.", "                chunk.after = chunk.after.replace(nextItemsRegex, getPrefixedItem);", "            }", "            if (isNumberedList == hasDigits) {", "                return;", "            }", "        }", "", "        var nLinesUp = 1;", "", "        chunk.before = chunk.before.replace(previousItemsRegex,", "            function (itemText) {", "                if (/^\\s*([*+-])/.test(itemText)) {", "                    bullet = re.$1;", "                }", "                nLinesUp = /[^\\n]\\n\\n[^\\n]/.test(itemText) ? 1 : 0;", "                return getPrefixedItem(itemText);", "            });", "", "        if (!chunk.selection) {", "            chunk.selection = this.getString(\"litem\");", "        }", "", "        var prefix = getItemPrefix();", "", "        var nLinesDown = 1;", "", "        chunk.after = chunk.after.replace(nextItemsRegex,", "            function (itemText) {", "                nLinesDown = /[^\\n]\\n\\n[^\\n]/.test(itemText) ? 1 : 0;", "                return getPrefixedItem(itemText);", "            });", "", "        chunk.trimWhitespace(true);", "        chunk.skipLines(nLinesUp, nLinesDown, true);", "        chunk.startTag = prefix;", "        var spaces = prefix.replace(/./g, \" \");", "        this.wrap(chunk, SETTINGS.lineLength - spaces.length);", "        chunk.selection = chunk.selection.replace(/\\n/g, \"\\n\" + spaces);", "", "    };", "", "    commandProto.doHeading = function (chunk, postProcessing) {", "", "        // Remove leading/trailing whitespace and reduce internal spaces to single spaces.", "        chunk.selection = chunk.selection.replace(/\\s+/g, \" \");", "        chunk.selection = chunk.selection.replace(/(^\\s+|\\s+$)/g, \"\");", "", "        // If we clicked the button with no selected text, we just", "        // make a level 2 hash header around some default text.", "        if (!chunk.selection) {", "            chunk.startTag = \"## \";", "            chunk.selection = this.getString(\"headingexample\");", "            chunk.endTag = \" ##\";", "            return;", "        }", "", "        var headerLevel = 0;     // The existing header level of the selected text.", "", "        // Remove any existing hash heading markdown and save the header level.", "        chunk.findTags(/#+[ ]*/, /[ ]*#+/);", "        if (/#+/.test(chunk.startTag)) {", "            headerLevel = re.lastMatch.length;", "        }", "        chunk.startTag = chunk.endTag = \"\";", "", "        // Try to get the current header level by looking for - and = in the line", "        // below the selection.", "        chunk.findTags(null, /\\s?(-+|=+)/);", "        if (/=+/.test(chunk.endTag)) {", "            headerLevel = 1;", "        }", "        if (/-+/.test(chunk.endTag)) {", "            headerLevel = 2;", "        }", "", "        // Skip to the next line so we can create the header markdown.", "        chunk.startTag = chunk.endTag = \"\";", "        chunk.skipLines(1, 1);", "", "        // We make a level 2 header if there is no current header.", "        // If there is a header level, we substract one from the header level.", "        // If it's already a level 1 header, it's removed.", "        var headerLevelToCreate = headerLevel == 0 ? 2 : headerLevel - 1;", "", "        if (headerLevelToCreate > 0) {", "", "            // The button only creates level 1 and 2 underline headers.", "            // Why not have it iterate over hash header levels?  Wouldn't that be easier and cleaner?", "            var headerChar = headerLevelToCreate >= 2 ? \"-\" : \"=\";", "            var len = chunk.selection.length;", "            if (len > SETTINGS.lineLength) {", "                len = SETTINGS.lineLength;", "            }", "            chunk.endTag = \"\\n\";", "            while (len--) {", "                chunk.endTag += headerChar;", "            }", "        }", "    };", "", "    commandProto.doHorizontalRule = function (chunk, postProcessing) {", "        chunk.startTag = \"----------\\n\";", "        chunk.selection = \"\";", "        chunk.skipLines(2, 1, true);", "    }", "", "", "})();"]}, {"lines": ["        title=title,", "        category=category,", "        creator=user,", "        description=description,"]}, {"lines": ["    )"]}, {"lines": [""]}, {"lines": ["", ""]}, {"lines": ["    permissions = kwargs.get('permissions')", "    if permissions is None:", "        raise HTTPError(http.BAD_REQUEST)", ""]}, {"lines": ["    }"]}, {"lines": ["GNUPG_HOME = os.path.join(BASE_PATH, 'gpg')", "GNUPG_BINARY = 'gpg'"]}, {"lines": ["# Use GnuPG for encryption", "USE_GNUPG = True", ""]}, {"lines": ["    <title>OSF | ${self.title()}</title>"]}, {"lines": ["<%def name=\"title()\">${node['title']} Files</%def>"]}, {"lines": ["<%def name=\"title()\">${node['title']} Settings</%def>"]}, {"lines": ["<form role=\"form\" id=\"addonSettings${addon_short_name.capitalize()}\" data-addon=\"${addon_short_name}\">"]}, {"lines": [""]}, {"lines": [""]}], "name": "Robert Liebowitz"}, {"commits": [{"lines": ["    def test_register_email_case_insensitive(self):", "        url = api_url_for('register_user')", "        name, email, password = fake.name(), fake.email(), 'underpressure'", "        self.app.post_json(", "            url,", "            {", "                'fullName': name,", "                'email1': email,", "                'email2': str(email).upper(),", "                'password': password,", "            }", "        )", "        user = User.find_one(Q('username', 'eq', email))", "        assert_equal(user.fullname, name)", ""]}], "name": "Revanth"}, {"commits": [{"lines": ["    def test_fails_to_create_project_with_whitespace_title(self):", "        payload = {", "            'title': '   '", "        }", "        res = self.app.post_json(", "            self.url, payload, auth=self.creator.auth, expect_errors=True)", "        assert_equal(res.status_code, 400)", ""]}, {"lines": ["        \"\"\"List a repo's branches or get a single branch (in a list)."]}, {"lines": ["        if branch:", "            return [self.repo(user, repo).branch(branch)]"]}, {"lines": ["        self.project.save()"]}, {"lines": ["        self.github = create_mock_github(user='fred', private=False)"]}, {"lines": ["        self.github = create_mock_github(user='fred', private=False)"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["    # make a user with no authorization; make sure check_permissions returns false"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["        # project is set to private right now"]}, {"lines": ["        connection = github_mock", "        non_authenticated_user = UserFactory()"]}, {"lines": ["        branch = 'master'"]}, {"lines": ["    # make a repository that doesn't allow push access for this user;", "    # make sure check_permissions returns false", "    @mock.patch('website.addons.github.model.AddonGitHubUserSettings.has_auth')", "    @mock.patch('website.addons.github.api.GitHub.repo')", "    def test_permissions_no_access(self, mock_repo, mock_has_auth):"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["        mock_has_auth.return_value = True", "        connection = github_mock", "        branch = 'master'", "        mock_repository = mock.NonCallableMock()", "        mock_repository.user = 'fred'", "        mock_repository.repo = 'mock-repo'"]}, {"lines": ["        mock_repo.return_value = mock_repository", "        assert_false(check_permissions(self.node_settings, self.consolidated_auth, connection, branch, repo=mock_repository))", ""]}, {"lines": ["    # make a branch with a different commit than the commit being passed into check_permissions", "    @mock.patch('website.addons.github.model.AddonGitHubUserSettings.has_auth')", "    def test_permissions_not_head(self, mock_has_auth):"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["        mock_has_auth.return_value = True", "        connection = github_mock", "        mock_branch = mock.NonCallableMock()", "        mock_branch.commit.sha = '67890'", "        sha = '12345'", "        assert_false(check_permissions(self.node_settings, self.consolidated_auth, connection, mock_branch, sha=sha))"]}, {"lines": ["    # make sure permissions are not granted for editing a registration", "    @mock.patch('website.addons.github.model.AddonGitHubUserSettings.has_auth')", "    def test_permissions(self, mock_has_auth):"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["        mock_has_auth.return_value = True", "        connection = github_mock", "        self.node_settings.owner.is_registration = True", "        assert_false(check_permissions(self.node_settings, self.consolidated_auth, connection, 'master'))"]}, {"lines": ["        self.github = create_mock_github(user='fred', private=False)"]}, {"lines": ["        github_mock = self.github"]}, {"lines": ["        github_mock = self.github"]}, {"lines": [""]}, {"lines": ["        try:", "            node.set_title(value, auth=auth)"]}, {"lines": ["            raise HTTPError("]}, {"lines": ["                http.BAD_REQUEST,"]}, {"lines": ["            )"]}, {"lines": ["    title = title.strip()"]}], "name": "csheldonhess"}, {"commits": [{"lines": ["    'them from the original project before registering.'"]}, {"lines": ["    'original project.'"]}, {"lines": ["        </div>"]}], "name": "jlcohoon"}, {"commits": [{"lines": ["TEMPLATED_FROM_PREFIX = \"Templated from \"", "", "# MFR Error handling"]}, {"lines": ["SUPPORT = \"Contact support@osf.io for further assistance.\"", "", "# Custom Error Messages w/ support", "STATA_VERSION_ERROR = 'Version of given Stata file is not 104, 105, 108, 113 (Stata 8/9), 114 (Stata 10/11) or 115 (Stata 12)<p>{0}</p>'.format(SUPPORT)"]}, {"lines": ["    'framework.tasks',"]}], "name": "Alexander Schiller"}, {"commits": [{"lines": ["        Rule('/news/', 'get', {}, OsfWebRenderer('public/pages/news.mako')),", ""]}, {"lines": ["<body data-spy=\"scroll\" data-target=\".nav-list-spy\">"]}, {"lines": ["<%def name=\"content()\">"]}, {"lines": ["        </div>"]}, {"lines": ["        </div>"]}, {"lines": ["    </div>"]}, {"lines": ["You have been added by ${referrer.fullname} as a contributor to the project \"${node.title}\" on the Open Science Framework. To claim yourself as a contributor to the project, visit this url:"]}, {"lines": ["Once you are logged in, you will be able to make contributions to ${node.title}."]}, {"lines": ["Want more information? Visit http://osf.io/ or http://cos.io/ for information about the Open Science Framework and its supporting organization, the Center for Open Science. Questions? Email contact@osf.io"]}, {"lines": ["    existing features. For updates on new features, you can join our <a href=\"https://groups.google.com/forum/#!forum/openscienceframework\">Google"]}, {"lines": ["        </div>"]}, {"lines": ["        </div>"]}, {"lines": ["</div>"]}, {"lines": ["</div>"]}, {"lines": ["        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"N1Jk7ax2UHs\"></div>", "        </div>", "    </div>", ""]}, {"lines": [""]}, {"lines": ["        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"CiwtT70rafU\"></div>", "        </div>", "    </div>", "</div>"]}, {"lines": ["        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"RVFTg0iT2gg\"></div>", "        </div>", "    </div>", "</div>"]}, {"lines": ["        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"iOkb9OH4x5k\"></div>", "        </div>", "    </div>", "</div>"]}, {"lines": ["        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"hmWjJ4En33Q\"></div>", "        </div>", "    </div>", "</div>"]}, {"lines": ["        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"rj89AgTdIvA\"></div>", "        </div>", "    </div>", "</div>"]}, {"lines": ["</div>"]}, {"lines": ["<span id=\"wiki\" class=\"anchor\"></span>"]}, {"lines": [""]}, {"lines": ["        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"BWlRGvg3Ro4\"></div>", "        </div>", "    </div>", "</div>"]}, {"lines": [""]}, {"lines": ["    <div class=\"col-md-8 col-md-offset-2 col-sm-12\">", "        <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "            <div class=\"embed-responsive-item youtube-loader\" id=\"2RVJS7nYX8k\"></div>", "        </div>", "    </div>"]}, {"lines": ["</div>"]}], "name": "Johanna Cohoon"}, {"commits": [{"lines": [""]}, {"lines": ["    @property"]}, {"lines": [""]}, {"lines": ["    def to_json(self, user):", "        ret = super(AddonUserSettingsBase, self).to_json(user)"]}, {"lines": ["        ret.update({"]}, {"lines": ["        })", "        return ret", ""]}, {"lines": [""]}, {"lines": ["                '/project/<pid>/github/config/',"]}, {"lines": ["                '/project/<pid>/node/<nid>/github/config/'", ""]}, {"lines": ["<%def name=\"on_submit()\"></%def>", ""]}, {"lines": [""]}, {"lines": ["                </div>"]}, {"lines": ["            % endif"]}, {"lines": [""]}], "name": "Austin"}, {"commits": [{"lines": ["        <div class=\"text-info dataverse-settings\" data-bind=\"if: credentialsChanged\">"]}, {"lines": ["            node_settings.deauthorize(save=True)"]}], "name": "="}, {"commits": [{"lines": [""]}, {"lines": ["/**", " * Github FileBrowser configuration module.", " */"]}, {"lines": [""]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": ["        branches=[each.name for each in branches],"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    }"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["    }"]}], "name": "Faye"}, {"commits": [{"lines": [""]}, {"lines": ["    def before_make_public(self, node):", "        return ("]}, {"lines": ["            '</strong>.'", "        ).format(", "            cat=node.project_or_component,", "        )", "", "    def after_delete(self, node, user):", "        self.deauthorize(Auth(user=user), add_log=True, save=True)", "", "    def before_register(self, node, user):"]}, {"lines": [""]}, {"lines": ["    # TODO: refactor this, watch_post, unwatch_post (@mambocab)"]}, {"lines": [""]}, {"lines": ["    user.save()", ""]}], "name": "Jim Witschey"}, {"commits": [{"lines": [""]}, {"lines": ["        }"]}, {"lines": ["                <p class=\"break-word\">"]}, {"lines": ["                            <div class=\"break-word\">"]}, {"lines": ["                                <h4 data-bind=\"if: selected\" class=\"${addon_short_name}-confirm-dlg\">", "                                    Connect &ldquo;{{ selectedFolderName }}&rdquo;?", "                                </h4>", "                            </div>"]}], "name": "Faye Huynh"}, {"commits": [{"lines": ["        if (item.kind === 'file' && privateOrSiblings && item.data.permissions && item.data.permissions.edit) {"]}, {"lines": [""]}, {"lines": ["new AddonNodeConfig('Google Drive', '#googledriveScope', url, '#googledriveGrid',", "    {", "        decodeFolder: (function(folder_name) {", "            return decodeURIComponent(folder_name);", "        })", "    }", ");", ""]}, {"lines": ["", "    return m('span', {", "        className: cls,", "        onclick: onclick", "    }, tb.options.decodeFolder(item.data.name));"]}, {"lines": ["function treebeardDecodeFolder(item) {", "    return item;", "}", ""]}, {"lines": ["    decodeFolder: treebeardDecodeFolder,"]}, {"lines": ["        var decodeFolderSpy = sinon.spy();"]}, {"lines": ["            onPickFolder: onPickFolderSpy,", "            decodeFolder: decodeFolderSpy"]}, {"lines": ["                vm.treebeardOptions.decodeFolder();", "                assert.calledOnce(opts.decodeFolder);"]}, {"lines": ["            <!-- Loading Import Text -->", "            <span data-bind=\"if: showLoading\">", "                <p class=\"text-muted pull-right addon-auth\">", "                    Loading ...", "                </p>", "            </span>", ""]}], "name": "Henrique Moco"}, {"commits": [{"lines": ["<%inherit file=\"project/addon/widget.mako\"/>", "<%include file=\"project/addon/citations_widget.mako\"/>"]}, {"lines": ["        \"\"\"An API session with Zotero\"\"\""]}, {"lines": ["        \"\"\"List of CitationList objects, derived from Zotero collections\"\"\""]}, {"lines": ["        collections = client.collections()"]}, {"lines": [""]}, {"lines": ["        ]"]}, {"lines": [""]}, {"lines": ["        \"\"\"Get a single CitationList", "", "        :param str list_id: ID for a Zotero collection. Optional.", "        :return CitationList: CitationList for the collection, or for all documents", "        \"\"\""]}, {"lines": ["", "    def _citations_for_zotero_collection(self, collection):"]}, {"lines": ["        \"\"\"Get all the citations in a specified collection"]}, {"lines": [""]}, {"lines": ["        :param  csljson collection: list of csljson documents", "        :return list of citation objects representing said dicts of said documents.", "        \"\"\""]}, {"lines": ["", "    def _citations_for_zotero_user(self):"]}, {"lines": ["        \"\"\"Get all the citations from the user \"\"\""]}, {"lines": ["                '/settings/zotero/accounts/',", "            ],", "            'get',"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["            ],"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["            ],"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            ["]}, {"lines": ["                '/project/<pid>/zotero/widget/',", "                '/project/<pid>/node/<nid>/zotero/widget/',", "            ],", "            'get',", "            views.zotero_widget,", "            json_renderer,", "        ),"]}, {"lines": ["        Rule(", "            [", "                '/project/<pid>/zotero/citations/',", "                '/project/<pid>/node/<nid>/zotero/citations/',"]}, {"lines": ["            ],", "            'get',", "            views.zotero_citation_list,", "            json_renderer,", "", "        ),", ""]}, {"lines": ["var $ = require('jquery');", "var ko = require('knockout');"]}, {"lines": ["////////////////", "// Public API //", "////////////////", ""]}, {"lines": ["}", "", "CitationsWidget.prototype.init = function() {", "    var self = this;", "    ko.applyBindings(self.viewModel, self.$element[0]);", "};", ""]}, {"lines": ["<%inherit file=\"project/addon/widget.mako\"/>", "<%include file=\"project/addon/citations_widget.mako\"/>"]}, {"lines": ["import httplib as http"]}, {"lines": ["from framework.exceptions import HTTPError", "from framework.exceptions import PermissionsError"]}, {"lines": ["from oauthlib.oauth2.rfc6749.errors import MissingTokenError"]}, {"lines": ["            try:", "                response = OAuth2Session(", "                    self.client_id,", "                    redirect_uri=web_url_for(", "                        'oauth_callback',", "                        service_name=self.short_name,", "                        _absolute=True", "                    ),", "                ).fetch_token(", "                    self.callback_url,", "                    client_secret=self.client_secret,", "                    code=request.args.get('code'),", "                )"]}, {"lines": ["                raise HTTPError(http.SERVICE_UNAVAILABLE)"]}], "name": "Harris Mendell"}, {"commits": [{"lines": ["        Rule(["]}, {"lines": ["        ], 'delete', views.project_wiki_delete, json_renderer),", ""]}, {"lines": ["        </div>"]}, {"lines": ["        </ul>"]}, {"lines": ["    others_count = ''"]}, {"lines": ["            separator = '&nbsp;&'"]}, {"lines": ["        message = (", "            'Your component was created successfully. You can keep working on the component page below, '", "            'or return to the <u><a href=\"{url}\">Project Page</a></u>.'"]}, {"lines": ["        status.push_status_message(message, 'info')", ""]}], "name": "Casey"}, {"commits": [{"lines": ["                % endif"]}, {"lines": ["            %endfor"]}, {"lines": ["        <hr />"]}, {"lines": ["                <li>"]}], "name": "Erica Baranski"}, {"commits": [{"lines": ["from modularodm import fields"]}, {"lines": ["class Zotero(ExternalProvider):", "    name = \"Zotero\"", "    short_name = \"zotero\"", "    _oauth_version = 1", "", "    client_id = settings.ZOTERO_CLIENT_ID", "    client_secret = settings.ZOTERO_CLIENT_SECRET", "", "    auth_url_base = 'https://www.zotero.org/oauth/authorize'", "    callback_url = 'https://www.zotero.org/oauth/access'", "    request_token_url = 'https://www.zotero.org/oauth/request'", "    default_scopes = ['all']", "", "    _client = None", "", "    def handle_callback(self, response):"]}, {"lines": ["        return {"]}, {"lines": ["        }", ""]}, {"lines": ["    @property", "    def client(self):"]}, {"lines": ["        if not self._client:", "            self._client = zotero.Zotero(self.account.provider_id, 'user', self.account.oauth_key)", "        return self._client", ""]}, {"lines": ["        client = self.client", ""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["from framework.routing import Rule, json_renderer"]}, {"lines": ["", "from website.addons.zotero import views", "", "api_routes = {", "    'rules': [", "        Rule(", "            ["]}, {"lines": ["            ],", "            'get',"]}, {"lines": ["            json_renderer,", "        ),", "        Rule(", "            ["]}, {"lines": ["            ],"]}, {"lines": ["            json_renderer,", "        ),"]}, {"lines": ["    ],"]}], "name": "harrismendell"}, {"commits": [{"lines": ["        'fullname': fullname,", "        'shortname': fullname if len(fullname) < 50 else fullname[:23] + \"...\" + fullname[-23:],"]}, {"lines": ["        <%", "            condensed = contributor['fullname']"]}, {"lines": ["            is_condensed = False"]}, {"lines": ["            if len(condensed) >= 50:", "                condensed = condensed[:23] + \"...\" + condensed[-23:]"]}, {"lines": ["                is_condensed = True"]}, {"lines": ["        %>"]}, {"lines": ["            <a class='user-profile' rel=\"${'tooltip' if is_condensed else ''}\" title=\"${contributor['fullname']}\" href=\"/${contributor['id']}/\">${condensed}</a></li>"]}, {"lines": ["            <span rel=\"${'tooltip' if is_condensed else ''}\" title=\"${contributor['fullname']}\">${condensed}</span></li>"]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["<a class=\"overflow contributor-name\""]}, {"lines": ["    <span class=\"overflow contributor-name\">${user_display_name}</span>"]}], "name": "Ginny Huang"}, {"commits": [{"lines": [""]}, {"lines": ["def show_diff(seqm):", "    \"\"\"Unify operations between two compared strings", "seqm is a difflib.SequenceMatcher instance whose a & b are strings\"\"\""]}, {"lines": ["    insert_el = '<span style=\"background:#4AA02C; font-size:1.5em; \">'", "    ins_el_close = '</span>'", "    del_el = '<span style=\"background:#D16587; font-size:1.5em;\">'", "    del_el_close = '</span>'", "    for opcode, a0, a1, b0, b1 in seqm.get_opcodes():"]}, {"lines": ["        if opcode == 'equal':"]}, {"lines": ["        elif opcode == 'insert':"]}, {"lines": ["        elif opcode == 'delete':"]}, {"lines": ["        elif opcode == 'replace':"]}, {"lines": ["        else:"]}, {"lines": ["    return ''.join(output)", ""]}, {"lines": ["    if description:"]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["import time"]}, {"lines": [""]}, {"lines": ["(function(){function t(t){return t.target}function n(t){return t.source}function e(t,n){try{for(var e in n)Object.defineProperty(t.prototype,e,{value:n[e],enumerable:!1})}catch(r){t.prototype=n}}function r(t){for(var n=-1,e=t.length,r=[];e>++n;)r.push(t[n]);return r}function i(t){return Array.prototype.slice.call(t)}function u(){}function a(t){return t}function o(){return!0}function c(t){return\"function\"==typeof t?t:function(){return t}}function l(t,n,e){return function(){var r=e.apply(n,arguments);return arguments.length?t:r}}function s(t){return null!=t&&!isNaN(t)}function f(t){return t.length}function h(t){return t.trim().replace(/\\s+/g,\" \")}function d(t){for(var n=1;t*n%1;)n*=10;return n}function g(t){return 1===t.length?function(n,e){t(null==n?e:null)}:t}function p(t){return t.responseText}function m(t){return JSON.parse(t.responseText)}function v(t){var n=document.createRange();return n.selectNode(document.body),n.createContextualFragment(t.responseText)}function y(t){return t.responseXML}function M(){}function b(t){function n(){for(var n,r=e,i=-1,u=r.length;u>++i;)(n=r[i].on)&&n.apply(this,arguments);return t}var e=[],r=new u;return n.on=function(n,i){var u,a=r.get(n);return 2>arguments.length?a&&a.on:(a&&(a.on=null,e=e.slice(0,u=e.indexOf(a)).concat(e.slice(u+1)),r.remove(n)),i&&e.push(r.set(n,{on:i})),t)},n}function x(t,n){return n-(t?1+Math.floor(Math.log(t+Math.pow(10,1+Math.floor(Math.log(t)/Math.LN10)-n))/Math.LN10):1)}function _(t){return t+\"\"}function w(t,n){var e=Math.pow(10,3*Math.abs(8-n));return{scale:n>8?function(t){return t/e}:function(t){return t*e},symbol:t}}function S(t){return function(n){return 0>=n?0:n>=1?1:t(n)}}function k(t){return function(n){return 1-t(1-n)}}function E(t){return function(n){return.5*(.5>n?t(2*n):2-t(2-2*n))}}function A(t){return t*t}function N(t){return t*t*t}function T(t){if(0>=t)return 0;if(t>=1)return 1;var n=t*t,e=n*t;return 4*(.5>t?e:3*(t-n)+e-.75)}function q(t){return function(n){return Math.pow(n,t)}}function C(t){return 1-Math.cos(t*Ru/2)}function z(t){return Math.pow(2,10*(t-1))}function D(t){return 1-Math.sqrt(1-t*t)}function L(t,n){var e;return 2>arguments.length&&(n=.45),arguments.length?e=n/(2*Ru)*Math.asin(1/t):(t=1,e=n/4),function(r){return 1+t*Math.pow(2,10*-r)*Math.sin(2*(r-e)*Ru/n)}}function F(t){return t||(t=1.70158),function(n){return n*n*((t+1)*n-t)}}function H(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function R(){d3.event.stopPropagation(),d3.event.preventDefault()}function P(){for(var t,n=d3.event;t=n.sourceEvent;)n=t;return n}function j(t){for(var n=new M,e=0,r=arguments.length;r>++e;)n[arguments[e]]=b(n);return n.of=function(e,r){return function(i){try{var u=i.sourceEvent=d3.event;i.target=t,d3.event=i,n[i.type].apply(e,r)}finally{d3.event=u}}},n}function O(t){var n=[t.a,t.b],e=[t.c,t.d],r=U(n),i=Y(n,e),u=U(I(e,n,-i))||0;n[0]*e[1]<e[0]*n[1]&&(n[0]*=-1,n[1]*=-1,r*=-1,i*=-1),this.rotate=(r?Math.atan2(n[1],n[0]):Math.atan2(-e[0],e[1]))*Ou,this.translate=[t.e,t.f],this.scale=[r,u],this.skew=u?Math.atan2(i,u)*Ou:0}function Y(t,n){return t[0]*n[0]+t[1]*n[1]}function U(t){var n=Math.sqrt(Y(t,t));return n&&(t[0]/=n,t[1]/=n),n}function I(t,n,e){return t[0]+=e*n[0],t[1]+=e*n[1],t}function V(t){return\"transform\"==t?d3.interpolateTransform:d3.interpolate}function X(t,n){return n=n-(t=+t)?1/(n-t):0,function(e){return(e-t)*n}}function Z(t,n){return n=n-(t=+t)?1/(n-t):0,function(e){return Math.max(0,Math.min(1,(e-t)*n))}}function B(){}function $(t,n,e){return new J(t,n,e)}function J(t,n,e){this.r=t,this.g=n,this.b=e}function G(t){return 16>t?\"0\"+Math.max(0,t).toString(16):Math.min(255,t).toString(16)}function K(t,n,e){var r,i,u,a=0,o=0,c=0;if(r=/([a-z]+)\\((.*)\\)/i.exec(t))switch(i=r[2].split(\",\"),r[1]){case\"hsl\":return e(parseFloat(i[0]),parseFloat(i[1])/100,parseFloat(i[2])/100);case\"rgb\":return n(nn(i[0]),nn(i[1]),nn(i[2]))}return(u=aa.get(t))?n(u.r,u.g,u.b):(null!=t&&\"#\"===t.charAt(0)&&(4===t.length?(a=t.charAt(1),a+=a,o=t.charAt(2),o+=o,c=t.charAt(3),c+=c):7===t.length&&(a=t.substring(1,3),o=t.substring(3,5),c=t.substring(5,7)),a=parseInt(a,16),o=parseInt(o,16),c=parseInt(c,16)),n(a,o,c))}function W(t,n,e){var r,i,u=Math.min(t/=255,n/=255,e/=255),a=Math.max(t,n,e),o=a-u,c=(a+u)/2;return o?(i=.5>c?o/(a+u):o/(2-a-u),r=t==a?(n-e)/o+(e>n?6:0):n==a?(e-t)/o+2:(t-n)/o+4,r*=60):i=r=0,en(r,i,c)}function Q(t,n,e){t=tn(t),n=tn(n),e=tn(e);var r=gn((.4124564*t+.3575761*n+.1804375*e)/sa),i=gn((.2126729*t+.7151522*n+.072175*e)/fa),u=gn((.0193339*t+.119192*n+.9503041*e)/ha);return ln(116*i-16,500*(r-i),200*(i-u))}function tn(t){return.04045>=(t/=255)?t/12.92:Math.pow((t+.055)/1.055,2.4)}function nn(t){var n=parseFloat(t);return\"%\"===t.charAt(t.length-1)?Math.round(2.55*n):n}function en(t,n,e){return new rn(t,n,e)}function rn(t,n,e){this.h=t,this.s=n,this.l=e}function un(t,n,e){function r(t){return t>360?t-=360:0>t&&(t+=360),60>t?u+(a-u)*t/60:180>t?a:240>t?u+(a-u)*(240-t)/60:u}function i(t){return Math.round(255*r(t))}var u,a;return t%=360,0>t&&(t+=360),n=0>n?0:n>1?1:n,e=0>e?0:e>1?1:e,a=.5>=e?e*(1+n):e+n-e*n,u=2*e-a,$(i(t+120),i(t),i(t-120))}function an(t,n,e){return new on(t,n,e)}function on(t,n,e){this.h=t,this.c=n,this.l=e}function cn(t,n,e){return ln(e,Math.cos(t*=ju)*n,Math.sin(t)*n)}function ln(t,n,e){return new sn(t,n,e)}function sn(t,n,e){this.l=t,this.a=n,this.b=e}function fn(t,n,e){var r=(t+16)/116,i=r+n/500,u=r-e/200;return i=dn(i)*sa,r=dn(r)*fa,u=dn(u)*ha,$(pn(3.2404542*i-1.5371385*r-.4985314*u),pn(-.969266*i+1.8760108*r+.041556*u),pn(.0556434*i-.2040259*r+1.0572252*u))}function hn(t,n,e){return an(180*(Math.atan2(e,n)/Ru),Math.sqrt(n*n+e*e),t)}function dn(t){return t>.206893034?t*t*t:(t-4/29)/7.787037}function gn(t){return t>.008856?Math.pow(t,1/3):7.787037*t+4/29}function pn(t){return Math.round(255*(.00304>=t?12.92*t:1.055*Math.pow(t,1/2.4)-.055))}function mn(t){return Iu(t,Ma),t}function vn(t){return function(){return ga(t,this)}}function yn(t){return function(){return pa(t,this)}}function Mn(t,n){function e(){this.removeAttribute(t)}function r(){this.removeAttributeNS(t.space,t.local)}function i(){this.setAttribute(t,n)}function u(){this.setAttributeNS(t.space,t.local,n)}function a(){var e=n.apply(this,arguments);null==e?this.removeAttribute(t):this.setAttribute(t,e)}function o(){var e=n.apply(this,arguments);null==e?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,e)}return t=d3.ns.qualify(t),null==n?t.local?r:e:\"function\"==typeof n?t.local?o:a:t.local?u:i}function bn(t){return RegExp(\"(?:^|\\\\s+)\"+d3.requote(t)+\"(?:\\\\s+|$)\",\"g\")}function xn(t,n){function e(){for(var e=-1;i>++e;)t[e](this,n)}function r(){for(var e=-1,r=n.apply(this,arguments);i>++e;)t[e](this,r)}t=t.trim().split(/\\s+/).map(_n);var i=t.length;return\"function\"==typeof n?r:e}function _n(t){var n=bn(t);return function(e,r){if(i=e.classList)return r?i.add(t):i.remove(t);var i=e.className,u=null!=i.baseVal,a=u?i.baseVal:i;r?(n.lastIndex=0,n.test(a)||(a=h(a+\" \"+t),u?i.baseVal=a:e.className=a)):a&&(a=h(a.replace(n,\" \")),u?i.baseVal=a:e.className=a)}}function wn(t,n,e){function r(){this.style.removeProperty(t)}function i(){this.style.setProperty(t,n,e)}function u(){var r=n.apply(this,arguments);null==r?this.style.removeProperty(t):this.style.setProperty(t,r,e)}return null==n?r:\"function\"==typeof n?u:i}function Sn(t,n){function e(){delete this[t]}function r(){this[t]=n}function i(){var e=n.apply(this,arguments);null==e?delete this[t]:this[t]=e}return null==n?e:\"function\"==typeof n?i:r}function kn(t){return{__data__:t}}function En(t){return function(){return ya(this,t)}}function An(t){return arguments.length||(t=d3.ascending),function(n,e){return t(n&&n.__data__,e&&e.__data__)}}function Nn(t,n,e){function r(){var n=this[u];n&&(this.removeEventListener(t,n,n.$),delete this[u])}function i(){function i(t){var e=d3.event;d3.event=t,o[0]=a.__data__;try{n.apply(a,o)}finally{d3.event=e}}var a=this,o=Yu(arguments);r.call(this),this.addEventListener(t,this[u]=i,i.$=e),i._=n}var u=\"__on\"+t,a=t.indexOf(\".\");return a>0&&(t=t.substring(0,a)),n?i:r}function Tn(t,n){for(var e=0,r=t.length;r>e;e++)for(var i,u=t[e],a=0,o=u.length;o>a;a++)(i=u[a])&&n(i,a,e);return t}function qn(t){return Iu(t,xa),t}function Cn(t,n){return Iu(t,wa),t.id=n,t}function zn(t,n,e,r){var i=t.__transition__||(t.__transition__={active:0,count:0}),a=i[e];if(!a){var o=r.time;return a=i[e]={tween:new u,event:d3.dispatch(\"start\",\"end\"),time:o,ease:r.ease,delay:r.delay,duration:r.duration},++i.count,d3.timer(function(r){function u(r){return i.active>e?l():(i.active=e,h.start.call(t,s,n),a.tween.forEach(function(e,r){(r=r.call(t,s,n))&&p.push(r)}),c(r)||d3.timer(c,0,o),1)}function c(r){if(i.active!==e)return l();for(var u=(r-d)/g,a=f(u),o=p.length;o>0;)p[--o].call(t,a);return u>=1?(l(),h.end.call(t,s,n),1):void 0}function l(){return--i.count?delete i[e]:delete t.__transition__,1}var s=t.__data__,f=a.ease,h=a.event,d=a.delay,g=a.duration,p=[];return r>=d?u(r):d3.timer(u,d,o),1},0,o),a}}function Dn(t){return null==t&&(t=\"\"),function(){this.textContent=t}}function Ln(t,n,e,r){var i=t.id;return Tn(t,\"function\"==typeof e?function(t,u,a){t.__transition__[i].tween.set(n,r(e.call(t,t.__data__,u,a)))}:(e=r(e),function(t){t.__transition__[i].tween.set(n,e)}))}function Fn(){for(var t,n=Date.now(),e=qa;e;)t=n-e.then,t>=e.delay&&(e.flush=e.callback(t)),e=e.next;var r=Hn()-n;r>24?(isFinite(r)&&(clearTimeout(Aa),Aa=setTimeout(Fn,r)),Ea=0):(Ea=1,Ca(Fn))}function Hn(){for(var t=null,n=qa,e=1/0;n;)n.flush?(delete Ta[n.callback.id],n=t?t.next=n.next:qa=n.next):(e=Math.min(e,n.then+n.delay),n=(t=n).next);return e}function Rn(t,n){var e=t.ownerSVGElement||t;if(e.createSVGPoint){var r=e.createSVGPoint();if(0>za&&(window.scrollX||window.scrollY)){e=d3.select(document.body).append(\"svg\").style(\"position\",\"absolute\").style(\"top\",0).style(\"left\",0);var i=e[0][0].getScreenCTM();za=!(i.f||i.e),e.remove()}return za?(r.x=n.pageX,r.y=n.pageY):(r.x=n.clientX,r.y=n.clientY),r=r.matrixTransform(t.getScreenCTM().inverse()),[r.x,r.y]}var u=t.getBoundingClientRect();return[n.clientX-u.left-t.clientLeft,n.clientY-u.top-t.clientTop]}function Pn(){}function jn(t){var n=t[0],e=t[t.length-1];return e>n?[n,e]:[e,n]}function On(t){return t.rangeExtent?t.rangeExtent():jn(t.range())}function Yn(t,n){var e,r=0,i=t.length-1,u=t[r],a=t[i];return u>a&&(e=r,r=i,i=e,e=u,u=a,a=e),(n=n(a-u))&&(t[r]=n.floor(u),t[i]=n.ceil(a)),t}function Un(){return Math}function In(t,n,e,r){function i(){var i=Math.min(t.length,n.length)>2?Gn:Jn,c=r?Z:X;return a=i(t,n,c,e),o=i(n,t,c,d3.interpolate),u}function u(t){return a(t)}var a,o;return u.invert=function(t){return o(t)},u.domain=function(n){return arguments.length?(t=n.map(Number),i()):t},u.range=function(t){return arguments.length?(n=t,i()):n},u.rangeRound=function(t){return u.range(t).interpolate(d3.interpolateRound)},u.clamp=function(t){return arguments.length?(r=t,i()):r},u.interpolate=function(t){return arguments.length?(e=t,i()):e},u.ticks=function(n){return Bn(t,n)},u.tickFormat=function(n){return $n(t,n)},u.nice=function(){return Yn(t,Xn),i()},u.copy=function(){return In(t,n,e,r)},i()}function Vn(t,n){return d3.rebind(t,n,\"range\",\"rangeRound\",\"interpolate\",\"clamp\")}function Xn(t){return t=Math.pow(10,Math.round(Math.log(t)/Math.LN10)-1),t&&{floor:function(n){return Math.floor(n/t)*t},ceil:function(n){return Math.ceil(n/t)*t}}}function Zn(t,n){var e=jn(t),r=e[1]-e[0],i=Math.pow(10,Math.floor(Math.log(r/n)/Math.LN10)),u=n/r*i;return.15>=u?i*=10:.35>=u?i*=5:.75>=u&&(i*=2),e[0]=Math.ceil(e[0]/i)*i,e[1]=Math.floor(e[1]/i)*i+.5*i,e[2]=i,e}function Bn(t,n){return d3.range.apply(d3,Zn(t,n))}function $n(t,n){return d3.format(\",.\"+Math.max(0,-Math.floor(Math.log(Zn(t,n)[2])/Math.LN10+.01))+\"f\")}function Jn(t,n,e,r){var i=e(t[0],t[1]),u=r(n[0],n[1]);return function(t){return u(i(t))}}function Gn(t,n,e,r){var i=[],u=[],a=0,o=Math.min(t.length,n.length)-1;for(t[o]<t[0]&&(t=t.slice().reverse(),n=n.slice().reverse());o>=++a;)i.push(e(t[a-1],t[a])),u.push(r(n[a-1],n[a]));return function(n){var e=d3.bisect(t,n,1,o)-1;return u[e](i[e](n))}}function Kn(t,n){function e(e){return t(n(e))}var r=n.pow;return e.invert=function(n){return r(t.invert(n))},e.domain=function(i){return arguments.length?(n=0>i[0]?Qn:Wn,r=n.pow,t.domain(i.map(n)),e):t.domain().map(r)},e.nice=function(){return t.domain(Yn(t.domain(),Un)),e},e.ticks=function(){var e=jn(t.domain()),i=[];if(e.every(isFinite)){var u=Math.floor(e[0]),a=Math.ceil(e[1]),o=r(e[0]),c=r(e[1]);if(n===Qn)for(i.push(r(u));a>u++;)for(var l=9;l>0;l--)i.push(r(u)*l);else{for(;a>u;u++)for(var l=1;10>l;l++)i.push(r(u)*l);i.push(r(u))}for(u=0;o>i[u];u++);for(a=i.length;i[a-1]>c;a--);i=i.slice(u,a)}return i},e.tickFormat=function(t,i){if(2>arguments.length&&(i=Da),!arguments.length)return i;var u,a=Math.max(.1,t/e.ticks().length),o=n===Qn?(u=-1e-12,Math.floor):(u=1e-12,Math.ceil);return function(t){return a>=t/r(o(n(t)+u))?i(t):\"\"}},e.copy=function(){return Kn(t.copy(),n)},Vn(e,t)}function Wn(t){return Math.log(0>t?0:t)/Math.LN10}function Qn(t){return-Math.log(t>0?0:-t)/Math.LN10}function te(t,n){function e(n){return t(r(n))}var r=ne(n),i=ne(1/n);return e.invert=function(n){return i(t.invert(n))},e.domain=function(n){return arguments.length?(t.domain(n.map(r)),e):t.domain().map(i)},e.ticks=function(t){return Bn(e.domain(),t)},e.tickFormat=function(t){return $n(e.domain(),t)},e.nice=function(){return e.domain(Yn(e.domain(),Xn))},e.exponent=function(t){if(!arguments.length)return n;var u=e.domain();return r=ne(n=t),i=ne(1/n),e.domain(u)},e.copy=function(){return te(t.copy(),n)},Vn(e,t)}function ne(t){return function(n){return 0>n?-Math.pow(-n,t):Math.pow(n,t)}}function ee(t,n){function e(n){return a[((i.get(n)||i.set(n,t.push(n)))-1)%a.length]}function r(n,e){return d3.range(t.length).map(function(t){return n+e*t})}var i,a,o;return e.domain=function(r){if(!arguments.length)return t;t=[],i=new u;for(var a,o=-1,c=r.length;c>++o;)i.has(a=r[o])||i.set(a,t.push(a));return e[n.t].apply(e,n.a)},e.range=function(t){return arguments.length?(a=t,o=0,n={t:\"range\",a:arguments},e):a},e.rangePoints=function(i,u){2>arguments.length&&(u=0);var c=i[0],l=i[1],s=(l-c)/(Math.max(1,t.length-1)+u);return a=r(2>t.length?(c+l)/2:c+s*u/2,s),o=0,n={t:\"rangePoints\",a:arguments},e},e.rangeBands=function(i,u,c){2>arguments.length&&(u=0),3>arguments.length&&(c=u);var l=i[1]<i[0],s=i[l-0],f=i[1-l],h=(f-s)/(t.length-u+2*c);return a=r(s+h*c,h),l&&a.reverse(),o=h*(1-u),n={t:\"rangeBands\",a:arguments},e},e.rangeRoundBands=function(i,u,c){2>arguments.length&&(u=0),3>arguments.length&&(c=u);var l=i[1]<i[0],s=i[l-0],f=i[1-l],h=Math.floor((f-s)/(t.length-u+2*c)),d=f-s-(t.length-u)*h;return a=r(s+Math.round(d/2),h),l&&a.reverse(),o=Math.round(h*(1-u)),n={t:\"rangeRoundBands\",a:arguments},e},e.rangeBand=function(){return o},e.rangeExtent=function(){return jn(n.a[0])},e.copy=function(){return ee(t,n)},e.domain(t)}function re(t,n){function e(){var e=0,u=n.length;for(i=[];u>++e;)i[e-1]=d3.quantile(t,e/u);return r}function r(t){return isNaN(t=+t)?0/0:n[d3.bisect(i,t)]}var i;return r.domain=function(n){return arguments.length?(t=n.filter(function(t){return!isNaN(t)}).sort(d3.ascending),e()):t},r.range=function(t){return arguments.length?(n=t,e()):n},r.quantiles=function(){return i},r.copy=function(){return re(t,n)},e()}function ie(t,n,e){function r(n){return e[Math.max(0,Math.min(a,Math.floor(u*(n-t))))]}function i(){return u=e.length/(n-t),a=e.length-1,r}var u,a;return r.domain=function(e){return arguments.length?(t=+e[0],n=+e[e.length-1],i()):[t,n]},r.range=function(t){return arguments.length?(e=t,i()):e},r.copy=function(){return ie(t,n,e)},i()}function ue(t,n){function e(e){return n[d3.bisect(t,e)]}return e.domain=function(n){return arguments.length?(t=n,e):t},e.range=function(t){return arguments.length?(n=t,e):n},e.copy=function(){return ue(t,n)},e}function ae(t){function n(t){return+t}return n.invert=n,n.domain=n.range=function(e){return arguments.length?(t=e.map(n),n):t},n.ticks=function(n){return Bn(t,n)},n.tickFormat=function(n){return $n(t,n)},n.copy=function(){return ae(t)},n}function oe(t){return t.innerRadius}function ce(t){return t.outerRadius}function le(t){return t.startAngle}function se(t){return t.endAngle}function fe(t){function n(n){function a(){s.push(\"M\",u(t(f),l))}for(var o,s=[],f=[],h=-1,d=n.length,g=c(e),p=c(r);d>++h;)i.call(this,o=n[h],h)?f.push([+g.call(this,o,h),+p.call(this,o,h)]):f.length&&(a(),f=[]);return f.length&&a(),s.length?s.join(\"\"):null}var e=he,r=de,i=o,u=ge,a=u.key,l=.7;return n.x=function(t){return arguments.length?(e=t,n):e},n.y=function(t){return arguments.length?(r=t,n):r},n.defined=function(t){return arguments.length?(i=t,n):i},n.interpolate=function(t){return arguments.length?(a=\"function\"==typeof t?u=t:(u=Oa.get(t)||ge).key,n):a},n.tension=function(t){return arguments.length?(l=t,n):l},n}function he(t){return t[0]}function de(t){return t[1]}function ge(t){return t.join(\"L\")}function pe(t){return ge(t)+\"Z\"}function me(t){for(var n=0,e=t.length,r=t[0],i=[r[0],\",\",r[1]];e>++n;)i.push(\"V\",(r=t[n])[1],\"H\",r[0]);return i.join(\"\")}function ve(t){for(var n=0,e=t.length,r=t[0],i=[r[0],\",\",r[1]];e>++n;)i.push(\"H\",(r=t[n])[0],\"V\",r[1]);return i.join(\"\")}function ye(t,n){return 4>t.length?ge(t):t[1]+xe(t.slice(1,t.length-1),_e(t,n))}function Me(t,n){return 3>t.length?ge(t):t[0]+xe((t.push(t[0]),t),_e([t[t.length-2]].concat(t,[t[1]]),n))}function be(t,n){return 3>t.length?ge(t):t[0]+xe(t,_e(t,n))}function xe(t,n){if(1>n.length||t.length!=n.length&&t.length!=n.length+2)return ge(t);var e=t.length!=n.length,r=\"\",i=t[0],u=t[1],a=n[0],o=a,c=1;if(e&&(r+=\"Q\"+(u[0]-2*a[0]/3)+\",\"+(u[1]-2*a[1]/3)+\",\"+u[0]+\",\"+u[1],i=t[1],c=2),n.length>1){o=n[1],u=t[c],c++,r+=\"C\"+(i[0]+a[0])+\",\"+(i[1]+a[1])+\",\"+(u[0]-o[0])+\",\"+(u[1]-o[1])+\",\"+u[0]+\",\"+u[1];for(var l=2;n.length>l;l++,c++)u=t[c],o=n[l],r+=\"S\"+(u[0]-o[0])+\",\"+(u[1]-o[1])+\",\"+u[0]+\",\"+u[1]}if(e){var s=t[c];r+=\"Q\"+(u[0]+2*o[0]/3)+\",\"+(u[1]+2*o[1]/3)+\",\"+s[0]+\",\"+s[1]}return r}function _e(t,n){for(var e,r=[],i=(1-n)/2,u=t[0],a=t[1],o=1,c=t.length;c>++o;)e=u,u=a,a=t[o],r.push([i*(a[0]-e[0]),i*(a[1]-e[1])]);return r}function we(t){if(3>t.length)return ge(t);var n=1,e=t.length,r=t[0],i=r[0],u=r[1],a=[i,i,i,(r=t[1])[0]],o=[u,u,u,r[1]],c=[i,\",\",u];for(Ne(c,a,o);e>++n;)r=t[n],a.shift(),a.push(r[0]),o.shift(),o.push(r[1]),Ne(c,a,o);for(n=-1;2>++n;)a.shift(),a.push(r[0]),o.shift(),o.push(r[1]),Ne(c,a,o);return c.join(\"\")}function Se(t){if(4>t.length)return ge(t);for(var n,e=[],r=-1,i=t.length,u=[0],a=[0];3>++r;)n=t[r],u.push(n[0]),a.push(n[1]);for(e.push(Ae(Ia,u)+\",\"+Ae(Ia,a)),--r;i>++r;)n=t[r],u.shift(),u.push(n[0]),a.shift(),a.push(n[1]),Ne(e,u,a);return e.join(\"\")}function ke(t){for(var n,e,r=-1,i=t.length,u=i+4,a=[],o=[];4>++r;)e=t[r%i],a.push(e[0]),o.push(e[1]);for(n=[Ae(Ia,a),\",\",Ae(Ia,o)],--r;u>++r;)e=t[r%i],a.shift(),a.push(e[0]),o.shift(),o.push(e[1]),Ne(n,a,o);return n.join(\"\")}function Ee(t,n){var e=t.length-1;if(e)for(var r,i,u=t[0][0],a=t[0][1],o=t[e][0]-u,c=t[e][1]-a,l=-1;e>=++l;)r=t[l],i=l/e,r[0]=n*r[0]+(1-n)*(u+i*o),r[1]=n*r[1]+(1-n)*(a+i*c);return we(t)}function Ae(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]}function Ne(t,n,e){t.push(\"C\",Ae(Ya,n),\",\",Ae(Ya,e),\",\",Ae(Ua,n),\",\",Ae(Ua,e),\",\",Ae(Ia,n),\",\",Ae(Ia,e))}function Te(t,n){return(n[1]-t[1])/(n[0]-t[0])}function qe(t){for(var n=0,e=t.length-1,r=[],i=t[0],u=t[1],a=r[0]=Te(i,u);e>++n;)r[n]=(a+(a=Te(i=u,u=t[n+1])))/2;return r[n]=a,r}function Ce(t){for(var n,e,r,i,u=[],a=qe(t),o=-1,c=t.length-1;c>++o;)n=Te(t[o],t[o+1]),1e-6>Math.abs(n)?a[o]=a[o+1]=0:(e=a[o]/n,r=a[o+1]/n,i=e*e+r*r,i>9&&(i=3*n/Math.sqrt(i),a[o]=i*e,a[o+1]=i*r));for(o=-1;c>=++o;)i=(t[Math.min(c,o+1)][0]-t[Math.max(0,o-1)][0])/(6*(1+a[o]*a[o])),u.push([i||0,a[o]*i||0]);return u}function ze(t){return 3>t.length?ge(t):t[0]+xe(t,Ce(t))}function De(t){for(var n,e,r,i=-1,u=t.length;u>++i;)n=t[i],e=n[0],r=n[1]+Pa,n[0]=e*Math.cos(r),n[1]=e*Math.sin(r);return t}function Le(t){function n(n){function o(){m.push(\"M\",l(t(y),d),h,f(t(v.reverse()),d),\"Z\")}for(var s,g,p,m=[],v=[],y=[],M=-1,b=n.length,x=c(e),_=c(i),w=e===r?function(){return g}:c(r),S=i===u?function(){return p}:c(u);b>++M;)a.call(this,s=n[M],M)?(v.push([g=+x.call(this,s,M),p=+_.call(this,s,M)]),y.push([+w.call(this,s,M),+S.call(this,s,M)])):v.length&&(o(),v=[],y=[]);return v.length&&o(),m.length?m.join(\"\"):null}var e=he,r=he,i=0,u=de,a=o,l=ge,s=l.key,f=l,h=\"L\",d=.7;return n.x=function(t){return arguments.length?(e=r=t,n):r},n.x0=function(t){return arguments.length?(e=t,n):e},n.x1=function(t){return arguments.length?(r=t,n):r},n.y=function(t){return arguments.length?(i=u=t,n):u},n.y0=function(t){return arguments.length?(i=t,n):i},n.y1=function(t){return arguments.length?(u=t,n):u},n.defined=function(t){return arguments.length?(a=t,n):a},n.interpolate=function(t){return arguments.length?(s=\"function\"==typeof t?l=t:(l=Oa.get(t)||ge).key,f=l.reverse||l,h=l.closed?\"M\":\"L\",n):s},n.tension=function(t){return arguments.length?(d=t,n):d},n}function Fe(t){return t.radius}function He(t){return[t.x,t.y]}function Re(t){return function(){var n=t.apply(this,arguments),e=n[0],r=n[1]+Pa;return[e*Math.cos(r),e*Math.sin(r)]}}function Pe(){return 64}function je(){return\"circle\"}function Oe(t){var n=Math.sqrt(t/Ru);return\"M0,\"+n+\"A\"+n+\",\"+n+\" 0 1,1 0,\"+-n+\"A\"+n+\",\"+n+\" 0 1,1 0,\"+n+\"Z\"}function Ye(t,n){t.attr(\"transform\",function(t){return\"translate(\"+n(t)+\",0)\"})}function Ue(t,n){t.attr(\"transform\",function(t){return\"translate(0,\"+n(t)+\")\"})}function Ie(t,n,e){if(r=[],e&&n.length>1){for(var r,i,u,a=jn(t.domain()),o=-1,c=n.length,l=(n[1]-n[0])/++e;c>++o;)for(i=e;--i>0;)(u=+n[o]-i*l)>=a[0]&&r.push(u);for(--o,i=0;e>++i&&(u=+n[o]+i*l)<a[1];)r.push(u)}return r}function Ve(){Ja||(Ja=d3.select(\"body\").append(\"div\").style(\"visibility\",\"hidden\").style(\"top\",0).style(\"height\",0).style(\"width\",0).style(\"overflow-y\",\"scroll\").append(\"div\").style(\"height\",\"2000px\").node().parentNode);var t,n=d3.event;try{Ja.scrollTop=1e3,Ja.dispatchEvent(n),t=1e3-Ja.scrollTop}catch(e){t=n.wheelDelta||5*-n.detail}return t}function Xe(t){for(var n=t.source,e=t.target,r=Be(n,e),i=[n];n!==r;)n=n.parent,i.push(n);for(var u=i.length;e!==r;)i.splice(u,0,e),e=e.parent;return i}function Ze(t){for(var n=[],e=t.parent;null!=e;)n.push(t),t=e,e=e.parent;return n.push(t),n}function Be(t,n){if(t===n)return t;for(var e=Ze(t),r=Ze(n),i=e.pop(),u=r.pop(),a=null;i===u;)a=i,i=e.pop(),u=r.pop();return a}function $e(t){t.fixed|=2}function Je(t){t.fixed&=1}function Ge(t){t.fixed|=4,t.px=t.x,t.py=t.y}function Ke(t){t.fixed&=3}function We(t,n,e){var r=0,i=0;if(t.charge=0,!t.leaf)for(var u,a=t.nodes,o=a.length,c=-1;o>++c;)u=a[c],null!=u&&(We(u,n,e),t.charge+=u.charge,r+=u.charge*u.cx,i+=u.charge*u.cy);if(t.point){t.leaf||(t.point.x+=Math.random()-.5,t.point.y+=Math.random()-.5);var l=n*e[t.point.index];t.charge+=t.pointCharge=l,r+=l*t.point.x,i+=l*t.point.y}t.cx=r/t.charge,t.cy=i/t.charge}function Qe(){return 20}function tr(){return 1}function nr(t){return t.x}function er(t){return t.y}function rr(t,n,e){t.y0=n,t.y=e}function ir(t){return d3.range(t.length)}function ur(t){for(var n=-1,e=t[0].length,r=[];e>++n;)r[n]=0;return r}function ar(t){for(var n,e=1,r=0,i=t[0][1],u=t.length;u>e;++e)(n=t[e][1])>i&&(r=e,i=n);return r}function or(t){return t.reduce(cr,0)}function cr(t,n){return t+n[1]}function lr(t,n){return sr(t,Math.ceil(Math.log(n.length)/Math.LN2+1))}function sr(t,n){for(var e=-1,r=+t[0],i=(t[1]-r)/n,u=[];n>=++e;)u[e]=i*e+r;return u}function fr(t){return[d3.min(t),d3.max(t)]}function hr(t,n){return d3.rebind(t,n,\"sort\",\"children\",\"value\"),t.nodes=t,t.links=mr,t}function dr(t){return t.children}function gr(t){return t.value}function pr(t,n){return n.value-t.value}function mr(t){return d3.merge(t.map(function(t){return(t.children||[]).map(function(n){return{source:t,target:n}})}))}function vr(t,n){return t.value-n.value}function yr(t,n){var e=t._pack_next;t._pack_next=n,n._pack_prev=t,n._pack_next=e,e._pack_prev=n}function Mr(t,n){t._pack_next=n,n._pack_prev=t}function br(t,n){var e=n.x-t.x,r=n.y-t.y,i=t.r+n.r;return i*i-e*e-r*r>.001}function xr(t){function n(t){s=Math.min(t.x-t.r,s),f=Math.max(t.x+t.r,f),h=Math.min(t.y-t.r,h),d=Math.max(t.y+t.r,d)}if((e=t.children)&&(l=e.length)){var e,r,i,u,a,o,c,l,s=1/0,f=-1/0,h=1/0,d=-1/0;if(e.forEach(_r),r=e[0],r.x=-r.r,r.y=0,n(r),l>1&&(i=e[1],i.x=i.r,i.y=0,n(i),l>2))for(u=e[2],kr(r,i,u),n(u),yr(r,u),r._pack_prev=u,yr(u,i),i=r._pack_next,a=3;l>a;a++){kr(r,i,u=e[a]);var g=0,p=1,m=1;for(o=i._pack_next;o!==i;o=o._pack_next,p++)if(br(o,u)){g=1;break}if(1==g)for(c=r._pack_prev;c!==o._pack_prev&&!br(c,u);c=c._pack_prev,m++);g?(m>p||p==m&&i.r<r.r?Mr(r,i=o):Mr(r=c,i),a--):(yr(r,u),i=u,n(u))}var v=(s+f)/2,y=(h+d)/2,M=0;for(a=0;l>a;a++)u=e[a],u.x-=v,u.y-=y,M=Math.max(M,u.r+Math.sqrt(u.x*u.x+u.y*u.y));t.r=M,e.forEach(wr)}}function _r(t){t._pack_next=t._pack_prev=t}function wr(t){delete t._pack_next,delete t._pack_prev}function Sr(t,n,e,r){var i=t.children;if(t.x=n+=r*t.x,t.y=e+=r*t.y,t.r*=r,i)for(var u=-1,a=i.length;a>++u;)Sr(i[u],n,e,r)}function kr(t,n,e){var r=t.r+e.r,i=n.x-t.x,u=n.y-t.y;if(r&&(i||u)){var a=n.r+e.r,o=i*i+u*u;a*=a,r*=r;var c=.5+(r-a)/(2*o),l=Math.sqrt(Math.max(0,2*a*(r+o)-(r-=o)*r-a*a))/(2*o);e.x=t.x+c*i+l*u,e.y=t.y+c*u-l*i}else e.x=t.x+r,e.y=t.y}function Er(t){return 1+d3.max(t,function(t){return t.y})}function Ar(t){return t.reduce(function(t,n){return t+n.x},0)/t.length}function Nr(t){var n=t.children;return n&&n.length?Nr(n[0]):t}function Tr(t){var n,e=t.children;return e&&(n=e.length)?Tr(e[n-1]):t}function qr(t,n){return t.parent==n.parent?1:2}function Cr(t){var n=t.children;return n&&n.length?n[0]:t._tree.thread}function zr(t){var n,e=t.children;return e&&(n=e.length)?e[n-1]:t._tree.thread}function Dr(t,n){var e=t.children;if(e&&(i=e.length))for(var r,i,u=-1;i>++u;)n(r=Dr(e[u],n),t)>0&&(t=r);return t}function Lr(t,n){return t.x-n.x}function Fr(t,n){return n.x-t.x}function Hr(t,n){return t.depth-n.depth}function Rr(t,n){function e(t,r){var i=t.children;if(i&&(a=i.length))for(var u,a,o=null,c=-1;a>++c;)u=i[c],e(u,o),o=u;n(t,r)}e(t,null)}function Pr(t){for(var n,e=0,r=0,i=t.children,u=i.length;--u>=0;)n=i[u]._tree,n.prelim+=e,n.mod+=e,e+=n.shift+(r+=n.change)}function jr(t,n,e){t=t._tree,n=n._tree;var r=e/(n.number-t.number);t.change+=r,n.change-=r,n.shift+=e,n.prelim+=e,n.mod+=e}function Or(t,n,e){return t._tree.ancestor.parent==n.parent?t._tree.ancestor:e}function Yr(t){return{x:t.x,y:t.y,dx:t.dx,dy:t.dy}}function Ur(t,n){var e=t.x+n[3],r=t.y+n[0],i=t.dx-n[1]-n[3],u=t.dy-n[0]-n[2];return 0>i&&(e+=i/2,i=0),0>u&&(r+=u/2,u=0),{x:e,y:r,dx:i,dy:u}}function Ir(t,n){function e(t,e){return d3.xhr(t,n,e).response(r)}function r(t){return e.parse(t.responseText)}function i(n){return n.map(u).join(t)}function u(t){return a.test(t)?'\"'+t.replace(/\\\"/g,'\"\"')+'\"':t}var a=RegExp('[\"'+t+\"\\n]\"),o=t.charCodeAt(0);return e.parse=function(t){var n;return e.parseRows(t,function(t){return n?n(t):(n=Function(\"d\",\"return {\"+t.map(function(t,n){return JSON.stringify(t)+\": d[\"+n+\"]\"}).join(\",\")+\"}\"),void 0)})},e.parseRows=function(t,n){function e(){if(s>=l)return a;if(i)return i=!1,u;var n=s;if(34===t.charCodeAt(n)){for(var e=n;l>e++;)if(34===t.charCodeAt(e)){if(34!==t.charCodeAt(e+1))break;++e}s=e+2;var r=t.charCodeAt(e+1);return 13===r?(i=!0,10===t.charCodeAt(e+2)&&++s):10===r&&(i=!0),t.substring(n+1,e).replace(/\"\"/g,'\"')}for(;l>s;){var r=t.charCodeAt(s++),c=1;if(10===r)i=!0;else if(13===r)i=!0,10===t.charCodeAt(s)&&(++s,++c);else if(r!==o)continue;return t.substring(n,s-c)}return t.substring(n)}for(var r,i,u={},a={},c=[],l=t.length,s=0,f=0;(r=e())!==a;){for(var h=[];r!==u&&r!==a;)h.push(r),r=e();(!n||(h=n(h,f++)))&&c.push(h)}return c},e.format=function(t){return t.map(i).join(\"\\n\")},e}function Vr(t,n){no.hasOwnProperty(t.type)&&no[t.type](t,n)}function Xr(t,n,e){var r,i=-1,u=t.length-e;for(n.lineStart();u>++i;)r=t[i],n.point(r[0],r[1]);n.lineEnd()}function Zr(t,n){var e=-1,r=t.length;for(n.polygonStart();r>++e;)Xr(t[e],n,1);n.polygonEnd()}function Br(t){return[Math.atan2(t[1],t[0]),Math.asin(Math.max(-1,Math.min(1,t[2])))]}function $r(t,n){return Pu>Math.abs(t[0]-n[0])&&Pu>Math.abs(t[1]-n[1])}function Jr(t){var n=t[0],e=t[1],r=Math.cos(e);return[r*Math.cos(n),r*Math.sin(n),Math.sin(e)]}function Gr(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function Kr(t,n){return[t[1]*n[2]-t[2]*n[1],t[2]*n[0]-t[0]*n[2],t[0]*n[1]-t[1]*n[0]]}function Wr(t,n){t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]}function Qr(t,n){return[t[0]*n,t[1]*n,t[2]*n]}function ti(t){var n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=n,t[1]/=n,t[2]/=n}function ni(t){function n(n){function r(e,r){e=t(e,r),n.point(e[0],e[1])}function u(){s=0/0,p.point=a,n.lineStart()}function a(r,u){var a=Jr([r,u]),o=t(r,u);e(s,f,l,h,d,g,s=o[0],f=o[1],l=r,h=a[0],d=a[1],g=a[2],i,n),n.point(s,f)}function o(){p.point=r,n.lineEnd()}function c(){var t,r,c,m,v,y,M;u(),p.point=function(n,e){a(t=n,r=e),c=s,m=f,v=h,y=d,M=g,p.point=a},p.lineEnd=function(){e(s,f,l,h,d,g,c,m,t,v,y,M,i,n),p.lineEnd=o,o()}}var l,s,f,h,d,g,p={point:r,lineStart:u,lineEnd:o,polygonStart:function(){n.polygonStart(),p.lineStart=c},polygonEnd:function(){n.polygonEnd(),p.lineStart=u}};return p}function e(n,i,u,a,o,c,l,s,f,h,d,g,p,m){var v=l-n,y=s-i,M=v*v+y*y;if(M>4*r&&p--){var b=a+h,x=o+d,_=c+g,w=Math.sqrt(b*b+x*x+_*_),S=Math.asin(_/=w),k=Pu>Math.abs(Math.abs(_)-1)?(u+f)/2:Math.atan2(x,b),E=t(k,S),A=E[0],N=E[1],T=A-n,q=N-i,C=y*T-v*q;(C*C/M>r||Math.abs((v*T+y*q)/M-.5)>.3)&&(e(n,i,u,a,o,c,A,N,k,b/=w,x/=w,_,p,m),m.point(A,N),e(A,N,k,b,x,_,l,s,f,h,d,g,p,m))}}var r=.5,i=16;return n.precision=function(t){return arguments.length?(i=(r=t*t)>0&&16,n):Math.sqrt(r)},n}function ei(t,n){function e(t,n){var e=Math.sqrt(u-2*i*Math.sin(n))/i;return[e*Math.sin(t*=i),a-e*Math.cos(t)]}var r=Math.sin(t),i=(r+Math.sin(n))/2,u=1+r*(2*i-r),a=Math.sqrt(u)/i;return e.invert=function(t,n){var e=a-n;return[Math.atan2(t,e)/i,Math.asin((u-(t*t+e*e)*i*i)/(2*i))]},e}function ri(t){function n(t,n){r>t&&(r=t),t>u&&(u=t),i>n&&(i=n),n>a&&(a=n)}function e(){o.point=o.lineEnd=Pn}var r,i,u,a,o={point:n,lineStart:Pn,lineEnd:Pn,polygonStart:function(){o.lineEnd=e},polygonEnd:function(){o.point=n}};return function(n){return a=u=-(r=i=1/0),d3.geo.stream(n,t(o)),[[r,i],[u,a]]}}function ii(t,n){if(!io){++uo,t*=ju;var e=Math.cos(n*=ju);ao+=(e*Math.cos(t)-ao)/uo,oo+=(e*Math.sin(t)-oo)/uo,co+=(Math.sin(n)-co)/uo}}function ui(){var t,n;io=1,ai(),io=2;var e=lo.point;lo.point=function(r,i){e(t=r,n=i)},lo.lineEnd=function(){lo.point(t,n),oi(),lo.lineEnd=oi}}function ai(){function t(t,i){t*=ju;var u=Math.cos(i*=ju),a=u*Math.cos(t),o=u*Math.sin(t),c=Math.sin(i),l=Math.atan2(Math.sqrt((l=e*c-r*o)*l+(l=r*a-n*c)*l+(l=n*o-e*a)*l),n*a+e*o+r*c);uo+=l,ao+=l*(n+(n=a)),oo+=l*(e+(e=o)),co+=l*(r+(r=c))}var n,e,r;io>1||(1>io&&(io=1,uo=ao=oo=co=0),lo.point=function(i,u){i*=ju;var a=Math.cos(u*=ju);n=a*Math.cos(i),e=a*Math.sin(i),r=Math.sin(u),lo.point=t})}function oi(){lo.point=ii}function ci(t,n){var e=Math.cos(t),r=Math.sin(t);return function(i,u,a,o){null!=i?(i=li(e,i),u=li(e,u),(a>0?u>i:i>u)&&(i+=2*a*Ru)):(i=t+2*a*Ru,u=t);for(var c,l=a*n,s=i;a>0?s>u:u>s;s-=l)o.point((c=Br([e,-r*Math.cos(s),-r*Math.sin(s)]))[0],c[1])}}function li(t,n){var e=Jr(n);e[0]-=t,ti(e);var r=Math.acos(Math.max(-1,Math.min(1,-e[1])));return((0>-e[2]?-r:r)+2*Math.PI-Pu)%(2*Math.PI)}function si(t,n,e){return function(r){function i(n,e){t(n,e)&&r.point(n,e)}function u(t,n){m.point(t,n)}function a(){v.point=u,m.lineStart()}function o(){v.point=i,m.lineEnd()}function c(t,n){M.point(t,n),p.push([t,n])}function l(){M.lineStart(),p=[]}function s(){c(p[0][0],p[0][1]),M.lineEnd();var t,n=M.clean(),e=y.buffer(),i=e.length;if(!i)return g=!0,d+=mi(p,-1),p=null,void 0;if(p=null,1&n){t=e[0],h+=mi(t,1);var u,i=t.length-1,a=-1;for(r.lineStart();i>++a;)r.point((u=t[a])[0],u[1]);return r.lineEnd(),void 0}i>1&&2&n&&e.push(e.pop().concat(e.shift())),f.push(e.filter(gi))}var f,h,d,g,p,m=n(r),v={point:i,lineStart:a,lineEnd:o,polygonStart:function(){v.point=c,v.lineStart=l,v.lineEnd=s,g=!1,d=h=0,f=[],r.polygonStart()", "},polygonEnd:function(){v.point=i,v.lineStart=a,v.lineEnd=o,f=d3.merge(f),f.length?fi(f,e,r):(-Pu>h||g&&-Pu>d)&&(r.lineStart(),e(null,null,1,r),r.lineEnd()),r.polygonEnd(),f=null},sphere:function(){r.polygonStart(),r.lineStart(),e(null,null,1,r),r.lineEnd(),r.polygonEnd()}},y=pi(),M=n(y);return v}}function fi(t,n,e){var r=[],i=[];if(t.forEach(function(t){var n=t.length;if(!(1>=n)){var e=t[0],u=t[n-1],a={point:e,points:t,other:null,visited:!1,entry:!0,subject:!0},o={point:e,points:[e],other:a,visited:!1,entry:!1,subject:!1};a.other=o,r.push(a),i.push(o),a={point:u,points:[u],other:null,visited:!1,entry:!1,subject:!0},o={point:u,points:[u],other:a,visited:!1,entry:!0,subject:!1},a.other=o,r.push(a),i.push(o)}}),i.sort(di),hi(r),hi(i),r.length)for(var u,a,o,c=r[0];;){for(u=c;u.visited;)if((u=u.next)===c)return;a=u.points,e.lineStart();do{if(u.visited=u.other.visited=!0,u.entry){if(u.subject)for(var l=0;a.length>l;l++)e.point((o=a[l])[0],o[1]);else n(u.point,u.next.point,1,e);u=u.next}else{if(u.subject){a=u.prev.points;for(var l=a.length;--l>=0;)e.point((o=a[l])[0],o[1])}else n(u.point,u.prev.point,-1,e);u=u.prev}u=u.other,a=u.points}while(!u.visited);e.lineEnd()}}function hi(t){if(n=t.length){for(var n,e,r=0,i=t[0];n>++r;)i.next=e=t[r],e.prev=i,i=e;i.next=e=t[0],e.prev=i}}function di(t,n){return(0>(t=t.point)[0]?t[1]-Ru/2-Pu:Ru/2-t[1])-(0>(n=n.point)[0]?n[1]-Ru/2-Pu:Ru/2-n[1])}function gi(t){return t.length>1}function pi(){var t,n=[];return{lineStart:function(){n.push(t=[])},point:function(n,e){t.push([n,e])},lineEnd:Pn,buffer:function(){var e=n;return n=[],t=null,e}}}function mi(t,n){if(!(e=t.length))return 0;for(var e,r,i,u=0,a=0,o=t[0],c=o[0],l=o[1],s=Math.cos(l),f=Math.atan2(n*Math.sin(c)*s,Math.sin(l)),h=1-n*Math.cos(c)*s,d=f;e>++u;)o=t[u],s=Math.cos(l=o[1]),r=Math.atan2(n*Math.sin(c=o[0])*s,Math.sin(l)),i=1-n*Math.cos(c)*s,Pu>Math.abs(h-2)&&Pu>Math.abs(i-2)||(Pu>Math.abs(i)||Pu>Math.abs(h)||(Pu>Math.abs(Math.abs(r-f)-Ru)?i+h>2&&(a+=4*(r-f)):a+=Pu>Math.abs(h-2)?4*(r-d):((3*Ru+r-f)%(2*Ru)-Ru)*(h+i)),d=f,f=r,h=i);return a}function vi(t){var n,e=0/0,r=0/0,i=0/0;return{lineStart:function(){t.lineStart(),n=1},point:function(u,a){var o=u>0?Ru:-Ru,c=Math.abs(u-e);Pu>Math.abs(c-Ru)?(t.point(e,r=(r+a)/2>0?Ru/2:-Ru/2),t.point(i,r),t.lineEnd(),t.lineStart(),t.point(o,r),t.point(u,r),n=0):i!==o&&c>=Ru&&(Pu>Math.abs(e-i)&&(e-=i*Pu),Pu>Math.abs(u-o)&&(u-=o*Pu),r=yi(e,r,u,a),t.point(i,r),t.lineEnd(),t.lineStart(),t.point(o,r),n=0),t.point(e=u,r=a),i=o},lineEnd:function(){t.lineEnd(),e=r=0/0},clean:function(){return 2-n}}}function yi(t,n,e,r){var i,u,a=Math.sin(t-e);return Math.abs(a)>Pu?Math.atan((Math.sin(n)*(u=Math.cos(r))*Math.sin(e)-Math.sin(r)*(i=Math.cos(n))*Math.sin(t))/(i*u*a)):(n+r)/2}function Mi(t,n,e,r){var i;if(null==t)i=e*Ru/2,r.point(-Ru,i),r.point(0,i),r.point(Ru,i),r.point(Ru,0),r.point(Ru,-i),r.point(0,-i),r.point(-Ru,-i),r.point(-Ru,0),r.point(-Ru,i);else if(Math.abs(t[0]-n[0])>Pu){var u=(t[0]<n[0]?1:-1)*Ru;i=e*u/2,r.point(-u,i),r.point(0,i),r.point(u,i)}else r.point(n[0],n[1])}function bi(t){function n(t,n){return Math.cos(t)*Math.cos(n)>u}function e(t){var e,i,u,a;return{lineStart:function(){u=i=!1,a=1},point:function(o,c){var l,s=[o,c],f=n(o,c);!e&&(u=i=f)&&t.lineStart(),f!==i&&(l=r(e,s),($r(e,l)||$r(s,l))&&(s[0]+=Pu,s[1]+=Pu,f=n(s[0],s[1]))),f!==i&&(a=0,(i=f)?(t.lineStart(),l=r(s,e),t.point(l[0],l[1])):(l=r(e,s),t.point(l[0],l[1]),t.lineEnd()),e=l),!f||e&&$r(e,s)||t.point(s[0],s[1]),e=s},lineEnd:function(){i&&t.lineEnd(),e=null},clean:function(){return a|(u&&i)<<1}}}function r(t,n){var e=Jr(t,0),r=Jr(n,0),i=[1,0,0],a=Kr(e,r),o=Gr(a,a),c=a[0],l=o-c*c;if(!l)return t;var s=u*o/l,f=-u*c/l,h=Kr(i,a),d=Qr(i,s),g=Qr(a,f);Wr(d,g);var p=h,m=Gr(d,p),v=Gr(p,p),y=Math.sqrt(m*m-v*(Gr(d,d)-1)),M=Qr(p,(-m-y)/v);return Wr(M,d),Br(M)}var i=t*ju,u=Math.cos(i),a=ci(i,6*ju);return si(n,e,a)}function xi(t,n){function e(e,r){return e=t(e,r),n(e[0],e[1])}return t.invert&&n.invert&&(e.invert=function(e,r){return e=n.invert(e,r),e&&t.invert(e[0],e[1])}),e}function _i(t,n){return[t,n]}function wi(t,n,e){var r=d3.range(t,n-Pu,e).concat(n);return function(t){return r.map(function(n){return[t,n]})}}function Si(t,n,e){var r=d3.range(t,n-Pu,e).concat(n);return function(t){return r.map(function(n){return[n,t]})}}function ki(t,n,e,r){function i(t){var n=Math.sin(t*=d)*g,e=Math.sin(d-t)*g,r=e*l+n*f,i=e*s+n*h,u=e*a+n*c;return[Math.atan2(i,r)/ju,Math.atan2(u,Math.sqrt(r*r+i*i))/ju]}var u=Math.cos(n),a=Math.sin(n),o=Math.cos(r),c=Math.sin(r),l=u*Math.cos(t),s=u*Math.sin(t),f=o*Math.cos(e),h=o*Math.sin(e),d=Math.acos(Math.max(-1,Math.min(1,a*c+u*o*Math.cos(e-t)))),g=1/Math.sin(d);return i.distance=d,i}function Ei(t,n){return[t/(2*Ru),Math.max(-.5,Math.min(.5,Math.log(Math.tan(Ru/4+n/2))/(2*Ru)))]}function Ai(t){return\"m0,\"+t+\"a\"+t+\",\"+t+\" 0 1,1 0,\"+-2*t+\"a\"+t+\",\"+t+\" 0 1,1 0,\"+2*t+\"z\"}function Ni(t){var n=ni(function(n,e){return t([n*Ou,e*Ou])});return function(t){return t=n(t),{point:function(n,e){t.point(n*ju,e*ju)},sphere:function(){t.sphere()},lineStart:function(){t.lineStart()},lineEnd:function(){t.lineEnd()},polygonStart:function(){t.polygonStart()},polygonEnd:function(){t.polygonEnd()}}}}function Ti(){function t(t,n){a.push(\"M\",t,\",\",n,u)}function n(t,n){a.push(\"M\",t,\",\",n),o.point=e}function e(t,n){a.push(\"L\",t,\",\",n)}function r(){o.point=t}function i(){a.push(\"Z\")}var u=Ai(4.5),a=[],o={point:t,lineStart:function(){o.point=n},lineEnd:r,polygonStart:function(){o.lineEnd=i},polygonEnd:function(){o.lineEnd=r,o.point=t},pointRadius:function(t){return u=Ai(t),o},result:function(){if(a.length){var t=a.join(\"\");return a=[],t}}};return o}function qi(t){function n(n,e){t.moveTo(n,e),t.arc(n,e,a,0,2*Ru)}function e(n,e){t.moveTo(n,e),o.point=r}function r(n,e){t.lineTo(n,e)}function i(){o.point=n}function u(){t.closePath()}var a=4.5,o={point:n,lineStart:function(){o.point=e},lineEnd:i,polygonStart:function(){o.lineEnd=u},polygonEnd:function(){o.lineEnd=i,o.point=n},pointRadius:function(t){return a=t,o},result:Pn};return o}function Ci(){function t(t,n){po+=i*t-r*n,r=t,i=n}var n,e,r,i;mo.point=function(u,a){mo.point=t,n=r=u,e=i=a},mo.lineEnd=function(){t(n,e)}}function zi(t,n){io||(ao+=t,oo+=n,++co)}function Di(){function t(t,r){var i=t-n,u=r-e,a=Math.sqrt(i*i+u*u);ao+=a*(n+t)/2,oo+=a*(e+r)/2,co+=a,n=t,e=r}var n,e;if(1!==io){if(!(1>io))return;io=1,ao=oo=co=0}vo.point=function(r,i){vo.point=t,n=r,e=i}}function Li(){vo.point=zi}function Fi(){function t(t,n){var e=i*t-r*n;ao+=e*(r+t),oo+=e*(i+n),co+=3*e,r=t,i=n}var n,e,r,i;2>io&&(io=2,ao=oo=co=0),vo.point=function(u,a){vo.point=t,n=r=u,e=i=a},vo.lineEnd=function(){t(n,e)}}function Hi(){function t(t,n){if(t*=ju,n*=ju,!(Pu>Math.abs(Math.abs(u)-Ru/2)&&Pu>Math.abs(Math.abs(n)-Ru/2))){var e=Math.cos(n),c=Math.sin(n);if(Pu>Math.abs(u-Ru/2))Mo+=2*(t-r);else{var l=t-i,s=Math.cos(l),f=Math.atan2(Math.sqrt((f=e*Math.sin(l))*f+(f=a*c-o*e*s)*f),o*c+a*e*s),h=(f+Ru+u+n)/4;Mo+=(0>l&&l>-Ru||l>Ru?-4:4)*Math.atan(Math.sqrt(Math.abs(Math.tan(h)*Math.tan(h-f/2)*Math.tan(h-Ru/4-u/2)*Math.tan(h-Ru/4-n/2))))}r=i,i=t,u=n,a=e,o=c}}var n,e,r,i,u,a,o;bo.point=function(c,l){bo.point=t,r=i=(n=c)*ju,u=(e=l)*ju,a=Math.cos(u),o=Math.sin(u)},bo.lineEnd=function(){t(n,e)}}function Ri(t){return Pi(function(){return t})()}function Pi(t){function n(t){return t=a(t[0]*ju,t[1]*ju),[t[0]*s+o,c-t[1]*s]}function e(t){return t=a.invert((t[0]-o)/s,(c-t[1])/s),t&&[t[0]*Ou,t[1]*Ou]}function r(){a=xi(u=Oi(p,m,v),i);var t=i(d,g);return o=f-t[0]*s,c=h+t[1]*s,n}var i,u,a,o,c,l=ni(function(t,n){return t=i(t,n),[t[0]*s+o,c-t[1]*s]}),s=150,f=480,h=250,d=0,g=0,p=0,m=0,v=0,y=so,M=null;return n.stream=function(t){return ji(u,y(l(t)))},n.clipAngle=function(t){return arguments.length?(y=null==t?(M=t,so):bi(M=+t),n):M},n.scale=function(t){return arguments.length?(s=+t,r()):s},n.translate=function(t){return arguments.length?(f=+t[0],h=+t[1],r()):[f,h]},n.center=function(t){return arguments.length?(d=t[0]%360*ju,g=t[1]%360*ju,r()):[d*Ou,g*Ou]},n.rotate=function(t){return arguments.length?(p=t[0]%360*ju,m=t[1]%360*ju,v=t.length>2?t[2]%360*ju:0,r()):[p*Ou,m*Ou,v*Ou]},d3.rebind(n,l,\"precision\"),function(){return i=t.apply(this,arguments),n.invert=i.invert&&e,r()}}function ji(t,n){return{point:function(e,r){r=t(e*ju,r*ju),e=r[0],n.point(e>Ru?e-2*Ru:-Ru>e?e+2*Ru:e,r[1])},sphere:function(){n.sphere()},lineStart:function(){n.lineStart()},lineEnd:function(){n.lineEnd()},polygonStart:function(){n.polygonStart()},polygonEnd:function(){n.polygonEnd()}}}function Oi(t,n,e){return t?n||e?xi(Ui(t),Ii(n,e)):Ui(t):n||e?Ii(n,e):_i}function Yi(t){return function(n,e){return n+=t,[n>Ru?n-2*Ru:-Ru>n?n+2*Ru:n,e]}}function Ui(t){var n=Yi(t);return n.invert=Yi(-t),n}function Ii(t,n){function e(t,n){var e=Math.cos(n),o=Math.cos(t)*e,c=Math.sin(t)*e,l=Math.sin(n),s=l*r+o*i;return[Math.atan2(c*u-s*a,o*r-l*i),Math.asin(Math.max(-1,Math.min(1,s*u+c*a)))]}var r=Math.cos(t),i=Math.sin(t),u=Math.cos(n),a=Math.sin(n);return e.invert=function(t,n){var e=Math.cos(n),o=Math.cos(t)*e,c=Math.sin(t)*e,l=Math.sin(n),s=l*u-c*a;return[Math.atan2(c*u+l*a,o*r+s*i),Math.asin(Math.max(-1,Math.min(1,s*r-o*i)))]},e}function Vi(t,n){function e(n,e){var r=Math.cos(n),i=Math.cos(e),u=t(r*i);return[u*i*Math.sin(n),u*Math.sin(e)]}return e.invert=function(t,e){var r=Math.sqrt(t*t+e*e),i=n(r),u=Math.sin(i),a=Math.cos(i);return[Math.atan2(t*u,r*a),Math.asin(r&&e*u/r)]},e}function Xi(t,n,e,r){var i,u,a,o,c,l,s;return i=r[t],u=i[0],a=i[1],i=r[n],o=i[0],c=i[1],i=r[e],l=i[0],s=i[1],(s-a)*(o-u)-(c-a)*(l-u)>0}function Zi(t,n,e){return(e[0]-n[0])*(t[1]-n[1])<(e[1]-n[1])*(t[0]-n[0])}function Bi(t,n,e,r){var i=t[0],u=e[0],a=n[0]-i,o=r[0]-u,c=t[1],l=e[1],s=n[1]-c,f=r[1]-l,h=(o*(c-l)-f*(i-u))/(f*a-o*s);return[i+h*a,c+h*s]}function $i(t,n){var e={list:t.map(function(t,n){return{index:n,x:t[0],y:t[1]}}).sort(function(t,n){return t.y<n.y?-1:t.y>n.y?1:t.x<n.x?-1:t.x>n.x?1:0}),bottomSite:null},r={list:[],leftEnd:null,rightEnd:null,init:function(){r.leftEnd=r.createHalfEdge(null,\"l\"),r.rightEnd=r.createHalfEdge(null,\"l\"),r.leftEnd.r=r.rightEnd,r.rightEnd.l=r.leftEnd,r.list.unshift(r.leftEnd,r.rightEnd)},createHalfEdge:function(t,n){return{edge:t,side:n,vertex:null,l:null,r:null}},insert:function(t,n){n.l=t,n.r=t.r,t.r.l=n,t.r=n},leftBound:function(t){var n=r.leftEnd;do n=n.r;while(n!=r.rightEnd&&i.rightOf(n,t));return n=n.l},del:function(t){t.l.r=t.r,t.r.l=t.l,t.edge=null},right:function(t){return t.r},left:function(t){return t.l},leftRegion:function(t){return null==t.edge?e.bottomSite:t.edge.region[t.side]},rightRegion:function(t){return null==t.edge?e.bottomSite:t.edge.region[_o[t.side]]}},i={bisect:function(t,n){var e={region:{l:t,r:n},ep:{l:null,r:null}},r=n.x-t.x,i=n.y-t.y,u=r>0?r:-r,a=i>0?i:-i;return e.c=t.x*r+t.y*i+.5*(r*r+i*i),u>a?(e.a=1,e.b=i/r,e.c/=r):(e.b=1,e.a=r/i,e.c/=i),e},intersect:function(t,n){var e=t.edge,r=n.edge;if(!e||!r||e.region.r==r.region.r)return null;var i=e.a*r.b-e.b*r.a;if(1e-10>Math.abs(i))return null;var u,a,o=(e.c*r.b-r.c*e.b)/i,c=(r.c*e.a-e.c*r.a)/i,l=e.region.r,s=r.region.r;l.y<s.y||l.y==s.y&&l.x<s.x?(u=t,a=e):(u=n,a=r);var f=o>=a.region.r.x;return f&&\"l\"===u.side||!f&&\"r\"===u.side?null:{x:o,y:c}},rightOf:function(t,n){var e=t.edge,r=e.region.r,i=n.x>r.x;if(i&&\"l\"===t.side)return 1;if(!i&&\"r\"===t.side)return 0;if(1===e.a){var u=n.y-r.y,a=n.x-r.x,o=0,c=0;if(!i&&0>e.b||i&&e.b>=0?c=o=u>=e.b*a:(c=n.x+n.y*e.b>e.c,0>e.b&&(c=!c),c||(o=1)),!o){var l=r.x-e.region.l.x;c=e.b*(a*a-u*u)<l*u*(1+2*a/l+e.b*e.b),0>e.b&&(c=!c)}}else{var s=e.c-e.a*n.x,f=n.y-s,h=n.x-r.x,d=s-r.y;c=f*f>h*h+d*d}return\"l\"===t.side?c:!c},endPoint:function(t,e,r){t.ep[e]=r,t.ep[_o[e]]&&n(t)},distance:function(t,n){var e=t.x-n.x,r=t.y-n.y;return Math.sqrt(e*e+r*r)}},u={list:[],insert:function(t,n,e){t.vertex=n,t.ystar=n.y+e;for(var r=0,i=u.list,a=i.length;a>r;r++){var o=i[r];if(!(t.ystar>o.ystar||t.ystar==o.ystar&&n.x>o.vertex.x))break}i.splice(r,0,t)},del:function(t){for(var n=0,e=u.list,r=e.length;r>n&&e[n]!=t;++n);e.splice(n,1)},empty:function(){return 0===u.list.length},nextEvent:function(t){for(var n=0,e=u.list,r=e.length;r>n;++n)if(e[n]==t)return e[n+1];return null},min:function(){var t=u.list[0];return{x:t.vertex.x,y:t.ystar}},extractMin:function(){return u.list.shift()}};r.init(),e.bottomSite=e.list.shift();for(var a,o,c,l,s,f,h,d,g,p,m,v,y,M=e.list.shift();;)if(u.empty()||(a=u.min()),M&&(u.empty()||M.y<a.y||M.y==a.y&&M.x<a.x))o=r.leftBound(M),c=r.right(o),h=r.rightRegion(o),v=i.bisect(h,M),f=r.createHalfEdge(v,\"l\"),r.insert(o,f),p=i.intersect(o,f),p&&(u.del(o),u.insert(o,p,i.distance(p,M))),o=f,f=r.createHalfEdge(v,\"r\"),r.insert(o,f),p=i.intersect(f,c),p&&u.insert(f,p,i.distance(p,M)),M=e.list.shift();else{if(u.empty())break;o=u.extractMin(),l=r.left(o),c=r.right(o),s=r.right(c),h=r.leftRegion(o),d=r.rightRegion(c),m=o.vertex,i.endPoint(o.edge,o.side,m),i.endPoint(c.edge,c.side,m),r.del(o),u.del(c),r.del(c),y=\"l\",h.y>d.y&&(g=h,h=d,d=g,y=\"r\"),v=i.bisect(h,d),f=r.createHalfEdge(v,y),r.insert(l,f),i.endPoint(v,_o[y],m),p=i.intersect(l,f),p&&(u.del(l),u.insert(l,p,i.distance(p,h))),p=i.intersect(f,s),p&&u.insert(f,p,i.distance(p,h))}for(o=r.right(r.leftEnd);o!=r.rightEnd;o=r.right(o))n(o.edge)}function Ji(){return{leaf:!0,nodes:[],point:null}}function Gi(t,n,e,r,i,u){if(!t(n,e,r,i,u)){var a=.5*(e+i),o=.5*(r+u),c=n.nodes;c[0]&&Gi(t,c[0],e,r,a,o),c[1]&&Gi(t,c[1],a,r,i,o),c[2]&&Gi(t,c[2],e,o,a,u),c[3]&&Gi(t,c[3],a,o,i,u)}}function Ki(){this._=new Date(arguments.length>1?Date.UTC.apply(this,arguments):arguments[0])}function Wi(t,n,e,r){for(var i,u,a=0,o=n.length,c=e.length;o>a;){if(r>=c)return-1;if(i=n.charCodeAt(a++),37===i){if(u=Yo[n.charAt(a++)],!u||0>(r=u(t,e,r)))return-1}else if(i!=e.charCodeAt(r++))return-1}return r}function Qi(t){return RegExp(\"^(?:\"+t.map(d3.requote).join(\"|\")+\")\",\"i\")}function tu(t){for(var n=new u,e=-1,r=t.length;r>++e;)n.set(t[e].toLowerCase(),e);return n}function nu(t,n,e){t+=\"\";var r=t.length;return e>r?Array(e-r+1).join(n)+t:t}function eu(t,n,e){Lo.lastIndex=0;var r=Lo.exec(n.substring(e));return r?e+=r[0].length:-1}function ru(t,n,e){Do.lastIndex=0;var r=Do.exec(n.substring(e));return r?e+=r[0].length:-1}function iu(t,n,e){Ro.lastIndex=0;var r=Ro.exec(n.substring(e));return r?(t.m=Po.get(r[0].toLowerCase()),e+=r[0].length):-1}function uu(t,n,e){Fo.lastIndex=0;var r=Fo.exec(n.substring(e));return r?(t.m=Ho.get(r[0].toLowerCase()),e+=r[0].length):-1}function au(t,n,e){return Wi(t,\"\"+Oo.c,n,e)}function ou(t,n,e){return Wi(t,\"\"+Oo.x,n,e)}function cu(t,n,e){return Wi(t,\"\"+Oo.X,n,e)}function lu(t,n,e){Uo.lastIndex=0;var r=Uo.exec(n.substring(e,e+4));return r?(t.y=+r[0],e+=r[0].length):-1}function su(t,n,e){Uo.lastIndex=0;var r=Uo.exec(n.substring(e,e+2));return r?(t.y=fu(+r[0]),e+=r[0].length):-1}function fu(t){return t+(t>68?1900:2e3)}function hu(t,n,e){Uo.lastIndex=0;var r=Uo.exec(n.substring(e,e+2));return r?(t.m=r[0]-1,e+=r[0].length):-1}function du(t,n,e){Uo.lastIndex=0;var r=Uo.exec(n.substring(e,e+2));return r?(t.d=+r[0],e+=r[0].length):-1}function gu(t,n,e){Uo.lastIndex=0;var r=Uo.exec(n.substring(e,e+2));return r?(t.H=+r[0],e+=r[0].length):-1}function pu(t,n,e){Uo.lastIndex=0;var r=Uo.exec(n.substring(e,e+2));return r?(t.M=+r[0],e+=r[0].length):-1}function mu(t,n,e){Uo.lastIndex=0;var r=Uo.exec(n.substring(e,e+2));return r?(t.S=+r[0],e+=r[0].length):-1}function vu(t,n,e){Uo.lastIndex=0;var r=Uo.exec(n.substring(e,e+3));return r?(t.L=+r[0],e+=r[0].length):-1}function yu(t,n,e){var r=Io.get(n.substring(e,e+=2).toLowerCase());return null==r?-1:(t.p=r,e)}function Mu(t){var n=t.getTimezoneOffset(),e=n>0?\"-\":\"+\",r=~~(Math.abs(n)/60),i=Math.abs(n)%60;return e+nu(r,\"0\",2)+nu(i,\"0\",2)}function bu(t){return t.toISOString()}function xu(t,n,e){function r(n){var e=t(n),r=u(e,1);return r-n>n-e?e:r}function i(e){return n(e=t(new wo(e-1)),1),e}function u(t,e){return n(t=new wo(+t),e),t}function a(t,r,u){var a=i(t),o=[];if(u>1)for(;r>a;)e(a)%u||o.push(new Date(+a)),n(a,1);else for(;r>a;)o.push(new Date(+a)),n(a,1);return o}function o(t,n,e){try{wo=Ki;var r=new Ki;return r._=t,a(r,n,e)}finally{wo=Date}}t.floor=t,t.round=r,t.ceil=i,t.offset=u,t.range=a;var c=t.utc=_u(t);return c.floor=c,c.round=_u(r),c.ceil=_u(i),c.offset=_u(u),c.range=o,t}function _u(t){return function(n,e){try{wo=Ki;var r=new Ki;return r._=n,t(r,e)._}finally{wo=Date}}}function wu(t,n,e){function r(n){return t(n)}return r.invert=function(n){return ku(t.invert(n))},r.domain=function(n){return arguments.length?(t.domain(n),r):t.domain().map(ku)},r.nice=function(t){return r.domain(Yn(r.domain(),function(){return t}))},r.ticks=function(e,i){var u=Su(r.domain());if(\"function\"!=typeof e){var a=u[1]-u[0],o=a/e,c=d3.bisect(Xo,o);if(c==Xo.length)return n.year(u,e);if(!c)return t.ticks(e).map(ku);Math.log(o/Xo[c-1])<Math.log(Xo[c]/o)&&--c,e=n[c],i=e[1],e=e[0].range}return e(u[0],new Date(+u[1]+1),i)},r.tickFormat=function(){return e},r.copy=function(){return wu(t.copy(),n,e)},d3.rebind(r,t,\"range\",\"rangeRound\",\"interpolate\",\"clamp\")}function Su(t){var n=t[0],e=t[t.length-1];return e>n?[n,e]:[e,n]}function ku(t){return new Date(t)}function Eu(t){return function(n){for(var e=t.length-1,r=t[e];!r[1](n);)r=t[--e];return r[0](n)}}function Au(t){var n=new Date(t,0,1);return n.setFullYear(t),n}function Nu(t){var n=t.getFullYear(),e=Au(n),r=Au(n+1);return n+(t-e)/(r-e)}function Tu(t){var n=new Date(Date.UTC(t,0,1));return n.setUTCFullYear(t),n}function qu(t){var n=t.getUTCFullYear(),e=Tu(n),r=Tu(n+1);return n+(t-e)/(r-e)}var Cu=\".\",zu=\",\",Du=[3,3];Date.now||(Date.now=function(){return+new Date});try{document.createElement(\"div\").style.setProperty(\"opacity\",0,\"\")}catch(Lu){var Fu=CSSStyleDeclaration.prototype,Hu=Fu.setProperty;Fu.setProperty=function(t,n,e){Hu.call(this,t,n+\"\",e)}}d3={version:\"3.0.4\"};var Ru=Math.PI,Pu=1e-6,ju=Ru/180,Ou=180/Ru,Yu=i;try{Yu(document.documentElement.childNodes)[0].nodeType}catch(Uu){Yu=r}var Iu=[].__proto__?function(t,n){t.__proto__=n}:function(t,n){for(var e in n)t[e]=n[e]};d3.map=function(t){var n=new u;for(var e in t)n.set(e,t[e]);return n},e(u,{has:function(t){return Vu+t in this},get:function(t){return this[Vu+t]},set:function(t,n){return this[Vu+t]=n},remove:function(t){return t=Vu+t,t in this&&delete this[t]},keys:function(){var t=[];return this.forEach(function(n){t.push(n)}),t},values:function(){var t=[];return this.forEach(function(n,e){t.push(e)}),t},entries:function(){var t=[];return this.forEach(function(n,e){t.push({key:n,value:e})}),t},forEach:function(t){for(var n in this)n.charCodeAt(0)===Xu&&t.call(this,n.substring(1),this[n])}});var Vu=\"\\0\",Xu=Vu.charCodeAt(0);d3.functor=c,d3.rebind=function(t,n){for(var e,r=1,i=arguments.length;i>++r;)t[e=arguments[r]]=l(t,n,n[e]);return t},d3.ascending=function(t,n){return n>t?-1:t>n?1:t>=n?0:0/0},d3.descending=function(t,n){return t>n?-1:n>t?1:n>=t?0:0/0},d3.mean=function(t,n){var e,r=t.length,i=0,u=-1,a=0;if(1===arguments.length)for(;r>++u;)s(e=t[u])&&(i+=(e-i)/++a);else for(;r>++u;)s(e=n.call(t,t[u],u))&&(i+=(e-i)/++a);return a?i:void 0},d3.median=function(t,n){return arguments.length>1&&(t=t.map(n)),t=t.filter(s),t.length?d3.quantile(t.sort(d3.ascending),.5):void 0},d3.min=function(t,n){var e,r,i=-1,u=t.length;if(1===arguments.length){for(;u>++i&&(null==(e=t[i])||e!=e);)e=void 0;for(;u>++i;)null!=(r=t[i])&&e>r&&(e=r)}else{for(;u>++i&&(null==(e=n.call(t,t[i],i))||e!=e);)e=void 0;for(;u>++i;)null!=(r=n.call(t,t[i],i))&&e>r&&(e=r)}return e},d3.max=function(t,n){var e,r,i=-1,u=t.length;if(1===arguments.length){for(;u>++i&&(null==(e=t[i])||e!=e);)e=void 0;for(;u>++i;)null!=(r=t[i])&&r>e&&(e=r)}else{for(;u>++i&&(null==(e=n.call(t,t[i],i))||e!=e);)e=void 0;for(;u>++i;)null!=(r=n.call(t,t[i],i))&&r>e&&(e=r)}return e},d3.extent=function(t,n){var e,r,i,u=-1,a=t.length;if(1===arguments.length){for(;a>++u&&(null==(e=i=t[u])||e!=e);)e=i=void 0;for(;a>++u;)null!=(r=t[u])&&(e>r&&(e=r),r>i&&(i=r))}else{for(;a>++u&&(null==(e=i=n.call(t,t[u],u))||e!=e);)e=void 0;for(;a>++u;)null!=(r=n.call(t,t[u],u))&&(e>r&&(e=r),r>i&&(i=r))}return[e,i]},d3.random={normal:function(t,n){var e=arguments.length;return 2>e&&(n=1),1>e&&(t=0),function(){var e,r,i;do e=2*Math.random()-1,r=2*Math.random()-1,i=e*e+r*r;while(!i||i>1);return t+n*e*Math.sqrt(-2*Math.log(i)/i)}},logNormal:function(t,n){var e=arguments.length;2>e&&(n=1),1>e&&(t=0);var r=d3.random.normal();return function(){return Math.exp(t+n*r())}},irwinHall:function(t){return function(){for(var n=0,e=0;t>e;e++)n+=Math.random();return n/t}}},d3.sum=function(t,n){var e,r=0,i=t.length,u=-1;if(1===arguments.length)for(;i>++u;)isNaN(e=+t[u])||(r+=e);else for(;i>++u;)isNaN(e=+n.call(t,t[u],u))||(r+=e);return r},d3.quantile=function(t,n){var e=(t.length-1)*n+1,r=Math.floor(e),i=+t[r-1],u=e-r;return u?i+u*(t[r]-i):i},d3.shuffle=function(t){for(var n,e,r=t.length;r;)e=0|Math.random()*r--,n=t[r],t[r]=t[e],t[e]=n;return t},d3.transpose=function(t){return d3.zip.apply(d3,t)},d3.zip=function(){if(!(r=arguments.length))return[];for(var t=-1,n=d3.min(arguments,f),e=Array(n);n>++t;)for(var r,i=-1,u=e[t]=Array(r);r>++i;)u[i]=arguments[i][t];return e},d3.bisector=function(t){return{left:function(n,e,r,i){for(3>arguments.length&&(r=0),4>arguments.length&&(i=n.length);i>r;){var u=r+i>>>1;e>t.call(n,n[u],u)?r=u+1:i=u}return r},right:function(n,e,r,i){for(3>arguments.length&&(r=0),4>arguments.length&&(i=n.length);i>r;){var u=r+i>>>1;t.call(n,n[u],u)>e?i=u:r=u+1}return r}}};var Zu=d3.bisector(function(t){return t});d3.bisectLeft=Zu.left,d3.bisect=d3.bisectRight=Zu.right,d3.nest=function(){function t(n,o){if(o>=a.length)return r?r.call(i,n):e?n.sort(e):n;for(var c,l,s,f=-1,h=n.length,d=a[o++],g=new u,p={};h>++f;)(s=g.get(c=d(l=n[f])))?s.push(l):g.set(c,[l]);return g.forEach(function(n,e){p[n]=t(e,o)}),p}function n(t,e){if(e>=a.length)return t;var r,i=[],u=o[e++];for(r in t)i.push({key:r,values:n(t[r],e)});return u&&i.sort(function(t,n){return u(t.key,n.key)}),i}var e,r,i={},a=[],o=[];return i.map=function(n){return t(n,0)},i.entries=function(e){return n(t(e,0),0)},i.key=function(t){return a.push(t),i},i.sortKeys=function(t){return o[a.length-1]=t,i},i.sortValues=function(t){return e=t,i},i.rollup=function(t){return r=t,i},i},d3.keys=function(t){var n=[];for(var e in t)n.push(e);return n},d3.values=function(t){var n=[];for(var e in t)n.push(t[e]);return n},d3.entries=function(t){var n=[];for(var e in t)n.push({key:e,value:t[e]});return n},d3.permute=function(t,n){for(var e=[],r=-1,i=n.length;i>++r;)e[r]=t[n[r]];return e},d3.merge=function(t){return Array.prototype.concat.apply([],t)},d3.range=function(t,n,e){if(3>arguments.length&&(e=1,2>arguments.length&&(n=t,t=0)),1/0===(n-t)/e)throw Error(\"infinite range\");var r,i=[],u=d(Math.abs(e)),a=-1;if(t*=u,n*=u,e*=u,0>e)for(;(r=t+e*++a)>n;)i.push(r/u);else for(;n>(r=t+e*++a);)i.push(r/u);return i},d3.requote=function(t){return t.replace(Bu,\"\\\\$&\")};var Bu=/[\\\\\\^\\$\\*\\+\\?\\|\\[\\]\\(\\)\\.\\{\\}]/g;d3.round=function(t,n){return n?Math.round(t*(n=Math.pow(10,n)))/n:Math.round(t)},d3.xhr=function(t,n,e){function r(){var t=l.status;!t&&l.responseText||t>=200&&300>t||304===t?u.load.call(i,c.call(i,l)):u.error.call(i,l)}var i={},u=d3.dispatch(\"progress\",\"load\",\"error\"),o={},c=a,l=new(window.XDomainRequest&&/^(http(s)?:)?\\/\\//.test(t)?XDomainRequest:XMLHttpRequest);return\"onload\"in l?l.onload=l.onerror=r:l.onreadystatechange=function(){l.readyState>3&&r()},l.onprogress=function(t){var n=d3.event;d3.event=t;try{u.progress.call(i,l)}finally{d3.event=n}},i.header=function(t,n){return t=(t+\"\").toLowerCase(),2>arguments.length?o[t]:(null==n?delete o[t]:o[t]=n+\"\",i)},i.mimeType=function(t){return arguments.length?(n=null==t?null:t+\"\",i):n},i.response=function(t){return c=t,i},[\"get\",\"post\"].forEach(function(t){i[t]=function(){return i.send.apply(i,[t].concat(Yu(arguments)))}}),i.send=function(e,r,u){if(2===arguments.length&&\"function\"==typeof r&&(u=r,r=null),l.open(e,t,!0),null==n||\"accept\"in o||(o.accept=n+\",*/*\"),l.setRequestHeader)for(var a in o)l.setRequestHeader(a,o[a]);return null!=n&&l.overrideMimeType&&l.overrideMimeType(n),null!=u&&i.on(\"error\",u).on(\"load\",function(t){u(null,t)}),l.send(null==r?null:r),i},i.abort=function(){return l.abort(),i},d3.rebind(i,u,\"on\"),2===arguments.length&&\"function\"==typeof n&&(e=n,n=null),null==e?i:i.get(g(e))},d3.text=function(){return d3.xhr.apply(d3,arguments).response(p)},d3.json=function(t,n){return d3.xhr(t,\"application/json\",n).response(m)},d3.html=function(t,n){return d3.xhr(t,\"text/html\",n).response(v)},d3.xml=function(){return d3.xhr.apply(d3,arguments).response(y)};var $u={svg:\"http://www.w3.org/2000/svg\",xhtml:\"http://www.w3.org/1999/xhtml\",xlink:\"http://www.w3.org/1999/xlink\",xml:\"http://www.w3.org/XML/1998/namespace\",xmlns:\"http://www.w3.org/2000/xmlns/\"};d3.ns={prefix:$u,qualify:function(t){var n=t.indexOf(\":\"),e=t;return n>=0&&(e=t.substring(0,n),t=t.substring(n+1)),$u.hasOwnProperty(e)?{space:$u[e],local:t}:t}},d3.dispatch=function(){for(var t=new M,n=-1,e=arguments.length;e>++n;)t[arguments[n]]=b(t);return t},M.prototype.on=function(t,n){var e=t.indexOf(\".\"),r=\"\";return e>0&&(r=t.substring(e+1),t=t.substring(0,e)),2>arguments.length?this[t].on(r):this[t].on(r,n)},d3.format=function(t){var n=Ju.exec(t),e=n[1]||\" \",r=n[2]||\">\",i=n[3]||\"\",u=n[4]||\"\",a=n[5],o=+n[6],c=n[7],l=n[8],s=n[9],f=1,h=\"\",d=!1;switch(l&&(l=+l.substring(1)),(a||\"0\"===e&&\"=\"===r)&&(a=e=\"0\",r=\"=\",c&&(o-=Math.floor((o-1)/4))),s){case\"n\":c=!0,s=\"g\";break;case\"%\":f=100,h=\"%\",s=\"f\";break;case\"p\":f=100,h=\"%\",s=\"r\";break;case\"b\":case\"o\":case\"x\":case\"X\":u&&(u=\"0\"+s.toLowerCase());case\"c\":case\"d\":d=!0,l=0;break;case\"s\":f=-1,s=\"r\"}\"#\"===u&&(u=\"\"),\"r\"!=s||l||(s=\"g\"),s=Gu.get(s)||_;var g=a&&c;return function(t){if(d&&t%1)return\"\";var n=0>t||0===t&&0>1/t?(t=-t,\"-\"):i;if(0>f){var p=d3.formatPrefix(t,l);t=p.scale(t),h=p.symbol}else t*=f;t=s(t,l),!a&&c&&(t=Ku(t));var m=u.length+t.length+(g?0:n.length),v=o>m?Array(m=o-m+1).join(e):\"\";return g&&(t=Ku(v+t)),Cu&&t.replace(\".\",Cu),n+=u,(\"<\"===r?n+t+v:\">\"===r?v+n+t:\"^\"===r?v.substring(0,m>>=1)+n+t+v.substring(m):n+(g?t:v+t))+h}};var Ju=/(?:([^{])?([<>=^]))?([+\\- ])?(#)?(0)?([0-9]+)?(,)?(\\.[0-9]+)?([a-zA-Z%])?/,Gu=d3.map({b:function(t){return t.toString(2)},c:function(t){return String.fromCharCode(t)},o:function(t){return t.toString(8)},x:function(t){return t.toString(16)},X:function(t){return t.toString(16).toUpperCase()},g:function(t,n){return t.toPrecision(n)},e:function(t,n){return t.toExponential(n)},f:function(t,n){return t.toFixed(n)},r:function(t,n){return d3.round(t,n=x(t,n)).toFixed(Math.max(0,Math.min(20,n)))}}),Ku=a;if(Du){var Wu=Du.length;Ku=function(t){for(var n=t.lastIndexOf(\".\"),e=n>=0?\".\"+t.substring(n+1):(n=t.length,\"\"),r=[],i=0,u=Du[0];n>0&&u>0;)r.push(t.substring(n-=u,n+u)),u=Du[i=(i+1)%Wu];return r.reverse().join(zu||\"\")+e}}var Qu=[\"y\",\"z\",\"a\",\"f\",\"p\",\"n\",\"\u03bc\",\"m\",\"\",\"k\",\"M\",\"G\",\"T\",\"P\",\"E\",\"Z\",\"Y\"].map(w);d3.formatPrefix=function(t,n){var e=0;return t&&(0>t&&(t*=-1),n&&(t=d3.round(t,x(t,n))),e=1+Math.floor(1e-12+Math.log(t)/Math.LN10),e=Math.max(-24,Math.min(24,3*Math.floor((0>=e?e+1:e-1)/3)))),Qu[8+e/3]};var ta=function(){return a},na=d3.map({linear:ta,poly:q,quad:function(){return A},cubic:function(){return N},sin:function(){return C},exp:function(){return z},circle:function(){return D},elastic:L,back:F,bounce:function(){return H}}),ea=d3.map({\"in\":a,out:k,\"in-out\":E,\"out-in\":function(t){return E(k(t))}});d3.ease=function(t){var n=t.indexOf(\"-\"),e=n>=0?t.substring(0,n):t,r=n>=0?t.substring(n+1):\"in\";return e=na.get(e)||ta,r=ea.get(r)||a,S(r(e.apply(null,Array.prototype.slice.call(arguments,1))))},d3.event=null,d3.transform=function(t){var n=document.createElementNS(d3.ns.prefix.svg,\"g\");return(d3.transform=function(t){n.setAttribute(\"transform\",t);var e=n.transform.baseVal.consolidate();return new O(e?e.matrix:ra)})(t)},O.prototype.toString=function(){return\"translate(\"+this.translate+\")rotate(\"+this.rotate+\")skewX(\"+this.skew+\")scale(\"+this.scale+\")\"};var ra={a:1,b:0,c:0,d:1,e:0,f:0};d3.interpolate=function(t,n){for(var e,r=d3.interpolators.length;--r>=0&&!(e=d3.interpolators[r](t,n)););return e},d3.interpolateNumber=function(t,n){return n-=t,function(e){return t+n*e}},d3.interpolateRound=function(t,n){return n-=t,function(e){return Math.round(t+n*e)}},d3.interpolateString=function(t,n){var e,r,i,u,a,o=0,c=0,l=[],s=[];for(ia.lastIndex=0,r=0;e=ia.exec(n);++r)e.index&&l.push(n.substring(o,c=e.index)),s.push({i:l.length,x:e[0]}),l.push(null),o=ia.lastIndex;for(n.length>o&&l.push(n.substring(o)),r=0,u=s.length;(e=ia.exec(t))&&u>r;++r)if(a=s[r],a.x==e[0]){if(a.i)if(null==l[a.i+1])for(l[a.i-1]+=a.x,l.splice(a.i,1),i=r+1;u>i;++i)s[i].i--;else for(l[a.i-1]+=a.x+l[a.i+1],l.splice(a.i,2),i=r+1;u>i;++i)s[i].i-=2;else if(null==l[a.i+1])l[a.i]=a.x;else for(l[a.i]=a.x+l[a.i+1],l.splice(a.i+1,1),i=r+1;u>i;++i)s[i].i--;s.splice(r,1),u--,r--}else a.x=d3.interpolateNumber(parseFloat(e[0]),parseFloat(a.x));for(;u>r;)a=s.pop(),null==l[a.i+1]?l[a.i]=a.x:(l[a.i]=a.x+l[a.i+1],l.splice(a.i+1,1)),u--;return 1===l.length?null==l[0]?s[0].x:function(){return n}:function(t){for(r=0;u>r;++r)l[(a=s[r]).i]=a.x(t);return l.join(\"\")}},d3.interpolateTransform=function(t,n){var e,r=[],i=[],u=d3.transform(t),a=d3.transform(n),o=u.translate,c=a.translate,l=u.rotate,s=a.rotate,f=u.skew,h=a.skew,d=u.scale,g=a.scale;return o[0]!=c[0]||o[1]!=c[1]?(r.push(\"translate(\",null,\",\",null,\")\"),i.push({i:1,x:d3.interpolateNumber(o[0],c[0])},{i:3,x:d3.interpolateNumber(o[1],c[1])})):c[0]||c[1]?r.push(\"translate(\"+c+\")\"):r.push(\"\"),l!=s?(l-s>180?s+=360:s-l>180&&(l+=360),i.push({i:r.push(r.pop()+\"rotate(\",null,\")\")-2,x:d3.interpolateNumber(l,s)})):s&&r.push(r.pop()+\"rotate(\"+s+\")\"),f!=h?i.push({i:r.push(r.pop()+\"skewX(\",null,\")\")-2,x:d3.interpolateNumber(f,h)}):h&&r.push(r.pop()+\"skewX(\"+h+\")\"),d[0]!=g[0]||d[1]!=g[1]?(e=r.push(r.pop()+\"scale(\",null,\",\",null,\")\"),i.push({i:e-4,x:d3.interpolateNumber(d[0],g[0])},{i:e-2,x:d3.interpolateNumber(d[1],g[1])})):(1!=g[0]||1!=g[1])&&r.push(r.pop()+\"scale(\"+g+\")\"),e=i.length,function(t){for(var n,u=-1;e>++u;)r[(n=i[u]).i]=n.x(t);return r.join(\"\")}},d3.interpolateRgb=function(t,n){t=d3.rgb(t),n=d3.rgb(n);var e=t.r,r=t.g,i=t.b,u=n.r-e,a=n.g-r,o=n.b-i;return function(t){return\"#\"+G(Math.round(e+u*t))+G(Math.round(r+a*t))+G(Math.round(i+o*t))}},d3.interpolateHsl=function(t,n){t=d3.hsl(t),n=d3.hsl(n);var e=t.h,r=t.s,i=t.l,u=n.h-e,a=n.s-r,o=n.l-i;return u>180?u-=360:-180>u&&(u+=360),function(t){return un(e+u*t,r+a*t,i+o*t)+\"\"}},d3.interpolateLab=function(t,n){t=d3.lab(t),n=d3.lab(n);var e=t.l,r=t.a,i=t.b,u=n.l-e,a=n.a-r,o=n.b-i;return function(t){return fn(e+u*t,r+a*t,i+o*t)+\"\"}},d3.interpolateHcl=function(t,n){t=d3.hcl(t),n=d3.hcl(n);var e=t.h,r=t.c,i=t.l,u=n.h-e,a=n.c-r,o=n.l-i;return u>180?u-=360:-180>u&&(u+=360),function(t){return cn(e+u*t,r+a*t,i+o*t)+\"\"}},d3.interpolateArray=function(t,n){var e,r=[],i=[],u=t.length,a=n.length,o=Math.min(t.length,n.length);for(e=0;o>e;++e)r.push(d3.interpolate(t[e],n[e]));for(;u>e;++e)i[e]=t[e];for(;a>e;++e)i[e]=n[e];return function(t){for(e=0;o>e;++e)i[e]=r[e](t);return i}},d3.interpolateObject=function(t,n){var e,r={},i={};for(e in t)e in n?r[e]=V(e)(t[e],n[e]):i[e]=t[e];for(e in n)e in t||(i[e]=n[e]);return function(t){for(e in r)i[e]=r[e](t);return i}};var ia=/[-+]?(?:\\d+\\.?\\d*|\\.?\\d+)(?:[eE][-+]?\\d+)?/g;d3.interpolators=[d3.interpolateObject,function(t,n){return n instanceof Array&&d3.interpolateArray(t,n)},function(t,n){return(\"string\"==typeof t||\"string\"==typeof n)&&d3.interpolateString(t+\"\",n+\"\")},function(t,n){return(\"string\"==typeof n?aa.has(n)||/^(#|rgb\\(|hsl\\()/.test(n):n instanceof B)&&d3.interpolateRgb(t,n)},function(t,n){return!isNaN(t=+t)&&!isNaN(n=+n)&&d3.interpolateNumber(t,n)}],B.prototype.toString=function(){return this.rgb()+\"\"},d3.rgb=function(t,n,e){return 1===arguments.length?t instanceof J?$(t.r,t.g,t.b):K(\"\"+t,$,un):$(~~t,~~n,~~e)};var ua=J.prototype=new B;ua.brighter=function(t){t=Math.pow(.7,arguments.length?t:1);var n=this.r,e=this.g,r=this.b,i=30;return n||e||r?(n&&i>n&&(n=i),e&&i>e&&(e=i),r&&i>r&&(r=i),$(Math.min(255,Math.floor(n/t)),Math.min(255,Math.floor(e/t)),Math.min(255,Math.floor(r/t)))):$(i,i,i)},ua.darker=function(t){return t=Math.pow(.7,arguments.length?t:1),$(Math.floor(t*this.r),Math.floor(t*this.g),Math.floor(t*this.b))", "},ua.hsl=function(){return W(this.r,this.g,this.b)},ua.toString=function(){return\"#\"+G(this.r)+G(this.g)+G(this.b)};var aa=d3.map({aliceblue:\"#f0f8ff\",antiquewhite:\"#faebd7\",aqua:\"#00ffff\",aquamarine:\"#7fffd4\",azure:\"#f0ffff\",beige:\"#f5f5dc\",bisque:\"#ffe4c4\",black:\"#000000\",blanchedalmond:\"#ffebcd\",blue:\"#0000ff\",blueviolet:\"#8a2be2\",brown:\"#a52a2a\",burlywood:\"#deb887\",cadetblue:\"#5f9ea0\",chartreuse:\"#7fff00\",chocolate:\"#d2691e\",coral:\"#ff7f50\",cornflowerblue:\"#6495ed\",cornsilk:\"#fff8dc\",crimson:\"#dc143c\",cyan:\"#00ffff\",darkblue:\"#00008b\",darkcyan:\"#008b8b\",darkgoldenrod:\"#b8860b\",darkgray:\"#a9a9a9\",darkgreen:\"#006400\",darkgrey:\"#a9a9a9\",darkkhaki:\"#bdb76b\",darkmagenta:\"#8b008b\",darkolivegreen:\"#556b2f\",darkorange:\"#ff8c00\",darkorchid:\"#9932cc\",darkred:\"#8b0000\",darksalmon:\"#e9967a\",darkseagreen:\"#8fbc8f\",darkslateblue:\"#483d8b\",darkslategray:\"#2f4f4f\",darkslategrey:\"#2f4f4f\",darkturquoise:\"#00ced1\",darkviolet:\"#9400d3\",deeppink:\"#ff1493\",deepskyblue:\"#00bfff\",dimgray:\"#696969\",dimgrey:\"#696969\",dodgerblue:\"#1e90ff\",firebrick:\"#b22222\",floralwhite:\"#fffaf0\",forestgreen:\"#228b22\",fuchsia:\"#ff00ff\",gainsboro:\"#dcdcdc\",ghostwhite:\"#f8f8ff\",gold:\"#ffd700\",goldenrod:\"#daa520\",gray:\"#808080\",green:\"#008000\",greenyellow:\"#adff2f\",grey:\"#808080\",honeydew:\"#f0fff0\",hotpink:\"#ff69b4\",indianred:\"#cd5c5c\",indigo:\"#4b0082\",ivory:\"#fffff0\",khaki:\"#f0e68c\",lavender:\"#e6e6fa\",lavenderblush:\"#fff0f5\",lawngreen:\"#7cfc00\",lemonchiffon:\"#fffacd\",lightblue:\"#add8e6\",lightcoral:\"#f08080\",lightcyan:\"#e0ffff\",lightgoldenrodyellow:\"#fafad2\",lightgray:\"#d3d3d3\",lightgreen:\"#90ee90\",lightgrey:\"#d3d3d3\",lightpink:\"#ffb6c1\",lightsalmon:\"#ffa07a\",lightseagreen:\"#20b2aa\",lightskyblue:\"#87cefa\",lightslategray:\"#778899\",lightslategrey:\"#778899\",lightsteelblue:\"#b0c4de\",lightyellow:\"#ffffe0\",lime:\"#00ff00\",limegreen:\"#32cd32\",linen:\"#faf0e6\",magenta:\"#ff00ff\",maroon:\"#800000\",mediumaquamarine:\"#66cdaa\",mediumblue:\"#0000cd\",mediumorchid:\"#ba55d3\",mediumpurple:\"#9370db\",mediumseagreen:\"#3cb371\",mediumslateblue:\"#7b68ee\",mediumspringgreen:\"#00fa9a\",mediumturquoise:\"#48d1cc\",mediumvioletred:\"#c71585\",midnightblue:\"#191970\",mintcream:\"#f5fffa\",mistyrose:\"#ffe4e1\",moccasin:\"#ffe4b5\",navajowhite:\"#ffdead\",navy:\"#000080\",oldlace:\"#fdf5e6\",olive:\"#808000\",olivedrab:\"#6b8e23\",orange:\"#ffa500\",orangered:\"#ff4500\",orchid:\"#da70d6\",palegoldenrod:\"#eee8aa\",palegreen:\"#98fb98\",paleturquoise:\"#afeeee\",palevioletred:\"#db7093\",papayawhip:\"#ffefd5\",peachpuff:\"#ffdab9\",peru:\"#cd853f\",pink:\"#ffc0cb\",plum:\"#dda0dd\",powderblue:\"#b0e0e6\",purple:\"#800080\",red:\"#ff0000\",rosybrown:\"#bc8f8f\",royalblue:\"#4169e1\",saddlebrown:\"#8b4513\",salmon:\"#fa8072\",sandybrown:\"#f4a460\",seagreen:\"#2e8b57\",seashell:\"#fff5ee\",sienna:\"#a0522d\",silver:\"#c0c0c0\",skyblue:\"#87ceeb\",slateblue:\"#6a5acd\",slategray:\"#708090\",slategrey:\"#708090\",snow:\"#fffafa\",springgreen:\"#00ff7f\",steelblue:\"#4682b4\",tan:\"#d2b48c\",teal:\"#008080\",thistle:\"#d8bfd8\",tomato:\"#ff6347\",turquoise:\"#40e0d0\",violet:\"#ee82ee\",wheat:\"#f5deb3\",white:\"#ffffff\",whitesmoke:\"#f5f5f5\",yellow:\"#ffff00\",yellowgreen:\"#9acd32\"});aa.forEach(function(t,n){aa.set(t,K(n,$,un))}),d3.hsl=function(t,n,e){return 1===arguments.length?t instanceof rn?en(t.h,t.s,t.l):K(\"\"+t,W,en):en(+t,+n,+e)};var oa=rn.prototype=new B;oa.brighter=function(t){return t=Math.pow(.7,arguments.length?t:1),en(this.h,this.s,this.l/t)},oa.darker=function(t){return t=Math.pow(.7,arguments.length?t:1),en(this.h,this.s,t*this.l)},oa.rgb=function(){return un(this.h,this.s,this.l)},d3.hcl=function(t,n,e){return 1===arguments.length?t instanceof on?an(t.h,t.c,t.l):t instanceof sn?hn(t.l,t.a,t.b):hn((t=Q((t=d3.rgb(t)).r,t.g,t.b)).l,t.a,t.b):an(+t,+n,+e)};var ca=on.prototype=new B;ca.brighter=function(t){return an(this.h,this.c,Math.min(100,this.l+la*(arguments.length?t:1)))},ca.darker=function(t){return an(this.h,this.c,Math.max(0,this.l-la*(arguments.length?t:1)))},ca.rgb=function(){return cn(this.h,this.c,this.l).rgb()},d3.lab=function(t,n,e){return 1===arguments.length?t instanceof sn?ln(t.l,t.a,t.b):t instanceof on?cn(t.l,t.c,t.h):Q((t=d3.rgb(t)).r,t.g,t.b):ln(+t,+n,+e)};var la=18,sa=.95047,fa=1,ha=1.08883,da=sn.prototype=new B;da.brighter=function(t){return ln(Math.min(100,this.l+la*(arguments.length?t:1)),this.a,this.b)},da.darker=function(t){return ln(Math.max(0,this.l-la*(arguments.length?t:1)),this.a,this.b)},da.rgb=function(){return fn(this.l,this.a,this.b)};var ga=function(t,n){return n.querySelector(t)},pa=function(t,n){return n.querySelectorAll(t)},ma=document.documentElement,va=ma.matchesSelector||ma.webkitMatchesSelector||ma.mozMatchesSelector||ma.msMatchesSelector||ma.oMatchesSelector,ya=function(t,n){return va.call(t,n)};\"function\"==typeof Sizzle&&(ga=function(t,n){return Sizzle(t,n)[0]||null},pa=function(t,n){return Sizzle.uniqueSort(Sizzle(t,n))},ya=Sizzle.matchesSelector);var Ma=[];d3.selection=function(){return ba},d3.selection.prototype=Ma,Ma.select=function(t){var n,e,r,i,u=[];\"function\"!=typeof t&&(t=vn(t));for(var a=-1,o=this.length;o>++a;){u.push(n=[]),n.parentNode=(r=this[a]).parentNode;for(var c=-1,l=r.length;l>++c;)(i=r[c])?(n.push(e=t.call(i,i.__data__,c)),e&&\"__data__\"in i&&(e.__data__=i.__data__)):n.push(null)}return mn(u)},Ma.selectAll=function(t){var n,e,r=[];\"function\"!=typeof t&&(t=yn(t));for(var i=-1,u=this.length;u>++i;)for(var a=this[i],o=-1,c=a.length;c>++o;)(e=a[o])&&(r.push(n=Yu(t.call(e,e.__data__,o))),n.parentNode=e);return mn(r)},Ma.attr=function(t,n){if(2>arguments.length){if(\"string\"==typeof t){var e=this.node();return t=d3.ns.qualify(t),t.local?e.getAttributeNS(t.space,t.local):e.getAttribute(t)}for(n in t)this.each(Mn(n,t[n]));return this}return this.each(Mn(t,n))},Ma.classed=function(t,n){if(2>arguments.length){if(\"string\"==typeof t){var e=this.node(),r=(t=t.trim().split(/^|\\s+/g)).length,i=-1;if(n=e.classList){for(;r>++i;)if(!n.contains(t[i]))return!1}else for(n=e.className,null!=n.baseVal&&(n=n.baseVal);r>++i;)if(!bn(t[i]).test(n))return!1;return!0}for(n in t)this.each(xn(n,t[n]));return this}return this.each(xn(t,n))},Ma.style=function(t,n,e){var r=arguments.length;if(3>r){if(\"string\"!=typeof t){2>r&&(n=\"\");for(e in t)this.each(wn(e,t[e],n));return this}if(2>r)return getComputedStyle(this.node(),null).getPropertyValue(t);e=\"\"}return this.each(wn(t,n,e))},Ma.property=function(t,n){if(2>arguments.length){if(\"string\"==typeof t)return this.node()[t];for(n in t)this.each(Sn(n,t[n]));return this}return this.each(Sn(t,n))},Ma.text=function(t){return arguments.length?this.each(\"function\"==typeof t?function(){var n=t.apply(this,arguments);this.textContent=null==n?\"\":n}:null==t?function(){this.textContent=\"\"}:function(){this.textContent=t}):this.node().textContent},Ma.html=function(t){return arguments.length?this.each(\"function\"==typeof t?function(){var n=t.apply(this,arguments);this.innerHTML=null==n?\"\":n}:null==t?function(){this.innerHTML=\"\"}:function(){this.innerHTML=t}):this.node().innerHTML},Ma.append=function(t){function n(){return this.appendChild(document.createElementNS(this.namespaceURI,t))}function e(){return this.appendChild(document.createElementNS(t.space,t.local))}return t=d3.ns.qualify(t),this.select(t.local?e:n)},Ma.insert=function(t,n){function e(){return this.insertBefore(document.createElementNS(this.namespaceURI,t),ga(n,this))}function r(){return this.insertBefore(document.createElementNS(t.space,t.local),ga(n,this))}return t=d3.ns.qualify(t),this.select(t.local?r:e)},Ma.remove=function(){return this.each(function(){var t=this.parentNode;t&&t.removeChild(this)})},Ma.data=function(t,n){function e(t,e){var r,i,a,o=t.length,f=e.length,h=Math.min(o,f),d=Array(f),g=Array(f),p=Array(o);if(n){var m,v=new u,y=new u,M=[];for(r=-1;o>++r;)m=n.call(i=t[r],i.__data__,r),v.has(m)?p[r]=i:v.set(m,i),M.push(m);for(r=-1;f>++r;)m=n.call(e,a=e[r],r),(i=v.get(m))?(d[r]=i,i.__data__=a):y.has(m)||(g[r]=kn(a)),y.set(m,a),v.remove(m);for(r=-1;o>++r;)v.has(M[r])&&(p[r]=t[r])}else{for(r=-1;h>++r;)i=t[r],a=e[r],i?(i.__data__=a,d[r]=i):g[r]=kn(a);for(;f>r;++r)g[r]=kn(e[r]);for(;o>r;++r)p[r]=t[r]}g.update=d,g.parentNode=d.parentNode=p.parentNode=t.parentNode,c.push(g),l.push(d),s.push(p)}var r,i,a=-1,o=this.length;if(!arguments.length){for(t=Array(o=(r=this[0]).length);o>++a;)(i=r[a])&&(t[a]=i.__data__);return t}var c=qn([]),l=mn([]),s=mn([]);if(\"function\"==typeof t)for(;o>++a;)e(r=this[a],t.call(r,r.parentNode.__data__,a));else for(;o>++a;)e(r=this[a],t);return l.enter=function(){return c},l.exit=function(){return s},l},Ma.datum=function(t){return arguments.length?this.property(\"__data__\",t):this.property(\"__data__\")},Ma.filter=function(t){var n,e,r,i=[];\"function\"!=typeof t&&(t=En(t));for(var u=0,a=this.length;a>u;u++){i.push(n=[]),n.parentNode=(e=this[u]).parentNode;for(var o=0,c=e.length;c>o;o++)(r=e[o])&&t.call(r,r.__data__,o)&&n.push(r)}return mn(i)},Ma.order=function(){for(var t=-1,n=this.length;n>++t;)for(var e,r=this[t],i=r.length-1,u=r[i];--i>=0;)(e=r[i])&&(u&&u!==e.nextSibling&&u.parentNode.insertBefore(e,u),u=e);return this},Ma.sort=function(t){t=An.apply(this,arguments);for(var n=-1,e=this.length;e>++n;)this[n].sort(t);return this.order()},Ma.on=function(t,n,e){var r=arguments.length;if(3>r){if(\"string\"!=typeof t){2>r&&(n=!1);for(e in t)this.each(Nn(e,t[e],n));return this}if(2>r)return(r=this.node()[\"__on\"+t])&&r._;e=!1}return this.each(Nn(t,n,e))},Ma.each=function(t){return Tn(this,function(n,e,r){t.call(n,n.__data__,e,r)})},Ma.call=function(t){var n=Yu(arguments);return t.apply(n[0]=this,n),this},Ma.empty=function(){return!this.node()},Ma.node=function(){for(var t=0,n=this.length;n>t;t++)for(var e=this[t],r=0,i=e.length;i>r;r++){var u=e[r];if(u)return u}return null},Ma.transition=function(){var t,n,e=_a||++Sa,r=[],i=Object.create(ka);i.time=Date.now();for(var u=-1,a=this.length;a>++u;){r.push(t=[]);for(var o=this[u],c=-1,l=o.length;l>++c;)(n=o[c])&&zn(n,c,e,i),t.push(n)}return Cn(r,e)};var ba=mn([[document]]);ba[0].parentNode=ma,d3.select=function(t){return\"string\"==typeof t?ba.select(t):mn([[t]])},d3.selectAll=function(t){return\"string\"==typeof t?ba.selectAll(t):mn([Yu(t)])};var xa=[];d3.selection.enter=qn,d3.selection.enter.prototype=xa,xa.append=Ma.append,xa.insert=Ma.insert,xa.empty=Ma.empty,xa.node=Ma.node,xa.select=function(t){for(var n,e,r,i,u,a=[],o=-1,c=this.length;c>++o;){r=(i=this[o]).update,a.push(n=[]),n.parentNode=i.parentNode;for(var l=-1,s=i.length;s>++l;)(u=i[l])?(n.push(r[l]=e=t.call(i.parentNode,u.__data__,l)),e.__data__=u.__data__):n.push(null)}return mn(a)};var _a,wa=[],Sa=0,ka={ease:T,delay:0,duration:250};wa.call=Ma.call,wa.empty=Ma.empty,wa.node=Ma.node,d3.transition=function(t){return arguments.length?_a?t.transition():t:ba.transition()},d3.transition.prototype=wa,wa.select=function(t){var n,e,r,i=this.id,u=[];\"function\"!=typeof t&&(t=vn(t));for(var a=-1,o=this.length;o>++a;){u.push(n=[]);for(var c=this[a],l=-1,s=c.length;s>++l;)(r=c[l])&&(e=t.call(r,r.__data__,l))?(\"__data__\"in r&&(e.__data__=r.__data__),zn(e,l,i,r.__transition__[i]),n.push(e)):n.push(null)}return Cn(u,i)},wa.selectAll=function(t){var n,e,r,i,u,a=this.id,o=[];\"function\"!=typeof t&&(t=yn(t));for(var c=-1,l=this.length;l>++c;)for(var s=this[c],f=-1,h=s.length;h>++f;)if(r=s[f]){u=r.__transition__[a],e=t.call(r,r.__data__,f),o.push(n=[]);for(var d=-1,g=e.length;g>++d;)zn(i=e[d],d,a,u),n.push(i)}return Cn(o,a)},wa.filter=function(t){var n,e,r,i=[];\"function\"!=typeof t&&(t=En(t));for(var u=0,a=this.length;a>u;u++){i.push(n=[]);for(var e=this[u],o=0,c=e.length;c>o;o++)(r=e[o])&&t.call(r,r.__data__,o)&&n.push(r)}return Cn(i,this.id,this.time).ease(this.ease())},wa.attr=function(t,n){function e(){this.removeAttribute(u)}function r(){this.removeAttributeNS(u.space,u.local)}if(2>arguments.length){for(n in t)this.attr(n,t[n]);return this}var i=V(t),u=d3.ns.qualify(t);return Ln(this,\"attr.\"+t,n,function(t){function n(){var n,e=this.getAttribute(u);return e!==t&&(n=i(e,t),function(t){this.setAttribute(u,n(t))})}function a(){var n,e=this.getAttributeNS(u.space,u.local);return e!==t&&(n=i(e,t),function(t){this.setAttributeNS(u.space,u.local,n(t))})}return null==t?u.local?r:e:(t+=\"\",u.local?a:n)})},wa.attrTween=function(t,n){function e(t,e){var r=n.call(this,t,e,this.getAttribute(i));return r&&function(t){this.setAttribute(i,r(t))}}function r(t,e){var r=n.call(this,t,e,this.getAttributeNS(i.space,i.local));return r&&function(t){this.setAttributeNS(i.space,i.local,r(t))}}var i=d3.ns.qualify(t);return this.tween(\"attr.\"+t,i.local?r:e)},wa.style=function(t,n,e){function r(){this.style.removeProperty(t)}var i=arguments.length;if(3>i){if(\"string\"!=typeof t){2>i&&(n=\"\");for(e in t)this.style(e,t[e],n);return this}e=\"\"}var u=V(t);return Ln(this,\"style.\"+t,n,function(n){function i(){var r,i=getComputedStyle(this,null).getPropertyValue(t);return i!==n&&(r=u(i,n),function(n){this.style.setProperty(t,r(n),e)})}return null==n?r:(n+=\"\",i)})},wa.styleTween=function(t,n,e){return 3>arguments.length&&(e=\"\"),this.tween(\"style.\"+t,function(r,i){var u=n.call(this,r,i,getComputedStyle(this,null).getPropertyValue(t));return u&&function(n){this.style.setProperty(t,u(n),e)}})},wa.text=function(t){return Ln(this,\"text\",t,Dn)},wa.remove=function(){return this.each(\"end.transition\",function(){var t;!this.__transition__&&(t=this.parentNode)&&t.removeChild(this)})},wa.ease=function(t){var n=this.id;return 1>arguments.length?this.node().__transition__[n].ease:(\"function\"!=typeof t&&(t=d3.ease.apply(d3,arguments)),Tn(this,function(e){e.__transition__[n].ease=t}))},wa.delay=function(t){var n=this.id;return Tn(this,\"function\"==typeof t?function(e,r,i){e.__transition__[n].delay=0|t.call(e,e.__data__,r,i)}:(t|=0,function(e){e.__transition__[n].delay=t}))},wa.duration=function(t){var n=this.id;return Tn(this,\"function\"==typeof t?function(e,r,i){e.__transition__[n].duration=Math.max(1,0|t.call(e,e.__data__,r,i))}:(t=Math.max(1,0|t),function(e){e.__transition__[n].duration=t}))},wa.each=function(t,n){var e=this.id;if(2>arguments.length){var r=ka,i=_a;_a=e,Tn(this,function(n,r,i){ka=n.__transition__[e],t.call(n,n.__data__,r,i)}),ka=r,_a=i}else Tn(this,function(r){r.__transition__[e].event.on(t,n)});return this},wa.transition=function(){for(var t,n,e,r,i=this.id,u=++Sa,a=[],o=0,c=this.length;c>o;o++){a.push(t=[]);for(var n=this[o],l=0,s=n.length;s>l;l++)(e=n[l])&&(r=Object.create(e.__transition__[i]),r.delay+=r.duration,zn(e,l,u,r)),t.push(e)}return Cn(a,u)},wa.tween=function(t,n){var e=this.id;return 2>arguments.length?this.node().__transition__[e].tween.get(t):Tn(this,null==n?function(n){n.__transition__[e].tween.remove(t)}:function(r){r.__transition__[e].tween.set(t,n)})};var Ea,Aa,Na=0,Ta={},qa=null;d3.timer=function(t,n,e){if(3>arguments.length){if(2>arguments.length)n=0;else if(!isFinite(n))return;e=Date.now()}var r=Ta[t.id];r&&r.callback===t?(r.then=e,r.delay=n):Ta[t.id=++Na]=qa={callback:t,then:e,delay:n,next:qa},Ea||(Aa=clearTimeout(Aa),Ea=1,Ca(Fn))},d3.timer.flush=function(){for(var t,n=Date.now(),e=qa;e;)t=n-e.then,e.delay||(e.flush=e.callback(t)),e=e.next;Hn()};var Ca=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){setTimeout(t,17)};d3.mouse=function(t){return Rn(t,P())};var za=/WebKit/.test(navigator.userAgent)?-1:0;d3.touches=function(t,n){return 2>arguments.length&&(n=P().touches),n?Yu(n).map(function(n){var e=Rn(t,n);return e.identifier=n.identifier,e}):[]},d3.scale={},d3.scale.linear=function(){return In([0,1],[0,1],d3.interpolate,!1)},d3.scale.log=function(){return Kn(d3.scale.linear(),Wn)};var Da=d3.format(\".0e\");Wn.pow=function(t){return Math.pow(10,t)},Qn.pow=function(t){return-Math.pow(10,-t)},d3.scale.pow=function(){return te(d3.scale.linear(),1)},d3.scale.sqrt=function(){return d3.scale.pow().exponent(.5)},d3.scale.ordinal=function(){return ee([],{t:\"range\",a:[[]]})},d3.scale.category10=function(){return d3.scale.ordinal().range(La)},d3.scale.category20=function(){return d3.scale.ordinal().range(Fa)},d3.scale.category20b=function(){return d3.scale.ordinal().range(Ha)},d3.scale.category20c=function(){return d3.scale.ordinal().range(Ra)};var La=[\"#1f77b4\",\"#ff7f0e\",\"#2ca02c\",\"#d62728\",\"#9467bd\",\"#8c564b\",\"#e377c2\",\"#7f7f7f\",\"#bcbd22\",\"#17becf\"],Fa=[\"#1f77b4\",\"#aec7e8\",\"#ff7f0e\",\"#ffbb78\",\"#2ca02c\",\"#98df8a\",\"#d62728\",\"#ff9896\",\"#9467bd\",\"#c5b0d5\",\"#8c564b\",\"#c49c94\",\"#e377c2\",\"#f7b6d2\",\"#7f7f7f\",\"#c7c7c7\",\"#bcbd22\",\"#dbdb8d\",\"#17becf\",\"#9edae5\"],Ha=[\"#393b79\",\"#5254a3\",\"#6b6ecf\",\"#9c9ede\",\"#637939\",\"#8ca252\",\"#b5cf6b\",\"#cedb9c\",\"#8c6d31\",\"#bd9e39\",\"#e7ba52\",\"#e7cb94\",\"#843c39\",\"#ad494a\",\"#d6616b\",\"#e7969c\",\"#7b4173\",\"#a55194\",\"#ce6dbd\",\"#de9ed6\"],Ra=[\"#3182bd\",\"#6baed6\",\"#9ecae1\",\"#c6dbef\",\"#e6550d\",\"#fd8d3c\",\"#fdae6b\",\"#fdd0a2\",\"#31a354\",\"#74c476\",\"#a1d99b\",\"#c7e9c0\",\"#756bb1\",\"#9e9ac8\",\"#bcbddc\",\"#dadaeb\",\"#636363\",\"#969696\",\"#bdbdbd\",\"#d9d9d9\"];d3.scale.quantile=function(){return re([],[])},d3.scale.quantize=function(){return ie(0,1,[0,1])},d3.scale.threshold=function(){return ue([.5],[0,1])},d3.scale.identity=function(){return ae([0,1])},d3.svg={},d3.svg.arc=function(){function t(){var t=n.apply(this,arguments),u=e.apply(this,arguments),a=r.apply(this,arguments)+Pa,o=i.apply(this,arguments)+Pa,c=(a>o&&(c=a,a=o,o=c),o-a),l=Ru>c?\"0\":\"1\",s=Math.cos(a),f=Math.sin(a),h=Math.cos(o),d=Math.sin(o);return c>=ja?t?\"M0,\"+u+\"A\"+u+\",\"+u+\" 0 1,1 0,\"+-u+\"A\"+u+\",\"+u+\" 0 1,1 0,\"+u+\"M0,\"+t+\"A\"+t+\",\"+t+\" 0 1,0 0,\"+-t+\"A\"+t+\",\"+t+\" 0 1,0 0,\"+t+\"Z\":\"M0,\"+u+\"A\"+u+\",\"+u+\" 0 1,1 0,\"+-u+\"A\"+u+\",\"+u+\" 0 1,1 0,\"+u+\"Z\":t?\"M\"+u*s+\",\"+u*f+\"A\"+u+\",\"+u+\" 0 \"+l+\",1 \"+u*h+\",\"+u*d+\"L\"+t*h+\",\"+t*d+\"A\"+t+\",\"+t+\" 0 \"+l+\",0 \"+t*s+\",\"+t*f+\"Z\":\"M\"+u*s+\",\"+u*f+\"A\"+u+\",\"+u+\" 0 \"+l+\",1 \"+u*h+\",\"+u*d+\"L0,0\"+\"Z\"}var n=oe,e=ce,r=le,i=se;return t.innerRadius=function(e){return arguments.length?(n=c(e),t):n},t.outerRadius=function(n){return arguments.length?(e=c(n),t):e},t.startAngle=function(n){return arguments.length?(r=c(n),t):r},t.endAngle=function(n){return arguments.length?(i=c(n),t):i},t.centroid=function(){var t=(n.apply(this,arguments)+e.apply(this,arguments))/2,u=(r.apply(this,arguments)+i.apply(this,arguments))/2+Pa;return[Math.cos(u)*t,Math.sin(u)*t]},t};var Pa=-Ru/2,ja=2*Ru-1e-6;d3.svg.line=function(){return fe(a)};var Oa=d3.map({linear:ge,\"linear-closed\":pe,\"step-before\":me,\"step-after\":ve,basis:we,\"basis-open\":Se,\"basis-closed\":ke,bundle:Ee,cardinal:be,\"cardinal-open\":ye,\"cardinal-closed\":Me,monotone:ze});Oa.forEach(function(t,n){n.key=t,n.closed=/-closed$/.test(t)});var Ya=[0,2/3,1/3,0],Ua=[0,1/3,2/3,0],Ia=[0,1/6,2/3,1/6];d3.svg.line.radial=function(){var t=fe(De);return t.radius=t.x,delete t.x,t.angle=t.y,delete t.y,t},me.reverse=ve,ve.reverse=me,d3.svg.area=function(){return Le(a)},d3.svg.area.radial=function(){var t=Le(De);return t.radius=t.x,delete t.x,t.innerRadius=t.x0,delete t.x0,t.outerRadius=t.x1,delete t.x1,t.angle=t.y,delete t.y,t.startAngle=t.y0,delete t.y0,t.endAngle=t.y1,delete t.y1,t},d3.svg.chord=function(){function e(t,n){var e=r(this,o,t,n),c=r(this,l,t,n);return\"M\"+e.p0+u(e.r,e.p1,e.a1-e.a0)+(i(e,c)?a(e.r,e.p1,e.r,e.p0):a(e.r,e.p1,c.r,c.p0)+u(c.r,c.p1,c.a1-c.a0)+a(c.r,c.p1,e.r,e.p0))+\"Z\"}function r(t,n,e,r){var i=n.call(t,e,r),u=s.call(t,i,r),a=f.call(t,i,r)+Pa,o=h.call(t,i,r)+Pa;return{r:u,a0:a,a1:o,p0:[u*Math.cos(a),u*Math.sin(a)],p1:[u*Math.cos(o),u*Math.sin(o)]}}function i(t,n){return t.a0==n.a0&&t.a1==n.a1}function u(t,n,e){return\"A\"+t+\",\"+t+\" 0 \"+ +(e>Ru)+\",1 \"+n}function a(t,n,e,r){return\"Q 0,0 \"+r}var o=n,l=t,s=Fe,f=le,h=se;return e.radius=function(t){return arguments.length?(s=c(t),e):s},e.source=function(t){return arguments.length?(o=c(t),e):o},e.target=function(t){return arguments.length?(l=c(t),e):l},e.startAngle=function(t){return arguments.length?(f=c(t),e):f},e.endAngle=function(t){return arguments.length?(h=c(t),e):h},e},d3.svg.diagonal=function(){function e(t,n){var e=r.call(this,t,n),a=i.call(this,t,n),o=(e.y+a.y)/2,c=[e,{x:e.x,y:o},{x:a.x,y:o},a];return c=c.map(u),\"M\"+c[0]+\"C\"+c[1]+\" \"+c[2]+\" \"+c[3]}var r=n,i=t,u=He;return e.source=function(t){return arguments.length?(r=c(t),e):r},e.target=function(t){return arguments.length?(i=c(t),e):i},e.projection=function(t){return arguments.length?(u=t,e):u},e},d3.svg.diagonal.radial=function(){var t=d3.svg.diagonal(),n=He,e=t.projection;return t.projection=function(t){return arguments.length?e(Re(n=t)):n},t},d3.svg.symbol=function(){function t(t,r){return(Va.get(n.call(this,t,r))||Oe)(e.call(this,t,r))}var n=je,e=Pe;return t.type=function(e){return arguments.length?(n=c(e),t):n},t.size=function(n){return arguments.length?(e=c(n),t):e},t};var Va=d3.map({circle:Oe,cross:function(t){var n=Math.sqrt(t/5)/2;return\"M\"+-3*n+\",\"+-n+\"H\"+-n+\"V\"+-3*n+\"H\"+n+\"V\"+-n+\"H\"+3*n+\"V\"+n+\"H\"+n+\"V\"+3*n+\"H\"+-n+\"V\"+n+\"H\"+-3*n+\"Z\"},diamond:function(t){var n=Math.sqrt(t/(2*Za)),e=n*Za;return\"M0,\"+-n+\"L\"+e+\",0\"+\" 0,\"+n+\" \"+-e+\",0\"+\"Z\"},square:function(t){var n=Math.sqrt(t)/2;return\"M\"+-n+\",\"+-n+\"L\"+n+\",\"+-n+\" \"+n+\",\"+n+\" \"+-n+\",\"+n+\"Z\"},\"triangle-down\":function(t){var n=Math.sqrt(t/Xa),e=n*Xa/2;return\"M0,\"+e+\"L\"+n+\",\"+-e+\" \"+-n+\",\"+-e+\"Z\"},\"triangle-up\":function(t){var n=Math.sqrt(t/Xa),e=n*Xa/2;return\"M0,\"+-e+\"L\"+n+\",\"+e+\" \"+-n+\",\"+e+\"Z\"}});d3.svg.symbolTypes=Va.keys();var Xa=Math.sqrt(3),Za=Math.tan(30*ju);d3.svg.axis=function(){function t(t){t.each(function(){var t,f=d3.select(this),h=null==l?e.ticks?e.ticks.apply(e,c):e.domain():l,d=null==n?e.tickFormat?e.tickFormat.apply(e,c):String:n,g=Ie(e,h,s),p=f.selectAll(\".minor\").data(g,String),m=p.enter().insert(\"line\",\"g\").attr(\"class\",\"tick minor\").style(\"opacity\",1e-6),v=d3.transition(p.exit()).style(\"opacity\",1e-6).remove(),y=d3.transition(p).style(\"opacity\",1),M=f.selectAll(\"g\").data(h,String),b=M.enter().insert(\"g\",\"path\").style(\"opacity\",1e-6),x=d3.transition(M.exit()).style(\"opacity\",1e-6).remove(),_=d3.transition(M).style(\"opacity\",1),w=On(e),S=f.selectAll(\".domain\").data([0]),k=d3.transition(S),E=e.copy(),A=this.__chart__||E;this.__chart__=E,S.enter().append(\"path\").attr(\"class\",\"domain\"),b.append(\"line\").attr(\"class\",\"tick\"),b.append(\"text\");var N=b.select(\"line\"),T=_.select(\"line\"),q=M.select(\"text\").text(d),C=b.select(\"text\"),z=_.select(\"text\");switch(r){case\"bottom\":t=Ye,m.attr(\"y2\",u),y.attr(\"x2\",0).attr(\"y2\",u),N.attr(\"y2\",i),C.attr(\"y\",Math.max(i,0)+o),T.attr(\"x2\",0).attr(\"y2\",i),z.attr(\"x\",0).attr(\"y\",Math.max(i,0)+o),q.attr(\"dy\",\".71em\").style(\"text-anchor\",\"middle\"),k.attr(\"d\",\"M\"+w[0]+\",\"+a+\"V0H\"+w[1]+\"V\"+a);break;case\"top\":t=Ye,m.attr(\"y2\",-u),y.attr(\"x2\",0).attr(\"y2\",-u),N.attr(\"y2\",-i),C.attr(\"y\",-(Math.max(i,0)+o)),T.attr(\"x2\",0).attr(\"y2\",-i),z.attr(\"x\",0).attr(\"y\",-(Math.max(i,0)+o)),q.attr(\"dy\",\"0em\").style(\"text-anchor\",\"middle\"),k.attr(\"d\",\"M\"+w[0]+\",\"+-a+\"V0H\"+w[1]+\"V\"+-a);break;case\"left\":t=Ue,m.attr(\"x2\",-u),y.attr(\"x2\",-u).attr(\"y2\",0),N.attr(\"x2\",-i),C.attr(\"x\",-(Math.max(i,0)+o)),T.attr(\"x2\",-i).attr(\"y2\",0),z.attr(\"x\",-(Math.max(i,0)+o)).attr(\"y\",0),q.attr(\"dy\",\".32em\").style(\"text-anchor\",\"end\"),k.attr(\"d\",\"M\"+-a+\",\"+w[0]+\"H0V\"+w[1]+\"H\"+-a);break;case\"right\":t=Ue,m.attr(\"x2\",u),y.attr(\"x2\",u).attr(\"y2\",0),N.attr(\"x2\",i),C.attr(\"x\",Math.max(i,0)+o),T.attr(\"x2\",i).attr(\"y2\",0),z.attr(\"x\",Math.max(i,0)+o).attr(\"y\",0),q.attr(\"dy\",\".32em\").style(\"text-anchor\",\"start\"),k.attr(\"d\",\"M\"+a+\",\"+w[0]+\"H0V\"+w[1]+\"H\"+a)}if(e.ticks)b.call(t,A),_.call(t,E),x.call(t,E),m.call(t,A),y.call(t,E),v.call(t,E);else{var D=E.rangeBand()/2,L=function(t){return E(t)+D};b.call(t,L),_.call(t,L)}})}var n,e=d3.scale.linear(),r=\"bottom\",i=6,u=6,a=6,o=3,c=[10],l=null,s=0;return t.scale=function(n){return arguments.length?(e=n,t):e},t.orient=function(n){return arguments.length?(r=n,t):r},t.ticks=function(){return arguments.length?(c=arguments,t):c},t.tickValues=function(n){return arguments.length?(l=n,t):l},t.tickFormat=function(e){return arguments.length?(n=e,t):n},t.tickSize=function(n,e){if(!arguments.length)return i;var r=arguments.length-1;return i=+n,u=r>1?+e:i,a=r>0?+arguments[r]:i,t},t.tickPadding=function(n){return arguments.length?(o=+n,t):o},t.tickSubdivide=function(n){return arguments.length?(s=+n,t):s},t},d3.svg.brush=function(){function t(u){u.each(function(){var u,a=d3.select(this),s=a.selectAll(\".background\").data([0]),f=a.selectAll(\".extent\").data([0]),h=a.selectAll(\".resize\").data(l,String);a.style(\"pointer-events\",\"all\").on(\"mousedown.brush\",i).on(\"touchstart.brush\",i),s.enter().append(\"rect\").attr(\"class\",\"background\").style(\"visibility\",\"hidden\").style(\"cursor\",\"crosshair\"),f.enter().append(\"rect\").attr(\"class\",\"extent\").style(\"cursor\",\"move\"),h.enter().append(\"g\").attr(\"class\",function(t){return\"resize \"+t}).style(\"cursor\",function(t){return Ba[t]}).append(\"rect\").attr(\"x\",function(t){return/[ew]$/.test(t)?-3:null}).attr(\"y\",function(t){return/^[ns]/.test(t)?-3:null}).attr(\"width\",6).attr(\"height\",6).style(\"visibility\",\"hidden\"),h.style(\"display\",t.empty()?\"none\":null),h.exit().remove(),o&&(u=On(o),s.attr(\"x\",u[0]).attr(\"width\",u[1]-u[0]),e(a)),c&&(u=On(c),s.attr(\"y\",u[0]).attr(\"height\",u[1]-u[0]),r(a)),n(a)})}function n(t){t.selectAll(\".resize\").attr(\"transform\",function(t){return\"translate(\"+s[+/e$/.test(t)][0]+\",\"+s[+/^s/.test(t)][1]+\")\"})}function e(t){t.select(\".extent\").attr(\"x\",s[0][0]),t.selectAll(\".extent,.n>rect,.s>rect\").attr(\"width\",s[1][0]-s[0][0])}function r(t){t.select(\".extent\").attr(\"y\",s[0][1]),t.selectAll(\".extent,.e>rect,.w>rect\").attr(\"height\",s[1][1]-s[0][1])}function i(){function i(){var t=d3.event.changedTouches;return t?d3.touches(v,t)[0]:d3.mouse(v)}function l(){32==d3.event.keyCode&&(S||(p=null,k[0]-=s[1][0],k[1]-=s[1][1],S=2),R())}function f(){32==d3.event.keyCode&&2==S&&(k[0]+=s[1][0],k[1]+=s[1][1],S=0,R())}function h(){var t=i(),u=!1;m&&(t[0]+=m[0],t[1]+=m[1]),S||(d3.event.altKey?(p||(p=[(s[0][0]+s[1][0])/2,(s[0][1]+s[1][1])/2]),k[0]=s[+(t[0]<p[0])][0],k[1]=s[+(t[1]<p[1])][1]):p=null),_&&d(t,o,0)&&(e(b),u=!0),w&&d(t,c,1)&&(r(b),u=!0),u&&(n(b),M({type:\"brush\",mode:S?\"move\":\"resize\"}))}function d(t,n,e){var r,i,a=On(n),o=a[0],c=a[1],l=k[e],f=s[1][e]-s[0][e];return S&&(o-=l,c-=f+l),r=Math.max(o,Math.min(c,t[e])),S?i=(r+=l)+f:(p&&(l=Math.max(o,Math.min(c,2*p[e]-r))),r>l?(i=r,r=l):i=l),s[0][e]!==r||s[1][e]!==i?(u=null,s[0][e]=r,s[1][e]=i,!0):void 0}function g(){h(),b.style(\"pointer-events\",\"all\").selectAll(\".resize\").style(\"display\",t.empty()?\"none\":null),d3.select(\"body\").style(\"cursor\",null),E.on(\"mousemove.brush\",null).on(\"mouseup.brush\",null).on(\"touchmove.brush\",null).on(\"touchend.brush\",null).on(\"keydown.brush\",null).on(\"keyup.brush\",null),M({type:\"brushend\"}),R()}var p,m,v=this,y=d3.select(d3.event.target),M=a.of(v,arguments),b=d3.select(v),x=y.datum(),_=!/^(n|s)$/.test(x)&&o,w=!/^(e|w)$/.test(x)&&c,S=y.classed(\"extent\"),k=i(),E=d3.select(window).on(\"mousemove.brush\",h).on(\"mouseup.brush\",g).on(\"touchmove.brush\",h).on(\"touchend.brush\",g).on(\"keydown.brush\",l).on(\"keyup.brush\",f);if(S)k[0]=s[0][0]-k[0],k[1]=s[0][1]-k[1];else if(x){var A=+/w$/.test(x),N=+/^n/.test(x);m=[s[1-A][0]-k[0],s[1-N][1]-k[1]],k[0]=s[A][0],k[1]=s[N][1]}else d3.event.altKey&&(p=k.slice());b.style(\"pointer-events\",\"none\").selectAll(\".resize\").style(\"display\",null),d3.select(\"body\").style(\"cursor\",y.style(\"cursor\")),M({type:\"brushstart\"}),h(),R()}var u,a=j(t,\"brushstart\",\"brush\",\"brushend\"),o=null,c=null,l=$a[0],s=[[0,0],[0,0]];return t.x=function(n){return arguments.length?(o=n,l=$a[!o<<1|!c],t):o},t.y=function(n){return arguments.length?(c=n,l=$a[!o<<1|!c],t):c},t.extent=function(n){var e,r,i,a,l;return arguments.length?(u=[[0,0],[0,0]],o&&(e=n[0],r=n[1],c&&(e=e[0],r=r[0]),u[0][0]=e,u[1][0]=r,o.invert&&(e=o(e),r=o(r)),e>r&&(l=e,e=r,r=l),s[0][0]=0|e,s[1][0]=0|r),c&&(i=n[0],a=n[1],o&&(i=i[1],a=a[1]),u[0][1]=i,u[1][1]=a,c.invert&&(i=c(i),a=c(a)),i>a&&(l=i,i=a,a=l),s[0][1]=0|i,s[1][1]=0|a),t):(n=u||s,o&&(e=n[0][0],r=n[1][0],u||(e=s[0][0],r=s[1][0],o.invert&&(e=o.invert(e),r=o.invert(r)),e>r&&(l=e,e=r,r=l))),c&&(i=n[0][1],a=n[1][1],u||(i=s[0][1],a=s[1][1],c.invert&&(i=c.invert(i),a=c.invert(a)),i>a&&(l=i,i=a,a=l))),o&&c?[[e,i],[r,a]]:o?[e,r]:c&&[i,a])},t.clear=function(){return u=null,s[0][0]=s[0][1]=s[1][0]=s[1][1]=0,t},t.empty=function(){return o&&s[0][0]===s[1][0]||c&&s[0][1]===s[1][1]},d3.rebind(t,a,\"on\")};var Ba={n:\"ns-resize\",e:\"ew-resize\",s:\"ns-resize\",w:\"ew-resize\",nw:\"nwse-resize\",ne:\"nesw-resize\",se:\"nwse-resize\",sw:\"nesw-resize\"},$a=[[\"n\",\"e\",\"s\",\"w\",\"nw\",\"ne\",\"se\",\"sw\"],[\"e\",\"w\"],[\"n\",\"s\"],[]];d3.behavior={},d3.behavior.drag=function(){function t(){this.on(\"mousedown.drag\",n).on(\"touchstart.drag\",n)}function n(){function t(){var t=o.parentNode;return null!=s?d3.touches(t).filter(function(t){return t.identifier===s})[0]:d3.mouse(t)}function n(){if(!o.parentNode)return i();var n=t(),e=n[0]-f[0],r=n[1]-f[1];h|=e|r,f=n,R(),c({type:\"drag\",x:n[0]+a[0],y:n[1]+a[1],dx:e,dy:r})}function i(){c({type:\"dragend\"}),h&&(R(),d3.event.target===l&&d.on(\"click.drag\",u,!0)),d.on(null!=s?\"touchmove.drag-\"+s:\"mousemove.drag\",null).on(null!=s?\"touchend.drag-\"+s:\"mouseup.drag\",null)}function u(){R(),d.on(\"click.drag\",null)}var a,o=this,c=e.of(o,arguments),l=d3.event.target,s=d3.event.touches?d3.event.changedTouches[0].identifier:null,f=t(),h=0,d=d3.select(window).on(null!=s?\"touchmove.drag-\"+s:\"mousemove.drag\",n).on(null!=s?\"touchend.drag-\"+s:\"mouseup.drag\",i,!0);r?(a=r.apply(o,arguments),a=[a.x-f[0],a.y-f[1]]):a=[0,0],null==s&&R(),c({type:\"dragstart\"})}var e=j(t,\"drag\",\"dragstart\",\"dragend\"),r=null;return t.origin=function(n){return arguments.length?(r=n,t):r},d3.rebind(t,e,\"on\")},d3.behavior.zoom=function(){function t(){this.on(\"mousedown.zoom\",o).on(\"mousewheel.zoom\",c).on(\"mousemove.zoom\",l).on(\"DOMMouseScroll.zoom\",c).on(\"dblclick.zoom\",s).on(\"touchstart.zoom\",f).on(\"touchmove.zoom\",h).on(\"touchend.zoom\",f)}function n(t){return[(t[0]-b[0])/x,(t[1]-b[1])/x]}function e(t){return[t[0]*x+b[0],t[1]*x+b[1]]}function r(t){x=Math.max(_[0],Math.min(_[1],t))}function i(t,n){n=e(n),b[0]+=t[0]-n[0],b[1]+=t[1]-n[1]}function u(){m&&m.domain(p.range().map(function(t){return(t-b[0])/x}).map(p.invert)),y&&y.domain(v.range().map(function(t){return(t-b[1])/x}).map(v.invert))}function a(t){u(),d3.event.preventDefault(),t({type:\"zoom\",scale:x,translate:b})}function o(){function t(){l=1,i(d3.mouse(u),f),a(o)}function e(){l&&R(),s.on(\"mousemove.zoom\",null).on(\"mouseup.zoom\",null),l&&d3.event.target===c&&s.on(\"click.zoom\",r,!0)}function r(){R(),s.on(\"click.zoom\",null)}var u=this,o=w.of(u,arguments),c=d3.event.target,l=0,s=d3.select(window).on(\"mousemove.zoom\",t).on(\"mouseup.zoom\",e),f=n(d3.mouse(u));window.focus(),R()}function c(){d||(d=n(d3.mouse(this))),r(Math.pow(2,.002*Ve())*x),i(d3.mouse(this),d),a(w.of(this,arguments))}function l(){d=null}function s(){var t=d3.mouse(this),e=n(t),u=Math.log(x)/Math.LN2;r(Math.pow(2,d3.event.shiftKey?Math.ceil(u)-1:Math.floor(u)+1)),i(t,e),a(w.of(this,arguments))}function f(){var t=d3.touches(this),e=Date.now();if(g=x,d={},t.forEach(function(t){d[t.identifier]=n(t)}),R(),1===t.length){if(500>e-M){var u=t[0],o=n(t[0]);r(2*x),i(u,o),a(w.of(this,arguments))}M=e}}function h(){var t=d3.touches(this),n=t[0],e=d[n.identifier];if(u=t[1]){var u,o=d[u.identifier];n=[(n[0]+u[0])/2,(n[1]+u[1])/2],e=[(e[0]+o[0])/2,(e[1]+o[1])/2],r(d3.event.scale*g)}i(n,e),M=null,a(w.of(this,arguments))}var d,g,p,m,v,y,M,b=[0,0],x=1,_=Ga,w=j(t,\"zoom\");return t.translate=function(n){return arguments.length?(b=n.map(Number),u(),t):b},t.scale=function(n){return arguments.length?(x=+n,u(),t):x},t.scaleExtent=function(n){return arguments.length?(_=null==n?Ga:n.map(Number),t):_},t.x=function(n){return arguments.length?(m=n,p=n.copy(),b=[0,0],x=1,t):m},t.y=function(n){return arguments.length?(y=n,v=n.copy(),b=[0,0],x=1,t):y},d3.rebind(t,w,\"on\")};var Ja,Ga=[0,1/0];d3.layout={},d3.layout.bundle=function(){return function(t){for(var n=[],e=-1,r=t.length;r>++e;)n.push(Xe(t[e]));return n}},d3.layout.chord=function(){function t(){var t,l,f,h,d,g={},p=[],m=d3.range(u),v=[];for(e=[],r=[],t=0,h=-1;u>++h;){for(l=0,d=-1;u>++d;)l+=i[h][d];p.push(l),v.push(d3.range(u)),t+=l}for(a&&m.sort(function(t,n){return a(p[t],p[n])}),o&&v.forEach(function(t,n){t.sort(function(t,e){return o(i[n][t],i[n][e])", "})}),t=(2*Ru-s*u)/t,l=0,h=-1;u>++h;){for(f=l,d=-1;u>++d;){var y=m[h],M=v[y][d],b=i[y][M],x=l,_=l+=b*t;g[y+\"-\"+M]={index:y,subindex:M,startAngle:x,endAngle:_,value:b}}r[y]={index:y,startAngle:f,endAngle:l,value:(l-f)/t},l+=s}for(h=-1;u>++h;)for(d=h-1;u>++d;){var w=g[h+\"-\"+d],S=g[d+\"-\"+h];(w.value||S.value)&&e.push(w.value<S.value?{source:S,target:w}:{source:w,target:S})}c&&n()}function n(){e.sort(function(t,n){return c((t.source.value+t.target.value)/2,(n.source.value+n.target.value)/2)})}var e,r,i,u,a,o,c,l={},s=0;return l.matrix=function(t){return arguments.length?(u=(i=t)&&i.length,e=r=null,l):i},l.padding=function(t){return arguments.length?(s=t,e=r=null,l):s},l.sortGroups=function(t){return arguments.length?(a=t,e=r=null,l):a},l.sortSubgroups=function(t){return arguments.length?(o=t,e=null,l):o},l.sortChords=function(t){return arguments.length?(c=t,e&&n(),l):c},l.chords=function(){return e||t(),e},l.groups=function(){return r||t(),r},l},d3.layout.force=function(){function t(t){return function(n,e,r,i){if(n.point!==t){var u=n.cx-t.x,a=n.cy-t.y,o=1/Math.sqrt(u*u+a*a);if(v>(i-e)*o){var c=n.charge*o*o;return t.px-=u*c,t.py-=a*c,!0}if(n.point&&isFinite(o)){var c=n.pointCharge*o*o;t.px-=u*c,t.py-=a*c}}return!n.charge}}function n(t){t.px=d3.event.x,t.py=d3.event.y,l.resume()}var e,r,i,u,o,l={},s=d3.dispatch(\"start\",\"tick\",\"end\"),f=[1,1],h=.9,d=Qe,g=tr,p=-30,m=.1,v=.8,y=[],M=[];return l.tick=function(){if(.005>(r*=.99))return s.end({type:\"end\",alpha:r=0}),!0;var n,e,a,c,l,d,g,v,b,x=y.length,_=M.length;for(e=0;_>e;++e)a=M[e],c=a.source,l=a.target,v=l.x-c.x,b=l.y-c.y,(d=v*v+b*b)&&(d=r*u[e]*((d=Math.sqrt(d))-i[e])/d,v*=d,b*=d,l.x-=v*(g=c.weight/(l.weight+c.weight)),l.y-=b*g,c.x+=v*(g=1-g),c.y+=b*g);if((g=r*m)&&(v=f[0]/2,b=f[1]/2,e=-1,g))for(;x>++e;)a=y[e],a.x+=(v-a.x)*g,a.y+=(b-a.y)*g;if(p)for(We(n=d3.geom.quadtree(y),r,o),e=-1;x>++e;)(a=y[e]).fixed||n.visit(t(a));for(e=-1;x>++e;)a=y[e],a.fixed?(a.x=a.px,a.y=a.py):(a.x-=(a.px-(a.px=a.x))*h,a.y-=(a.py-(a.py=a.y))*h);s.tick({type:\"tick\",alpha:r})},l.nodes=function(t){return arguments.length?(y=t,l):y},l.links=function(t){return arguments.length?(M=t,l):M},l.size=function(t){return arguments.length?(f=t,l):f},l.linkDistance=function(t){return arguments.length?(d=c(t),l):d},l.distance=l.linkDistance,l.linkStrength=function(t){return arguments.length?(g=c(t),l):g},l.friction=function(t){return arguments.length?(h=t,l):h},l.charge=function(t){return arguments.length?(p=\"function\"==typeof t?t:+t,l):p},l.gravity=function(t){return arguments.length?(m=t,l):m},l.theta=function(t){return arguments.length?(v=t,l):v},l.alpha=function(t){return arguments.length?(r?r=t>0?t:0:t>0&&(s.start({type:\"start\",alpha:r=t}),d3.timer(l.tick)),l):r},l.start=function(){function t(t,r){for(var i,u=n(e),a=-1,o=u.length;o>++a;)if(!isNaN(i=u[a][t]))return i;return Math.random()*r}function n(){if(!a){for(a=[],r=0;s>r;++r)a[r]=[];for(r=0;h>r;++r){var t=M[r];a[t.source.index].push(t.target),a[t.target.index].push(t.source)}}return a[e]}var e,r,a,c,s=y.length,h=M.length,m=f[0],v=f[1];for(e=0;s>e;++e)(c=y[e]).index=e,c.weight=0;for(i=[],u=[],e=0;h>e;++e)c=M[e],\"number\"==typeof c.source&&(c.source=y[c.source]),\"number\"==typeof c.target&&(c.target=y[c.target]),i[e]=d.call(this,c,e),u[e]=g.call(this,c,e),++c.source.weight,++c.target.weight;for(e=0;s>e;++e)c=y[e],isNaN(c.x)&&(c.x=t(\"x\",m)),isNaN(c.y)&&(c.y=t(\"y\",v)),isNaN(c.px)&&(c.px=c.x),isNaN(c.py)&&(c.py=c.y);if(o=[],\"function\"==typeof p)for(e=0;s>e;++e)o[e]=+p.call(this,y[e],e);else for(e=0;s>e;++e)o[e]=p;return l.resume()},l.resume=function(){return l.alpha(.1)},l.stop=function(){return l.alpha(0)},l.drag=function(){e||(e=d3.behavior.drag().origin(a).on(\"dragstart\",$e).on(\"drag\",n).on(\"dragend\",Je)),this.on(\"mouseover.force\",Ge).on(\"mouseout.force\",Ke).call(e)},d3.rebind(l,s,\"on\")},d3.layout.partition=function(){function t(n,e,r,i){var u=n.children;if(n.x=e,n.y=n.depth*i,n.dx=r,n.dy=i,u&&(a=u.length)){var a,o,c,l=-1;for(r=n.value?r/n.value:0;a>++l;)t(o=u[l],e,c=o.value*r,i),e+=c}}function n(t){var e=t.children,r=0;if(e&&(i=e.length))for(var i,u=-1;i>++u;)r=Math.max(r,n(e[u]));return 1+r}function e(e,u){var a=r.call(this,e,u);return t(a[0],0,i[0],i[1]/n(a[0])),a}var r=d3.layout.hierarchy(),i=[1,1];return e.size=function(t){return arguments.length?(i=t,e):i},hr(e,r)},d3.layout.pie=function(){function t(u){var a=u.map(function(e,r){return+n.call(t,e,r)}),o=+(\"function\"==typeof r?r.apply(this,arguments):r),c=((\"function\"==typeof i?i.apply(this,arguments):i)-r)/d3.sum(a),l=d3.range(u.length);null!=e&&l.sort(e===Ka?function(t,n){return a[n]-a[t]}:function(t,n){return e(u[t],u[n])});var s=[];return l.forEach(function(t){var n;s[t]={data:u[t],value:n=a[t],startAngle:o,endAngle:o+=n*c}}),s}var n=Number,e=Ka,r=0,i=2*Ru;return t.value=function(e){return arguments.length?(n=e,t):n},t.sort=function(n){return arguments.length?(e=n,t):e},t.startAngle=function(n){return arguments.length?(r=n,t):r},t.endAngle=function(n){return arguments.length?(i=n,t):i},t};var Ka={};d3.layout.stack=function(){function t(a,c){var l=a.map(function(e,r){return n.call(t,e,r)}),s=l.map(function(n){return n.map(function(n,e){return[u.call(t,n,e),o.call(t,n,e)]})}),f=e.call(t,s,c);l=d3.permute(l,f),s=d3.permute(s,f);var h,d,g,p=r.call(t,s,c),m=l.length,v=l[0].length;for(d=0;v>d;++d)for(i.call(t,l[0][d],g=p[d],s[0][d][1]),h=1;m>h;++h)i.call(t,l[h][d],g+=s[h-1][d][1],s[h][d][1]);return a}var n=a,e=ir,r=ur,i=rr,u=nr,o=er;return t.values=function(e){return arguments.length?(n=e,t):n},t.order=function(n){return arguments.length?(e=\"function\"==typeof n?n:Wa.get(n)||ir,t):e},t.offset=function(n){return arguments.length?(r=\"function\"==typeof n?n:Qa.get(n)||ur,t):r},t.x=function(n){return arguments.length?(u=n,t):u},t.y=function(n){return arguments.length?(o=n,t):o},t.out=function(n){return arguments.length?(i=n,t):i},t};var Wa=d3.map({\"inside-out\":function(t){var n,e,r=t.length,i=t.map(ar),u=t.map(or),a=d3.range(r).sort(function(t,n){return i[t]-i[n]}),o=0,c=0,l=[],s=[];for(n=0;r>n;++n)e=a[n],c>o?(o+=u[e],l.push(e)):(c+=u[e],s.push(e));return s.reverse().concat(l)},reverse:function(t){return d3.range(t.length).reverse()},\"default\":ir}),Qa=d3.map({silhouette:function(t){var n,e,r,i=t.length,u=t[0].length,a=[],o=0,c=[];for(e=0;u>e;++e){for(n=0,r=0;i>n;n++)r+=t[n][e][1];r>o&&(o=r),a.push(r)}for(e=0;u>e;++e)c[e]=(o-a[e])/2;return c},wiggle:function(t){var n,e,r,i,u,a,o,c,l,s=t.length,f=t[0],h=f.length,d=[];for(d[0]=c=l=0,e=1;h>e;++e){for(n=0,i=0;s>n;++n)i+=t[n][e][1];for(n=0,u=0,o=f[e][0]-f[e-1][0];s>n;++n){for(r=0,a=(t[n][e][1]-t[n][e-1][1])/(2*o);n>r;++r)a+=(t[r][e][1]-t[r][e-1][1])/o;u+=a*t[n][e][1]}d[e]=c-=i?u/i*o:0,l>c&&(l=c)}for(e=0;h>e;++e)d[e]-=l;return d},expand:function(t){var n,e,r,i=t.length,u=t[0].length,a=1/i,o=[];for(e=0;u>e;++e){for(n=0,r=0;i>n;n++)r+=t[n][e][1];if(r)for(n=0;i>n;n++)t[n][e][1]/=r;else for(n=0;i>n;n++)t[n][e][1]=a}for(e=0;u>e;++e)o[e]=0;return o},zero:ur});d3.layout.histogram=function(){function t(t,u){for(var a,o,c=[],l=t.map(e,this),s=r.call(this,l,u),f=i.call(this,s,l,u),u=-1,h=l.length,d=f.length-1,g=n?1:1/h;d>++u;)a=c[u]=[],a.dx=f[u+1]-(a.x=f[u]),a.y=0;if(d>0)for(u=-1;h>++u;)o=l[u],o>=s[0]&&s[1]>=o&&(a=c[d3.bisect(f,o,1,d)-1],a.y+=g,a.push(t[u]));return c}var n=!0,e=Number,r=fr,i=lr;return t.value=function(n){return arguments.length?(e=n,t):e},t.range=function(n){return arguments.length?(r=c(n),t):r},t.bins=function(n){return arguments.length?(i=\"number\"==typeof n?function(t){return sr(t,n)}:c(n),t):i},t.frequency=function(e){return arguments.length?(n=!!e,t):n},t},d3.layout.hierarchy=function(){function t(n,a,o){var c=i.call(e,n,a);if(n.depth=a,o.push(n),c&&(l=c.length)){for(var l,s,f=-1,h=n.children=[],d=0,g=a+1;l>++f;)s=t(c[f],g,o),s.parent=n,h.push(s),d+=s.value;r&&h.sort(r),u&&(n.value=d)}else u&&(n.value=+u.call(e,n,a)||0);return n}function n(t,r){var i=t.children,a=0;if(i&&(o=i.length))for(var o,c=-1,l=r+1;o>++c;)a+=n(i[c],l);else u&&(a=+u.call(e,t,r)||0);return u&&(t.value=a),a}function e(n){var e=[];return t(n,0,e),e}var r=pr,i=dr,u=gr;return e.sort=function(t){return arguments.length?(r=t,e):r},e.children=function(t){return arguments.length?(i=t,e):i},e.value=function(t){return arguments.length?(u=t,e):u},e.revalue=function(t){return n(t,0),t},e},d3.layout.pack=function(){function t(t,i){var u=n.call(this,t,i),a=u[0];a.x=0,a.y=0,Rr(a,function(t){t.r=Math.sqrt(t.value)}),Rr(a,xr);var o=r[0],c=r[1],l=Math.max(2*a.r/o,2*a.r/c);if(e>0){var s=e*l/2;Rr(a,function(t){t.r+=s}),Rr(a,xr),Rr(a,function(t){t.r-=s}),l=Math.max(2*a.r/o,2*a.r/c)}return Sr(a,o/2,c/2,1/l),u}var n=d3.layout.hierarchy().sort(vr),e=0,r=[1,1];return t.size=function(n){return arguments.length?(r=n,t):r},t.padding=function(n){return arguments.length?(e=+n,t):e},hr(t,n)},d3.layout.cluster=function(){function t(t,i){var u,a=n.call(this,t,i),o=a[0],c=0;Rr(o,function(t){var n=t.children;n&&n.length?(t.x=Ar(n),t.y=Er(n)):(t.x=u?c+=e(t,u):0,t.y=0,u=t)});var l=Nr(o),s=Tr(o),f=l.x-e(l,s)/2,h=s.x+e(s,l)/2;return Rr(o,function(t){t.x=(t.x-f)/(h-f)*r[0],t.y=(1-(o.y?t.y/o.y:1))*r[1]}),a}var n=d3.layout.hierarchy().sort(null).value(null),e=qr,r=[1,1];return t.separation=function(n){return arguments.length?(e=n,t):e},t.size=function(n){return arguments.length?(r=n,t):r},hr(t,n)},d3.layout.tree=function(){function t(t,i){function u(t,n){var r=t.children,i=t._tree;if(r&&(a=r.length)){for(var a,c,l,s=r[0],f=s,h=-1;a>++h;)l=r[h],u(l,c),f=o(l,c,f),c=l;Pr(t);var d=.5*(s._tree.prelim+l._tree.prelim);n?(i.prelim=n._tree.prelim+e(t,n),i.mod=i.prelim-d):i.prelim=d}else n&&(i.prelim=n._tree.prelim+e(t,n))}function a(t,n){t.x=t._tree.prelim+n;var e=t.children;if(e&&(r=e.length)){var r,i=-1;for(n+=t._tree.mod;r>++i;)a(e[i],n)}}function o(t,n,r){if(n){for(var i,u=t,a=t,o=n,c=t.parent.children[0],l=u._tree.mod,s=a._tree.mod,f=o._tree.mod,h=c._tree.mod;o=zr(o),u=Cr(u),o&&u;)c=Cr(c),a=zr(a),a._tree.ancestor=t,i=o._tree.prelim+f-u._tree.prelim-l+e(o,u),i>0&&(jr(Or(o,t,r),t,i),l+=i,s+=i),f+=o._tree.mod,l+=u._tree.mod,h+=c._tree.mod,s+=a._tree.mod;o&&!zr(a)&&(a._tree.thread=o,a._tree.mod+=f-s),u&&!Cr(c)&&(c._tree.thread=u,c._tree.mod+=l-h,r=t)}return r}var c=n.call(this,t,i),l=c[0];Rr(l,function(t,n){t._tree={ancestor:t,prelim:0,mod:0,change:0,shift:0,number:n?n._tree.number+1:0}}),u(l),a(l,-l._tree.prelim);var s=Dr(l,Fr),f=Dr(l,Lr),h=Dr(l,Hr),d=s.x-e(s,f)/2,g=f.x+e(f,s)/2,p=h.depth||1;return Rr(l,function(t){t.x=(t.x-d)/(g-d)*r[0],t.y=t.depth/p*r[1],delete t._tree}),c}var n=d3.layout.hierarchy().sort(null).value(null),e=qr,r=[1,1];return t.separation=function(n){return arguments.length?(e=n,t):e},t.size=function(n){return arguments.length?(r=n,t):r},hr(t,n)},d3.layout.treemap=function(){function t(t,n){for(var e,r,i=-1,u=t.length;u>++i;)r=(e=t[i]).value*(0>n?0:n),e.area=isNaN(r)||0>=r?0:r}function n(e){var u=e.children;if(u&&u.length){var a,o,c,l=f(e),s=[],h=u.slice(),g=1/0,p=\"slice\"===d?l.dx:\"dice\"===d?l.dy:\"slice-dice\"===d?1&e.depth?l.dy:l.dx:Math.min(l.dx,l.dy);for(t(h,l.dx*l.dy/e.value),s.area=0;(c=h.length)>0;)s.push(a=h[c-1]),s.area+=a.area,\"squarify\"!==d||g>=(o=r(s,p))?(h.pop(),g=o):(s.area-=s.pop().area,i(s,p,l,!1),p=Math.min(l.dx,l.dy),s.length=s.area=0,g=1/0);s.length&&(i(s,p,l,!0),s.length=s.area=0),u.forEach(n)}}function e(n){var r=n.children;if(r&&r.length){var u,a=f(n),o=r.slice(),c=[];for(t(o,a.dx*a.dy/n.value),c.area=0;u=o.pop();)c.push(u),c.area+=u.area,null!=u.z&&(i(c,u.z?a.dx:a.dy,a,!o.length),c.length=c.area=0);r.forEach(e)}}function r(t,n){for(var e,r=t.area,i=0,u=1/0,a=-1,o=t.length;o>++a;)(e=t[a].area)&&(u>e&&(u=e),e>i&&(i=e));return r*=r,n*=n,r?Math.max(n*i*g/r,r/(n*u*g)):1/0}function i(t,n,e,r){var i,u=-1,a=t.length,o=e.x,l=e.y,s=n?c(t.area/n):0;if(n==e.dx){for((r||s>e.dy)&&(s=e.dy);a>++u;)i=t[u],i.x=o,i.y=l,i.dy=s,o+=i.dx=Math.min(e.x+e.dx-o,s?c(i.area/s):0);i.z=!0,i.dx+=e.x+e.dx-o,e.y+=s,e.dy-=s}else{for((r||s>e.dx)&&(s=e.dx);a>++u;)i=t[u],i.x=o,i.y=l,i.dx=s,l+=i.dy=Math.min(e.y+e.dy-l,s?c(i.area/s):0);i.z=!1,i.dy+=e.y+e.dy-l,e.x+=s,e.dx-=s}}function u(r){var i=a||o(r),u=i[0];return u.x=0,u.y=0,u.dx=l[0],u.dy=l[1],a&&o.revalue(u),t([u],u.dx*u.dy/u.value),(a?e:n)(u),h&&(a=i),i}var a,o=d3.layout.hierarchy(),c=Math.round,l=[1,1],s=null,f=Yr,h=!1,d=\"squarify\",g=.5*(1+Math.sqrt(5));return u.size=function(t){return arguments.length?(l=t,u):l},u.padding=function(t){function n(n){var e=t.call(u,n,n.depth);return null==e?Yr(n):Ur(n,\"number\"==typeof e?[e,e,e,e]:e)}function e(n){return Ur(n,t)}if(!arguments.length)return s;var r;return f=null==(s=t)?Yr:\"function\"==(r=typeof t)?n:\"number\"===r?(t=[t,t,t,t],e):e,u},u.round=function(t){return arguments.length?(c=t?Math.round:Number,u):c!=Number},u.sticky=function(t){return arguments.length?(h=t,a=null,u):h},u.ratio=function(t){return arguments.length?(g=t,u):g},u.mode=function(t){return arguments.length?(d=t+\"\",u):d},hr(u,o)},d3.csv=Ir(\",\",\"text/csv\"),d3.tsv=Ir(\"\t\",\"text/tab-separated-values\"),d3.geo={},d3.geo.stream=function(t,n){to.hasOwnProperty(t.type)?to[t.type](t,n):Vr(t,n)};var to={Feature:function(t,n){Vr(t.geometry,n)},FeatureCollection:function(t,n){for(var e=t.features,r=-1,i=e.length;i>++r;)Vr(e[r].geometry,n)}},no={Sphere:function(t,n){n.sphere()},Point:function(t,n){var e=t.coordinates;n.point(e[0],e[1])},MultiPoint:function(t,n){for(var e,r=t.coordinates,i=-1,u=r.length;u>++i;)e=r[i],n.point(e[0],e[1])},LineString:function(t,n){Xr(t.coordinates,n,0)},MultiLineString:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;i>++r;)Xr(e[r],n,0)},Polygon:function(t,n){Zr(t.coordinates,n)},MultiPolygon:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;i>++r;)Zr(e[r],n)},GeometryCollection:function(t,n){for(var e=t.geometries,r=-1,i=e.length;i>++r;)Vr(e[r],n)}};d3.geo.albersUsa=function(){function t(t){return n(t)(t)}function n(t){var n=t[0],a=t[1];return a>50?r:-140>n?i:21>a?u:e}var e=d3.geo.albers(),r=d3.geo.albers().rotate([160,0]).center([0,60]).parallels([55,65]),i=d3.geo.albers().rotate([160,0]).center([0,20]).parallels([8,18]),u=d3.geo.albers().rotate([60,0]).center([0,10]).parallels([8,18]);return t.scale=function(n){return arguments.length?(e.scale(n),r.scale(.6*n),i.scale(n),u.scale(1.5*n),t.translate(e.translate())):e.scale()},t.translate=function(n){if(!arguments.length)return e.translate();var a=e.scale(),o=n[0],c=n[1];return e.translate(n),r.translate([o-.4*a,c+.17*a]),i.translate([o-.19*a,c+.2*a]),u.translate([o+.58*a,c+.43*a]),t},t.scale(e.scale())},(d3.geo.albers=function(){var t=29.5*ju,n=45.5*ju,e=Pi(ei),r=e(t,n);return r.parallels=function(r){return arguments.length?e(t=r[0]*ju,n=r[1]*ju):[t*Ou,n*Ou]},r.rotate([98,0]).center([0,38]).scale(1e3)}).raw=ei;var eo=Vi(function(t){return Math.sqrt(2/(1+t))},function(t){return 2*Math.asin(t/2)});(d3.geo.azimuthalEqualArea=function(){return Ri(eo)}).raw=eo;var ro=Vi(function(t){var n=Math.acos(t);return n&&n/Math.sin(n)},a);(d3.geo.azimuthalEquidistant=function(){return Ri(ro)}).raw=ro,d3.geo.bounds=ri(a),d3.geo.centroid=function(t){io=uo=ao=oo=co=0,d3.geo.stream(t,lo);var n;return uo&&Math.abs(n=Math.sqrt(ao*ao+oo*oo+co*co))>Pu?[Math.atan2(oo,ao)*Ou,Math.asin(Math.max(-1,Math.min(1,co/n)))*Ou]:void 0};var io,uo,ao,oo,co,lo={sphere:function(){2>io&&(io=2,uo=ao=oo=co=0)},point:ii,lineStart:ai,lineEnd:oi,polygonStart:function(){2>io&&(io=2,uo=ao=oo=co=0),lo.lineStart=ui},polygonEnd:function(){lo.lineStart=ai}};d3.geo.circle=function(){function t(){var t=\"function\"==typeof r?r.apply(this,arguments):r,n=Oi(-t[0]*ju,-t[1]*ju,0).invert,i=[];return e(null,null,1,{point:function(t,e){i.push(t=n(t,e)),t[0]*=Ou,t[1]*=Ou}}),{type:\"Polygon\",coordinates:[i]}}var n,e,r=[0,0],i=6;return t.origin=function(n){return arguments.length?(r=n,t):r},t.angle=function(r){return arguments.length?(e=ci((n=+r)*ju,i*ju),t):n},t.precision=function(r){return arguments.length?(e=ci(n*ju,(i=+r)*ju),t):i},t.angle(90)};var so=si(o,vi,Mi);(d3.geo.equirectangular=function(){return Ri(_i).scale(250/Ru)}).raw=_i.invert=_i;var fo=Vi(function(t){return 1/t},Math.atan);(d3.geo.gnomonic=function(){return Ri(fo)}).raw=fo,d3.geo.graticule=function(){function t(){return{type:\"MultiLineString\",coordinates:n()}}function n(){return d3.range(Math.ceil(r/c)*c,e,c).map(a).concat(d3.range(Math.ceil(u/l)*l,i,l).map(o))}var e,r,i,u,a,o,c=22.5,l=c,s=2.5;return t.lines=function(){return n().map(function(t){return{type:\"LineString\",coordinates:t}})},t.outline=function(){return{type:\"Polygon\",coordinates:[a(r).concat(o(i).slice(1),a(e).reverse().slice(1),o(u).reverse().slice(1))]}},t.extent=function(n){return arguments.length?(r=+n[0][0],e=+n[1][0],u=+n[0][1],i=+n[1][1],r>e&&(n=r,r=e,e=n),u>i&&(n=u,u=i,i=n),t.precision(s)):[[r,u],[e,i]]},t.step=function(n){return arguments.length?(c=+n[0],l=+n[1],t):[c,l]},t.precision=function(n){return arguments.length?(s=+n,a=wi(u,i,s),o=Si(r,e,s),t):s},t.extent([[-180+Pu,-90+Pu],[180-Pu,90-Pu]])},d3.geo.interpolate=function(t,n){return ki(t[0]*ju,t[1]*ju,n[0]*ju,n[1]*ju)},d3.geo.greatArc=function(){function e(){for(var t=r||a.apply(this,arguments),n=i||o.apply(this,arguments),e=u||d3.geo.interpolate(t,n),l=0,s=c/e.distance,f=[t];1>(l+=s);)f.push(e(l));return f.push(n),{type:\"LineString\",coordinates:f}}var r,i,u,a=n,o=t,c=6*ju;return e.distance=function(){return(u||d3.geo.interpolate(r||a.apply(this,arguments),i||o.apply(this,arguments))).distance},e.source=function(t){return arguments.length?(a=t,r=\"function\"==typeof t?null:t,u=r&&i?d3.geo.interpolate(r,i):null,e):a},e.target=function(t){return arguments.length?(o=t,i=\"function\"==typeof t?null:t,u=r&&i?d3.geo.interpolate(r,i):null,e):o},e.precision=function(t){return arguments.length?(c=t*ju,e):c/ju},e},Ei.invert=function(t,n){return[2*Ru*t,2*Math.atan(Math.exp(2*Ru*n))-Ru/2]},(d3.geo.mercator=function(){return Ri(Ei).scale(500)}).raw=Ei;var ho=Vi(function(){return 1},Math.asin);(d3.geo.orthographic=function(){return Ri(ho)}).raw=ho,d3.geo.path=function(){function t(t){return t&&d3.geo.stream(t,r(i.pointRadius(\"function\"==typeof u?+u.apply(this,arguments):u))),i.result()}var n,e,r,i,u=4.5;return t.area=function(t){return go=0,d3.geo.stream(t,r(mo)),go},t.centroid=function(t){return io=ao=oo=co=0,d3.geo.stream(t,r(vo)),co?[ao/co,oo/co]:void 0},t.bounds=function(t){return ri(r)(t)},t.projection=function(e){return arguments.length?(r=(n=e)?e.stream||Ni(e):a,t):n},t.context=function(n){return arguments.length?(i=null==(e=n)?new Ti:new qi(n),t):e},t.pointRadius=function(n){return arguments.length?(u=\"function\"==typeof n?n:+n,t):u},t.projection(d3.geo.albersUsa()).context(null)};var go,po,mo={point:Pn,lineStart:Pn,lineEnd:Pn,polygonStart:function(){po=0,mo.lineStart=Ci},polygonEnd:function(){mo.lineStart=mo.lineEnd=mo.point=Pn,go+=Math.abs(po/2)}},vo={point:zi,lineStart:Di,lineEnd:Li,polygonStart:function(){vo.lineStart=Fi},polygonEnd:function(){vo.point=zi,vo.lineStart=Di,vo.lineEnd=Li}};d3.geo.area=function(t){return yo=0,d3.geo.stream(t,bo),yo};var yo,Mo,bo={sphere:function(){yo+=4*Ru},point:Pn,lineStart:Pn,lineEnd:Pn,polygonStart:function(){Mo=0,bo.lineStart=Hi},polygonEnd:function(){yo+=0>Mo?4*Ru+Mo:Mo,bo.lineStart=bo.lineEnd=bo.point=Pn}};d3.geo.projection=Ri,d3.geo.projectionMutator=Pi;var xo=Vi(function(t){return 1/(1+t)},function(t){return 2*Math.atan(t)});(d3.geo.stereographic=function(){return Ri(xo)}).raw=xo,d3.geom={},d3.geom.hull=function(t){if(3>t.length)return[];var n,e,r,i,u,a,o,c,l,s,f=t.length,h=f-1,d=[],g=[],p=0;for(n=1;f>n;++n)t[n][1]<t[p][1]?p=n:t[n][1]==t[p][1]&&(p=t[n][0]<t[p][0]?n:p);for(n=0;f>n;++n)n!==p&&(i=t[n][1]-t[p][1],r=t[n][0]-t[p][0],d.push({angle:Math.atan2(i,r),index:n}));for(d.sort(function(t,n){return t.angle-n.angle}),l=d[0].angle,c=d[0].index,o=0,n=1;h>n;++n)e=d[n].index,l==d[n].angle?(r=t[c][0]-t[p][0],i=t[c][1]-t[p][1],u=t[e][0]-t[p][0],a=t[e][1]-t[p][1],r*r+i*i>=u*u+a*a?d[n].index=-1:(d[o].index=-1,l=d[n].angle,o=n,c=e)):(l=d[n].angle,o=n,c=e);for(g.push(p),n=0,e=0;2>n;++e)-1!==d[e].index&&(g.push(d[e].index),n++);for(s=g.length;h>e;++e)if(-1!==d[e].index){for(;!Xi(g[s-2],g[s-1],d[e].index,t);)--s;g[s++]=d[e].index}var m=[];for(n=0;s>n;++n)m.push(t[g[n]]);return m},d3.geom.polygon=function(t){return t.area=function(){for(var n=0,e=t.length,r=t[e-1][1]*t[0][0]-t[e-1][0]*t[0][1];e>++n;)r+=t[n-1][1]*t[n][0]-t[n-1][0]*t[n][1];return.5*r},t.centroid=function(n){var e,r,i=-1,u=t.length,a=0,o=0,c=t[u-1];for(arguments.length||(n=-1/(6*t.area()));u>++i;)e=c,c=t[i],r=e[0]*c[1]-c[0]*e[1],a+=(e[0]+c[0])*r,o+=(e[1]+c[1])*r;return[a*n,o*n]},t.clip=function(n){for(var e,r,i,u,a,o,c=-1,l=t.length,s=t[l-1];l>++c;){for(e=n.slice(),n.length=0,u=t[c],a=e[(i=e.length)-1],r=-1;i>++r;)o=e[r],Zi(o,s,u)?(Zi(a,s,u)||n.push(Bi(a,o,s,u)),n.push(o)):Zi(a,s,u)&&n.push(Bi(a,o,s,u)),a=o;s=u}return n},t},d3.geom.voronoi=function(t){var n=t.map(function(){return[]}),e=1e6;return $i(t,function(t){var r,i,u,a,o,c;1===t.a&&t.b>=0?(r=t.ep.r,i=t.ep.l):(r=t.ep.l,i=t.ep.r),1===t.a?(o=r?r.y:-e,u=t.c-t.b*o,c=i?i.y:e,a=t.c-t.b*c):(u=r?r.x:-e,o=t.c-t.a*u,a=i?i.x:e,c=t.c-t.a*a);var l=[u,o],s=[a,c];n[t.region.l.index].push(l,s),n[t.region.r.index].push(l,s)}),n=n.map(function(n,e){var r=t[e][0],i=t[e][1],u=n.map(function(t){return Math.atan2(t[0]-r,t[1]-i)});return d3.range(n.length).sort(function(t,n){return u[t]-u[n]}).filter(function(t,n,e){return!n||u[t]-u[e[n-1]]>Pu}).map(function(t){return n[t]})}),n.forEach(function(n,r){var i=n.length;if(!i)return n.push([-e,-e],[-e,e],[e,e],[e,-e]);if(!(i>2)){var u=t[r],a=n[0],o=n[1],c=u[0],l=u[1],s=a[0],f=a[1],h=o[0],d=o[1],g=Math.abs(h-s),p=d-f;if(Pu>Math.abs(p)){var m=f>l?-e:e;n.push([-e,m],[e,m])}else if(Pu>g){var v=s>c?-e:e;n.push([v,-e],[v,e])}else{var m=(s-c)*(d-f)>(h-s)*(f-l)?e:-e,y=Math.abs(p)-g;Pu>Math.abs(y)?n.push([0>p?m:-m,m]):(y>0&&(m*=-1),n.push([-e,m],[e,m]))}}}),n};var _o={l:\"r\",r:\"l\"};d3.geom.delaunay=function(t){var n=t.map(function(){return[]}),e=[];return $i(t,function(e){n[e.region.l.index].push(t[e.region.r.index])}),n.forEach(function(n,r){var i=t[r],u=i[0],a=i[1];n.forEach(function(t){t.angle=Math.atan2(t[0]-u,t[1]-a)}),n.sort(function(t,n){return t.angle-n.angle});for(var o=0,c=n.length-1;c>o;o++)e.push([i,n[o],n[o+1]])}),e},d3.geom.quadtree=function(t,n,e,r,i){function u(t,n,e,r,i,u){if(!isNaN(n.x)&&!isNaN(n.y))if(t.leaf){var o=t.point;o?.01>Math.abs(o.x-n.x)+Math.abs(o.y-n.y)?a(t,n,e,r,i,u):(t.point=null,a(t,o,e,r,i,u),a(t,n,e,r,i,u)):t.point=n}else a(t,n,e,r,i,u)}function a(t,n,e,r,i,a){var o=.5*(e+i),c=.5*(r+a),l=n.x>=o,s=n.y>=c,f=(s<<1)+l;t.leaf=!1,t=t.nodes[f]||(t.nodes[f]=Ji()),l?e=o:i=o,s?r=c:a=c,u(t,n,e,r,i,a)}var o,c=-1,l=t.length;if(5>arguments.length)if(3===arguments.length)i=e,r=n,e=n=0;else for(n=e=1/0,r=i=-1/0;l>++c;)o=t[c],n>o.x&&(n=o.x),e>o.y&&(e=o.y),o.x>r&&(r=o.x),o.y>i&&(i=o.y);var s=r-n,f=i-e;s>f?i=e+s:r=n+f;var h=Ji();return h.add=function(t){u(h,t,n,e,r,i)},h.visit=function(t){Gi(t,h,n,e,r,i)},t.forEach(h.add),h},d3.time={};var wo=Date,So=[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"];Ki.prototype={getDate:function(){return this._.getUTCDate()},getDay:function(){return this._.getUTCDay()},getFullYear:function(){return this._.getUTCFullYear()},getHours:function(){return this._.getUTCHours()},getMilliseconds:function(){return this._.getUTCMilliseconds()},getMinutes:function(){return this._.getUTCMinutes()},getMonth:function(){return this._.getUTCMonth()},getSeconds:function(){return this._.getUTCSeconds()},getTime:function(){return this._.getTime()},getTimezoneOffset:function(){return 0},valueOf:function(){return this._.valueOf()},setDate:function(){ko.setUTCDate.apply(this._,arguments)},setDay:function(){ko.setUTCDay.apply(this._,arguments)},setFullYear:function(){ko.setUTCFullYear.apply(this._,arguments)},setHours:function(){ko.setUTCHours.apply(this._,arguments)},setMilliseconds:function(){ko.setUTCMilliseconds.apply(this._,arguments)},setMinutes:function(){ko.setUTCMinutes.apply(this._,arguments)},setMonth:function(){ko.setUTCMonth.apply(this._,arguments)},setSeconds:function(){ko.setUTCSeconds.apply(this._,arguments)},setTime:function(){ko.setTime.apply(this._,arguments)}};var ko=Date.prototype,Eo=\"%a %b %e %X %Y\",Ao=\"%m/%d/%Y\",No=\"%H:%M:%S\",To=[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"],qo=[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],Co=[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],zo=[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"];d3.time.format=function(t){function n(n){for(var r,i,u,a=[],o=-1,c=0;e>++o;)37===t.charCodeAt(o)&&(a.push(t.substring(c,o)),null!=(i=jo[r=t.charAt(++o)])&&(r=t.charAt(++o)),(u=Oo[r])&&(r=u(n,null==i?\"e\"===r?\" \":\"0\":i)),a.push(r),c=o+1);return a.push(t.substring(c,o)),a.join(\"\")}var e=t.length;return n.parse=function(n){var e={y:1900,m:0,d:1,H:0,M:0,S:0,L:0},r=Wi(e,t,n,0);if(r!=n.length)return null;\"p\"in e&&(e.H=e.H%12+12*e.p);var i=new wo;return i.setFullYear(e.y,e.m,e.d),i.setHours(e.H,e.M,e.S,e.L),i},n.toString=function(){return t},n};var Do=Qi(To),Lo=Qi(qo),Fo=Qi(Co),Ho=tu(Co),Ro=Qi(zo),Po=tu(zo),jo={\"-\":\"\",_:\" \",0:\"0\"},Oo={a:function(t){return qo[t.getDay()]},A:function(t){return To[t.getDay()]},b:function(t){return zo[t.getMonth()]},B:function(t){return Co[t.getMonth()]},c:d3.time.format(Eo),d:function(t,n){return nu(t.getDate(),n,2)},e:function(t,n){return nu(t.getDate(),n,2)},H:function(t,n){return nu(t.getHours(),n,2)},I:function(t,n){return nu(t.getHours()%12||12,n,2)},j:function(t,n){return nu(1+d3.time.dayOfYear(t),n,3)},L:function(t,n){return nu(t.getMilliseconds(),n,3)},m:function(t,n){return nu(t.getMonth()+1,n,2)},M:function(t,n){return nu(t.getMinutes(),n,2)},p:function(t){return t.getHours()>=12?\"PM\":\"AM\"},S:function(t,n){return nu(t.getSeconds(),n,2)},U:function(t,n){return nu(d3.time.sundayOfYear(t),n,2)},w:function(t){return t.getDay()},W:function(t,n){return nu(d3.time.mondayOfYear(t),n,2)},x:d3.time.format(Ao),X:d3.time.format(No),y:function(t,n){return nu(t.getFullYear()%100,n,2)},Y:function(t,n){return nu(t.getFullYear()%1e4,n,4)},Z:Mu,\"%\":function(){return\"%\"}},Yo={a:eu,A:ru,b:iu,B:uu,c:au,d:du,e:du,H:gu,I:gu,L:vu,m:hu,M:pu,p:yu,S:mu,x:ou,X:cu,y:su,Y:lu},Uo=/^\\s*\\d+/,Io=d3.map({am:0,pm:1});d3.time.format.utc=function(t){function n(t){try{wo=Ki;var n=new wo;return n._=t,e(n)}finally{wo=Date}}var e=d3.time.format(t);return n.parse=function(t){try{wo=Ki;var n=e.parse(t);return n&&n._}finally{wo=Date}},n.toString=e.toString,n};var Vo=d3.time.format.utc(\"%Y-%m-%dT%H:%M:%S.%LZ\");d3.time.format.iso=Date.prototype.toISOString?bu:Vo,bu.parse=function(t){var n=new Date(t);return isNaN(n)?null:n},bu.toString=Vo.toString,d3.time.second=xu(function(t){return new wo(1e3*Math.floor(t/1e3))},function(t,n){t.setTime(t.getTime()+1e3*Math.floor(n))},function(t){return t.getSeconds()}),d3.time.seconds=d3.time.second.range,d3.time.seconds.utc=d3.time.second.utc.range,d3.time.minute=xu(function(t){return new wo(6e4*Math.floor(t/6e4))},function(t,n){t.setTime(t.getTime()+6e4*Math.floor(n))},function(t){return t.getMinutes()}),d3.time.minutes=d3.time.minute.range,d3.time.minutes.utc=d3.time.minute.utc.range,d3.time.hour=xu(function(t){var n=t.getTimezoneOffset()/60;return new wo(36e5*(Math.floor(t/36e5-n)+n))},function(t,n){t.setTime(t.getTime()+36e5*Math.floor(n))},function(t){return t.getHours()}),d3.time.hours=d3.time.hour.range,d3.time.hours.utc=d3.time.hour.utc.range,d3.time.day=xu(function(t){var n=new wo(1970,0);return n.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()),n},function(t,n){t.setDate(t.getDate()+n)},function(t){return t.getDate()-1}),d3.time.days=d3.time.day.range,d3.time.days.utc=d3.time.day.utc.range,d3.time.dayOfYear=function(t){var n=d3.time.year(t);return Math.floor((t-n-6e4*(t.getTimezoneOffset()-n.getTimezoneOffset()))/864e5)},So.forEach(function(t,n){t=t.toLowerCase(),n=7-n;var e=d3.time[t]=xu(function(t){return(t=d3.time.day(t)).setDate(t.getDate()-(t.getDay()+n)%7),t},function(t,n){t.setDate(t.getDate()+7*Math.floor(n))},function(t){var e=d3.time.year(t).getDay();return Math.floor((d3.time.dayOfYear(t)+(e+n)%7)/7)-(e!==n)});d3.time[t+\"s\"]=e.range,d3.time[t+\"s\"].utc=e.utc.range,d3.time[t+\"OfYear\"]=function(t){var e=d3.time.year(t).getDay();return Math.floor((d3.time.dayOfYear(t)+(e+n)%7)/7)}}),d3.time.week=d3.time.sunday,d3.time.weeks=d3.time.sunday.range,d3.time.weeks.utc=d3.time.sunday.utc.range,d3.time.weekOfYear=d3.time.sundayOfYear,d3.time.month=xu(function(t){return t=d3.time.day(t),t.setDate(1),t},function(t,n){t.setMonth(t.getMonth()+n)},function(t){return t.getMonth()}),d3.time.months=d3.time.month.range,d3.time.months.utc=d3.time.month.utc.range,d3.time.year=xu(function(t){return t=d3.time.day(t),t.setMonth(0,1),t},function(t,n){t.setFullYear(t.getFullYear()+n)},function(t){return t.getFullYear()}),d3.time.years=d3.time.year.range,d3.time.years.utc=d3.time.year.utc.range;var Xo=[1e3,5e3,15e3,3e4,6e4,3e5,9e5,18e5,36e5,108e5,216e5,432e5,864e5,1728e5,6048e5,2592e6,7776e6,31536e6],Zo=[[d3.time.second,1],[d3.time.second,5],[d3.time.second,15],[d3.time.second,30],[d3.time.minute,1],[d3.time.minute,5],[d3.time.minute,15],[d3.time.minute,30],[d3.time.hour,1],[d3.time.hour,3],[d3.time.hour,6],[d3.time.hour,12],[d3.time.day,1],[d3.time.day,2],[d3.time.week,1],[d3.time.month,1],[d3.time.month,3],[d3.time.year,1]],Bo=[[d3.time.format(\"%Y\"),o],[d3.time.format(\"%B\"),function(t){return t.getMonth()}],[d3.time.format(\"%b %d\"),function(t){return 1!=t.getDate()}],[d3.time.format(\"%a %d\"),function(t){return t.getDay()&&1!=t.getDate()}],[d3.time.format(\"%I %p\"),function(t){return t.getHours()}],[d3.time.format(\"%I:%M\"),function(t){return t.getMinutes()}],[d3.time.format(\":%S\"),function(t){return t.getSeconds()}],[d3.time.format(\".%L\"),function(t){return t.getMilliseconds()}]],$o=d3.scale.linear(),Jo=Eu(Bo);Zo.year=function(t,n){return $o.domain(t.map(Nu)).ticks(n).map(Au)},d3.time.scale=function(){return wu(d3.scale.linear(),Zo,Jo)};var Go=Zo.map(function(t){return[t[0].utc,t[1]]}),Ko=[[d3.time.format.utc(\"%Y\"),o],[d3.time.format.utc(\"%B\"),function(t){return t.getUTCMonth()}],[d3.time.format.utc(\"%b %d\"),function(t){return 1!=t.getUTCDate()}],[d3.time.format.utc(\"%a %d\"),function(t){return t.getUTCDay()&&1!=t.getUTCDate()}],[d3.time.format.utc(\"%I %p\"),function(t){return t.getUTCHours()}],[d3.time.format.utc(\"%I:%M\"),function(t){return t.getUTCMinutes()}],[d3.time.format.utc(\":%S\"),function(t){return t.getUTCSeconds()}],[d3.time.format.utc(\".%L\"),function(t){return t.getUTCMilliseconds()}]],Wo=Eu(Ko);Go.year=function(t,n){return $o.domain(t.map(qu)).ticks(n).map(Tu)},d3.time.scale.utc=function(){return wu(d3.scale.linear(),Go,Wo)}})();"]}, {"lines": ["<div class=\"page-header\">", "    <h1>About Open Science Framework</h1>", "</div>", "<p>"]}, {"lines": ["</p>", "<p>", "Some tools and infrastructure projects:", "<ul>", "    <li>Open Science Framework: Document, archive, share, and find study materials in a web-based project management system for scientists [Coordinators: <a href=\"http://people.virginia.edu/~js6ew\">Jeffrey Spies</a> and <a href=\"http://briannosek.com\">Brian Nosek</a>]", "        <li>Replication Value: Developing a statistic to identify published effects that are important to replicate. [Coordinator: Daniel Lakens]", "</ul>", "</p>", "<p>", "Some research projects", "<ul>", "<li><a href=\"/reproducibility\">Reproducibility Project</a>: A large-scale collaboration to estimate the reproducibility of published psychological science. [Coordinator: <a href=\"http://briannosek.com\">Brian Nosek</a>]", "<li>Opinions about Disclosure Standards: A survey assessing psychological scientists opinions about disclosure standards recommended by Simmons, Nelson, and Simonsohn (2011). [Coordinators: Heather Fuchs and Susann Fiedler]", "</ul>", "</p>", "<p>", "Read more about current projects, <a href=\"/howosfworks\">how the OSF works</a>, or join the <a href=\"http://groups.google.com/group/openscienceframework/\">OSF discussion group</a>.", "</p>", "", "<h3>The promise of open science collaboration</h3>", "<p>"]}, {"lines": ["(who may not even know what training to get)."]}, {"lines": ["</p>", "<h3>How open science collaboration can work</h3>", "<p>"]}, {"lines": ["See <a href=\"/howosfworks\">how the OSF works</a> for more detail.", "</p>", "<h3>OSF Features</h3>", "<p>"]}, {"lines": ["</p>", "", "<dl>", "<dt>Document and archive studies</dt>", "<dd>Move the organization and management of study materials from the desktop into the cloud.  Labs can organize, share, and archive study materials among team members.  Web-based project management reduces the likelihood of losing study materials due to computer malfunction, changing personnel, or just forgetting where you put the damn thing.</dd>", "", "<dt>Share and find materials</dt>", "<dd>With a click, make study materials public so that other researchers can find, use and cite them.  Find materials by other researchers to avoid reinventing something that already exists.</dd>", "", "", "<dt>Detail individual contribution</dt>", "<dd>Assign citable, contributor credit to any research material - tools, analysis scripts, methods, measures, data.</dd>", "", "<dt>Increase transparency</dt>", "<dd>Make as much of the scientific workflow public as desired - as it is developed or after publication of reports.</dd>", "", "<dt>Time-stamp materials</dt>", "<dd>When a strong a priori hypothesis exists, registering materials certifies what was done in advance of data collection or analysis.  When many labs are working on similar questions, registration affirms the date and time of designs, data collections, and discoveries.</dd>", "</dl>", "<p>"]}, {"lines": ["</p>", "<p>", "Interested in being a developer?  Contact <a href=\"mailto:jspies@virginia.edu.edu\">Jeff Spies</a> about development plans and open-sourcing of the project.", "</p>", "<p>", "Have ideas to make the OSF useful to you?  <a href=\"mailto:feedback@openscienceframework.org\">Submit them here</a>."]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": [""]}, {"lines": ["", "<h3>What is coming to the OSF?</h3>"]}, {"lines": [""]}, {"lines": ["<div class=\"page-header\">", "    <h1>How the Open Science Framework works</h1>", "</div>", "", "<h3>What is the Open Science Framework?</h3>"]}, {"lines": ["    depending on the interests and engagement by members of the OSF.</p>", ""]}, {"lines": ["    manage the development of collaborative projects in an open model.</p>", "", "<h3>How do projects develop in the Open Science Framework?</h3>", ""]}, {"lines": ["    infrastructure, research article).  There are some qualifications and elaborations:</p>", "", "<ol>", "    <li>Project coordinators are necessary and functional for project development and management.  Most of the time, the coordinator(s) will emerge naturally.  For example, it would be common for the originator of the project idea to become the coordinator.  If a project lead does not emerge, it is likely that the project will die (perhaps for the best).</li>", "    <li>A project coordinator has some organizational responsibility and authority for keeping the project moving.  That might include setting deadlines for getting involved and making contributions, or defining and negotiating the roles of the contributing members on the project.  The project lead has responsibility to make the expectations for the project explicit (even if they are decided collectively), so that all members of the team have a shared understanding of the project and their contribution.</li>", "    <li>If a project appears to be dying within OSF, a member can post to the OSF discussion group indicating that they would like to pursue the project independently of OSF.  If there is ever a dispute, the OSF community can discuss collectively how to resolve it.</li>", "</ol>", "", "<h3>How is authorship determined for Open Science Framework projects?</h3>", ""]}, {"lines": ["    that may turn into a product, the project coordinator or group of initial contributors", "     should explicitly define how authorship will be determined. Critically, this discussion"]}, {"lines": ["      prior to putting substantial effort into the project.</p>", ""]}, {"lines": ["    and contribution expectations for each contributor to be defined in advance.</p>", ""]}, {"lines": ["    is done. </p>", "", "<h3>How do contributors get credit for their work on Open Science Framework projects?</h3>", ""]}, {"lines": ["    relevant for junior scholars that need to make clear their contributions for hiring and career advancement.</p>", "", "<p>Further, as an open project, reputation is vitally important.  Collaborators"]}, {"lines": ["    be recognized, credited, and valued.", "</p>", "", "<h3>How does Open Science Framework manage free-riders and disagreements?</h3>", ""]}, {"lines": ["    the OSF discussion group for resolution advice."]}, {"lines": ["<div class=\"page-header\">", "    <h1>About the Reproducibility Project</h1>", "</div>", "<h3>Overview</h3>", "<p>Do normative scientific practices and incentive structures produce a biased body of research evidence?  The Reproducibility Project is the first known empirical effort to estimate the reproducibility of a sample of studies from the scientific literature.  The project is a large-scale, open collaboration involving dozens of scientists from around the world.  The investigation is currently sampling from the 2008 issues of three prominent psychology journals - Journal of Personality and Social Psychology, Psychological Science, and Journal of Experimental Psychology: Learning, Memory, and Cognition.  Individuals or teams of scientists follow a structured protocol for designing and conducting a close, high-powered replication of a key effect from the selected articles.  The project will evaluate the ability to reproduce the original study procedures and the overall probability of replicating the original results.  Further, it will examine the predictors of replication success - e.g., publishing journal, number of conceptual/direct replications in the published literature, citation impact of the original article, closeness of the replication to the original circumstances: sample, setting, materials.  Interested contributors can still join the project.</p>", "", "<h3>How to get involved</h3>", "<p>The Reproducibility Project is most likely to appeal to psychological scientists that are interested in the reproducibility of the field's research results or wanting to participate in a large-scale, open science project.  Contributors receive authorship on project reports (see <a href=\"https://docs.google.com/document/d/1FcWLfASVXPkLuTVQmbZKvpkPsgrW8XKPGfWJqnSnmeM/edit\">Executive Summary</a> for details).</p>", "", "<p>The most straightforward contribution is to conduct one or more replication studies following the guidelines described in the Researcher Guide.  If you are interested as an individual or team, contact the project coordinator, nosek at virginia dot edu, with questions or to sign-up and get editing access to the project materials.</p>", "", "<p>There are other ways to contribute including tasks appropriate for citizen scientists that do not have resources for conducting a replication.  Some tasks include: coding studies in the eligible pool, creating or improving tables and figures for communicating results, contributing data analytic expertise, and web design for project communication.</p>", "", "<h3>Project materials</h3>", "<p>The Reproducibility Project is open and transparent.  You can access background information about the project, materials about the study design, and information about the present progress and results with the links below.  Also, a public google group documents discussion about the project.  Anyone can join the google group to monitor the discussion, or contribute.</p>", "<ol>", "<li><a href=\"https://docs.google.com/document/d/1FcWLfASVXPkLuTVQmbZKvpkPsgrW8XKPGfWJqnSnmeM/edit\">Executive Summary</a>: Get an overview of the project goals and approach (start here if you want some background of the project)"]}, {"lines": ["<li><a href=\"https://docs.google.com/spreadsheet/ccc?key=0AvIo2znxWnxZdERIS2xqNnNxUUZRRTB5LVJxckhiY3c#gid=8\">Project Progress and Results Spreadsheet</a>: The primary vehicle for reviewing eligible articles, reporting project progress and results, and documenting researcher contribution", "<li><a href=\"http://groups.google.com/group/openscienceframework?hl=en\">Google Discussion Group</a>: to participate in the dynamic discussion of project design and progress (and discussions about other OSF projects)", "<li>Project Materials Dropbox: Access scientific articles that are eligible for replication, or other background reading materials (email nosek at virginia dot edu to get access)", "<li>Open Science Framework: Replication study materials will be made available in the OSF."]}], "name": "Jeff Spies"}, {"commits": [{"lines": ["        except ValidationValueError as e:"]}, {"lines": ["                data=dict(message_long=e.message)"]}, {"lines": ["        try:", "            project = new_node(category, title, user, description)", "        except ValidationValueError as e:", "            raise HTTPError(", "                http.BAD_REQUEST,", "                data=dict(message_long=e.message)", "            )"]}, {"lines": ["        try:", "            node = new_node(", "                title=strip_html(form.title.data),", "                user=user,", "                category=form.category.data,", "                parent=node,", "            )", "        except ValidationValueError as e:", "            raise HTTPError(", "                http.BAD_REQUEST,", "                data=dict(message_long=e.message)", "            )", ""]}, {"lines": ["        item.notify.update('Files couldn\\'t load. Please try again later.', 'deleting', undefined, 3000);"]}, {"lines": ["            $('#newComponent .modal-alert').text('The new component title cannot be empty.');"]}, {"lines": ["            $('#newComponent .modal-alert').text('The new component title cannot be more than 200 characters.'); //This alert never appears..."]}], "name": "Lauren Revere"}, {"commits": [{"lines": [""]}, {"lines": [""]}, {"lines": ["    tick = time.time()"]}, {"lines": [""]}, {"lines": [""]}], "name": "SamPortnow"}, {"commits": [{"lines": ["        var url = owner === 'user' ? '/api/v1/settings/' + addon + '/' : nodeApiUrl + addon + '/settings/';"]}, {"lines": ["            response = JSON.parse(response.responseText);"]}, {"lines": ["                message += 'Settings not updated.';"]}, {"lines": ["                m('span.tb-modal-btn.text-default', {onclick: function() {tb.modal.dismiss();}}, 'Cancel'), //jshint ignore:line"]}, {"lines": ["                m('span.tb-modal-btn.text-default', {onclick: cb.bind(tb, 'replace')},'Replace'),"]}, {"lines": ["                m('span.tb-modal-btn.text-default', {onclick: function() {tb.modal.dismiss();}}, 'Cancel'), // jshint ignore:line"]}, {"lines": ["                m('span.tb-modal-btn.text-default', {onclick: cb.bind(tb, 'replace')},'Replace'),"]}, {"lines": ["    if (to.id === ogParent && (!rename || rename === from.data.name)){", "      return;", "    }"]}, {"lines": ["    var parent = file.treebeardParent || treebeardParent.dropzoneItemCache; // jshint ignore:line"]}, {"lines": ["    if  (val === item.name) {", "        return;", "    }"]}, {"lines": ["    if (items.length < 1 ||"]}, {"lines": ["        copyMode === 'forbidden'", "    ) {"]}, {"lines": ["        return;", "    }"]}, {"lines": ["    if (folder.parentId === 0 ||", "        folder.data.kind !== 'folder' ||", "        !folder.data.permissions.edit ||", "        !folder.data.provider ||", "        folder.data.status ||", "        folder.data.provider === 'dataverse'", "    ) {"]}, {"lines": ["        return 'forbidden';", "    }"]}, {"lines": ["    ) {", "        return 'forbidden';", "    }"]}, {"lines": ["        ) {", "            return 'forbidden';", "        }"]}, {"lines": ["    if (folder.data.isPointer ||", "        altKey ||", "        !canMove", "    ) {"]}, {"lines": ["        return 'copy';", "    }"]}, {"lines": ["                        });  // jshint ignore:line"]}, {"lines": ["                } else if (this.type === 'section' || !child.repeatSection) {"]}, {"lines": ["                    if (action === 'add') {", "                        child.$parent.observedData[key] = this;", "                    } else if (action === 'remove') {", "                        delete child.$parent.observedData[key];"]}, {"lines": ["            if (action === 'add') {", "                this.$root.observedData[key] = this;", "            } else if (action === 'remove') {", "                delete this.$root.observedData[key];"]}, {"lines": ["        if (self.repeatType === 'repeat') {"]}, {"lines": ["        if ('options' in self && typeof(self.options) === 'string') {"]}, {"lines": ["                        if (option.value) {", "                            return option.value();"]}, {"lines": ["        if (self.multiple || self.type === 'checkbox') {"]}, {"lines": ["            return this.value() === value;"]}, {"lines": ["                );"]}, {"lines": ["            if (value[0] && this.$root.nodes.indexOf(value[0]) === -1) {"]}, {"lines": ["            return this.node() === value[0] && this.value() === value[1];"]}, {"lines": ["            if (content.id.indexOf(char) !== -1) {"]}, {"lines": ["            return data.type === 'section' ? 'section' : 'item';"]}, {"lines": ["                scrollTop: $('#meta-data-container').offset().top"]}, {"lines": ["                        if (current && current.repeatType === 'repeat') {"]}, {"lines": ["                if (Object.keys(nextData).length === Object.keys(data).length) {", "                    throw 'Unserialize failed';"]}, {"lines": ["        return window.contextVars.search;"]}, {"lines": ["    var inputDom =  $('#searchPageFullBar');", "    var inputLabel =  $('#searchBarLabel');"]}, {"lines": ["    inputLabel.css( 'visibility', 'visible' );"]}, {"lines": ["         inputLabel.css( 'visibility', 'hidden' );"]}, {"lines": ["            if (isInitialized) {", "                return;", "            }"]}, {"lines": ["        if (!ctrl.loaded) {", "            return util.Spinner;", "        }"]}, {"lines": ["        if (!model.loaded()) {", "            self.reload();", "        }"]}, {"lines": ["                if (!model.loaded()) {", "                    return util.Spinner;", "                }", "                if (model.errorMessage) {", "                    return m('.alert.alert-warning', {style:{margin: '10px'}}, model.errorMessage);", "                }"]}, {"lines": ["if (String.prototype.endsWith === undefined) {"]}, {"lines": ["var Comment = require('js/comment'); //jshint ignore:line"]}, {"lines": ["var $ = require('jquery');"]}, {"lines": ["var Node = oop.defclass({  // jshint ignore:line"]}, {"lines": ["        it('sets the View Model\\'s message to an empty string and sets the messageClass to \"text-info\"', () => {"]}, {"lines": ["            assert.equal(fullUrl, 'http://localhost:8000/v2/nodes/abcd3/contributors/');"]}, {"lines": ["            assert.equal(fullUrl, 'http://localhost:8000/v2/nodes/abcd3/contributors/');"]}, {"lines": ["            assert.notEqual(fullUrl, 'http://localhost:8000/v2/nodes/abcd3/contributors/');"]}, {"lines": ["            assert.equal(fullUrl, 'https://staging2.osf.io/api/v2/nodes/abcd3/contributors/?filter%5Bfullname%5D=bob&page_size=10');"]}, {"lines": ["            assert.equal(fullUrl, 'http://localhost:8000/v2/');"]}, {"lines": ["        it('restores the selectedCategory to the VM\\'s category, sets the dirty state to false, and resets the message', () => {"]}, {"lines": ["            it('... and returns \"\" otherwise', () => {"]}, {"lines": ["            it('returns the selected folder\\'s name if set else \"None\" when the User is owner', () => {"]}, {"lines": ["       % else:"]}, {"lines": ["                % if user_name:", "                    <li><a href=\"/explore/activity/\">Browse</a></li>", "                % endif", ""]}, {"lines": ["    <h3 class=\"text-center\" style=\"padding: 0;margin: 30px 0 0 0;border: none;list-style: none;font-weight: 300;text-align: center;\">Registration of <b>${src.title}</b> finished</h3>"]}, {"lines": ["    linking to someone else's project but would now like to edit it to make your own version, find the linked project", "    on the project overview page and hit the small fork button. There will now be a version you"]}], "name": "John Tordoff"}, {"commits": [{"lines": ["        items.indexOf(folder) > -1 ||"]}, {"lines": ["<div class=\"row\">", "\t<div class=\"col-md-8 col-md-offset-2 col-sm-12\">", "\t    <div class=\"gs-video embed-responsive embed-responsive-16by9\">", "\t        <div class=\"embed-responsive-item youtube-loader\" id=\"kotF8Pnurpw\"></div>", "\t    </div>", "\t</div>"]}], "name": "Zak"}, {"commits": [{"lines": ["/** Only for Search Bar Placeholder -- Allow IE and other browsers to work as the same */", "function placeholder(inputDom, inputLabel) {", "    inputDom.on('input', function () {", "        if (inputDom.val() === '') {"]}, {"lines": ["        } else {"]}, {"lines": ["        }", "    });", "}", "", "function searchBarPlaceHolderInit() {"]}, {"lines": ["    placeholder(inputDom, inputLabel);", "    inputDom.focus();", "", "    //Make sure IE cursor is located at the end of text", "    var $inputVal = inputDom.val();", "    inputDom.val('').val($inputVal);", "", "    //For search page with existing input, make sure placeholder is hidden."]}, {"lines": ["    if(inputDom.val() !== '' ){"]}, {"lines": ["    }", "}", ""]}, {"lines": ["        searchBarPlaceHolderInit();", "    }", ""]}, {"lines": [""]}, {"lines": ["    describe('htmlDecode', () => {", "        it('should decode html entities', () => {", "            assert.equal($osf.htmlDecode('safe'), 'safe');", "            assert.equal($osf.htmlDecode('b&gt;a&amp;'), 'b>a&');", "            assert.equal($osf.htmlDecode('&lt;script&gt;alert(\"lol\")&lt;/script&gt;'), '<script>alert(\"lol\")</script>');", "        });", "    });", ""]}, {"lines": ["                    <input id=\"searchPageFullBar\" name=\"search-placeholder\" type=\"text\" class=\"osf-search-input form-control\" placeholder=\"Search\" data-bind=\"value: query, hasFocus: true\">"]}, {"lines": ["                    <label id=\"searchBarLabel\" class=\"search-label-placeholder\" for=\"search-placeholder\">Search</label>"]}, {"lines": [""]}], "name": "haoyuchen1992"}, {"commits": [{"lines": ["    var bibliographicContribInfoHtml = 'Only bibliographic contributors will be displayed ' +", "           'in the Contributors list and in project citations. Non-bibliographic contributors ' +", "            'can read and modify the project as normal.';"]}, {"lines": ["        'data-content', bibliographicContribInfoHtml"]}], "name": "himanshu"}, {"commits": [{"lines": ["var $ = require('jquery');"]}, {"lines": ["$('.render-nodes-list').each(function() {", "    $osf.applyBindings(ComponentControl, this);", "});"]}, {"lines": [""]}], "name": "Gage Gaskins"}, {"commits": [{"lines": ["    <%include file=\"nav.mako\"/>"]}], "name": "tightsight"}, {"commits": [{"lines": ["        <script>window.jQuery || document.write('<script src=\"/static/vendor/bower_components/jquery/dist/jquery.min.js\">\\x3C/script>')</script>"]}, {"lines": ["        <script src=\"/static/vendor/bower_components/jquery/dist/jquery.min.js\"></script>"]}], "name": "Alessandro Cosentino"}, {"commits": [{"lines": ["            <option value=\"\">Please select a registration form to initiate registration</option>"]}], "name": "geeksnglitter"}, {"commits": [{"lines": ["<p>From your <a href=\"https://osf.io/settings/account\">account settings</a> page, you can additional email addresses to your account, and select which of these is your primary email address. Any of these emails can be used to log in to the OSF. </p>"]}], "name": "Gary Kriebel"}, {"commits": [{"lines": ["<p>If you\u2019d like to attach a license to your materials hosted on the OSF, you can put this information in your project\u2019s wiki or upload a README file. Typically, users wish to license their materials using Creative Commons licenses. Information about Creative Commons licenses can be found <a href=\"https://creativecommons.org/licenses/\">here.</a> </p>"]}, {"lines": ["<p>The best way to create a lab or organizational group on the OSF is to create a project for that group. Then, individual projects within the lab can either be organized into components of the lab project or into their own projects which are linked to the lab group project. For an example, check out the <a href=\"https://osf.io/ezcuj/\">Reproducibility Project: Psychology.</a></p>"]}], "name": "GaryKriebel"}, {"commits": [{"lines": ["% for contributor in contributors:"]}, {"lines": ["            class=\"contributor", "                ${'contributor-registered' if contributor['registered'] else 'contributor-unregistered'}", "                ${'contributor-self' if user['id'] == contributor['id'] else ''}\">"]}, {"lines": ["        % if contributor['registered']:"]}, {"lines": ["        % else:"]}, {"lines": ["        %endif"]}, {"lines": ["% endfor"]}], "name": "Fitz Elliott"}]